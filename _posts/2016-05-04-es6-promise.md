---
layout: post
title: ESä¸­çš„Promise
date: 2016-05-04
categories: [æŠ€æœ¯]
---

åœ¨æ‰§è¡Œä¸€äº›å¼‚æ­¥æ“ä½œ(å…¸å‹çš„æœ‰JavaScriptä¸­çš„ajax/NodeJsä¸­è¯»å–æ–‡ä»¶ç­‰ç­‰)çš„æ—¶å€™,æˆ‘ä»¬ä¸çŸ¥é“è¯¥æ“ä½œä»€ä¹ˆæ—¶å€™å®Œæˆ,æ‰€ä»¥å°±éœ€è¦åœ¨ä¸åŒçš„æ—¶å€™å†™ä¸Šå›è°ƒ,ç­‰åˆ°æœ‰è¿”å›çš„æ—¶å€™,å†æ‰§è¡Œä¸‹ä¸€æ­¥æ“ä½œ,ä¸‹é¢å°±ç”¨jQueryä¸­çš„ä¸€ä¸ªajaxæ¥åšç¤ºä¾‹:

    $.ajax({
        "url": "xxx",
        "type": "GET",
        "dataType": ""JSON,
        "success": function(res){},
        "error": function(ex){
            //  do some thing
        }
    });

æœ€åŸºç¡€çš„ä¸€ä¸ªajaxç¤ºä¾‹,å½“æˆ‘ä»¬æœ‰å¤šä¸ªajaxåµŒå¥—è¯·æ±‚çš„æ—¶å€™,å°±ä¸­äº†æ‰€è°“çš„"å›è°ƒåœ°ç‹±",ç±»ä¼¼äºä¸‹é¢çš„å†™æ³•:

    $.ajax({
        //  some configs
        "success": function(res){
            $.ajax({
                //  ...
                "success": function(res){
                    $.ajax({
                        //  ...
                        "success":function(res){
                            .
                            .
                            .
                        }
                    });
                }
            });
        }
    });

ä¸€å±‚å¥—ç€ä¸€å±‚,ä»£ç å¯è¯»æ€§å¾ˆå·®,ä¸”ä¸å®¹æ˜“åæœŸçš„ç»´æŠ¤

è¿™æ—¶å€™å°±éœ€è¦ä¸€ä¸ªæ¯”å‰è€…å¥½çš„è§£å†³æ–¹æ¡ˆæ¥è§£å†³è¯¥é—®é¢˜,ES6ä¸­çš„Promiseä¸€å®šç¨‹åº¦ä¸Šè§£å†³äº†è¯¥é—®é¢˜:

æˆ‘ä»¬å¯ä»¥åˆ©ç”¨Promiseå¯¹ajaxè¿›è¡Œä¸€å±‚å°è£…

    function _ajax(url, method, args) {
        let promise = new Promise((resolve, reject) => {

            let client = new XMLHttpRequest();
            let uri = url;

            if (args && (method == "POST" || method == "PUT")) {
                let argcount = 0;
                uri += "?";
                for (var key in args) {
                    if (args.hasOwnProperty(key)) {
                        if (argcount++) {
                            uri += '&';
                        }
                        uri += encodeURIComponent(key) + '=' + encodeURIComponent(args[key]);
                    }
                }
            }

            client.open(method, uri);
            client.send();

            client.onload = function() {
                if (this.status >= 200 && this.status < 300) {
                    resolve(this.response);
                } else {
                    reject(this.statusText);
                }
            };
            client.onerror = function() {
                reject(this.statusText);
            };

        });

        return promise;
    }

    let core = {

        "GET": function(args) {
            return _ajax(url, "GET", args);
        },

        "POST": function(args) {
            return _ajax(url, "POST", args);
        },

        "PUT": function(args) {
            return _ajax(url, "PUT", args);
        },

        "DELETE": function(args) {
            return _ajax(url, "DELETE", args);
        }

    };

ä¸Šé¢è¿™æ®µä»£ç æ˜¯JavaScript MDNä¸Šçš„ä»£ç (å¯èƒ½ç¨å¾®æœ‰ç‚¹æ”¹åŠ¨),å®ƒå¯¹ajaxè¿›è¡Œäº†ä¸€å±‚å°è£…,ç»è¿‡è¿™å±‚å°è£…,æˆ‘ä»¬å¯ä»¥åƒä¸‹é¢è¿™æ ·å†™ä¸€äº›å¼‚æ­¥ä»£ç :

    $http("xxx")
    .GET()
    .then((data) => {
        
        //  do something
        
        $http("xxx2")
        .GET()
        .then((data) => {
        
            //  do something
            
            $http("xxx3")
            .GET({"key","value"})
            .then((data) => {
                //  do something...
            })
            
            
        },(ex) => {});
        
    })
    .catch((ex) => {});

è™½ç„¶è¿˜æœ‰åµŒå¥—,ä½†æ˜¯ä»£ç çœ‹èµ·æ¥å·²ç»èˆ’æœäº†å¾ˆå¤šã€‚

Promiseæ˜¯ä¸€ä¸ªå¼‚æ­¥ç¼–ç¨‹çš„æŠ½è±¡,å®ƒæ˜¯ä¸€ä¸ªè¿”å›å€¼æˆ–æŠ›å‡ºexceptionçš„ä»£ç†å¯¹è±¡,ä¸€èˆ¬promiseå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªthenæ–¹æ³•,è¿™ä¸ªthenæ–¹æ³•æ˜¯æˆ‘ä»¬å¦‚ä½•è·å¾—è¿”å›å€¼(æˆåŠŸå®ç°æ‰¿è¯ºçš„ç»“æœå€¼,ç§°ä¸ºfulfillment)æˆ–æŠ›å‡ºexception(æ‹’ç»æ‰¿è¯ºçš„ç†ç”±,ç§°ä¸ºrejection)ï¼Œthenæ˜¯ç”¨ä¸¤ä¸ªå¯é€‰çš„å›è°ƒä½œä¸ºå‚æ•°,æˆ‘ä»¬å¯ä»¥ç§°ä¸ºonFulfilledå’ŒOnRejected,ä¹Ÿå¯ä»¥æŠŠOnRejectedå†™åœ¨catché‡Œé¢

æ‰€ä»¥ä¸€ä¸ªPromiseä¸€å…±æœ‰ä¸‹é¢å‡ ä¸ªçŠ¶æ€

1. pendingå¾…æ‰¿è¯º - promiseåˆå§‹çŠ¶æ€
2. fulfilledå®ç°æ‰¿è¯º - ä¸€ä¸ªæ‰¿è¯ºæˆåŠŸå®ç°çŠ¶æ€
3. rejectedæ‹’ç»æ‰¿è¯º - ä¸€ä¸ªæ‰¿è¯ºå¤±è´¥çš„çŠ¶æ€

å†æ¥ä¸ªNodeJsä¸­è¯»å–æ–‡ä»¶çš„ä¾‹å­:

    function readFile(path) {
        var fs = require("fs");
        var prromise = new Promise((resolve, reject) => {
            fs.readdir(path, (ex, files) => {
                if (ex) {
                    return reject(ex);
                }
                return resolve(files);
            });
        });
        
        return prromise;
    }

    readFile(config.avatarPath + "1").then((files) => {
        //  do some thing
        console.log(files);
    }).catch((ex) => {
        //  do something...
        console.log(ex);
    });
    
å¦‚æœä¸ç”¨Promiseå’Œä¸€äº›ES6çš„ç‰¹æ€§,ä¸Šé¢çš„ä»£ç åº”è¯¥çœ‹èµ·æ¥æ˜¯ä¸‹é¢çš„è¿™æ ·å­:

    var fs = require("fs");
    fs.readdir(path, function (ex, files) {
        if (ex) {
            //  do something
            return console.log();
        }
        
        //  do some thing
        console.log(files);
    });

ä»£ç é‡å¯èƒ½æ›´å°‘,ä½†æ˜¯é™·å…¥"å›è°ƒåœ°ç‹±"çš„å¯èƒ½å°±æ›´å¤§äº†,åœ¨ES7ä¸­,åˆæ–°å¢äº†async/awaitç‰¹æ€§æ¥é’ˆå¯¹å¼‚æ­¥æ“ä½œçš„,åé¢ä»‹ç»ğŸ˜„

