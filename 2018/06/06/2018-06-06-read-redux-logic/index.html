<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> redux-logicæºç é˜…è¯» Â· å°å®‹</title><meta name="description" content="redux-logicæºç é˜…è¯» - rwson"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="å°å®‹"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/rwson" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">redux-logicæºç é˜…è¯»</h1><div class="post-info">Jun 6, 2018</div><div class="post-content"><p>åœ¨ç”¨<a href="https://reactjs.org/" target="_blank" rel="external">React</a>å’Œ<a href="https://redux.js.org/" target="_blank" rel="external">Redux</a>åšå¼€å‘æ—¶, éƒ½ä¼šç”¨åˆ°å¼‚æ­¥çš„ä¸€äº›ä¸œè¥¿, ä¹‹å‰æ›´å¤šçš„ç”¨çš„æ˜¯<code>redux-thunk</code>æˆ–è€…<code>redux-saga</code>ä¹‹ç±»çš„, ä½†æ˜¯éƒ½æœ‰ç”¨çš„ä¸é¡ºçš„åœ°æ–¹, æœ‰ä¸€æ¬¡çªç„¶å‘ç°<a href="https://github.com/jeffbski/redux-logic" target="_blank" rel="external">redux-logic</a>æ˜¯ä¸€ä¸ªå¾ˆä¸é”™çš„è§£å†³æ–¹æ¡ˆ, ç”¨èµ·æ¥ä¹Ÿæ„Ÿè§‰å¾ˆé¡ºæ‰‹, ä¸å¸‚é¢ä¸Šå…¶ä»–<code>redux</code>ä¸­é—´ä»¶ä¸åŒçš„åˆ†æéƒ½åœ¨<a href="https://codewinds.com/assets/article/redux-logic-nodevember.pdf" target="_blank" rel="external">è¿™é‡Œ</a>, æ„Ÿå…´è¶£çš„å¯ä»¥è‡ªå·±æŸ¥çœ‹ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸‹<code>redux-logic</code>çš„åŸºæœ¬ç”¨æ³•:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">//	logic/index.js</span></div><div class="line"><span class="keyword">import</span> &#123; createLogic &#125; <span class="keyword">from</span> <span class="string">'redux-logic'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> someLogic = createLogic(&#123;</div><div class="line">	<span class="comment">//	å½“å‰logicç›‘å¬çš„actionType</span></div><div class="line">	type: <span class="string">'SOME_ACTION_TYPE'</span>,</div><div class="line"></div><div class="line">	<span class="comment">//	å–æ¶ˆå½“å‰logicæ‰§è¡Œçš„actionType</span></div><div class="line">	cancelType: <span class="string">'CANCEL_TYPE'</span>,</div><div class="line"></div><div class="line">	<span class="comment">//	æ˜¯å¦è·å–æœ€åä¸€ä¸ªè¿”å›</span></div><div class="line">	latest: <span class="literal">true</span>,</div><div class="line"></div><div class="line">	<span class="comment">//	å½“å‰actionTypeçš„ä¸šåŠ¡é€»è¾‘</span></div><div class="line">	<span class="keyword">async</span> process(&#123; getState, action, cancelled &#125;, dispatch, done) &#123;</div><div class="line">		<span class="keyword">const</span> res = <span class="keyword">await</span> asyncFn();</div><div class="line">		dispatch(newAction(&#123;</div><div class="line">			...res</div><div class="line">		&#125;));</div><div class="line">		done();</div><div class="line">	&#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">export</span> someLogic;</div><div class="line"></div><div class="line"><span class="comment">//	store/index.js</span></div><div class="line"><span class="keyword">import</span> &#123; createStore, applyMiddleware &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</div><div class="line"><span class="keyword">import</span> &#123; createLogicMiddleware &#125; <span class="keyword">from</span> <span class="string">'redux-logic'</span>;</div><div class="line"><span class="keyword">import</span> &#123; routerMiddleware &#125; <span class="keyword">from</span> <span class="string">'react-router-redux'</span>;</div><div class="line"></div><div class="line"><span class="keyword">import</span> reducer <span class="keyword">from</span> <span class="string">'../reducers'</span>;</div><div class="line"><span class="keyword">import</span> history <span class="keyword">from</span> <span class="string">'../history'</span>;</div><div class="line"><span class="keyword">import</span> &#123; someLogic &#125; <span class="keyword">from</span> <span class="string">'../logic'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> configureStore = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">    <span class="keyword">const</span> reduxRouteMiddleware = routerMiddleware(history),</div><div class="line"></div><div class="line">		<span class="comment">//	å°†æ‰€æœ‰çš„logicåº”ç”¨åˆ°ä¸­é—´ä»¶ä¸­</span></div><div class="line">    	loggicMiddleware = createLogicMiddleware([someLogic]),</div><div class="line">    	middlewares = process.env.NODE_ENV === <span class="string">'development'</span> ? [loggicMiddleware, reduxRouteMiddleware, logger] : [loggicMiddleware, reduxRouteMiddleware],</div><div class="line">        createStoreWithMiddleware = applyMiddleware(...middlewares)(createStore),</div><div class="line">        store = createStoreWithMiddleware(reducer);</div><div class="line">    <span class="keyword">return</span> store;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> configureStore();</div></pre></td></tr></table></figure>
<p>æœ¬æ–‡ä¼šé€æ­¥åˆ†æ<code>redux-logic</code>çš„ç›¸å…³å®ç°, é¦–å…ˆæŠŠ<a href="https://github.com/jeffbski/redux-logic" target="_blank" rel="external">redux-logic</a>å…‹éš†åˆ°æœ¬åœ°, æºç éƒ½ä½äº<code>redux-logic/src</code>é‡Œé¢, æ‰€ä»¥æˆ‘ä»¬ä»<code>src/index.js</code>å¼€å§‹:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> createLogic, &#123; configureLogic &#125; <span class="keyword">from</span> <span class="string">'./createLogic'</span>;</div><div class="line"></div><div class="line"><span class="keyword">import</span> createLogicMiddleware <span class="keyword">from</span> <span class="string">'./createLogicMiddleware'</span>;</div><div class="line"></div><div class="line"><span class="keyword">export</span> &#123;</div><div class="line">  configureLogic,</div><div class="line">  createLogic,</div><div class="line">  createLogicMiddleware</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</div><div class="line">  configureLogic,</div><div class="line">  createLogic,</div><div class="line">  createLogicMiddleware</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢çš„ä»£ç ä¸­å¯ä»¥çœ‹åˆ°, ä¸€å…±å¯¼å‡º3ä¸ªå‡½æ•°, <code>configureLogic</code>çš„åŠŸèƒ½å°±æ˜¯å¯¹æ‰€æœ‰çš„<code>logic</code>è¿›è¡Œé…ç½®(è¶…æ—¶è­¦å‘Šæ—¶é—´ç­‰), æˆ‘ä»¬ä¸»è¦çœ‹<code>createLogic</code>å’Œ<code>createLogicMiddleware</code>:</p>
<ul>
<li>createLogic</li>
</ul>
<p><code>createLogic</code>ä½äº<code>src/createLogic</code>é‡Œ</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * åˆ›å»ºä¸€ä¸ªLogicå¯¹è±¡</span></div><div class="line"><span class="comment"> * @param  &#123;Object&#125; logicOptions</span></div><div class="line"><span class="comment"> *         @param  &#123;String&#125;     logicOptions.name           å¯é€‰å€¼, ä¸»è¦ç”¨äºLogicä¸­çš„å¼‚å¸¸æç¤º, å¯é€‰å€¼</span></div><div class="line"><span class="comment"> *         @param  &#123;String&#125;     logicOptions.type           è§¦å‘å½“å‰Logicçš„redux action type</span></div><div class="line"><span class="comment"> *         @param  &#123;String&#125;     logicOptions.cancelType     å–æ¶ˆæ‰§è¡Œå½“å‰Logicçš„redux action type</span></div><div class="line"><span class="comment"> *         @param  &#123;Boolean&#125;    logicOptions.latest         æ˜¯å¦åªè·å–æœ€åä¸€æ¬¡çš„ç»“æœ,ç±»ä¼¼redux-sagaä¸­çš„takeLatest effect</span></div><div class="line"><span class="comment"> *         @param  &#123;Number&#125;     logicOptions.debounce       å‡½æ•°å»æŠ–é…ç½®, å•ä½ä¸ºæ¯«ç§’</span></div><div class="line"><span class="comment"> *         @param  &#123;Object&#125;     logicOptions.throttle       å‡½æ•°èŠ‚æµé…ç½®, å•ä½ä¸ºæ¯«ç§’</span></div><div class="line"><span class="comment"> *         @param  &#123;Function&#125;   logicOptions.validate       åœ¨æ‰§è¡Œprocessä¹‹å‰çš„ä¸€ä¸ªé’©å­, å¯ä»¥å¯¹å½“å‰actionæ‰§è¡Œä¸€äº›æ“ä½œ</span></div><div class="line"><span class="comment"> *         @param  &#123;Function&#125;   logicOptions.transform      validateçš„ä¸€ä¸ªåˆ«å, validateå’Œtransformåªéœ€æŒ‡å®šä¸€ä¸ªå³å¯</span></div><div class="line"><span class="comment"> *         @param  &#123;Function&#125;   logicOptions.process        å½“å‰redux action typeå¯¹åº”çš„å¤„ç†é€»è¾‘(å‘èµ·å¼‚æ­¥è¯·æ±‚, åœ¨å¼‚æ­¥è¯·æ±‚è¿”å›æˆåŠŸä¹‹åè§¦å‘æ–°çš„redux action)</span></div><div class="line"><span class="comment"> *         @param  &#123;Object&#125;     logicOptions.processOptions processä¸­éœ€è¦çš„ä¸€äº›é…ç½®</span></div><div class="line"><span class="comment"> *         @param  &#123;Number&#125;     logicOptions.warnTimeout    è¶…æ—¶è­¦å‘Šæ—¶é—´, é»˜è®¤60ç§’, éœ€è¦åœ¨processä¸­æ‰‹åŠ¨è°ƒç”¨doneæ¥ç»ˆæ­¢è¿™ä¸ªLogic, å¦‚æœæ˜¯ä¸€ä¸ªæŒç»­æ€§çš„Logic, warnTimeoutéœ€è¦è®¾ç½®æˆ0</span></div><div class="line"><span class="comment"> * @return &#123;Object&#125;              åˆ›å»ºå‡ºæ¥çš„Logic</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">createLogic</span>(<span class="params">logicOptions = &#123;&#125;</span>) </span>&#123;</div><div class="line">    <span class="comment">//  æ— æ•ˆé…ç½®é¡¹éªŒè¯, æŠŠæ— æ•ˆçš„é…ç½®é¡¹é”®åæ”¾æ•°ç»„è¿”å›</span></div><div class="line">    <span class="keyword">const</span> invalidOptions = getInvalidOptions(logicOptions, allowedOptions);</div><div class="line">    <span class="keyword">if</span> (invalidOptions.length) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`unknown or misspelled option(s): <span class="subst">$&#123;invalidOptions&#125;</span>`</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//  name, type, cancelType, validate, transforméƒ½ä»ä¼ å…¥çš„logicOptionsé‡Œé¢è·å–</span></div><div class="line">    <span class="comment">//  å¦‚æœå…¶ä»–é…ç½®é¡¹æ²¡æœ‰åœ¨logicOptionsä¸­å£°æ˜, å°±ä»é»˜è®¤é…ç½®ä¸­è·å–æˆ–è€…ç»™ä¸€ä¸ªé»˜è®¤å€¼</span></div><div class="line">    <span class="keyword">const</span> &#123;</div><div class="line">        name,</div><div class="line">        type,</div><div class="line">        cancelType,</div><div class="line">        warnTimeout = defaultOptions.warnTimeout,</div><div class="line">        latest = defaultOptions.latest,</div><div class="line">        debounce = defaultOptions.debounce,</div><div class="line">        throttle = defaultOptions.throttle,</div><div class="line">        validate,</div><div class="line">        transform,</div><div class="line">        process = emptyProcess,</div><div class="line">        processOptions = &#123;&#125;</div><div class="line">    &#125; = logicOptions;</div><div class="line"></div><div class="line">    <span class="comment">//  typeå¿…ä¼ </span></div><div class="line">    <span class="keyword">if</span> (!type) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'type is required, use \'*\' to match all actions'</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//  validateå’Œtranformåªèƒ½åŒæ—¶æŒ‡å®šä¸€ä¸ª</span></div><div class="line">    <span class="keyword">if</span> (validate &amp;&amp; transform) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'logic cannot define both the validate and transform hooks they are aliases'</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//  warnTimeoutéœ€è¦æ”¾åœ¨processOptionsåŒçº§</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> processOptions.warnTimeout !== <span class="string">'undefined'</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'warnTimeout is a top level createLogic option, not a processOptions option'</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//  è·å–processOptionsä¸­çš„æ— æ•ˆé…ç½®é¡¹</span></div><div class="line">    <span class="keyword">const</span> invalidProcessOptions = getInvalidOptions(processOptions, allowedProcessOptions);</div><div class="line">    <span class="keyword">if</span> (invalidProcessOptions.length) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`unknown or misspelled processOption(s): <span class="subst">$&#123;invalidProcessOptions&#125;</span>`</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//  å¦‚æœvalidateå’Œtransforméƒ½æ²¡ä¼ å…¥,å°±ç”¨é»˜è®¤çš„, å¦åˆ™å°±ç”¨ä¼ å…¥çš„validate</span></div><div class="line">    <span class="keyword">const</span> validateDefaulted = (!validate &amp;&amp; !transform) ?</div><div class="line">        identityValidation :</div><div class="line">        validate;</div><div class="line"></div><div class="line">    <span class="comment">//  å¦‚æœåœ¨processOptionsé‡Œé¢æŒ‡å®šäº†dispatchMultiple, warnTimeoutåº”è¯¥æ˜¯0</span></div><div class="line">    <span class="keyword">if</span> (NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</div><div class="line">        <span class="keyword">typeof</span> processOptions.dispatchMultiple !== <span class="string">'undefined'</span> &amp;&amp;</div><div class="line">        warnTimeout !== <span class="number">0</span>) &#123;</div><div class="line">        <span class="built_in">console</span>.error(<span class="string">`warning: in logic for type(s): <span class="subst">$&#123;type&#125;</span> - dispatchMultiple is always true in next version. For non-ending logic, set warnTimeout to 0`</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">        æ ¹æ®process.lengthå¯ä»¥è·å–ä¼ å…¥çš„processå¯¹åº”çš„å¤„ç†å‡½æ•°ä¸­çš„å½¢å‚ä¸ªæ•°</span></div><div class="line"><span class="comment">        ä»è€Œç¡®å®šprocessOptionä¸­çš„ä¸€äº›é»˜è®¤å€¼</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">        const fn = function(arg1, agr2) &#123;&#125;;</span></div><div class="line"><span class="comment">        console.log(fn.length);  -&gt; 2</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">        const fn = function(arg1, agr2, arg3) &#123;&#125;;</span></div><div class="line"><span class="comment">        console.log(fn.length); -&gt; 3</span></div><div class="line"><span class="comment">    **/</span></div><div class="line">    <span class="keyword">switch</span> (process.length) &#123;</div><div class="line">        <span class="comment">//  å¦‚æœæ²¡æœ‰æˆ–åªæœ‰ä¸€ä¸ªå½¢å‚æ²¡æœ‰ä¼ å…¥ä¸”dispatchReturnæ²¡æœ‰åœ¨processOptionsä¼ å…¥, å°±æŠŠå®ƒè®¾ç½®æˆtrue</span></div><div class="line">        <span class="keyword">case</span> <span class="number">0</span>:</div><div class="line">        <span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">            setIfUndefined(processOptions, <span class="string">'dispatchReturn'</span>, <span class="literal">true</span>);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="comment">//  ä¸¤ä¸ªå½¢å‚(single-dispatchæ¨¡å¼[å·²åºŸå¼ƒ])</span></div><div class="line">        <span class="keyword">case</span> <span class="number">2</span>:</div><div class="line">            <span class="keyword">if</span> (NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</div><div class="line">                !processOptions.dispatchMultiple &amp;&amp;</div><div class="line">                warnTimeout !== <span class="number">0</span>) &#123;</div><div class="line">                <span class="built_in">console</span>.error(<span class="string">`warning: in logic for type(s): <span class="subst">$&#123;type&#125;</span> - single-dispatch mode is deprecated, call done when finished dispatching. For non-ending logic, set warnTimeout: 0`</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">            3ä¸ªå½¢å‚åŠæ›´å¤š, è®¤ä¸ºæ˜¯multi-dispatchæ¨¡å¼</span></div><div class="line"><span class="comment">            processOptions.dispatchMultiple = processOptions === undefined ? true : processOptions.dispatchMultiple</span></div><div class="line"><span class="comment">        **/</span></div><div class="line">        <span class="keyword">case</span> <span class="number">3</span>:</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            setIfUndefined(processOptions, <span class="string">'dispatchMultiple'</span>, <span class="literal">true</span>);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//  è¿”å›å¤„ç†å¥½çš„å¯¹è±¡</span></div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">        name: typeToStrFns(name),</div><div class="line">        type: typeToStrFns(type),</div><div class="line">        cancelType: typeToStrFns(cancelType),</div><div class="line">        latest,</div><div class="line">        debounce,</div><div class="line">        throttle,</div><div class="line">        validate: validateDefaulted,</div><div class="line">        transform,</div><div class="line">        process,</div><div class="line">        processOptions,</div><div class="line">        warnTimeout</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢çš„åˆ†æä¸­æˆ‘ä»¬å¯ä»¥å¾—å‡º: åœ¨<code>createLogic</code>ä¸­åšçš„ä¸»è¦æ˜¯ä¸€äº›å‚æ•°çš„éªŒè¯å’Œé»˜è®¤å€¼çš„å¤„ç†, ä¸‹é¢æˆ‘ä»¬ä¸€èµ·çœ‹çœ‹ä»–é‡Œé¢çš„è°ƒç”¨çš„ä¸€äº›çš„å®ç°:</p>
<p>å…ˆæ¥çœ‹ä¸‹<code>getInvalidOptions</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getInvalidOptions</span>(<span class="params">options, validOptions</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="built_in">Object</span>.keys(options)</div><div class="line">    .filter(<span class="function"><span class="params">k</span> =&gt;</span> validOptions.indexOf(k) === <span class="number">-1</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line"><span class="comment">/**	æ¯”å¦‚åœ¨createLogicé‡Œçš„ç¬¬ä¸€è¡Œå°±è°ƒç”¨äº†è¯¥æ–¹æ³•</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">export default function createLogic(logicOptions = &#123;&#125;) &#123;</span></div><div class="line"><span class="comment">  const invalidOptions = getInvalidOptions(logicOptions, allowedOptions);</span></div><div class="line"><span class="comment">  //	...</span></div><div class="line"><span class="comment">&#125;</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">const allowedOptions = [</span></div><div class="line"><span class="comment">  'name',</span></div><div class="line"><span class="comment">  'type',</span></div><div class="line"><span class="comment">  'cancelType',</span></div><div class="line"><span class="comment">  'latest',</span></div><div class="line"><span class="comment">  'debounce',</span></div><div class="line"><span class="comment">  'throttle',</span></div><div class="line"><span class="comment">  'validate',</span></div><div class="line"><span class="comment">  'transform',</span></div><div class="line"><span class="comment">  'process',</span></div><div class="line"><span class="comment">  'processOptions',</span></div><div class="line"><span class="comment">  'warnTimeout'</span></div><div class="line"><span class="comment">];</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">**/</span></div></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢çš„åˆ†æä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡º, <code>getInvalidOptions</code>ç”¨æ¥è·å–<code>Object</code>é‡Œçš„ä¸åˆæ³•çš„é…ç½®é¡¹, å¹¶æŠŠéæ³•çš„<code>key</code>ä½œä¸ºæ•°ç»„çš„å½¢å¼è¿”å›ã€‚</p>
<p><code>typeToStrFns</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//	å¦‚æœæ˜¯æ•°ç»„å½¢å¼å°±é’ˆå¯¹æ•°ç»„çš„æ¯ä¸€é¡¹éƒ½è°ƒç”¨typeToStrFns, è¿”å›ä¸€ä¸ªæ–°æ•°ç»„</span></div><div class="line"><span class="comment">//	å¦‚æœæ˜¯å‡½æ•°å½¢å¼å°±è¿”å›å‡½æ•°ä½“çš„å­—ç¬¦ä¸²å½¢å¼</span></div><div class="line"><span class="comment">//	å…¶å®ƒç›´æ¥è¿”å›</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">typeToStrFns</span>(<span class="params">type</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(type)) &#123; <span class="keyword">return</span> type.map(<span class="function"><span class="params">x</span> =&gt;</span> typeToStrFns(x)); &#125;</div><div class="line">  <span class="keyword">return</span> (<span class="keyword">typeof</span> type === <span class="string">'function'</span>) ?</div><div class="line">    type.toString() :</div><div class="line">    type;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>setIfUndefined</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">setIfUndefined</span>(<span class="params">obj, propName, propValue</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> obj[propName] === <span class="string">'undefined'</span>) &#123;</div><div class="line">    obj[propName] = propValue;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ²¡ä»€ä¹ˆå¥½è¯´çš„ğŸ˜‚</p>
<ul>
<li>createLogicMiddleware<br><code>createLogic</code>åˆ†æå®Œäº†, ä¸‹é¢ä¸€èµ·çœ‹çœ‹<code>createLogicMiddleware</code>, <code>createLogicMiddleware</code>ä½äº<code>src/createLogicMiddleware</code>é‡Œ:</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">	@param arrLogic  Array.&lt;logic&gt;</span></div><div class="line"><span class="comment">	@param deps 	 Object</span></div><div class="line"><span class="comment">**/</span></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">createLogicMiddleware</span>(<span class="params">arrLogic = [], deps = &#123;&#125;</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(arrLogic)) &#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'createLogicMiddleware needs to be called with an array of logic items'</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">	<span class="comment">//	åˆ¤æ–­æ˜¯å¦æœ‰é‡å¤çš„logic</span></div><div class="line">  <span class="keyword">const</span> duplicateLogic = findDuplicates(arrLogic);</div><div class="line">  <span class="keyword">if</span> (duplicateLogic.length) &#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`duplicate logic, indexes: <span class="subst">$&#123;duplicateLogic&#125;</span>`</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line"><span class="comment">		å› ä¸ºredux-logicé›†æˆäº†rxjs</span></div><div class="line"><span class="comment">		æ‰€ä»¥Subjectå’ŒBehaviorSubjectéƒ½æ˜¯rxjsé‡Œçš„ä¸»ä½“</span></div><div class="line"><span class="comment">		BehaviorSubjectä½œä¸ºSubjectçš„ä¸€ä¸ªå˜ä½“, å’ŒSubjectä¸åŒçš„æ˜¯å®ƒæœ‰ä¸€ä¸ªåˆå§‹å€¼</span></div><div class="line"><span class="comment">		https://cn.rx.js.org/manual/overview.html#h15</span></div><div class="line"><span class="comment">	**/</span></div><div class="line">  <span class="keyword">const</span> actionSrc$ = <span class="keyword">new</span> Subject();</div><div class="line"></div><div class="line">	<span class="comment">//	ç”¨æ¥ç›‘è§†æ‰€æœ‰action</span></div><div class="line">  <span class="keyword">const</span> monitor$ = <span class="keyword">new</span> Subject();</div><div class="line">  <span class="keyword">const</span> lastPending$ = <span class="keyword">new</span> BehaviorSubject(&#123; <span class="attr">op</span>: OP_INIT &#125;);</div><div class="line"></div><div class="line">	<span class="comment">//	å¯¹monitor$ä½¿ç”¨ç´¯åŠ å™¨å‡½æ•°,è¿”å›ç”Ÿæˆçš„ä¸­é—´å€¼,å¯é€‰çš„åˆå§‹å€¼</span></div><div class="line">  monitor$</div><div class="line">    .scan(<span class="function">(<span class="params">acc, x</span>) =&gt;</span> &#123; <span class="comment">// è¿½åŠ ä¸€ä¸ªpendingçŠ¶æ€çš„è®¡æ•°å™¨</span></div><div class="line">      <span class="keyword">let</span> pending = acc.pending || <span class="number">0</span>;</div><div class="line">      <span class="keyword">switch</span> (x.op) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="string">'top'</span> : 		<span class="comment">// å½“å‰actionä½äºlogicæ ˆçš„é¡¶çº§</span></div><div class="line">        <span class="keyword">case</span> <span class="string">'begin'</span> : 		<span class="comment">// å¼€å§‹è§¦å‘ä¸€ä¸ªaction</span></div><div class="line">          pending += <span class="number">1</span>;</div><div class="line">          <span class="keyword">break</span>;</div><div class="line"></div><div class="line">		<span class="comment">/**</span></div><div class="line"><span class="comment">			åœ¨createLogicé‡Œçš„processä¸­è°ƒç”¨äº†done, doneçš„å®ç°ç¨å€™åˆ†æ;</span></div><div class="line"><span class="comment">		**/</span></div><div class="line">        <span class="keyword">case</span> <span class="string">'end'</span>:</div><div class="line">        <span class="keyword">case</span> <span class="string">'bottom'</span>: 			<span class="comment">// actionå˜æˆäº†ä¸€ä¸ªè¢«è½¬æ¢åçš„æ–°action</span></div><div class="line"></div><div class="line">		<span class="comment">/**</span></div><div class="line"><span class="comment">			åœ¨createLogicé‡Œçš„validateä¸­è°ƒç”¨äº†allow, ä¸”è§¦å‘äº†ä¸€ä¸ªæ–°çš„action</span></div><div class="line"><span class="comment">			craeteLogic(&#123;</span></div><div class="line"><span class="comment">				...</span></div><div class="line"><span class="comment">				validate(&#123; getState, action &#125;, allow, reject) &#123;</span></div><div class="line"><span class="comment">					allow(action);</span></div><div class="line"><span class="comment">				&#125;</span></div><div class="line"><span class="comment">			&#125;)</span></div><div class="line"><span class="comment">		**/</span></div><div class="line">        <span class="keyword">case</span> <span class="string">'nextDisp'</span> :</div><div class="line">        <span class="keyword">case</span> <span class="string">'filtered'</span> : 		<span class="comment">// 	å½“å‰actionç”±äºæ— æ•ˆè¢«è¿‡æ»¤</span></div><div class="line">        <span class="keyword">case</span> <span class="string">'dispatchError'</span> : <span class="comment">// 	æ´¾å‘actionçš„æ—¶å€™å¼‚å¸¸(å¥½åƒæš‚æ—¶æ²¡ç”¨åˆ°)</span></div><div class="line"></div><div class="line">		<span class="comment">/**</span></div><div class="line"><span class="comment">			åœ¨actionæ‹¦æˆªå™¨(validate)é‡Œé¢æ‰§è¡Œreject</span></div><div class="line"><span class="comment">			craeteLogic(&#123;</span></div><div class="line"><span class="comment">				...</span></div><div class="line"><span class="comment">				validate(&#123; getState, action &#125;, allow, reject) &#123;</span></div><div class="line"><span class="comment">					reject(action);</span></div><div class="line"><span class="comment">				&#125;</span></div><div class="line"><span class="comment">			&#125;)</span></div><div class="line"><span class="comment">		**/</span></div><div class="line">        <span class="keyword">case</span> <span class="string">'cancelled'</span>:</div><div class="line">          pending -= <span class="number">1</span>;</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> &#123;</div><div class="line">        ...x,</div><div class="line">        pending</div><div class="line">      &#125;;</div><div class="line">    &#125;, &#123; <span class="attr">pending</span>: <span class="number">0</span> &#125;)</div><div class="line"></div><div class="line">	<span class="comment">//	https://cn.rx.js.org/manual/usage.html</span></div><div class="line">    .subscribe(lastPending$);</div><div class="line"></div><div class="line">  <span class="keyword">let</span> savedStore;</div><div class="line">  <span class="keyword">let</span> savedNext;</div><div class="line">  <span class="keyword">let</span> actionEnd$;</div><div class="line">  <span class="keyword">let</span> logicSub;</div><div class="line">  <span class="keyword">let</span> logicCount = <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="comment">//	ç¼“å­˜ä¼ å…¥çš„logicæ•°ç»„</span></div><div class="line">  <span class="keyword">let</span> savedLogicArr = arrLogic;</div><div class="line"></div><div class="line">	<span class="comment">//	è°ƒç”¨å®ŒcreateLogicMiddlewareåè¿”å›çš„reduxä¸­é—´ä»¶</span></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">mw</span>(<span class="params">store</span>) </span>&#123;</div><div class="line">	<span class="comment">//	å¤šæ¬¡è°ƒç”¨äº†createLogicMiddleware, å¹¶ä¸”ä¼ å…¥äº†ä¸åŒçš„store</span></div><div class="line">    <span class="keyword">if</span> (savedStore &amp;&amp; savedStore !== store) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'cannot assign logicMiddleware instance to multiple stores, create separate instance for each'</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="comment">//	ç¼“å­˜æœ¬æ¬¡è°ƒç”¨ä¼ å…¥çš„store</span></div><div class="line">    savedStore = store;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="params">next</span> =&gt;</span> &#123;</div><div class="line">      savedNext = next;</div><div class="line"></div><div class="line">		<span class="comment">//	ä»applyLogicè¿”å›ä¸­è·å–action$, sub, æŠŠlogicCountèµ‹å€¼ç»™cnt</span></div><div class="line">      <span class="keyword">const</span> &#123; action$, sub, <span class="attr">logicCount</span>: cnt &#125; =</div><div class="line">            applyLogic(arrLogic, savedStore, savedNext,</div><div class="line">                       logicSub, actionSrc$, deps, logicCount,</div><div class="line">                       monitor$);</div><div class="line">      actionEnd$ = action$;</div><div class="line">      logicSub = sub;</div><div class="line">      logicCount = cnt;</div><div class="line"></div><div class="line">      <span class="keyword">return</span> <span class="function"><span class="params">action</span> =&gt;</span> &#123;</div><div class="line">        debug(<span class="string">'starting off'</span>, action);</div><div class="line">        monitor$.next(&#123; action, <span class="attr">op</span>: <span class="string">'top'</span> &#125;);</div><div class="line">        actionSrc$.next(action);</div><div class="line">        <span class="keyword">return</span> action;</div><div class="line">      &#125;;</div><div class="line">    &#125;;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">//	ç»™mwæŒ‚è½½ä¸€ä¸ªæŒ‡å‘monitor$çš„monitor$å±æ€§</span></div><div class="line">  mw.monitor$ = monitor$;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä¸€ä¸ªè‡ªå®šä¹‰é’©å­å‡½æ•°, ä¸»è¦ç”¨äºæµ‹è¯•</span></div><div class="line"><span class="comment">     * @param  &#123;Function&#125; fn   å¯å†™å…¥ç›¸å…³æµ‹è¯•é€»è¾‘</span></div><div class="line"><span class="comment">     * @return &#123;Objetc&#125;</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    mw.whenComplete = <span class="function"><span class="keyword">function</span> <span class="title">whenComplete</span>(<span class="params">fn = identity</span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> lastPending$</div><div class="line">            <span class="comment">//  åªæœ‰å½“x.pending &gt; 0æ˜¯æ‰ç»§ç»­å¾€ä¸‹èµ°</span></div><div class="line">            .takeWhile(<span class="function"><span class="params">x</span> =&gt;</span> x.pending)</div><div class="line">            .map(<span class="function">(<span class="params"> <span class="regexp">/* x */</span> </span>) =&gt;</span> <span class="literal">undefined</span>)</div><div class="line">            .toPromise()</div><div class="line">            .then(fn);</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line"><span class="comment">		ç»™å½“å‰reduxä¸­é—´ä»¶åŠ¨æ€æ·»åŠ ä¾èµ–(ç›¸å½“äºcreateLogicMiddlewareç¬¬äºŒä¸ªå‚æ•°çš„æ‹“å±•)</span></div><div class="line"><span class="comment">	**/</span></div><div class="line">  mw.addDeps = <span class="function"><span class="keyword">function</span> <span class="title">addDeps</span>(<span class="params">additionalDeps</span>) </span>&#123;</div><div class="line">	<span class="comment">//	æ‰€æ·»åŠ çš„ä¾èµ–å¿…é¡»æ˜¯ä¸€ä¸ªå¯¹è±¡ç±»å‹</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> additionalDeps !== <span class="string">'object'</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'addDeps should be called with an object'</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="comment">//	éå†æ‰€æ·»åŠ çš„ä¸­é—´ä»¶</span></div><div class="line">    <span class="built_in">Object</span>.keys(additionalDeps).forEach(<span class="function"><span class="params">k</span> =&gt;</span> &#123;</div><div class="line">      <span class="keyword">const</span> existing = deps[k];</div><div class="line">      <span class="keyword">const</span> newValue = additionalDeps[k];</div><div class="line">		<span class="comment">//	æ‰€æ·»åŠ çš„ä¸­é—´ä»¶ä¸èƒ½å’Œå½“å‰å·²æœ‰çš„é‡å(å½“å‰å·²ç»æœ‰çš„ä¸èƒ½è¢«è¦†ç›–)</span></div><div class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> existing !== <span class="string">'undefined'</span> &amp;&amp;</div><div class="line">          existing !== newValue) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`addDeps cannot override an existing dep value: <span class="subst">$&#123;k&#125;</span>`</span>);</div><div class="line">      &#125;</div><div class="line">      deps[k] = newValue;</div><div class="line">    &#125;);</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line"><span class="comment">		ç»™å½“å‰reduxä¸­é—´ä»¶åŠ¨æ€æ·»åŠ æ–°çš„logic</span></div><div class="line"><span class="comment">		@param arrNewLogic Array.&lt;Logic&gt;</span></div><div class="line"><span class="comment">	**/</span></div><div class="line">  mw.addLogic = <span class="function"><span class="keyword">function</span> <span class="title">addLogic</span>(<span class="params">arrNewLogic</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!arrNewLogic.length) &#123; <span class="keyword">return</span> &#123; logicCount &#125;; &#125;</div><div class="line"></div><div class="line">	<span class="comment">//	åˆå¹¶åˆ°å½“å‰å·²æœ‰çš„æ•°ç»„é‡Œé¢</span></div><div class="line">    <span class="keyword">const</span> combinedLogic = savedLogicArr.concat(arrNewLogic);</div><div class="line">    <span class="keyword">const</span> duplicateLogic = findDuplicates(combinedLogic);</div><div class="line"></div><div class="line">	<span class="comment">//	åˆ¤æ–­æ˜¯å¦æœ‰é‡å¤</span></div><div class="line">    <span class="keyword">if</span> (duplicateLogic.length) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`duplicate logic, indexes: <span class="subst">$&#123;duplicateLogic&#125;</span>`</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">const</span> &#123; action$, sub, <span class="attr">logicCount</span>: cnt &#125; =</div><div class="line">          applyLogic(arrNewLogic, savedStore, savedNext,</div><div class="line">                     logicSub, actionEnd$, deps, logicCount, monitor$);</div><div class="line">    actionEnd$ = action$;</div><div class="line">    logicSub = sub;</div><div class="line">    logicCount = cnt;</div><div class="line">    savedLogicArr = combinedLogic;</div><div class="line">    debug(<span class="string">'added logic'</span>);</div><div class="line">    <span class="keyword">return</span> &#123; <span class="attr">logicCount</span>: cnt &#125;;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line"><span class="comment">		ç»™å½“å‰reduxä¸­é—´ä»¶åˆå¹¶æ–°çš„logic</span></div><div class="line"><span class="comment">		@param arrNewLogic Array.&lt;Logic&gt;</span></div><div class="line"><span class="comment">	**/</span></div><div class="line">  mw.mergeNewLogic = <span class="function"><span class="keyword">function</span> <span class="title">mergeNewLogic</span>(<span class="params">arrMergeLogic</span>) </span>&#123;</div><div class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦é‡å</span></div><div class="line">    <span class="keyword">const</span> duplicateLogic = findDuplicates(arrMergeLogic);</div><div class="line">    <span class="keyword">if</span> (duplicateLogic.length) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`duplicate logic, indexes: <span class="subst">$&#123;duplicateLogic&#125;</span>`</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// è¿‡æ»¤æ‰é‡å¤çš„</span></div><div class="line">    <span class="keyword">const</span> arrNewLogic = arrMergeLogic.filter(<span class="function"><span class="params">x</span> =&gt;</span></div><div class="line">      savedLogicArr.indexOf(x) === <span class="number">-1</span>);</div><div class="line">    <span class="keyword">return</span> mw.addLogic(arrNewLogic);</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">	æ›¿æ¢å½“å‰æ‰€æœ‰çš„logicå˜æˆæ–°çš„logic</span></div><div class="line"><span class="comment">   **/</span></div><div class="line">  mw.replaceLogic = <span class="function"><span class="keyword">function</span> <span class="title">replaceLogic</span>(<span class="params">arrRepLogic</span>) </span>&#123;</div><div class="line">    <span class="keyword">const</span> duplicateLogic = findDuplicates(arrRepLogic);</div><div class="line"></div><div class="line">	<span class="comment">//	åˆ¤æ–­æ–°çš„logicæ•°ç»„é‡Œæ˜¯å¦æœ‰é‡å¤çš„logic</span></div><div class="line">    <span class="keyword">if</span> (duplicateLogic.length) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`duplicate logic, indexes: <span class="subst">$&#123;duplicateLogic&#125;</span>`</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">const</span> &#123; action$, sub, <span class="attr">logicCount</span>: cnt &#125; =</div><div class="line">          applyLogic(arrRepLogic, savedStore, savedNext,</div><div class="line">                     logicSub, actionSrc$, deps, <span class="number">0</span>, monitor$);</div><div class="line">    actionEnd$ = action$;</div><div class="line">    logicSub = sub;</div><div class="line">    logicCount = cnt;</div><div class="line">    savedLogicArr = arrRepLogic;</div><div class="line">    debug(<span class="string">'replaced logic'</span>);</div><div class="line">    <span class="keyword">return</span> &#123; <span class="attr">logicCount</span>: cnt &#125;;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> mw;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢çš„åˆ†æä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡º, <code>createLogicMiddleware</code>è¿”å›äº†ä¸€ä¸ªä¸­é—´ä»¶, è¯¥ä¸­é—´ä»¶åŸºäº<a href="https://cn.rx.js.org/" target="_blank" rel="external">Rxjs</a>å®ç°, è¿”å›çš„ä¸­é—´ä»¶ä¸­å¤„ç†ç›¸å…³<code>redux action</code>å¯¹åº”çš„é€»è¾‘ã€‚</p>
<p>åœ¨<code>createLogicMiddleware</code>ä¸­è°ƒç”¨äº†ä¸€äº›å…¶ä»–å‡½æ•°, é€ä¸ªçœ‹ä¸‹è¿™äº›å‡½æ•°çš„å®ç°:</p>
<p><code>findDuplicates</code>, è¯¥æ–¹æ³•å®ŒæˆæŸ¥æ‰¾æ•°ç»„é‡Œé¢é‡å¤çš„<code>Logic</code>, å¹¶è®°å½•é‡å¤çš„ä¸‹æ ‡è¿”å›</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">	@param arrLogic  Array.&lt;Logic&gt;   logicæ•°ç»„</span></div><div class="line"><span class="comment">**/</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * @param  &#123;Array.&lt;Logic&gt;&#125;  arrLogic Logicæ•°ç»„</span></div><div class="line"><span class="comment"> * @return &#123;Array.&lt;Number&gt;&#125;          é‡å¤çš„Logicä¸‹æ ‡</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">findDuplicates</span>(<span class="params">arrLogic</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> arrLogic.reduce(<span class="function">(<span class="params">acc, x1, idx1</span>) =&gt;</span> &#123;</div><div class="line">    <span class="comment">//  ä¸æ˜¯åŒä¸€ä¸ªä¸‹æ ‡, ä¸”å€¼ç›¸ç­‰çš„æƒ…å†µä¸‹å°±æŠŠä¸‹æ ‡æ”¾åˆ°accé‡Œé¢</span></div><div class="line">    <span class="keyword">if</span> (arrLogic.some(<span class="function">(<span class="params">x2, idx2</span>) =&gt;</span> (idx1 !== idx2 &amp;&amp; x1 === x2))) &#123;</div><div class="line">      acc.push(idx1);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> acc;</div><div class="line">  &#125;, []);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å†çœ‹çœ‹çœ‹<code>applyLogic</code>çš„å®ç°:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * @param  &#123;Array.&lt;Logic&gt;&#125;   arrLogic        Logicæ•°ç»„</span></div><div class="line"><span class="comment"> * @param  &#123;Object&#125;         store            redux store</span></div><div class="line"><span class="comment"> * @param  &#123;Function&#125;       next             reduxä¸­é—´ä»¶ä¸­çš„ç¬¬äºŒå±‚å‡½æ•°</span></div><div class="line"><span class="comment"> * @param  &#123;Rx.Subject&#125;     sub              å½“å‰actionå¯¹åº”çš„</span></div><div class="line"><span class="comment"> * @param  &#123;Rx.Subject&#125;     actionIn$        å½“å‰actionå¯¹åº”çš„å¯è®¢é˜…å¯¹è±¡</span></div><div class="line"><span class="comment"> * @param  &#123;Object&#125;         deps             createLogicMiddleçš„ç¬¬äºŒä¸ªå‚æ•°</span></div><div class="line"><span class="comment"> * @param  &#123;Number&#125;         startLogicCount  ç”¨äºå‘½å</span></div><div class="line"><span class="comment"> * @param  &#123;Rx.Subject&#125;     monitor$         å…¨å±€å¯è®¢é˜…å¯¹è±¡</span></div><div class="line"><span class="comment"> * @return &#123;Object&#125;</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">applyLogic</span>(<span class="params">arrLogic, store, next, sub, actionIn$, deps, startLogicCount, monitor$</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!store || !next) &#123; <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'store is not defined'</span>); &#125;</div><div class="line"></div><div class="line">    <span class="comment">//  å¦‚æœå½“å‰Logicå·²ç»æ˜¯ä¸€ä¸ªRx.Subject(å·²ç»è¢«è®¢é˜…è¿‡äº†), å–æ¶ˆè®¢é˜…</span></div><div class="line">    <span class="keyword">if</span> (sub) &#123; sub.unsubscribe(); &#125;</div><div class="line"></div><div class="line">    <span class="comment">//  å¯¹å½“å‰Logicæ•°ç»„è¿›è¡Œæ“ä½œ(å‘½åç­‰), è¿”å›ä¸€ä¸ªæ–°æ•°ç»„</span></div><div class="line">    <span class="keyword">const</span> wrappedLogic = arrLogic.map(<span class="function">(<span class="params">logic, idx</span>) =&gt;</span> &#123;</div><div class="line">        <span class="comment">//  ç»™å½“å‰æœªæŒ‡å®šnameçš„Logicè¿›è¡Œå‘½åå¹¶ä¸”è¿”å›, namingç¨å€™åˆ†æ</span></div><div class="line">        <span class="keyword">const</span> namedLogic = naming(logic, idx + startLogicCount);</div><div class="line"></div><div class="line">        <span class="comment">//  åŒ…è£…å‘½ååçš„Logic, wrapperç¨å€™åˆ†æ</span></div><div class="line">        <span class="keyword">return</span> wrapper(namedLogic, store, deps, monitor$);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> actionOut$ = wrappedLogic.reduce(<span class="function">(<span class="params">acc$, wep</span>) =&gt;</span> wep(acc$), actionIn$);</div><div class="line"></div><div class="line">    <span class="comment">//  è®¢é˜…æ–°çš„Observableå¯¹è±¡</span></div><div class="line">    <span class="keyword">const</span> newSub = actionOut$.subscribe(<span class="function"><span class="params">action</span> =&gt;</span> &#123;</div><div class="line">        debug(<span class="string">'actionEnd$'</span>, action);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">const</span> result = next(action);</div><div class="line">            debug(<span class="string">'result'</span>, result);</div><div class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</div><div class="line">            <span class="built_in">console</span>.error(<span class="string">'error in mw dispatch or next call, probably in middlware/reducer/render fn:'</span>, err);</div><div class="line">            <span class="keyword">const</span> msg = (err &amp;&amp; err.message) ? err.message : err;</div><div class="line">            monitor$.next(&#123; action, <span class="attr">err</span>: msg, <span class="attr">op</span>: <span class="string">'nextError'</span> &#125;);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//  actionå˜æˆäº†ä¸€ä¸ªè¢«è½¬æ¢åçš„æ–°action</span></div><div class="line">        monitor$.next(&#123; <span class="attr">nextAction</span>: action, <span class="attr">op</span>: <span class="string">'bottom'</span> &#125;);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">        action$: actionOut$,</div><div class="line">        sub: newSub,</div><div class="line">        logicCount: startLogicCount + arrLogic.length</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢çš„åˆ†æä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡º, <code>applyLogic</code>è¿”å›äº†ä¸€ä¸ªæ–°çš„<a href="https://cn.rx.js.org/class/es6/Observable.js~Observable.html" target="_blank" rel="external">Rx.Observable</a>, é‡Œé¢è°ƒç”¨äº†<code>naming</code>å’Œ<code>wrapper</code>, ä¸‹é¢æˆ‘ä»¬é€ä¸ªåˆ†æä¸‹ã€‚</p>
<p>å…ˆçœ‹<code>naming</code>çš„å®ç°å§:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * åˆ¤æ–­å½“å‰ä¼ å…¥çš„Logicæœ‰æ²¡æœ‰name, æœ‰å°±ä¸åšä»»ä½•æ“ä½œç›´æ¥è¿”å›, æ²¡æœ‰å°±ç»™å½“å‰Logicæ·»åŠ ä¸€ä¸ªnameå±æ€§åè¿”å›</span></div><div class="line"><span class="comment"> * @param  &#123;Object&#125; logic å½“å‰Logic</span></div><div class="line"><span class="comment"> * @param  &#123;Number&#125; idx   å½“å‰Logicåœ¨arrLogicä¸­çš„ä¸‹æ ‡åœ°å€</span></div><div class="line"><span class="comment"> * @return &#123;Object&#125;</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">naming</span>(<span class="params">logic, idx</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (logic.name) &#123; <span class="keyword">return</span> logic; &#125;</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">        ...logic,</div><div class="line">        name: <span class="string">`L(<span class="subst">$&#123;logic.type.toString()&#125;</span>)-<span class="subst">$&#123;idx&#125;</span>`</span></div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å†çœ‹ä¸‹<code>wrapper</code>çš„, <code>wrapper</code>æ˜¯å†™åœ¨<code>src/logicWrapper</code>é‡Œçš„, <code>wrapper</code>è¿”å›çš„æ˜¯ä¸€ä¸ª<code>Rx.Observable</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Logicä¸­ç›¸å…³å¤„ç†</span></div><div class="line"><span class="comment"> * @param  &#123;Object&#125;     options.action   å½“å‰action</span></div><div class="line"><span class="comment"> * @param  &#123;Object&#125;     options.logic    å½“å‰logic</span></div><div class="line"><span class="comment"> * @param  &#123;Object&#125;     options.store    redux store</span></div><div class="line"><span class="comment"> * @param  &#123;Object&#125;     options.deps     createLogicMiddlewareçš„ç¬¬äºŒä¸ªå‚æ•°</span></div><div class="line"><span class="comment"> * @param  &#123;Rx.Subject&#125; options.cancel$  å–æ¶ˆLogicæ‰§è¡Œçš„è®¢é˜…å¯¹è±¡</span></div><div class="line"><span class="comment"> * @param  &#123;Rx.Subject&#125; options.monitor$ å…¨å±€å¯è®¢é˜…å¯¹è±¡</span></div><div class="line"><span class="comment"> * @return &#123;Rx.Observable&#125;</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">createLogicAction$</span>(<span class="params">&#123; action, logic, store, deps, cancel$, monitor$ &#125;</span>) </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">//  reduxStore.getState()</span></div><div class="line">    <span class="keyword">const</span> &#123; getState &#125; = store;</div><div class="line"></div><div class="line">    <span class="comment">//  ä»å½“å‰logicä¸­å–å¾—ç›¸å…³é…ç½®å‚æ•°</span></div><div class="line">    <span class="keyword">const</span> &#123;</div><div class="line">        name,</div><div class="line">        warnTimeout,</div><div class="line">        process: processFn,</div><div class="line">        processOptions: &#123;</div><div class="line">            dispatchReturn,</div><div class="line">            dispatchMultiple,</div><div class="line">            successType,</div><div class="line">            failType</div><div class="line">        &#125;</div><div class="line">    &#125; = logic;</div><div class="line"></div><div class="line">    <span class="comment">//  å½“å‰Logicçš„æ‹¦æˆªå™¨</span></div><div class="line">    <span class="keyword">const</span> intercept = logic.validate || logic.transform;</div><div class="line"></div><div class="line">    debug(<span class="string">'createLogicAction$'</span>, name, action);</div><div class="line"></div><div class="line">    <span class="comment">//  å¼€å§‹æœ¬æ¬¡actionçš„æ‰§è¡Œ</span></div><div class="line">    monitor$.next(&#123; action, name, <span class="attr">op</span>: <span class="string">'begin'</span> &#125;);</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">        1.å½“å‰actionå‘ç”Ÿæ”¹å˜</span></div><div class="line"><span class="comment">        2.åœ¨validate/transformä¸­è°ƒç”¨allow</span></div><div class="line"><span class="comment">        3.æ— æ•ˆçš„action type</span></div><div class="line"><span class="comment">        4.actionè¢«å–æ¶ˆ</span></div><div class="line"><span class="comment">        interceptCompleteéƒ½ä¼šå˜æˆtrue, æ ‡è®°æ‹¦æˆªå™¨å¤„ç†å®Œæˆ</span></div><div class="line"><span class="comment">     **/</span></div><div class="line">    <span class="keyword">let</span> interceptComplete = <span class="literal">false</span>;</div><div class="line"></div><div class="line">    <span class="comment">//  https://cn.rx.js.org/class/es6/Observable.js~Observable.html#instance-method-take</span></div><div class="line">    <span class="keyword">const</span> logicAction$ = Observable.create(<span class="function"><span class="params">logicActionObs</span> =&gt;</span> &#123;</div><div class="line">            <span class="comment">//  åˆ›å»ºä¸€ä¸ªä¸»é¢˜(åªå‘å‡ºä¸€ä¸ªå€¼), ç”¨æ¥è®¢é˜…`å–æ¶ˆLogicæ‰§è¡Œçš„è®¢é˜…å¯¹è±¡`, åœ¨å–æ¶ˆæœ¬æ¬¡actionå, é€šçŸ¥`å–æ¶ˆLogicæ‰§è¡Œçš„è®¢é˜…å¯¹è±¡`</span></div><div class="line">            <span class="keyword">const</span> cancelled$ = (<span class="keyword">new</span> Subject()).take(<span class="number">1</span>);</div><div class="line">            cancel$.subscribe(cancelled$);</div><div class="line">            cancelled$</div><div class="line">                .subscribe(</div><div class="line">                    () =&gt; &#123;</div><div class="line">                        <span class="comment">//  ç¡®ä¿cancelä¸ä¼šè¢«è°ƒç”¨2æ¬¡(åœ¨createLogicMiddleä¸­è¿½åŠ çš„pendingåªä¼šè¢«å‡ä¸€æ¬¡)</span></div><div class="line">                        <span class="keyword">if</span> (!interceptComplete) &#123;</div><div class="line">                            monitor$.next(&#123; action, name, <span class="attr">op</span>: <span class="string">'cancelled'</span> &#125;);</div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            monitor$.next(&#123; action, name, <span class="attr">op</span>: <span class="string">'dispCancelled'</span> &#125;);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                );</div><div class="line"></div><div class="line">            <span class="comment">//  å¦‚æœå½“å‰Logicä¸æ˜¯ä¸€ä¸ªæŒç»­æ€§çš„, ä¸”æ²¡æœ‰åœ¨warnTimeout / 1000ç§’å†…è°ƒç”¨done(warnTimeout &gt; 0), å°±ç»™å‡ºå¼‚å¸¸æç¤º</span></div><div class="line">            <span class="keyword">if</span> (NODE_ENV !== <span class="string">'production'</span> &amp;&amp; warnTimeout) &#123;</div><div class="line">                Observable.timer(warnTimeout)</div><div class="line">                    <span class="comment">//  https://cn.rx.js.org/class/es6/Observable.js~Observable.html#instance-method-takeUntil</span></div><div class="line">                    <span class="comment">//  https://cn.rx.js.org/class/es6/Observable.js~Observable.html#instance-method-defaultIfEmpty</span></div><div class="line">                    .takeUntil(cancelled$.defaultIfEmpty(<span class="literal">true</span>))</div><div class="line">                    .do(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">                        <span class="comment">//	console.error(`warning: logic ($&#123;name&#125;) is still running after $&#123;warnTimeout / 1000&#125;s, forget to call done()? For non-ending logic, set warnTimeout: 0`);</span></div><div class="line">                    &#125;)</div><div class="line">                    .subscribe();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">const</span> dispatch$ = (<span class="keyword">new</span> Subject())</div><div class="line">                .mergeAll()</div><div class="line">                .takeUntil(cancel$);</div><div class="line"></div><div class="line">            dispatch$</div><div class="line">                <span class="comment">/**</span></div><div class="line"><span class="comment">                    .do(&#123;</span></div><div class="line"><span class="comment">                        nextOrObserver: mapToActionAndDispatch,</span></div><div class="line"><span class="comment">                        error: mapErrorToActionAndDispatch</span></div><div class="line"><span class="comment">                    &#125;)</span></div><div class="line"><span class="comment">                    è¿™é‡Œçœç•¥äº†nextOrObserverå’Œerror</span></div><div class="line"><span class="comment">                    https://cn.rx.js.org/class/es6/Observable.js~Observable.html#instance-method-do</span></div><div class="line"><span class="comment">                 **/</span></div><div class="line">                .do(</div><div class="line">                    mapToActionAndDispatch,</div><div class="line">                    mapErrorToActionAndDispatch</div><div class="line">                )</div><div class="line">                .subscribe(&#123;</div><div class="line">                    error: <span class="function">(<span class="params"> <span class="regexp">/* err */</span> </span>) =&gt;</span> &#123;</div><div class="line">                        <span class="comment">//  åœ¨å‘ç”Ÿå¼‚å¸¸å, ç»ˆæ­¢æœ¬æ¬¡acion, å¹¶ä¸”å–æ¶ˆè®¢é˜…cancelled$</span></div><div class="line">                        monitor$.next(&#123; action, name, <span class="attr">op</span>: <span class="string">'end'</span> &#125;);</div><div class="line">                        cancelled$.complete();</div><div class="line">                        cancelled$.unsubscribe();</div><div class="line">                    &#125;,</div><div class="line">                    complete: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">                        <span class="comment">//  æœ¬æ¬¡actionå¤„ç†å®Œæˆ</span></div><div class="line">                        monitor$.next(&#123; action, name, <span class="attr">op</span>: <span class="string">'end'</span> &#125;);</div><div class="line">                        cancelled$.complete();</div><div class="line">                        cancelled$.unsubscribe();</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line"></div><div class="line">            <span class="comment">//  è§¦å‘reduxé‡Œé¢çš„action</span></div><div class="line">            <span class="function"><span class="keyword">function</span> <span class="title">storeDispatch</span>(<span class="params">act</span>) </span>&#123;</div><div class="line">                monitor$.next(&#123; action, <span class="attr">dispAction</span>: act, <span class="attr">op</span>: <span class="string">'dispatch'</span> &#125;);</div><div class="line">                <span class="keyword">return</span> store.dispatch(act);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">/**</span></div><div class="line"><span class="comment">             * é€‚é…ä¸åŒæƒ…å†µçš„action, ç»„è£…åå¦‚æœæ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„redux action, å°±è°ƒç”¨reduxStore.dispatch</span></div><div class="line"><span class="comment">             * @param  &#123;Object&#125; actionOrValue</span></div><div class="line"><span class="comment">             */</span></div><div class="line">            <span class="function"><span class="keyword">function</span> <span class="title">mapToActionAndDispatch</span>(<span class="params">actionOrValue</span>) </span>&#123;</div><div class="line">                <span class="comment">/**</span></div><div class="line"><span class="comment">                    let act;</span></div><div class="line"><span class="comment">                    if (isInterceptAction(actionOrValue)) &#123;</span></div><div class="line"><span class="comment">                        act = unwrapInterceptAction(actionOrValue);</span></div><div class="line"><span class="comment">                    &#125; else &#123;</span></div><div class="line"><span class="comment">                        if (successType) &#123;</span></div><div class="line"><span class="comment">                            act = mapToAction(successType, actionOrValue, false);</span></div><div class="line"><span class="comment">                        &#125; else &#123;</span></div><div class="line"><span class="comment">                            act = actionOrValue;</span></div><div class="line"><span class="comment">                        &#125;</span></div><div class="line"><span class="comment">                    &#125;</span></div><div class="line"><span class="comment">                    æŠŠä¸‹é¢çš„ä»£ç æ‹†æˆä¸Šé¢çš„æ ·å­, å¤§æ¦‚åšäº†ä¸‹é¢å‡ ä»¶äº‹æƒ…:</span></div><div class="line"><span class="comment">                    åˆ¤æ–­æ˜¯ä¸æ˜¯ä¸€ä¸ªæ‹¦æˆªå™¨, å¦‚æœæ˜¯å°±æŠŠä¹‹å‰åŒ…è£…çš„æ‹¦æˆªå™¨è§£åŒ…</span></div><div class="line"><span class="comment">                    åˆ¤æ–­processOptions.successTypeæ˜¯å¦å­˜åœ¨, å­˜åœ¨å°±è°ƒç”¨mapToAction, æ‹¼å‡ºä¸€ä¸ªæ–°çš„redux action, è°ƒç”¨reduxSrore.dispatch</span></div><div class="line"><span class="comment">                    å¦åˆ™å°±ç›´æ¥ä½¿ç”¨actionOrValue</span></div><div class="line"><span class="comment">                **/</span></div><div class="line">                <span class="keyword">const</span> act = (isInterceptAction(actionOrValue)) ? </div><div class="line">                unwrapInterceptAction(actionOrValue) : (successType) ? </div><div class="line">                mapToAction(successType, actionOrValue, <span class="literal">false</span>) : actionOrValue;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (act) &#123;</div><div class="line">                    storeDispatch(act);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">/**</span></div><div class="line"><span class="comment">             * æ ¹æ®actionOrValueçš„ç±»å‹æ¥ç»„è£…å¯ä»¥è¢«reduxStore.dispatchè°ƒç”¨çš„action</span></div><div class="line"><span class="comment">             * @param  &#123;any&#125; actionOrValue</span></div><div class="line"><span class="comment">             * @return &#123;Object&#125;</span></div><div class="line"><span class="comment">             */</span></div><div class="line">            <span class="function"><span class="keyword">function</span> <span class="title">mapErrorToActionAndDispatch</span>(<span class="params">actionOrValue</span>) </span>&#123;</div><div class="line">                <span class="comment">//  æ‹¦æˆªå™¨ç±»å‹çš„ç›´æ¥è°ƒç”¨è§¦å‘__interceptAction</span></div><div class="line">                <span class="keyword">if</span> (isInterceptAction(actionOrValue)) &#123;</div><div class="line">                    <span class="keyword">const</span> interceptAction = unwrapInterceptAction(actionOrValue);</div><div class="line">                    <span class="keyword">return</span> storeDispatch(interceptAction);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">//  åˆ¤æ–­Logicä¸­çš„processOptionsé‡Œæœ‰æ²¡æœ‰failType</span></div><div class="line">                <span class="keyword">if</span> (failType) &#123;</div><div class="line">                    <span class="comment">//  å¦‚æœæœ‰failType, ç»„è£…ä¸€ä¸ªæ–°çš„redux actionå¹¶è§¦å‘</span></div><div class="line">                    <span class="keyword">const</span> act = mapToAction(failType, actionOrValue, <span class="literal">true</span>);</div><div class="line">                    <span class="keyword">if</span> (act) &#123;</div><div class="line">                        <span class="keyword">return</span> storeDispatch(act);</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">//  actionOrValueæœ¬èº«å°±æ˜¯ä¸€ä¸ªå¼‚å¸¸</span></div><div class="line">                <span class="keyword">if</span> (actionOrValue <span class="keyword">instanceof</span> <span class="built_in">Error</span>) &#123;</div><div class="line">                    <span class="keyword">const</span> act =</div><div class="line">                        <span class="comment">//  actionOrValueæœ¬èº«åŒ…å«type, ç›´æ¥è°ƒç”¨redux.dispatch(actionOrValue)</span></div><div class="line">                        <span class="comment">//  å¦åˆ™åŒ…è£…å‡ºä¸€ä¸ªredux action(typeä¸ºUNHANDLED_LOGIC_ERROR), åœ¨è°ƒç”¨redux.dispatch</span></div><div class="line">                        (actionOrValue.type) ? actionOrValue :</div><div class="line">                        &#123;</div><div class="line">                            type: UNHANDLED_LOGIC_ERROR,</div><div class="line">                            payload: actionOrValue,</div><div class="line">                            error: <span class="literal">true</span></div><div class="line">                        &#125;;</div><div class="line">                    <span class="keyword">return</span> storeDispatch(act);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">//  actionOrValueæ˜¯ä¸€ä¸ªplain objectæˆ–ä¸€ä¸ªå‡½æ•°(action creator)</span></div><div class="line">                <span class="keyword">const</span> typeOfValue = <span class="keyword">typeof</span> actionOrValue;</div><div class="line">                <span class="keyword">if</span> (actionOrValue &amp;&amp; (typeOfValue === <span class="string">'object'</span> || typeOfValue === <span class="string">'function'</span>)) &#123;</div><div class="line">                    <span class="keyword">return</span> storeDispatch(actionOrValue);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">//  éå¼‚å¸¸/å‡½æ•°/plain objectçš„æƒ…å†µ</span></div><div class="line">                storeDispatch(&#123;</div><div class="line">                    type: UNHANDLED_LOGIC_ERROR,</div><div class="line">                    payload: actionOrValue,</div><div class="line">                    error: <span class="literal">true</span></div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">/**</span></div><div class="line"><span class="comment">             * ç»„è£…å‡ºä¸€ä¸ªæœ‰æ•ˆçš„redux actionå¹¶è¿”å›</span></div><div class="line"><span class="comment">             * @param  &#123;String|Function&#125; type       redux action type</span></div><div class="line"><span class="comment">             * @param  &#123;Object&#125; payload             redux payload</span></div><div class="line"><span class="comment">             * @param  &#123;Error|Unfdeined&#125; err        error</span></div><div class="line"><span class="comment">             * @return &#123;Object&#125;</span></div><div class="line"><span class="comment">             */</span></div><div class="line">            <span class="function"><span class="keyword">function</span> <span class="title">mapToAction</span>(<span class="params">type, payload, err</span>) </span>&#123;</div><div class="line">                <span class="comment">//  action typeæœ¬èº«æ˜¯ä¸€ä¸ªaction creator, ç›´æ¥æ‰§è¡Œtype</span></div><div class="line">                <span class="keyword">if</span> (<span class="keyword">typeof</span> type === <span class="string">'function'</span>) &#123;</div><div class="line">                    <span class="keyword">return</span> type(payload);</div><div class="line">                &#125;</div><div class="line">                <span class="comment">//  åŒ…è£…å‡ºä¸€ä¸ªæœ‰æ•ˆçš„redux action</span></div><div class="line">                <span class="keyword">const</span> act = &#123; type, payload &#125;;</div><div class="line">                <span class="keyword">if</span> (err) &#123; act.error = <span class="literal">true</span>; &#125;</div><div class="line">                <span class="keyword">return</span> act;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// allowMore is now deprecated in favor of variable process arity</span></div><div class="line">            <span class="comment">// which sets processOptions.dispatchMultiple = true then</span></div><div class="line">            <span class="comment">// expects done() cb to be called to end</span></div><div class="line">            <span class="comment">// Might still be needed for internal use so keeping it for now</span></div><div class="line">            <span class="keyword">const</span> DispatchDefaults = &#123;</div><div class="line">                allowMore: <span class="literal">false</span></div><div class="line">            &#125;;</div><div class="line"></div><div class="line">            <span class="comment">/**</span></div><div class="line"><span class="comment">             * è§¦å‘</span></div><div class="line"><span class="comment">             * @param  &#123;[type]&#125; act     [description]</span></div><div class="line"><span class="comment">             * @param  &#123;[type]&#125; options [description]</span></div><div class="line"><span class="comment">             * @return &#123;[type]&#125;         [description]</span></div><div class="line"><span class="comment">             */</span></div><div class="line">            <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">act, options = DispatchDefaults</span>) </span>&#123;</div><div class="line">                <span class="keyword">const</span> &#123; allowMore &#125; = applyDispatchDefaults(options);</div><div class="line">                <span class="comment">//  action !== undefined</span></div><div class="line">                <span class="keyword">if</span> (<span class="keyword">typeof</span> act !== <span class="string">'undefined'</span>) &#123;</div><div class="line">                    <span class="comment">/**</span></div><div class="line"><span class="comment">                        let action;</span></div><div class="line"><span class="comment">                        if (isObservable(act)) &#123;</span></div><div class="line"><span class="comment">                            action = act;</span></div><div class="line"><span class="comment">                        &#125; else if (isPromise(act)) &#123;</span></div><div class="line"><span class="comment">                            action = Observable.fromPromise(act);</span></div><div class="line"><span class="comment">                        &#125; else if (act instanceof Error) &#123;</span></div><div class="line"><span class="comment">                            action = Observable.throw(act);</span></div><div class="line"><span class="comment">                        &#125; else &#123;</span></div><div class="line"><span class="comment">                            action = Observable.of(act);</span></div><div class="line"><span class="comment">                        &#125;</span></div><div class="line"><span class="comment">                        dispatch$.next(action);</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">                        https://cn.rx.js.org/class/es6/MiscJSDoc.js~ObserverDoc.html#instance-method-next</span></div><div class="line"><span class="comment">                     **/</span></div><div class="line">                    dispatch$.next(</div><div class="line">                        (isObservable(act)) ? act :</div><div class="line">                        (isPromise(act)) ? Observable.fromPromise(act) :</div><div class="line">                        (act <span class="keyword">instanceof</span> <span class="built_in">Error</span>) ? Observable.throw(act) :</div><div class="line">                        Observable.of(act)</div><div class="line">                    );</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (!(dispatchMultiple || allowMore)) &#123;</div><div class="line">                   dispatch$.complete();</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span> act;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="function"><span class="keyword">function</span> <span class="title">applyDispatchDefaults</span>(<span class="params">options</span>) </span>&#123;</div><div class="line">                <span class="keyword">return</span> &#123;</div><div class="line">                    ...DispatchDefaults,</div><div class="line">                    ...options</div><div class="line">                &#125;;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">//  æ‹¼è£…createLogicä¸­ç›¸å…³é’©å­å‡½æ•°(validate/tranform/process)ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°</span></div><div class="line">            <span class="keyword">const</span> depObj = &#123;</div><div class="line">                ...deps,</div><div class="line">                cancelled$,</div><div class="line">                ctx: &#123;&#125;, <span class="comment">// åœ¨ä¸åŒé’©å­ä¸­å…±äº«æ•°æ®</span></div><div class="line">                getState,</div><div class="line">                action</div><div class="line">            &#125;;</div><div class="line"></div><div class="line">            <span class="function"><span class="keyword">function</span> <span class="title">shouldDispatch</span>(<span class="params">act, useDispatch</span>) </span>&#123;</div><div class="line">                <span class="comment">//  æ–°çš„actionä¸ºç©º</span></div><div class="line">                <span class="keyword">if</span> (!act) &#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</div><div class="line">                <span class="comment">//  åœ¨è§¦å‘å¦å¤–ä¸€ä¸ªactionä¹‹å‰, ç¡®ä¿è§¦å‘çš„æ˜¯ä¸€ä¸ªæ–°çš„action</span></div><div class="line">                <span class="keyword">if</span> (useDispatch === <span class="string">'auto'</span>) &#123;</div><div class="line">                    <span class="keyword">return</span> (act.type !== action.type);</div><div class="line">                &#125;</div><div class="line">                <span class="comment">//  å¦åˆ™æ ¹æ®useDispatchæ˜¯å¦ä¸ºç©º, è¿”å›</span></div><div class="line">                <span class="keyword">return</span> (useDispatch);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">const</span> AllowRejectNextDefaults = &#123;</div><div class="line">                useDispatch: <span class="string">'auto'</span></div><div class="line">            &#125;;</div><div class="line"></div><div class="line">            <span class="function"><span class="keyword">function</span> <span class="title">applyAllowRejectNextDefaults</span>(<span class="params">options</span>) </span>&#123;</div><div class="line">                <span class="keyword">return</span> &#123;</div><div class="line">                    ...AllowRejectNextDefaults,</div><div class="line">                    ...options</div><div class="line">                &#125;;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">//  æ‹¦æˆªå™¨(validate/tranform)é‡Œçš„allowæˆ–next</span></div><div class="line">            <span class="function"><span class="keyword">function</span> <span class="title">allow</span>(<span class="params">act, options = AllowRejectNextDefaults</span>) </span>&#123;</div><div class="line">                handleNextOrDispatch(<span class="literal">true</span>, act, options);</div><div class="line">            &#125;</div><div class="line">            <span class="function"><span class="keyword">function</span> <span class="title">reject</span>(<span class="params">act, options = AllowRejectNextDefaults</span>) </span>&#123;</div><div class="line">                handleNextOrDispatch(<span class="literal">false</span>, act, options);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">//  å®Œæˆæœ¬æ¬¡action, åœ¨createLogicä¸­çš„processæœ€åè°ƒç”¨</span></div><div class="line">            <span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params"></span>) </span>&#123;</div><div class="line">                dispatch$.complete();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">/**</span></div><div class="line"><span class="comment">             * å¯¹å½“å‰æ‹¦æˆªå™¨ç±»å‹action(validate/transform)åšä¸€æ¬¡åŒ…è£…, æ–¹ä¾¿åé¢åˆ¤æ–­</span></div><div class="line"><span class="comment">             * @param  &#123;Object&#125; act å½“å‰action</span></div><div class="line"><span class="comment">             * @return &#123;Object&#125;</span></div><div class="line"><span class="comment">             */</span></div><div class="line">            <span class="function"><span class="keyword">function</span> <span class="title">wrapActionForIntercept</span>(<span class="params">act</span>) </span>&#123;</div><div class="line">                <span class="keyword">if</span> (!act) &#123; <span class="keyword">return</span> act; &#125;</div><div class="line">                <span class="keyword">return</span> &#123;</div><div class="line">                    __interceptAction: act</div><div class="line">                &#125;;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">/**</span></div><div class="line"><span class="comment">             * åˆ¤æ–­ä¼ å…¥çš„actionæ˜¯å¦ä¸ºæ‹¦æˆªå™¨ç±»å‹çš„</span></div><div class="line"><span class="comment">             * @param  &#123;Object&#125;  act å½“å‰action</span></div><div class="line"><span class="comment">             * @return &#123;Boolean&#125;</span></div><div class="line"><span class="comment">             */</span></div><div class="line">            <span class="function"><span class="keyword">function</span> <span class="title">isInterceptAction</span>(<span class="params">act</span>) </span>&#123;</div><div class="line">                <span class="keyword">return</span> act &amp;&amp; act.__interceptAction;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">/**</span></div><div class="line"><span class="comment">             * å¯¹æ‹¦æˆªå™¨æ‰§è¡Œè§£åŒ…</span></div><div class="line"><span class="comment">             * @param  &#123;Object&#125;  act å½“å‰action</span></div><div class="line"><span class="comment">             * @return &#123;Object&#125;      redux action</span></div><div class="line"><span class="comment">             */</span></div><div class="line">            <span class="function"><span class="keyword">function</span> <span class="title">unwrapInterceptAction</span>(<span class="params">act</span>) </span>&#123;</div><div class="line">                <span class="keyword">return</span> act.__interceptAction;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">/**</span></div><div class="line"><span class="comment">             * æ‹¦æˆªå™¨(validate/tranform)é‡Œçš„allowã€rejectå®ç°, è§¦å‘æ–°çš„redux action</span></div><div class="line"><span class="comment">             * @param  &#123;Boolean&#125; shouldProcess æ˜¯å¦æ‰§è¡Œprocess</span></div><div class="line"><span class="comment">             * @param  &#123;Object&#125; act            æ–°çš„redux action</span></div><div class="line"><span class="comment">             * @param  &#123;Object&#125; options</span></div><div class="line"><span class="comment">             */</span></div><div class="line">            <span class="function"><span class="keyword">function</span> <span class="title">handleNextOrDispatch</span>(<span class="params">shouldProcess, act, options</span>) </span>&#123;</div><div class="line">                <span class="keyword">const</span> &#123; useDispatch &#125; = applyAllowRejectNextDefaults(options);</div><div class="line">                <span class="comment">//  åˆ¤æ–­æ˜¯å¦åº”è¯¥è§¦å‘ä¼ å…¥çš„redux action</span></div><div class="line">                <span class="keyword">if</span> (shouldDispatch(act, useDispatch)) &#123;</div><div class="line">                    monitor$.next(&#123; action, <span class="attr">dispAction</span>: act, name, shouldProcess, <span class="attr">op</span>: <span class="string">'nextDisp'</span> &#125;);</div><div class="line">                    interceptComplete = <span class="literal">true</span>;</div><div class="line">                    dispatch(wrapActionForIntercept(act), &#123; <span class="attr">allowMore</span>: <span class="literal">true</span> &#125;); <span class="comment">// will be completed later</span></div><div class="line">                    logicActionObs.complete(); <span class="comment">// dispatched action, so no next(act)</span></div><div class="line">                &#125; <span class="keyword">else</span> &#123; <span class="comment">// normal next</span></div><div class="line">                    <span class="keyword">if</span> (act) &#123;</div><div class="line">                        monitor$.next(&#123; action, <span class="attr">nextAction</span>: act, name, shouldProcess, <span class="attr">op</span>: <span class="string">'next'</span> &#125;);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        <span class="comment">//  æ— æ•ˆçš„action, ç›´æ¥ç»“æŸæœ¬æ¬¡æ‹¦æˆªå™¨</span></div><div class="line">                        monitor$.next(&#123; action, name, shouldProcess, <span class="attr">op</span>: <span class="string">'filtered'</span> &#125;);</div><div class="line">                        interceptComplete = <span class="literal">true</span>;</div><div class="line">                    &#125;</div><div class="line">                    postIfDefinedOrComplete(act, logicActionObs);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">//  æ‰§è¡ŒLogicä¸­çš„processå›è°ƒ</span></div><div class="line">                <span class="keyword">if</span> (shouldProcess) &#123;</div><div class="line">                    <span class="comment">//  ç»„ç»‡depObjçš„actionå‚æ•°</span></div><div class="line">                    depObj.action = act || action;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        <span class="keyword">const</span> retValue = processFn(depObj, dispatch, done);</div><div class="line">                        <span class="comment">/**</span></div><div class="line"><span class="comment">                            å¦‚æœåœ¨createLogicæŒ‡å®šäº†processOption.dispatchReturnä¸ºtrue, å¹¶ä¸”prcessæ‰§è¡Œå®Œä¹‹åè¿”å›æœ‰æ•ˆçš„å€¼</span></div><div class="line"><span class="comment">                            å°±å†æŠŠè¿”å›å€¼ä½œä¸ºä¸€ä¸ªæ–°çš„redux actionè¿›è¡Œè§¦å‘</span></div><div class="line"><span class="comment">                            å¦åˆ™ç›´æ¥ç»“æŸdispatch$è¿™ä¸ªRx.Subject</span></div><div class="line"><span class="comment">                            </span></div><div class="line"><span class="comment">                            æ‰§è¡Œprocess, å¹¶ä¸”æ¥æ”¶è¿”å›å€¼</span></div><div class="line"><span class="comment">                            åˆ¤æ–­processOption.dispatchReturn</span></div><div class="line"><span class="comment">                                æˆç«‹: åˆ¤æ–­è¿”å›å€¼æ˜¯å¦æœ‰æ•ˆ</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">                                    æœ‰æ•ˆ: dispatch -&gt; mapToActionAndDispatch</span></div><div class="line"><span class="comment">                                        mapToActionAndDispatchè¿”å›ä¸€ä¸ªæœ‰æ•ˆçš„action:</span></div><div class="line"><span class="comment">                                            ç»§ç»­reduxStore.dispatch(mapToActionAndDispatch(retValue))</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">                                    æ— æ•ˆ: dispatch$.complete -&gt; monitor$.next(&#123; action, name, op: 'end' &#125;); cancelled$.complete(); cancelled$.unsubscribe();</span></div><div class="line"><span class="comment">                        **/</span></div><div class="line">                        <span class="keyword">if</span> (dispatchReturn) &#123;</div><div class="line">                            <span class="keyword">if</span> (<span class="keyword">typeof</span> retValue === <span class="string">'undefined'</span>) &#123;</div><div class="line">                                dispatch$.complete();</div><div class="line">                            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                                dispatch(retValue);</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">catch</span> (err) &#123;</div><div class="line">                        <span class="built_in">console</span>.error(<span class="string">`unhandled exception in logic named: <span class="subst">$&#123;name&#125;</span>`</span>, err);</div><div class="line">                        <span class="comment">//  æ‰§è¡Œprocessçš„è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸</span></div><div class="line">                        dispatch(Observable.throw(err));</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">//  ä¼ å…¥çš„actæ˜¯ä¸€ä¸ªç©ºå€¼, æˆ–è€…å’Œå½“å‰çš„typeç›¸åŒ, æˆ–è€…useDispatchä¸æˆç«‹</span></div><div class="line">                    dispatch$.complete();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">/**</span></div><div class="line"><span class="comment">             * åœ¨æœ¬æ¬¡æ‹¦æˆªå™¨ä¹‹åæ‰§è¡Œ</span></div><div class="line"><span class="comment">             * @param  &#123;Object&#125; act       æ–°çš„action</span></div><div class="line"><span class="comment">             * @param  &#123;Rx.Subject&#125; act$  å½“å‰actionå¯¹åº”çš„Observableå¯¹è±¡</span></div><div class="line"><span class="comment">             */</span></div><div class="line">            <span class="function"><span class="keyword">function</span> <span class="title">postIfDefinedOrComplete</span>(<span class="params">act, act$</span>) </span>&#123;</div><div class="line">                <span class="comment">//  å¦‚æœæ–°çš„actionå­˜åœ¨, æ‰§è¡Œæ–°çš„action</span></div><div class="line">                <span class="keyword">if</span> (act) &#123;</div><div class="line">                    act$.next(act);</div><div class="line">                &#125;</div><div class="line">                interceptComplete = <span class="literal">true</span>;</div><div class="line">                act$.complete();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">//  å¼€å§‹æœ¬æ¬¡actionçš„æ‰§è¡Œ</span></div><div class="line">            <span class="function"><span class="keyword">function</span> <span class="title">start</span>(<span class="params"></span>) </span>&#123;</div><div class="line">                intercept(depObj, allow, reject);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            start();</div><div class="line">        &#125;)</div><div class="line">        .takeUntil(cancel$)</div><div class="line">        <span class="comment">//  è§„å®šlogicAction$å€¼å‘å‡ºä¸€ä¸ªå€¼å°±å®Œæˆ</span></div><div class="line">        .take(<span class="number">1</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> logicAction$;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»¥ä¸Šå°±æ˜¯æœ¬äººå¯¹<code>redux-logic</code>çš„é˜…è¯», ç»è¿‡é˜…è¯», å¤§è‡´äº†è§£åˆ°æ•´ä¸ª<code>redux-logic</code>çš„æ‰§è¡Œé¡ºåºåº”è¯¥æ˜¯ä¸‹å›¾æ‰€ç¤ºçš„æ ·å­ã€‚</p>
<p><img src="/imgs/redux-logic.png" alt=""></p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/11/09/2017-11-09-vue-computed/" class="next">NEXT</a></div><div class="copyright"><p>Â© 2015 - 2018 <a href="http://yoursite.com">rwson</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>