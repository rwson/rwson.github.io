<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> redux-logicæºç é˜…è¯» Â· å°å®‹</title><meta name="description" content="redux-logicæºç é˜…è¯» - rwson"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="å°å®‹"><link rel="alternate" href="/atom.xml" title="å°å®‹" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/sunchongsheng" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/pinggod" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">redux-logicæºç é˜…è¯»</h1><div class="post-info">Jun 6, 2018</div><div class="post-content"><p>åœ¨ç”¨<a href="https://reactjs.org/" target="_blank" rel="noopener">React</a>å’Œ<a href="https://redux.js.org/" target="_blank" rel="noopener">Redux</a>åšå¼€å‘æ—¶, éƒ½ä¼šç”¨åˆ°å¼‚æ­¥çš„ä¸€äº›ä¸œè¥¿, ä¹‹å‰æ›´å¤šçš„ç”¨çš„æ˜¯<code>redux-thunk</code>æˆ–è€…<code>redux-saga</code>ä¹‹ç±»çš„, ä½†æ˜¯éƒ½æœ‰ç”¨çš„ä¸é¡ºçš„åœ°æ–¹, æœ‰ä¸€æ¬¡çªç„¶å‘ç°<a href="https://github.com/jeffbski/redux-logic" target="_blank" rel="noopener">redux-logic</a>æ˜¯ä¸€ä¸ªå¾ˆä¸é”™çš„è§£å†³æ–¹æ¡ˆ, ç”¨èµ·æ¥ä¹Ÿæ„Ÿè§‰å¾ˆé¡ºæ‰‹, ä¸å¸‚é¢ä¸Šå…¶ä»–<code>redux</code>ä¸­é—´ä»¶ä¸åŒçš„åˆ†æéƒ½åœ¨<a href="https://codewinds.com/assets/article/redux-logic-nodevember.pdf" target="_blank" rel="noopener">è¿™é‡Œ</a>, æ„Ÿå…´è¶£çš„å¯ä»¥è‡ªå·±æŸ¥çœ‹ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸‹<code>redux-logic</code>çš„åŸºæœ¬ç”¨æ³•:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//	logic/index.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; createLogic &#125; <span class="keyword">from</span> <span class="string">'redux-logic'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> someLogic = createLogic(&#123;</span><br><span class="line">	<span class="comment">//	å½“å‰logicç›‘å¬çš„actionType</span></span><br><span class="line">	type: <span class="string">'SOME_ACTION_TYPE'</span>,</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	å–æ¶ˆå½“å‰logicæ‰§è¡Œçš„actionType</span></span><br><span class="line">	cancelType: <span class="string">'CANCEL_TYPE'</span>,</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	æ˜¯å¦è·å–æœ€åä¸€ä¸ªè¿”å›</span></span><br><span class="line">	latest: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	å½“å‰actionTypeçš„ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line">	<span class="keyword">async</span> process(&#123; getState, action, cancelled &#125;, dispatch, done) &#123;</span><br><span class="line">		<span class="keyword">const</span> res = <span class="keyword">await</span> asyncFn();</span><br><span class="line">		dispatch(newAction(&#123;</span><br><span class="line">			...res</span><br><span class="line">		&#125;));</span><br><span class="line">		done();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> someLogic;</span><br><span class="line"></span><br><span class="line"><span class="comment">//	store/index.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; createStore, applyMiddleware &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createLogicMiddleware &#125; <span class="keyword">from</span> <span class="string">'redux-logic'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; routerMiddleware &#125; <span class="keyword">from</span> <span class="string">'react-router-redux'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> reducer <span class="keyword">from</span> <span class="string">'../reducers'</span>;</span><br><span class="line"><span class="keyword">import</span> history <span class="keyword">from</span> <span class="string">'../history'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; someLogic &#125; <span class="keyword">from</span> <span class="string">'../logic'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> configureStore = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> reduxRouteMiddleware = routerMiddleware(history),</span><br><span class="line"></span><br><span class="line">		<span class="comment">//	å°†æ‰€æœ‰çš„logicåº”ç”¨åˆ°ä¸­é—´ä»¶ä¸­</span></span><br><span class="line">    	loggicMiddleware = createLogicMiddleware([someLogic]),</span><br><span class="line">    	middlewares = process.env.NODE_ENV === <span class="string">'development'</span> ? [loggicMiddleware, reduxRouteMiddleware, logger] : [loggicMiddleware, reduxRouteMiddleware],</span><br><span class="line">        createStoreWithMiddleware = applyMiddleware(...middlewares)(createStore),</span><br><span class="line">        store = createStoreWithMiddleware(reducer);</span><br><span class="line">    <span class="keyword">return</span> store;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> configureStore();</span><br></pre></td></tr></table></figure>
<p>æœ¬æ–‡ä¼šé€æ­¥åˆ†æ<code>redux-logic</code>çš„ç›¸å…³å®ç°, é¦–å…ˆæŠŠ<a href="https://github.com/jeffbski/redux-logic" target="_blank" rel="noopener">redux-logic</a>å…‹éš†åˆ°æœ¬åœ°, æºç éƒ½ä½äº<code>redux-logic/src</code>é‡Œé¢, æ‰€ä»¥æˆ‘ä»¬ä»<code>src/index.js</code>å¼€å§‹:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> createLogic, &#123; configureLogic &#125; <span class="keyword">from</span> <span class="string">'./createLogic'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> createLogicMiddleware <span class="keyword">from</span> <span class="string">'./createLogicMiddleware'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  configureLogic,</span><br><span class="line">  createLogic,</span><br><span class="line">  createLogicMiddleware</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  configureLogic,</span><br><span class="line">  createLogic,</span><br><span class="line">  createLogicMiddleware</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢çš„ä»£ç ä¸­å¯ä»¥çœ‹åˆ°, ä¸€å…±å¯¼å‡º3ä¸ªå‡½æ•°, <code>configureLogic</code>çš„åŠŸèƒ½å°±æ˜¯å¯¹æ‰€æœ‰çš„<code>logic</code>è¿›è¡Œé…ç½®(è¶…æ—¶è­¦å‘Šæ—¶é—´ç­‰), æˆ‘ä»¬ä¸»è¦çœ‹<code>createLogic</code>å’Œ<code>createLogicMiddleware</code>:</p>
<ul>
<li>createLogic</li>
</ul>
<p><code>createLogic</code>ä½äº<code>src/createLogic</code>é‡Œ</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ›å»ºä¸€ä¸ªLogicå¯¹è±¡</span></span><br><span class="line"><span class="comment"> * @param  &#123;Object&#125; logicOptions</span></span><br><span class="line"><span class="comment"> *         @param  &#123;String&#125;     logicOptions.name           å¯é€‰å€¼, ä¸»è¦ç”¨äºLogicä¸­çš„å¼‚å¸¸æç¤º, å¯é€‰å€¼</span></span><br><span class="line"><span class="comment"> *         @param  &#123;String&#125;     logicOptions.type           è§¦å‘å½“å‰Logicçš„redux action type</span></span><br><span class="line"><span class="comment"> *         @param  &#123;String&#125;     logicOptions.cancelType     å–æ¶ˆæ‰§è¡Œå½“å‰Logicçš„redux action type</span></span><br><span class="line"><span class="comment"> *         @param  &#123;Boolean&#125;    logicOptions.latest         æ˜¯å¦åªè·å–æœ€åä¸€æ¬¡çš„ç»“æœ,ç±»ä¼¼redux-sagaä¸­çš„takeLatest effect</span></span><br><span class="line"><span class="comment"> *         @param  &#123;Number&#125;     logicOptions.debounce       å‡½æ•°å»æŠ–é…ç½®, å•ä½ä¸ºæ¯«ç§’</span></span><br><span class="line"><span class="comment"> *         @param  &#123;Object&#125;     logicOptions.throttle       å‡½æ•°èŠ‚æµé…ç½®, å•ä½ä¸ºæ¯«ç§’</span></span><br><span class="line"><span class="comment"> *         @param  &#123;Function&#125;   logicOptions.validate       åœ¨æ‰§è¡Œprocessä¹‹å‰çš„ä¸€ä¸ªé’©å­, å¯ä»¥å¯¹å½“å‰actionæ‰§è¡Œä¸€äº›æ“ä½œ</span></span><br><span class="line"><span class="comment"> *         @param  &#123;Function&#125;   logicOptions.transform      validateçš„ä¸€ä¸ªåˆ«å, validateå’Œtransformåªéœ€æŒ‡å®šä¸€ä¸ªå³å¯</span></span><br><span class="line"><span class="comment"> *         @param  &#123;Function&#125;   logicOptions.process        å½“å‰redux action typeå¯¹åº”çš„å¤„ç†é€»è¾‘(å‘èµ·å¼‚æ­¥è¯·æ±‚, åœ¨å¼‚æ­¥è¯·æ±‚è¿”å›æˆåŠŸä¹‹åè§¦å‘æ–°çš„redux action)</span></span><br><span class="line"><span class="comment"> *         @param  &#123;Object&#125;     logicOptions.processOptions processä¸­éœ€è¦çš„ä¸€äº›é…ç½®</span></span><br><span class="line"><span class="comment"> *         @param  &#123;Number&#125;     logicOptions.warnTimeout    è¶…æ—¶è­¦å‘Šæ—¶é—´, é»˜è®¤60ç§’, éœ€è¦åœ¨processä¸­æ‰‹åŠ¨è°ƒç”¨doneæ¥ç»ˆæ­¢è¿™ä¸ªLogic, å¦‚æœæ˜¯ä¸€ä¸ªæŒç»­æ€§çš„Logic, warnTimeoutéœ€è¦è®¾ç½®æˆ0</span></span><br><span class="line"><span class="comment"> * @return &#123;Object&#125;              åˆ›å»ºå‡ºæ¥çš„Logic</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">createLogic</span>(<span class="params">logicOptions = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//  æ— æ•ˆé…ç½®é¡¹éªŒè¯, æŠŠæ— æ•ˆçš„é…ç½®é¡¹é”®åæ”¾æ•°ç»„è¿”å›</span></span><br><span class="line">    <span class="keyword">const</span> invalidOptions = getInvalidOptions(logicOptions, allowedOptions);</span><br><span class="line">    <span class="keyword">if</span> (invalidOptions.length) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`unknown or misspelled option(s): <span class="subst">$&#123;invalidOptions&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  name, type, cancelType, validate, transforméƒ½ä»ä¼ å…¥çš„logicOptionsé‡Œé¢è·å–</span></span><br><span class="line">    <span class="comment">//  å¦‚æœå…¶ä»–é…ç½®é¡¹æ²¡æœ‰åœ¨logicOptionsä¸­å£°æ˜, å°±ä»é»˜è®¤é…ç½®ä¸­è·å–æˆ–è€…ç»™ä¸€ä¸ªé»˜è®¤å€¼</span></span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">        name,</span><br><span class="line">        type,</span><br><span class="line">        cancelType,</span><br><span class="line">        warnTimeout = defaultOptions.warnTimeout,</span><br><span class="line">        latest = defaultOptions.latest,</span><br><span class="line">        debounce = defaultOptions.debounce,</span><br><span class="line">        throttle = defaultOptions.throttle,</span><br><span class="line">        validate,</span><br><span class="line">        transform,</span><br><span class="line">        process = emptyProcess,</span><br><span class="line">        processOptions = &#123;&#125;</span><br><span class="line">    &#125; = logicOptions;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  typeå¿…ä¼ </span></span><br><span class="line">    <span class="keyword">if</span> (!type) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'type is required, use \'*\' to match all actions'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  validateå’Œtranformåªèƒ½åŒæ—¶æŒ‡å®šä¸€ä¸ª</span></span><br><span class="line">    <span class="keyword">if</span> (validate &amp;&amp; transform) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'logic cannot define both the validate and transform hooks they are aliases'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  warnTimeoutéœ€è¦æ”¾åœ¨processOptionsåŒçº§</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> processOptions.warnTimeout !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'warnTimeout is a top level createLogic option, not a processOptions option'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  è·å–processOptionsä¸­çš„æ— æ•ˆé…ç½®é¡¹</span></span><br><span class="line">    <span class="keyword">const</span> invalidProcessOptions = getInvalidOptions(processOptions, allowedProcessOptions);</span><br><span class="line">    <span class="keyword">if</span> (invalidProcessOptions.length) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`unknown or misspelled processOption(s): <span class="subst">$&#123;invalidProcessOptions&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  å¦‚æœvalidateå’Œtransforméƒ½æ²¡ä¼ å…¥,å°±ç”¨é»˜è®¤çš„, å¦åˆ™å°±ç”¨ä¼ å…¥çš„validate</span></span><br><span class="line">    <span class="keyword">const</span> validateDefaulted = (!validate &amp;&amp; !transform) ?</span><br><span class="line">        identityValidation :</span><br><span class="line">        validate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  å¦‚æœåœ¨processOptionsé‡Œé¢æŒ‡å®šäº†dispatchMultiple, warnTimeoutåº”è¯¥æ˜¯0</span></span><br><span class="line">    <span class="keyword">if</span> (NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">        <span class="keyword">typeof</span> processOptions.dispatchMultiple !== <span class="string">'undefined'</span> &amp;&amp;</span><br><span class="line">        warnTimeout !== <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(<span class="string">`warning: in logic for type(s): <span class="subst">$&#123;type&#125;</span> - dispatchMultiple is always true in next version. For non-ending logic, set warnTimeout to 0`</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        æ ¹æ®process.lengthå¯ä»¥è·å–ä¼ å…¥çš„processå¯¹åº”çš„å¤„ç†å‡½æ•°ä¸­çš„å½¢å‚ä¸ªæ•°</span></span><br><span class="line"><span class="comment">        ä»è€Œç¡®å®šprocessOptionä¸­çš„ä¸€äº›é»˜è®¤å€¼</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        const fn = function(arg1, agr2) &#123;&#125;;</span></span><br><span class="line"><span class="comment">        console.log(fn.length);  -&gt; 2</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        const fn = function(arg1, agr2, arg3) &#123;&#125;;</span></span><br><span class="line"><span class="comment">        console.log(fn.length); -&gt; 3</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    <span class="keyword">switch</span> (process.length) &#123;</span><br><span class="line">        <span class="comment">//  å¦‚æœæ²¡æœ‰æˆ–åªæœ‰ä¸€ä¸ªå½¢å‚æ²¡æœ‰ä¼ å…¥ä¸”dispatchReturnæ²¡æœ‰åœ¨processOptionsä¼ å…¥, å°±æŠŠå®ƒè®¾ç½®æˆtrue</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            setIfUndefined(processOptions, <span class="string">'dispatchReturn'</span>, <span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//  ä¸¤ä¸ªå½¢å‚(single-dispatchæ¨¡å¼[å·²åºŸå¼ƒ])</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">if</span> (NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">                !processOptions.dispatchMultiple &amp;&amp;</span><br><span class="line">                warnTimeout !== <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">console</span>.error(<span class="string">`warning: in logic for type(s): <span class="subst">$&#123;type&#125;</span> - single-dispatch mode is deprecated, call done when finished dispatching. For non-ending logic, set warnTimeout: 0`</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">            3ä¸ªå½¢å‚åŠæ›´å¤š, è®¤ä¸ºæ˜¯multi-dispatchæ¨¡å¼</span></span><br><span class="line"><span class="comment">            processOptions.dispatchMultiple = processOptions === undefined ? true : processOptions.dispatchMultiple</span></span><br><span class="line"><span class="comment">        **/</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            setIfUndefined(processOptions, <span class="string">'dispatchMultiple'</span>, <span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  è¿”å›å¤„ç†å¥½çš„å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        name: typeToStrFns(name),</span><br><span class="line">        type: typeToStrFns(type),</span><br><span class="line">        cancelType: typeToStrFns(cancelType),</span><br><span class="line">        latest,</span><br><span class="line">        debounce,</span><br><span class="line">        throttle,</span><br><span class="line">        validate: validateDefaulted,</span><br><span class="line">        transform,</span><br><span class="line">        process,</span><br><span class="line">        processOptions,</span><br><span class="line">        warnTimeout</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢çš„åˆ†æä¸­æˆ‘ä»¬å¯ä»¥å¾—å‡º: åœ¨<code>createLogic</code>ä¸­åšçš„ä¸»è¦æ˜¯ä¸€äº›å‚æ•°çš„éªŒè¯å’Œé»˜è®¤å€¼çš„å¤„ç†, ä¸‹é¢æˆ‘ä»¬ä¸€èµ·çœ‹çœ‹ä»–é‡Œé¢çš„è°ƒç”¨çš„ä¸€äº›çš„å®ç°:</p>
<p>å…ˆæ¥çœ‹ä¸‹<code>getInvalidOptions</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getInvalidOptions</span>(<span class="params">options, validOptions</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Object</span>.keys(options)</span><br><span class="line">    .filter(<span class="function"><span class="params">k</span> =&gt;</span> validOptions.indexOf(k) === <span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**	æ¯”å¦‚åœ¨createLogicé‡Œçš„ç¬¬ä¸€è¡Œå°±è°ƒç”¨äº†è¯¥æ–¹æ³•</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">export default function createLogic(logicOptions = &#123;&#125;) &#123;</span></span><br><span class="line"><span class="comment">  const invalidOptions = getInvalidOptions(logicOptions, allowedOptions);</span></span><br><span class="line"><span class="comment">  //	...</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">const allowedOptions = [</span></span><br><span class="line"><span class="comment">  'name',</span></span><br><span class="line"><span class="comment">  'type',</span></span><br><span class="line"><span class="comment">  'cancelType',</span></span><br><span class="line"><span class="comment">  'latest',</span></span><br><span class="line"><span class="comment">  'debounce',</span></span><br><span class="line"><span class="comment">  'throttle',</span></span><br><span class="line"><span class="comment">  'validate',</span></span><br><span class="line"><span class="comment">  'transform',</span></span><br><span class="line"><span class="comment">  'process',</span></span><br><span class="line"><span class="comment">  'processOptions',</span></span><br><span class="line"><span class="comment">  'warnTimeout'</span></span><br><span class="line"><span class="comment">];</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">**/</span></span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢çš„åˆ†æä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡º, <code>getInvalidOptions</code>ç”¨æ¥è·å–<code>Object</code>é‡Œçš„ä¸åˆæ³•çš„é…ç½®é¡¹, å¹¶æŠŠéæ³•çš„<code>key</code>ä½œä¸ºæ•°ç»„çš„å½¢å¼è¿”å›ã€‚</p>
<p><code>typeToStrFns</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//	å¦‚æœæ˜¯æ•°ç»„å½¢å¼å°±é’ˆå¯¹æ•°ç»„çš„æ¯ä¸€é¡¹éƒ½è°ƒç”¨typeToStrFns, è¿”å›ä¸€ä¸ªæ–°æ•°ç»„</span></span><br><span class="line"><span class="comment">//	å¦‚æœæ˜¯å‡½æ•°å½¢å¼å°±è¿”å›å‡½æ•°ä½“çš„å­—ç¬¦ä¸²å½¢å¼</span></span><br><span class="line"><span class="comment">//	å…¶å®ƒç›´æ¥è¿”å›</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">typeToStrFns</span>(<span class="params">type</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(type)) &#123; <span class="keyword">return</span> type.map(<span class="function"><span class="params">x</span> =&gt;</span> typeToStrFns(x)); &#125;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">typeof</span> type === <span class="string">'function'</span>) ?</span><br><span class="line">    type.toString() :</span><br><span class="line">    type;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>setIfUndefined</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setIfUndefined</span>(<span class="params">obj, propName, propValue</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> obj[propName] === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">    obj[propName] = propValue;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ²¡ä»€ä¹ˆå¥½è¯´çš„ğŸ˜‚</p>
<ul>
<li>createLogicMiddleware<br><code>createLogic</code>åˆ†æå®Œäº†, ä¸‹é¢ä¸€èµ·çœ‹çœ‹<code>createLogicMiddleware</code>, <code>createLogicMiddleware</code>ä½äº<code>src/createLogicMiddleware</code>é‡Œ:</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	@param arrLogic  Array.&lt;logic&gt;</span></span><br><span class="line"><span class="comment">	@param deps 	 Object</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">createLogicMiddleware</span>(<span class="params">arrLogic = [], deps = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(arrLogic)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'createLogicMiddleware needs to be called with an array of logic items'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	åˆ¤æ–­æ˜¯å¦æœ‰é‡å¤çš„logic</span></span><br><span class="line">  <span class="keyword">const</span> duplicateLogic = findDuplicates(arrLogic);</span><br><span class="line">  <span class="keyword">if</span> (duplicateLogic.length) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`duplicate logic, indexes: <span class="subst">$&#123;duplicateLogic&#125;</span>`</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">		å› ä¸ºredux-logicé›†æˆäº†rxjs</span></span><br><span class="line"><span class="comment">		æ‰€ä»¥Subjectå’ŒBehaviorSubjectéƒ½æ˜¯rxjsé‡Œçš„ä¸»ä½“</span></span><br><span class="line"><span class="comment">		BehaviorSubjectä½œä¸ºSubjectçš„ä¸€ä¸ªå˜ä½“, å’ŒSubjectä¸åŒçš„æ˜¯å®ƒæœ‰ä¸€ä¸ªåˆå§‹å€¼</span></span><br><span class="line"><span class="comment">		https://cn.rx.js.org/manual/overview.html#h15</span></span><br><span class="line"><span class="comment">	**/</span></span><br><span class="line">  <span class="keyword">const</span> actionSrc$ = <span class="keyword">new</span> Subject();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	ç”¨æ¥ç›‘è§†æ‰€æœ‰action</span></span><br><span class="line">  <span class="keyword">const</span> monitor$ = <span class="keyword">new</span> Subject();</span><br><span class="line">  <span class="keyword">const</span> lastPending$ = <span class="keyword">new</span> BehaviorSubject(&#123; <span class="attr">op</span>: OP_INIT &#125;);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	å¯¹monitor$ä½¿ç”¨ç´¯åŠ å™¨å‡½æ•°,è¿”å›ç”Ÿæˆçš„ä¸­é—´å€¼,å¯é€‰çš„åˆå§‹å€¼</span></span><br><span class="line">  monitor$</span><br><span class="line">    .scan(<span class="function">(<span class="params">acc, x</span>) =&gt;</span> &#123; <span class="comment">// è¿½åŠ ä¸€ä¸ªpendingçŠ¶æ€çš„è®¡æ•°å™¨</span></span><br><span class="line">      <span class="keyword">let</span> pending = acc.pending || <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">switch</span> (x.op) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'top'</span> : 		<span class="comment">// å½“å‰actionä½äºlogicæ ˆçš„é¡¶çº§</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">'begin'</span> : 		<span class="comment">// å¼€å§‹è§¦å‘ä¸€ä¸ªaction</span></span><br><span class="line">          pending += <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">			åœ¨createLogicé‡Œçš„processä¸­è°ƒç”¨äº†done, doneçš„å®ç°ç¨å€™åˆ†æ;</span></span><br><span class="line"><span class="comment">		**/</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">'end'</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'bottom'</span>: 			<span class="comment">// actionå˜æˆäº†ä¸€ä¸ªè¢«è½¬æ¢åçš„æ–°action</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">			åœ¨createLogicé‡Œçš„validateä¸­è°ƒç”¨äº†allow, ä¸”è§¦å‘äº†ä¸€ä¸ªæ–°çš„action</span></span><br><span class="line"><span class="comment">			craeteLogic(&#123;</span></span><br><span class="line"><span class="comment">				...</span></span><br><span class="line"><span class="comment">				validate(&#123; getState, action &#125;, allow, reject) &#123;</span></span><br><span class="line"><span class="comment">					allow(action);</span></span><br><span class="line"><span class="comment">				&#125;</span></span><br><span class="line"><span class="comment">			&#125;)</span></span><br><span class="line"><span class="comment">		**/</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">'nextDisp'</span> :</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'filtered'</span> : 		<span class="comment">// 	å½“å‰actionç”±äºæ— æ•ˆè¢«è¿‡æ»¤</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">'dispatchError'</span> : <span class="comment">// 	æ´¾å‘actionçš„æ—¶å€™å¼‚å¸¸(å¥½åƒæš‚æ—¶æ²¡ç”¨åˆ°)</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">			åœ¨actionæ‹¦æˆªå™¨(validate)é‡Œé¢æ‰§è¡Œreject</span></span><br><span class="line"><span class="comment">			craeteLogic(&#123;</span></span><br><span class="line"><span class="comment">				...</span></span><br><span class="line"><span class="comment">				validate(&#123; getState, action &#125;, allow, reject) &#123;</span></span><br><span class="line"><span class="comment">					reject(action);</span></span><br><span class="line"><span class="comment">				&#125;</span></span><br><span class="line"><span class="comment">			&#125;)</span></span><br><span class="line"><span class="comment">		**/</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">'cancelled'</span>:</span><br><span class="line">          pending -= <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...x,</span><br><span class="line">        pending</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;, &#123; <span class="attr">pending</span>: <span class="number">0</span> &#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	https://cn.rx.js.org/manual/usage.html</span></span><br><span class="line">    .subscribe(lastPending$);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> savedStore;</span><br><span class="line">  <span class="keyword">let</span> savedNext;</span><br><span class="line">  <span class="keyword">let</span> actionEnd$;</span><br><span class="line">  <span class="keyword">let</span> logicSub;</span><br><span class="line">  <span class="keyword">let</span> logicCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	ç¼“å­˜ä¼ å…¥çš„logicæ•°ç»„</span></span><br><span class="line">  <span class="keyword">let</span> savedLogicArr = arrLogic;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	è°ƒç”¨å®ŒcreateLogicMiddlewareåè¿”å›çš„reduxä¸­é—´ä»¶</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">mw</span>(<span class="params">store</span>) </span>&#123;</span><br><span class="line">	<span class="comment">//	å¤šæ¬¡è°ƒç”¨äº†createLogicMiddleware, å¹¶ä¸”ä¼ å…¥äº†ä¸åŒçš„store</span></span><br><span class="line">    <span class="keyword">if</span> (savedStore &amp;&amp; savedStore !== store) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'cannot assign logicMiddleware instance to multiple stores, create separate instance for each'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	ç¼“å­˜æœ¬æ¬¡è°ƒç”¨ä¼ å…¥çš„store</span></span><br><span class="line">    savedStore = store;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">next</span> =&gt;</span> &#123;</span><br><span class="line">      savedNext = next;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//	ä»applyLogicè¿”å›ä¸­è·å–action$, sub, æŠŠlogicCountèµ‹å€¼ç»™cnt</span></span><br><span class="line">      <span class="keyword">const</span> &#123; action$, sub, <span class="attr">logicCount</span>: cnt &#125; =</span><br><span class="line">            applyLogic(arrLogic, savedStore, savedNext,</span><br><span class="line">                       logicSub, actionSrc$, deps, logicCount,</span><br><span class="line">                       monitor$);</span><br><span class="line">      actionEnd$ = action$;</span><br><span class="line">      logicSub = sub;</span><br><span class="line">      logicCount = cnt;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">        debug(<span class="string">'starting off'</span>, action);</span><br><span class="line">        monitor$.next(&#123; action, <span class="attr">op</span>: <span class="string">'top'</span> &#125;);</span><br><span class="line">        actionSrc$.next(action);</span><br><span class="line">        <span class="keyword">return</span> action;</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//	ç»™mwæŒ‚è½½ä¸€ä¸ªæŒ‡å‘monitor$çš„monitor$å±æ€§</span></span><br><span class="line">  mw.monitor$ = monitor$;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¸€ä¸ªè‡ªå®šä¹‰é’©å­å‡½æ•°, ä¸»è¦ç”¨äºæµ‹è¯•</span></span><br><span class="line"><span class="comment">     * @param  &#123;Function&#125; fn   å¯å†™å…¥ç›¸å…³æµ‹è¯•é€»è¾‘</span></span><br><span class="line"><span class="comment">     * @return &#123;Objetc&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    mw.whenComplete = <span class="function"><span class="keyword">function</span> <span class="title">whenComplete</span>(<span class="params">fn = identity</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> lastPending$</span><br><span class="line">            <span class="comment">//  åªæœ‰å½“x.pending &gt; 0æ˜¯æ‰ç»§ç»­å¾€ä¸‹èµ°</span></span><br><span class="line">            .takeWhile(<span class="function"><span class="params">x</span> =&gt;</span> x.pending)</span><br><span class="line">            .map(<span class="function">(<span class="params"> <span class="regexp">/* x */</span> </span>) =&gt;</span> <span class="literal">undefined</span>)</span><br><span class="line">            .toPromise()</span><br><span class="line">            .then(fn);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">		ç»™å½“å‰reduxä¸­é—´ä»¶åŠ¨æ€æ·»åŠ ä¾èµ–(ç›¸å½“äºcreateLogicMiddlewareç¬¬äºŒä¸ªå‚æ•°çš„æ‹“å±•)</span></span><br><span class="line"><span class="comment">	**/</span></span><br><span class="line">  mw.addDeps = <span class="function"><span class="keyword">function</span> <span class="title">addDeps</span>(<span class="params">additionalDeps</span>) </span>&#123;</span><br><span class="line">	<span class="comment">//	æ‰€æ·»åŠ çš„ä¾èµ–å¿…é¡»æ˜¯ä¸€ä¸ªå¯¹è±¡ç±»å‹</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> additionalDeps !== <span class="string">'object'</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'addDeps should be called with an object'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	éå†æ‰€æ·»åŠ çš„ä¸­é—´ä»¶</span></span><br><span class="line">    <span class="built_in">Object</span>.keys(additionalDeps).forEach(<span class="function"><span class="params">k</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> existing = deps[k];</span><br><span class="line">      <span class="keyword">const</span> newValue = additionalDeps[k];</span><br><span class="line">		<span class="comment">//	æ‰€æ·»åŠ çš„ä¸­é—´ä»¶ä¸èƒ½å’Œå½“å‰å·²æœ‰çš„é‡å(å½“å‰å·²ç»æœ‰çš„ä¸èƒ½è¢«è¦†ç›–)</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> existing !== <span class="string">'undefined'</span> &amp;&amp;</span><br><span class="line">          existing !== newValue) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`addDeps cannot override an existing dep value: <span class="subst">$&#123;k&#125;</span>`</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      deps[k] = newValue;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">		ç»™å½“å‰reduxä¸­é—´ä»¶åŠ¨æ€æ·»åŠ æ–°çš„logic</span></span><br><span class="line"><span class="comment">		@param arrNewLogic Array.&lt;Logic&gt;</span></span><br><span class="line"><span class="comment">	**/</span></span><br><span class="line">  mw.addLogic = <span class="function"><span class="keyword">function</span> <span class="title">addLogic</span>(<span class="params">arrNewLogic</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!arrNewLogic.length) &#123; <span class="keyword">return</span> &#123; logicCount &#125;; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	åˆå¹¶åˆ°å½“å‰å·²æœ‰çš„æ•°ç»„é‡Œé¢</span></span><br><span class="line">    <span class="keyword">const</span> combinedLogic = savedLogicArr.concat(arrNewLogic);</span><br><span class="line">    <span class="keyword">const</span> duplicateLogic = findDuplicates(combinedLogic);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	åˆ¤æ–­æ˜¯å¦æœ‰é‡å¤</span></span><br><span class="line">    <span class="keyword">if</span> (duplicateLogic.length) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`duplicate logic, indexes: <span class="subst">$&#123;duplicateLogic&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> &#123; action$, sub, <span class="attr">logicCount</span>: cnt &#125; =</span><br><span class="line">          applyLogic(arrNewLogic, savedStore, savedNext,</span><br><span class="line">                     logicSub, actionEnd$, deps, logicCount, monitor$);</span><br><span class="line">    actionEnd$ = action$;</span><br><span class="line">    logicSub = sub;</span><br><span class="line">    logicCount = cnt;</span><br><span class="line">    savedLogicArr = combinedLogic;</span><br><span class="line">    debug(<span class="string">'added logic'</span>);</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">logicCount</span>: cnt &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">		ç»™å½“å‰reduxä¸­é—´ä»¶åˆå¹¶æ–°çš„logic</span></span><br><span class="line"><span class="comment">		@param arrNewLogic Array.&lt;Logic&gt;</span></span><br><span class="line"><span class="comment">	**/</span></span><br><span class="line">  mw.mergeNewLogic = <span class="function"><span class="keyword">function</span> <span class="title">mergeNewLogic</span>(<span class="params">arrMergeLogic</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦é‡å</span></span><br><span class="line">    <span class="keyword">const</span> duplicateLogic = findDuplicates(arrMergeLogic);</span><br><span class="line">    <span class="keyword">if</span> (duplicateLogic.length) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`duplicate logic, indexes: <span class="subst">$&#123;duplicateLogic&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿‡æ»¤æ‰é‡å¤çš„</span></span><br><span class="line">    <span class="keyword">const</span> arrNewLogic = arrMergeLogic.filter(<span class="function"><span class="params">x</span> =&gt;</span></span><br><span class="line">      savedLogicArr.indexOf(x) === <span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">return</span> mw.addLogic(arrNewLogic);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">	æ›¿æ¢å½“å‰æ‰€æœ‰çš„logicå˜æˆæ–°çš„logic</span></span><br><span class="line"><span class="comment">   **/</span></span><br><span class="line">  mw.replaceLogic = <span class="function"><span class="keyword">function</span> <span class="title">replaceLogic</span>(<span class="params">arrRepLogic</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> duplicateLogic = findDuplicates(arrRepLogic);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	åˆ¤æ–­æ–°çš„logicæ•°ç»„é‡Œæ˜¯å¦æœ‰é‡å¤çš„logic</span></span><br><span class="line">    <span class="keyword">if</span> (duplicateLogic.length) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`duplicate logic, indexes: <span class="subst">$&#123;duplicateLogic&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> &#123; action$, sub, <span class="attr">logicCount</span>: cnt &#125; =</span><br><span class="line">          applyLogic(arrRepLogic, savedStore, savedNext,</span><br><span class="line">                     logicSub, actionSrc$, deps, <span class="number">0</span>, monitor$);</span><br><span class="line">    actionEnd$ = action$;</span><br><span class="line">    logicSub = sub;</span><br><span class="line">    logicCount = cnt;</span><br><span class="line">    savedLogicArr = arrRepLogic;</span><br><span class="line">    debug(<span class="string">'replaced logic'</span>);</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">logicCount</span>: cnt &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> mw;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢çš„åˆ†æä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡º, <code>createLogicMiddleware</code>è¿”å›äº†ä¸€ä¸ªä¸­é—´ä»¶, è¯¥ä¸­é—´ä»¶åŸºäº<a href="https://cn.rx.js.org/" target="_blank" rel="noopener">Rxjs</a>å®ç°, è¿”å›çš„ä¸­é—´ä»¶ä¸­å¤„ç†ç›¸å…³<code>redux action</code>å¯¹åº”çš„é€»è¾‘ã€‚</p>
<p>åœ¨<code>createLogicMiddleware</code>ä¸­è°ƒç”¨äº†ä¸€äº›å…¶ä»–å‡½æ•°, é€ä¸ªçœ‹ä¸‹è¿™äº›å‡½æ•°çš„å®ç°:</p>
<p><code>findDuplicates</code>, è¯¥æ–¹æ³•å®ŒæˆæŸ¥æ‰¾æ•°ç»„é‡Œé¢é‡å¤çš„<code>Logic</code>, å¹¶è®°å½•é‡å¤çš„ä¸‹æ ‡è¿”å›</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	@param arrLogic  Array.&lt;Logic&gt;   logicæ•°ç»„</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @param  &#123;Array.&lt;Logic&gt;&#125;  arrLogic Logicæ•°ç»„</span></span><br><span class="line"><span class="comment"> * @return &#123;Array.&lt;Number&gt;&#125;          é‡å¤çš„Logicä¸‹æ ‡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findDuplicates</span>(<span class="params">arrLogic</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> arrLogic.reduce(<span class="function">(<span class="params">acc, x1, idx1</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//  ä¸æ˜¯åŒä¸€ä¸ªä¸‹æ ‡, ä¸”å€¼ç›¸ç­‰çš„æƒ…å†µä¸‹å°±æŠŠä¸‹æ ‡æ”¾åˆ°accé‡Œé¢</span></span><br><span class="line">    <span class="keyword">if</span> (arrLogic.some(<span class="function">(<span class="params">x2, idx2</span>) =&gt;</span> (idx1 !== idx2 &amp;&amp; x1 === x2))) &#123;</span><br><span class="line">      acc.push(idx1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> acc;</span><br><span class="line">  &#125;, []);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†çœ‹çœ‹çœ‹<code>applyLogic</code>çš„å®ç°:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @param  &#123;Array.&lt;Logic&gt;&#125;   arrLogic        Logicæ•°ç»„</span></span><br><span class="line"><span class="comment"> * @param  &#123;Object&#125;         store            redux store</span></span><br><span class="line"><span class="comment"> * @param  &#123;Function&#125;       next             reduxä¸­é—´ä»¶ä¸­çš„ç¬¬äºŒå±‚å‡½æ•°</span></span><br><span class="line"><span class="comment"> * @param  &#123;Rx.Subject&#125;     sub              å½“å‰actionå¯¹åº”çš„</span></span><br><span class="line"><span class="comment"> * @param  &#123;Rx.Subject&#125;     actionIn$        å½“å‰actionå¯¹åº”çš„å¯è®¢é˜…å¯¹è±¡</span></span><br><span class="line"><span class="comment"> * @param  &#123;Object&#125;         deps             createLogicMiddleçš„ç¬¬äºŒä¸ªå‚æ•°</span></span><br><span class="line"><span class="comment"> * @param  &#123;Number&#125;         startLogicCount  ç”¨äºå‘½å</span></span><br><span class="line"><span class="comment"> * @param  &#123;Rx.Subject&#125;     monitor$         å…¨å±€å¯è®¢é˜…å¯¹è±¡</span></span><br><span class="line"><span class="comment"> * @return &#123;Object&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">applyLogic</span>(<span class="params">arrLogic, store, next, sub, actionIn$, deps, startLogicCount, monitor$</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!store || !next) &#123; <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'store is not defined'</span>); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  å¦‚æœå½“å‰Logicå·²ç»æ˜¯ä¸€ä¸ªRx.Subject(å·²ç»è¢«è®¢é˜…è¿‡äº†), å–æ¶ˆè®¢é˜…</span></span><br><span class="line">    <span class="keyword">if</span> (sub) &#123; sub.unsubscribe(); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  å¯¹å½“å‰Logicæ•°ç»„è¿›è¡Œæ“ä½œ(å‘½åç­‰), è¿”å›ä¸€ä¸ªæ–°æ•°ç»„</span></span><br><span class="line">    <span class="keyword">const</span> wrappedLogic = arrLogic.map(<span class="function">(<span class="params">logic, idx</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">//  ç»™å½“å‰æœªæŒ‡å®šnameçš„Logicè¿›è¡Œå‘½åå¹¶ä¸”è¿”å›, namingç¨å€™åˆ†æ</span></span><br><span class="line">        <span class="keyword">const</span> namedLogic = naming(logic, idx + startLogicCount);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//  åŒ…è£…å‘½ååçš„Logic, wrapperç¨å€™åˆ†æ</span></span><br><span class="line">        <span class="keyword">return</span> wrapper(namedLogic, store, deps, monitor$);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> actionOut$ = wrappedLogic.reduce(<span class="function">(<span class="params">acc$, wep</span>) =&gt;</span> wep(acc$), actionIn$);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  è®¢é˜…æ–°çš„Observableå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">const</span> newSub = actionOut$.subscribe(<span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">        debug(<span class="string">'actionEnd$'</span>, action);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> result = next(action);</span><br><span class="line">            debug(<span class="string">'result'</span>, result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            <span class="built_in">console</span>.error(<span class="string">'error in mw dispatch or next call, probably in middlware/reducer/render fn:'</span>, err);</span><br><span class="line">            <span class="keyword">const</span> msg = (err &amp;&amp; err.message) ? err.message : err;</span><br><span class="line">            monitor$.next(&#123; action, <span class="attr">err</span>: msg, <span class="attr">op</span>: <span class="string">'nextError'</span> &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//  actionå˜æˆäº†ä¸€ä¸ªè¢«è½¬æ¢åçš„æ–°action</span></span><br><span class="line">        monitor$.next(&#123; <span class="attr">nextAction</span>: action, <span class="attr">op</span>: <span class="string">'bottom'</span> &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        action$: actionOut$,</span><br><span class="line">        sub: newSub,</span><br><span class="line">        logicCount: startLogicCount + arrLogic.length</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢çš„åˆ†æä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡º, <code>applyLogic</code>è¿”å›äº†ä¸€ä¸ªæ–°çš„<a href="https://cn.rx.js.org/class/es6/Observable.js~Observable.html" target="_blank" rel="noopener">Rx.Observable</a>, é‡Œé¢è°ƒç”¨äº†<code>naming</code>å’Œ<code>wrapper</code>, ä¸‹é¢æˆ‘ä»¬é€ä¸ªåˆ†æä¸‹ã€‚</p>
<p>å…ˆçœ‹<code>naming</code>çš„å®ç°å§:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ¤æ–­å½“å‰ä¼ å…¥çš„Logicæœ‰æ²¡æœ‰name, æœ‰å°±ä¸åšä»»ä½•æ“ä½œç›´æ¥è¿”å›, æ²¡æœ‰å°±ç»™å½“å‰Logicæ·»åŠ ä¸€ä¸ªnameå±æ€§åè¿”å›</span></span><br><span class="line"><span class="comment"> * @param  &#123;Object&#125; logic å½“å‰Logic</span></span><br><span class="line"><span class="comment"> * @param  &#123;Number&#125; idx   å½“å‰Logicåœ¨arrLogicä¸­çš„ä¸‹æ ‡åœ°å€</span></span><br><span class="line"><span class="comment"> * @return &#123;Object&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">naming</span>(<span class="params">logic, idx</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (logic.name) &#123; <span class="keyword">return</span> logic; &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        ...logic,</span><br><span class="line">        name: <span class="string">`L(<span class="subst">$&#123;logic.type.toString()&#125;</span>)-<span class="subst">$&#123;idx&#125;</span>`</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†çœ‹ä¸‹<code>wrapper</code>çš„, <code>wrapper</code>æ˜¯å†™åœ¨<code>src/logicWrapper</code>é‡Œçš„, <code>wrapper</code>è¿”å›çš„æ˜¯ä¸€ä¸ª<code>Rx.Observable</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Logicä¸­ç›¸å…³å¤„ç†</span></span><br><span class="line"><span class="comment"> * @param  &#123;Object&#125;     options.action   å½“å‰action</span></span><br><span class="line"><span class="comment"> * @param  &#123;Object&#125;     options.logic    å½“å‰logic</span></span><br><span class="line"><span class="comment"> * @param  &#123;Object&#125;     options.store    redux store</span></span><br><span class="line"><span class="comment"> * @param  &#123;Object&#125;     options.deps     createLogicMiddlewareçš„ç¬¬äºŒä¸ªå‚æ•°</span></span><br><span class="line"><span class="comment"> * @param  &#123;Rx.Subject&#125; options.cancel$  å–æ¶ˆLogicæ‰§è¡Œçš„è®¢é˜…å¯¹è±¡</span></span><br><span class="line"><span class="comment"> * @param  &#123;Rx.Subject&#125; options.monitor$ å…¨å±€å¯è®¢é˜…å¯¹è±¡</span></span><br><span class="line"><span class="comment"> * @return &#123;Rx.Observable&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">createLogicAction$</span>(<span class="params">&#123; action, logic, store, deps, cancel$, monitor$ &#125;</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  reduxStore.getState()</span></span><br><span class="line">    <span class="keyword">const</span> &#123; getState &#125; = store;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  ä»å½“å‰logicä¸­å–å¾—ç›¸å…³é…ç½®å‚æ•°</span></span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">        name,</span><br><span class="line">        warnTimeout,</span><br><span class="line">        process: processFn,</span><br><span class="line">        processOptions: &#123;</span><br><span class="line">            dispatchReturn,</span><br><span class="line">            dispatchMultiple,</span><br><span class="line">            successType,</span><br><span class="line">            failType</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; = logic;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  å½“å‰Logicçš„æ‹¦æˆªå™¨</span></span><br><span class="line">    <span class="keyword">const</span> intercept = logic.validate || logic.transform;</span><br><span class="line"></span><br><span class="line">    debug(<span class="string">'createLogicAction$'</span>, name, action);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  å¼€å§‹æœ¬æ¬¡actionçš„æ‰§è¡Œ</span></span><br><span class="line">    monitor$.next(&#123; action, name, <span class="attr">op</span>: <span class="string">'begin'</span> &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        1.å½“å‰actionå‘ç”Ÿæ”¹å˜</span></span><br><span class="line"><span class="comment">        2.åœ¨validate/transformä¸­è°ƒç”¨allow</span></span><br><span class="line"><span class="comment">        3.æ— æ•ˆçš„action type</span></span><br><span class="line"><span class="comment">        4.actionè¢«å–æ¶ˆ</span></span><br><span class="line"><span class="comment">        interceptCompleteéƒ½ä¼šå˜æˆtrue, æ ‡è®°æ‹¦æˆªå™¨å¤„ç†å®Œæˆ</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="keyword">let</span> interceptComplete = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  https://cn.rx.js.org/class/es6/Observable.js~Observable.html#instance-method-take</span></span><br><span class="line">    <span class="keyword">const</span> logicAction$ = Observable.create(<span class="function"><span class="params">logicActionObs</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">//  åˆ›å»ºä¸€ä¸ªä¸»é¢˜(åªå‘å‡ºä¸€ä¸ªå€¼), ç”¨æ¥è®¢é˜…`å–æ¶ˆLogicæ‰§è¡Œçš„è®¢é˜…å¯¹è±¡`, åœ¨å–æ¶ˆæœ¬æ¬¡actionå, é€šçŸ¥`å–æ¶ˆLogicæ‰§è¡Œçš„è®¢é˜…å¯¹è±¡`</span></span><br><span class="line">            <span class="keyword">const</span> cancelled$ = (<span class="keyword">new</span> Subject()).take(<span class="number">1</span>);</span><br><span class="line">            cancel$.subscribe(cancelled$);</span><br><span class="line">            cancelled$</span><br><span class="line">                .subscribe(</span><br><span class="line">                    () =&gt; &#123;</span><br><span class="line">                        <span class="comment">//  ç¡®ä¿cancelä¸ä¼šè¢«è°ƒç”¨2æ¬¡(åœ¨createLogicMiddleä¸­è¿½åŠ çš„pendingåªä¼šè¢«å‡ä¸€æ¬¡)</span></span><br><span class="line">                        <span class="keyword">if</span> (!interceptComplete) &#123;</span><br><span class="line">                            monitor$.next(&#123; action, name, <span class="attr">op</span>: <span class="string">'cancelled'</span> &#125;);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            monitor$.next(&#123; action, name, <span class="attr">op</span>: <span class="string">'dispCancelled'</span> &#125;);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                );</span><br><span class="line"></span><br><span class="line">            <span class="comment">//  å¦‚æœå½“å‰Logicä¸æ˜¯ä¸€ä¸ªæŒç»­æ€§çš„, ä¸”æ²¡æœ‰åœ¨warnTimeout / 1000ç§’å†…è°ƒç”¨done(warnTimeout &gt; 0), å°±ç»™å‡ºå¼‚å¸¸æç¤º</span></span><br><span class="line">            <span class="keyword">if</span> (NODE_ENV !== <span class="string">'production'</span> &amp;&amp; warnTimeout) &#123;</span><br><span class="line">                Observable.timer(warnTimeout)</span><br><span class="line">                    <span class="comment">//  https://cn.rx.js.org/class/es6/Observable.js~Observable.html#instance-method-takeUntil</span></span><br><span class="line">                    <span class="comment">//  https://cn.rx.js.org/class/es6/Observable.js~Observable.html#instance-method-defaultIfEmpty</span></span><br><span class="line">                    .takeUntil(cancelled$.defaultIfEmpty(<span class="literal">true</span>))</span><br><span class="line">                    .do(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                        <span class="comment">//	console.error(`warning: logic ($&#123;name&#125;) is still running after $&#123;warnTimeout / 1000&#125;s, forget to call done()? For non-ending logic, set warnTimeout: 0`);</span></span><br><span class="line">                    &#125;)</span><br><span class="line">                    .subscribe();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> dispatch$ = (<span class="keyword">new</span> Subject())</span><br><span class="line">                .mergeAll()</span><br><span class="line">                .takeUntil(cancel$);</span><br><span class="line"></span><br><span class="line">            dispatch$</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                    .do(&#123;</span></span><br><span class="line"><span class="comment">                        nextOrObserver: mapToActionAndDispatch,</span></span><br><span class="line"><span class="comment">                        error: mapErrorToActionAndDispatch</span></span><br><span class="line"><span class="comment">                    &#125;)</span></span><br><span class="line"><span class="comment">                    è¿™é‡Œçœç•¥äº†nextOrObserverå’Œerror</span></span><br><span class="line"><span class="comment">                    https://cn.rx.js.org/class/es6/Observable.js~Observable.html#instance-method-do</span></span><br><span class="line"><span class="comment">                 **/</span></span><br><span class="line">                .do(</span><br><span class="line">                    mapToActionAndDispatch,</span><br><span class="line">                    mapErrorToActionAndDispatch</span><br><span class="line">                )</span><br><span class="line">                .subscribe(&#123;</span><br><span class="line">                    error: <span class="function">(<span class="params"> <span class="regexp">/* err */</span> </span>) =&gt;</span> &#123;</span><br><span class="line">                        <span class="comment">//  åœ¨å‘ç”Ÿå¼‚å¸¸å, ç»ˆæ­¢æœ¬æ¬¡acion, å¹¶ä¸”å–æ¶ˆè®¢é˜…cancelled$</span></span><br><span class="line">                        monitor$.next(&#123; action, name, <span class="attr">op</span>: <span class="string">'end'</span> &#125;);</span><br><span class="line">                        cancelled$.complete();</span><br><span class="line">                        cancelled$.unsubscribe();</span><br><span class="line">                    &#125;,</span><br><span class="line">                    complete: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                        <span class="comment">//  æœ¬æ¬¡actionå¤„ç†å®Œæˆ</span></span><br><span class="line">                        monitor$.next(&#123; action, name, <span class="attr">op</span>: <span class="string">'end'</span> &#125;);</span><br><span class="line">                        cancelled$.complete();</span><br><span class="line">                        cancelled$.unsubscribe();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//  è§¦å‘reduxé‡Œé¢çš„action</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">storeDispatch</span>(<span class="params">act</span>) </span>&#123;</span><br><span class="line">                monitor$.next(&#123; action, <span class="attr">dispAction</span>: act, <span class="attr">op</span>: <span class="string">'dispatch'</span> &#125;);</span><br><span class="line">                <span class="keyword">return</span> store.dispatch(act);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * é€‚é…ä¸åŒæƒ…å†µçš„action, ç»„è£…åå¦‚æœæ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„redux action, å°±è°ƒç”¨reduxStore.dispatch</span></span><br><span class="line"><span class="comment">             * @param  &#123;Object&#125; actionOrValue</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">mapToActionAndDispatch</span>(<span class="params">actionOrValue</span>) </span>&#123;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                    let act;</span></span><br><span class="line"><span class="comment">                    if (isInterceptAction(actionOrValue)) &#123;</span></span><br><span class="line"><span class="comment">                        act = unwrapInterceptAction(actionOrValue);</span></span><br><span class="line"><span class="comment">                    &#125; else &#123;</span></span><br><span class="line"><span class="comment">                        if (successType) &#123;</span></span><br><span class="line"><span class="comment">                            act = mapToAction(successType, actionOrValue, false);</span></span><br><span class="line"><span class="comment">                        &#125; else &#123;</span></span><br><span class="line"><span class="comment">                            act = actionOrValue;</span></span><br><span class="line"><span class="comment">                        &#125;</span></span><br><span class="line"><span class="comment">                    &#125;</span></span><br><span class="line"><span class="comment">                    æŠŠä¸‹é¢çš„ä»£ç æ‹†æˆä¸Šé¢çš„æ ·å­, å¤§æ¦‚åšäº†ä¸‹é¢å‡ ä»¶äº‹æƒ…:</span></span><br><span class="line"><span class="comment">                    åˆ¤æ–­æ˜¯ä¸æ˜¯ä¸€ä¸ªæ‹¦æˆªå™¨, å¦‚æœæ˜¯å°±æŠŠä¹‹å‰åŒ…è£…çš„æ‹¦æˆªå™¨è§£åŒ…</span></span><br><span class="line"><span class="comment">                    åˆ¤æ–­processOptions.successTypeæ˜¯å¦å­˜åœ¨, å­˜åœ¨å°±è°ƒç”¨mapToAction, æ‹¼å‡ºä¸€ä¸ªæ–°çš„redux action, è°ƒç”¨reduxSrore.dispatch</span></span><br><span class="line"><span class="comment">                    å¦åˆ™å°±ç›´æ¥ä½¿ç”¨actionOrValue</span></span><br><span class="line"><span class="comment">                **/</span></span><br><span class="line">                <span class="keyword">const</span> act = (isInterceptAction(actionOrValue)) ? </span><br><span class="line">                unwrapInterceptAction(actionOrValue) : (successType) ? </span><br><span class="line">                mapToAction(successType, actionOrValue, <span class="literal">false</span>) : actionOrValue;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (act) &#123;</span><br><span class="line">                    storeDispatch(act);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * æ ¹æ®actionOrValueçš„ç±»å‹æ¥ç»„è£…å¯ä»¥è¢«reduxStore.dispatchè°ƒç”¨çš„action</span></span><br><span class="line"><span class="comment">             * @param  &#123;any&#125; actionOrValue</span></span><br><span class="line"><span class="comment">             * @return &#123;Object&#125;</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">mapErrorToActionAndDispatch</span>(<span class="params">actionOrValue</span>) </span>&#123;</span><br><span class="line">                <span class="comment">//  æ‹¦æˆªå™¨ç±»å‹çš„ç›´æ¥è°ƒç”¨è§¦å‘__interceptAction</span></span><br><span class="line">                <span class="keyword">if</span> (isInterceptAction(actionOrValue)) &#123;</span><br><span class="line">                    <span class="keyword">const</span> interceptAction = unwrapInterceptAction(actionOrValue);</span><br><span class="line">                    <span class="keyword">return</span> storeDispatch(interceptAction);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//  åˆ¤æ–­Logicä¸­çš„processOptionsé‡Œæœ‰æ²¡æœ‰failType</span></span><br><span class="line">                <span class="keyword">if</span> (failType) &#123;</span><br><span class="line">                    <span class="comment">//  å¦‚æœæœ‰failType, ç»„è£…ä¸€ä¸ªæ–°çš„redux actionå¹¶è§¦å‘</span></span><br><span class="line">                    <span class="keyword">const</span> act = mapToAction(failType, actionOrValue, <span class="literal">true</span>);</span><br><span class="line">                    <span class="keyword">if</span> (act) &#123;</span><br><span class="line">                        <span class="keyword">return</span> storeDispatch(act);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//  actionOrValueæœ¬èº«å°±æ˜¯ä¸€ä¸ªå¼‚å¸¸</span></span><br><span class="line">                <span class="keyword">if</span> (actionOrValue <span class="keyword">instanceof</span> <span class="built_in">Error</span>) &#123;</span><br><span class="line">                    <span class="keyword">const</span> act =</span><br><span class="line">                        <span class="comment">//  actionOrValueæœ¬èº«åŒ…å«type, ç›´æ¥è°ƒç”¨redux.dispatch(actionOrValue)</span></span><br><span class="line">                        <span class="comment">//  å¦åˆ™åŒ…è£…å‡ºä¸€ä¸ªredux action(typeä¸ºUNHANDLED_LOGIC_ERROR), åœ¨è°ƒç”¨redux.dispatch</span></span><br><span class="line">                        (actionOrValue.type) ? actionOrValue :</span><br><span class="line">                        &#123;</span><br><span class="line">                            type: UNHANDLED_LOGIC_ERROR,</span><br><span class="line">                            payload: actionOrValue,</span><br><span class="line">                            error: <span class="literal">true</span></span><br><span class="line">                        &#125;;</span><br><span class="line">                    <span class="keyword">return</span> storeDispatch(act);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//  actionOrValueæ˜¯ä¸€ä¸ªplain objectæˆ–ä¸€ä¸ªå‡½æ•°(action creator)</span></span><br><span class="line">                <span class="keyword">const</span> typeOfValue = <span class="keyword">typeof</span> actionOrValue;</span><br><span class="line">                <span class="keyword">if</span> (actionOrValue &amp;&amp; (typeOfValue === <span class="string">'object'</span> || typeOfValue === <span class="string">'function'</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> storeDispatch(actionOrValue);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//  éå¼‚å¸¸/å‡½æ•°/plain objectçš„æƒ…å†µ</span></span><br><span class="line">                storeDispatch(&#123;</span><br><span class="line">                    type: UNHANDLED_LOGIC_ERROR,</span><br><span class="line">                    payload: actionOrValue,</span><br><span class="line">                    error: <span class="literal">true</span></span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * ç»„è£…å‡ºä¸€ä¸ªæœ‰æ•ˆçš„redux actionå¹¶è¿”å›</span></span><br><span class="line"><span class="comment">             * @param  &#123;String|Function&#125; type       redux action type</span></span><br><span class="line"><span class="comment">             * @param  &#123;Object&#125; payload             redux payload</span></span><br><span class="line"><span class="comment">             * @param  &#123;Error|Unfdeined&#125; err        error</span></span><br><span class="line"><span class="comment">             * @return &#123;Object&#125;</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">mapToAction</span>(<span class="params">type, payload, err</span>) </span>&#123;</span><br><span class="line">                <span class="comment">//  action typeæœ¬èº«æ˜¯ä¸€ä¸ªaction creator, ç›´æ¥æ‰§è¡Œtype</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">typeof</span> type === <span class="string">'function'</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> type(payload);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//  åŒ…è£…å‡ºä¸€ä¸ªæœ‰æ•ˆçš„redux action</span></span><br><span class="line">                <span class="keyword">const</span> act = &#123; type, payload &#125;;</span><br><span class="line">                <span class="keyword">if</span> (err) &#123; act.error = <span class="literal">true</span>; &#125;</span><br><span class="line">                <span class="keyword">return</span> act;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// allowMore is now deprecated in favor of variable process arity</span></span><br><span class="line">            <span class="comment">// which sets processOptions.dispatchMultiple = true then</span></span><br><span class="line">            <span class="comment">// expects done() cb to be called to end</span></span><br><span class="line">            <span class="comment">// Might still be needed for internal use so keeping it for now</span></span><br><span class="line">            <span class="keyword">const</span> DispatchDefaults = &#123;</span><br><span class="line">                allowMore: <span class="literal">false</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * è§¦å‘</span></span><br><span class="line"><span class="comment">             * @param  &#123;[type]&#125; act     [description]</span></span><br><span class="line"><span class="comment">             * @param  &#123;[type]&#125; options [description]</span></span><br><span class="line"><span class="comment">             * @return &#123;[type]&#125;         [description]</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">act, options = DispatchDefaults</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">const</span> &#123; allowMore &#125; = applyDispatchDefaults(options);</span><br><span class="line">                <span class="comment">//  action !== undefined</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">typeof</span> act !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                        let action;</span></span><br><span class="line"><span class="comment">                        if (isObservable(act)) &#123;</span></span><br><span class="line"><span class="comment">                            action = act;</span></span><br><span class="line"><span class="comment">                        &#125; else if (isPromise(act)) &#123;</span></span><br><span class="line"><span class="comment">                            action = Observable.fromPromise(act);</span></span><br><span class="line"><span class="comment">                        &#125; else if (act instanceof Error) &#123;</span></span><br><span class="line"><span class="comment">                            action = Observable.throw(act);</span></span><br><span class="line"><span class="comment">                        &#125; else &#123;</span></span><br><span class="line"><span class="comment">                            action = Observable.of(act);</span></span><br><span class="line"><span class="comment">                        &#125;</span></span><br><span class="line"><span class="comment">                        dispatch$.next(action);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                        https://cn.rx.js.org/class/es6/MiscJSDoc.js~ObserverDoc.html#instance-method-next</span></span><br><span class="line"><span class="comment">                     **/</span></span><br><span class="line">                    dispatch$.next(</span><br><span class="line">                        (isObservable(act)) ? act :</span><br><span class="line">                        (isPromise(act)) ? Observable.fromPromise(act) :</span><br><span class="line">                        (act <span class="keyword">instanceof</span> <span class="built_in">Error</span>) ? Observable.throw(act) :</span><br><span class="line">                        Observable.of(act)</span><br><span class="line">                    );</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!(dispatchMultiple || allowMore)) &#123;</span><br><span class="line">                   dispatch$.complete();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> act;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">applyDispatchDefaults</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    ...DispatchDefaults,</span><br><span class="line">                    ...options</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//  æ‹¼è£…createLogicä¸­ç›¸å…³é’©å­å‡½æ•°(validate/tranform/process)ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°</span></span><br><span class="line">            <span class="keyword">const</span> depObj = &#123;</span><br><span class="line">                ...deps,</span><br><span class="line">                cancelled$,</span><br><span class="line">                ctx: &#123;&#125;, <span class="comment">// åœ¨ä¸åŒé’©å­ä¸­å…±äº«æ•°æ®</span></span><br><span class="line">                getState,</span><br><span class="line">                action</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">shouldDispatch</span>(<span class="params">act, useDispatch</span>) </span>&#123;</span><br><span class="line">                <span class="comment">//  æ–°çš„actionä¸ºç©º</span></span><br><span class="line">                <span class="keyword">if</span> (!act) &#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line">                <span class="comment">//  åœ¨è§¦å‘å¦å¤–ä¸€ä¸ªactionä¹‹å‰, ç¡®ä¿è§¦å‘çš„æ˜¯ä¸€ä¸ªæ–°çš„action</span></span><br><span class="line">                <span class="keyword">if</span> (useDispatch === <span class="string">'auto'</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> (act.type !== action.type);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//  å¦åˆ™æ ¹æ®useDispatchæ˜¯å¦ä¸ºç©º, è¿”å›</span></span><br><span class="line">                <span class="keyword">return</span> (useDispatch);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> AllowRejectNextDefaults = &#123;</span><br><span class="line">                useDispatch: <span class="string">'auto'</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">applyAllowRejectNextDefaults</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    ...AllowRejectNextDefaults,</span><br><span class="line">                    ...options</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//  æ‹¦æˆªå™¨(validate/tranform)é‡Œçš„allowæˆ–next</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">allow</span>(<span class="params">act, options = AllowRejectNextDefaults</span>) </span>&#123;</span><br><span class="line">                handleNextOrDispatch(<span class="literal">true</span>, act, options);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">reject</span>(<span class="params">act, options = AllowRejectNextDefaults</span>) </span>&#123;</span><br><span class="line">                handleNextOrDispatch(<span class="literal">false</span>, act, options);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//  å®Œæˆæœ¬æ¬¡action, åœ¨createLogicä¸­çš„processæœ€åè°ƒç”¨</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                dispatch$.complete();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * å¯¹å½“å‰æ‹¦æˆªå™¨ç±»å‹action(validate/transform)åšä¸€æ¬¡åŒ…è£…, æ–¹ä¾¿åé¢åˆ¤æ–­</span></span><br><span class="line"><span class="comment">             * @param  &#123;Object&#125; act å½“å‰action</span></span><br><span class="line"><span class="comment">             * @return &#123;Object&#125;</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">wrapActionForIntercept</span>(<span class="params">act</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (!act) &#123; <span class="keyword">return</span> act; &#125;</span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    __interceptAction: act</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * åˆ¤æ–­ä¼ å…¥çš„actionæ˜¯å¦ä¸ºæ‹¦æˆªå™¨ç±»å‹çš„</span></span><br><span class="line"><span class="comment">             * @param  &#123;Object&#125;  act å½“å‰action</span></span><br><span class="line"><span class="comment">             * @return &#123;Boolean&#125;</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">isInterceptAction</span>(<span class="params">act</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> act &amp;&amp; act.__interceptAction;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * å¯¹æ‹¦æˆªå™¨æ‰§è¡Œè§£åŒ…</span></span><br><span class="line"><span class="comment">             * @param  &#123;Object&#125;  act å½“å‰action</span></span><br><span class="line"><span class="comment">             * @return &#123;Object&#125;      redux action</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">unwrapInterceptAction</span>(<span class="params">act</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> act.__interceptAction;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * æ‹¦æˆªå™¨(validate/tranform)é‡Œçš„allowã€rejectå®ç°, è§¦å‘æ–°çš„redux action</span></span><br><span class="line"><span class="comment">             * @param  &#123;Boolean&#125; shouldProcess æ˜¯å¦æ‰§è¡Œprocess</span></span><br><span class="line"><span class="comment">             * @param  &#123;Object&#125; act            æ–°çš„redux action</span></span><br><span class="line"><span class="comment">             * @param  &#123;Object&#125; options</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">handleNextOrDispatch</span>(<span class="params">shouldProcess, act, options</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">const</span> &#123; useDispatch &#125; = applyAllowRejectNextDefaults(options);</span><br><span class="line">                <span class="comment">//  åˆ¤æ–­æ˜¯å¦åº”è¯¥è§¦å‘ä¼ å…¥çš„redux action</span></span><br><span class="line">                <span class="keyword">if</span> (shouldDispatch(act, useDispatch)) &#123;</span><br><span class="line">                    monitor$.next(&#123; action, <span class="attr">dispAction</span>: act, name, shouldProcess, <span class="attr">op</span>: <span class="string">'nextDisp'</span> &#125;);</span><br><span class="line">                    interceptComplete = <span class="literal">true</span>;</span><br><span class="line">                    dispatch(wrapActionForIntercept(act), &#123; <span class="attr">allowMore</span>: <span class="literal">true</span> &#125;); <span class="comment">// will be completed later</span></span><br><span class="line">                    logicActionObs.complete(); <span class="comment">// dispatched action, so no next(act)</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123; <span class="comment">// normal next</span></span><br><span class="line">                    <span class="keyword">if</span> (act) &#123;</span><br><span class="line">                        monitor$.next(&#123; action, <span class="attr">nextAction</span>: act, name, shouldProcess, <span class="attr">op</span>: <span class="string">'next'</span> &#125;);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">//  æ— æ•ˆçš„action, ç›´æ¥ç»“æŸæœ¬æ¬¡æ‹¦æˆªå™¨</span></span><br><span class="line">                        monitor$.next(&#123; action, name, shouldProcess, <span class="attr">op</span>: <span class="string">'filtered'</span> &#125;);</span><br><span class="line">                        interceptComplete = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    postIfDefinedOrComplete(act, logicActionObs);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//  æ‰§è¡ŒLogicä¸­çš„processå›è°ƒ</span></span><br><span class="line">                <span class="keyword">if</span> (shouldProcess) &#123;</span><br><span class="line">                    <span class="comment">//  ç»„ç»‡depObjçš„actionå‚æ•°</span></span><br><span class="line">                    depObj.action = act || action;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">const</span> retValue = processFn(depObj, dispatch, done);</span><br><span class="line">                        <span class="comment">/**</span></span><br><span class="line"><span class="comment">                            å¦‚æœåœ¨createLogicæŒ‡å®šäº†processOption.dispatchReturnä¸ºtrue, å¹¶ä¸”prcessæ‰§è¡Œå®Œä¹‹åè¿”å›æœ‰æ•ˆçš„å€¼</span></span><br><span class="line"><span class="comment">                            å°±å†æŠŠè¿”å›å€¼ä½œä¸ºä¸€ä¸ªæ–°çš„redux actionè¿›è¡Œè§¦å‘</span></span><br><span class="line"><span class="comment">                            å¦åˆ™ç›´æ¥ç»“æŸdispatch$è¿™ä¸ªRx.Subject</span></span><br><span class="line"><span class="comment">                            </span></span><br><span class="line"><span class="comment">                            æ‰§è¡Œprocess, å¹¶ä¸”æ¥æ”¶è¿”å›å€¼</span></span><br><span class="line"><span class="comment">                            åˆ¤æ–­processOption.dispatchReturn</span></span><br><span class="line"><span class="comment">                                æˆç«‹: åˆ¤æ–­è¿”å›å€¼æ˜¯å¦æœ‰æ•ˆ</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                                    æœ‰æ•ˆ: dispatch -&gt; mapToActionAndDispatch</span></span><br><span class="line"><span class="comment">                                        mapToActionAndDispatchè¿”å›ä¸€ä¸ªæœ‰æ•ˆçš„action:</span></span><br><span class="line"><span class="comment">                                            ç»§ç»­reduxStore.dispatch(mapToActionAndDispatch(retValue))</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                                    æ— æ•ˆ: dispatch$.complete -&gt; monitor$.next(&#123; action, name, op: 'end' &#125;); cancelled$.complete(); cancelled$.unsubscribe();</span></span><br><span class="line"><span class="comment">                        **/</span></span><br><span class="line">                        <span class="keyword">if</span> (dispatchReturn) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (<span class="keyword">typeof</span> retValue === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">                                dispatch$.complete();</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                dispatch(retValue);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">                        <span class="built_in">console</span>.error(<span class="string">`unhandled exception in logic named: <span class="subst">$&#123;name&#125;</span>`</span>, err);</span><br><span class="line">                        <span class="comment">//  æ‰§è¡Œprocessçš„è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸</span></span><br><span class="line">                        dispatch(Observable.throw(err));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//  ä¼ å…¥çš„actæ˜¯ä¸€ä¸ªç©ºå€¼, æˆ–è€…å’Œå½“å‰çš„typeç›¸åŒ, æˆ–è€…useDispatchä¸æˆç«‹</span></span><br><span class="line">                    dispatch$.complete();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * åœ¨æœ¬æ¬¡æ‹¦æˆªå™¨ä¹‹åæ‰§è¡Œ</span></span><br><span class="line"><span class="comment">             * @param  &#123;Object&#125; act       æ–°çš„action</span></span><br><span class="line"><span class="comment">             * @param  &#123;Rx.Subject&#125; act$  å½“å‰actionå¯¹åº”çš„Observableå¯¹è±¡</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">postIfDefinedOrComplete</span>(<span class="params">act, act$</span>) </span>&#123;</span><br><span class="line">                <span class="comment">//  å¦‚æœæ–°çš„actionå­˜åœ¨, æ‰§è¡Œæ–°çš„action</span></span><br><span class="line">                <span class="keyword">if</span> (act) &#123;</span><br><span class="line">                    act$.next(act);</span><br><span class="line">                &#125;</span><br><span class="line">                interceptComplete = <span class="literal">true</span>;</span><br><span class="line">                act$.complete();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//  å¼€å§‹æœ¬æ¬¡actionçš„æ‰§è¡Œ</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">start</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                intercept(depObj, allow, reject);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            start();</span><br><span class="line">        &#125;)</span><br><span class="line">        .takeUntil(cancel$)</span><br><span class="line">        <span class="comment">//  è§„å®šlogicAction$å€¼å‘å‡ºä¸€ä¸ªå€¼å°±å®Œæˆ</span></span><br><span class="line">        .take(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> logicAction$;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šå°±æ˜¯æœ¬äººå¯¹<code>redux-logic</code>çš„é˜…è¯», ç»è¿‡é˜…è¯», å¤§è‡´äº†è§£åˆ°æ•´ä¸ª<code>redux-logic</code>çš„æ‰§è¡Œé¡ºåºåº”è¯¥æ˜¯ä¸‹å›¾æ‰€ç¤ºçš„æ ·å­ã€‚</p>
<p><img src="/imgs/redux-logic.png" alt></p>
</div></article></div></main><footer><div class="paginator"><a href="/2019/09/28/2019-09-28-react-binding-events-with-arguments/" class="prev">PREV</a><a href="/2017/11/09/2017-11-09-vue-computed/" class="next">NEXT</a></div><div class="copyright"><p>Â© 2015 - 2020 <a href="http://yoursite.com">rwson</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>