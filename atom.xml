<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>å°å®‹</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2017-11-09T08:54:04.187Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>rwson</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Vueä¸­computedè®¡ç®—å±æ€§å’Œwatchè§‚å¯Ÿè€…åŸç†</title>
    <link href="http://yoursite.com/2017/11/09/2017-11-09-vue-computed/"/>
    <id>http://yoursite.com/2017/11/09/2017-11-09-vue-computed/</id>
    <published>2017-11-08T16:00:00.000Z</published>
    <updated>2017-11-09T08:54:04.187Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ç”¨<code>Vue</code>åšå¼€å‘ä¸­, æˆ‘ä»¬å¤šå¤šå°‘å°‘éƒ½ä¼šç”¨åˆ°é‡Œé¢ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„ä¸œè¥¿: <code>computed</code>å’Œ<code>watch</code>, æ¥ä¸‹æ¥æˆ‘ä»¬ä¸€èµ·åˆ†æå¹¶ç®€å•å®ç°ä¸‹è¿™ä¸¤ä¸ªå±æ€§ã€‚</p><h4 id="computed"><a href="#computed" class="headerlink" title="computed"></a>computed</h4><p><code>computed</code>åä¸ºè®¡ç®—å±æ€§, ç›®çš„å°±æ˜¯è®©æˆ‘ä»¬åœ¨æ¨¡æ¿é‡Œé¢åªå…³æ³¨ç®€å•çš„ç»‘å®š, ä¸åšå¤æ‚æ“ä½œ, æ‹¿å®˜ç½‘çš„ä»£ç åšä¾‹å­,ä¸‹é¢å°±æ˜¯ä¸€ä¸ªç›¸å¯¹å¤æ‚çš„æ“ä½œ:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"example"</span>&gt;</span></div><div class="line">  &#123;&#123; message.split('').reverse().join('') &#125;&#125;</div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure><p>å…ˆæ¥çœ‹ä¸‹ç”¨æ³•:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> Vue(&#123;</div><div class="line">    data() &#123;</div><div class="line">      <span class="keyword">return</span> &#123;</div><div class="line">        firstName: <span class="string">"rw"</span>,</div><div class="line">        lastName: <span class="string">"son"</span>,</div><div class="line">        age: <span class="number">25</span></div><div class="line">      &#125;;</div><div class="line">    &#125;,</div><div class="line">    computed: &#123;</div><div class="line">      <span class="comment">//  æŒ‡å®šè®¡ç®—å±æ€§çš„getter</span></div><div class="line">      info() &#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">`info content: my name is <span class="subst">$&#123;<span class="keyword">this</span>.firstName&#125;</span><span class="subst">$&#123;<span class="keyword">this</span>.lastName&#125;</span>, I'm <span class="subst">$&#123;<span class="keyword">this</span>.age&#125;</span> years old`</span>;</div><div class="line">      &#125;,</div><div class="line">      <span class="comment">//  åŒæ—¶æä¾›getterå’Œsetter, setterä¸­å¯ä»¥æ“ä½œå…¶ä»–æ•°æ®</span></div><div class="line">      fullName: &#123;</div><div class="line">        get() &#123;</div><div class="line">          <span class="keyword">return</span> <span class="string">`my fullName is: <span class="subst">$&#123;<span class="keyword">this</span>.firstName&#125;</span><span class="subst">$&#123;<span class="keyword">this</span>.lastName&#125;</span>`</span>;</div><div class="line">        &#125;,</div><div class="line">        set(value) &#123;</div><div class="line">          value = value.split(<span class="string">" "</span>);</div><div class="line">          <span class="keyword">this</span>.firstName = value[<span class="number">0</span>];</div><div class="line">          <span class="keyword">this</span>.lastName = value[value.length - <span class="number">1</span>];</div><div class="line">        &#125;</div><div class="line">      &#125;,</div><div class="line">  text: <span class="string">"just a test case"</span></div><div class="line">    &#125;,</div><div class="line">    created() &#123;</div><div class="line">      <span class="built_in">console</span>.log(<span class="keyword">this</span>.info);</div><div class="line">      <span class="comment">//  info content: my name is rwson, I'm 25 years old</span></div><div class="line"></div><div class="line">      <span class="keyword">this</span>.fullName = <span class="string">"son rw"</span>;</div><div class="line"></div><div class="line">      <span class="built_in">console</span>.log(<span class="keyword">this</span>.info);</div><div class="line">      <span class="comment">//  info content: my name is sonrw, I'm 25 years old</span></div><div class="line"></div><div class="line">      <span class="built_in">console</span>.log(<span class="keyword">this</span>.fullName);</div><div class="line">      <span class="comment">//  my fullName is: sonrw</span></div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure><p><code>computed</code>çš„ç”¨æ³•å°±æ˜¯ä¸Šé¢ä¾‹å­ä¸­çš„ä¸¤ç§, ä¸‹é¢æˆ‘ä»¬ä¸€èµ·æ¥æ¨¡æ‹Ÿå®ç°ä¸‹:</p><p>é¦–å…ˆæˆ‘ä»¬æ¨¡æ‹Ÿå°è£…ä¸€ä¸ª<code>Vm</code>å‡½æ•°ä½œä¸ºæ„é€ å™¨, ç„¶åå»è°ƒç”¨å®ƒ,</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> vm = <span class="keyword">new</span> Vm(&#123;</div><div class="line">data() &#123;</div><div class="line"><span class="keyword">return</span> &#123;</div><div class="line">firstName: <span class="string">"rw"</span>,</div><div class="line">lastName: <span class="string">"son"</span>,</div><div class="line">age: <span class="number">25</span></div><div class="line">&#125;;</div><div class="line">&#125;,</div><div class="line">computed: &#123;</div><div class="line">info() &#123;</div><div class="line"><span class="keyword">return</span> <span class="string">`info content: my name is <span class="subst">$&#123;<span class="keyword">this</span>.firstName&#125;</span><span class="subst">$&#123;<span class="keyword">this</span>.lastName&#125;</span>, I'm <span class="subst">$&#123;<span class="keyword">this</span>.age&#125;</span> years old`</span>;</div><div class="line">&#125;,</div><div class="line">fullName: &#123;</div><div class="line">get() &#123;</div><div class="line"><span class="keyword">return</span> <span class="string">`my fullName is: <span class="subst">$&#123;<span class="keyword">this</span>.firstName&#125;</span><span class="subst">$&#123;<span class="keyword">this</span>.lastName&#125;</span>`</span>;</div><div class="line">&#125;,</div><div class="line">set(value) &#123;</div><div class="line">value = value.split(<span class="string">" "</span>);</div><div class="line"><span class="keyword">this</span>.firstName = value[<span class="number">0</span>];</div><div class="line"><span class="keyword">this</span>.lastName = value[value.length - <span class="number">1</span>];</div><div class="line">&#125;</div><div class="line">&#125;,</div><div class="line">text: <span class="string">"just a test case"</span></div><div class="line">&#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(vm.text);</div><div class="line"><span class="comment">//just a test case</span></div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(vm.info);</div><div class="line"><span class="comment">//info content: my name is rwson, I'm 25 years old</span></div><div class="line"></div><div class="line">vm.fullName = <span class="string">"song rw"</span>;</div><div class="line"><span class="built_in">console</span>.log(vm.info);</div><div class="line"><span class="comment">//info content: my name is songrw, I'm 25 years old</span></div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(vm.firstName);</div><div class="line"><span class="comment">//song</span></div></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯è¿è¡Œç»“æœå’Œè°ƒç”¨, ä¸‹é¢æˆ‘ä»¬ä¸€èµ·å®ç°ä¸‹<code>Vm</code>è¿™ä¸ªå‡½æ•°:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//vmæ„é€ å‡½æ•°</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vm</span>(<span class="params">obj</span>) </span>&#123;</div><div class="line"><span class="keyword">const</span> data = obj.data();</div><div class="line"></div><div class="line"><span class="comment">//å¤„ç†dataæ‰§è¡Œçš„è¿”å›ç»“æœ</span></div><div class="line">handleData(<span class="keyword">this</span>, data);</div><div class="line"></div><div class="line"><span class="comment">//å¤„ç†compotedå¯¹è±¡</span></div><div class="line">handleComputed(<span class="keyword">this</span>, obj.computed);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//hasOwnPropertyç®€å†™</span></div><div class="line"><span class="keyword">const</span> hasOwnProp = <span class="function">(<span class="params">obj, prop</span>) =&gt;</span> obj.hasOwnProperty(prop);</div><div class="line"></div><div class="line"><span class="comment">//è·å–prototypeç±»å</span></div><div class="line"><span class="keyword">const</span> typeOf = <span class="function">(<span class="params">obj</span>) =&gt;</span> &#123;</div><div class="line"><span class="keyword">return</span> &#123;&#125;.toString.call(obj).slice(<span class="number">8</span>, <span class="number">-1</span>).toLowerCase();</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">//æšä¸¾å¯¹è±¡</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">loopObj</span>(<span class="params">obj, callback</span>) </span>&#123;</div><div class="line"> <span class="built_in">Object</span>.keys(obj).forEach(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</div><div class="line">callback(key, obj[key], obj);</div><div class="line">&#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//ç»™dataç”¨Object.definePropertyç»‘å®š</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleData</span>(<span class="params">context, data</span>) </span>&#123;</div><div class="line">loopObj(data, (key, val, data) =&gt; &#123;</div><div class="line">defineProp(context, key, val);</div><div class="line">&#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//å¤„ç†computedå±æ€§</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleComputed</span>(<span class="params">context, obj</span>) </span>&#123;</div><div class="line"><span class="keyword">let</span> type;</div><div class="line">loopObj(obj, (key, val, obj) =&gt; &#123;</div><div class="line">defineProp(context, key, val);</div><div class="line">&#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">defineProp</span>(<span class="params">obj, key, val</span>) </span>&#123;</div><div class="line">    <span class="keyword">let</span> _val = val, type;</div><div class="line">    <span class="keyword">return</span> <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</div><div class="line">        enumerable: <span class="literal">true</span>,</div><div class="line">        configable: <span class="literal">true</span>,</div><div class="line">        get: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">            type = typeOf(_val);</div><div class="line">            <span class="keyword">switch</span> (type) &#123;</div><div class="line">            <span class="comment">/**</span></div><div class="line"><span class="comment">             * å±æ€§å€¼å¯¹åº”ä¸€ä¸ªå‡½æ•°, ä¹Ÿå°±æ˜¯computedé‡Œé¢åªå£°æ˜äº†getter</span></div><div class="line"><span class="comment">             * eg.</span></div><div class="line"><span class="comment">             * ...</span></div><div class="line"><span class="comment">             * computed: &#123;</span></div><div class="line"><span class="comment">             * info() &#123;</span></div><div class="line"><span class="comment">             * return `info content: my name is $&#123;this.firstName&#125;$&#123;this.lastName&#125;, I'm $&#123;this.age&#125; years old`;</span></div><div class="line"><span class="comment">             * &#125;</span></div><div class="line"><span class="comment">             * ...</span></div><div class="line"><span class="comment">             * &#125;</span></div><div class="line"><span class="comment">             * ...</span></div><div class="line"><span class="comment">             */</span></div><div class="line">            <span class="keyword">case</span> <span class="string">"function"</span>:</div><div class="line">            <span class="keyword">return</span> _val.call(obj);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">            <span class="comment">/**</span></div><div class="line"><span class="comment">             * å±æ€§å€¼å¯¹åº”ä¸€ä¸ªå¯¹è±¡, ä¹Ÿå°±æ˜¯computedé‡Œé¢åŒæ—¶å£°æ˜äº†getter/setter</span></div><div class="line"><span class="comment">             * eg.</span></div><div class="line"><span class="comment">             * ...</span></div><div class="line"><span class="comment">             * computed: &#123;</span></div><div class="line"><span class="comment">             * fullName: &#123;</span></div><div class="line"><span class="comment">             * get() &#123;</span></div><div class="line"><span class="comment">             * return `my fullName is: $&#123;this.firstName&#125;$&#123;this.lastName&#125;`;</span></div><div class="line"><span class="comment">             * &#125;,</span></div><div class="line"><span class="comment">             * set() &#123;</span></div><div class="line"><span class="comment">             * value = value.split(" ");</span></div><div class="line"><span class="comment">             * this.firstName = value[0];</span></div><div class="line"><span class="comment">             * this.lastName = value[value.length - 1];</span></div><div class="line"><span class="comment">             * &#125;</span></div><div class="line"><span class="comment">             * &#125;</span></div><div class="line"><span class="comment">             * &#125;</span></div><div class="line"><span class="comment">             * ...</span></div><div class="line"><span class="comment">             */</span></div><div class="line">            <span class="keyword">case</span> <span class="string">"object"</span>:</div><div class="line">            <span class="keyword">return</span> _val.get.call(obj);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">            <span class="comment">//å…¶ä»–ç±»å‹é»˜è®¤</span></div><div class="line">            <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">return</span> _val;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line">        set: <span class="function"><span class="keyword">function</span>(<span class="params">newV</span>) </span>&#123;</div><div class="line">        type = typeOf(_val);</div><div class="line">        <span class="keyword">switch</span> (type) &#123;</div><div class="line">        <span class="comment">//å±æ€§å€¼å¯¹åº”ä¸€ä¸ªå¯¹è±¡, ä¹Ÿå°±æ˜¯computedé‡Œé¢åŒæ—¶å£°æ˜äº†getter/setter</span></div><div class="line">        <span class="keyword">case</span> <span class="string">"object"</span>:</div><div class="line">        _val.set.call(obj, newV);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="comment">//å…¶ä»–ç±»å‹çš„é»˜è®¤</span></div><div class="line">        <span class="keyword">default</span>:</div><div class="line">        <span class="keyword">if</span> (newV !== _val) &#123;</div><div class="line">        _val = newV;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>ä¸Šé¢å°±æ˜¯æˆ‘ä»¬ä¸€ä¸ªå®ç°äº†, å…¶ä¸­<code>defineProp</code>è¿™ä¸ªå‡½æ•°ä¸­, æˆ‘ä»¬åšäº†ä¸‹é¢å‡ æ­¥:</p><ol><li>ç¼“å­˜å½“å‰å±æ€§å€¼</li><li>è°ƒç”¨Object.definePropertyæ–¹æ³•åœ¨objä¸Šå®šä¹‰å±æ€§key</li><li>åœ¨<code>descriptor</code>ä¸­çš„<code>getter</code>/<code>setter</code>é‡Œé¢åˆ¤æ–­å±æ€§å€¼ç±»å‹(å¦‚æœæ˜¯å‡½æ•°æˆ–è€…å¯¹è±¡, é‚£è¯¥å±æ€§å°±æ˜¯åœ¨<code>computed</code>[å…ˆä¸è°ˆ<code>watch</code>]é‡Œé¢å£°æ˜çš„, <code>getter</code>é‡Œé¢è¿”å›è¯¥å‡½æ•°çš„æ‰§è¡Œç»“æœã€<code>setter</code>é‡Œé¢æ‰§è¡Œ<code>computed</code>ä¸­æŒ‡å®šçš„<code>set</code>å‡½æ•°[å¦‚æœæœ‰çš„è¯], å¦åˆ™ä½œä¸ºæ™®é€šçš„<code>data</code>å¤„ç†)</li></ol><h4 id="watch"><a href="#watch" class="headerlink" title="watch"></a>watch</h4><p><code>watch</code>åä¸ºè§‚å¯Ÿè€…, é€šè¿‡ç›‘å¬ç»„ä»¶å†…æŸä¸ªå±æ€§æ¥æ‰§è¡ŒæŸäº›æ“ä½œ, æœ€å¸¸ç”¨çš„å°±æ˜¯ç»„ä»¶ä¸­æŸä¸ªå±æ€§å€¼å‘ç”Ÿå˜åŒ–ä¹‹å, å‘åç«¯å‘é€ä¸€ä¸ªå¼‚æ­¥è¯·æ±‚, æ¯”å¦‚ä¸€äº›å•†å“ç½‘ç«™ä¸Šæœ‰é¡¶éƒ¨tabæ , æ¯ä¸ªtabéƒ½æ˜¯ä¸€ä¸ªç±»ç›®, è¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥ç»™è¿™äº›tabç»‘å®š<code>click</code>äº‹ä»¶, ç„¶ååœ¨äº‹ä»¶å¤„ç†ä¸­å¤„ç†é¡¶éƒ¨tabæ ç»‘å®šçš„å±æ€§å€¼, watchä¸­å»ç›‘å¬å®ƒçš„å˜åŒ–æ¥å‘é€å¼‚æ­¥è¯·æ±‚ç­‰ç­‰, æ¯”å¦‚ä¸‹é¢çš„ä¾‹å­:</p><p>å…ˆæ¥çœ‹æ¨¡æ¿éƒ¨åˆ†:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">li</span> @<span class="attr">click</span>=<span class="string">"setFilter('1')"</span>&gt;</span>ç”·è£…<span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">li</span> @<span class="attr">click</span>=<span class="string">"setFilter('2')"</span>&gt;</span>å¥³è£…<span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">li</span> @<span class="attr">click</span>=<span class="string">"setFilter('3')"</span>&gt;</span>ç«¥è£…<span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">li</span> @<span class="attr">click</span>=<span class="string">"setFilter('4')"</span>&gt;</span>ç¾é£Ÿ<span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div><div class="line">...</div></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬çœ‹çœ‹jséƒ¨åˆ†å®ç°:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">default</span>() &#123;</div><div class="line">data() &#123;</div><div class="line"><span class="keyword">return</span> &#123;</div><div class="line">page: <span class="number">1</span>,</div><div class="line">filter: <span class="string">"1"</span>,</div><div class="line">goodsList: []</div><div class="line">&#125;;</div><div class="line">&#125;,</div><div class="line">watch: &#123;</div><div class="line"><span class="keyword">async</span> filter() &#123;</div><div class="line"><span class="keyword">const</span> &#123; filter, page &#125; = <span class="keyword">this</span>,</div><div class="line">res = <span class="keyword">await</span> <span class="keyword">this</span>.queryGoods(filter, page);</div><div class="line"><span class="keyword">if</span> (res.success) &#123;</div><div class="line"><span class="keyword">this</span>.goodsList = res.goods;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">&#125;,</div><div class="line">methods: &#123;</div><div class="line">setFilter(filter) &#123;</div><div class="line"><span class="keyword">this</span>.filter = filter;</div><div class="line"><span class="keyword">this</span>.page = <span class="number">1</span>;</div><div class="line"><span class="keyword">this</span>.goodsList = [];</div><div class="line">&#125;,</div><div class="line"><span class="keyword">async</span> queryGoods(filter, page) &#123;</div><div class="line"><span class="comment">//...</span></div><div class="line">&#125;</div><div class="line">&#125;,</div><div class="line"><span class="comment">//...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><p>å½“ç„¶è¿™ä¸ªä¾‹å­å¯èƒ½æœ‰ç‚¹æç«¯, å› ä¸º<code>queryGoods</code>å®Œå…¨å¯ä»¥æ”¾åœ¨<code>setFilter</code>é‡Œé¢å»è°ƒç”¨, ä½†æ˜¯ä¸ºäº†æ¼”ç¤ºæ•ˆæœ, åªèƒ½è¿™ä¹ˆåšäº†ğŸ˜‚</p><p>ä¸‹é¢ä¸€èµ·çœ‹çœ‹çœ‹çœ‹<code>watch</code>éƒ¨åˆ†çš„å®ç°, æœ‰äº†åˆšæ‰çš„åˆ†æ, æˆ‘ä»¬çŸ¥é“<code>watch</code>ä¸­å£°æ˜çš„è‚¯å®šæ˜¯åœ¨<code>setter</code>éƒ¨åˆ†è¿›è¡Œè°ƒç”¨çš„, æ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨å¤„ç†<code>data</code>çš„æ—¶å€™å°±æŠŠ<code>watch</code>å¯¹åº”çš„åŠ ä¸Š:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">//é¦–å…ˆæˆ‘ä»¬éœ€è¦åœ¨æ„é€ å‡½æ•°é‡Œé¢, æ”¹ä¸‹handleDataè¿™ä¸ªå‡½æ•°çš„è°ƒç”¨, ç»™å®ƒæŠŠobj.watchä¹Ÿä¼ è¿›å»</span></div><div class="line"><span class="comment">// handleData(this, data);</span></div><div class="line">handleData(<span class="keyword">this</span>, data, obj.watch);</div><div class="line"></div><div class="line"><span class="comment">//æ¥ä¸‹æ¥æˆ‘ä»¬æ”¹å†™handleDataè¿™ä¸ªå‡½æ•°</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleData</span>(<span class="params">context, data, watch</span>) </span>&#123;</div><div class="line"><span class="keyword">let</span> inWatch, watchVal;</div><div class="line">loopObj(data, (key, val, data) =&gt; &#123;</div><div class="line"><span class="comment">//åˆ¤æ–­åœ¨watchä¸­æ˜¯å¦ä¹Ÿå£°æ˜äº†è¯¥å±æ€§å€¼</span></div><div class="line">inWatch = hasOwnProp(watch, key);</div><div class="line"><span class="comment">//å¦‚æœæœ‰å–å‡ºæ¥, ä½œä¸ºdefinePropçš„ç¬¬äº”ä¸ªå‚æ•°ç»™ä¼ è¿›å»</span></div><div class="line">watchVal = inWatch ? watch[key] : <span class="literal">null</span>;</div><div class="line">defineProp(context, key, val, inWatch, watchVal);</div><div class="line">&#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//ä¸‹é¢å°±æ˜¯æˆ‘ä»¬è¯´åˆ°çš„åœ¨setteréƒ¨åˆ†è°ƒç”¨å£°æ˜çš„watchè§‚å¯Ÿè€…</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">defineProp</span>(<span class="params">obj, key, val, inWatch = false, watchVal = (</span>) =&gt; </span>&#123;&#125;) &#123;</div><div class="line">    <span class="keyword">let</span> _val = val, type;</div><div class="line">    <span class="keyword">return</span> <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</div><div class="line">        enumerable: <span class="literal">true</span>,</div><div class="line">        configable: <span class="literal">true</span>,</div><div class="line">        get: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">            type = typeOf(_val);</div><div class="line">            <span class="keyword">switch</span> (type) &#123;</div><div class="line">            <span class="comment">/**</span></div><div class="line"><span class="comment">             * å±æ€§å€¼å¯¹åº”ä¸€ä¸ªå‡½æ•°, ä¹Ÿå°±æ˜¯computedé‡Œé¢åªå£°æ˜äº†getter</span></div><div class="line"><span class="comment">             * eg.</span></div><div class="line"><span class="comment">             * ...</span></div><div class="line"><span class="comment">             * computed: &#123;</span></div><div class="line"><span class="comment">             * info() &#123;</span></div><div class="line"><span class="comment">             * return `info content: my name is $&#123;this.firstName&#125;$&#123;this.lastName&#125;, I'm $&#123;this.age&#125; years old`;</span></div><div class="line"><span class="comment">             * &#125;</span></div><div class="line"><span class="comment">             * ...</span></div><div class="line"><span class="comment">             * &#125;</span></div><div class="line"><span class="comment">             * ...</span></div><div class="line"><span class="comment">             */</span></div><div class="line">            <span class="keyword">case</span> <span class="string">"function"</span>:</div><div class="line">            <span class="keyword">return</span> _val.call(obj);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">            <span class="comment">/**</span></div><div class="line"><span class="comment">             * å±æ€§å€¼å¯¹åº”ä¸€ä¸ªå¯¹è±¡, ä¹Ÿå°±æ˜¯computedé‡Œé¢åŒæ—¶å£°æ˜äº†getter/setter</span></div><div class="line"><span class="comment">             * eg.</span></div><div class="line"><span class="comment">             * ...</span></div><div class="line"><span class="comment">             * computed: &#123;</span></div><div class="line"><span class="comment">             * fullName: &#123;</span></div><div class="line"><span class="comment">             * get() &#123;</span></div><div class="line"><span class="comment">             * return `my fullName is: $&#123;this.firstName&#125;$&#123;this.lastName&#125;`;</span></div><div class="line"><span class="comment">             * &#125;,</span></div><div class="line"><span class="comment">             * set() &#123;</span></div><div class="line"><span class="comment">             * value = value.split(" ");</span></div><div class="line"><span class="comment">             * this.firstName = value[0];</span></div><div class="line"><span class="comment">             * this.lastName = value[value.length - 1];</span></div><div class="line"><span class="comment">             * &#125;</span></div><div class="line"><span class="comment">             * &#125;</span></div><div class="line"><span class="comment">             * &#125;</span></div><div class="line"><span class="comment">             * ...</span></div><div class="line"><span class="comment">             */</span></div><div class="line">            <span class="keyword">case</span> <span class="string">"object"</span>:</div><div class="line">            <span class="keyword">return</span> _val.get.call(obj);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">            <span class="comment">//å…¶ä»–ç±»å‹é»˜è®¤</span></div><div class="line">            <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">return</span> _val;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line">        set: <span class="function"><span class="keyword">function</span>(<span class="params">newV</span>) </span>&#123;</div><div class="line">        type = typeOf(_val);</div><div class="line">        <span class="keyword">switch</span> (type) &#123;</div><div class="line">        <span class="comment">//å±æ€§å€¼å¯¹åº”ä¸€ä¸ªå¯¹è±¡, ä¹Ÿå°±æ˜¯computedé‡Œé¢åŒæ—¶å£°æ˜äº†getter/setter</span></div><div class="line">        <span class="keyword">case</span> <span class="string">"object"</span>:</div><div class="line">        _val.set.call(obj, newV);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="comment">//å…¶ä»–ç±»å‹çš„é»˜è®¤</span></div><div class="line">        <span class="keyword">default</span>:</div><div class="line">        <span class="keyword">if</span> (newV !== _val) &#123;</div><div class="line">        _val = newV;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line"><span class="comment">//å¦‚æœwatchè§‚å¯Ÿè€…å­˜åœ¨, å¹¶ä¸”å¯¹åº”ä¸€ä¸ªå›è°ƒå‡½æ•°, åœ¨å€¼å‘ç”Ÿæ”¹å˜çš„æ—¶å€™è°ƒç”¨è¯¥å›è°ƒ, å¹¶ä¿®æ”¹thisæŒ‡å‘åˆ°å½“å‰vmå®ä¾‹</span></div><div class="line">            <span class="keyword">if</span> (inWatch &amp;&amp; typeOf(watchVal) === <span class="string">"function"</span>) &#123;</div><div class="line">            watchVal.call(obj);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>å†æ¥çœ‹ä¸‹ç”¨æ³•:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> vm = <span class="keyword">new</span> Vm(&#123;</div><div class="line">data() &#123;</div><div class="line"><span class="keyword">return</span> &#123;</div><div class="line">firstName: <span class="string">"rw"</span>,</div><div class="line">lastName: <span class="string">"son"</span>,</div><div class="line">age: <span class="number">25</span></div><div class="line">&#125;;</div><div class="line">&#125;,</div><div class="line">computed: &#123;</div><div class="line">info() &#123;</div><div class="line"><span class="keyword">return</span> <span class="string">`info content: my name is <span class="subst">$&#123;<span class="keyword">this</span>.firstName&#125;</span><span class="subst">$&#123;<span class="keyword">this</span>.lastName&#125;</span>, I'm <span class="subst">$&#123;<span class="keyword">this</span>.age&#125;</span> years old`</span>;</div><div class="line">&#125;,</div><div class="line">fullName: &#123;</div><div class="line">get() &#123;</div><div class="line"><span class="keyword">return</span> <span class="string">`my fullName is: <span class="subst">$&#123;<span class="keyword">this</span>.firstName&#125;</span><span class="subst">$&#123;<span class="keyword">this</span>.lastName&#125;</span>`</span>;</div><div class="line">&#125;,</div><div class="line">set(value) &#123;</div><div class="line">value = value.split(<span class="string">" "</span>);</div><div class="line"><span class="keyword">this</span>.firstName = value[<span class="number">0</span>];</div><div class="line"><span class="keyword">this</span>.lastName = value[value.length - <span class="number">1</span>];</div><div class="line">&#125;</div><div class="line">&#125;,</div><div class="line">text: <span class="string">"just a test case"</span></div><div class="line">&#125;,</div><div class="line">watch: &#123;</div><div class="line">firstName() &#123;</div><div class="line"><span class="built_in">console</span>.log(<span class="string">`%c now firstName's value is: <span class="subst">$&#123;<span class="keyword">this</span>.firstName&#125;</span>`</span>, <span class="string">"color: red"</span>);</div><div class="line"><span class="comment">//èµ°åˆ°vm.fullName = "song rw";å°±ä¼šè¾“å‡º</span></div><div class="line">&#125;,</div><div class="line">lastName() &#123;</div><div class="line"><span class="built_in">console</span>.log(<span class="string">`%c now lastName's value is: <span class="subst">$&#123;<span class="keyword">this</span>.lastName&#125;</span>`</span>, <span class="string">"color: green"</span>);</div><div class="line"><span class="comment">//èµ°åˆ°vm.fullName = "song rw";å°±ä¼šè¾“å‡º</span></div><div class="line">&#125;,</div><div class="line">age() &#123;</div><div class="line"><span class="built_in">console</span>.log(<span class="string">`%c now age's value is: <span class="subst">$&#123;<span class="keyword">this</span>.age&#125;</span>`</span>, <span class="string">"color: yellow"</span>);</div><div class="line"><span class="comment">//èµ°åˆ°vm.fullName = "song rw";å°±ä¼šè¾“å‡º</span></div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(vm.text);</div><div class="line"><span class="built_in">console</span>.log(vm.info);</div><div class="line">vm.fullName = <span class="string">"song rw"</span>;</div><div class="line"><span class="built_in">console</span>.log(vm.info);</div><div class="line"><span class="built_in">console</span>.log(vm.firstName);</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨ç”¨&lt;code&gt;Vue&lt;/code&gt;åšå¼€å‘ä¸­, æˆ‘ä»¬å¤šå¤šå°‘å°‘éƒ½ä¼šç”¨åˆ°é‡Œé¢ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„ä¸œè¥¿: &lt;code&gt;computed&lt;/code&gt;å’Œ&lt;code&gt;watch&lt;/code&gt;, æ¥ä¸‹æ¥æˆ‘ä»¬ä¸€èµ·åˆ†æå¹¶ç®€å•å®ç°ä¸‹è¿™ä¸¤ä¸ªå±æ€§ã€‚&lt;/p&gt;
&lt;h4 id=&quot;computed&quot;&gt;&lt;a h
      
    
    </summary>
    
      <category term="JavaScript" scheme="http://yoursite.com/categories/JavaScript/"/>
    
      <category term="Vue" scheme="http://yoursite.com/categories/JavaScript/Vue/"/>
    
    
  </entry>
  
  <entry>
    <title>ç”¨NodeJså’ŒPythonå¼€å‘ä¸€ä¸ªSublimeæ’ä»¶</title>
    <link href="http://yoursite.com/2017/10/24/2017-10-24-write-a-sublime-plugin-by-python-nodejs/"/>
    <id>http://yoursite.com/2017/10/24/2017-10-24-write-a-sublime-plugin-by-python-nodejs/</id>
    <published>2017-10-23T16:00:00.000Z</published>
    <updated>2017-10-24T07:38:04.404Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://www.sublimetext.com/" target="_blank" rel="external">Sublime Text</a>è‘—æœ‰æœ€æ€§æ„Ÿçš„ç¼–è¾‘å™¨ä¹‹ç§°,å®ƒè½»é‡,æ˜“äºæ‹“å±•,é€šè¿‡æ’ä»¶çš„æ–¹å¼å¯ä½¿å®ƒå˜å¾—å¾ˆå¼ºå¤§,è€Œæˆ‘æ›´æ˜¯æŠŠå®ƒä½œä¸ºè‡ªå·±çš„ä¸»è¦ç¼–è¾‘å™¨ä½¿ç”¨ã€‚</p><p>æœ‰ä¸€æ¬¡é€›<a href="https://packagecontrol.io" target="_blank" rel="external">package control</a>çš„æ—¶å€™,å‘ç°ä¸€ä¸ªç”¨<code>NodeJs</code>æ¥å†™æ’ä»¶çš„è„šæ‰‹æ¶: <a href="https://github.com/akira-cn/SublimeJS_Samples" target="_blank" rel="external">SublimeJS_Samples</a>,æ‰å‘ç°ç”¨<code>NodeJs</code>ç»“åˆ<code>Python</code>ä¹Ÿå¯ä»¥æ¥å¼€å‘æ’ä»¶,è¿™å¯¹äºå¯¹<code>Python</code>ä¸æ˜¯ç‰¹åˆ«äº†è§£çš„äººå¯èƒ½å¾ˆåƒåŠ›,ç„¶åå°±ç ”ç©¶äº†å‡ ä¸ªå¸¸ç”¨æ’ä»¶çš„æºç ,æ‹¿<a href="https://github.com/luozhihua/sublime-vue-formatter" target="_blank" rel="external">sublime-vue-formatter</a>è¿™ä¸ªæ’ä»¶è¯¦ç»†çœ‹äº†ä¸‹,æ€»ç»“å‡ºåŸç†å¤§æ¦‚æ˜¯è¿™æ ·çš„:</p><ol><li>åœ¨<code>Python</code>ä¸­æ‹¿åˆ°å½“å‰æ­£åœ¨ç¼–è¾‘çš„æ–‡ä»¶æˆ–è€…é€‰ä¸­çš„å†…å®¹</li><li>ç”¨<code>Python</code>å­è¿›ç¨‹<code>subprocess</code>å»æ‰§è¡Œä¸€æ®µcmdå‘½ä»¤å¹¶æ¥å—è¾“å‡º,<code>Node</code>è·¯å¾„ä¸ºæˆ‘ä»¬ç”µè„‘ä¸Šè£…çš„<code>Node</code>ç»å¯¹è·¯å¾„(ç”¨æˆ·äº‹å…ˆé…ç½®å¥½), å†å»æ‰§è¡Œä¸€ä¸ª<code>NodeJs</code>è„šæœ¬, ä»¥Macä¸ºä¾‹, æœ€åè¦æ‰§è¡Œçš„å‘½ä»¤å¤§æ¦‚æ˜¯è¿™æ ·çš„<code>/usr/local/bin/node script/run.js --arg1=argVal1  --arg2=argVal2</code>(å…¶å®å’Œæˆ‘ä»¬å¹³æ—¶åœ¨Terminalé‡Œè¿è¡Œçš„ä¸€æ ·)</li><li><code>Python</code>æ¥æ”¶åˆ°<code>NodeJs</code>çš„æ‰§è¡Œè¿”å›çš„æ—¶å€™, æ›¿æ¢æ–‡ä»¶ä¸­çš„ç›¸å…³å†…å®¹</li></ol><p>æŠ±ç€è¯•è¯•çœ‹çš„å¿ƒç†,æˆ‘ä¹Ÿå†³å®šè‡ªå·±ç”¨è¿™ä¸ªæ¨¡å¼å†™ä¸ªå›¾ç‰‡å‹ç¼©ç›¸å…³çš„æ’ä»¶,å…ˆç®€å•ä»‹ç»ä¸‹æˆ‘æƒ³å†™çš„æ’ä»¶çš„åŠŸèƒ½:</p><ol><li>ç”¨æˆ·åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ–°å»ºé…ç½®æ–‡ä»¶, æŒ‡å®šå‹ç¼©ç›®å½•å’Œé‡Šæ”¾ç›®å½•, è°ƒç”¨<a href="http://tinypng.com" target="_blank" rel="external">tinypng</a>çš„å¼€å‘è€…APIè¿›è¡Œå‹ç¼©</li><li>å½“å‹ç¼©å®Œçš„å›¾ç‰‡å°äºå¤šå°‘å­—èŠ‚æ—¶æŠŠcssä¸­çš„å¼•ç”¨è½¬æ¢æˆ<code>Base64</code>ç¼–ç ,ä¹Ÿæ˜¯é€šè¿‡é…ç½®é¡¹</li><li>ç”¨æˆ·å¯ä»¥é€šè¿‡ä¸€äº›å¿«æ·é”®æˆ–è€…å‘½ä»¤(å­å‘½ä»¤)åœ¨é¡¹ç›®æ ¹ç›®å½•æ–°å»ºé…ç½®æ–‡ä»¶ã€ä¿®æ”¹å…¨å±€<code>NodeJs</code>è·¯å¾„é…ç½®ç­‰ç­‰</li></ol><p>ç°åœ¨çŸ¥é“äº†æˆ‘ä»¬æƒ³åšä»€ä¹ˆ, ä¸‹ä¸€æ­¥å°±æ˜¯æ ¹æ®è¿™ä¸ªéœ€æ±‚å¼€å§‹å†™ä»£ç , å› ä¸ºæ˜¯å›¾ç‰‡å‹ç¼©æ’ä»¶, æ‰€ä»¥æˆ‘æŠŠå®ƒå‘½åæˆ<code>sublime-image-compressor</code></p><h4 id="å‘½ä»¤ã€å­å‘½ä»¤"><a href="#å‘½ä»¤ã€å­å‘½ä»¤" class="headerlink" title="å‘½ä»¤ã€å­å‘½ä»¤"></a>å‘½ä»¤ã€å­å‘½ä»¤</h4><p>åœ¨æ’ä»¶é…ç½®ä¸­, å‘½ä»¤éƒ½æ˜¯é€šè¿‡é…ç½®æ–‡ä»¶å†™å…¥çš„, ä¸‹é¢è´´ä¸‹æˆ‘ä»¬è¿™ä¸ªæ’ä»¶æ”¯æŒå‘½ä»¤çš„ä¸€ä¸ªé…ç½®å¹¶åšä»‹ç»</p><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">//ImageCompressor.sublime-commands</div><div class="line"></div><div class="line">[&#123;</div><div class="line">  <span class="attr">"caption"</span>: <span class="string">"ImageCompress"</span>,</div><div class="line">  <span class="attr">"command"</span>: <span class="string">"image_compress"</span></div><div class="line">&#125;, &#123;</div><div class="line">  <span class="attr">"caption"</span>: <span class="string">"ImageCompress: Init Project Config File"</span>,</div><div class="line">  <span class="attr">"command"</span>: <span class="string">"imagecompress_config_project"</span></div><div class="line">&#125;, &#123;</div><div class="line">  <span class="attr">"caption"</span>: <span class="string">"ImageCompress: Set Global Config"</span>,</div><div class="line">  <span class="attr">"command"</span>: <span class="string">"imagecompress_set_global_plugin_options"</span></div><div class="line">&#125;]</div></pre></td></tr></table></figure><p><code>.sublime-commands</code>æ˜¯ç”¨æ¥æŒ‡å®šæ’ä»¶æ”¯æŒçš„å‘½ä»¤çš„, é‡Œé¢æŒ‡å®šä¸€ä¸ªå¯¹è±¡å‹æ•°ç»„, æ•°ç»„æœ‰<code>caption</code>å’Œ<code>command</code>ä¸¤é¡¹, éœ€è¦æ³¨æ„çš„æ˜¯, <code>command</code>çš„å€¼å’Œ<code>Python</code>çš„ç±»æ˜¯å¯¹åº”çš„, ä¸”<code>Python</code>ä¸­ç”¨é©¼å³°å‘½åæ³•æ¥å®šä¹‰ç±»å, ä»¥ç¬¬ä¸€é¡¹ä¸ºä¾‹, æ¯”å¦‚<code>command</code>çš„å€¼ä¸º<code>image_compress</code>, æˆ‘ä»¬çš„<code>Python</code>ä¸­å°±éœ€è¦åƒç±»ä¼¼ä¸‹é¢çš„æ ·å­å®šä¹‰ä¸€ä¸ªç±»:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImageCompressCommand</span><span class="params">(sublime_plugin.TextCommand)</span>:</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self, edit)</span>:</span></div></pre></td></tr></table></figure><p>å…¶ä»–ç±»ä¼¼</p><h4 id="å¿«æ·é”®"><a href="#å¿«æ·é”®" class="headerlink" title="å¿«æ·é”®"></a>å¿«æ·é”®</h4><p>åœ¨æ’ä»¶é…ç½®ä¸­, å¿«æ·é”®éƒ½æ˜¯é€šè¿‡é…ç½®æ–‡ä»¶å†™å…¥çš„, ä¸‹é¢è´´ä¸‹æˆ‘ä»¬è¿™ä¸ªæ’ä»¶å¿«æ·é”®çš„ä¸€ä¸ªé…ç½®å¹¶åšä»‹ç», éœ€è¦æ³¨æ„çš„æ˜¯, å¦‚æœéœ€è¦å…¼å®¹å¤šå¹³å°, å› ä¸ºæ¯ä¸ªå¹³å°çš„é”®å¯èƒ½éƒ½ä¸å¤ªä¸€æ ·, åˆ™éœ€è¦å¤šä»½é…ç½®æ–‡ä»¶, <code>Windows</code>/<code>Mac</code>/<code>Linux</code>çš„å‘½ååˆ†åˆ«æ˜¯<code>Default (Windows).sublime-keymap</code>/<code>Default (OSX).sublime-keymap</code>/<code>Default (Linux).sublime-keymap</code>, ä¸‹é¢æˆ‘ä»¬æŠŠ<code>Default (OSX).sublime-keymap</code>è¿™ä¸ªæ–‡ä»¶çš„å†…å®¹è´´å‡ºæ¥çœ‹ä¸‹:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[&#123;</div><div class="line">  <span class="attr">"keys"</span>: [<span class="string">"ctrl+shift+i"</span>, <span class="string">"c"</span>],</div><div class="line">  <span class="attr">"command"</span>: <span class="string">"image_compress"</span></div><div class="line">&#125;, &#123;</div><div class="line">  <span class="attr">"keys"</span>: [<span class="string">"ctrl+alt+i"</span>, <span class="string">"f"</span>],</div><div class="line">  <span class="attr">"command"</span>: <span class="string">"image_compress_config_project"</span></div><div class="line">&#125;, &#123;</div><div class="line">  <span class="attr">"keys"</span>: [<span class="string">"ctrl+alt+i"</span>, <span class="string">"g"</span>],</div><div class="line">  <span class="attr">"command"</span>: <span class="string">"image_compress_set_global_plugin_options"</span></div><div class="line">&#125;]</div></pre></td></tr></table></figure><p><code>.sublime-keymap</code>ä¹Ÿæ˜¯æŒ‡å®šä¸€ä¸ªå¯¹è±¡å‹æ•°ç»„, æ¯ä¸ªå¯¹è±¡æœ‰<code>keys</code>å’Œ<code>command</code>ä¸¤ä¸ªå±æ€§, <code>keys</code>æ˜¯æŒ‡å®šæŒ‰å“ªå‡ ä¸ªé”®ç”Ÿæ•ˆçš„, <code>command</code>çš„é…ç½®å’Œä¹‹å‰çš„å‘½ä»¤é…ç½®ä¸€æ ·</p><p>å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡æ·»åŠ å…¶ä»–é…ç½®æ–‡ä»¶æ¯”å¦‚<code>Context.sublime-menu</code>æˆ–è€…<code>Main.sublime-menu</code>æ¥æŒ‡å®šæ’ä»¶çš„å³é”®èœå•æˆ–è€…åœ¨<code>Toolbar</code>ä¸Šçš„èœå•é…ç½®</p><p>è¯´å®Œäº†å‡ ä¸ªé…ç½®, æˆ‘ä»¬ä¸€èµ·æ¥å†™<code>Python</code>å’Œ<code>NodeJs</code>, å…ˆå†™<code>Python</code>å§</p><p>åœ¨<code>Python</code>ä¸­æˆ‘ä»¬éœ€è¦å®Œæˆå¤§æ¦‚ä¸‹é¢å‡ ä¸ªä»»åŠ¡:</p><ol><li>é¦–å…ˆè·å–ç”¨æˆ·å½“å‰é¡¹ç›®çš„æ ¹ç›®å½•</li><li>è·å–æ ¹ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶, å¦‚æœç”¨æˆ·æ²¡æœ‰æ–°å»ºé…ç½®æ–‡ä»¶, å°±è¯»å–ä¸€ä»½é»˜è®¤çš„é…ç½®æ–‡ä»¶, æ‹¼å‡ºå‘½ä»¤è¡Œå‚æ•°(â€“arg1=argVal1 â€“arg2=argVal2)</li><li>è·å–ç”¨æˆ·è£…çš„<code>NodeJs</code>å…¨è·¯å¾„, ç»“åˆä¸Šä¸€æ­¥æ‹¼å¥½çš„å‘½ä»¤è¡Œå‚æ•°å†æ‹¼å‡ºä¸€ä¸ªå¯æ‰§è¡Œå‘½ä»¤(ç±»ä¼¼åˆšæ‰åˆ†ææµç¨‹é‚£è¾¹é‚£æ¡)</li><li>ç”¨<code>subprocess</code>æ¨¡å—æ¥è¿è¡Œè¯¥å‘½ä»¤</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># å†™æ’ä»¶å¿…é¡»å¼•å…¥è¿™ä¸¤ä¸ªæ¨¡å—</span></div><div class="line"><span class="keyword">import</span> sublime, sublime_plugin</div><div class="line"></div><div class="line"><span class="comment"># Pythonå†…ç½®æ¨¡å—çš„å¼•å…¥</span></div><div class="line"><span class="keyword">import</span> os, sys, subprocess, codecs, webbrowser, platform, json</div><div class="line"></div><div class="line"><span class="comment"># å½“å‰æ’ä»¶, é…ç½®æ–‡ä»¶, å¿«æ·é”®é…ç½®, æ‰§è¡Œä»»åŠ¡çš„jsè·¯å¾„é…ç½®</span></div><div class="line">PLUGIN_FOLDER = os.path.dirname(os.path.realpath(__file__))</div><div class="line">CONFIG_FILE = <span class="string">"image-compressor.config.json"</span></div><div class="line">SETTINGS_FILE = <span class="string">"ImageCompressor.sublime-settings"</span></div><div class="line">KEYMAP_FILE = <span class="string">"Default ($PLATFORM).sublime-keymap"</span></div><div class="line"><span class="comment"># è¿™é‡ŒJS_PATHå¿…é¡»ä¸ºç»å¯¹è·¯å¾„, å¦åˆ™ä¼šå»$&#123;nodepath&#125;æ‰¾/scripts/index.js,æ‰¾ä¸åˆ°è‚¯å®šä¼šæŠ¥é”™</span></div><div class="line">JS_PATH = PLUGIN_FOLDER.replace(<span class="string">" "</span>, <span class="string">"\\ "</span>) + <span class="string">"/scripts/index.js"</span></div><div class="line"></div><div class="line">//å¼•å…¥commandsæ¨¡å—, å¹¶catchå¼‚å¸¸</div><div class="line"><span class="keyword">try</span>:</div><div class="line">  <span class="keyword">import</span> commands</div><div class="line"><span class="keyword">except</span> ImportError:</div><div class="line">  <span class="keyword">pass</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImageCompressCommand</span><span class="params">(sublime_plugin.TextCommand)</span>:</span></div><div class="line">  </div><div class="line">  <span class="string">"""</span></div><div class="line"><span class="string">    æ’ä»¶éœ€è¦ä¸€ä¸ªrunæ–¹æ³•, è¯¥æ–¹æ³•æ¥æ”¶selfå’Œeditä¸¤ä¸ªå‚æ•°</span></div><div class="line"><span class="string">    def run(self, run[, args])</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">    self: ä»£è¡¨å½“å‰ç±»</span></div><div class="line"><span class="string">    view: ä»£è¡¨å½“å‰ç¼–è¾‘çš„tab</span></div><div class="line"><span class="string">    args: å…¶ä»–å‚æ•°, å¯ä»¥åœ¨é…ç½®ä¸­æŒ‡å®š</span></div><div class="line"><span class="string">      æ¯”å¦‚ &#123; "caption": "xxx", "command": "xxxx", "args": &#123;"by": "abc"&#125; &#125;</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">      class Xxxx(sublime_plugin.TextCommand):</span></div><div class="line"><span class="string">        def run(self, edit, by):</span></div><div class="line"><span class="string">          print("by=" + by)</span></div><div class="line"><span class="string">          # by=file</span></div><div class="line"><span class="string">  """</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self, edit)</span>:</span></div><div class="line">    <span class="comment"># æ‹¿åˆ°é¡¹ç›®æ ¹è·¯å¾„çš„ç»å¯¹è·¯å¾„</span></div><div class="line">    currentDir = PluginUtils.get_active_project_path()</div><div class="line">    <span class="comment"># ä».sublime-settingsé…ç½®æ–‡ä»¶ä¸­è·å–å½“å‰å¹³å°çš„node_path</span></div><div class="line">    nodepath = PluginUtils.get_node_path()</div><div class="line">    <span class="comment"># è·å–æ ¹è·¯å¾„</span></div><div class="line">    configs = PluginUtils.load_config()</div><div class="line"></div><div class="line">    configs += <span class="string">" --currentDir='"</span> + currentDir + <span class="string">"'"</span></div><div class="line"></div><div class="line">    <span class="comment"># ç©ºæ ¼æ›¿æ¢</span></div><div class="line">    nodepath = nodepath.replace(<span class="string">" "</span>, <span class="string">"\\ "</span>);</div><div class="line"></div><div class="line">    <span class="comment"># æ‹¼ä¸€ä¸ªcmdæ•°ç»„</span></div><div class="line">    cmd = [nodepath, JS_PATH]</div><div class="line">    cmd.append(configs)</div><div class="line"></div><div class="line">    <span class="comment"># æ‰§è¡Œå‘½ä»¤</span></div><div class="line">    PluginUtils.exec_cmd(cmd)</div></pre></td></tr></table></figure><p>ä¸Šé¢æˆ‘ä»¬å®Œæˆäº†ä¸€ä¸ª<code>ImageCompressCommand</code>è¿™ä¸ªç±»çš„å°è£…,å¹¶ä¸”åœ¨<code>run</code>é‡Œé¢å¥½å‡ ä¸ªåœ°æ–¹éƒ½è°ƒç”¨äº†<code>PluginUtils</code>ä¸‹çš„é™æ€æ–¹æ³•, ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹<code>PluginUtils</code>çš„å®šä¹‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#åœ¨pythonç”¨staticmethod Decoratorè¡¨ç¤ºé™æ€æ–¹æ³•</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PluginUtils</span>:</span></div><div class="line">    <span class="string">'''</span></div><div class="line"><span class="string">      è¯»å–é…ç½®æ–‡ä»¶</span></div><div class="line"><span class="string">      è¿™é‡Œçš„é€»è¾‘æœ‰ç‚¹ä¸å¯¹, åº”è¯¥å…ˆå»é¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰¾é…ç½®æ–‡ä»¶</span></div><div class="line"><span class="string">      æ‰¾ä¸åˆ°å†æ‰¾é»˜è®¤çš„é…ç½®</span></div><div class="line"><span class="string">    '''</span></div><div class="line"></div><div class="line"><span class="meta">    @staticmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">load_config</span><span class="params">(base)</span>:</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            args = <span class="string">""</span></div><div class="line">            <span class="comment"># ä»¥è¯»å–çš„æ¨¡å¼æ‰“å¼€é…ç½®æ–‡ä»¶</span></div><div class="line">            fs = open(CONFIG_FILE, <span class="string">"r"</span>)</div><div class="line">            stream = fs.read()</div><div class="line">            <span class="comment"># steamè¯»å‡ºæ¥æ˜¯ä¸ªjsonå­—ç¬¦ä¸², æ‰€ä»¥éœ€è¦ç”¨json.loadsè½¬æ¢æˆdict</span></div><div class="line">            <span class="comment"># http://python3-cookbook.readthedocs.io/zh_CN/latest/c06/p02_read-write_json_data.html</span></div><div class="line">            data = json.loads(stream)</div><div class="line">            <span class="comment"># è·å–dictä¸‹çš„keyå˜æˆä¸€ä¸ªlist</span></div><div class="line">            keys = data.keys()</div><div class="line">            <span class="comment"># å…³é—­æ–‡ä»¶</span></div><div class="line">            fs.close()</div><div class="line"></div><div class="line">            <span class="comment"># æšä¸¾æ‰€æœ‰key</span></div><div class="line">            <span class="keyword">for</span> key <span class="keyword">in</span> keys:</div><div class="line">                val = data[key]</div><div class="line">                <span class="comment"># æ•°ç»„ç±»å‹å‚æ•°è½¬æ¢æˆå­—ç¬¦ä¸²</span></div><div class="line">                <span class="keyword">if</span> isinstance(val, list):</div><div class="line">                    val = <span class="string">"-compress-config-split-"</span>.join(val)</div><div class="line">                args += <span class="string">" --"</span> + key + <span class="string">"="</span> + str(val)</div><div class="line">            <span class="keyword">return</span> args</div><div class="line">        <span class="keyword">except</span>:</div><div class="line">            <span class="keyword">return</span> <span class="string">""</span></div><div class="line"></div><div class="line">    <span class="comment">#ä».sublime-settingsé‡Œé¢è·å–ç›¸å…³é…ç½®é¡¹</span></div><div class="line"><span class="meta">    @staticmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_pref</span><span class="params">(key)</span>:</span></div><div class="line">        <span class="keyword">return</span> sublime.load_settings(SETTINGS_FILE).get(key)</div><div class="line"></div><div class="line">    <span class="string">'''</span></div><div class="line"><span class="string">        ä».sublime-settingsé‡Œé¢è·å–å½“å‰å¹³å°ä¸‹nodejsçš„è·¯å¾„</span></div><div class="line"><span class="string">    '''</span></div><div class="line"><span class="meta">    @staticmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_node_path</span><span class="params">()</span>:</span></div><div class="line">        platform = sublime.platform()</div><div class="line">        node = PluginUtils.get_pref(<span class="string">"node_path"</span>).get(platform)</div><div class="line">        <span class="keyword">return</span> node</div><div class="line"></div><div class="line">    <span class="string">'''</span></div><div class="line"><span class="string">        è·å–å½“å‰æ¿€æ´»é¡¹ç›®çš„æ ¹è·¯å¾„</span></div><div class="line"><span class="string">        å‚è€ƒhttps://github.com/fyneworks/sublime-TortoiseGIT/blob/master/TortoiseGIT.py#L8å®ç°</span></div><div class="line"><span class="string">    '''</span></div><div class="line"><span class="meta">    @staticmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_active_project_path</span><span class="params">()</span>:</span></div><div class="line">        window = sublime.active_window()</div><div class="line">        folders = window.folders()</div><div class="line">        <span class="keyword">if</span> len(folders) == <span class="number">1</span>:</div><div class="line">            <span class="keyword">return</span> folders[<span class="number">0</span>]</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            active_view = window.active_view()</div><div class="line">            active_file_name = active_view.file_name() <span class="keyword">if</span> active_view <span class="keyword">else</span> <span class="keyword">None</span></div><div class="line">            <span class="keyword">if</span> <span class="keyword">not</span> active_file_name:</div><div class="line">                <span class="keyword">return</span> folders[<span class="number">0</span>] <span class="keyword">if</span> len(folders) <span class="keyword">else</span> os.path.expanduser(<span class="string">"~"</span>)</div><div class="line">            <span class="keyword">for</span> folder <span class="keyword">in</span> folders:</div><div class="line">                <span class="keyword">if</span> active_file_name.startswith(folder):</div><div class="line">                    <span class="keyword">return</span> folder</div><div class="line">            <span class="keyword">return</span> os.path.dirname(active_file_name)</div><div class="line"></div><div class="line">    <span class="string">'''</span></div><div class="line"><span class="string">        æ‰§è¡Œå‘½ä»¤</span></div><div class="line"><span class="string">        å‚è€ƒhttps://github.com/luozhihua/sublime-vue-formatter/blob/master/vue-next-formatter.py#L196å®ç°</span></div><div class="line"><span class="string">    '''</span></div><div class="line"><span class="meta">    @staticmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">exec_cmd</span><span class="params">(cmd)</span>:</span></div><div class="line">        <span class="keyword">if</span> int(sublime.version()) &lt; <span class="number">3000</span>:</div><div class="line">            <span class="keyword">if</span> sublime.platform() != <span class="string">"windows"</span>:</div><div class="line">                run = <span class="string">'"'</span> + <span class="string">'" "'</span>.join(cmd) + <span class="string">'"'</span></div><div class="line">                <span class="keyword">return</span> commands.getoutput(run)</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                startupinfo = subprocess.STARTUPINFO()</div><div class="line">                startupinfo.dwFlags |= subprocess.STARTF_USESHOWWINDOW</div><div class="line">                <span class="keyword">return</span> subprocess.Popen(cmd, \</div><div class="line">                                        stdout=subprocess.PIPE, \</div><div class="line">                                        startupinfo=startupinfo).communicate()[<span class="number">0</span>]</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            run = <span class="string">" "</span>.join(cmd)</div><div class="line">            res = subprocess.check_output(run, stderr=subprocess.STDOUT, shell=<span class="keyword">True</span>, env=os.environ)</div><div class="line">            print(res)</div></pre></td></tr></table></figure><p>ä¸Šé¢æˆ‘ä»¬å°±å®Œæˆäº†å¯¹<code>PluginUtils</code>è¿™ä¸ªç±»çš„å°è£…, åœ¨æœ€åä¸€ä¸ªæ–¹æ³•ä¸­, æˆ‘ä»¬ç”¨äº†<code>subprocess</code>ä¸‹é¢çš„å‡ ä¸ªæ–¹æ³•, <code>subprocess</code>ä¸‹é¢è¿˜æœ‰å¾ˆå¤šå…¶ä»–æ–¹æ³•, è¿™äº›åœ¨<a href="http://python3-cookbook.readthedocs.io/zh_CN/latest/c13/p06_executing_external_command_and_get_its_output.html" target="_blank" rel="external">æ–‡æ¡£</a>é‡Œé¢éƒ½èƒ½æ‰¾åˆ°, ä¸‹é¢å†çœ‹çœ‹<code>NodeJs</code>éƒ¨åˆ†å®ç°:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> dir = <span class="built_in">require</span>(<span class="string">"node-dir"</span>),</div><div class="line">    co = <span class="built_in">require</span>(<span class="string">"co"</span>),</div><div class="line">    tinify = <span class="built_in">require</span>(<span class="string">"tinify"</span>),</div><div class="line">    mkdirp = <span class="built_in">require</span>(<span class="string">"mkdirp"</span>),</div><div class="line">    <span class="built_in">Promise</span> = <span class="built_in">require</span>(<span class="string">"bluebird"</span>),</div><div class="line">    fs = <span class="built_in">require</span>(<span class="string">"fs"</span>),</div><div class="line">    path = <span class="built_in">require</span>(<span class="string">"path"</span>);</div><div class="line"></div><div class="line"><span class="comment">//ç¼“å­˜Object.prototype</span></div><div class="line"><span class="keyword">const</span> obj2 = &#123;&#125;;</div><div class="line"></div><div class="line"><span class="comment">//å‚æ•°è§£æ</span></div><div class="line"><span class="keyword">const</span> parseArgs = <span class="function"><span class="params">arr</span> =&gt;</span> &#123;</div><div class="line">    <span class="keyword">let</span> res = &#123;&#125;,</div><div class="line">        tmp = <span class="literal">null</span>;</div><div class="line">    arr.map(<span class="function"><span class="params">item</span> =&gt;</span> item.replace(<span class="regexp">/^-&#123;2&#125;/</span>, <span class="string">""</span>))</div><div class="line">        .forEach(<span class="function"><span class="params">val</span> =&gt;</span> &#123;</div><div class="line">            tmp = val.split(<span class="string">"="</span>);</div><div class="line">            <span class="comment">//Pythonä¸­å¸ƒå°”å€¼è½¬æ¢æˆTrue/False, æ•°å­—è½¬æ¢æˆ'123'</span></div><div class="line">            <span class="keyword">if</span> (<span class="regexp">/^[\d]+$/</span>.test(tmp[<span class="number">1</span>])) &#123;</div><div class="line">                tmp[<span class="number">1</span>] = <span class="built_in">Number</span>(tmp[<span class="number">1</span>]);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (<span class="regexp">/^True$/</span>.test(tmp[<span class="number">1</span>])) &#123;</div><div class="line">                tmp[<span class="number">1</span>] = <span class="literal">true</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (<span class="regexp">/^False/</span>.test(tmp[<span class="number">1</span>])) &#123;</div><div class="line">                tmp[<span class="number">1</span>] = <span class="literal">false</span>;</div><div class="line">            &#125;</div><div class="line">            res[tmp[<span class="number">0</span>]] = tmp[<span class="number">1</span>];</div><div class="line">        &#125;);</div><div class="line">    <span class="keyword">return</span> res;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">//åˆ¤æ–­æ˜¯å¦ä¸ºä¸€ä¸ªå›¾ç‰‡æ–‡ä»¶</span></div><div class="line"><span class="keyword">const</span> isImageFile = <span class="function"><span class="params">file</span> =&gt;</span> /\.(jpe?g|png|gif)$/i.test(file);</div><div class="line"></div><div class="line"><span class="comment">//åˆ¤æ–­æ˜¯å¦ä¸ºä¸€ä¸ªcssæ–‡ä»¶</span></div><div class="line"><span class="keyword">const</span> isCssFile = <span class="function"><span class="params">file</span> =&gt;</span> /\.css$/i.test(file);</div><div class="line"></div><div class="line"><span class="comment">//ç›®æ ‡ç›®å½•</span></div><div class="line"><span class="keyword">const</span> distDir = <span class="function">(<span class="params">prefix, folder</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">if</span> (!folder) &#123;</div><div class="line">        folder = prefix;</div><div class="line">        prefix = __dirname;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//æ‹¼è·¯å¾„</span></div><div class="line">    <span class="keyword">return</span> path.join(prefix, folder);</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">//åŒæ­¥è¯»å–ä¸€ä¸ªæ–‡ä»¶çš„çŠ¶æ€</span></div><div class="line"><span class="keyword">const</span> fstat = <span class="function"><span class="params">filePath</span> =&gt;</span> fs.fstatSync(filePath);</div><div class="line"></div><div class="line"><span class="comment">//æŠŠæ–‡ä»¶è½¬æ¢æˆbase64ç¼–ç </span></div><div class="line"><span class="keyword">const</span> toBase64 = <span class="function"><span class="params">filePath</span> =&gt;</span> &#123;</div><div class="line">    <span class="keyword">const</span> buffer = fs.readFileSync(filePath);</div><div class="line">    <span class="keyword">return</span> buffer.toString(<span class="string">"base64"</span>);</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">//æŠŠä¸€ä¸ªæ•°ç»„æŒ‰ç…§20ä¸ªæ¯é¡¹åšå­é¡¹ç›®æ‹†åˆ†æˆäºŒçº§æ•°ç»„</span></div><div class="line"><span class="keyword">const</span> splitArray = <span class="function"><span class="params">array</span> =&gt;</span> &#123;</div><div class="line">    <span class="keyword">const</span> length = array.length;</div><div class="line">    <span class="keyword">let</span> res = [];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; length; i += <span class="number">20</span>) &#123;</div><div class="line">        res.push(array.slice(i, i + <span class="number">20</span>));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> res;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">//åˆ¤æ–­ç›®å½•æ˜¯å¦å­˜åœ¨</span></div><div class="line"><span class="keyword">const</span> folderExist = <span class="function"><span class="params">folder</span> =&gt;</span> &#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        fs.readdirSync(folder);</div><div class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">//è¯»å–ç›®å½•ä¸‹çš„csså¹¶ä¸”è½¬æ¢æˆASTå¯¹è±¡</span></div><div class="line"><span class="keyword">const</span> listCssAST = <span class="function"><span class="params">cssdir</span> =&gt;</span> &#123;</div><div class="line">    <span class="keyword">let</span> list = [],</div><div class="line">        fullPath = <span class="literal">null</span>,</div><div class="line">        basename = <span class="literal">null</span>,</div><div class="line">        stream = <span class="literal">null</span>;</div><div class="line">    files = fs.readFileSync(cssdir);</div><div class="line">    list = files.filter(<span class="function"><span class="params">file</span> =&gt;</span> isCssFile).map(<span class="function"><span class="params">file</span> =&gt;</span> &#123;</div><div class="line">        fullPath = path.join(cssdir, file);</div><div class="line">        stream = fs.readFileSync(fullPath);</div><div class="line">        basename = path.basename(fullPath);</div><div class="line">        <span class="keyword">return</span> &#123;</div><div class="line">            ast: stream.parse(stream.toString()),</div><div class="line">            sourcePath: fullPath,</div><div class="line">            distPath: path.join(</div><div class="line">                cssdir,</div><div class="line">                <span class="string">`<span class="subst">$&#123;basename.replace(<span class="regexp">/\.css$/i</span>, <span class="string">""</span>)&#125;</span>.css`</span></div><div class="line">            )</div><div class="line">        &#125;;</div><div class="line">    &#125;);</div><div class="line">    <span class="keyword">return</span> list;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">//æ›¿æ¢cssä¸­çš„background: url(xxx) ä¸º background: url(base64: xxxx)</span></div><div class="line"><span class="keyword">const</span> replaceCss = <span class="function">(<span class="params">cssdir, files</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">if</span> (!files || files.length === <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">const</span> csses = listCssAST(cssdir);</div><div class="line">    <span class="keyword">if</span> (csses.length === <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    files = files.map(<span class="function"><span class="params">file</span> =&gt;</span> &#123;</div><div class="line">        <span class="keyword">return</span> &#123;</div><div class="line">            source: file,</div><div class="line">            encoded: toBase64(file)</div><div class="line">        &#125;;</div><div class="line">    &#125;);</div><div class="line">    <span class="comment">//<span class="doctag">TODO:</span>éå†CSS ASTå¹¶æ›¿æ¢å¼•ç”¨</span></div><div class="line">    <span class="comment">// csses.forEach((&#123; ast, distPath &#125;) =&gt; &#123;&#125;);</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * promiseifyToFile -&gt; source = yield promiseifyToFile("a/b/c/d.jpg");</span></div><div class="line"><span class="comment"> * @param  &#123;String&#125; file æºæ–‡ä»¶è·¯å¾„</span></div><div class="line"><span class="comment"> * @param  &#123;String&#125; dist ç›®æ ‡æ–‡ä»¶è·¯å¾„</span></div><div class="line"><span class="comment"> * åœ¨è°ƒç”¨tinypng APIå¼‚å¸¸å, ç›´æ¥æ‹·è´æºæ–‡ä»¶åˆ°ç›¸å…³ç›®å½•</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">const</span> promiseifyToFile = <span class="function">(<span class="params">file, dist</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">const</span> fileUp = tinify.fromFile(file);</div><div class="line">            fileUp._url</div><div class="line">                .then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</div><div class="line">                    fileUp</div><div class="line">                        .toFile(dist)</div><div class="line">                        .then(<span class="function"><span class="params">e</span> =&gt;</span> &#123;</div><div class="line">                            <span class="keyword">if</span> (e) &#123;</div><div class="line">                                reject(e);</div><div class="line">                                <span class="keyword">return</span>;</div><div class="line">                            &#125;</div><div class="line">                            resolve();</div><div class="line">                        &#125;)</div><div class="line">                        .catch(reject);</div><div class="line">                &#125;)</div><div class="line">                .catch(reject);</div><div class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</div><div class="line">            fs.copyFileSync(file, dist);</div><div class="line">            resolve();</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">//è·å–ç±»å‹å</span></div><div class="line"><span class="keyword">const</span> typeOf = <span class="function"><span class="params">obj</span> =&gt;</span> obj2.toString.call(obj).slice(<span class="number">8</span>, <span class="number">-1</span>).toLowerCase();</div><div class="line"></div><div class="line"><span class="keyword">let</span> args;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (process.argv.length &gt; <span class="number">2</span>) &#123;</div><div class="line"><span class="comment">//å‚æ•°è¯»å–å’Œå¤„ç†</span></div><div class="line">args = parseArgs(process.argv.slice(<span class="number">2</span>));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (args) &#123;</div><div class="line"><span class="comment">//prefixå¤„ç†</span></div><div class="line">args.prefix = args.prefix || <span class="string">""</span>;</div><div class="line"></div><div class="line"><span class="comment">//æºæ–‡ä»¶ç›®å½•å’Œcssæ–‡ä»¶ç›®å½•çš„ç»åº¦è·¯å¾„å¤„ç†</span></div><div class="line">args.source = args.source.split(<span class="string">"-compress-config-split-"</span>).map(<span class="function"><span class="params">item</span> =&gt;</span> path.join(args.currentDir, item));</div><div class="line">args.cssDir = args.cssDir.split(<span class="string">"-compress-config-split-"</span>).map(<span class="function"><span class="params">item</span> =&gt;</span> path.join(args.currentDir, item));</div><div class="line"></div><div class="line"><span class="comment">//tinypngçš„API Key</span></div><div class="line">tinify.key = args.key;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * å…¥å£å‡½æ•°</span></div><div class="line"><span class="comment"> * @param  options.source</span></div><div class="line"><span class="comment"> * @param  options.outputDir</span></div><div class="line"><span class="comment"> * @param  options.prefix</span></div><div class="line"><span class="comment"> * @param  options.injectCssUrl</span></div><div class="line"><span class="comment"> * @param  options.injectMaxSize</span></div><div class="line"><span class="comment"> * @param  options.cssDir</span></div><div class="line"><span class="comment"> * @param  options.currentDir</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params">&#123;</span></span></div><div class="line"><span class="function"><span class="params">    source,</span></span></div><div class="line"><span class="function"><span class="params">    outputDir,</span></span></div><div class="line"><span class="function"><span class="params">    prefix,</span></span></div><div class="line"><span class="function"><span class="params">    injectCssUrl,</span></span></div><div class="line"><span class="function"><span class="params">    injectMaxSize,</span></span></div><div class="line"><span class="function"><span class="params">    cssDir,</span></span></div><div class="line"><span class="function"><span class="params">    currentDir</span></span></div><div class="line"><span class="function"><span class="params">&#125;</span>) </span>&#123;</div><div class="line">    <span class="keyword">let</span> distPath = distDir(currentDir, outputDir),</div><div class="line">        filesList = [],</div><div class="line">        tmp = <span class="literal">null</span>,</div><div class="line">        basename;</div><div class="line"></div><div class="line">    mkdirp.sync(distPath);</div><div class="line"></div><div class="line">    <span class="comment">//å¼‚æ­¥ä¸Šä¼ , å¹¶ä¸”æ”¾åˆ°å…·ä½“çš„ç›®å½•</span></div><div class="line">    co(<span class="function"><span class="keyword">function</span>*(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">of</span> dirs) &#123;</div><div class="line">                tmp = <span class="keyword">yield</span> dir.promiseFiles(i);</div><div class="line">                filesList = [].concat.call(filesList, tmp.filter(<span class="function"><span class="params">file</span> =&gt;</span> isImageFile(file)));</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">for</span> (tmp <span class="keyword">of</span> filesList) &#123;</div><div class="line">                basename = path.basename(tmp);</div><div class="line">                <span class="keyword">const</span> res = <span class="keyword">yield</span> promiseifyToFile(</div><div class="line">                    tmp,</div><div class="line">                    path.join(distPath, basename)</div><div class="line">                );</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">init(args);</div></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œ, æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªå‘½ä»¤å°±å®ç°å¥½äº†, å¦‚æœæƒ³æµ‹è¯•, å¯ä»¥ç›´æ¥åœ¨<code>Sublime Text</code>æŒ‰ä¸‹<code>ctrl + &#39;</code>(æ•°å­—1å‰é¢é‚£ä¸ªé”®), ç„¶ååœ¨<code>console</code>ä¸­è¿è¡Œ<code>view.run_command(&quot;image_compress&quot;)</code>, <code>view.run_command</code>æ¥æ”¶çš„å‚æ•°å’Œæˆ‘ä»¬åœ¨<code>keyMap</code>æˆ–è€…<code>command</code>é‡Œé¢å®šä¹‰çš„ä¸€è‡´ã€‚</p><p>è‡³æ­¤, æˆ‘ä»¬æ’ä»¶çš„ç¬¬ä¸€ä¸ªåŠŸèƒ½å°±å®Œæˆäº†, åé¢è¿˜æœ‰ä¸¤ä¸ªéœ€è¦åš, ç›¸å¯¹ç®€å•, ä¸å†åšä»‹ç», ç”¨æ³•å’Œä»£ç è¯·ç§»æ­¥<a href="https://github.com/rwson/sublime-image-compressor" target="_blank" rel="external">GitHub</a>ã€‚</p><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>æˆ‘ä»¬å¯ä»¥ç”¨è¿™ç§æ¨¡å¼å¼€å‘å¾ˆå¤šæ’ä»¶, æ¯”å¦‚ä»£ç å‹ç¼©ç±»ã€ ä»£ç æ ¼å¼åŒ–ç±»ã€ ä»£ç è¯­æ³•æ£€æµ‹ç±»ç­‰ç­‰, å…³äºè¿™äº›, <a href="https://www.npmjs.com/" target="_blank" rel="external">npm</a>ä¸Šé¢æœ‰å¾ˆå¤šç°æˆçš„åŒ…, <code>NodeJs</code>ç«¯éœ€è¦åšçš„åªæœ‰å¤„ç†è¾“å…¥, å†è¿”å›ç»“æœå°±å¥½ã€‚</p><p>è¿™ç§æ¨¡å¼æ–¹ä¾¿äº†å¾ˆå¤šäººå»è‡ªå·±å¼€å‘æ’ä»¶, ä½†æ˜¯ä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹, é¦–å…ˆå¼€å‘çš„æ—¶å€™å¾ˆç—›è‹¦, ä¸æ˜“è°ƒè¯•, è€Œä¸”åœ¨ç”¨<code>Node</code>å’Œ<code>Python</code>é€šä¿¡çš„æ—¶å€™, æ•°æ®å¤šçš„æ—¶å€™å¯èƒ½ä¼šæœ‰äº›å»¶è¿Ÿç­‰ç­‰ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;a href=&quot;https://www.sublimetext.com/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Sublime Text&lt;/a&gt;è‘—æœ‰æœ€æ€§æ„Ÿçš„ç¼–è¾‘å™¨ä¹‹ç§°,å®ƒè½»é‡,æ˜“äºæ‹“å±•,é€šè¿‡æ’ä»¶çš„æ–¹å¼å¯ä½¿å®ƒå˜å¾—å¾ˆå¼ºå¤§,è€Œæˆ‘æ›´æ˜¯æŠŠå®ƒä½œä¸ºè‡ªå·±çš„ä¸»è¦ç¼–
      
    
    </summary>
    
      <category term="NodeJs" scheme="http://yoursite.com/categories/NodeJs/"/>
    
      <category term="Python" scheme="http://yoursite.com/categories/NodeJs/Python/"/>
    
    
  </entry>
  
  <entry>
    <title>webpackæºç é˜…è¯»</title>
    <link href="http://yoursite.com/2017/09/25/2017-09-25-read-webpack-source/"/>
    <id>http://yoursite.com/2017/09/25/2017-09-25-read-webpack-source/</id>
    <published>2017-09-24T16:00:00.000Z</published>
    <updated>2017-09-26T13:12:39.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨å‰ç«¯å·¥ç¨‹åŒ–è¶Šæ¥è¶Šæ™®åŠçš„ä»Šå¤©ï¼Œæˆ‘ä»¬å‡ ä¹æ¯ä¸ªé¡¹ç›®éƒ½éœ€è¦ç”¨åˆ°æ„å»ºå·¥å…·ï¼Œä»ä¸€å¼€å§‹çš„<code>grunt</code>ï¼Œåˆ°<code>gulp</code>ï¼Œå†åˆ°ç°åœ¨çš„<code>webpack</code>ã€‚<br>æˆ‘ä»¬åœ¨ä½¿ç”¨<code>webpack</code>æ—¶ï¼Œå¯ä»¥é€šè¿‡é…ç½®ä¸€äº›å‘½ä»¤è¡Œå‚æ•°æ¥è®©<code>webpack</code>å®Œæˆä¸€äº›ç¼–è¯‘æ‰“åŒ…çš„ä»»åŠ¡ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬æ‰§è¡Œ<code>webpack</code>è¿™ä¸ªå‘½ä»¤çš„æ—¶å€™ï¼Œ<code>webpack</code>ç©¶ç«Ÿåšäº†å“ªäº›äº‹æƒ…? æˆ‘ä»¬ä¸€èµ·æ¥è¯»è¯»<code>webpack</code>çš„ç›¸å…³æºç ã€‚</p><p>æ³¨ï¼šæœ¬æ–‡é˜…è¯»çš„ç‰ˆæœ¬ä¸º<a href="https://github.com/webpack/webpack/tree/webpack-1" target="_blank" rel="external">webpack1.15.0</a>ï¼Œä»å…¥å£å¼€å§‹åˆ†æå†æ‹¿åˆ°æˆ‘ä»¬çš„å‘½ä»¤ä¹‹åæ‰§è¡Œçš„çš„æµç¨‹ï¼Œæ‰€ä»¥æœ‰äº›ä¸ªäººè®¤ä¸ºä¸é‡è¦çš„å¯èƒ½ä¼šçœç•¥ã€‚</p><p>é€šè¿‡<code>package.json</code>ä¸­çš„<code>bin</code>çš„æŒ‡å‘å¯ä»¥çŸ¥é“é¦–å…ˆä¼šèµ°åˆ°<code>./bin/webpack.js</code>è¿™ä¸ªæ–‡ä»¶ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/usr/bin/env node</span></div><div class="line"></div><div class="line"><span class="comment">//å¼•å…¥nodejs pathæ¨¡å—</span></div><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</div><div class="line"></div><div class="line"><span class="comment">// require.resolveè·å–/bin/webpack.jsçš„ç»å¯¹è·¯å¾„(ä»é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„node_modulesé‡Œé¢æ‰¾)</span></div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line"><span class="keyword">var</span> localWebpack = <span class="built_in">require</span>.resolve(path.join(process.cwd(), <span class="string">"node_modules"</span>, <span class="string">"webpack"</span>, <span class="string">"bin"</span>, <span class="string">"webpack.js"</span>));</div><div class="line"><span class="keyword">if</span>(__filename !== localWebpack) &#123;</div><div class="line"><span class="keyword">return</span> <span class="built_in">require</span>(localWebpack);</div><div class="line">&#125;</div><div class="line">&#125; <span class="keyword">catch</span>(e) &#123;&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> optimist = <span class="built_in">require</span>(<span class="string">"optimist"</span>)</div><div class="line">.usage(<span class="string">"webpack "</span> + <span class="built_in">require</span>(<span class="string">"../package.json"</span>).version + <span class="string">"\n"</span> +</div><div class="line"><span class="string">"Usage: https://webpack.github.io/docs/cli.html"</span>);</div><div class="line"></div><div class="line"><span class="built_in">require</span>(<span class="string">"./config-optimist"</span>)(optimist);</div><div class="line"></div><div class="line"><span class="comment">//å¯¹åœ¨å‘½ä»¤è¡Œä¼ å…¥çš„å‚æ•°è¿›è¡Œè§£æ</span></div><div class="line"><span class="comment">//--colorsã€--jsonã€ ...</span></div><div class="line">optimist</div><div class="line">.boolean(<span class="string">"json"</span>).alias(<span class="string">"json"</span>, <span class="string">"j"</span>).describe(<span class="string">"json"</span>)</div><div class="line">.boolean(<span class="string">"colors"</span>).alias(<span class="string">"colors"</span>, <span class="string">"c"</span>).describe(<span class="string">"colors"</span>)</div><div class="line"><span class="comment">//å…¶ä»–å‚æ•°è§£æ, ç•¥;</span></div><div class="line"></div><div class="line"><span class="comment">//è·å–è§£æåçš„å‚æ•°å¹¶è½¬æ¢æ ¼å¼</span></div><div class="line"><span class="keyword">var</span> argv = optimist.argv;</div><div class="line"><span class="keyword">var</span> options = <span class="built_in">require</span>(<span class="string">"./convert-argv"</span>)(optimist, argv);</div><div class="line"></div><div class="line"><span class="comment">//å¦‚æœæœ‰ç¬¦åˆargvé‡Œé¢çš„å‚æ•°</span></div><div class="line"><span class="comment">//å°±æ‰§è¡Œç›¸å…³çš„å›è°ƒå‡½æ•°</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">ifArg</span>(<span class="params">name, fn, init</span>) </span>&#123;</div><div class="line"><span class="keyword">if</span>(<span class="built_in">Array</span>.isArray(argv[name])) &#123;</div><div class="line"><span class="keyword">if</span>(init) init();</div><div class="line">argv[name].forEach(fn);</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">typeof</span> argv[name] !== <span class="string">"undefined"</span>) &#123;</div><div class="line"><span class="keyword">if</span>(init) init();</div><div class="line">fn(argv[name], <span class="number">-1</span>);</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> *  å¤„ç†è¾“å‡ºç›¸å…³ï¼ˆoutputï¼‰çš„é…ç½®å‚æ•°ï¼Œå¹¶æ‰§è¡Œç¼–è¯‘å‡½æ•°</span></div><div class="line"><span class="comment"> *  @param   &#123;[type]&#125;  options  [description]</span></div><div class="line"><span class="comment"> *  @return  &#123;[type]&#125;           [description]</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">processOptions</span>(<span class="params">options</span>) </span>&#123;</div><div class="line"><span class="comment">//å¦‚æœoptionsä¸‹é¢çš„thenæ˜¯ä¸ªå‡½æ•°(optionsæ˜¯ä¸ªPromiseç¤ºä¾‹)</span></div><div class="line"><span class="comment">//æŠŠprocessOptionsä½œä¸ºå‚æ•°ä¼ åˆ°options.thenä¸­</span></div><div class="line"><span class="comment">//å¹¶ä¸”ä¸­æ–­ä¸‹é¢ä»£ç çš„æ‰§è¡Œ</span></div><div class="line"><span class="keyword">if</span>(<span class="keyword">typeof</span> options.then === <span class="string">"function"</span>) &#123;</div><div class="line">options.then(processOptions).catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line"><span class="built_in">console</span>.error(err.stack || err);</div><div class="line">process.exit();</div><div class="line">&#125;);</div><div class="line"><span class="keyword">return</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//å¦‚æœä¼ å…¥çš„optionsæ˜¯ä¸€ä¸ªæ•°ç»„, å–æ•°ç»„çš„ç¬¬ä¸€é¡¹</span></div><div class="line"><span class="keyword">var</span> firstOptions = <span class="built_in">Array</span>.isArray(options) ? options[<span class="number">0</span>] : options;</div><div class="line"></div><div class="line"><span class="comment">//è¾“å‡ºçš„é…ç½®</span></div><div class="line"><span class="keyword">var</span> outputOptions = <span class="built_in">Object</span>.create(options.stats || firstOptions.stats || &#123;&#125;);</div><div class="line"></div><div class="line"><span class="comment">//å¦‚æœoutputOptionsä¸­æœ¬èº«æ²¡æœ‰context</span></div><div class="line"><span class="comment">//å°±æŠŠé…ç½®é¡¹ä¸­çš„contextç»™å®ƒ</span></div><div class="line"><span class="keyword">if</span>(<span class="keyword">typeof</span> outputOptions.context === <span class="string">"undefined"</span>)</div><div class="line">outputOptions.context = firstOptions.context;</div><div class="line"></div><div class="line"><span class="comment">//å„ç§å‘½ä»¤è¡Œå‚æ•°å¤„ç†</span></div><div class="line">ifArg(<span class="string">"json"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">bool</span>) </span>&#123;</div><div class="line"><span class="keyword">if</span>(bool)</div><div class="line">outputOptions.json = bool;</div><div class="line">&#125;);</div><div class="line"><span class="comment">//è¿˜æœ‰å¾ˆå¤šifArgï¼Œç•¥</span></div><div class="line"></div><div class="line"><span class="comment">//å¼•å…¥webpackå…¥å£æ–‡ä»¶</span></div><div class="line"><span class="keyword">var</span> webpack = <span class="built_in">require</span>(<span class="string">"../lib/webpack.js"</span>);</div><div class="line"></div><div class="line"><span class="comment">//é”™è¯¯å †æ ˆè¿½è¸ªä¸Šé™</span></div><div class="line"><span class="built_in">Error</span>.stackTraceLimit = <span class="number">30</span>;</div><div class="line"><span class="keyword">var</span> lastHash = <span class="literal">null</span>;</div><div class="line"></div><div class="line"><span class="comment">//æ‰§è¡Œç¼–è¯‘</span></div><div class="line"><span class="keyword">var</span> compiler = webpack(options);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">compilerCallback</span>(<span class="params">err, stats</span>) </span>&#123;</div><div class="line">      <span class="comment">//å‘½ä»¤è¡Œå‚æ•°ä¸­æ²¡æœ‰å¸¦æœ‰--watch</span></div><div class="line"><span class="keyword">if</span>(!options.watch) &#123;</div><div class="line">compiler.purgeInputFileSystem();</div><div class="line">&#125;</div><div class="line">      </div><div class="line">      <span class="comment">//å‡ºé”™</span></div><div class="line"><span class="keyword">if</span>(err) &#123;</div><div class="line">lastHash = <span class="literal">null</span>;</div><div class="line"><span class="built_in">console</span>.error(err.stack || err);</div><div class="line"><span class="keyword">if</span>(err.details) <span class="built_in">console</span>.error(err.details);</div><div class="line"><span class="keyword">if</span>(!options.watch) &#123;</div><div class="line">process.on(<span class="string">"exit"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">process.exit(<span class="number">1</span>);</div><div class="line">&#125;);</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(outputOptions.json) &#123;</div><div class="line">process.stdout.write(<span class="built_in">JSON</span>.stringify(stats.toJson(outputOptions), <span class="literal">null</span>, <span class="number">2</span>) + <span class="string">"\n"</span>);</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(stats.hash !== lastHash) &#123;</div><div class="line">lastHash = stats.hash;</div><div class="line">process.stdout.write(stats.toString(outputOptions) + <span class="string">"\n"</span>);</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">  </div><div class="line"><span class="comment">//å‘½ä»¤è¡Œå‚æ•°ä¸­å¸¦æœ‰--watch</span></div><div class="line"><span class="keyword">if</span>(options.watch) &#123;</div><div class="line"><span class="keyword">var</span> primaryOptions = !<span class="built_in">Array</span>.isArray(options) ? options : options[<span class="number">0</span>];</div><div class="line"><span class="keyword">var</span> watchOptions = primaryOptions.watchOptions || primaryOptions.watch || &#123;&#125;;</div><div class="line"><span class="keyword">if</span>(watchOptions.stdin) &#123;</div><div class="line">process.stdin.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">process.exit(<span class="number">0</span>); <span class="comment">// eslint-disable-line</span></div><div class="line">&#125;);</div><div class="line">process.stdin.resume();</div><div class="line">&#125;</div><div class="line">      </div><div class="line">      <span class="comment">//è°ƒç”¨compilerä¸‹é¢çš„watchæ¥ç›‘å¬æ–‡ä»¶å˜åŒ–</span></div><div class="line">compiler.watch(watchOptions, compilerCallback);</div><div class="line">&#125; <span class="keyword">else</span></div><div class="line">compiler.run(compilerCallback);</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//æ‰§è¡ŒprocessOptionså¹¶ä¸”ä¼ å…¥è§£æå‡ºæ¥çš„å‚æ•°</span></div><div class="line">processOptions(options);</div></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢å®šä¹‰çš„<code>processOptions</code>æ–¹æ³•ä¸­å¯ä»¥çœ‹åˆ°å¼•å…¥äº†<code>../lib/webpack.js</code>è¿™ä¸ªæ–‡ä»¶ï¼Œä¸‹é¢æˆ‘ä»¬ä¸€èµ·çœ‹çœ‹<code>../lib/webpack.js</code>è¿™ä¸ªæ–‡ä»¶ã€‚</p><p>åœ¨<code>../lib/webpack.js</code>ä¸­ï¼Œ<code>webpack</code>ä½œä¸ºå…¥å£å‡½æ•°ï¼Œæˆ‘ä»¬ä¸€èµ·çœ‹ä¸‹å®ƒçš„å®ç°ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> *  webpackå…¥å£</span></div><div class="line"><span class="comment"> *  @param   &#123;Object&#125;    options   webpack.config.jsä¸­module.exportså‡ºæ¥çš„å¯¹è±¡</span></div><div class="line"><span class="comment"> *  @param   &#123;Function&#125;  callback  å›è°ƒå‡½æ•°</span></div><div class="line"><span class="comment"> *  @return  &#123;Object&#125;              webpack Compiler Object/multi compiler object Collection</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">webpack</span>(<span class="params">options, callback</span>) </span>&#123;</div><div class="line"><span class="keyword">var</span> compiler;</div><div class="line"><span class="comment">//optionsæ˜¯ä¸€ä¸ªæ•°ç»„æ—¶, å®ä¾‹åŒ–ä¸€ä¸ªMultiCompiler, å»mapè¿™ä¸ªæ•°ç»„, é’ˆå¯¹æ¯ä¸ªé…ç½®é¡¹è¿”å›ä¸€ä¸ªwebpackå®ä¾‹, æœ€åç”¨compileræ¥æ”¶</span></div><div class="line"><span class="keyword">if</span>(<span class="built_in">Array</span>.isArray(options)) &#123;</div><div class="line">compiler = <span class="keyword">new</span> MultiCompiler(options.map(<span class="function"><span class="keyword">function</span>(<span class="params">options</span>) </span>&#123;</div><div class="line"><span class="keyword">return</span> webpack(options);</div><div class="line">&#125;));</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">typeof</span> options === <span class="string">"object"</span>) &#123;</div><div class="line"></div><div class="line"><span class="comment">// å®ä¾‹åŒ–ä¸€ä¸ªWebpackOptionsDefaulteræ¥å¤„ç†é»˜è®¤é…ç½®é¡¹</span></div><div class="line"><span class="keyword">new</span> WebpackOptionsDefaulter().process(options);</div><div class="line"></div><div class="line"><span class="comment">//å®ä¾‹åŒ–ä¸€ä¸ªCompiler, Compilerç»§æ‰¿è‡ªTapable(https://doc.webpack-china.org/api/plugins/tapable/)</span></div><div class="line"><span class="comment">//Compilerå®ä¾‹åŒ–åä¼šç»§æ‰¿åˆ°applyã€pluginç­‰è°ƒç”¨å’Œç»‘å®šæ’ä»¶çš„æ–¹æ³•</span></div><div class="line">compiler = <span class="keyword">new</span> Compiler();</div><div class="line"></div><div class="line"><span class="comment">//é…ç½®é¡¹</span></div><div class="line">compiler.options = options;</div><div class="line"></div><div class="line"><span class="comment">//å¯¹ä¼ å…¥çš„optionsè¿›è¡Œé€ä¸ªç¼–è¯‘,å¹¶ä¸”æŠŠoptionsä½œä¸ºè¿”å›å€¼é‡èµ‹å€¼åˆ°compiler.options</span></div><div class="line">compiler.options = <span class="keyword">new</span> WebpackOptionsApply().process(options, compiler);</div><div class="line"></div><div class="line"><span class="comment">//åº”ç”¨nodeç¯å¢ƒæ’ä»¶(ç»™compilerè®¾ç½®resolversã€watchFileSystemã€outputFileSystem)</span></div><div class="line"><span class="keyword">new</span> NodeEnvironmentPlugin().apply(compiler);</div><div class="line"></div><div class="line"><span class="comment">//è§¦å‘environmentå’Œafter-environmentäº‹ä»¶</span></div><div class="line">compiler.applyPlugins(<span class="string">"environment"</span>);</div><div class="line">compiler.applyPlugins(<span class="string">"after-environment"</span>);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="comment">//optionsæ—¢ä¸æ˜¯æ•°ç»„ä¹Ÿä¸æ˜¯å¯¹è±¡æ—¶, æŠ›å‡ºå¼‚å¸¸</span></div><div class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Invalid argument: options"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//å­˜åœ¨å›è°ƒå‡½æ•°</span></div><div class="line"><span class="keyword">if</span>(callback) &#123;</div><div class="line"><span class="keyword">if</span>(<span class="keyword">typeof</span> callback !== <span class="string">"function"</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Invalid argument: callback"</span>);</div><div class="line"></div><div class="line"><span class="comment">//å‘½ä»¤è¡Œé‡Œé¢å¸¦watch, æˆ–è€…optionsæ˜¯ä¸ªæ•°ç»„(å¹¶ä¸”æ•°ç»„ä¸­æœ‰ä¸€é¡¹çš„watchä¸ºtrue)</span></div><div class="line"><span class="keyword">if</span>(options.watch === <span class="literal">true</span> || (<span class="built_in">Array</span>.isArray(options) &amp;&amp;</div><div class="line">options.some(<span class="function"><span class="keyword">function</span>(<span class="params">o</span>) </span>&#123;</div><div class="line"><span class="keyword">return</span> o.watch;</div><div class="line">&#125;))) &#123;</div><div class="line"></div><div class="line"><span class="comment">//æ ¹æ®å‚æ•°ç±»å‹æ‹¿åˆ°watchOptions</span></div><div class="line"><span class="keyword">var</span> watchOptions = (!<span class="built_in">Array</span>.isArray(options) ? options : options[<span class="number">0</span>]).watchOptions || &#123;&#125;;</div><div class="line"></div><div class="line"><span class="comment">//watchDelayå±æ€§åº”è¯¥è¢«options.watchOptions.aggregateTimeoutä»£æ›¿</span></div><div class="line"><span class="keyword">var</span> watchDelay = (!<span class="built_in">Array</span>.isArray(options) ? options : options[<span class="number">0</span>]).watchDelay;</div><div class="line"><span class="keyword">if</span>(watchDelay) &#123;</div><div class="line"><span class="built_in">console</span>.warn(<span class="string">"options.watchDelay is deprecated: Use 'options.watchOptions.aggregateTimeout' instead"</span>);</div><div class="line">watchOptions.aggregateTimeout = watchDelay;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//å®ä¾‹åŒ–å¹¶è¿”å›ä¸€ä¸ªwatchå¯¹è±¡</span></div><div class="line"><span class="keyword">return</span> compiler.watch(watchOptions, callback);</div><div class="line">&#125;</div><div class="line">compiler.run(callback);</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> compiler;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> *  åœ¨å¯¹è±¡ä¸‹ç”¨Object.definePropertyçš„æ–¹æ³•æ·»åŠ æ’ä»¶</span></div><div class="line"><span class="comment"> *  @param   &#123;Object&#125;  exports  è¢«æ·»åŠ çš„å¯¹è±¡</span></div><div class="line"><span class="comment"> *  @param   &#123;String&#125;  path     åœ¨getä¸­è¿”å›require</span></div><div class="line"><span class="comment"> *  @param   &#123;Array&#125;   plugins  æ’ä»¶æ•°ç»„</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">exportPlugins</span>(<span class="params">exports, path, plugins</span>) </span>&#123;</div><div class="line">plugins.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">name</span>) </span>&#123;</div><div class="line"><span class="built_in">Object</span>.defineProperty(exports, name, &#123;</div><div class="line">configurable: <span class="literal">false</span>,</div><div class="line">enumerable: <span class="literal">true</span>,</div><div class="line">get: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line"><span class="keyword">return</span> <span class="built_in">require</span>(path + <span class="string">"/"</span> + name);</div><div class="line">&#125;</div><div class="line">&#125;);</div><div class="line">&#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªæ–‡ä»¶æœ€åï¼Œé€šè¿‡ä¸Šé¢çš„<code>exportPlugins</code>åœ¨<code>webpack</code>ä¸‹é¢æŒ‚è½½äº†ä¸€äº›æ’ä»¶åšå±æ€§</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//æš´éœ²æ’ä»¶åˆ°webpackä¸‹é¢</span></div><div class="line"><span class="comment">//new webpack.DefinePlugin()</span></div><div class="line"><span class="comment">//...</span></div><div class="line">exportPlugins(exports, <span class="string">"."</span>, [</div><div class="line"><span class="string">"DefinePlugin"</span>,</div><div class="line"><span class="comment">//...</span></div><div class="line">]);</div><div class="line">exportPlugins(exports.optimize = &#123;&#125;, <span class="string">"./optimize"</span>, [</div><div class="line"><span class="string">"AggressiveMergingPlugin"</span>,</div><div class="line"><span class="string">"CommonsChunkPlugin"</span>,</div><div class="line"><span class="string">"DedupePlugin"</span>,</div><div class="line"><span class="string">"LimitChunkCountPlugin"</span>,</div><div class="line"><span class="string">"MinChunkSizePlugin"</span>,</div><div class="line"><span class="string">"OccurenceOrderPlugin"</span>,</div><div class="line"><span class="string">"OccurrenceOrderPlugin"</span>,</div><div class="line"><span class="string">"UglifyJsPlugin"</span></div><div class="line">]);</div><div class="line">exportPlugins(exports.dependencies = &#123;&#125;, <span class="string">"./dependencies"</span>, [</div><div class="line"><span class="string">"LabeledModulesPlugin"</span></div><div class="line">]);</div></pre></td></tr></table></figure><p>åˆšæ‰åœ¨å¯¹<code>webpack</code>è¿›è¡Œæ ‡æ³¨çš„æ—¶å€™ï¼Œå®ä¾‹åŒ–äº†<code>WebpackOptionsApply</code>å¯¹è±¡å¹¶ä¸”è°ƒç”¨äº†<code>process</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°†ä¼šå¯¹æˆ‘ä»¬ä¼ è¿›å»çš„<code>options</code>å’Œ<code>compiler</code>ç¼–è¯‘å¯¹è±¡è¿›è¡Œé€ä¸ªç¼–è¯‘ï¼Œä¸‹é¢æˆ‘ä»¬ä¸€èµ·çœ‹ä¸‹<code>WebpackOptionsApply</code>è¿™ä¸ªæ¨¡å—çš„å®ç°ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">WebpackOptionsApply</span>(<span class="params"></span>) </span>&#123;</div><div class="line"><span class="comment">//OptionsApplyæ„é€ å‡½æ•°çš„ç»§æ‰¿</span></div><div class="line">OptionsApply.call(<span class="keyword">this</span>);</div><div class="line">&#125;</div><div class="line"><span class="built_in">module</span>.exports = WebpackOptionsApply;</div><div class="line"></div><div class="line"><span class="comment">//ç»§æ‰¿OptionsApplyçš„åŸå‹</span></div><div class="line">WebpackOptionsApply.prototype = <span class="built_in">Object</span>.create(OptionsApply.prototype);</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> *  å¯¹æˆ‘ä»¬ä¼ è¿›å»çš„optionså’Œcompilerç¼–è¯‘å¯¹è±¡è¿›è¡Œé€ä¸ªç¼–è¯‘</span></div><div class="line"><span class="comment"> *  @param   &#123;[type]&#125;  options   [description]</span></div><div class="line"><span class="comment"> *  @param   &#123;[type]&#125;  compiler  [description]</span></div><div class="line"><span class="comment"> *  @return  &#123;[type]&#125;            [description]</span></div><div class="line"><span class="comment"> */</span></div><div class="line">WebpackOptionsApply.prototype.process = <span class="function"><span class="keyword">function</span>(<span class="params">options, compiler</span>) </span>&#123;</div><div class="line"><span class="comment">//contextå¤„ç†</span></div><div class="line">compiler.context = options.context;</div><div class="line"></div><div class="line"><span class="comment">//pluginsçš„å¤„ç†, è°ƒç”¨compiler.apply.apply</span></div><div class="line"><span class="keyword">if</span>(options.plugins &amp;&amp; <span class="built_in">Array</span>.isArray(options.plugins)) &#123;</div><div class="line">compiler.apply.apply(compiler, options.plugins);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//ç¼“å­˜è¾“å…¥è¾“å‡ºçš„è·¯å¾„</span></div><div class="line">compiler.outputPath = options.output.path;</div><div class="line">compiler.recordsInputPath = options.recordsInputPath || options.recordsPath;</div><div class="line">compiler.recordsOutputPath = options.recordsOutputPath || options.recordsPath;</div><div class="line">compiler.name = options.name;</div><div class="line"></div><div class="line"><span class="comment">//å¦‚æœoptions.targetæ˜¯ä¸ªå­—ç¬¦ä¸²,æ ¹æ®options.targetåˆ¤æ–­å…·ä½“åº”ç”¨å“ªäº›æ’ä»¶(compiler.apply)</span></div><div class="line"><span class="keyword">if</span>(<span class="keyword">typeof</span> options.target === <span class="string">"string"</span>) &#123;</div><div class="line"><span class="comment">//è¿™è¾¹æœ¬æ¥æœ‰ä¸ªswitch...caseæ¥æ ¹æ®options.targetçš„å…·ä½“å€¼åº”ç”¨</span></div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(options.target !== <span class="literal">false</span>) &#123;</div><div class="line">options.target(compiler);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Unsupported target '"</span> + options.target + <span class="string">"'."</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//output.libraryç›¸å…³é…ç½®</span></div><div class="line"><span class="keyword">if</span>(options.output.library || options.output.libraryTarget !== <span class="string">"var"</span>) &#123;</div><div class="line"><span class="keyword">var</span> LibraryTemplatePlugin = <span class="built_in">require</span>(<span class="string">"./LibraryTemplatePlugin"</span>);</div><div class="line">compiler.apply(<span class="keyword">new</span> LibraryTemplatePlugin(options.output.library, options.output.libraryTarget, options.output.umdNamedDefine));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//å¤„ç†externalså±æ€§,å‘Šè¯‰webpackä¸è¦æ‰“åŒ…è¿™äº›æ¨¡å—,è€Œæ˜¯åœ¨è¿è¡Œæ—¶ä»ç¯å¢ƒä¸­è¯·æ±‚ä»–ä»¬</span></div><div class="line"><span class="keyword">if</span>(options.externals) &#123;</div><div class="line"><span class="keyword">var</span> ExternalsPlugin = <span class="built_in">require</span>(<span class="string">"./ExternalsPlugin"</span>);</div><div class="line">compiler.apply(<span class="keyword">new</span> ExternalsPlugin(options.output.libraryTarget, options.externals));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//å¤„ç†hotå±æ€§,devServerç›¸å…³</span></div><div class="line"><span class="keyword">if</span>(options.hot) &#123;</div><div class="line">compiler.apply(<span class="keyword">new</span> MovedToPluginWarningPlugin(<span class="string">"hot"</span>, <span class="string">"HotModuleReplacementPlugin"</span>));</div><div class="line"><span class="keyword">var</span> HotModuleReplacementPlugin = <span class="built_in">require</span>(<span class="string">"./HotModuleReplacementPlugin"</span>);</div><div class="line">compiler.apply(<span class="keyword">new</span> HotModuleReplacementPlugin(options.output));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//devtoolå’ŒsourceMapç›¸å…³é…ç½®</span></div><div class="line"><span class="keyword">if</span>(options.devtool &amp;&amp; (options.devtool.indexOf(<span class="string">"sourcemap"</span>) &gt;= <span class="number">0</span> || options.devtool.indexOf(<span class="string">"source-map"</span>) &gt;= <span class="number">0</span>)) &#123;</div><div class="line"><span class="keyword">var</span> hidden = options.devtool.indexOf(<span class="string">"hidden"</span>) &gt;= <span class="number">0</span>;</div><div class="line"><span class="keyword">var</span> inline = options.devtool.indexOf(<span class="string">"inline"</span>) &gt;= <span class="number">0</span>;</div><div class="line"><span class="keyword">var</span> evalWrapped = options.devtool.indexOf(<span class="string">"eval"</span>) &gt;= <span class="number">0</span>;</div><div class="line"><span class="keyword">var</span> cheap = options.devtool.indexOf(<span class="string">"cheap"</span>) &gt;= <span class="number">0</span>;</div><div class="line"><span class="keyword">var</span> moduleMaps = options.devtool.indexOf(<span class="string">"module"</span>) &gt;= <span class="number">0</span>;</div><div class="line"><span class="keyword">var</span> noSources = options.devtool.indexOf(<span class="string">"nosources"</span>) &gt;= <span class="number">0</span>;</div><div class="line"><span class="keyword">var</span> legacy = options.devtool.indexOf(<span class="string">"@"</span>) &gt;= <span class="number">0</span>;</div><div class="line"><span class="keyword">var</span> modern = options.devtool.indexOf(<span class="string">"#"</span>) &gt;= <span class="number">0</span>;</div><div class="line"><span class="keyword">var</span> comment = legacy &amp;&amp; modern ? <span class="string">"\n/*\n//@ sourceMappingURL=[url]\n//# sourceMappingURL=[url]\n*/"</span> :</div><div class="line">legacy ? <span class="string">"\n/*\n//@ sourceMappingURL=[url]\n*/"</span> :</div><div class="line">modern ? <span class="string">"\n//# sourceMappingURL=[url]"</span> :</div><div class="line"><span class="literal">null</span>;</div><div class="line"><span class="keyword">var</span> Plugin = evalWrapped ? EvalSourceMapDevToolPlugin : SourceMapDevToolPlugin;</div><div class="line">compiler.apply(<span class="keyword">new</span> Plugin(&#123;</div><div class="line">filename: inline ? <span class="literal">null</span> : options.output.sourceMapFilename,</div><div class="line">moduleFilenameTemplate: options.output.devtoolModuleFilenameTemplate,</div><div class="line">fallbackModuleFilenameTemplate: options.output.devtoolFallbackModuleFilenameTemplate,</div><div class="line">append: hidden ? <span class="literal">false</span> : comment,</div><div class="line"><span class="built_in">module</span>: moduleMaps ? <span class="literal">true</span> : cheap ? <span class="literal">false</span> : <span class="literal">true</span>,</div><div class="line">columns: cheap ? <span class="literal">false</span> : <span class="literal">true</span>,</div><div class="line">lineToLine: options.output.devtoolLineToLine,</div><div class="line">noSources: noSources,</div><div class="line">&#125;));</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(options.devtool &amp;&amp; options.devtool.indexOf(<span class="string">"eval"</span>) &gt;= <span class="number">0</span>) &#123;</div><div class="line"><span class="keyword">var</span> legacy = options.devtool.indexOf(<span class="string">"@"</span>) &gt;= <span class="number">0</span>;</div><div class="line"><span class="keyword">var</span> modern = options.devtool.indexOf(<span class="string">"#"</span>) &gt;= <span class="number">0</span>;</div><div class="line"><span class="keyword">var</span> comment = legacy &amp;&amp; modern ? <span class="string">"//@ sourceURL=[url]\n//# sourceURL=[url]"</span> :</div><div class="line">legacy ? <span class="string">"//@ sourceURL=[url]"</span> :</div><div class="line">modern ? <span class="string">"//# sourceURL=[url]"</span> :</div><div class="line"><span class="literal">null</span>;</div><div class="line">compiler.apply(<span class="keyword">new</span> EvalDevToolModulePlugin(comment, options.output.devtoolModuleFilenameTemplate));</div><div class="line">&#125;</div><div class="line"></div><div class="line">compiler.apply(<span class="keyword">new</span> EntryOptionPlugin());</div><div class="line">compiler.applyPluginsBailResult(<span class="string">"entry-option"</span>, options.context, options.entry);</div><div class="line"></div><div class="line"><span class="keyword">if</span>(options.prefetch) &#123;</div><div class="line">compiler.apply(<span class="keyword">new</span> MovedToPluginWarningPlugin(<span class="string">"prefetch"</span>, <span class="string">"PrefetchPlugin"</span>));</div><div class="line"><span class="keyword">var</span> PrefetchPlugin = <span class="built_in">require</span>(<span class="string">"./PrefetchPlugin"</span>);</div><div class="line">options.prefetch.map(<span class="function"><span class="keyword">function</span>(<span class="params">request</span>) </span>&#123;</div><div class="line">compiler.apply(<span class="keyword">new</span> PrefetchPlugin(options.context, request));</div><div class="line">&#125;);</div><div class="line">&#125;</div><div class="line">compiler.apply(</div><div class="line"><span class="keyword">new</span> CompatibilityPlugin(),</div><div class="line"><span class="keyword">new</span> LoaderPlugin(),<span class="comment">//loaderæ’ä»¶</span></div><div class="line"><span class="keyword">new</span> NodeStuffPlugin(options.node),<span class="comment">//nodejsç¯å¢ƒç›¸å…³çš„æ’ä»¶</span></div><div class="line"><span class="keyword">new</span> RequireJsStuffPlugin(),<span class="comment">//RequireJsçš„æ’ä»¶</span></div><div class="line"><span class="keyword">new</span> APIPlugin(),<span class="comment">//å˜é‡åçš„æ›¿æ¢,ç¼–è¯‘åçš„æ–‡ä»¶é‡Œéšå¤„å¯è§çš„__webpack_require__å˜é‡åå°±æ˜¯åœ¨æ­¤å¤„ç†</span></div><div class="line"><span class="keyword">new</span> ConstPlugin(),<span class="comment">//è½¬æ¢ä¸€äº›if, ä¸‰ç›®è¡¨è¾¾å¼ç­‰ç­‰</span></div><div class="line"><span class="keyword">new</span> RequireIncludePlugin(),<span class="comment">//require.includeå‡½æ•°çš„è½¬æ¢</span></div><div class="line"><span class="keyword">new</span> RequireEnsurePlugin(),<span class="comment">//require.ensureå‡½æ•°çš„è½¬æ¢</span></div><div class="line"><span class="keyword">new</span> RequireContextPlugin(options.resolve.modulesDirectories, options.resolve.extensions),</div><div class="line"><span class="comment">//</span></div><div class="line"><span class="keyword">new</span> AMDPlugin(options.module, options.amd || &#123;&#125;),</div><div class="line"><span class="comment">//AMDè§„èŒƒæ’ä»¶</span></div><div class="line"><span class="keyword">new</span> CommonJsPlugin(options.module)<span class="comment">//commonJsè§„èŒƒæ’ä»¶</span></div><div class="line">);</div><div class="line"></div><div class="line">compiler.apply(</div><div class="line"><span class="keyword">new</span> RemoveParentModulesPlugin(),<span class="comment">//ç§»é™¤çˆ¶moduleçš„æ’ä»¶</span></div><div class="line"><span class="keyword">new</span> RemoveEmptyChunksPlugin(),<span class="comment">//ç§»é™¤ç©ºæ¨¡å—çš„æ’ä»¶</span></div><div class="line"><span class="keyword">new</span> MergeDuplicateChunksPlugin(),<span class="comment">//ç§»é™¤é‡å¤æ¨¡å—çš„æ’ä»¶</span></div><div class="line"><span class="keyword">new</span> FlagIncludedChunksPlugin()<span class="comment">//outputä¸­å¯¹äºåç§°çš„é…ç½®([name].[hash].[ext])</span></div><div class="line">);</div><div class="line"></div><div class="line">compiler.apply(<span class="keyword">new</span> TemplatedPathPlugin());</div><div class="line"></div><div class="line">compiler.apply(<span class="keyword">new</span> RecordIdsPlugin());<span class="comment">//è®°å½•chunkIdçš„æ’ä»¶</span></div><div class="line"></div><div class="line">compiler.apply(<span class="keyword">new</span> WarnCaseSensitiveModulesPlugin());</div><div class="line"><span class="comment">//å¤§å°å†™æ•æ„Ÿçš„æ’ä»¶</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * webpack.optimizeå±æ€§ä¸‹çš„å‡ ä¸ªæ–¹æ³•</span></div><div class="line"><span class="comment"> * ./webpack.js</span></div><div class="line"><span class="comment"> * exportPlugins(exports.optimize = &#123;&#125;, "./optimize", [</span></div><div class="line"><span class="comment"> * "AggressiveMergingPlugin"</span></div><div class="line"><span class="comment"> * //...</span></div><div class="line"><span class="comment"> * ]);</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">if</span>(options.optimize &amp;&amp; options.optimize.occurenceOrder) &#123;</div><div class="line">compiler.apply(<span class="keyword">new</span> MovedToPluginWarningPlugin(<span class="string">"optimize.occurenceOrder"</span>, <span class="string">"optimize.OccurrenceOrderPlugin"</span>));</div><div class="line"><span class="keyword">var</span> OccurrenceOrderPlugin = <span class="built_in">require</span>(<span class="string">"./optimize/OccurrenceOrderPlugin"</span>);</div><div class="line">compiler.apply(<span class="keyword">new</span> OccurrenceOrderPlugin(options.optimize.occurenceOrderPreferEntry));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * å¤„ç†minChunkSize, æ€§èƒ½ä¼˜åŒ–ç›¸å…³</span></div><div class="line"><span class="comment"> * ä¸€äº›å°æ¨¡å—ä¼šè¢«æ‰“åŒ…æˆå•ç‹¬çš„æ¨¡å—è€Œé€ æˆä¸å¿…è¦çš„HTTPè¯·æ±‚, æŒ‡å®šminChunkSizeä¼šåˆå¹¶è¿™äº›å°æ¨¡å—, å‡å°‘HTTPè¯·æ±‚</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">if</span>(options.optimize &amp;&amp; options.optimize.minChunkSize) &#123;</div><div class="line">compiler.apply(<span class="keyword">new</span> MovedToPluginWarningPlugin(<span class="string">"optimize.minChunkSize"</span>, <span class="string">"optimize.MinChunkSizePlugin"</span>));</div><div class="line"><span class="keyword">var</span> MinChunkSizePlugin = <span class="built_in">require</span>(<span class="string">"./optimize/MinChunkSizePlugin"</span>);</div><div class="line">compiler.apply(<span class="keyword">new</span> MinChunkSizePlugin(options.optimize));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//å’ŒmaxChunksSizeç›¸å</span></div><div class="line"><span class="keyword">if</span>(options.optimize &amp;&amp; options.optimize.maxChunks) &#123;</div><div class="line">compiler.apply(<span class="keyword">new</span> MovedToPluginWarningPlugin(<span class="string">"optimize.maxChunks"</span>, <span class="string">"optimize.LimitChunkCountPlugin"</span>));</div><div class="line"><span class="keyword">var</span> LimitChunkCountPlugin = <span class="built_in">require</span>(<span class="string">"./optimize/LimitChunkCountPlugin"</span>);</div><div class="line">compiler.apply(<span class="keyword">new</span> LimitChunkCountPlugin(options.optimize));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span>(options.optimize.minimize) &#123;</div><div class="line">compiler.apply(<span class="keyword">new</span> MovedToPluginWarningPlugin(<span class="string">"optimize.minimize"</span>, <span class="string">"optimize.UglifyJsPlugin"</span>));</div><div class="line"><span class="keyword">var</span> UglifyJsPlugin = <span class="built_in">require</span>(<span class="string">"./optimize/UglifyJsPlugin"</span>);</div><div class="line"><span class="keyword">if</span>(options.optimize.minimize === <span class="literal">true</span>)</div><div class="line">compiler.apply(<span class="keyword">new</span> UglifyJsPlugin());</div><div class="line"><span class="keyword">else</span></div><div class="line">compiler.apply(<span class="keyword">new</span> UglifyJsPlugin(options.optimize.minimize));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//ç¼“å­˜,è¯¥å±æ€§åœ¨watchçš„æ¨¡å¼ä¸‹é»˜è®¤å¼€å¯ç¼“å­˜</span></div><div class="line"><span class="keyword">if</span>(options.cache === <span class="literal">undefined</span> ? options.watch : options.cache) &#123;</div><div class="line"><span class="keyword">var</span> CachePlugin = <span class="built_in">require</span>(<span class="string">"./CachePlugin"</span>);</div><div class="line">compiler.apply(<span class="keyword">new</span> CachePlugin(<span class="keyword">typeof</span> options.cache === <span class="string">"object"</span> ? options.cache : <span class="literal">null</span>));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * å¤„ç†provideå±æ€§,å¦‚æœæœ‰åˆ™è°ƒç”¨ProvidePluginæ’ä»¶,è¿™ä¸ªæ’ä»¶å¯ä»¥è®©ä¸€ä¸ªmoduleèµ‹å€¼ä¸ºä¸€ä¸ªå˜é‡,ä»è€Œèƒ½åœ¨æ¯ä¸ªmoduleä¸­ä»¥å˜é‡åè®¿é—®å®ƒ</span></div><div class="line"><span class="comment"> * new webpack.ProvidePlugin(&#123;</span></div><div class="line"><span class="comment"> * identifier: "module1"</span></div><div class="line"><span class="comment"> * &#125;);</span></div><div class="line"><span class="comment"> * new webpack.ProvidePlugin(&#123;</span></div><div class="line"><span class="comment"> * identifier: ["module1", "property1"]</span></div><div class="line"><span class="comment"> * &#125;);</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">if</span>(<span class="keyword">typeof</span> options.provide === <span class="string">"object"</span>) &#123;</div><div class="line">compiler.apply(<span class="keyword">new</span> MovedToPluginWarningPlugin(<span class="string">"provide"</span>, <span class="string">"ProvidePlugin"</span>));</div><div class="line"><span class="keyword">var</span> ProvidePlugin = <span class="built_in">require</span>(<span class="string">"./ProvidePlugin"</span>);</div><div class="line">compiler.apply(<span class="keyword">new</span> ProvidePlugin(options.provide));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * å¤„ç†defineå±æ€§,å¦‚æœæœ‰è¿™ä¸ªå±æ€§åˆ™è°ƒç”¨DefinePluginæ’ä»¶,è¿™ä¸ªæ’ä»¶å¯ä»¥å®šä¹‰å…¨å±€çš„å¸¸é‡</span></div><div class="line"><span class="comment"> * //define</span></div><div class="line"><span class="comment"> * new webpack.DefinePlugin(&#123;</span></div><div class="line"><span class="comment"> * PRODUCTION: JSON.stringify(true),</span></div><div class="line"><span class="comment"> * BROWSER_SUPPORTS_HTML5: true</span></div><div class="line"><span class="comment"> * &#125;);</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * //use</span></div><div class="line"><span class="comment"> * if(!PRODUCTION) &#123;</span></div><div class="line"><span class="comment"> * console.log("develop mode");</span></div><div class="line"><span class="comment"> * &#125;</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * if (!BROWSER_SUPPORTS_HTML5) &#123;</span></div><div class="line"><span class="comment"> * require("html5shiv");</span></div><div class="line"><span class="comment"> * &#125; </span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">if</span>(options.define) &#123;</div><div class="line">compiler.apply(<span class="keyword">new</span> MovedToPluginWarningPlugin(<span class="string">"define"</span>, <span class="string">"DefinePlugin"</span>));</div><div class="line"><span class="keyword">var</span> defineObject = &#123;&#125;;</div><div class="line"><span class="keyword">if</span>(<span class="keyword">typeof</span> options.define === <span class="string">"object"</span>) &#123;</div><div class="line"><span class="built_in">Object</span>.keys(options.define).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">key</span>) </span>&#123;</div><div class="line">defineObject[key] = options.define[key];</div><div class="line">&#125;);</div><div class="line">&#125;</div><div class="line">compiler.apply(<span class="keyword">new</span> DefinePlugin(defineObject));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//defineDebugä¸ä¸ºfalse,å£°æ˜ä¸€ä¸ªå…¨å±€çš„DEBUG</span></div><div class="line"><span class="keyword">if</span>(options.defineDebug !== <span class="literal">false</span>)</div><div class="line">compiler.apply(<span class="keyword">new</span> DefinePlugin(&#123;</div><div class="line">DEBUG: !!options.debug</div><div class="line">&#125;));</div><div class="line"></div><div class="line"><span class="comment">//è§¦å‘after-pluginså’Œåº”ç”¨ä¸€äº›å…¶ä»–æ’ä»¶, æœ€åè§¦å‘after-resolvers</span></div><div class="line">compiler.applyPlugins(<span class="string">"after-plugins"</span>, compiler);</div><div class="line">compiler.resolvers.normal.apply(</div><div class="line"><span class="keyword">new</span> UnsafeCachePlugin(options.resolve.unsafeCache)</div><div class="line"><span class="comment">//...</span></div><div class="line">);</div><div class="line"><span class="comment">//...</span></div><div class="line">compiler.applyPlugins(<span class="string">"after-resolvers"</span>, compiler);</div><div class="line"></div><div class="line"><span class="comment">//è¿”å›options</span></div><div class="line"><span class="keyword">return</span> options;</div><div class="line">&#125;;</div></pre></td></tr></table></figure><p>çœ‹å®Œè¿™ä¸€æ®µä¹‹åï¼Œä¸ªäººå¯¹<code>webpack</code>çš„äº†è§£æ›´æ·±å…¥äº†ä¸€äº›ï¼Œç†Ÿæ‚‰äº†å¥½å‡ ä¸ªå¹³å¸¸ä¸æ€ä¹ˆç”¨åˆ°ï¼Œä½†æ˜¯æ„Ÿè§‰è¿˜æ˜¯å¾ˆæœ‰ç”¨çš„ä¸œè¥¿ï¼Œä¾‹å¦‚<code>externals</code>å’Œ<code>define</code>å±æ€§ã€‚</p><p>åˆ°è¿™é‡Œï¼Œ<code>webpack</code>çš„æ•´ä½“æµç¨‹ç®—æ˜¯å®Œäº†ï¼Œåœ¨<code>webpack</code>ä¸­ï¼Œæœ‰å„å¼å„æ ·çš„æ’ä»¶ï¼Œä¸‹é¢æˆ‘ä»¬ä¸€èµ·äº†è§£ä¸‹å¤§å®¶æ‰€ç†ŸçŸ¥çš„<code>UglifyJsPlugin</code>æ¥ç†è§£ä¸‹æ’ä»¶ä½“ç³»å’ŒåŠ æ·±å¯¹<code>webpack</code>æµç¨‹çš„ç†è§£ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬äº†è§£ä¸‹å¼€å‘<a href="https://doc.webpack-china.org/development/how-to-write-a-plugin" target="_blank" rel="external">webpackæ’ä»¶</a>çš„ä¸€äº›äº‹é¡¹ï¼š<br>åœ¨ä¸­æ–‡é‡Œé¢æåˆ°ï¼š</p><ul><li>ä¸€ä¸ªJavaScriptå‘½åå‡½æ•°</li><li>åœ¨å®ƒçš„åŸå‹ä¸Šå®šä¹‰ä¸€ä¸ª<code>apply</code>æ–¹æ³•</li><li>æŒ‡å®šæŒ‚è½½çš„webpackäº‹ä»¶é’©å­</li><li>å¤„ç†webpackå†…éƒ¨å®ä¾‹çš„ç‰¹å®šæ•°æ®</li><li>åŠŸèƒ½å®Œæˆåè°ƒç”¨webpackæä¾›çš„å›è°ƒ</li></ul><p>åŸºç¡€ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// å‘½åå‡½æ•°</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyExampleWebpackPlugin</span>(<span class="params"></span>) </span>&#123;</div><div class="line"><span class="comment">//...</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// åœ¨å®ƒçš„ prototype ä¸Šå®šä¹‰ä¸€ä¸ª apply æ–¹æ³•ã€‚</span></div><div class="line">MyExampleWebpackPlugin.prototype.apply = <span class="function"><span class="keyword">function</span>(<span class="params">compiler</span>) </span>&#123;</div><div class="line">  <span class="comment">// æŒ‡å®šæŒ‚è½½çš„webpackäº‹ä»¶é’©å­</span></div><div class="line">  compiler.plugin(<span class="string">'webpacksEventHook'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">compilation <span class="regexp">/* å¤„ç†webpackå†…éƒ¨å®ä¾‹çš„ç‰¹å®šæ•°æ®*/</span>, callback</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">"This is an example plugin!!!"</span>);</div><div class="line"></div><div class="line">    <span class="comment">// åŠŸèƒ½å®Œæˆåè°ƒç”¨webpackæä¾›çš„å›è°ƒã€‚</span></div><div class="line">    callback();</div><div class="line">  &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure><p>äº†è§£äº†æ’ä»¶çš„åŸºæœ¬æ¶æ„ï¼Œä¸‹é¢ä¸€èµ·çœ‹ä¸‹<code>UglifyJsPlugin</code>çš„å®ç°ï¼Œ<code>UglifyJsPlugin</code>ä½äº<code>lib/optimize/UglifyJsPlugin.js</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ä¸€ä¸ªJavaScriptå‘½åå‡½æ•°</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">UglifyJsPlugin</span>(<span class="params">options</span>) </span>&#123;</div><div class="line"><span class="keyword">if</span>(<span class="keyword">typeof</span> options !== <span class="string">"object"</span>) options = &#123;&#125;;</div><div class="line"><span class="keyword">if</span>(<span class="keyword">typeof</span> options.compressor !== <span class="string">"undefined"</span>) &#123;</div><div class="line">options.compress = options.compressor;</div><div class="line">&#125;</div><div class="line"><span class="keyword">this</span>.options = options;</div><div class="line">&#125;</div><div class="line"><span class="built_in">module</span>.exports = UglifyJsPlugin;</div><div class="line"></div><div class="line"><span class="comment">//åœ¨å®ƒçš„åŸå‹ä¸Šå®šä¹‰ä¸€ä¸ªapplyæ–¹æ³•</span></div><div class="line">UglifyJsPlugin.prototype.apply = <span class="function"><span class="keyword">function</span>(<span class="params">compiler</span>) </span>&#123;</div><div class="line"><span class="keyword">var</span> options = <span class="keyword">this</span>.options;</div><div class="line"></div><div class="line"><span class="comment">//å¦‚æœåªé€‰æŒ‡å®šé¡¹ä¸­æœ‰å…³äºæ–‡ä»¶åç¼€çš„å°±ç”¨æŒ‡å®šé¡¹ä¸­çš„ï¼Œå¦åˆ™ç”¨é»˜è®¤çš„(.jsç»“å°¾)</span></div><div class="line">options.test = options.test || <span class="regexp">/\.js($|\?)/i</span>;</div><div class="line"></div><div class="line"><span class="keyword">var</span> requestShortener = <span class="keyword">new</span> RequestShortener(compiler.context);</div><div class="line">compiler.plugin(<span class="string">"compilation"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">compilation</span>) </span>&#123;</div><div class="line"><span class="keyword">if</span>(options.sourceMap !== <span class="literal">false</span>) &#123;</div><div class="line">compilation.plugin(<span class="string">"build-module"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">module</span>) </span>&#123;</div><div class="line"><span class="comment">// to get detailed location info about errors</span></div><div class="line"><span class="built_in">module</span>.useSourceMap = <span class="literal">true</span>;</div><div class="line">&#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * æŒ‡å®šæŒ‚è½½çš„webpackäº‹ä»¶é’©å­(optimize-chunk-assets)</span></div><div class="line"><span class="comment"> * @param  &#123;Object&#125;  chunks     è¢«å‹ç¼©çš„æ¨¡å—ä¿¡æ¯</span></div><div class="line"><span class="comment"> * @param  &#123;Object&#125;  callback webpackæä¾›çš„å›è°ƒ</span></div><div class="line"><span class="comment"> */</span></div><div class="line">compilation.plugin(<span class="string">"optimize-chunk-assets"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">chunks, callback</span>) </span>&#123;</div><div class="line"><span class="keyword">var</span> files = [];</div><div class="line"></div><div class="line"><span class="comment">//å–å‡ºæ¨¡å—ä¸­çš„æ–‡ä»¶</span></div><div class="line">chunks.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>) </span>&#123;</div><div class="line">chunk.files.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">file</span>) </span>&#123;</div><div class="line">files.push(file);</div><div class="line">&#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">//compilation.additionalChunkAssetsè¿™ä¸ªé˜Ÿåˆ—åœ¨lib/HotModuleReplacementPlugin.jsè¿™ä¸ªæ–‡ä»¶ä¸­è¢«åŠ å…¥äº†æ–°å…ƒç´ </span></div><div class="line"><span class="comment">//ä¹Ÿä¸€èµ·åˆå¹¶åˆ°filesä¸­å»</span></div><div class="line">compilation.additionalChunkAssets.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">file</span>) </span>&#123;</div><div class="line">files.push(file);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">//æå–å‡ºç¬¦åˆoptionsä¸­æŒ‡å®šçš„æ–‡ä»¶åç¼€çš„æ–‡ä»¶</span></div><div class="line">files = files.filter(ModuleFilenameHelpers.matchObject.bind(<span class="literal">undefined</span>, options));</div><div class="line">files.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">file</span>) </span>&#123;</div><div class="line"><span class="keyword">var</span> oldWarnFunction = uglify.AST_Node.warn_function;</div><div class="line"><span class="keyword">var</span> warnings = [];</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line"><span class="keyword">var</span> asset = compilation.assets[file];</div><div class="line"><span class="keyword">if</span>(asset.__UglifyJsPlugin) &#123;</div><div class="line">compilation.assets[file] = asset.__UglifyJsPlugin;</div><div class="line"><span class="keyword">return</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//sourceMapç›¸å…³</span></div><div class="line"><span class="keyword">if</span>(options.sourceMap !== <span class="literal">false</span>) &#123;</div><div class="line"><span class="keyword">if</span>(asset.sourceAndMap) &#123;</div><div class="line"><span class="keyword">var</span> sourceAndMap = asset.sourceAndMap();</div><div class="line"><span class="keyword">var</span> inputSourceMap = sourceAndMap.map;</div><div class="line"><span class="keyword">var</span> input = sourceAndMap.source;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="keyword">var</span> inputSourceMap = asset.map();</div><div class="line"><span class="keyword">var</span> input = asset.source();</div><div class="line">&#125;</div><div class="line"><span class="keyword">var</span> sourceMap = <span class="keyword">new</span> SourceMapConsumer(inputSourceMap);</div><div class="line">uglify.AST_Node.warn_function = <span class="function"><span class="keyword">function</span>(<span class="params">warning</span>) </span>&#123; <span class="comment">// eslint-disable-line camelcase</span></div><div class="line"><span class="keyword">var</span> match = <span class="regexp">/\[.+:([0-9]+),([0-9]+)\]/</span>.exec(warning);</div><div class="line"><span class="keyword">var</span> line = +match[<span class="number">1</span>];</div><div class="line"><span class="keyword">var</span> column = +match[<span class="number">2</span>];</div><div class="line"><span class="keyword">var</span> original = sourceMap.originalPositionFor(&#123;</div><div class="line">line: line,</div><div class="line">column: column</div><div class="line">&#125;);</div><div class="line"><span class="keyword">if</span>(!original || !original.source || original.source === file) <span class="keyword">return</span>;</div><div class="line">warnings.push(warning.replace(<span class="regexp">/\[.+:([0-9]+),([0-9]+)\]/</span>, <span class="string">""</span>) +</div><div class="line"><span class="string">"["</span> + requestShortener.shorten(original.source) + <span class="string">":"</span> + original.line + <span class="string">","</span> + original.column + <span class="string">"]"</span>);</div><div class="line">&#125;;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="keyword">var</span> input = asset.source();</div><div class="line">uglify.AST_Node.warn_function = <span class="function"><span class="keyword">function</span>(<span class="params">warning</span>) </span>&#123; <span class="comment">// eslint-disable-line camelcase</span></div><div class="line">warnings.push(warning);</div><div class="line">&#125;;</div><div class="line">&#125;</div><div class="line">uglify.base54.reset();</div><div class="line"><span class="keyword">var</span> ast = uglify.parse(input, &#123;</div><div class="line">filename: file</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">//å‹ç¼©ä»£ç å¹¶åº”ç”¨è½¬æ¢</span></div><div class="line"><span class="keyword">if</span>(options.compress !== <span class="literal">false</span>) &#123;</div><div class="line">ast.figure_out_scope();</div><div class="line"><span class="keyword">var</span> compress = uglify.Compressor(options.compress);</div><div class="line">ast = ast.transform(compress);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//åœ¨é¡¶çº§ä½œç”¨åŸŸæ‰“ä¹±å˜é‡åç§°ï¼ˆé»˜è®¤ä¸å¼€å¯ï¼‰</span></div><div class="line"><span class="keyword">if</span>(options.mangle !== <span class="literal">false</span>) &#123;</div><div class="line">ast.figure_out_scope(options.mangle || &#123;&#125;);</div><div class="line">ast.compute_char_frequency(options.mangle || &#123;&#125;);</div><div class="line">ast.mangle_names(options.mangle || &#123;&#125;);</div><div class="line"><span class="keyword">if</span>(options.mangle &amp;&amp; options.mangle.props) &#123;</div><div class="line">uglify.mangle_properties(ast, options.mangle.props);</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">var</span> output = &#123;&#125;;</div><div class="line"></div><div class="line"><span class="comment">//æ³¨é‡Š</span></div><div class="line">output.comments = <span class="built_in">Object</span>.prototype.hasOwnProperty.call(options, <span class="string">"comments"</span>) ? options.comments : <span class="regexp">/^\**!|@preserve|@license/</span>;</div><div class="line"></div><div class="line"><span class="comment">//ä»£ç ç¾åŒ–</span></div><div class="line">output.beautify = options.beautify;</div><div class="line"></div><div class="line"><span class="comment">//æŠŠoptions.outputä¸‹çš„æ¯é¡¹æå–åˆ°output</span></div><div class="line"><span class="keyword">for</span>(<span class="keyword">var</span> k <span class="keyword">in</span> options.output) &#123;</div><div class="line">output[k] = options.output[k];</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(options.sourceMap !== <span class="literal">false</span>) &#123;</div><div class="line"><span class="keyword">var</span> map = uglify.SourceMap(&#123; <span class="comment">// eslint-disable-line new-cap</span></div><div class="line">file: file,</div><div class="line">root: <span class="string">""</span></div><div class="line">&#125;);</div><div class="line">output.source_map = map; <span class="comment">// eslint-disable-line camelcase</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">var</span> stream = uglify.OutputStream(output); <span class="comment">// eslint-disable-line new-cap</span></div><div class="line">ast.print(stream);</div><div class="line"><span class="keyword">if</span>(map) map = map + <span class="string">""</span>;</div><div class="line">stream = stream + <span class="string">""</span>;</div><div class="line">asset.__UglifyJsPlugin = compilation.assets[file] = (map ?</div><div class="line"><span class="keyword">new</span> SourceMapSource(stream, file, <span class="built_in">JSON</span>.parse(map), input, inputSourceMap) :</div><div class="line"><span class="keyword">new</span> RawSource(stream));</div><div class="line"><span class="keyword">if</span>(warnings.length &gt; <span class="number">0</span>) &#123;</div><div class="line">compilation.warnings.push(<span class="keyword">new</span> <span class="built_in">Error</span>(file + <span class="string">" from UglifyJs\n"</span> + warnings.join(<span class="string">"\n"</span>)));</div><div class="line">&#125;</div><div class="line">&#125; <span class="keyword">catch</span>(err) &#123;</div><div class="line"><span class="comment">//æ•è·åˆ°å‹ç¼©å‡ºé”™ä¿¡æ¯çš„æ“ä½œ</span></div><div class="line"><span class="keyword">if</span>(err.line) &#123;</div><div class="line"><span class="keyword">var</span> original = sourceMap &amp;&amp; sourceMap.originalPositionFor(&#123;</div><div class="line">line: err.line,</div><div class="line">column: err.col</div><div class="line">&#125;);</div><div class="line"><span class="keyword">if</span>(original &amp;&amp; original.source) &#123;</div><div class="line">compilation.errors.push(<span class="keyword">new</span> <span class="built_in">Error</span>(file + <span class="string">" from UglifyJs\n"</span> + err.message + <span class="string">" ["</span> + requestShortener.shorten(original.source) + <span class="string">":"</span> + original.line + <span class="string">","</span> + original.column + <span class="string">"]"</span>));</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">compilation.errors.push(<span class="keyword">new</span> <span class="built_in">Error</span>(file + <span class="string">" from UglifyJs\n"</span> + err.message + <span class="string">" ["</span> + file + <span class="string">":"</span> + err.line + <span class="string">","</span> + err.col + <span class="string">"]"</span>));</div><div class="line">&#125;</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(err.msg) &#123;</div><div class="line">compilation.errors.push(<span class="keyword">new</span> <span class="built_in">Error</span>(file + <span class="string">" from UglifyJs\n"</span> + err.msg));</div><div class="line">&#125; <span class="keyword">else</span></div><div class="line">compilation.errors.push(<span class="keyword">new</span> <span class="built_in">Error</span>(file + <span class="string">" from UglifyJs\n"</span> + err.stack));</div><div class="line">&#125; <span class="keyword">finally</span> &#123;</div><div class="line">uglify.AST_Node.warn_function = oldWarnFunction; <span class="comment">// eslint-disable-line camelcase</span></div><div class="line">&#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">//æ‰§è¡Œå›è°ƒå‡½æ•°</span></div><div class="line">callback();</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// æŒ‡å®šæŒ‚è½½çš„webpackäº‹ä»¶é’©å­(normal-module-loader)</span></div><div class="line">compilation.plugin(<span class="string">"normal-module-loader"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">context</span>) </span>&#123;</div><div class="line">context.minimize = <span class="literal">true</span>;</div><div class="line">&#125;);</div><div class="line">&#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure><p>ä¸Šé¢å°±æ˜¯æˆ‘å¯¹<code>UglifyJsPlugin</code>çš„æ ‡æ³¨ï¼Œä»è¿™ä¸ªæ’ä»¶çš„æºç åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥åŸºæœ¬çœ‹åˆ° webpack ç¼–è¯‘æ—¶çš„è¯»å†™è¿‡ç¨‹å¤§è‡´æ˜¯æ€ä¹ˆæ ·çš„ï¼šå®ä¾‹åŒ–æ’ä»¶ â€“&gt; è¯»å–æºæ–‡ä»¶ â€“&gt; ç¼–è¯‘å¹¶è¾“å‡º</p><h5 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><p>æˆ‘ä»¬åœ¨å‘½ä»¤è¡Œé‡Œè¾“å…¥äº†<code>webpack [--xxx]</code>ä¹‹åï¼Œ<code>webpack</code>å†…éƒ¨å¤§æ¦‚å¸®æˆ‘ä»¬åšäº†ä¸‹é¢å‡ ä»¶äº‹æƒ…ï¼š</p><ul><li>é¦–å…ˆä¼šèµ°åˆ°<code>bin/webpack.js</code>ï¼Œè§£æå‘½ä»¤è¡Œå‚æ•°ä»¥åŠå¼€å§‹æ‰§è¡Œç¼–è¯‘</li><li>åœ¨<code>bin/webpack.js</code>ä¸­è°ƒç”¨<code>webpack</code>å…¥å£å‡½æ•°ï¼Œ èµ°åˆ°<code>lib/webpack.js</code></li><li>åœ¨<code>webpack</code>ä¸­å®ä¾‹åŒ–ä¸€ä¸ª<code>Compiler</code>å¯¹è±¡ï¼ˆç»§æ‰¿<code>Tapable</code>ï¼Œå®ç°æ’ä»¶çš„æ³¨å†Œï¼‰ï¼Œè°ƒç”¨ç›®å½•ä¸‹çš„<code>lib/WebpackOptionsApply.js</code>æ¨¡å—</li><li>åœ¨<code>lib/WebpackOptionsApply.js</code>ä¸­æ ¹æ®ä¼ å…¥çš„<code>options</code>å’Œ<code>compiler</code>é€ä¸ªç¼–è¯‘å¹¶åº”ç”¨ä¸åŒæ’ä»¶ï¼Œå¹¶ä¸”è¿”å›æ–‡ä»¶</li></ul><h5 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h5><p><a href="https://zhuanlan.zhihu.com/p/24717349" target="_blank" rel="external">[webpack]æºç è§£è¯»ï¼šå‘½ä»¤è¡Œè¾“å…¥webpackçš„æ—¶å€™éƒ½å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</a></p><p><a href="http://www.jianshu.com/p/01a606c97d76" target="_blank" rel="external">webpackæºç åˆ†æï¼ˆä¸€ï¼‰â€” Tapableæ’ä»¶æ¶æ„</a></p><p><a href="https://juejin.im/entry/576b7aeda633bd0064065c74" target="_blank" rel="external">webpack æºç è§£æ</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨å‰ç«¯å·¥ç¨‹åŒ–è¶Šæ¥è¶Šæ™®åŠçš„ä»Šå¤©ï¼Œæˆ‘ä»¬å‡ ä¹æ¯ä¸ªé¡¹ç›®éƒ½éœ€è¦ç”¨åˆ°æ„å»ºå·¥å…·ï¼Œä»ä¸€å¼€å§‹çš„&lt;code&gt;grunt&lt;/code&gt;ï¼Œåˆ°&lt;code&gt;gulp&lt;/code&gt;ï¼Œå†åˆ°ç°åœ¨çš„&lt;code&gt;webpack&lt;/code&gt;ã€‚&lt;br&gt;æˆ‘ä»¬åœ¨ä½¿ç”¨&lt;code&gt;webpack&lt;/code&gt;æ—¶ï¼Œå¯ä»¥é€šè¿‡
      
    
    </summary>
    
      <category term="javascript" scheme="http://yoursite.com/categories/javascript/"/>
    
      <category term="webpackï¼Œæ„å»ºå·¥å…·" scheme="http://yoursite.com/categories/javascript/webpack%EF%BC%8C%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7/"/>
    
    
  </entry>
  
  <entry>
    <title>ä»é›¶å¼€å§‹å†™ä¸€ä¸ªReact - setStateå’Œç”Ÿå‘½å‘¨æœŸ</title>
    <link href="http://yoursite.com/2017/09/14/2017-09-14-write-your-own-react-2/"/>
    <id>http://yoursite.com/2017/09/14/2017-09-14-write-your-own-react-2/</id>
    <published>2017-09-13T16:00:00.000Z</published>
    <updated>2017-09-14T09:26:47.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨å‰é¢ä¸€ç¯‡ä¸­æˆ‘ä»¬ç”¨<code>instantiateReactComponent</code>æ–¹æ³•æ¥æ ¹æ®<code>node</code>çš„ä¸åŒæ¥è¿”å›ä¸åŒçš„ç»„ä»¶å®ä¾‹ï¼Œä¹‹å‰çš„åˆ†ç±»å¯èƒ½æœ‰äº›é—®é¢˜ï¼Œå°±æ˜¯å½“è¯¥ç»„ä»¶ä¸­<code>JSX</code>éƒ¨åˆ†æœ‰è¿”å›<code>null</code>çš„æƒ…å†µï¼Œ<code>instantiateReactComponent</code>å°±ä¸èƒ½è¿”å›æ­£ç¡®çš„ç»„ä»¶ï¼Œæ‰€ä»¥åœ¨è¿™é‡ŒåŠ äº†ä¸€ç§æ–°çš„ç»„ä»¶ç±»å‹ï¼š<code>ReactEmptyComponent</code>ï¼Œä½œç”¨å°±æ˜¯è¿”å›ä¸€æ®µç©ºçš„æ³¨é‡Šï¼Œæ ‡è®°è¿™æ˜¯ä¸€ä¸ªç©ºç»„ä»¶ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">instantiateReactComponent</span>(<span class="params">node</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (lodash.isNull(node) || lodash.isUndefined(node)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ReactEmptyComponent(<span class="literal">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//  ...</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//  ç©ºç»„ä»¶</span></div><div class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ReactEmptyComponent</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span>(node) &#123;</div><div class="line">        <span class="keyword">this</span>.type = <span class="string">"ReactEmptyComponent"</span>;</div><div class="line">        <span class="keyword">this</span>._currentElement = <span class="literal">null</span>;</div><div class="line">        <span class="keyword">this</span>._rootNodeID = <span class="literal">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     *  ç©ºç»„ä»¶æŒ‚è½½ç›´æ¥è¿”å›ä¸€æ®µç©ºæ³¨é‡Šå›å»</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    mountComponent(rootID) &#123;</div><div class="line">        <span class="keyword">this</span>._rootNodeID = rootID;</div><div class="line">        <span class="keyword">return</span> <span class="string">`&lt;!-- empty component data-reactid="<span class="subst">$&#123;<span class="keyword">this</span>._rootNodeID&#125;</span>" --&gt;`</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¹‹å‰ç®€å•å®ç°äº†ä¸€ä¸ªåˆå§‹åŒ–æ¸²æŸ“çš„è¿‡ç¨‹ï¼Œç°åœ¨æˆ‘ä»¬ä¸€èµ·å®ç°ä¸€ä¸ª<code>setState</code>æ–¹æ³•ä»¥åŠç»„ä»¶åé¢çš„æ›´æ–°é€»è¾‘ã€‚<code>setState</code>æ˜¯åœ¨ç»„ä»¶ä¸­è¢«è°ƒç”¨çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ä¹‹å‰çš„<code>Component</code>ç±»ä¸­åŠ å…¥ä¸€ä¸ª<code>setState</code>æ–¹æ³•ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Component</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="comment">//...</span></div><div class="line"></div><div class="line">    setState(newState, callback) &#123;</div><div class="line">        <span class="keyword">const</span> stacks = StackTrace.getSync();</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> &#123;functionName, source&#125; <span class="keyword">of</span> stacks) &#123;</div><div class="line">            <span class="keyword">if</span>(RENDER_REG.test(functionName) &amp;&amp; RENDER_REG.test(source)) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"callStack Error: you can't call setState in render method!"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">this</span>._reactInternalInstance.receiveComponent(<span class="literal">null</span>, newState);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (lodash.isFunction(callback)) &#123;</div><div class="line">            callback();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">    <span class="comment">//...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><p>ä¹‹å‰ä¸€ç¯‡æˆ‘ä»¬è¯´åˆ°ä¸€å…±å¯åˆ†æˆæ–‡æœ¬ç»„ä»¶ï¼Œæµè§ˆå™¨æ ‡ç­¾ç»„ä»¶ï¼Œè‡ªå®šä¹‰æ ‡ç­¾ç»„ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨è¿™ä¸‰ä¸ªç»„ä»¶ä¸­å„å®ç°ä¸€ä¸ª<code>receiveComponent</code>æ¥æ¥æ”¶æ–°ç»„ä»¶å¹¶ä¸”å®ç°ç›¸åº”æ›´æ–°ï¼š</p><p>å¯¹äºæ™®é€šçš„æ–‡æœ¬èŠ‚ç‚¹ï¼Œè¦åšçš„ç›¸å¯¹ç®€å•ï¼Œå°±æ˜¯åœ¨<code>receiveComponent</code>ä¸­å»æ›´æ–°ç›¸å…³<code>DOM</code>çš„<code>textContent</code>ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ReactDOMTextComponent</span> </span>&#123;</div><div class="line">  <span class="comment">//...</span></div><div class="line">  </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     *  æ¥æ”¶åˆ°æ–°ç»„ä»¶</span></div><div class="line"><span class="comment">     *  @param   &#123;String&#125;  text  [æ¥æ”¶åˆ°çš„æ–°ç»„ä»¶]</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    receiveComponent(text) &#123;</div><div class="line">        <span class="keyword">const</span> nextStringText = (<span class="string">""</span> + text);</div><div class="line">        <span class="keyword">if</span> (nextStringText !== <span class="keyword">this</span>._currentElement) &#123;</div><div class="line">            <span class="keyword">this</span>._currentElement = nextStringText;</div><div class="line">          <span class="comment">//æ›´æ–°ç›¸å…³DOMçš„textContent</span></div><div class="line">            $(<span class="string">`[data-reactid='<span class="subst">$&#123;<span class="keyword">this</span>._rootNodeID&#125;</span>']`</span>).textContent = nextStringText;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>åœ¨è‡ªå®šæ ‡ç­¾ç»„ä»¶ä¸­ï¼Œæˆ‘ä»¬éœ€è¦åšçš„äº‹æƒ…å¤§æ¦‚å¦‚ä¸‹</p><ul><li>å¦‚æœè°ƒç”¨æ—¶ä¼ å…¥äº†æ–°çš„<code>Vnode</code>å°±æŠŠå½“å‰çš„<code>_currentElement</code>æ”¹æˆæ–°ä¼ å…¥çš„<code>Vnode</code></li><li>åˆå¹¶æ–°è€<code>state</code></li><li>è°ƒç”¨ç»„ä»¶å®ä¾‹ä¸‹çš„<code>shouldComponentUpdate</code>æ ¹æ®è¿”å›çš„å¸ƒå°”å€¼å»åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°ç»„ä»¶</li><li>è°ƒç”¨ç»„ä»¶å®ä¾‹ä¸‹çš„<code>componentWillUpdate</code></li><li>è°ƒç”¨ç»„ä»¶çš„<code>render</code>å»æ‹¿åˆ°æ–°çš„<code>Vnode</code>ï¼Œå’Œä¹‹å‰çš„åšå¯¹æ¯”ï¼Œå¦‚æœä¹‹å‰çš„ç»„ä»¶<code>Vnode</code>ä¸å­˜åœ¨ï¼Œå°±ç›´æ¥è°ƒç”¨<code>instantiateReactComponent</code>è¿”å›æ–°çš„ç»„ä»¶å®ä¾‹</li><li>è°ƒç”¨ç»„ä»¶ç”Ÿå‘½å‘¨æœŸä¸‹çš„<code>componentDidUpdate</code>æ–¹æ³•</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ReactCompositeComponent</span> </span>&#123;</div><div class="line">    <span class="comment">//...</span></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     *  æ¥æ”¶åˆ°æ–°ç»„ä»¶, æ›´æ–°å®ä¾‹ä¸‹çš„state, ç»„ä»¶ç”Ÿå‘½å‘¨æœŸæ–¹æ³•è°ƒç”¨</span></div><div class="line"><span class="comment">     *  @param   &#123;ReactElement&#125;  nextElement  [æ–°çš„Vnode]</span></div><div class="line"><span class="comment">     *  @param   &#123;Object&#125;        newState     [this.setState(state)ä¸­çš„state]</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    receiveComponent(nextElement, newState) &#123;</div><div class="line">        <span class="comment">//  å¦‚æœæ¥å—äº†æ–°çš„, å°±ä½¿ç”¨æœ€æ–°çš„element</span></div><div class="line">        <span class="keyword">this</span>._currentElement = nextElement || <span class="keyword">this</span>._currentElement;</div><div class="line"></div><div class="line">        <span class="keyword">const</span> &#123; _rootNodeID &#125; = <span class="keyword">this</span>;</div><div class="line"></div><div class="line">        <span class="keyword">let</span> inst = <span class="keyword">this</span>._instance,</div><div class="line"></div><div class="line">            <span class="comment">//  nextStateå’ŒnextPropsçš„å¤„ç†</span></div><div class="line">            nextState = <span class="built_in">Object</span>.assign(inst.state || &#123;&#125;, newState),</div><div class="line">            nextProps = lodash.clone(<span class="keyword">this</span>._currentElement.props),</div><div class="line">            finalProps,</div><div class="line">            prevComponentInstance,</div><div class="line">            prevRenderedElement,</div><div class="line">            nextRenderedElement,</div><div class="line">            nextMarkup,</div><div class="line">            child;</div><div class="line"></div><div class="line">        <span class="comment">//  ä¿®æ”¹ç»„ä»¶çš„stateå’Œprops</span></div><div class="line">        <span class="keyword">this</span>._instance.state = nextState;</div><div class="line">        <span class="keyword">this</span>._instance.props = nextProps;</div><div class="line">        inst.state = nextState;</div><div class="line">        inst.props = nextProps;</div><div class="line"></div><div class="line">        <span class="comment">//  å£°æ˜å‘¨æœŸshouldComponentUpdate</span></div><div class="line">        <span class="keyword">if</span> (!inst.shouldComponentUpdate(nextProps, nextState)) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//  å£°æ˜å‘¨æœŸcomponentWillUpdate</span></div><div class="line">        inst.componentWillUpdate(nextProps, nextState);</div><div class="line"></div><div class="line">        <span class="comment">//  ä¹‹å‰çš„ç»„ä»¶ç»„ä»¶å®ä¾‹</span></div><div class="line">        prevComponentInstance = <span class="keyword">this</span>._renderedComponent;</div><div class="line"></div><div class="line">        <span class="comment">//  ä¹‹å‰çš„ç»„ä»¶å…ƒç´ </span></div><div class="line">        prevRenderedElement = prevComponentInstance._currentElement;</div><div class="line"></div><div class="line">        <span class="comment">//  å³å°†è¢«æ¸²æŸ“çš„æ–°ç»„ä»¶å…ƒç´ </span></div><div class="line">        nextRenderedElement = inst.render();</div><div class="line"></div><div class="line">        <span class="comment">//  åˆ¤æ–­æ˜¯éœ€è¦æ›´æ–°è¿˜æ˜¯ç›´æ¥å°±é‡æ–°æ¸²æŸ“</span></div><div class="line">        <span class="keyword">if</span> (shouldUpdateReactComponent(prevRenderedElement, nextRenderedElement)) &#123;</div><div class="line">            prevComponentInstance.receiveComponent(nextRenderedElement);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">//  é‡æ–°newä¸€ä¸ªå¯¹åº”çš„component</span></div><div class="line">            <span class="keyword">this</span>._renderedComponent = instantiateReactComponent(nextRenderedElement);</div><div class="line"></div><div class="line">            <span class="comment">//  é‡æ–°ç”Ÿæˆå¯¹åº”çš„å…ƒç´ å†…å®¹</span></div><div class="line">            nextMarkup = <span class="keyword">this</span>._renderedComponent.mountComponent(_rootNodeID);</div><div class="line"></div><div class="line">            <span class="comment">//  æ›¿æ¢æ•´ä¸ªèŠ‚ç‚¹</span></div><div class="line">            $(<span class="string">`[data-reactid="<span class="subst">$&#123;_rootNodeID&#125;</span>"]`</span>).innerHTML = nextMarkup;</div><div class="line">        &#125;</div><div class="line">        inst.componentDidUpdate();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>åœ¨ç»„ä»¶çš„<code>render</code>è¢«é‡æ–°è°ƒç”¨ä¹‹åï¼Œæœ€åè¿˜æ˜¯éœ€è¦è¦æ›´æ–°<code>DOM</code>çš„ï¼Œæ‰€ä»¥åœ¨<code>ReactDOMComponent</code>ä¸‹çš„<code>receiveComponent</code>é‡Œæˆ‘ä»¬éœ€è¦å¯¹ç»„ä»¶é‡Œçš„<code>DOM</code>ä¸‹çš„å±æ€§å’Œç»“æ„è¿›è¡Œæ›´æ–°ã€‚</p><p>åœ¨<code>React</code>ä¸­ï¼Œæœ‰ä¸€å¥—<code>diff</code>ç®—æ³•æ¥æ¯”è¾ƒæ–°è€ç»„ä»¶é—´çš„å·®å¼‚ï¼Œè¿”å›éœ€è¦æ›´æ–°çš„é˜Ÿåˆ—ï¼Œç„¶åç»Ÿä¸€å¯¹<code>DOM</code>ç»“æ„è¿›è¡Œæ›´æ–°ï¼Œåœ¨<code>ReactDOMComponent</code>ä¸‹çš„<code>receiveComponent</code>ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å®Œæˆä¸‹é¢çš„å‡ ä»¶äº‹æƒ…</p><ul><li>æ‹¿åˆ°è€çš„<code>props</code>å’Œæ–°çš„<code>props</code>åšï¼Œåœ¨<code>_updateDOMProperties</code>ä¸­å¯¹<code>DOM</code>ä¸‹çš„å±æ€§è¿›è¡Œæ›´æ–°</li><li>è°ƒç”¨<code>_updateDOMChildren</code>ï¼Œä¼ å…¥æ–°çš„ç»„ä»¶å­èŠ‚ç‚¹ï¼Œå»æ‹¼å‡‘å·®å¼‚é˜Ÿåˆ—ï¼Œç„¶åæ›´æ–°<code>DOM</code></li><li>ä¿®æ”¹<code>currentElement</code>å˜æˆæœ¬æ¬¡æ¸²æŸ“çš„ï¼Œä¾›ä¸‹æ¬¡ä½¿ç”¨</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ReactDOMComponent</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     *  æ¥æ”¶åˆ°æ–°ç»„ä»¶</span></div><div class="line"><span class="comment">     *  @param   &#123;Object&#125;  nextElement  [æ–°ç»„ä»¶]</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    receiveComponent(nextElement) &#123;</div><div class="line">        <span class="keyword">const</span> lastProps = lodash.clone(<span class="keyword">this</span>._currentElement.props),</div><div class="line">            nextProps = nextElement.props;</div><div class="line"></div><div class="line">        <span class="comment">//  éœ€è¦å•ç‹¬çš„æ›´æ–°å±æ€§</span></div><div class="line">        <span class="keyword">this</span>._updateDOMProperties(lastProps, nextProps);</div><div class="line"></div><div class="line">        <span class="comment">//  å†æ›´æ–°å­èŠ‚ç‚¹</span></div><div class="line">        <span class="keyword">this</span>._updateDOMChildren(nextElement.props.children);</div><div class="line"></div><div class="line">        <span class="comment">//  ä¿®æ”¹currentElementå˜æˆæœ¬æ¬¡æ¸²æŸ“çš„</span></div><div class="line">        <span class="keyword">this</span>._currentElement = nextElement;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     *  æ›´æ–°ç»„ä»¶ä¸­ç›¸å…³DOMçš„å±æ€§</span></div><div class="line"><span class="comment">     *  @param    &#123;Object&#125;  lastProps  [æ—§å±æ€§]</span></div><div class="line"><span class="comment">     *  @param    &#123;Object&#125;  nextProps  [æ–°å±æ€§]</span></div><div class="line"><span class="comment">     *  @private</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    _updateDOMProperties(lastProps, nextProps) &#123;</div><div class="line">        <span class="keyword">const</span> &#123; _rootNodeID &#125; = <span class="keyword">this</span>,</div><div class="line">        element = $(<span class="string">`[data-reactid="<span class="subst">$&#123;_rootNodeID&#125;</span>"]`</span>);</div><div class="line">        <span class="keyword">let</span> propKey, propValue, eventType, removed;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (propKey <span class="keyword">in</span> lastProps) &#123;</div><div class="line">            <span class="comment">//  åªåˆ é™¤è€å±æ€§ä¸­æœ‰ä½†æ˜¯æ–°å±æ€§ä¸­æ²¡æœ‰çš„</span></div><div class="line">            <span class="keyword">if</span> (hasOwnProperty(lastProps, propKey) &amp;&amp; !hasOwnProperty(nextProps, propKey)) &#123;</div><div class="line">                propValue = lastProps[propKey];</div><div class="line"></div><div class="line">                <span class="comment">//  ä¹‹å‰çš„äº‹ä»¶ä»£ç†éœ€è¦è§£é™¤</span></div><div class="line">                <span class="keyword">if</span> (EVENT_REG.test(propKey)) &#123;</div><div class="line">                    eventType = propKey.replace(<span class="string">"on"</span>, <span class="string">""</span>);</div><div class="line">                    Event.undelegate(&#123;</div><div class="line">                        element: doc,</div><div class="line">                        type: eventType,</div><div class="line">                        selector: <span class="string">`[data-reactid="<span class="subst">$&#123;_rootNodeID&#125;</span>"]`</span></div><div class="line">                    &#125;);</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === <span class="string">"className"</span>) &#123;</div><div class="line">                    removed = <span class="string">"class"</span>;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    removed = propKey;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">//  åˆ é™¤DOMä¸Šçš„ç›¸å…³å±æ€§</span></div><div class="line">                element.removeAttribute(removed);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//  å¼€å§‹éå†æ–°å±æ€§é›†åˆ</span></div><div class="line">        <span class="keyword">for</span> (propKey <span class="keyword">in</span> nextProps) &#123;</div><div class="line">            <span class="keyword">if</span> (hasOwnProperty(nextProps, propKey) &amp;&amp; propKey !== <span class="string">"children"</span>) &#123;</div><div class="line">                propValue = lastProps[propKey];</div><div class="line">              <span class="comment">//é‡æ–°ä»£ç†äº‹ä»¶</span></div><div class="line">                <span class="keyword">if</span> (EVENT_REG.test(propKey)) &#123;</div><div class="line">                    eventType = propKey.replace(<span class="string">"on"</span>, <span class="string">""</span>);</div><div class="line">                    Event.undelegate(&#123;</div><div class="line">                        element: doc,</div><div class="line">                        type: eventType,</div><div class="line">                        selector: <span class="string">`[data-reactid="<span class="subst">$&#123;_rootNodeID&#125;</span>"]`</span></div><div class="line">                    &#125;);</div><div class="line">                    Event.delegate(&#123;</div><div class="line">                        element: doc,</div><div class="line">                        type: eventType,</div><div class="line">                        selector: <span class="string">`[data-reactid="<span class="subst">$&#123;_rootNodeID&#125;</span>"]`</span>,</div><div class="line">                        handler: propValue,</div><div class="line">                        context: <span class="literal">null</span></div><div class="line">                    &#125;);</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === <span class="string">"className"</span>) &#123;</div><div class="line">                    element.setAttribute(<span class="string">"class"</span>, propValue);</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === <span class="string">"style"</span>) &#123;</div><div class="line">                    <span class="keyword">if</span> (lodash.isObject(propValue)) &#123;</div><div class="line">                        propValue = toStyle.string(propValue);</div><div class="line">                    &#125;</div><div class="line">                    element.setAttribute(propKey, propValue);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    element.setAttribute(propKey, propValue);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     *  æ›´æ–°å­å…ƒç´ </span></div><div class="line"><span class="comment">     *  @param    &#123;Array&#125;  nextChildrenElements  [è¢«æ›´æ–°çš„ç»„ä»¶é˜Ÿåˆ—]</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    _updateDOMChildren(nextChildrenElements) &#123;</div><div class="line">        <span class="keyword">if</span> (nextChildrenElements &amp;&amp; nextChildrenElements.length) &#123;</div><div class="line"></div><div class="line">            update.updateDepth++;</div><div class="line">            <span class="comment">//  é€’å½’æ‰¾å‡ºå·®åˆ«, ç»„è£…å·®å¼‚å¯¹è±¡</span></div><div class="line">            update.diff(update.diffQueue, nextChildrenElements, <span class="keyword">this</span>);</div><div class="line">            update.updateDepth--;</div><div class="line"></div><div class="line">            <span class="comment">//  åº”ç”¨æ›´æ–°</span></div><div class="line">            <span class="keyword">if</span> (update.updateDepth === <span class="number">0</span>) &#123;</div><div class="line">                update.patch(update.diffQueue);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>åœ¨<code>_updateDOMChildren</code>ä¸­æˆ‘ä»¬è°ƒç”¨äº†<code>update.diff</code>å’Œ<code>update.patch</code>æ–¹æ³•ï¼Œä¸€ä¸ªå¯¹æ¯”ä¸€ä¸ªåº”ç”¨ï¼Œè¿™é‡Œæˆ‘æ˜¯æŠŠ<code>diff</code>å’Œ<code>patch</code>æ”¾åˆ°ä¸€ä¸ªå¯¹è±¡ä¸‹ä½œä¸ºä¸€ä¸ªæ¨¡å—æš´éœ²å‡ºå»çš„ï¼Œä¸‹é¢å°±æ˜¯å…·ä½“çš„å®ç°ä»£ç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//å®šä¹‰æ›´æ–°ç±»å‹(ç§»åŠ¨å·²ç»å­˜åœ¨çš„ï¼Œåˆ é™¤èŠ‚ç‚¹ï¼Œæ’å…¥çš„æ–°æ ‡ç­¾)</span></div><div class="line"><span class="keyword">const</span> UPDATE_TYPES = &#123;</div><div class="line">    MOVE_EXISTING: <span class="number">1</span>,</div><div class="line">    REMOVE_NODE: <span class="number">2</span>,</div><div class="line">    INSERT_MARKUP: <span class="number">3</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> update = &#123;</div><div class="line">    <span class="comment">//  æ›´æ–°æ·±åº¦æ ‡è¯†</span></div><div class="line">    updateDepth: <span class="number">0</span>,</div><div class="line"></div><div class="line">    <span class="comment">//  æ›´æ–°é˜Ÿåˆ—</span></div><div class="line">    diffQueue: [],</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     *  é€’å½’æ‰¾å‡ºå·®åˆ«, ç»„è£…å·®å¼‚å¯¹è±¡, æ·»åŠ åˆ°æ›´æ–°é˜Ÿåˆ—diffQueue</span></div><div class="line"><span class="comment">     *  @param   &#123;Array&#125;  diffQueue             [æ›´æ–°é˜Ÿåˆ—]</span></div><div class="line"><span class="comment">     *  @param   &#123;Array&#125;  nextChildrenElements  [æ–°çš„å­ç»„ä»¶é›†åˆ]</span></div><div class="line"><span class="comment">     *  @param   &#123;Object&#125; component             [è¢«diffçš„ç»„ä»¶]</span></div><div class="line"><span class="comment">     *  @return  &#123;Array&#125;                        [éœ€è¦æ›´æ–°çš„å†…å®¹]</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    diff(diffQueue, nextChildrenElements, component) &#123;</div><div class="line">        <span class="comment">//  è·å–åˆ°å½“å‰ç»„ä»¶ä¸‹å·²ç»æ¸²æŸ“çš„ç»„ä»¶é›†åˆï¼ŒæŠŠcomponent._renderedChildrenæ‰å¹³æˆä¸€ä¸ªå¯¹è±¡ï¼Œå¦‚æœchildæœ‰keyï¼Œå°±æ‹¿keyä½œä¸ºå¯¹åº”çš„å±æ€§åï¼Œå¦åˆ™ç”¨ä¸‹æ ‡åšå±æ€§åï¼Œå…·ä½“å®ç°å¯ä»¥çœ‹ä¸‹é¢</span></div><div class="line">        <span class="keyword">const</span> prevChildren = flattenChildren(component._renderedChildren),</div><div class="line"></div><div class="line">            <span class="comment">//  ç”Ÿæˆæ–°çš„å­èŠ‚ç‚¹çš„componentå¯¹è±¡é›†åˆ(å¦‚æœæ˜¯ç»„ä»¶æœ‰æ›´æ–°, å°±å¤ç”¨åŸæ¥çš„, å¦‚æœæ˜¯æ–°å¢å°±æ˜¯æ–°çš„ç»„ä»¶å®ä¾‹)</span></div><div class="line">            nextChildren = generateComponentChildren(prevChildren, nextChildrenElements);</div><div class="line"></div><div class="line">        <span class="keyword">let</span> lastIndex = <span class="number">0</span>,</div><div class="line">            nextIndex = <span class="number">0</span>,</div><div class="line">            prevChild = <span class="literal">null</span>,</div><div class="line">            nextChild = <span class="literal">null</span>,</div><div class="line">            name, props, propKey, eventType;</div><div class="line"></div><div class="line">        <span class="comment">//  æšä¸¾nextChildren</span></div><div class="line">        <span class="keyword">for</span> (name <span class="keyword">in</span> nextChildren) &#123;</div><div class="line">            <span class="keyword">if</span> (!hasOwnProperty(nextChildren, name)) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            prevChild = prevChildren &amp;&amp; prevChildren[name];</div><div class="line">            nextChild = nextChildren[name];</div><div class="line"></div><div class="line">            <span class="comment">//  ä¸¤ä¸ªç›¸åŒè¯´æ˜æ˜¯ä½¿ç”¨çš„åŒä¸€ä¸ªcomponent,æ‰€ä»¥æˆ‘ä»¬éœ€è¦åšç§»åŠ¨çš„æ“ä½œ</span></div><div class="line">            <span class="keyword">if</span> (lodash.isEqual(prevChild, nextChild)) &#123;</div><div class="line">                <span class="keyword">if</span> (prevChild._mountIndex &lt; lastIndex) &#123;</div><div class="line">                    <span class="keyword">this</span>.diffQueue.push(&#123;</div><div class="line">                        parentId: component._rootNodeID,</div><div class="line">                        parentNode: $(<span class="string">`[data-reactid="<span class="subst">$&#123;component._rootNodeID&#125;</span>"]`</span>),</div><div class="line">                        type: UPDATE_TYPES.MOVE_EXISTING,</div><div class="line">                      <span class="comment">//ä»ç»„ä»¶åŸæ¥çš„mountIndex</span></div><div class="line">                        fromIndex: prevChild._mountIndex,</div><div class="line">                      <span class="comment">//åˆ°nextIndex</span></div><div class="line">                        toIndex: nextIndex</div><div class="line">                    &#125;);</div><div class="line">                &#125;</div><div class="line">              </div><div class="line">              <span class="comment">//ç¼“å­˜ä¸Šæ¬¡éå†æ—¶æœ€å¤§çš„index</span></div><div class="line">                lastIndex = <span class="built_in">Math</span>.max(prevChild._mountIndex, lastIndex);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">//  ä¹‹å‰å­˜åœ¨å­èŠ‚ç‚¹, éœ€è¦å…ˆå°†å­èŠ‚ç‚¹ç§»é™¤</span></div><div class="line">                <span class="keyword">if</span> (prevChild) &#123;</div><div class="line">                    <span class="keyword">this</span>.diffQueue.push(&#123;</div><div class="line">                        parentId: component._rootNodeID,</div><div class="line">                        parentNode: $(<span class="string">`[data-reactid="<span class="subst">$&#123;component._rootNodeID&#125;</span>"]`</span>),</div><div class="line">                        type: UPDATE_TYPES.REMOVE_NODE,</div><div class="line">                        fromIndex: prevChild._mountIndex,</div><div class="line">                        toIndex: <span class="literal">null</span></div><div class="line">                    &#125;);</div><div class="line">                    lastIndex = <span class="built_in">Math</span>.max(prevChild._mountIndex, lastIndex);</div><div class="line"></div><div class="line">                    props = (prevChild._currentElement &amp;&amp; prevChild._currentElement.props) ? prevChild._currentElement.props : &#123;&#125;;</div><div class="line"></div><div class="line">                  <span class="comment">//å¯¹ç§»é™¤çš„å­èŠ‚ç‚¹éœ€è¦è¿›è¡Œäº‹ä»¶ä»£ç†çš„æ¥è§¦ï¼Œé˜²æ­¢é‡å¤</span></div><div class="line">                    <span class="keyword">for</span> (propKey <span class="keyword">in</span> props) &#123;</div><div class="line">                        <span class="keyword">if</span> (hasOwnProperty(props, propKey) &amp;&amp; EVENT_REG.test(propKey)) &#123;</div><div class="line">                            eventType = propKey.replace(<span class="string">"on"</span>, <span class="string">""</span>);</div><div class="line">                            Event.undelegate(&#123;</div><div class="line">                                element: doc,</div><div class="line">                                type: eventType,</div><div class="line">                                selector: <span class="string">`[data-reactid="<span class="subst">$&#123;prevChild._rootNodeID&#125;</span>"]`</span></div><div class="line">                            &#125;);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">//  æ–°å¢çš„èŠ‚ç‚¹, éœ€è¦pushåˆ°diffQueue</span></div><div class="line">                <span class="keyword">if</span> (nextChild) &#123;</div><div class="line">                    <span class="keyword">this</span>.diffQueue.push(&#123;</div><div class="line">                        parentId: component._rootNodeID,</div><div class="line">                        parentNode: $(<span class="string">`[data-reactid="<span class="subst">$&#123;component._rootNodeID&#125;</span>"]`</span>),</div><div class="line">                        type: UPDATE_TYPES.INSERT_MARKUP,</div><div class="line">                        fromIndex: <span class="literal">null</span>,</div><div class="line">                        toIndex: nextIndex,</div><div class="line">                        markup: nextChild.mountComponent(<span class="string">`<span class="subst">$&#123;component._rootNodeID&#125;</span>.<span class="subst">$&#123;name&#125;</span>`</span>)</div><div class="line">                    &#125;);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">//  æ›´æ–°_mountIndexå’ŒnextIndex</span></div><div class="line">            nextChild._mountIndex = nextIndex;</div><div class="line">            nextIndex++;</div><div class="line"></div><div class="line">            <span class="comment">//  æŠŠnextChildrenå…‹éš†ä¸€ä»½ç»™_renderedChildren</span></div><div class="line">            component._renderedChildren = makeArray(nextChildren);</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     *  åº”ç”¨æ›´æ–°, æ‰§è¡ŒDOMæ“ä½œ</span></div><div class="line"><span class="comment">     *  @param   &#123;Array&#125;  updates  [å·®å¼‚å¯¹è±¡é›†åˆ]</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    patch(updates) &#123;</div><div class="line">        <span class="keyword">let</span> initialChildren = &#123;&#125;,</div><div class="line">            deleteChildren = [],</div><div class="line">            updatedIndex, updatedChild, parentID;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> update <span class="keyword">of</span> updates) &#123;</div><div class="line">            updatedIndex = update.fromIndex;</div><div class="line">            updatedChild = update.parentNode.children[updatedIndex];</div><div class="line">            parentID = update.parentID;</div><div class="line"></div><div class="line">            <span class="comment">//  æŠŠæ‰€æœ‰éœ€è¦æ›´æ–°çš„èŠ‚ç‚¹éƒ½ä¿å­˜ä¸‹æ¥</span></div><div class="line">            initialChildren[parentID] = initialChildren[parentID] || [];</div><div class="line"></div><div class="line">            <span class="comment">//  ä½¿ç”¨parentIDä½œä¸ºç®€æ˜“å‘½åç©ºé—´</span></div><div class="line">            initialChildren[parentID][updatedIndex] = updatedChild;</div><div class="line"></div><div class="line">            <span class="comment">//  æ‰€æœ‰éœ€è¦ä¿®æ”¹çš„èŠ‚ç‚¹å…ˆåˆ é™¤,å¯¹äºmoveçš„,åé¢å†é‡æ–°æ’å…¥åˆ°æ­£ç¡®çš„ä½ç½®å³å¯</span></div><div class="line">            <span class="keyword">if</span> (!lodash.isNull(updatedChild) &amp;&amp; !lodash.isUndefined(updatedChild)) &#123;</div><div class="line">                deleteChildren.push(updatedChild);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//  åˆ é™¤éœ€è¦åˆ é™¤çš„èŠ‚ç‚¹</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> child <span class="keyword">of</span> deleteChildren) &#123;</div><div class="line">            child.parentNode.removeChild(child);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> updateItem <span class="keyword">of</span> updates) &#123;</div><div class="line">            <span class="keyword">switch</span> (updateItem.type) &#123;</div><div class="line">                <span class="comment">//  æ’å…¥æ–°å…ƒç´ </span></div><div class="line">                <span class="keyword">case</span> UPDATE_TYPES.INSERT_MARKUP:</div><div class="line">                    insertChildAt(updateItem.parentNode, updateItem.markup, updateItem.toIndex);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line"></div><div class="line">                    <span class="comment">//  å…ƒç´ ä½ç½®å‘ç”Ÿæ”¹å˜    </span></div><div class="line">                <span class="keyword">case</span> UPDATE_TYPES.MOVE_EXISTING:</div><div class="line">                    insertChildAt(updateItem.parentNode, initialChildren[updateItem.parentID][updateItem.fromIndex], updateItem.toIndex);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line"></div><div class="line">                    <span class="comment">//  ä¸Šé¢å·²ç»åˆ é™¤, æ‰€ä»¥ä¸éœ€è¦å¤„ç†</span></div><div class="line">                <span class="keyword">case</span> UPDATE_TYPES.REMOVE_NODE:</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line"></div><div class="line">                <span class="keyword">default</span>:</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//  é‡ç½®ç›¸å…³å˜é‡</span></div><div class="line">        <span class="keyword">this</span>.reset();</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     *  é‡ç½®ç›¸å…³å˜é‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    reset() &#123;</div><div class="line">        <span class="keyword">this</span>.updateDepth = <span class="number">0</span>;</div><div class="line">        <span class="keyword">this</span>.diffQueue = [];</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure><p>åœ¨<code>diff</code>ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†ä¸¤ä¸ªæ–°æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯<code>flattenChildren</code>å’Œ<code>generateComponentChildren</code>ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹<code>flattenChildren</code>çš„å®ç°ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> *  æŠŠåŸæ¥æ˜¯æ•°ç»„çš„å­ç»„ä»¶é›†åˆè½¬æ¢æˆMapè¿”å›</span></div><div class="line"><span class="comment"> *  @param   &#123;Array&#125;  componentChildren     [å­ç»„ä»¶é›†åˆ]</span></div><div class="line"><span class="comment"> *  @return  &#123;Object&#125;                       [è¾“å‡ºçš„Map, æ¯ä¸ªå­ç»„ä»¶çš„keyæˆ–è€…ä¸€ä¸ªéšæœºæ•°åškey]</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">flattenChildren</span>(<span class="params">componentChildren</span>) </span>&#123;</div><div class="line">    <span class="keyword">let</span> childrenMap = &#123;&#125;,</div><div class="line">        child, name, i, len;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>, len = componentChildren.length; i &lt; len; i++) &#123;</div><div class="line">        child = componentChildren[i];</div><div class="line">        name = child &amp;&amp; child._currentelement &amp;&amp; child._currentelement.key ? child._currentelement.key : i.toString(<span class="number">36</span>);</div><div class="line">        childrenMap[name] = child;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> childrenMap;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>åœ¨<code>generateComponentChildren</code>æˆ‘ä»¬å¤§æ¦‚éœ€è¦å®Œæˆä¸‹é¢å‡ ä»¶äº‹æƒ…ï¼š</p><ul><li>éå†æ‹¿åˆ°å³å°†æ¸²æŸ“çš„æ–°ç»„ä»¶<code>children</code>ï¼ˆåšå‚æ•° <code>nextChildrenElements</code>ä¼ å…¥ï¼‰å’Œè€èŠ‚ç‚¹è¿›è¡Œå¯¹æ¯”</li><li>å¦‚æœè€èŠ‚ç‚¹å­˜åœ¨ä¸”å’Œæ–°èŠ‚ç‚¹æœ‰å·®å¼‚ï¼Œå³è°ƒç”¨è€èŠ‚ç‚¹ä¸‹çš„<code>receiveComponent</code>å»æ›´æ–°</li><li>å¦åˆ™å¦‚æœè€èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œåˆ™é‡æ–°è°ƒç”¨<code>instantiateReactComponent</code>è¿”å›ä¸€ä¸ªç»„ä»¶å®ä¾‹</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> *  ç”Ÿæˆå­èŠ‚ç‚¹elementsçš„componenté›†åˆ</span></div><div class="line"><span class="comment"> *  @param   &#123;Object&#125;  prevChildren          [flattenChildrenè¿”å›çš„Map]</span></div><div class="line"><span class="comment"> *  @param   &#123;Array&#125;   nextChildrenElements  [å³å°†è¦æ¸²æŸ“çš„èŠ‚ç‚¹]</span></div><div class="line"><span class="comment"> *  @return  &#123;Object&#125;                        [å­èŠ‚ç‚¹elementsçš„componenté›†åˆ]</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">generateComponentChildren</span>(<span class="params">prevChildren, nextChildrenElements</span>) </span>&#123;</div><div class="line">    <span class="keyword">let</span> nextChildren = &#123;&#125;,</div><div class="line">        index, len, name, prevChild, prevElement, nextElement, nextChildInstance, element;</div><div class="line">    nextChildrenElements = nextChildrenElements || [];</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (index = <span class="number">0</span>, len = nextChildrenElements.length; index &lt; len; index++) &#123;</div><div class="line">        element = nextChildrenElements[index];</div><div class="line">        name = (element &amp;&amp; element.key) ? element.key : index;</div><div class="line">        prevChild = prevChildren &amp;&amp; prevChildren[name];</div><div class="line">        prevElement = prevChild &amp;&amp; prevChild._currentElement;</div><div class="line">        nextElement = element;</div><div class="line"></div><div class="line">        <span class="comment">//  ç»„ä»¶æœ‰æ›´æ–°, è°ƒç”¨å½“å‰ç»„ä»¶ä¸‹çš„reciveComponentå»æ›´æ–°ç»„ä»¶</span></div><div class="line">        <span class="keyword">if</span> (shouldUpdateReactComponent(prevElement, nextElement)) &#123;</div><div class="line">            prevChild.receiveComponent(nextElement);</div><div class="line">            nextChildren[name] = prevChild;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">//  æ–°èŠ‚ç‚¹, å®ä¾‹åŒ–æ–°ç»„ä»¶</span></div><div class="line">            nextChildInstance = instantiateReactComponent(nextElement);</div><div class="line">            nextChildren[name] = nextChildInstance;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> nextChildren;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>åœ¨ä¹‹å‰å¥½å‡ ä¸ªåœ°æ–¹æˆ‘ä»¬éƒ½çœ‹åˆ°äº†<code>shouldUpdateReactComponent</code>è¿™ä¸ªæ–¹æ³•ï¼Œå®ƒå®Œæˆçš„åŠŸèƒ½ä¸»è¦æ˜¯åˆ¤æ–­ä¸¤ä¸ª<code>Vnode</code>ä¹‹å‰æ˜¯å¦æœ‰å·®å¼‚ï¼Œè¿”å›å¸ƒå°”å€¼ï¼Œä¸»è¦å®Œæˆä¸‹é¢å‡ ä»¶äº‹æƒ…ï¼š</p><ul><li>å¦‚æœæ–°è€<code>Vnode</code>æœ‰ä¸€ä¸ªæˆ–è€…éƒ½ä¸ºç©ºï¼Œç›´æ¥è¿”å›<code>false</code></li><li>æ–‡æœ¬èŠ‚ç‚¹ä¹‹é—´çš„å¯¹æ¯”</li><li>å½“æ–°çš„<code>Vnode</code>çš„<code>type</code>æ˜¯<code>object</code>ï¼Œæ¯”è¾ƒè€èŠ‚ç‚¹çš„<code>type</code>å’Œ<code>key</code>ï¼Œå¹¶ä¸”æ‹¿åˆ°ä¸¤è€…çš„<code>children</code>æ•°ç»„ï¼Œåšä¸€ä¸ªç®€å•çš„é•¿åº¦å¯¹æ¯”</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> *  åˆ¤æ–­ç»„ä»¶æ˜¯å¦éœ€è¦æ›´æ–°</span></div><div class="line"><span class="comment"> *  @param   &#123;Object&#125;  prevElement  [è€çš„vnode]</span></div><div class="line"><span class="comment"> *  @param   &#123;Object&#125;  nextElement  [æ–°çš„vnode]</span></div><div class="line"><span class="comment"> *  @return  &#123;Boolean&#125;              [æ ‡è¯†ç»„ä»¶æ˜¯å¦éœ€è¦æ›´æ–°]</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">shouldUpdateReactComponent</span>(<span class="params">prevElement, nextElement</span>) </span>&#123;</div><div class="line">    <span class="comment">//  æ’é™¤ä¸ºç©ºçš„æƒ…å†µ</span></div><div class="line">    <span class="keyword">if</span> (!lodash.isNull(prevElement) &amp;&amp; !lodash.isNull(nextElement) &amp;&amp; !lodash.isUndefined(prevElement) &amp;&amp; !lodash.isUndefined(nextElement)) &#123;</div><div class="line">        <span class="keyword">const</span> prevType = <span class="keyword">typeof</span> prevElement,</div><div class="line">            nextType = <span class="keyword">typeof</span> nextElement;</div><div class="line"></div><div class="line">        <span class="comment">//  çº¯æ–‡æœ¬ç»„ä»¶</span></div><div class="line">        <span class="keyword">if</span> (prevType === <span class="string">"number"</span> || prevType === <span class="string">"string"</span>) &#123;</div><div class="line">            <span class="keyword">return</span> (nextType === <span class="string">"number"</span> || nextType === <span class="string">"number"</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">let</span> prevChildren = [],</div><div class="line">                nextChildren = [],</div><div class="line">                childEqual = <span class="literal">true</span>;</div><div class="line"></div><div class="line">            <span class="keyword">if</span>(prevElement &amp;&amp; prevElement.props) &#123;</div><div class="line">                prevChildren = prevElement.props.children || [];</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (nextElement &amp;&amp; nextElement.props) &#123;</div><div class="line">                nextChildren = nextElement.props.children || [];</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            childEqual = prevChildren.length === nextChildren.length;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> (nextType === <span class="string">"object"</span> &amp;&amp;</div><div class="line">                (prevElement.type === nextElement.type) &amp;&amp;</div><div class="line">                (prevElement.key === nextElement.key) &amp;&amp;</div><div class="line">                childEqual);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œæˆ‘ä»¬å°±å®ç°ä¸€ä¸ª<code>setState</code>å’Œç”Ÿå‘½å‘¨æœŸï¼Œåœ¨ä¾‹å­ä¸­å®ç°äº†ä¸€ä¸ª<code>Todo</code>ï¼Œä¸€èµ·çœ‹ä¸‹æ•ˆæœ</p><p><img src="/imgs/todo.gif" alt="todo"></p><p>è‡³æ­¤æˆ‘ä»¬å°±å®ç°äº†ä¸€ä¸ªç®€å•çš„<code>React</code>ï¼Œä½†æ˜¯ä»…ä»…å®ç°äº†<code>è™šæ‹ŸèŠ‚ç‚¹</code>ï¼Œ<code>å·®å¼‚ç®—æ³•</code>ï¼Œ<code>propså•å‘æ•°æ®æµ</code>ï¼Œè¿˜æœ‰å¾ˆå¤šæ›´ä¼˜ç§€çš„æ²¡å®ç°ï¼Œæ¯”å¦‚æ‰¹é‡æ›´æ–°ï¼Œäº‹ä»¶ä¼˜åŒ–ï¼Œç»„ä»¶ä¸­çš„<code>refs</code>ï¼ŒæœåŠ¡ç«¯æ¸²æŸ“ç­‰ç­‰ï¼Œåªæ˜¯ä¸€ä¸ªç©å…·ï¼Œå¯¹äºæƒ³æ·±å…¥äº†è§£<code>React</code>åŸç†çš„å¯èƒ½ä¼šæœ‰äº›å¸®åŠ©ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨å‰é¢ä¸€ç¯‡ä¸­æˆ‘ä»¬ç”¨&lt;code&gt;instantiateReactComponent&lt;/code&gt;æ–¹æ³•æ¥æ ¹æ®&lt;code&gt;node&lt;/code&gt;çš„ä¸åŒæ¥è¿”å›ä¸åŒçš„ç»„ä»¶å®ä¾‹ï¼Œä¹‹å‰çš„åˆ†ç±»å¯èƒ½æœ‰äº›é—®é¢˜ï¼Œå°±æ˜¯å½“è¯¥ç»„ä»¶ä¸­&lt;code&gt;JSX&lt;/code&gt;éƒ¨åˆ†æœ‰è¿”å›&lt;code&gt;null&lt;/co
      
    
    </summary>
    
      <category term="javascript" scheme="http://yoursite.com/categories/javascript/"/>
    
      <category term="React" scheme="http://yoursite.com/categories/javascript/React/"/>
    
    
  </entry>
  
  <entry>
    <title>ä»é›¶å¼€å§‹å†™ä¸€ä¸ªReact - åˆå§‹åŒ–æ¸²æŸ“</title>
    <link href="http://yoursite.com/2017/09/04/2017-09-04-write-your-own-react-1/"/>
    <id>http://yoursite.com/2017/09/04/2017-09-04-write-your-own-react-1/</id>
    <published>2017-09-03T16:00:00.000Z</published>
    <updated>2017-09-07T04:26:08.000Z</updated>
    
    <content type="html"><![CDATA[<p>æˆ‘ä»¬çŸ¥é“<code>React</code>ç»„ä»¶è¿”å›çš„æ˜¯<code>JSX</code>ï¼Œè€Œ<code>JSX</code>å°†è¢«<code>babel</code>è½¬æ¢ï¼Œåœ¨<code>React</code>ä¸­æ˜¯å°†<code>JSX</code>ä¸­è½¬æ¢æˆ<code>React.createElement(type, config, children)</code>çš„å½¢å¼ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line">    render() &#123;</div><div class="line">        <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"app-container"</span>&gt;</span>App Component<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//babelè½¬æ¢åè¾“å‡ºçš„ä»£ç </span></div><div class="line"><span class="keyword">var</span> App = React.createClass(&#123;</div><div class="line">    render() &#123;</div><div class="line">        <span class="keyword">return</span> React.createElement(<span class="string">"div"</span>, &#123;</div><div class="line">          className: <span class="string">"app-container"</span></div><div class="line">        &#125;, <span class="string">"App Component"</span>)</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥åœ¨<code>babel</code>ä¸­æŠŠ<code>JSX</code>çš„<code>pragma</code>è½¬æ¢æ”¹æˆè‡ªå·±çš„å‡½æ•°å:</p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"presets"</span>: [</div><div class="line">    <span class="string">"es2015"</span></div><div class="line">  ],</div><div class="line">  <span class="attr">"plugins"</span>: [</div><div class="line">    [<span class="string">"transform-react-jsx"</span>, &#123;</div><div class="line">      "pragma":  "createElement"//é»˜è®¤çš„æ˜¯React.createElement, è¿™é‡Œæˆ‘ä»¬è¿˜æ˜¯ç”¨é»˜è®¤çš„</div><div class="line">    &#125;]</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>ä¸‹é¢ä¸€èµ·çœ‹çœ‹<code>createElement</code>çš„å®ç°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> uselessProp = [<span class="string">"key"</span>, <span class="string">"ref"</span>, <span class="string">"__self"</span>, <span class="string">"__source"</span>]</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">createElement</span>(<span class="params">type, config, ...children</span>) </span>&#123;</div><div class="line">    <span class="keyword">let</span> props = &#123;&#125;,</div><div class="line">        key = <span class="literal">null</span>,</div><div class="line">        ref = <span class="literal">null</span>;</div><div class="line">    <span class="keyword">if</span> (config != <span class="literal">null</span>) &#123;</div><div class="line">        ref = lodash.isUndefined(config.ref) ? <span class="literal">null</span> : config.ref;</div><div class="line">        key = lodash.isUndefined(config.key) ? <span class="literal">null</span> : <span class="string">""</span> + config.key;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> propsName <span class="keyword">in</span> config) &#123;</div><div class="line">            <span class="keyword">if</span> (uselessProp.indexOf(propsName) === <span class="number">-1</span> &amp;&amp; hasOwnProperty(config, propsName)) &#123;</div><div class="line">                props[propsName] = config[propsName];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//  å­ç»„ä»¶</span></div><div class="line">        props.children = children;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ReactElement(type, key, props, ref);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>è¿™é‡Œ<code>createElement</code>å°±æ˜¯å¯¹å‚æ•°è¿›è¡Œå¤„ç†ï¼Œè¿”å›ä¸€ä¸ªReactElement(<code>virtual-dom</code>)ï¼Œ<code>ReactElement</code>è¿”å›ä¸€ä¸ª<code>vnode</code>æ¥è¡¨ç¤ºä¸€ä¸ªèŠ‚ç‚¹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReactElement</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span>(type, key, props, ref) &#123;</div><div class="line">        <span class="keyword">this</span>.type = type;</div><div class="line">        <span class="keyword">this</span>.key = key;</div><div class="line">        <span class="keyword">this</span>.props = props || &#123;&#125;;</div><div class="line">        <span class="keyword">this</span>.ref = ref || &#123;&#125;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>åœ¨è¿”å›çš„<code>vnode</code>ä¸­ï¼Œ<code>type</code>ç”¨æ¥æ ‡è¯†ç»„ä»¶ç±»å‹ï¼Œ<code>props</code>å°±æ˜¯ç»„ä»¶ä¸­æ ‡ç­¾ä¸Šçš„<code>attributes</code>ï¼Œ<code>key</code>ç”¨ä½œè¿™ä¸ª<code>vnode</code>çš„å”¯ä¸€æ ‡è¯†ï¼Œå¯ç”¨äºåé¢çš„æ›´æ–°ï¼Œç°åœ¨æœ‰äº†<code>vnode</code>ï¼Œå°±éœ€è¦å°†<code>vnode</code>è½¬æ¢æˆçœŸå®çš„<code>DOM</code>æŒ‚è½½åˆ°é¡µé¢ä¸Šï¼Œåœ¨<code>React</code>å¯åŠ¨çš„æ—¶å€™ï¼Œæ˜¯é€šè¿‡<code>ReactDOM.render</code>æ¥è¿›è¡Œæ¸²æŸ“ç»„ä»¶åˆ°é¡µé¢ï¼Œæ¸²æŸ“å°±æ˜¯ä¸€ä¸ªé€’å½’è°ƒç”¨<code>render</code>çš„è¿‡ç¨‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">componnet, container, callback = noop</span>) </span>&#123;</div><div class="line">    <span class="keyword">const</span> componentInstance = instantiateReactComponent(componnet),</div><div class="line">        markup = componentInstance.mountComponent(React.nextReactRootIndex ++);</div><div class="line">    container.innerHTML = markup;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (lodash.isFunction(callback)) &#123;</div><div class="line">        callback.call(componentInstance);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>åœ¨<code>render</code>ä¸­æˆ‘ä»¬è°ƒç”¨äº†ä¸€ä¸ª<code>instantiateReactComponent</code>ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯æ ¹æ®<code>vnode</code>é‡Œé¢<code>type</code>çš„ä¸åŒæ¥è¿”å›ä¸åŒçš„ç»„ä»¶ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">instantiateReactComponent</span>(<span class="params">node</span>) </span>&#123;</div><div class="line">    <span class="comment">//  æ–‡æœ¬èŠ‚ç‚¹çš„æƒ…å†µ</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> node === <span class="string">"string"</span> || <span class="keyword">typeof</span> node === <span class="string">"number"</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ReactDOMTextComponent(node);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//  æµè§ˆå™¨é»˜è®¤èŠ‚ç‚¹çš„æƒ…å†µ</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> node === <span class="string">"object"</span> &amp;&amp; <span class="keyword">typeof</span> node.type === <span class="string">"string"</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ReactDOMComponent(node);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//  è‡ªå®šä¹‰çš„å…ƒç´ èŠ‚ç‚¹</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> node === <span class="string">"object"</span> &amp;&amp; <span class="keyword">typeof</span> node.type === <span class="string">"function"</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ReactCompositeComponent(node);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œ<code>ReactDOMTextComponent</code>æ˜¯çº¯æ–‡æœ¬ç»„ä»¶ï¼Œ<code>ReactDOMComponent</code>æ˜¯æµè§ˆå™¨æ ‡ç­¾ç»„ä»¶ï¼Œ<code>ReactCompositeComponent</code>æ˜¯è‡ªå®šä¹‰çš„ç»„ä»¶ï¼Œåé¢çš„ä¸¤ç§ç»„ä»¶ç±»å‹éƒ½å±äº<code>virtual-dom</code>ã€‚</p><p>æˆ‘ä»¬æ¥ä¸‹æ¥çœ‹çœ‹ä¸Šé¢ä¸‰ä¸ªç»„ä»¶çš„å®ç°ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//  æ–‡æœ¬ç»„ä»¶</span></div><div class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ReactDOMTextComponent</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span>(text) &#123;</div><div class="line">        <span class="comment">//  å­˜ä¸‹å½“å‰çš„å­—ç¬¦ä¸²</span></div><div class="line">        <span class="keyword">this</span>._currentElement =  (<span class="string">""</span> + text);</div><div class="line">        <span class="comment">//  ç»„ä»¶å”¯ä¸€id</span></div><div class="line">        <span class="keyword">this</span>._rootNodeID = <span class="literal">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     *  componentæ¸²æŸ“æ—¶ç”Ÿæˆçš„domç»“æ„</span></div><div class="line"><span class="comment">     *  @param   &#123;String&#125;  rootID  [ç»„ä»¶å”¯ä¸€id]</span></div><div class="line"><span class="comment">     *  @return  &#123;String&#125;          [HTMLå­—ç¬¦ä¸²]</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    mountComponent(rootID) &#123;</div><div class="line">        <span class="keyword">this</span>._rootNodeID = rootID;</div><div class="line"><span class="keyword">return</span> <span class="string">`&lt;!-- react-text: <span class="subst">$&#123;<span class="keyword">this</span>._rootNodeID&#125;</span> --&gt;<span class="subst">$&#123;<span class="keyword">this</span>._currentElement&#125;</span>&lt;!-- /react-text --&gt;`</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//æµè§ˆå™¨æ ‡ç­¾ç»„ä»¶</span></div><div class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ReactDOMComponent</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span>(element) &#123;</div><div class="line">        <span class="comment">//  å­˜ä¸‹å½“å‰å…ƒç´ å¼•ç”¨</span></div><div class="line">        <span class="keyword">this</span>._currentElement = element;</div><div class="line">        <span class="comment">//  ç»„ä»¶å”¯ä¸€id</span></div><div class="line">        <span class="keyword">this</span>._rootNodeID = <span class="literal">null</span>;</div><div class="line">        <span class="comment">//  å­ç»„ä»¶é›†åˆ</span></div><div class="line">        <span class="keyword">this</span>._renderedChildren = <span class="literal">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     *  componentæ¸²æŸ“æ—¶ç”Ÿæˆçš„domç»“æ„</span></div><div class="line"><span class="comment">     *  @param   &#123;String&#125;  rootID  [ç»„ä»¶å”¯ä¸€id]</span></div><div class="line"><span class="comment">     *  @return  &#123;String&#125;          [HTMLå­—ç¬¦ä¸²]</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    mountComponent(rootID) &#123;</div><div class="line">        <span class="keyword">this</span>._rootNodeID = rootID;</div><div class="line"></div><div class="line">        <span class="keyword">const</span> &#123; props, type &#125; = <span class="keyword">this</span>._currentElement,</div><div class="line">            &#123; children &#125; = props,</div><div class="line">            </div><div class="line"><span class="comment">//åˆ¤æ–­æ˜¯å¦ä¸ºå•æ ‡ç­¾</span></div><div class="line">            isSingleTag = SINGLE_TAG_REG.test(type);</div><div class="line">        <span class="keyword">let</span> tagOpen,</div><div class="line">            tagClose,</div><div class="line">            propKey, </div><div class="line">            propValue, </div><div class="line">            eventType,</div><div class="line">            childrenInstances, </div><div class="line">            childComponentInstance, </div><div class="line">            childrenMarkups, </div><div class="line">            curRootId;</div><div class="line"></div><div class="line">        tagOpen = [];</div><div class="line">        tagOpen.push(<span class="string">`&lt;<span class="subst">$&#123;type&#125;</span>`</span>, <span class="string">`data-reactid="<span class="subst">$&#123;<span class="keyword">this</span>._rootNodeID&#125;</span>"`</span>);</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (propKey <span class="keyword">in</span> props) &#123;</div><div class="line">          </div><div class="line">          <span class="comment">//è¿‡æ»¤æ‰propKeyä¸º"children"çš„æƒ…å†µ</span></div><div class="line">            <span class="keyword">if</span> (hasOwnProperty(props, propKey) &amp;&amp; propKey !== <span class="string">"children"</span>) &#123;</div><div class="line"></div><div class="line">                propValue = props[propKey];</div><div class="line">                <span class="keyword">if</span> (<span class="regexp">/^on[a-z]+/i</span>.test(propKey)) &#123;</div><div class="line">                    <span class="comment">/**</span></div><div class="line"><span class="comment">                     *  handleClick() &#123;</span></div><div class="line"><span class="comment">                     *      alert("clicked");</span></div><div class="line"><span class="comment">                     *  &#125;</span></div><div class="line"><span class="comment">                     *  </span></div><div class="line"><span class="comment">                     *  render() &#123;</span></div><div class="line"><span class="comment">                     *      return (</span></div><div class="line"><span class="comment">                     *          &lt;div onClick=&#123;this.handleClick&#125;&gt;click me&lt;/div&gt;</span></div><div class="line"><span class="comment">                     *      );</span></div><div class="line"><span class="comment">                     *  &#125;</span></div><div class="line"><span class="comment">                     */</span></div><div class="line">                  </div><div class="line">                  <span class="comment">//å–å¾—äº‹ä»¶åç§°å¹¶è¿›è¡Œäº‹ä»¶ä»£ç†</span></div><div class="line">                    eventType = propKey.replace(<span class="string">"on"</span>, <span class="string">""</span>).toLowerCase();</div><div class="line">                    Event.delegate(&#123;</div><div class="line">                        element: doc,</div><div class="line">                        type: eventType,</div><div class="line">                        selector: <span class="string">`[data-reactid="<span class="subst">$&#123;<span class="keyword">this</span>._rootNodeID&#125;</span>"]`</span>,</div><div class="line">                        handler: propValue,</div><div class="line">                        context: <span class="literal">null</span></div><div class="line">                    &#125;);</div><div class="line"></div><div class="line">                    <span class="comment">//  <span class="doctag">TODO:</span> å®ç°å¯¹å½“å‰å…ƒç´ è¿›è¡Œäº‹ä»¶ä»£ç†</span></div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === <span class="string">"style"</span>) &#123;</div><div class="line"></div><div class="line">                    <span class="comment">/**</span></div><div class="line"><span class="comment">                     *  render() &#123;</span></div><div class="line"><span class="comment">                     *      return (</span></div><div class="line"><span class="comment">                     *          &lt;div style=&#123;"background: red;"&#125;&gt;&lt;/div&gt;</span></div><div class="line"><span class="comment">                     *      );</span></div><div class="line"><span class="comment">                     *  &#125;</span></div><div class="line"><span class="comment">                     *</span></div><div class="line"><span class="comment">                     *  -----------------------</span></div><div class="line"><span class="comment">                     *</span></div><div class="line"><span class="comment">                     *  render() &#123;</span></div><div class="line"><span class="comment">                     *      return (</span></div><div class="line"><span class="comment">                     *          &lt;div style=&#123;&#123;background: 'red'&#125;&#125;&gt;</span></div><div class="line"><span class="comment">                     *          &lt;/div&gt;</span></div><div class="line"><span class="comment">                     *      );</span></div><div class="line"><span class="comment">                     *  &#125;</span></div><div class="line"><span class="comment">                     */</span></div><div class="line">                    <span class="keyword">if</span> (lodash.isObject(propValue)) &#123;</div><div class="line">                      </div><div class="line"><span class="comment">//è¿™é‡Œçš„toStyleç”¨äº†ä¸€ä¸ªnpmåŒ…(https://www.npmjs.com/package/to-style)</span></div><div class="line">                        propValue = toStyle.string(propValue);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    tagOpen.push(<span class="string">`style="<span class="subst">$&#123;propValue&#125;</span>"`</span>);</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propValue === <span class="string">"className"</span>) &#123;</div><div class="line">                    tagOpen.push(<span class="string">`class="<span class="subst">$&#123;propValue&#125;</span>"`</span>);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    tagOpen.push(<span class="string">`<span class="subst">$&#123;propKey&#125;</span>="<span class="subst">$&#123;propValue&#125;</span>"`</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (isSingleTag) &#123;</div><div class="line">            tagOpen.push(<span class="string">"/&gt;"</span>);</div><div class="line">            tagClose = <span class="string">""</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            tagOpen.push(<span class="string">"&gt;"</span>);</div><div class="line">            tagClose = <span class="string">`&lt;/<span class="subst">$&#123;type&#125;</span>&gt;`</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        childrenMarkups = [];</div><div class="line">        childrenInstances = [];</div><div class="line">      </div><div class="line">      <span class="comment">//éå†å­èŠ‚ç‚¹ï¼Œå®ä¾‹åŒ–-&gt;æ¸²æŸ“å­èŠ‚ç‚¹</span></div><div class="line">        <span class="keyword">if</span> (children &amp;&amp; children.length) &#123;</div><div class="line">            children.forEach(<span class="function">(<span class="params">child, key</span>) =&gt;</span> &#123;</div><div class="line">                childComponentInstance = instantiateReactComponent(child);</div><div class="line">                childrenInstances.push(childComponentInstance);</div><div class="line">                childComponentInstance._mountIndex = key;</div><div class="line">              </div><div class="line">              <span class="comment">//æ‹¼ä¸€ä¸ªç±»ä¼¼äº"x.y"çš„å­èŠ‚ç‚¹çš„nodeId</span></div><div class="line">                curRootId = <span class="string">`<span class="subst">$&#123;<span class="keyword">this</span>._rootNodeID&#125;</span>.<span class="subst">$&#123;key&#125;</span>`</span>;</div><div class="line">                childrenMarkups.push(childComponentInstance.mountComponent.call(childComponentInstance, curRootId));</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">      <span class="comment">//å°†å­ç»„ä»¶çš„é›†åˆä¿ç•™èµ·æ¥ï¼Œç•™ä½œåé¢æ›´æ–°ä½¿ç”¨</span></div><div class="line">        <span class="keyword">this</span>._renderedChildren = childrenInstances;</div><div class="line">      </div><div class="line">      <span class="comment">//è¿”å›ç»„ä»¶çš„çœŸå®HTMLç»“æ„</span></div><div class="line">        <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;tagOpen.join(<span class="string">" "</span>)&#125;</span> <span class="subst">$&#123;childrenMarkups.join(<span class="string">" "</span>)&#125;</span> <span class="subst">$&#123;tagClose&#125;</span>`</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//Reactè‡ªå®šä¹‰ç»„ä»¶</span></div><div class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ReactCompositeComponent</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span>(element) &#123;</div><div class="line">        <span class="comment">//  å­˜æ”¾å…ƒç´ elementå¯¹è±¡</span></div><div class="line">        <span class="keyword">this</span>._currentElement = element;</div><div class="line">        <span class="comment">//  å­˜æ”¾å”¯ä¸€æ ‡è¯†</span></div><div class="line">        <span class="keyword">this</span>._rootNodeID = <span class="literal">null</span>;</div><div class="line">        <span class="comment">//  å­˜æ”¾å¯¹åº”çš„ReactClassçš„å®ä¾‹</span></div><div class="line">        <span class="keyword">this</span>._instance = <span class="literal">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mountComponent(rootID, hostContainerInfo, context) &#123;</div><div class="line">        <span class="keyword">this</span>._rootNodeID = rootID;</div><div class="line">        <span class="keyword">const</span> &#123; props, type &#125; = <span class="keyword">this</span>._currentElement,</div><div class="line">            ReactClass = type,</div><div class="line">            <span class="comment">//æ ¹æ®vnodeä¸­çš„typeæ¥å®ä¾‹åŒ–</span></div><div class="line">            <span class="comment">//åœ¨instantiateReactComponentä¸­å¯ä»¥çœ‹åˆ°,åªæœ‰å½“vnodeçš„typeæ˜¯ä¸€ä¸ªæ–¹æ³•ç±»å‹(ç»„ä»¶çš„constructor)æ—¶æ‰ä¼šè¿”å›ReactCompositeComponent</span></div><div class="line">            inst = <span class="keyword">new</span> ReactClass(props);</div><div class="line">        <span class="keyword">let</span> renderedElement, renderedComponentInstance, renderedMarkup;</div><div class="line"></div><div class="line">      <span class="comment">//ä¿æŒå¯¹å½“å‰ç»„ä»¶å®ä¾‹çš„å¼•ç”¨</span></div><div class="line">        <span class="keyword">this</span>._instance = inst;</div><div class="line">        inst._reactInternalInstance = <span class="keyword">this</span>;</div><div class="line"></div><div class="line">      <span class="comment">//æ‰§è¡Œç”Ÿå‘½å‘¨æœŸä¸­çš„componentWillMount</span></div><div class="line">        <span class="keyword">if</span> (lodash.isFunction(inst.componentWillMount)) &#123;</div><div class="line">            inst.componentWillMount();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">      <span class="comment">//è°ƒç”¨å½“å‰ç»„ä»¶çš„render</span></div><div class="line">        renderedElement = <span class="keyword">this</span>._instance.render();</div><div class="line">      </div><div class="line">      <span class="comment">//æ ¹æ®renderä¸­è¿”å›çš„å†å»æ‰§è¡ŒinstantiateReactComponent</span></div><div class="line">        renderedComponentInstance = instantiateReactComponent(renderedElement);</div><div class="line">        <span class="keyword">this</span>._renderedComponent = renderedComponentInstance;</div><div class="line">      </div><div class="line">      <span class="comment">//æŒ‚è½½ç»„ä»¶</span></div><div class="line">        renderedMarkup = renderedComponentInstance.mountComponent(<span class="keyword">this</span>._rootNodeID);</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (lodash.isFunction(inst.componentDidMount)) &#123;</div><div class="line">            inst.componentDidMount();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> renderedMarkup;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    receiveComponent(nextElement, newState) &#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>ä¸Šé¢å°±æ˜¯æˆ‘ä»¬å¯¹ä¸‰ç§ç»„ä»¶çš„ä¸€ä¸ªå®ç°ï¼Œä¸‹é¢æˆ‘ä»¬ç”¨ä¸€ä¸ªå›¾ç®€å•è¡¨ç¤ºä¸‹å…·ä½“çš„æ¸²æŸ“è¿‡ç¨‹ï¼Œç¬¬ä¸€æ¬¡ç”»å›¾ï¼Œä¸è¶³ä¹‹å¤„å¤šå¤šåŒ…æ¶µã€‚</p><p><img src="/imgs/react-render.png" alt="æ¸²æŸ“é€»è¾‘"></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å†™ä¸€ä¸ª<code>Component</code>åŸºç±»ï¼Œå»ç»™æ‰€æœ‰çš„å­ç±»ç»§æ‰¿ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Component</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">constructor</span>() &#123;&#125;</div><div class="line"></div><div class="line">    setState(newState) &#123;</div><div class="line">        <span class="keyword">this</span>._reactInternalInstance.receiveComponent(<span class="literal">null</span>, newState);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     *  ç»„ä»¶å³å°†è¢«æŒ‚è½½åˆ°DOMä¸Š</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    componentWillMount() &#123;&#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     *  ç»„ä»¶å·²ç»è¢«æŒ‚è½½åˆ°DOMä¸Š</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    componentDidMount() &#123;&#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     *  ç»„ä»¶å³å°†æ”¶åˆ°æ–°çš„props</span></div><div class="line"><span class="comment">     *  @param   &#123;Object&#125;  nextProps  [æ–°çš„props]</span></div><div class="line"><span class="comment">     *  @param   &#123;Object&#125;  nextState  [æ–°çš„state]</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    componentWillReceiveProps(nextProps, nextState) &#123;&#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     *  ç»„ä»¶æ˜¯å¦åº”è¯¥æ›´æ–°</span></div><div class="line"><span class="comment">     *  @param   &#123;Object&#125;  nextProps  [æ–°çš„props]</span></div><div class="line"><span class="comment">     *  @param   &#123;Object&#125;  nextState  [æ–°çš„state]</span></div><div class="line"><span class="comment">     *  @return  &#123;Boolean&#125;            [æ ‡è®°ç»„ä»¶æ˜¯å¦åº”è¯¥æ›´æ–°]</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    shouldComponentUpdate(nextProps, nextState) &#123;</div><div class="line">        <span class="keyword">return</span> lodash.isEqual(<span class="keyword">this</span>.state, nextState) || lodash.isEqual(<span class="keyword">this</span>.props, nextProps);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     *  ç»„ä»¶å³å°†æ›´æ–°</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    componentWillUpdate() &#123;&#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     *  ç»„ä»¶å·²ç»æ›´æ–°</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    componentDidUpdate() &#123;&#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     *  ç»„ä»¶å³å°†è¢«å¸è½½</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    componentWillUnmount() &#123;&#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     *  è¿”å›ç»„ä»¶å†…éƒ¨çš„jsx</span></div><div class="line"><span class="comment">     *  @return  &#123;JSX&#125;  [ç»„ä»¶å¸ƒå±€]</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    render() &#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>ä¸‹é¢æˆ‘ä»¬ä¸€èµ·æ ¹æ®ä¸Šé¢çš„ä»£ç æ¥å®Œæˆä¸€ä¸ªåˆå§‹åŒ–æ¸²æŸ“çš„demoï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"./src/react"</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">InputComponnet</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span>() &#123;</div><div class="line">        <span class="keyword">super</span>();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    keyUpHandler(ev) &#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    render() &#123;</div><div class="line">        <span class="keyword">return</span> (</div><div class="line">&lt;input</div><div class="line">        type = <span class="string">"text"</span></div><div class="line">                ref=<span class="string">"textInput"</span></div><div class="line">        placeholder = &#123; <span class="string">"è¯·è¾“å…¥..."</span> &#125;</div><div class="line">        onKeyUp = &#123; <span class="keyword">this</span>.keyUpHandler.bind(<span class="keyword">this</span>) &#125;</div><div class="line">        style = &#123;&#123;</div><div class="line">                display: <span class="string">"block"</span>,</div><div class="line">                width: <span class="string">"200px"</span>,</div><div class="line">                height: <span class="string">"30px"</span>,</div><div class="line">                fontSize: <span class="string">"14px"</span>,</div><div class="line">                lineHeight: <span class="string">"30px"</span></div><div class="line">        &#125;&#125; /&gt;</div><div class="line">       );</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span>() &#123;</div><div class="line">        <span class="keyword">super</span>();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    render() &#123;</div><div class="line">        <span class="keyword">return</span> ( </div><div class="line">            &lt;div style = &#123; <span class="string">"background: red;"</span> &#125; &gt;</div><div class="line">        App Component &lt;InputComponnet placeholder = &#123; <span class="string">"è¯·è¾“å…¥..."</span> &#125;/&gt; </div><div class="line">         &lt;<span class="regexp">/div&gt;</span></div><div class="line"><span class="regexp">        );</span></div><div class="line"><span class="regexp">    &#125;</span></div><div class="line"><span class="regexp">&#125;</span></div><div class="line"><span class="regexp"></span></div><div class="line"><span class="regexp">React.render( &lt; App /</span> &gt; , <span class="built_in">document</span>.querySelector(<span class="string">"#root"</span>));</div></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œæˆ‘ä»¬çš„åˆå§‹åŒ–æ¸²æŸ“å·²ç»å®Œæˆäº†ï¼Œæˆ‘ä»¬å®ç°äº†ç»„ä»¶ä¸­çš„äº‹ä»¶ç»‘å®šï¼ˆäº‹ä»¶ä»£ç†ï¼‰ï¼Œç®€å•çš„ç”Ÿå‘½å‘¨æœŸï¼ˆ<code>componentWillMout</code>ï¼Œ <code>componentDidMount</code>ï¼‰ï¼Œå°†<code>virtual-dom</code>è½¬æ¢æˆçœŸå®çš„<code>DOM</code>å¹¶ä¸”æŒ‚è½½åˆ°é¡µé¢çš„è¿‡ç¨‹ã€‚</p><p><a href="https://github.com/rwson/little-react" target="_blank" rel="external">è¿™é‡Œ</a>å¯ä»¥æŸ¥çœ‹ç›¸å¯¹å®Œæ•´çš„ä»£ç ã€‚</p><h4 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h4><ul><li><a href="http://www.ahonn.me/2017/06/08/write-a-react-from-scratch-init-render/" target="_blank" rel="external">ä»é›¶å¼€å§‹å†™ä¸€ä¸ª Reactï¼šåˆå§‹åŒ–æ¸²æŸ“</a></li><li><a href="https://segmentfault.com/a/1190000010822571" target="_blank" rel="external">ä»0å®ç°ä¸€ä¸ªtiny react</a></li><li><a href="http://purplebamboo.github.io/2015/09/15/reactjs_source_analyze_part_one/" target="_blank" rel="external">reactjsæºç åˆ†æ-ä¸Šç¯‡</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æˆ‘ä»¬çŸ¥é“&lt;code&gt;React&lt;/code&gt;ç»„ä»¶è¿”å›çš„æ˜¯&lt;code&gt;JSX&lt;/code&gt;ï¼Œè€Œ&lt;code&gt;JSX&lt;/code&gt;å°†è¢«&lt;code&gt;babel&lt;/code&gt;è½¬æ¢ï¼Œåœ¨&lt;code&gt;React&lt;/code&gt;ä¸­æ˜¯å°†&lt;code&gt;JSX&lt;/code&gt;ä¸­è½¬æ¢æˆ&lt;code&gt;Reac
      
    
    </summary>
    
      <category term="javascript" scheme="http://yoursite.com/categories/javascript/"/>
    
      <category term="React" scheme="http://yoursite.com/categories/javascript/React/"/>
    
    
  </entry>
  
  <entry>
    <title>å®ç°ä½ è‡ªå·±çš„Promise</title>
    <link href="http://yoursite.com/2017/08/04/2017-08-04-write-your-promise/"/>
    <id>http://yoursite.com/2017/08/04/2017-08-04-write-your-promise/</id>
    <published>2017-08-03T16:00:00.000Z</published>
    <updated>2017-09-04T08:08:49.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ç°ä»£åŒ–å‰ç«¯å¼€å‘ä¸­ï¼Œç»å¸¸ä¼šç”¨åˆ°<code>Promise</code>æ¨¡å¼ï¼Œ<code>Promise</code>æœ€å¤§çš„å¥½å¤„å°±æ˜¯å¯ä»¥ä½¿å¼‚æ­¥ä»£ç çœ‹èµ·æ¥å¦‚åŒæ­¥èˆ¬æ¸…æ–°æ˜“è¯»ï¼Œä»è€Œä»å›è°ƒåœ°ç‹±ä¸­è§£è„±å‡ºæ¥ï¼Œ<code>ES6</code>å·²ç»åŸç”Ÿæ”¯æŒ<code>Promise</code>å¯¹è±¡ï¼Œä½†åœ¨æœªæ”¯æŒçš„æµè§ˆå™¨ä¸­è¿˜éœ€è¦é€šè¿‡ polyfill æ¨¡æ‹Ÿå®ç°ã€‚ä¸‹é¢ä¸€èµ·å®ç°ä¸€ä¸ª<code>Promise</code>ã€‚</p><p>ä¸€èˆ¬æˆ‘ä»¬ç”¨<code>Promise</code>ä¼šå†™æˆç±»ä¼¼ä¸‹é¢çš„æ ·å­ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> ins = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</div><div class="line">  <span class="comment">//...</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line">ins.then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</div><div class="line">  <span class="comment">//   ...</span></div><div class="line">&#125;, (ex) =&gt; &#123;&#125;);</div></pre></td></tr></table></figure><p>åœ¨<code>Promise</code>ä¸­ä¸€å…±å­˜åœ¨ä¸‰ç§çŠ¶æ€ï¼Œ<code>PENDING</code>, <code>FULFILLED</code>,<code>REJECTED</code>ï¼Œåœ¨å®ä¾‹åŒ–ä¸€ä¸ª<code>Promise</code>åï¼Œå®ƒçš„çŠ¶æ€ä¼šå˜æˆ<code>PENDING</code>ï¼Œæ‰§è¡Œ<code>resolve</code>æˆ–è€…<code>reject</code>æ–¹æ³•ä¼šæŠŠçŠ¶æ€æ”¹æˆ<code>FULFILLED</code>æˆ–è€…<code>REJECTED</code>ï¼Œæ­¤è¿‡ç¨‹ä¸å¯é€†ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ª<code>Promise</code>åªèƒ½è°ƒç”¨ä¸€æ¬¡<code>resolve</code>æˆ–è€…<code>reject</code>ã€‚</p><p>å…ˆæ¥æ­ä¸ªéª¨æ¶:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> PENDING = <span class="string">"PENDING"</span>,</div><div class="line">    FULFILLED = <span class="string">"FULFILLED"</span>,</div><div class="line">    REJECTED = <span class="string">"REJECTED"</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Promise</span>(<span class="params">resolver</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!isFunction(resolver)) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">"TypeError: resolver must be a function"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//å®ä¾‹çš„å€¼</span></div><div class="line">    <span class="keyword">this</span>.value = <span class="literal">null</span>;</div><div class="line"></div><div class="line">    <span class="comment">//å®ä¾‹çš„çŠ¶æ€</span></div><div class="line">    <span class="keyword">this</span>.status = PENDING;</div><div class="line"></div><div class="line">    <span class="comment">//ç¼“å­˜thenå’Œcatchä¸­ä¼ å…¥çš„æ–¹æ³•</span></div><div class="line">    <span class="keyword">this</span>._doneCallbacks = [];</div><div class="line">    <span class="keyword">this</span>._failCallbacks = [];</div><div class="line"></div><div class="line">    <span class="comment">//åœ¨æ‰§è¡Œresolverå†…éƒ¨æŠ›å‡ºå¼‚å¸¸, try ... catch åŒ…è£¹</span></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        resolver(resolve.bind(<span class="keyword">this</span>), reject.bind(<span class="keyword">this</span>));</div><div class="line">    &#125; <span class="keyword">catch</span> (ex) &#123;</div><div class="line">        reject.bind(<span class="keyword">this</span>)(ex);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">Promise</span>.prototype = &#123;</div><div class="line">  <span class="keyword">constructor</span>: Promise,</div><div class="line">  </div><div class="line">  then: function(onFulfilled, onRejected) &#123;&#125;,</div><div class="line">  </div><div class="line">  <span class="keyword">catch</span>: <span class="function"><span class="keyword">function</span>(<span class="params">onRejected</span>) </span>&#123;&#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">isFunction</span>(<span class="params">obj</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> obj === <span class="string">"function"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>ä¸Šé¢å®ç°äº†ä¸€ä¸ª<code>Promise</code>æ„é€ å™¨å¹¶ä¸”åœ¨å®ƒåŸå‹ä¸Šå£°æ˜äº†<code>then</code>å’Œ<code>catch</code>ä¸¤ä¸ªç©ºæ–¹æ³•ï¼Œä¸‹é¢æˆ‘ä»¬ä¸€èµ·æ¥å®ç°ä¸€ä¸‹<code>then</code>å’Œ<code>catch</code>ä¸¤ä¸ªæ–¹æ³•, <code>Promise</code>ä¸­çš„<code>then</code>æ”¯æŒè°ƒç”¨ï¼Œæ‰€ä»¥<code>then</code>æ–¹æ³•éœ€è¦è¿”å›ä¸€ä¸ª<code>Promise</code>å®ä¾‹ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">Promise</span>.prototype = &#123;</div><div class="line">  <span class="keyword">constructor</span>: Promise,</div><div class="line">  </div><div class="line">  //thenæ–¹æ³•æ¥å—onFulfilled, onRejectedä¸¤ä¸ªå›è°ƒ, å¹¶ä¸”è¿”å›ä¸€ä¸ªæ–°çš„Promiseå®ä¾‹</div><div class="line">  then: function(onFulfilled, onRejected) &#123;</div><div class="line">    <span class="comment">//è¦è¿”å›çš„æ–°Promise</span></div><div class="line">    <span class="keyword">let</span> ins = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125;);</div><div class="line"><span class="keyword">if</span> (isFunction(onFulfilled)) &#123;</div><div class="line">      <span class="comment">//å°†onFulfilledç¼“å­˜åˆ°_doneCallbacksä¸­</span></div><div class="line">      <span class="keyword">this</span>._doneCallbacks.push(makeCallback(ins, onFulfilled, <span class="string">"resolve"</span>));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (isFunction(onRejected)) &#123;</div><div class="line">      <span class="keyword">this</span>._failCallbacks.push(makeCallback(ins, onFulfilled, <span class="string">"reject"</span>));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> ins;</div><div class="line">  &#125;,</div><div class="line">  </div><div class="line">  <span class="keyword">catch</span>: <span class="function"><span class="keyword">function</span>(<span class="params">onRejected</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.then(<span class="literal">null</span>, onRejected);</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure><p>åœ¨å®ä¾‹åŒ–ä¸€ä¸ª<code>Promise</code>æ—¶ï¼Œæˆ‘ä»¬çš„<code>resolver</code>æœ‰<code>resolve</code>å’Œ<code>reject</code>ä¸¤ä¸ªå‚æ•°(ä¹Ÿå°±æ˜¯ä¸Šé¢æ„é€ å™¨ä¸­çš„æœ€å)ï¼Œåœ¨å®ä¾‹åŒ–å®Œæˆåå…¶ä¸­æœ‰ä¸€ä¸ªå°†è¢«ç«‹å³è°ƒç”¨ï¼Œç”¨äºç»“æŸå½“å‰<code>Promise</code>ã€‚ä¸‹é¢ä¸€èµ·å®ç°ä¸‹<code>resolve</code>å’Œ<code>reject</code>ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°å®Œæˆçš„åŠŸèƒ½å°±æ˜¯æ¥å—<code>resolver</code>ä¸­å¼‚æ­¥å¤„ç†è¿”å›çš„å€¼å¹¶ä¸”ä¼ é€’ç»™<code>then</code>æˆ–è€…<code>catch</code>ï¼Œå¹¶ä¸”å°†å½“å‰<code>PENDING</code>çš„çŠ¶æ€æ”¹æ‰ï¼Œåˆšæ‰ä¸Šé¢è¯´åˆ°<code>Promise</code>çš„çŠ¶æ€ä»<code>PENDING</code>åˆ°<code>FULFILLED</code>æˆ–è€…<code>REJECTED</code>æ˜¯ä¸€ä¸ªä¸å¯é€†çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥ä¸ºäº†ç¡®ä¿<code>resolve</code>æˆ–è€…<code>reject</code>ä¸è¢«å¤šæ¬¡è°ƒç”¨ï¼Œéœ€è¦åœ¨æ–¹æ³•å¼€å¤´æå‰åˆ¤æ–­ä¸‹<code>status</code>æ˜¯ä¸æ˜¯<code>PENDING</code>çŠ¶æ€ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolve</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.status !== PENDING) &#123;</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="keyword">this</span>.value = data;</div><div class="line">  <span class="keyword">this</span>.status = FULFILLED;</div><div class="line">  run.call(<span class="keyword">this</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">reject</span>(<span class="params">ex</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.status !== PENDING) &#123;</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="keyword">this</span>.value = ex;</div><div class="line">  <span class="keyword">this</span>.status = REJECTED;</div><div class="line">  run.call(<span class="keyword">this</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>åœ¨<code>resolve</code>å’Œ<code>reject</code>ä¸­ï¼Œæˆ‘ä»¬éƒ½è°ƒç”¨äº†<code>run</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„ä½œç”¨æ˜¯ç”¨äºè§¦å‘æ¥ä¸‹æ¥çš„<code>Promise</code>çš„æ‰§è¡Œã€‚<code>run</code>å‡½æ•°ä¸­éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œéœ€è¦å¼‚æ­¥æ‰§è¡Œç›¸å…³çš„å›è°ƒå‡½æ•°ï¼Œä¸‹é¢ä¸€èµ·æ¥å®ç°ä¸€ä¸ª<code>run</code>æ–¹æ³•ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯æ¯ä¸ª<code>Promise</code>åªèƒ½è¢«æ‰§è¡Œä¸€æ¬¡ï¼Œæ‰€ä»¥åœ¨<code>run</code>æ–¹æ³•æœ€åï¼ŒæŠŠ<code>_doneCallbacks</code>å’Œ<code>_failCallbacks</code>ç½®ç©ºã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.status === PENDING) &#123;</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="comment">//è·å–åˆ°å¼‚æ­¥å¤„ç†åçš„å€¼, æ ¹æ®å½“å‰çŠ¶æ€è·å–è¦æ‰§è¡Œçš„å›è°ƒ</span></div><div class="line">  <span class="keyword">const</span> &#123; value &#125; = <span class="keyword">this</span>,</div><div class="line">callbacks = <span class="keyword">this</span>.status === FULFILLED ? <span class="keyword">this</span>._doneCallbacks : <span class="keyword">this</span>._failCallbacksï¼›</div><div class="line">  </div><div class="line">  <span class="comment">//Promiseå¼‚æ­¥æ‰§è¡Œ</span></div><div class="line">  <span class="keyword">let</span> timeout = setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> fn <span class="keyword">of</span> callbacks) &#123;</div><div class="line">  <span class="comment">//å€¼ç©¿é€åˆ°æ¯ä¸ªthenæˆ–è€…catch</span></div><div class="line">      fn(value);</div><div class="line">    &#125;</div><div class="line">    clearTimeout(timeout);</div><div class="line">  &#125;);</div><div class="line">  </div><div class="line">  <span class="keyword">this</span>._doneCallbacks = [];</div><div class="line">  <span class="keyword">this</span>._failCallbacks = [];</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>ä¸Šé¢<code>run</code>é‡Œæ‰§è¡Œçš„æ¯ä¸ª<code>fn</code>éƒ½æ˜¯<code>then</code>æ–¹æ³•ä¸­<code>push</code>è¿›<code>_doneCallbacks</code>æˆ–<code>_failCallbacksçš„</code>makeCallback<code>è¿”å›å€¼ï¼Œ</code>makeCallback`æ˜¯æ•´ä¸ªä»£ç ä¸­æ¯”è¾ƒå¤æ‚çš„ä¸€éƒ¨åˆ†ï¼Œä¸‹é¢ä¸€èµ·çœ‹ä¸‹å…·ä½“å®ç°ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeCallback</span>(<span class="params">promise, callback, action</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">promiseCallback</span>(<span class="params">value</span>) </span>&#123;</div><div class="line">    <span class="comment">//callbackæ˜¯ä¸ªå‡½æ•°</span></div><div class="line">        <span class="keyword">if</span> (isFunction(callback)) &#123;</div><div class="line">        <span class="comment">//å®šä¹‰ä¸ªå˜é‡å»æ¥å—è¿”å›å€¼</span></div><div class="line">        <span class="comment">//é˜²æ­¢æŠ›å‡ºå¼‚å¸¸, try ... catch åŒ…è£¹, catch æ—¶ç›´æ¥è°ƒç”¨reject</span></div><div class="line">            <span class="keyword">let</span> x;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                x = callback(value);</div><div class="line">            &#125; <span class="keyword">catch</span> (ex) &#123;</div><div class="line">                reject.bind(promise)(ex);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">//callbackä¸­è¿”å›çš„æ˜¯this, ä¼šå¼•å‘æ­»å¾ªç¯</span></div><div class="line">            <span class="comment">//æŠ›å‡ºç±»å‹å¼‚å¸¸åˆ°reject</span></div><div class="line">            <span class="comment">/**</span></div><div class="line"><span class="comment">             * const ins = new Promise((resolve, reject) =&gt; &#123;&#125;);</span></div><div class="line"><span class="comment">             * ins.then(() =&gt; &#123;</span></div><div class="line"><span class="comment">             * return ins;</span></div><div class="line"><span class="comment">             * &#125;);</span></div><div class="line"><span class="comment">             */</span></div><div class="line">            <span class="keyword">if</span> (x === promise) &#123;</div><div class="line">                <span class="keyword">let</span> reason = <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">"TypeError: The return value could not be same with the promise"</span>);</div><div class="line">                reject.bind(promise)(reason);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (x <span class="keyword">instanceof</span> <span class="built_in">Promise</span>) &#123;</div><div class="line"></div><div class="line">            <span class="comment">//callbackä¸­è¿”å›ä¸€ä¸ªæ–°çš„Promise</span></div><div class="line">            <span class="comment">//æ‰§è¡Œè¯¥Promiseçš„thenå’Œcatch</span></div><div class="line">            <span class="comment">/**</span></div><div class="line"><span class="comment">             * const ins = new Promise((resolve, reject) =&gt; &#123;&#125;);</span></div><div class="line"><span class="comment">             * ins.then(() =&gt; &#123;</span></div><div class="line"><span class="comment">             * return new Promise((resolve, reject) =&gt; &#123;&#125;);</span></div><div class="line"><span class="comment">             * &#125;);</span></div><div class="line"><span class="comment">             */</span></div><div class="line">                x.then(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</div><div class="line">                    resolve.bind(promise)(data);</div><div class="line">                &#125;, (ex) =&gt; &#123;</div><div class="line">                    reject.bind(promise)(ex);</div><div class="line">                &#125;);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">let</span> then;</div><div class="line">                (<span class="function"><span class="keyword">function</span> <span class="title">resolveThenable</span>(<span class="params">x</span>) </span>&#123;</div><div class="line">                    <span class="comment">// å¦‚æœè¿”å›çš„æ˜¯ä¸€ä¸ªThenableå¯¹è±¡(Promise)</span></div><div class="line">                    <span class="keyword">if</span> (x &amp;&amp; (<span class="keyword">typeof</span> x === <span class="string">"object"</span> || isFunction(x))) &#123;</div><div class="line">                        <span class="keyword">try</span> &#123;</div><div class="line">                            then = x.then;</div><div class="line">                        &#125; <span class="keyword">catch</span> (ex) &#123;</div><div class="line">                            reject.bind(promise)(ex);</div><div class="line">                            <span class="keyword">return</span>;</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        <span class="keyword">if</span> (isFunction(then)) &#123;</div><div class="line">                            <span class="comment">// è°ƒç”¨Thenableå¯¹è±¡çš„thenæ–¹æ³•æ—¶,ä¼ é€’è¿›å»çš„resolvePromiseå’ŒrejectPromiseæ–¹æ³•ï¼ˆåŠä¸‹é¢çš„ä¸¤ä¸ªåŒ¿åæ–¹æ³•ï¼‰</span></div><div class="line">                            <span class="comment">// å¯èƒ½ä¼šè¢«é‡å¤è°ƒç”¨ã€‚ ä½†Promise+è§„èŒƒè§„å®šè¿™ä¸¤ä¸ªæ–¹æ³•æœ‰ä¸”åªèƒ½æœ‰å…¶ä¸­çš„ä¸€ä¸ªè¢«è°ƒç”¨ä¸€æ¬¡,å¤šæ¬¡è°ƒç”¨å°†è¢«å¿½ç•¥</span></div><div class="line">                            <span class="comment">// æ­¤å¤„é€šè¿‡invokedæ¥å¤„ç†é‡å¤è°ƒç”¨</span></div><div class="line">                            <span class="keyword">let</span> invoked = <span class="literal">false</span>;</div><div class="line">                            <span class="keyword">try</span> &#123;</div><div class="line">                                then.call( x, (y) =&gt; &#123;</div><div class="line">                                <span class="comment">//å¦‚æœå·²ç»è¢«è°ƒç”¨äº†ï¼Œç›´æ¥returnæ‰</span></div><div class="line">                                        <span class="keyword">if</span> (invoked) &#123;</div><div class="line">                                            <span class="keyword">return</span>;</div><div class="line">                                        &#125;</div><div class="line">                                        invoked = <span class="literal">true</span>;</div><div class="line"></div><div class="line">                                        <span class="comment">// é¿å…æ­»å¾ªç¯</span></div><div class="line">                                        <span class="keyword">if</span> (y === x) &#123;</div><div class="line">                                            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">"TypeError: The return value could not be same with the previous thenable object"</span>);</div><div class="line">                                        &#125;</div><div class="line"></div><div class="line">                                        <span class="comment">// yä»æœ‰å¯èƒ½æ˜¯thenableå¯¹è±¡ï¼Œé€’å½’è°ƒç”¨</span></div><div class="line">                                        resolveThenable(y);</div><div class="line">                                    &#125;, (e) =&gt; &#123;</div><div class="line">                                        <span class="keyword">if</span> (invoked) &#123;</div><div class="line">                                            <span class="keyword">return</span>;</div><div class="line">                                        &#125;</div><div class="line">                                        invoked = <span class="literal">true</span>;</div><div class="line">                                        reject.bind(promise)(e);</div><div class="line">                                    &#125;</div><div class="line">                                );</div><div class="line">                            &#125; <span class="keyword">catch</span> (e) &#123;</div><div class="line">                                <span class="comment">// å¦‚æœresolvePromiseå’ŒrejectPromiseæ–¹æ³•è¢«è°ƒç”¨å,å†æŠ›å‡ºå¼‚å¸¸,åˆ™å¿½ç•¥å¼‚å¸¸</span></div><div class="line">                                <span class="comment">// å¦åˆ™ç”¨å¼‚å¸¸å¯¹è±¡rejectæ­¤Promiseå¯¹è±¡</span></div><div class="line">                                <span class="keyword">if</span> (!invoked) &#123;</div><div class="line">                                    reject.bind(promise)(e);</div><div class="line">                                &#125;</div><div class="line">                            &#125;</div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            resolve.bind(promise)(x);</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        resolve.bind(promise)(x);</div><div class="line">                    &#125;</div><div class="line">                &#125;(x));</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">//æ ¹æ®actionåˆ¤æ–­æ‰§è¡Œresolveæˆ–è€…reject</span></div><div class="line">        action === <span class="string">"resolve"</span> ? resolve.bind(promise)(value) : reject.bind(promise)(value);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>ä¸Šé¢å°±æ˜¯æˆ‘å¯¹äºä¸€ä¸ª<code>Promise</code>çš„å®ç°ï¼Œå®Œæ•´ä»£ç è¯·ç§»æ­¥æˆ‘çš„<a href="https://github.com/rwson/My-Promise" target="_blank" rel="external">GitHub</a></p><p>å‚è€ƒï¼š</p><ul><li><a href="http://www.ituring.com.cn/article/66566" target="_blank" rel="external">Promises/A+è§„èŒƒ</a></li><li><a href="http://bruce-xu.github.io/blogs/js/promise" target="_blank" rel="external">JS Promiseçš„å®ç°åŸç†</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨ç°ä»£åŒ–å‰ç«¯å¼€å‘ä¸­ï¼Œç»å¸¸ä¼šç”¨åˆ°&lt;code&gt;Promise&lt;/code&gt;æ¨¡å¼ï¼Œ&lt;code&gt;Promise&lt;/code&gt;æœ€å¤§çš„å¥½å¤„å°±æ˜¯å¯ä»¥ä½¿å¼‚æ­¥ä»£ç çœ‹èµ·æ¥å¦‚åŒæ­¥èˆ¬æ¸…æ–°æ˜“è¯»ï¼Œä»è€Œä»å›è°ƒåœ°ç‹±ä¸­è§£è„±å‡ºæ¥ï¼Œ&lt;code&gt;ES6&lt;/code&gt;å·²ç»åŸç”Ÿæ”¯æŒ&lt;code&gt;Promise&lt;/cod
      
    
    </summary>
    
      <category term="javascript" scheme="http://yoursite.com/categories/javascript/"/>
    
      <category term="Promise" scheme="http://yoursite.com/categories/javascript/Promise/"/>
    
    
  </entry>
  
  <entry>
    <title>ç¼–å†™ä½ è‡ªå·±çš„async.waterfall</title>
    <link href="http://yoursite.com/2017/05/14/2017-05-14-write-your-async.waterfall/"/>
    <id>http://yoursite.com/2017/05/14/2017-05-14-write-your-async.waterfall/</id>
    <published>2017-05-13T16:00:00.000Z</published>
    <updated>2017-06-14T08:43:06.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨æ—©æœŸçš„å¼‚æ­¥å¼€å‘ä¸­ï¼Œå¦‚æœæœ‰ä¸€äº›å¼‚æ­¥ä»»åŠ¡éœ€è¦å¤„ç†ï¼Œéš¾å…ä¼šé‡åˆ°å›è°ƒåœ°ç‹±ï¼Œä¸ºäº†è§£å†³è¿™ç§é—®é¢˜ï¼Œä¹Ÿå‡ºç°è¿‡å¾ˆå¤šç¬¬ä¸‰æ–¹åº“æ¥é¿å…ï¼Œå…¶ä¸­<a href="[https://caolan.github.io/async/]">async.js</a>å°±æ˜¯æ¯”è¾ƒæœ‰åçš„ä¸€ä¸ªï¼Œé‡Œé¢æœ‰ä¸ª<code>waterfall</code>æ–¹æ³•ï¼Œæœ¬æ–‡æˆ‘ä»¬ä¸€èµ·æ¥æ¨¡æ‹Ÿå®ç°ä¸€ä¸ªç±»ä¼¼çš„</p><p>å…ˆæ¥çœ‹ä¸‹è°ƒç”¨</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">waterfall([</div><div class="line"><span class="function"><span class="keyword">function</span>(<span class="params">cb</span>) </span>&#123;</div><div class="line"><span class="built_in">console</span>.log(<span class="keyword">new</span> <span class="built_in">Date</span>);</div><div class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">cb(<span class="literal">null</span>, <span class="number">123</span>);</div><div class="line">&#125;, <span class="number">2000</span>);</div><div class="line">&#125;,</div><div class="line"><span class="function"><span class="keyword">function</span>(<span class="params">arg, cb</span>) </span>&#123;</div><div class="line"><span class="built_in">console</span>.log(<span class="keyword">new</span> <span class="built_in">Date</span>);</div><div class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line"><span class="built_in">console</span>.log(arg);</div><div class="line">cb(<span class="literal">null</span>, <span class="number">123</span>, <span class="number">456</span>);</div><div class="line">&#125;, <span class="number">2000</span>);</div><div class="line">&#125;,</div><div class="line"><span class="function"><span class="keyword">function</span>(<span class="params">arg1, arg2, cb</span>) </span>&#123;</div><div class="line"><span class="built_in">console</span>.log(<span class="keyword">new</span> <span class="built_in">Date</span>);</div><div class="line"><span class="built_in">console</span>.log(arg1, arg2);</div><div class="line">&#125;</div><div class="line">], <span class="function"><span class="keyword">function</span>(<span class="params">ex</span>) </span>&#123;</div><div class="line"><span class="keyword">if</span> (ex) &#123;</div><div class="line"><span class="keyword">throw</span> ex;</div><div class="line">&#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure><p>ä¸‹é¢æˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸‹å®ç°ä¸‹<code>waterfall</code>è¿™ä¸ªæ–¹æ³• : </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * @param task ä»»åŠ¡é˜Ÿåˆ—</span></div><div class="line"><span class="comment"> * @param callback æœ€åçš„å›è°ƒ</span></div><div class="line"><span class="comment"> **/</span></div><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">task = [], callback = noop</span>) </span>&#123;</div><div class="line">  <span class="comment">//ç±»å‹åˆ¤æ–­</span></div><div class="line">    <span class="keyword">if</span> (!(task <span class="keyword">instanceof</span> <span class="built_in">Array</span>)) &#123;</div><div class="line">        <span class="keyword">return</span> callback(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"task should be an array!"</span>));</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">  </div><div class="line">    (<span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params">...args</span>) </span>&#123;</div><div class="line">        <span class="comment">//  ç¬¬ä¸€ä¸ªå‚æ•°å¦‚æœä¸ä¸ºç©ºå°±ç›´æ¥æ‰§è¡Œcallback</span></div><div class="line">        <span class="keyword">if</span> (args[<span class="number">0</span>]) &#123;</div><div class="line">            <span class="keyword">return</span> callback(args[<span class="number">0</span>]);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (task.length) &#123;</div><div class="line">            <span class="comment">//  å–å¾—å½“å‰è¦æ‰§è¡Œçš„å‡½æ•°</span></div><div class="line">            <span class="keyword">let</span> fn = task.shift();</div><div class="line">          <span class="comment">//ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯errorç›¸å…³çš„,æ‰€ä»¥ä»ç¬¬äºŒä¸ªå¼€å§‹æˆªå–</span></div><div class="line">            fn.apply(<span class="literal">null</span>, [...args.slice(<span class="number">1</span>), onlyOnce(next)]);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            callback.apply(<span class="literal">null</span>, args);</div><div class="line">        &#125;</div><div class="line">    &#125;)();</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * åŒ…è£…ä¸€ä¸ªå‡½æ•°ç¡®ä¿å®ƒåªè¢«æ‰§è¡Œä¸€æ¬¡</span></div><div class="line"><span class="comment"> **/</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">onlyOnce</span>(<span class="params">cb</span>) </span>&#123;</div><div class="line">    <span class="keyword">let</span> flag = <span class="literal">false</span>;</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">...args</span>) </span>&#123;</div><div class="line">        <span class="keyword">if</span> (flag) &#123;</div><div class="line">            <span class="keyword">return</span> cb(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'cb already called'</span>));</div><div class="line">        &#125;</div><div class="line">        cb.apply(<span class="literal">null</span>, args);</div><div class="line">        flag = <span class="literal">true</span>;</div><div class="line">    &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">noop</span>(<span class="params"></span>) </span>&#123;&#125;</div></pre></td></tr></table></figure><p>ä¸Šé¢å°±æ˜¯å¯¹<code>waterfall</code>æ–¹æ³•çš„å®ç°ï¼Œåœ¨<a href="[https://caolan.github.io/async/]">async.js</a>è¿˜æœ‰å¾ˆå¤šå…¶ä»–å¾ˆæœ‰ç”¨çš„æ–¹æ³•ï¼Œåé¢æœ‰æœºä¼šç»§ç»­æ¨¡æ‹Ÿå®ç°ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨æ—©æœŸçš„å¼‚æ­¥å¼€å‘ä¸­ï¼Œå¦‚æœæœ‰ä¸€äº›å¼‚æ­¥ä»»åŠ¡éœ€è¦å¤„ç†ï¼Œéš¾å…ä¼šé‡åˆ°å›è°ƒåœ°ç‹±ï¼Œä¸ºäº†è§£å†³è¿™ç§é—®é¢˜ï¼Œä¹Ÿå‡ºç°è¿‡å¾ˆå¤šç¬¬ä¸‰æ–¹åº“æ¥é¿å…ï¼Œå…¶ä¸­&lt;a href=&quot;[https://caolan.github.io/async/]&quot;&gt;async.js&lt;/a&gt;å°±æ˜¯æ¯”è¾ƒæœ‰åçš„ä¸€ä¸ªï¼Œé‡Œé¢æœ‰ä¸ª&lt;code&gt;wa
      
    
    </summary>
    
      <category term="javascript" scheme="http://yoursite.com/categories/javascript/"/>
    
      <category term="å¼‚æ­¥æµæ§åˆ¶" scheme="http://yoursite.com/categories/javascript/%E5%BC%82%E6%AD%A5%E6%B5%81%E6%8E%A7%E5%88%B6/"/>
    
    
  </entry>
  
  <entry>
    <title>å®ç°ä¸€ä¸ªnewå‡½æ•°</title>
    <link href="http://yoursite.com/2017/04/20/2017-04-20-write-a-new-operator/"/>
    <id>http://yoursite.com/2017/04/20/2017-04-20-write-a-new-operator/</id>
    <published>2017-04-19T16:00:00.000Z</published>
    <updated>2017-11-09T08:59:44.162Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨æ—¥å¸¸javaScriptå¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¤šå¤šå°‘å°‘éƒ½ä¼šç”¨åˆ°<code>new</code>ï¼Œæœ€å¸¸è§çš„æ¯”å¦‚<code>new Date</code>ç­‰ç­‰ï¼Œåœ¨ä¸€äº›<code>js</code>é¢å‘å¯¹è±¡ä¸­ï¼Œç”¨åˆ°<code>new</code>çš„åœ°æ–¹æ›´å¤šäº†ï¼Œæ¯”å¦‚æˆ‘ä»¬é€šè¿‡<code>function</code>æ¥æ¨¡æ‹Ÿå£°æ˜ä¸€ä¸ªç±»ï¼Œéœ€è¦å®ä¾‹åŒ–çš„æ—¶å€™å°±éœ€è¦ç”¨<code>new xxx()</code>:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Class</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="comment">//...</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> inst = <span class="keyword">new</span> Class();</div></pre></td></tr></table></figure><p>åœ¨<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/new" target="_blank" rel="external">MDN</a>ä¸Šå¯¹åœ¨æ‰§è¡Œäº†<code>new</code>ä¹‹åçš„ä»‹ç»å¦‚ä¸‹:</p><ul><li>ä¸€ä¸ªæ–°å¯¹è±¡è¢«åˆ›å»ºã€‚å®ƒç»§æ‰¿è‡ª<code>*foo*.prototype</code></li><li>æ„é€ å‡½æ•° <code>*foo*</code> è¢«æ‰§è¡Œã€‚æ‰§è¡Œçš„æ—¶å€™ï¼Œç›¸åº”çš„ä¼ å‚ä¼šè¢«ä¼ å…¥ï¼ŒåŒæ—¶ä¸Šä¸‹æ–‡ä¼šè¢«æŒ‡å®šä¸ºè¿™ä¸ªæ–°å®ä¾‹ã€‚<code>new *foo*</code> ç­‰åŒäº <code>new *foo*()</code>, åªèƒ½ç”¨åœ¨ä¸ä¼ é€’ä»»ä½•å‚æ•°çš„æƒ…å†µã€‚</li><li>å¦‚æœæ„é€ å‡½æ•°è¿”å›äº†ä¸€ä¸ªâ€œå¯¹è±¡â€ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡ä¼šå–ä»£æ•´ä¸ª<code>new</code>å‡ºæ¥çš„ç»“æœã€‚å¦‚æœæ„é€ å‡½æ•°æ²¡æœ‰è¿”å›å¯¹è±¡ï¼Œé‚£ä¹ˆ<code>new</code>å‡ºæ¥çš„ç»“æœä¸ºæ­¥éª¤1åˆ›å»ºçš„å¯¹è±¡ã€‚(ä¸€èˆ¬æƒ…å†µä¸‹æ„é€ å‡½æ•°ä¸è¿”å›ä»»ä½•å€¼ï¼Œä¸è¿‡ç”¨æˆ·å¦‚æœæƒ³è¦†ç›–è¿™ä¸ªè¿”å›å€¼ï¼Œå¯ä»¥è‡ªå·±é€‰æ‹©è¿”å›ä¸€ä¸ªæ™®é€šå¯¹è±¡æ¥è¦†ç›–ã€‚å½“ç„¶ï¼Œè¿”å›æ•°ç»„ä¹Ÿä¼šè¦†ç›–ï¼Œå› ä¸ºæ•°ç»„ä¹Ÿæ˜¯å¯¹è±¡ã€‚)</li></ul><p>åœ¨çŸ¥é“äº†<code>new</code>ä¹‹åå‘ç”Ÿçš„äº‹æƒ…ï¼Œæˆ‘ä»¬çš„<code>_new</code>å‡½æ•°å°±å¯ä»¥æŒ‰ç…§ä¸Šé¢çš„å‡ ä¸ªæ­¥éª¤æ¥ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">_new</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="comment">//è·å–åˆ°æ‰€æœ‰å‚æ•°</span></div><div class="line"><span class="keyword">var</span> args = [].slice.call(<span class="built_in">arguments</span>),</div><div class="line">        <span class="comment">//åˆ›å»ºä¸€ä¸ªç©ºå¯¹è±¡</span></div><div class="line">obj = <span class="built_in">Object</span>.create(&#123;&#125;),</div><div class="line">        <span class="comment">//æŠŠç¬¬ä¸€ä¸ªå‚æ•°ä½œä¸ºæ„é€ å™¨</span></div><div class="line">Constructor = args[<span class="number">0</span>],</div><div class="line">res;</div><div class="line">  <span class="comment">//ç»§æ‰¿æ„é€ å™¨ä¸‹çš„åŸå‹</span></div><div class="line">obj.__proto__ = args[<span class="number">0</span>].prototype;</div><div class="line">  <span class="comment">//æ‰§è¡Œæ„é€ å™¨ï¼Œå¹¶ä¼ å…¥ç›¸å…³å‚æ•°</span></div><div class="line">res = Constructor.apply(obj, args.slice(<span class="number">1</span>));</div><div class="line">    <span class="keyword">return</span> obj;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯ç¬¬ä¸€ç‰ˆï¼Œæˆ‘ä»¬æŠŠæ„é€ å™¨çš„æ‰§è¡Œç»“æœä½œä¸ºè¿”å›å€¼è¿”å›å‡ºå»ï¼Œä¸‹é¢æˆ‘ä»¬ä¸€èµ·å†™ä¸ªæ¨¡æ‹Ÿç±»æµ‹è¯•ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Class</span>(<span class="params">name, age</span>) </span>&#123;</div><div class="line"><span class="keyword">this</span>.name = name;</div><div class="line"><span class="keyword">this</span>.age = age;</div><div class="line">&#125;</div><div class="line"></div><div class="line">Class.prototype = &#123;</div><div class="line"><span class="keyword">constructor</span>: Class,</div><div class="line">method: function () &#123;</div><div class="line"><span class="built_in">console</span>.log(<span class="string">"I'm method under Class.prototype"</span>);</div><div class="line">&#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">var</span> inst = _new(Class, <span class="string">"rwson"</span>, <span class="number">24</span>);</div><div class="line">inst.method();</div><div class="line"><span class="built_in">console</span>.log(inst);</div></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨æ§åˆ¶å°æ‰“å‡ºçš„ç±»ä¼¼ä¸‹å›¾çš„ä¸œè¥¿</p><p><img src="/imgs/new-1.png" alt="new-1"></p><p>æˆ‘ä»¬ç°åœ¨å®ç°äº†ä¸€ä¸ªç‰ˆæœ¬ï¼Œåªæ˜¯æŠŠåœ¨<code>_new</code>æ–¹æ³•ä¸­çš„<code>obj</code>å¯¹è±¡è¿”å›å‡ºæ¥äº†ï¼Œåˆšæ‰ä¸Šé¢ç¬¬ä¸‰æ­¥éª¤è¯´åˆ°ï¼Œ<code>å¦‚æœæ„é€ å‡½æ•°è¿”å›äº†ä¸€ä¸ªâ€œå¯¹è±¡â€ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡ä¼šå–ä»£æ•´ä¸ª</code>new<code>å‡ºæ¥çš„ç»“æœã€‚å¦‚æœæ„é€ å‡½æ•°æ²¡æœ‰è¿”å›å¯¹è±¡ï¼Œé‚£ä¹ˆ</code>new<code>å‡ºæ¥çš„ç»“æœä¸ºæ­¥éª¤1åˆ›å»ºçš„å¯¹è±¡ã€‚(ä¸€èˆ¬æƒ…å†µä¸‹æ„é€ å‡½æ•°ä¸è¿”å›ä»»ä½•å€¼ï¼Œä¸è¿‡ç”¨æˆ·å¦‚æœæƒ³è¦†ç›–è¿™ä¸ªè¿”å›å€¼ï¼Œå¯ä»¥è‡ªå·±é€‰æ‹©è¿”å›ä¸€ä¸ªæ™®é€šå¯¹è±¡æ¥è¦†ç›–ã€‚å½“ç„¶ï¼Œè¿”å›æ•°ç»„ä¹Ÿä¼šè¦†ç›–ï¼Œå› ä¸ºæ•°ç»„ä¹Ÿæ˜¯å¯¹è±¡ã€‚)</code>ï¼Œé’ˆå¯¹æ„é€ å‡½æ•°æœ‰è¿”å›å€¼çš„æƒ…å†µï¼Œæˆ‘ä»¬éœ€è¦æŠŠè¯¥è¿”å›å€¼è¿”å›ï¼Œä¸‹é¢æˆ‘ä»¬æŠŠä¹‹å‰çš„ä»£ç æ”¹æ”¹ï¼Œä»¥é€‚é…æœ‰è¿”å›å€¼çš„æƒ…å†µï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">_new</span>(<span class="params"></span>) </span>&#123;</div><div class="line"><span class="keyword">var</span> args = [].slice.call(<span class="built_in">arguments</span>),</div><div class="line">obj = <span class="built_in">Object</span>.create(&#123;&#125;),</div><div class="line">Constructor = args[<span class="number">0</span>],</div><div class="line">res;</div><div class="line">obj.__proto__ = args[<span class="number">0</span>].prototype;</div><div class="line">res = Constructor.apply(obj, args.slice(<span class="number">1</span>));</div><div class="line">  </div><div class="line">  <span class="comment">//åˆ¤æ–­Constructorçš„è¿”å›å€¼ç±»å‹</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">typeof</span> res === <span class="string">"object"</span> ? res : obj;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>åŒæ ·æˆ‘ä»¬å†™ä¸ªç±»åšæµ‹è¯•</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Class</span>(<span class="params">name, age</span>) </span>&#123;</div><div class="line"><span class="keyword">this</span>.name = name;</div><div class="line"><span class="keyword">this</span>.age = age;</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">       name: name,</div><div class="line">       age: age</div><div class="line">&#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> inst = _new(Class, <span class="string">"rwson"</span>, <span class="number">24</span>);</div><div class="line"><span class="built_in">console</span>.log(inst);</div></pre></td></tr></table></figure><p>è§‚å¯Ÿåœ¨æ§åˆ¶å°çš„è¾“å‡ºåº”è¯¥å’Œä¸‹é¢çš„ç±»ä¼¼ï¼š</p><p><img src="/imgs/new-2.png" alt="new-2"></p><p>åˆ°è¿™é‡Œæˆ‘ä»¬çš„<code>_new</code>æ–¹æ³•å°±å®ç°äº†ï¼Œä½†æ˜¯ç”±äº<code>Object.create</code>çš„åŸå› ï¼Œåœ¨<code>IE9-</code>çš„ç‰ˆæœ¬ä¸­å¯èƒ½ä¸å¤ªæ”¯æŒï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æŠŠ<code>Object.create</code>æ”¹æˆ<code>new Object</code>æˆ–è€…å¯¹è±¡å­—é¢é‡çš„å½¢å¼</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">_new</span>(<span class="params"></span>) </span>&#123;</div><div class="line"><span class="keyword">var</span> args = [].slice.call(<span class="built_in">arguments</span>),</div><div class="line">obj = &#123;&#125;,</div><div class="line">Constructor = args[<span class="number">0</span>],</div><div class="line">res;</div><div class="line">obj.__proto__ = args[<span class="number">0</span>].prototype;</div><div class="line">res = Constructor.apply(obj, args.slice(<span class="number">1</span>));</div><div class="line">  </div><div class="line">  <span class="comment">//åˆ¤æ–­Constructorçš„è¿”å›å€¼ç±»å‹</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">typeof</span> res === <span class="string">"object"</span> ? res : obj;</div><div class="line">&#125;</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨æ—¥å¸¸javaScriptå¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¤šå¤šå°‘å°‘éƒ½ä¼šç”¨åˆ°&lt;code&gt;new&lt;/code&gt;ï¼Œæœ€å¸¸è§çš„æ¯”å¦‚&lt;code&gt;new Date&lt;/code&gt;ç­‰ç­‰ï¼Œåœ¨ä¸€äº›&lt;code&gt;js&lt;/code&gt;é¢å‘å¯¹è±¡ä¸­ï¼Œç”¨åˆ°&lt;code&gt;new&lt;/code&gt;çš„åœ°æ–¹æ›´å¤šäº†ï¼Œæ¯”å¦‚æˆ‘ä»¬é€šè¿‡&lt;code&gt;fu
      
    
    </summary>
    
      <category term="javascript" scheme="http://yoursite.com/categories/javascript/"/>
    
      <category term="newæ“ä½œç¬¦" scheme="http://yoursite.com/categories/javascript/new%E6%93%8D%E4%BD%9C%E7%AC%A6/"/>
    
    
  </entry>
  
  <entry>
    <title>NodeJsè¯»å–windowsæ³¨å†Œè¡¨æ¥å¯¹è½¯ä»¶è¿›è¡Œå¸è½½</title>
    <link href="http://yoursite.com/2017/03/29/2017-03-29-node-read-regedit-uninstall-software/"/>
    <id>http://yoursite.com/2017/03/29/2017-03-29-node-read-regedit-uninstall-software/</id>
    <published>2017-03-28T16:00:00.000Z</published>
    <updated>2017-03-30T13:28:52.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘åœ¨åŸºäºnode-webkit(ä»¥ä¸‹ç®€ç§°NW)å¼€å‘windowsæ¡Œé¢app,é‡Œé¢æœ‰ä¸ªç±»ä¼¼äºè½¯ä»¶å¸‚åœºçš„åŠŸèƒ½,åå°ç®¡ç†å‘˜æä¾›ä¸€äº›è½¯ä»¶,å¯ä»¥ä»è¯¥appä¸Šè¿›è¡Œä¸‹è½½ã€å®‰è£…ã€å¸è½½ã€å‡çº§ç­‰ç­‰ã€‚</p><p>å®‰è£…æˆ–å‡çº§å¯ä»¥ç›´æ¥é€šè¿‡æŠŠä¸‹è½½å¥½çš„zipåŒ…è§£å‹å‡ºæ¥ç„¶åæ‰§è¡Œé‡Œé¢çš„exeç¨‹åºå®‰è£…å°±å¥½,ä½†æ˜¯å¸è½½ç›¸å¯¹æ¥è¯´æ¯”è¾ƒéº»çƒ¦,å‡ ä¹æ¯ä¸ªç¬¬ä¸‰æ–¹exeåœ¨å®‰è£…åçš„ç›®å½•é‡Œé¢éƒ½æœ‰ä¸€ä¸ªuninstall.exe,ä½†æ˜¯æˆ‘ä»¬ä¸çŸ¥é“è¿™ä¸ªè½¯ä»¶å…·ä½“å®‰è£…åœ¨å“ª,æ‰€ä»¥è¦å¸è½½ä¹Ÿæ— ä»ä¸‹æ‰‹,è¿™æ—¶å€™å°±æƒ³åˆ°äº†æ³¨å†Œè¡¨,é€šè¿‡æ³¨å†Œè¡¨å¯ä»¥è·å–åˆ°æŸä¸ªè½¯ä»¶çš„å®‰è£…ç›®å½•,æ‰€ä»¥å¯ä»¥å…ˆæŠŠå½“å‰æ³¨å†Œè¡¨çš„ç›®å½•å–å¾—,å†å»ç›¸åº”ç›®å½•ä¸‹æ‰¾å¸è½½è¯¥è½¯ä»¶çš„é‚£ä¸ªexeå¹¶æ‰§è¡Œã€‚</p><p>ç”±äºNWæ˜¯åŸºäºnodejsçš„,æ‰€ä»¥å¯ä»¥é€šè¿‡ä¸€äº›ç¬¬ä¸‰æ–¹çš„npmåŒ…æ¥æ“ä½œ,åœ¨è¿™é‡Œä¸»è¦ä¸»è¦ç”¨åˆ°çš„åŒ…æ˜¯<a href="https://github.com/fresc81/node-winreg" target="_blank" rel="external">winreg</a>,é¦–å…ˆæˆ‘ä»¬å…ˆåˆ†æä¸‹æ³¨å†Œè¡¨:</p><p><img src="/imgs/regedit-nalysis.png" alt="æ³¨å†Œè¡¨åˆ†æ"></p><p>å¯ä»¥çœ‹åˆ°æ ¹ä¸‹é¢æœ‰5ä¸ªå¤§é¡¹(HKEY_CLASSES_ROOTã€HKEY_CURRENT_USERã€HKEY_LOCAL_MACHINEã€HKEY_USERSã€HKEY_CURRENT_CONFIG),ç¬¬ä¸‰æ–¹è½¯ä»¶åŸºæœ¬ä¸Šéƒ½æ˜¯åœ¨HKEY_LOCAL_MACHINEä¸‹é¢çš„,æ‰€ä»¥è¯»å–çš„æ—¶å€™å°±ä»HKEY_LOCAL_MACHINEä¸‹é¢å¼€å§‹æ‰¾,è¿™é‡Œä»¥æœç‹—è¾“å…¥æ³•ä¸ºä¾‹:</p><p><img src="/imgs/sogouinput.png" alt="æœç‹—è¾“å…¥æ³•åˆ†æ"></p><p>ä»ä¸Šå›¾ä¸­çœ‹åˆ°è¯¥é¡¹çš„å…¨è·¯å¾„ä¸ºâ€HKEY_LOCAL_MACHINE\SOFTWARE\SogouInputâ€,æ³¨å†Œé¡¹é‡Œçš„ç¬¬ä¸€é¡¹å°±æ˜¯å®‰è£…è·¯å¾„,å¯¹åº”çš„åç§°æ˜¯é»˜è®¤,æ‰€ä»¥æˆ‘ä»¬è¯»å–çš„æ—¶å€™ä»å°±å¯ä»¥è¯»å–åˆšæ‰çš„é‚£ä¸ªè·¯å¾„,ä¸‹é¢æ˜¯ä¸»è¦çš„å®ç°:</p><pre><code>const Registry = require(&quot;winreg&quot;),    child_process = require(&quot;child_process&quot;),    path = require(&quot;path&quot;),    key = new Registry({        //  æ‰“å¼€HKEY_LOCAL_MACHINEè¿™ä¸ªå¤§ç±»        //  ä¸€å…±æœ‰5ä¸ªå±æ€§,åˆ†åˆ«æ˜¯&apos;HKLM&apos;, &apos;HKCU&apos;, &apos;HKCR&apos;, &apos;HKU&apos;, &apos;HKCC&apos;        //  å°±æ˜¯ä¸Šé¢é‚£5å¤§é¡¹çš„ç®€ç§°        hive: Registry.HKLM,        //  åæ–œæ å‰é¢éœ€è¦åŠ &quot;\&quot;è¿›è¡Œè½¬ä¹‰        key: &quot;\\SOFTWARE\\SogouInput&quot;    });let pre, end, cur, target;//  è·å–åˆ°æ³¨å†Œé¡¹ä¸­ä¸­æ‰€æœ‰é…ç½®é¡¹,ä»¥é”®å€¼å¯¹çš„å½¢å¼è¿”å›//  æ¯ä¸€å°é¡¹åˆ†åˆ«åŒ…å«(hostã€hiveã€keyã€nameã€typeã€valueã€arch)è¿™å‡ ä¸ªå±æ€§key.values((err, res) =&gt; {    if (err) {        console.log(err);    } else {        for(var i in res) {            cur = res[i];            //  åˆ¤æ–­å½“å‰é¡¹çš„åç§°æ˜¯å¦åŒ…å«defaultæˆ–è€…version            if (/default/gi.test(cur.name)) {                pre = cur.value;            } else if (/^version$/gi.test(cur.name)) {                end = cur.value;            }        }        //  æ‹¼æ¥è½¯ä»¶çš„å®‰è£…å…¨è·¯å¾„        target = `${pre}\\${end}`;        //  ç»“åˆnodejsä¸­å­è¿›ç¨‹æ¨¡å—ä¸­çš„execFileæ–¹æ³•æ‰§è¡Œå¸è½½çš„exe        child_process.execFile(path.join(target, &quot;Uninstall.exe&quot;), (err, res) =&gt; {            if (err) {                console.log(&quot;å¸è½½å¤±è´¥,è¯·é‡è¯•!&quot;);            }        });    }});</code></pre><p>æœ€åæ‰§è¡Œå†™å¥½çš„jsæ–‡ä»¶,å°±ä¼šé¡ºåˆ©æ‰“å¼€ç›¸å…³å¸è½½çª—å£:</p><p><img src="/imgs/uninstall-screenshoot.png" alt="å¸è½½çª—å£"></p><p>å½“ç„¶è¿™åªæ˜¯ä¸€ä¸ªç®€å•çš„å®ç°,æ˜¯åˆ†æå¥½äº†è½¯ä»¶å®‰è£…ç›®å½•ä¸‹çš„å¸è½½æ–‡ä»¶åœ¨ä»€ä¹ˆåœ°æ–¹å»è°ƒç”¨å®ƒçš„,è‚¯å®šä¸èƒ½åº”ç”¨äºæ‰€æœ‰åœºæ™¯,åº”è¯¥éå†è¯¥è½¯ä»¶å®‰è£…çš„æ ¹ç›®å½•å’Œå­ç›®å½•æœç´¢å¸è½½ç¨‹åºæ‰€åœ¨çš„æœ€ç»ˆç›®å½•æ¥æ‰§è¡Œå¹¶è¿›è¡Œå¸è½½ã€‚</p><h5 id="è®°åœ¨2017-03-30"><a href="#è®°åœ¨2017-03-30" class="headerlink" title="è®°åœ¨2017-03-30"></a>è®°åœ¨2017-03-30</h5><p>ä»Šå¤©å°è¯•ç”¨æ˜¨å¤©çš„å†™æ³•æ¥å®ç°è½¯ä»¶å¸è½½,å‘ç°å®ç°èµ·æ¥å¹¶ä¸æ˜¯é‚£ä¹ˆç®€å•,è€Œä¸”éå†æ–‡ä»¶çš„è¯é¢ä¸´ä¸€ä¸ªæ€§èƒ½é—®é¢˜,å±‚çº§ä¸€å¤š,é€’å½’å¾ªç¯å°±å¯èƒ½å¯¼è‡´éœ€è¦ç­‰å¥½ä¹…æ‰èƒ½å¼€å§‹å¸è½½,æ‰€ä»¥åˆæ·±å…¥ç ”ç©¶äº†ä¸‹æ³¨å†Œè¡¨,çœŸæ˜¯å¾—æ¥å…¨ä¸è´¹å·¥å¤«,æ³¨å†Œè¡¨é‡Œé¢å°±ç»™æˆ‘ä»¬æä¾›äº†æŸä¸ªè½¯ä»¶çš„å¸è½½è·¯å¾„,å…·ä½“ä½ç½®åœ¨</p><pre><code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\</code></pre><p>è¿™è¾¹éƒ½æ˜¯æˆ‘ä»¬å®‰è£…çš„æ‰€æœ‰è½¯ä»¶,éœ€è¦æ³¨æ„çš„æ˜¯åœ¨64ä½ç³»ç»Ÿä¸­è¯¥è·¯å¾„æœ‰æ‰€ä¸åŒ,å¤§é—®é¢˜è§£å†³äº†,æˆ‘ä»¬åˆé¢ä¸´ä¸€ä¸ªå…¶ä»–é—®é¢˜,å°±æ˜¯æœ‰äº›è½¯ä»¶åœ¨å®‰è£…å,å¸è½½é‚£ä¸€çº§çš„æœ€åä¸€å±‚å¹¶ä¸æ˜¯å®ƒè‡ªå·±çš„åå­—,è€Œæ˜¯ä¸€ä¸²èŠ±æ‹¬å·å¼€å§‹èŠ±æ‹¬å·ç»“å°¾çš„å­—ç¬¦ä¸²,ç±»ä¼¼äºä¸‹å›¾æ‰€ç¤º:</p><p><img src="/imgs/uninstall-id.png" alt="å¸è½½id"></p><p>äºæ˜¯åˆåœ¨å¥½å‡ ç§ä¸åŒç‰ˆæœ¬çš„windowsç”µè„‘ä¸Šè¿›è¡Œå°è¯•,å‘ç°è¿™ä¸ªidå§‹ç»ˆæ˜¯å”¯ä¸€çš„,æœ€åå’Œéœ€æ±‚å•†é‡å†³å®šåå°ç®¡ç†å‘˜åœ¨æä¾›è½¯ä»¶çš„æ—¶å€™æŠŠè¿™ä¸ªidä¹Ÿå¸¦ä¸Š,è¿™æ ·å°±è§£å†³äº†é—®é¢˜,è¿™æ ·å”¯ä¸€çš„ä¸å¥½å°±æ˜¯åå°ç®¡ç†å‘˜çš„å·¥ä½œå¯èƒ½ä¼šç¨å¾®ç¹çç‚¹ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æœ€è¿‘åœ¨åŸºäºnode-webkit(ä»¥ä¸‹ç®€ç§°NW)å¼€å‘windowsæ¡Œé¢app,é‡Œé¢æœ‰ä¸ªç±»ä¼¼äºè½¯ä»¶å¸‚åœºçš„åŠŸèƒ½,åå°ç®¡ç†å‘˜æä¾›ä¸€äº›è½¯ä»¶,å¯ä»¥ä»è¯¥appä¸Šè¿›è¡Œä¸‹è½½ã€å®‰è£…ã€å¸è½½ã€å‡çº§ç­‰ç­‰ã€‚&lt;/p&gt;
&lt;p&gt;å®‰è£…æˆ–å‡çº§å¯ä»¥ç›´æ¥é€šè¿‡æŠŠä¸‹è½½å¥½çš„zipåŒ…è§£å‹å‡ºæ¥ç„¶åæ‰§è¡Œé‡Œé¢çš„exeç¨‹åºå®‰è£…å°±
      
    
    </summary>
    
      <category term="nodejs" scheme="http://yoursite.com/categories/nodejs/"/>
    
      <category term="æ¡Œé¢exe" scheme="http://yoursite.com/categories/nodejs/%E6%A1%8C%E9%9D%A2exe/"/>
    
    
  </entry>
  
  <entry>
    <title>decoratorçš„å­¦ä¹ </title>
    <link href="http://yoursite.com/2017/02/17/2017-02-17-es7-decorator-tourial/"/>
    <id>http://yoursite.com/2017/02/17/2017-02-17-es7-decorator-tourial/</id>
    <published>2017-02-16T16:00:00.000Z</published>
    <updated>2017-02-17T12:44:15.000Z</updated>
    
    <content type="html"><![CDATA[<p>éšç€å‰ç«¯æŠ€æœ¯çš„å‘å±•,è¶Šæ¥è¶Šå¤šäººæŠŠES6ã€7ç”¨åœ¨æ—¥å¸¸å¼€å‘ä¸­,åœ¨ES7ä¸­é™¤äº†å¹¿ä¸ºäººçŸ¥çš„async/awaitä¹‹å¤–,è¿˜æœ‰ä¸€å¤§ç‰¹æ€§ â€” decorator(è£…é¥°å™¨)ã€‚</p><p>åœ¨ä¹‹å‰åŸç”Ÿjavascriptè®¾è®¡æ¨¡å¼ä¸­çš„ä¸€ç¯‡æ–‡ç« (<a href="http://rwson.github.io/2015/07/15/2015-07-15-js-design-mode-decorator/" target="_blank" rel="external">javascriptè£…é¥°è€…æ¨¡å¼</a>)ä¸­è¯´é“: jsè£…é¥°è€…æ¨¡å¼å¯ä»¥æŠŠä¸€ä¸ªå¯¹è±¡(ç±»/å‡½æ•°)é€æ˜åœ°åŒ…è£…åœ¨å¦å¤–ä¸€ä¸ªå¯¹è±¡ä¸Š,å®Œæˆå¯¹è¢«è£…é¥°è€…æ·»åŠ ä¸€äº›æ–°åŠŸèƒ½çš„ä½œç”¨ã€‚ç®€å•çš„è¯´æˆ‘ä»¬å¯ä»¥åœ¨ä¸ä¿®æ”¹ç±»/å‡½æ•°å†…éƒ¨ä»£ç çš„æƒ…å†µä¸‹,æ¥è¾¾åˆ°ç»™ç±»/å‡½æ•°åŠ å…¥ä¸€äº›æ–°åŠŸèƒ½ã€‚</p><p>è£…é¥°å™¨å¯ä»¥ä½œç”¨äºç±»æˆ–è€…ç±»çš„æˆå‘˜å±æ€§/æ–¹æ³•ä¸Š,ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸¤æ®µä»£ç æ¥åˆ†åˆ«è§£é‡Š:</p><pre><code>//  ä½œç”¨äºç±»/** * éœ€æ±‚: * å°è£…4ä¸ªæ–¹æ³•,åˆ†åˆ«å®ç°åŠ å‡ä¹˜é™¤å››ä¸ªåŠŸèƒ½ * é€šè¿‡è£…é¥°å™¨ç»™ç±»æ·»åŠ è¿™å››ä¸ªæ–¹æ³•,å¹¶ä¸”å¯æŒ‡å®šæ˜¯å¦ä½œä¸ºç±»çš„é™æ€æ–¹æ³•æ·»åŠ  **///  åŠ å‡ä¹˜é™¤çš„å®ç°function add() {    return [].slice.call(arguments).reduce((a, b) =&gt; a + b);}function reduce() {    return [].slice.call(arguments).reduce((a, b) =&gt; a - b);}function mul() {    return [].slice.call(arguments).reduce((a, b) =&gt; a * b);}function div() {    return [].slice.call(arguments).reduce((a, b) =&gt; a / b);}@bindCal(add, true)@bindCal(reduce, true)@bindCal(mul, false)@bindCal(div, false)class MyMath {}</code></pre><p>ä¸Šé¢æˆ‘ä»¬å®Œæˆäº†éœ€æ±‚ä¸­çš„å››ä¸ªå‡½æ•°çš„å°è£…ä»¥åŠå¯¹MyMathç±»åº”ç”¨äº†è£…é¥°å™¨,ä¸‹é¢æˆ‘ä»¬å°±æ¥å®ç°è¿™ä¸ªè£…é¥°å™¨:</p><pre><code>/** * @param    {Function}   method    æŒ‡å‘éœ€è¦è¢«æ·»åŠ æ–¹æ³•çš„æŒ‡é’ˆ * @param    {String}     isStatic  æ˜¯å¦æ·»åŠ ä¸ºé™æ€å±æ€§,é»˜è®¤ä¸ºtrue * @return   {Function} */function bindCal(method, isStatic = true) {    //  è·å–åˆ°æ–¹æ³•å    const {name} = method;    //  å½“ä½œç”¨äºç±»ä¸Šæ—¶,ä¼šè¿”å›ä¸€ä¸ªåŒ¿åå‡½æ•°,å°†ç±»çš„æ„é€ å‡½æ•°ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°    return function(target) {        //  è·å–ç±»çš„åŸå‹        const {prototype} = target;        //  æ·»åŠ ä¸ºåŸå‹å±æ€§(éé™æ€å±æ€§)        if (!isStatic) {            //  æ£€æµ‹è¦æ·»åŠ çš„å±æ€§æ˜¯å¦å­˜åœ¨            if (prototype[name]) {                throw `${prototype.name}.${name} already exits!`;            } else {                //  åˆ©ç”¨ES5ä¸­çš„Object.definePropertyæ¥æ·»åŠ ç›¸å…³å±æ€§                Object.defineProperty(target.prototype, name, {                    value: method                });            }        } else {            //  æ·»åŠ ä¸ºé™æ€å±æ€§            //  æ£€æµ‹è¦æ·»åŠ çš„å±æ€§æ˜¯å¦å­˜åœ¨            if (target[name]) {                throw `${target}.${name} already exits!`;            }            //  åˆ©ç”¨ES5ä¸­çš„Object.definePropertyæ¥æ·»åŠ ç›¸å…³å±æ€§            Object.defineProperty(target, name, {                value: method            });        }        //  è¿”å›ç±»çš„æ„é€ å™¨        return target;    }}</code></pre><p>æˆ‘ä»¬æŠŠaddå’Œreduceä½œä¸ºé™æ€æ–¹æ³•æ·»åŠ ç»™MyMathç±»,æŠŠmulå’Œdivä½œä¸ºåŸå‹æ–¹æ³•ç»™äº†MyMathç±»,æ‰€ä»¥è°ƒç”¨åº”è¯¥çœ‹èµ·æ¥åƒä¸‹é¢çš„æ ·å­:</p><pre><code>const math = new MyMath();console.log(MyMath.add(1, 2, 3, 4));        //  10console.log(MyMath.reduce(1, 2, 3, 4));     //  -8console.log(math.mul(1, 2, 3, 4));          //  24console.log(math.div(10000, 1000, 10, 5));  //  0.2</code></pre><p>ä¸Šé¢å°±æ˜¯æˆ‘ä»¬åœ¨ç±»ä¸Šåº”ç”¨è£…é¥°å™¨çš„ä¸€ä¸ªä¾‹å­,ä¸‹é¢å†ä¸€èµ·çœ‹ä¸‹å¦‚æœåœ¨æˆå‘˜å±æ€§/æ–¹æ³•ä¸Šåº”ç”¨æ„é€ å™¨çš„ä¾‹å­:</p><pre><code>/** * éœ€æ±‚: * å®ç°åœ¨ç±»ä¸­å¯ä»¥å†»ç»“æˆå‘˜å±æ€§(å¤–éƒ¨æ— æ³•ä¿®æ”¹,åªè¯») * å®ç°ä¿®æ”¹ç±»ä¸­æˆå‘˜æ–¹æ³•ä¸­çš„thisæŒ‡å‘ **///  å®ç°ä¸€ä¸ªç±»,å¹¶ä¸”å¯¹å…¶æˆå‘˜å±æ€§/æ–¹æ³•åº”ç”¨è£…é¥°å™¨ã€å®šä¹‰ä¸€ä¸ªå¯¹è±¡,ä½œä¸ºæˆå‘˜æ–¹æ³•ä¸­çš„thisæŒ‡å‘const obj = {    name: &quot;rwson&quot;,    age: 24,    sex: &quot;male&quot;,    job: &quot;web developer&quot;};class Context {    constructor() {    }    @readonly    version = &quot;1.0.0&quot;;    @bindContext(obj)    showContext() {        console.log(this);    }} </code></pre><p>ä¸Šé¢æˆ‘ä»¬å®Œæˆäº†å¯¹è£…é¥°å™¨åº”ç”¨è¿‡ç¨‹,ä¸‹é¢ä¸€èµ·çœ‹ä¸‹readonlyå’ŒbindContextä¸¤ä¸ªè£…é¥°å™¨çš„å®ç°:</p><pre><code>/** * @param    {Object}   target    å½“å‰ç±»çš„prototype * @param    {String}   key       å°†è¦è¢«è£…é¥°çš„å±æ€§å * @param    {Object}   decorator ES5ä¸­Object.definePropertyçš„æœ€åä¸€ä¸ªå‚æ•° * @return   {Object}   decorator */function readonly(target, key, decorator) {    decorator.configurable = false;    decorator.enumerable = false;    decorator.writable = false;    decorator.value = decorator.value;    return decorator;}/** * @param    {Object}   context    éœ€è¦ç»‘å®šæˆthisçš„å¯¹è±¡ * @return   {Function} */function bindContext(context) {    /**     * @param    {Object}   target    å½“å‰ç±»çš„prototype     * @param    {String}   key       å°†è¦è¢«è£…é¥°çš„å±æ€§å     * @param    {Object}   decorator ES5ä¸­Object.definePropertyçš„æœ€åä¸€ä¸ªå‚æ•°     * @return   {Object}   decorator     */    return function(target, key, decorator) {        if (typeof context === &quot;undefined&quot;) {            context = target;        }        decorator.value = decorator.value.bind(context);        return decorator;    }}</code></pre><p>å¥½äº†ä¸Šé¢å°±æ˜¯æˆ‘ä»¬çš„ä¸¤ä¸ªä½œç”¨äºæˆå‘˜å±æ€§/æ–¹æ³•ä¸Šçš„è£…é¥°å™¨,ä¸‹é¢ä¸€èµ·æ¥çœ‹ä¸‹ç®€å•çš„è°ƒç”¨å§:</p><pre><code>const context = new Context();context.showContext();          //  æ‰“å°å‡ºåˆšæ‰å®šä¹‰çš„objå¯¹è±¡context.version = &quot;1.1.0&quot;;      //  æŠ›å‡ºå¼‚å¸¸ Uncaught TypeError: Cannot assign to read only property &apos;version&apos; of object &apos;#&lt;Context&gt;&apos;</code></pre><p>å¥½äº†,ä¸Šé¢å°±è£…é¥°å™¨çš„å‡ ç§ç”¨æ³•å’Œå®ç°,æˆ‘ä»¬å¯èƒ½ä¼šå‘ç°åˆšæ‰åœ¨å®šä¹‰è£…é¥°å™¨å‡½æ•°çš„æ—¶å€™,å½“è¯¥è£…é¥°å™¨ä½œç”¨äºç±»ä¸Šçš„æ—¶å€™è¿”å›å‡ºçš„åŒ¿åå‡½æ•°éƒ½æ˜¯ä¸€ä¸ªå‚æ•°;è€Œä½œç”¨äºæˆå‘˜å±æ€§æˆ–è€…æˆå‘˜æ–¹æ³•ä¸Šçš„,éƒ½æ˜¯ä¸‰ä¸ªå‚æ•°,è¿™åˆæ˜¯ä¸ºå•¥å‘¢?</p><p>ä¸€èµ·æ¥åˆ†æä¸‹ç¼–è¯‘åçš„ä»£ç :</p><pre><code>/** * @param    {Object}               target     å½“å‰ç±»çš„prototype * @param    {String}               property   å°†è¦è¢«è£…é¥°çš„å±æ€§å * @param    {Array.&lt;Function&gt;}       decorators è£…é¥°å™¨å‡½æ•°åˆ—è¡¨ * @param    {Object}               descriptor ES5ä¸­Object.definePropertyçš„æœ€åä¸€ä¸ªå‚æ•° * @param    {[type]}   context    [description] * @return   {[type]}              [description] * @private */function _applyDecoratedDescriptor(target, property, decorators, descriptor, context) {    //    å±æ€§å¯¹è±¡    var desc = {};    //    Object[&quot;keys&quot;]    -&gt; [&quot;value&quot;, &quot;writable&quot;, &quot;enumerable&quot;, &quot;configurable&quot;]    //    æŠŠES5ä¸­Object.definePropertyçš„æœ€åä¸€ä¸ªå‚æ•°çš„å±æ€§å˜æˆå¤–éƒ¨æŒ‡å®šçš„    Object[&apos;ke&apos; + &apos;ys&apos;](descriptor).forEach(function (key) {        desc[key] = descriptor[key];    });    desc.enumerable = !!desc.enumerable;    desc.configurable = !!desc.configurable;    if (&apos;value&apos; in desc || desc.initializer) {        desc.writable = true;    }    desc = decorators.slice().reverse().reduce(function (desc, decorator) {        return decorator(target, property, desc) || desc;    }, desc);    if (context &amp;&amp; desc.initializer !== void 0) {        desc.value = desc.initializer ? desc.initializer.call(context) : void 0;        desc.initializer = undefined;    }    //    åˆ©ç”¨Object.definePropertyå®šä¹‰å±æ€§    if (desc.initializer === void 0) {        Object[&apos;define&apos; + &apos;Property&apos;](target, property, desc);        desc = null;    }    //    è¿”å›å½“å‰å±æ€§å¯¹è±¡    return desc;}</code></pre><p>å¯ä»¥çœ‹å‡ºå…¶å®decoratoræœ€åä¹Ÿæ˜¯é€šè¿‡Object.definePropertyå®ç°çš„,æ‰€ä»¥å‚æ•°å’ŒObject.definePropertyæ˜¯ä¸€è‡´çš„ã€‚</p><p>é‚£æ—¥å¸¸å¼€å‘ä¸­,æˆ‘ä»¬å¯èƒ½éœ€è¦å€ŸåŠ©babelæ¥å¯¹å¸¦æœ‰decoratorçš„ä»£ç è¿›è¡Œç¼–è¯‘,é¦–å…ˆæˆ‘ä»¬éœ€è¦å®‰è£…babel:</p><pre><code>npm install babel -g</code></pre><p>ç„¶ååˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•è¿è¡Œ:</p><pre><code>npm install babel-plugin-transform-decorators-legacy --save-dev</code></pre><p>ç„¶ååˆ›å»º.babelrcé…ç½®æ–‡ä»¶,åœ¨pluginsé€‰é¡¹ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®:</p><pre><code>//  ...&quot;plugins&quot;: [    &quot;transform-decorators-legacy&quot;]//  ...</code></pre><p>æœ€åæˆ‘ä»¬å°±å¯ä»¥ç¼–è¯‘ä¹‹å‰å†™çš„ä»£ç äº†:</p><pre><code>babel decorator.js &gt; decorator.es5.js</code></pre>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;éšç€å‰ç«¯æŠ€æœ¯çš„å‘å±•,è¶Šæ¥è¶Šå¤šäººæŠŠES6ã€7ç”¨åœ¨æ—¥å¸¸å¼€å‘ä¸­,åœ¨ES7ä¸­é™¤äº†å¹¿ä¸ºäººçŸ¥çš„async/awaitä¹‹å¤–,è¿˜æœ‰ä¸€å¤§ç‰¹æ€§ â€” decorator(è£…é¥°å™¨)ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨ä¹‹å‰åŸç”Ÿjavascriptè®¾è®¡æ¨¡å¼ä¸­çš„ä¸€ç¯‡æ–‡ç« (&lt;a href=&quot;http://rwson.gi
      
    
    </summary>
    
      <category term="javascript" scheme="http://yoursite.com/categories/javascript/"/>
    
      <category term="ES7" scheme="http://yoursite.com/categories/javascript/ES7/"/>
    
      <category term="decorator" scheme="http://yoursite.com/categories/javascript/ES7/decorator/"/>
    
    
  </entry>
  
  <entry>
    <title>å®ç°ä¸€ä¸ªæ‹·è´æ–‡ä»¶å¤¹ä»¥åŠæ–‡ä»¶å¤¹ä¸‹æ‰€æœ‰æ–‡ä»¶çš„æ–¹æ³•</title>
    <link href="http://yoursite.com/2017/01/20/2017-01-20-copy-a-directory-and-files-under-it/"/>
    <id>http://yoursite.com/2017/01/20/2017-01-20-copy-a-directory-and-files-under-it/</id>
    <published>2017-01-19T16:00:00.000Z</published>
    <updated>2017-03-30T12:19:21.000Z</updated>
    
    <content type="html"><![CDATA[<p>å®ç°è¿™ä¸ªæ–¹æ³•ä¾èµ–äº†<a href="https://www.npmjs.com/package/fs-extra" target="_blank" rel="external">fs-extra</a>æ¨¡å—,å®ç°ç›®çš„æ˜¯ä¸ºäº†ä¸€ä¸ªæ–¹æ³•æ‹·è´æ‰€æœ‰å½“å‰ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶,å…·ä½“å®ç°å¦‚ä¸‹:</p><pre><code>let fs = require(&quot;fs-extra&quot;);/** * æ‰¹é‡æ‹·è´æ–‡ä»¶ * @param src           æºç›®å½•          String * @param target        ç›®æ ‡ç›®å½•        String * @param filetypes     æ–‡ä»¶ç±»å‹        RegExp * @param ignorefiles   å¿½ç•¥æ–‡ä»¶åˆ—è¡¨    Array **/fs.copyAllFiles = (src, target, filetypes, ignorefiles) =&gt; {    let argus = arguments,        readSrc = src,        targetSrc = target,        fileSrc, targeFileSrc;    fs.readdir(readSrc, (ex, files) =&gt; {        if (files.length) {            files.forEach((file) =&gt; {                //  å½“å‰æ–‡ä»¶ä¸åœ¨å¿½ç•¥åˆ—è¡¨ä¸­                if (!(~ignoreFiles.indexOf(file))) {                    fileSrc = path.resolve(readSrc, file);                    if (filetypes.test(file)) {                        targeFileSrc = path.resolve(targetSrc, file);                        fs.copySync(fileSrc, targeFileSrc);                    } else {                        targeFileSrc = path.resolve(targetSrc, file);                        fs.copySync(fileSrc, targeFileSrc);                        //  é€’å½’æ‹·è´ä¸‹ä¸€çº§ç›®å½•                        fs.copyAllFiles.call(fileSrc, targeFileSrc, filetypes, ignorefiles);                    }                }            });        }    });};</code></pre><p>ä¸Šé¢çš„å°±æ˜¯è¦å®ç°çš„æ–¹æ³•,è°ƒç”¨çš„æ–¹æ³•å°±çœ‹èµ·æ¥åƒä¸‹é¢çš„æ ·å­:</p><pre><code>const ignoreFiles = [&quot;.DS_Store&quot;, &quot;.idea&quot;, &quot;.git&quot;, &quot;.svn&quot;];fs.copyAllFiles(&quot;a&quot;, &quot;b&quot;, /\.jpe?g|\.png/, ignoreFiles);</code></pre>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;å®ç°è¿™ä¸ªæ–¹æ³•ä¾èµ–äº†&lt;a href=&quot;https://www.npmjs.com/package/fs-extra&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;fs-extra&lt;/a&gt;æ¨¡å—,å®ç°ç›®çš„æ˜¯ä¸ºäº†ä¸€ä¸ªæ–¹æ³•æ‹·è´æ‰€æœ‰å½“å‰ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶,å…·ä½“å®ç°å¦‚ä¸‹:&lt;
      
    
    </summary>
    
      <category term="nodejs" scheme="http://yoursite.com/categories/nodejs/"/>
    
      <category term="æ–‡ä»¶æ“ä½œ" scheme="http://yoursite.com/categories/nodejs/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C/"/>
    
    
  </entry>
  
  <entry>
    <title>å®ç°ä¸€ä¸ªwebpack loader</title>
    <link href="http://yoursite.com/2017/01/18/2017-01-18-wrire-a-webpack-loader/"/>
    <id>http://yoursite.com/2017/01/18/2017-01-18-wrire-a-webpack-loader/</id>
    <published>2017-01-17T16:00:00.000Z</published>
    <updated>2017-03-30T12:19:21.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨React,ES6å¼€å‘æ¨¡å¼è¶Šæ¥è¶Šæ™®åŠçš„ä»Šå¤©,webpackå°±æˆäº†å‰ç«¯æ„å»ºçš„ä¸€ä¸ªæ ‡é…ã€‚webpackæœ‰ä¸¤å¤§é‡è¦éƒ¨åˆ†ç»„æˆ: loaderå’Œpluginã€‚loaderæ˜¯ç”¨åœ¨åº”ç”¨æºç ä¸Šçš„è½¬æ¢åŸä»¶,æ¯”å¦‚æœ€å¸¸ç”¨åˆ°çš„babel-loader/jsx-loader/file-loader/css-loader/url-loaderç­‰ç­‰ã€‚</p><p>loaderå¯é“¾å¼æ‰§è¡Œ,ä¸€ç§æ–‡ä»¶ç±»å‹å¯ä»¥ç”¨å¤šä¸ªloader(æ¯”å¦‚cssæ–‡ä»¶,å¯èƒ½å°±éœ€è¦ç”¨åˆ°css-loaderå’Œstyle-loader),loaderä¹‹é—´ç”¨â€!â€åˆ†éš”,å½“å‰loaderå¤„ç†å®Œ,æŠŠå¤„ç†ç»“æœå¸¦åˆ°ä¸‹ä¸€ä¸ªloader,æœ€åä¸€ä¸ªloaderè¿”å›ä¸€ä¸ªStringæˆ–è€…String Bufferè¿”å›ç»™compilerã€‚</p><p>loaderè°ƒç”¨æ–¹å¼å¤§ä½“æœ‰3ç§å½¢å¼:</p><ol><li><p>å¼•ç”¨æ—¶è°ƒç”¨</p><pre><code>//  a.jsrequire(&quot;style-loader/url!css-loader!./xxx.css&quot;);</code></pre></li><li><p>webpackç›´æ¥è°ƒç”¨</p><pre><code>//  webpack.config.js//  ...module: {    loaders: [        //  ...        {            test: /\.css$/,            loader: &quot;style-loader!css-loader&quot;        }    ]}</code></pre></li><li><p>æŒ‡å®šloadersæ•°ç»„</p><pre><code>//  webpack.config.js//  ...module: {    loaders: [        //  ...        {            test: /\.css$/,            loaders: [                &quot;style-loader&quot;,                &quot;css-loader&quot;            ]        }    ]}</code></pre></li></ol><p>webpackå®˜ç½‘ä¸Šè¯´â€A loader is a node module exporting a functionâ€,ä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªloaderå°±æ˜¯ä¸€ä¸ªæš´éœ²å‡ºå»çš„nodeæ¨¡å—,æ—¢ç„¶æ˜¯ä¸€ä¸ªnode module,ä¹Ÿå°±åŸºæœ¬å¯ä»¥å†™æˆä¸‹é¢çš„æ ·å­:</p><pre><code>module.exports = function() {    //  ...};</code></pre><p>éœ€è¦æ³¨æ„çš„æ˜¯,åœ¨è¯¥æ¨¡å—è¢«è°ƒç”¨æ—¶,ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ–‡ä»¶çš„å†…å®¹,æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å†æ”¹æ”¹:</p><pre><code>/** * @param content  å°†è¢«å¤„ç†çš„å†…å®¹ * **/module.exports = function(content) {    //  ...    //  è¿è¡Œä¸‹ä¸€ä¸ªloader    this.callback(content);};</code></pre><p>çŸ¥é“äº†å¤§ä½“å†™æ³•,ç°åœ¨æˆ‘ä»¬å°±æ¥å®ç°ä¸€ä¸ªç®€å•çš„loader,ä¸»è¦åŠŸèƒ½å°±æ˜¯æŠŠcssä¸­çš„pxå•ä½è½¬æ¢æˆremå•ä½</p><pre><code>//  px2rem-loader/index.js&quot;use strict&quot;;//  ç”¨æ¥è·å–è°ƒç”¨loaderæ—¶ä¼ å…¥çš„å‚æ•°ç­‰ç­‰var loaderUtils = require(&quot;loader-utils&quot;);//  cssè§£ææ¨¡å—var css = require(&quot;css&quot;);//  ä¹˜é™¤æ¨¡å—,é˜²æ­¢åœ¨è®¡ç®—ä¸­å‡ºç°ç²¾åº¦ä¸¢å¤±çš„é—®é¢˜var privateMath = {    mul: function(num1, num2) {        var m = 0,            s1 = num1.toString(),            s2 = num2.toString();        try {            m += s1.split(&quot;.&quot;)[1].length        } catch (e) {}        try {            m += s2.split(&quot;.&quot;)[1].length        } catch (e) {}        return Number(s1.replace(&quot;.&quot;, &quot;&quot;)) * Number(s2.replace(&quot;.&quot;, &quot;&quot;)) / Math.pow(10, m);    },    div: function(num1, num2) {        var t1, t2, r1, r2;        try {            t1 = num1.toString().split(&apos;.&apos;)[1].length;        } catch (e) {            t1 = 0;        }        try {            t2 = num2.toString().split(&quot;.&quot;)[1].length;        } catch (e) {            t2 = 0;        }        r1 = Number(num1.toString().replace(&quot;.&quot;, &quot;&quot;));        r2 = Number(num2.toString().replace(&quot;.&quot;, &quot;&quot;));        return (r1 / r2) * Math.pow(10, t2 - t1);    }};module.exports = function(content) {    //  æŠŠå½“æˆcsså†…å®¹è§£ææˆASTå¯¹è±¡    var contentAST = css.parse(content);    //  ä½¿ç”¨loaderæ—¶çš„queryString(ç›¸å…³å‚æ•°)    var query = loaderUtils.parseQuery(this.query);    //  æœ€å°pxå€¼,å½“æ•°ç»„å°äºå®ƒæ˜¯å¿½ç•¥è®¡ç®—    var minSize = query.minSize || 1;    //  åŸºæ•°(æœ€åè®¡ç®—å‡ºçš„ç»“æœ = (åŸå…ˆçš„å¤§å° / base / scale) + &quot;rem&quot;)    var base = query.base || 37.5;    //  å¿½ç•¥çš„æ ·å¼è§„åˆ™åç§°    var ignore = query.ignore.length ? query.ignore.split(&quot;|&quot;) : [];    //  ç¼©æ”¾æ¯”    var scale = query.scale || 1;    //  åŒ¹é…10pxæˆ–è€…10.5pxè¿™ç§å•ä½    var pxUnitReg = /\d+[\.{1}\d+]?px/gi;    var tmp;    //  éå†æ ·å¼æ ‘    contentAST.stylesheet.rules.forEach(function(rule) {        //  éå†æ ·å¼è¡¨        rule.declarations.forEach(function(style) {            if (ignore.indexOf(style.property) &lt; 0) {                style.value = style.value.replace(pxUnitReg, function(match) {                    tmp = parseFloat(match);                    if(tmp &gt; minSize) {                        return privateMath.div(tmp, privateMath.mul(base, scale)) + &quot;rem&quot;;                    }                });            }        });    });    //  å†æŠŠå¤„ç†å¥½çš„ASTå¯¹è±¡è½¬æˆcss String    content = css.stringify(contentAST);    //  è°ƒç”¨ä¸‹ä¸€ä¸ªloader    this.callback(null, content);};</code></pre><p>åˆ°è¿™é‡Œ,ä¸€ä¸ªç®€å•çš„loadå°±ç®—å®ç°äº†,ä¸€èµ·æ¥çœ‹ä¸‹è°ƒç”¨æŠŠ:</p><pre><code>//  webpack.config.jsconst webpack = require(&quot;webpack&quot;);module.exports = {    entry: &quot;./src/js/entry.js&quot;,    output: {        path: __dirname,        filename: &quot;build/bundle.js&quot;    },    module: {        loaders: [{            test: /\.js$/,            loader: &apos;babel-loader?presets[]=es2015&apos;        }, {            test: /\.css$/,            loader: &apos;style-loader!css-loader!px2rem-loader?base=37.5&amp;scale=2&amp;minSize=1&amp;ignore=border|margin|padding&apos;        }]    },    plugins: [    ]};</code></pre><p>ä¹‹å‰çš„css:</p><p><img src="/imgs/webpack-loader-1.png" alt=""></p><p>æ‰“åŒ…ä¹‹å:</p><p><img src="/imgs/webpack-px-2rem-compiled.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨React,ES6å¼€å‘æ¨¡å¼è¶Šæ¥è¶Šæ™®åŠçš„ä»Šå¤©,webpackå°±æˆäº†å‰ç«¯æ„å»ºçš„ä¸€ä¸ªæ ‡é…ã€‚webpackæœ‰ä¸¤å¤§é‡è¦éƒ¨åˆ†ç»„æˆ: loaderå’Œpluginã€‚loaderæ˜¯ç”¨åœ¨åº”ç”¨æºç ä¸Šçš„è½¬æ¢åŸä»¶,æ¯”å¦‚æœ€å¸¸ç”¨åˆ°çš„babel-loader/jsx-loader/file-loader
      
    
    </summary>
    
      <category term="javascript" scheme="http://yoursite.com/categories/javascript/"/>
    
      <category term="æ„å»ºå·¥å…·" scheme="http://yoursite.com/categories/javascript/%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7/"/>
    
      <category term="webpack" scheme="http://yoursite.com/categories/javascript/%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7/webpack/"/>
    
    
  </entry>
  
  <entry>
    <title>Shadow DOMç ”ç©¶</title>
    <link href="http://yoursite.com/2016/12/12/2016-12-12-chrome-shadow-dom-tourial/"/>
    <id>http://yoursite.com/2016/12/12/2016-12-12-chrome-shadow-dom-tourial/</id>
    <published>2016-12-11T16:00:00.000Z</published>
    <updated>2017-02-11T03:55:27.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨<a href="https://github.com/Polymer/polymer" target="_blank" rel="external">Polymer</a>ä¸­,æå‡ºäº†<a href="https://developer.mozilla.org/zh-CN/docs/Web/Web_Components" target="_blank" rel="external">Web Component</a>çš„æ¦‚å¿µ,æ—¨åœ¨è®©å¼€å‘è€…å¯ä»¥å°è£…å‡ºå¾ˆå¤šå¯å¤ç”¨çš„ç»„ä»¶ã€‚ç°åœ¨,webkitæ·»åŠ äº†å¯¹è¯¥APIæ”¯æŒ,ä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬ä¸ç”¨å€ŸåŠ©æ¡†æ¶,ä¹Ÿå¯ä»¥è‡ªå·±å°è£…å‡ºå¯å¤ç”¨çš„ç»„ä»¶(é€šè¿‡è‡ªå®šä¹‰å…ƒç´ çš„å½¢å¼),è€Œä¸éœ€è¦ä¾èµ–å…¶ä»–æ¡†æ¶æ¥å®ç°ã€‚</p><p>å‡è®¾æˆ‘ä»¬è¿™è¾¹éœ€è¦å°è£…ä¸€ä¸ªè¿›åº¦æ¡ç»„ä»¶,å®ç°ä»£ç å¤§æ¦‚æ˜¯è¿™æ ·çš„:</p><pre><code>//  javascriptclass CustomProgressBar extends HTMLElement {    constructor(args) {        super(args);        //  createShadowRootç”¨æ¥åˆ›å»ºä¸€ä¸ªshadowDOMå®ä¾‹        const shadowRoot = this.createShadowRoot();        //  è®¾ç½®ç»„ä»¶å†…çš„å¸ƒå±€ç»“æ„å’Œæ ·å¼        shadowRoot.innerHTML = `            &lt;style type=&quot;text/css&quot;&gt;                :host {                    display: inline-block;                    width: 200px;                    height: 30px;                    box-sizing: border-box;                    padding: 1px;                }                :host * {                    -webkit-touch-callout: none;                    -webkit-user-select: none;                    -khtml-user-select: none;                    -moz-user-select: none;                    -ms-user-select: none;                    user-select: none;                }                .progress {                    display: inline-block;                    width: 200px;                    height: 30px;                    position: relative;                    border: 1px solid #000;                }                .progress &gt; .bar {                    background: red;                    height: 100%;                    width: 0;                    transition: all 0.2s;                }                .progress .label {                    position: absolute;                    top: 0;                    left: 0;                    width: 100%;                    text-align: center;                    font-size: 14px;                    line-height: 30px;                    color: #000;                }            &lt;/style&gt;            &lt;div class=&quot;progress&quot; aria-valuenow=&quot;0&quot; aria-valuemin=&quot;0&quot; aria-valuemax=&quot;100&quot;&gt;                &lt;div class=&quot;bar&quot;&gt;&lt;/div&gt;                &lt;div class=&quot;label&quot;&gt;0%&lt;/div&gt;            &lt;/div&gt;        `;        //  å°†ç›¸å…³å…ƒç´ å­˜å‚¨åˆ°æˆå‘˜å˜é‡ä¸­        this._progressElement = shadowRoot.querySelector(&quot;.progress&quot;);        this._bar = shadowRoot.querySelector(&quot;.bar&quot;);        this._label = shadowRoot.querySelector(&quot;.label&quot;);    }    /**     * å–å¾—å½“å‰è¿›åº¦     * @return {string}     */    get progress() {        return Number(this._progressElement.getAttribute(&quot;aria-valuenow&quot;));    }    /**     * è®¾ç½®è¿›åº¦     * @param value     */    set progress(value) {        //  æœ€å¤§å€¼å€¼æœ€å°å€¼        const max = this._progressElement.getAttribute(&quot;aria-valuemax&quot;),              min = this._progressElement.getAttribute(&quot;aria-valuemin&quot;);        //  ç±»å‹åˆ¤æ–­        if(Number.isNaN(Number(value))) {            throw new Error(`value must be an number type, you specified ${value} which is ${{}.toString.call(value).slice(8, -1).toLowerCase()}!`);        }        //  èŒƒå›´æ£€æµ‹        if(value &gt; max || value &lt; min) {            throw new Error(`value must between ${min} to ${max} , you specified ${value}!`);        }        //  è®¾ç½®ç›¸å…³å±æ€§        this._progressElement.setAttribute(&quot;aria-valuenow&quot;, value);        this._bar.style.width = `${value}%`;        this._label.textContent = `${value}%`;    }    /**     * æä¾›å¯ä»¥ç»‘å®šonclickçš„æ¥å£     * @param callback     */    set onclick(callback) {        if(typeof callback === &quot;function&quot;) {            this._progressElement.addEventListener(&quot;click&quot;, e =&gt; {                callback.call(this, e);            }, false);        }    }}//  è°ƒç”¨ customElements.defineå®šä¹‰è‡ªå®šä¹‰å…ƒç´ ,ç¬¬ä¸€ä¸ªå‚æ•°è‡ªå®šä¹‰å…ƒç´ å,ç¬¬äºŒä¸ªå‚æ•°æ˜¯HTMLElementçš„ä¸€ä¸ªå­ç±»customElements.define(&quot;custom-progress-bar&quot;, CustomProgressBar);window.onload = () =&gt; {    let customProgressBar = document.querySelector(&quot;custom-progress-bar&quot;),        progress;    /**     * ç»™è¿›åº¦æ¡ç»„ä»¶ç»‘å®šonclickäº‹ä»¶,æ¯æ¬¡ç‚¹å‡»è¿›åº¦åŠ 10     * @param e     */    customProgressBar.onclick = (e) =&gt; {        progress = Number(this.progress);        if(progress &gt;= 100) {            progress = 0;        } else {            progress += 10;        }        this.progress = progress;    };};//  HTML//  ç°åœ¨æˆ‘ä»¬å¯ä»¥é€šè¿‡new CustomProgressBar()æˆ–è€…custom-progress-baræ¥ä½¿ç”¨è‡ªå®šä¹‰å…ƒç´ äº†&lt;custom-progress-bar&gt;&lt;/custom-progress-bar&gt;</code></pre><p>è‡³æ­¤æˆ‘ä»¬çš„ä¸€ä¸ªè¿›åº¦æ¡ç»„ä»¶å°±ç®—å°è£…å®Œæˆäº†,éœ€è¦æ³¨æ„çš„æ˜¯,customElements.defineæ–¹æ³•å¯¹ç¬¬ä¸€ä¸ªå‚æ•°æœ‰ä¸€äº›è¦æ±‚:</p><ul><li>å¿…é¡»ä»¥å°å†™å­—æ¯ a-z å¼€å¤´</li><li>ä¸èƒ½åŒ…å«å¤§å†™å­—æ¯ A-Z</li><li>å¿…é¡»åŒ…å«â€-â€œ</li></ul><p>æœ€åæ¸²æŸ“å‡ºæ¥æ˜¯å¦‚ä¸‹çš„å¸ƒå±€ç»“æ„:</p><p><img src="/imgs/shadow-dom-rendered.png" alt=""></p><p>ä¸€èµ·çœ‹çœ‹å®é™…çš„æ•ˆæœ:</p><p><img src="/imgs/shadow-dom-gif.gif" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨&lt;a href=&quot;https://github.com/Polymer/polymer&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Polymer&lt;/a&gt;ä¸­,æå‡ºäº†&lt;a href=&quot;https://developer.mozilla.org/zh-CN
      
    
    </summary>
    
      <category term="javascript" scheme="http://yoursite.com/categories/javascript/"/>
    
      <category term="Shadow DOM" scheme="http://yoursite.com/categories/javascript/Shadow-DOM/"/>
    
      <category term="Web Component" scheme="http://yoursite.com/categories/javascript/Shadow-DOM/Web-Component/"/>
    
    
  </entry>
  
  <entry>
    <title>Gulpæ’ä»¶çš„ç ”ç©¶</title>
    <link href="http://yoursite.com/2016/11/29/2016-11-29-gulp-plugin-tourial/"/>
    <id>http://yoursite.com/2016/11/29/2016-11-29-gulp-plugin-tourial/</id>
    <published>2016-11-28T16:00:00.000Z</published>
    <updated>2017-03-30T12:19:21.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ç½‘é¡µç«¯åŠŸèƒ½è¶Šæ¥è¶Šç¹æ‚çš„ä»Šå¤©,éšç€åŠŸèƒ½çš„å¢å¤š,ä»£ç é‡ä¹Ÿå¿…ä¸å¯å°‘çš„å¤šä¸ª,ä»£ç é‡ä¸€å¤š,webæ€§èƒ½å°±æ˜¾å¾—å°¤ä¸ºé‡è¦,å°¤å…¶æ˜¯åŠ è½½æ–¹é¢,æ—¶é—´å¤ªé•¿,å¯èƒ½ç”¨æˆ·å°±æ²¡å¿ƒæƒ…ç­‰ä¸‹å»,æ‰€ä»¥ç°åœ¨çš„webé¡¹ç›®ä¸€èˆ¬éƒ½åœ¨å‘å¸ƒçš„æ—¶å€™è¿›è¡Œä¸€ç‰ˆè‡ªåŠ¨æ„å»º,ä»åŸæ¥çš„gruntåˆ°gulp,å†åˆ°ç°åœ¨çš„webpackã€‚</p><p>ä»Šå¤©ç ”ç©¶äº†ä¸‹gulpæ’ä»¶,å†™ç‚¹å¿ƒå¾—ä½“ä¼šå§ã€‚çœ‹äº†ä¸¤ä¸ªgulpæ’ä»¶æºç ,å‘ç°é‡Œé¢éƒ½å¼•å…¥äº†<a href="https://github.com/rvagg/through2" target="_blank" rel="external">through2</a>è¿™ä¸ªåŒ…,å®˜æ–¹çš„è¯´æ³•å°±æ˜¯â€Node Streamçš„ç®€å•å°è£…ï¼Œç›®çš„æ˜¯è®©é“¾å¼æµæ“ä½œæ›´åŠ ç®€å•;â€,å°±ä¹Ÿç…§è‘«èŠ¦ç”»ç“¢,å¼•ç”¨äº†è¿™ä¸ªåŒ…,ç®€å•å®ç°ä¸€ä¸ªgulpæ’ä»¶,åŠŸèƒ½å°±æ˜¯å‹ç¼©css,å¹¶ä¸”æŠŠcssä¸­çš„â€background: url(xxxx.png)â€ä¸­çš„â€xxxx.pngâ€è½¬æ¢æˆbase64ç¼–ç çš„å½¢å¼,å‡å°‘httpè¯·æ±‚æ•°ã€‚</p><pre><code>&quot;use strict&quot;;const through = require(&quot;through2&quot;),    path = require(&quot;path&quot;),    fs = require(&quot;fs&quot;),    //  å¼•ç”¨async/await,æ–¹ä¾¿å¤„ç†æ–‡ä»¶è¯»å†™çš„å¼‚æ­¥æ“ä½œ    async = require(&quot;asyncawait&quot;).async,    await = require(&quot;asyncawait&quot;).await,    //  åŒ¹é…url(../xxx.yyy)è¿™ç§è¡¨è¾¾å¼    imgReg = /url\s*\((\s*[A-Za-z0-9\-\_\.\/\:]+\s*)\);?/gi,    //  å°†fs.readFileå°è£…æˆPromise    readFile = (path) =&gt; {        return new Promise((resolve, reject) =&gt; {            fs.readFile(path, (ex, file) =&gt; {                if (ex) {                    reject(ex);                }                resolve(file);            });        });    };let base, contents, match, tmp, url;//  æš´éœ²å‡ºå»çš„å‡½æ•°module.exports = (opt) =&gt; {    return through.obj(function(file, enc, cb) {        //  æ–‡ä»¶ä¸ºç©ºç›´æ¥æ‰§è¡Œå›è°ƒå‡½æ•°        if (file.isNull()) {            cb(null, file);        }        //  å–å¾—å½“å‰cssçš„ç»å¯¹è·¯å¾„        base = file.base;        //  åŒ¹é…cssä¸­çš„æ— æ•ˆå­—ç¬¦,å¹¶ä¸”è½¬æ¢æˆbuffer        file.contents = new Buffer(file._contents.toString()            //  å»æ¢è¡Œç¬¦            .replace(/\n/gm, &quot;&quot;)            //  å»&quot;{&quot;ä¹‹ååˆ°ç¬¬ä¸€æ¡æ ·å¼é—´çš„ç©ºç™½å­—ç¬¦            .replace(/\{\s+/g, &quot;{&quot;)            //  å»&quot;;&quot;ä¹‹åçš„ç©ºç™½å­—ç¬¦            .replace(/\;\s+/g, &quot;;&quot;));        //  å°†æ–‡ä»¶å†…å®¹è½¬æ¢æˆæ™®é€šå­—ç¬¦ä¸²å¹¶ç¼“å­˜        contents = file.contents.toString();        //  å–å¾—url(../../xxx.yyy),å¹¶ä¸”ç¼“å­˜        match = contents.match(imgReg);        //  async-awaitè¯»å–å›¾ç‰‡æ–‡ä»¶æˆbase64ç¼–ç         async(() =&gt; {            //  éå†ä¹‹å‰çš„ç¼“å­˜é¡¹            match.forEach((item) =&gt; {                //  æ‹¼å‡‘æ–‡ä»¶ç»å¯¹è·¯å¾„                url = item.replace(&quot;url(&quot;, &quot;&quot;).replace(&quot;)&quot;, &quot;&quot;).trim();                //  ç”¨awaitè¯»å–æ–‡ä»¶,é¿å…åµŒå¥—                tmp = await (readFile(path.resolve(base, url)));                //  æ›¿æ¢ä¹‹å‰åŒ¹é…çš„å­—ç¬¦ä¸²                contents = contents.replace(item, `url(data:image/png;base64,${tmp.toString(&quot;base64&quot;)})`);            });            //  æŠŠæ–‡ä»¶å†…å®¹è½¬æˆbuffer            file.contents = new Buffer(contents);            //  å›è°ƒå‡½æ•°            cb(null, file);        })();    });};</code></pre><p>è‡³æ­¤,ä¸€ä¸ªç®€å•çš„æ’ä»¶å°±å®ç°äº†,å½“ç„¶,è¿˜æœ‰å¾ˆå¤šä¸è¶³,æ¯”å¦‚å¯¹å›¾ç‰‡è¿›è¡Œå‹ç¼©,å‡å°‘base64å­—ç¬¦ä¸²çš„é•¿åº¦,ç”¨requestæ¨¡å—å¤„ç†å¯¹ç½‘ç»œå›¾ç‰‡çš„å¼•ç”¨ç­‰ç­‰ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨ç½‘é¡µç«¯åŠŸèƒ½è¶Šæ¥è¶Šç¹æ‚çš„ä»Šå¤©,éšç€åŠŸèƒ½çš„å¢å¤š,ä»£ç é‡ä¹Ÿå¿…ä¸å¯å°‘çš„å¤šä¸ª,ä»£ç é‡ä¸€å¤š,webæ€§èƒ½å°±æ˜¾å¾—å°¤ä¸ºé‡è¦,å°¤å…¶æ˜¯åŠ è½½æ–¹é¢,æ—¶é—´å¤ªé•¿,å¯èƒ½ç”¨æˆ·å°±æ²¡å¿ƒæƒ…ç­‰ä¸‹å»,æ‰€ä»¥ç°åœ¨çš„webé¡¹ç›®ä¸€èˆ¬éƒ½åœ¨å‘å¸ƒçš„æ—¶å€™è¿›è¡Œä¸€ç‰ˆè‡ªåŠ¨æ„å»º,ä»åŸæ¥çš„gruntåˆ°gulp,å†åˆ°ç°åœ¨çš„webpackã€‚&lt;/
      
    
    </summary>
    
      <category term="javascript" scheme="http://yoursite.com/categories/javascript/"/>
    
      <category term="Gulp" scheme="http://yoursite.com/categories/javascript/Gulp/"/>
    
      <category term="æ„å»ºå·¥å…·" scheme="http://yoursite.com/categories/javascript/Gulp/%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7/"/>
    
    
  </entry>
  
  <entry>
    <title>javascriptæ¨¡å—åŒ–ç¼–ç¨‹-åŒæ­¥æ¨¡å¼</title>
    <link href="http://yoursite.com/2016/11/29/2016-11-23-js-sync-module-mode/"/>
    <id>http://yoursite.com/2016/11/29/2016-11-23-js-sync-module-mode/</id>
    <published>2016-11-28T16:00:00.000Z</published>
    <updated>2017-03-30T12:19:21.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨æ—¥å¸¸å¼€å‘ä¸­,ä¸ºäº†ä¾¿äºå¤šäººåä½œå¼€å‘,æˆ‘ä»¬é€šå¸¸éƒ½ä¼šé‡‡ç”¨æ¨¡å—åŒ–å¼€å‘çš„æ¨¡å¼,ä»Šå¤©çœ‹å¼ è£é“­çš„ã€Šjavascriptè®¾è®¡æ¨¡å¼ã€‹çš„æ—¶å€™,çœ‹åˆ°åŒæ­¥æ¨¡å¼è¿™ä¸€ç« ,ç»“åˆè‡ªå·±ä¹‹å‰çš„ç«‹å³,ä¹Ÿæ¥å®ç°ä¸€ä¸ªç®€å•çš„åŒæ­¥æ¨¡å—åŒ–æ¨¡å¼ã€‚</p><pre><code>const module = (() =&gt; {    //  ç¼“å­˜ä¹‹å‰å£°æ˜çš„æ¨¡å—    let modules = {};    /**     * [description]     * @param  deps     ä¾èµ–åˆ—è¡¨     * @return Array     */    let _loadDeps = (deps) =&gt; {        return deps.map((dep) =&gt; {            return modules[dep];        });    };    return {        /**         * å£°æ˜ä¸€ä¸ªæ¨¡å—         * @param   id      æ¨¡å—id         * @param   deps    ä¾èµ–æ•°ç»„(æ¨¡å—id)         * @param   factory æ„é€ å‡½æ•°         */        define: (id, deps, factory) =&gt; {            //  è·å–ä¾èµ–,å¹¶ä¸”å–å¾—æ¨¡å—è¿”å›çš„å¯¹è±¡            deps = _loadDeps(deps);            deps.map(function(dep) {                return dep.factory.apply(window, dep.deps);            });            //  åˆ¤æ–­æ¨¡å—åæ˜¯å¦é‡å¤            if (modules[id]) {                 throw new Error(&quot;module &quot; + id + &quot; has been declared!&quot;);            }            //  ç¼“å­˜æ¨¡å—            modules[id] = {                id: id,                factory: factory,                deps: deps            };        },        /**         * ä½¿ç”¨å®šä¹‰å¥½çš„æ¨¡å—         * @param   depArr  ä¾èµ–æ•°ç»„(æ¨¡å—id)         * @param   factory æ„é€ å‡½æ•°         */        use: (depArr, factory) =&gt; {            //  è·å–ä¾èµ–,å¹¶ä¸”å–å¾—æ¨¡å—è¿”å›çš„å¯¹è±¡            depArr = depArr.map((dep) =&gt; {                return modules[dep].factory.apply(window, modules[dep].deps);            });            //  è¿è¡Œæ„é€ å‡½æ•°            factory.apply(window, depArr);        }    };})();</code></pre><p>ä¸‹é¢æˆ‘ä»¬å£°æ˜å‡ ä¸ªæ¨¡å—åšæµ‹è¯•:</p><pre><code>//  Aæ¨¡å—module.define(&quot;A&quot;, [], () =&gt; {    return {        method: () =&gt; {            console.log(&quot;method under module A&quot;);        }    };});//  Bæ¨¡å—module.define(&quot;B&quot;, [], () =&gt; {    return {        method: () =&gt; {            console.log(&quot;method under module B&quot;);        }    };});//  Personç±»module.define(&quot;PersonClass&quot;, [], () =&gt; {    class Person {        constructor(name, age, sex, job) {            this.name = name;            this.age = age;            this.sex = sex;            this.job = job;        }        hello() {            console.log(&quot;hello &quot; + this.name);        }        eat() {            console.log(this.name + &quot; will eat&quot;);        }        getProfile() {            return {                name: this.name,                age: this.age,                sex: this.sex,                job: this.job            };        }    }    return Person;});</code></pre><p>æœ€åæˆ‘ä»¬è°ƒç”¨module.useæ¥ä½¿ç”¨è¿™äº›æ¨¡å—:</p><pre><code>module.use([&quot;A&quot;, &quot;B&quot;, &quot;PersonClass&quot;], (A, B, PersonClass) =&gt; {    A.method();    B.method();    let person = new PersonClass(&quot;rwson&quot;, 24, &quot;male&quot;, &quot;web developer&quot;);    person.hello();    setTimeout(function() {        person.eat();    }, 5000);    console.log(person.getProfile());});</code></pre><p>æœ€åæµè§ˆå™¨æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹å›¾çš„ç»“æœ:</p><p><img src="/imgs/sync-module-mode.png" alt="javascriptæ¨¡å—åŒ–-åŒæ­¥æ¨¡å¼"></p><p>è‡³æ­¤ä¸€ä¸ªç®€å•çš„æ¨¡å—åŒ–å·¥å…·å°±å¼€å‘å®Œæˆäº†ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨æ—¥å¸¸å¼€å‘ä¸­,ä¸ºäº†ä¾¿äºå¤šäººåä½œå¼€å‘,æˆ‘ä»¬é€šå¸¸éƒ½ä¼šé‡‡ç”¨æ¨¡å—åŒ–å¼€å‘çš„æ¨¡å¼,ä»Šå¤©çœ‹å¼ è£é“­çš„ã€Šjavascriptè®¾è®¡æ¨¡å¼ã€‹çš„æ—¶å€™,çœ‹åˆ°åŒæ­¥æ¨¡å¼è¿™ä¸€ç« ,ç»“åˆè‡ªå·±ä¹‹å‰çš„ç«‹å³,ä¹Ÿæ¥å®ç°ä¸€ä¸ªç®€å•çš„åŒæ­¥æ¨¡å—åŒ–æ¨¡å¼ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;const module = (() =&amp;g
      
    
    </summary>
    
      <category term="javascript" scheme="http://yoursite.com/categories/javascript/"/>
    
      <category term="æ¨¡å—åŒ–" scheme="http://yoursite.com/categories/javascript/%E6%A8%A1%E5%9D%97%E5%8C%96/"/>
    
    
  </entry>
  
  <entry>
    <title>ä¸€èµ·å†™ä¸€ä¸ªnpmå‘½ä»¤è¡Œå·¥å…·</title>
    <link href="http://yoursite.com/2016/11/20/2016-11-20-write-a-client/"/>
    <id>http://yoursite.com/2016/11/20/2016-11-20-write-a-client/</id>
    <published>2016-11-19T16:00:00.000Z</published>
    <updated>2017-09-22T03:17:53.000Z</updated>
    
    <content type="html"><![CDATA[<p>è‡ªä»nodejsé—®ä¸–ä¹‹åï¼Œéšç€å‰ç«¯ä¸æ–­çš„å‘å±•ï¼Œå‡ºç°è¿‡å¾ˆå¤šçš„å‘½ä»¤è¡Œå·¥å…·ï¼Œå°±æ¯”å¦‚å‰ç«¯æ„å»ºå·¥å…·ï¼Œä»æœ€å¼€å§‹çš„<code>grunt</code>ï¼Œå†åˆ°<code>gulp</code>ï¼Œç„¶ååˆ°ç°åœ¨çš„<code>webpack</code>ç­‰ç­‰ï¼Œå®ƒä»¬éƒ½æœ‰è‡ªå·±çš„å‘½ä»¤è¡Œï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¸€èµ·åˆ†æå¹¶å®ç°ä¸€ä¸ªç®€å•çš„å‘½ä»¤è¡Œå·¥å…·</p><p>é¦–å…ˆéœ€è¦å»ºä¸€ä¸ªç›®å½•ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬æš‚ä¸”å«<code>cli-starter</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mkdir cli-starter</div></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬éœ€è¦å»ç”¨<code>npm</code>åˆå§‹åŒ–è¿™ä¸ªç›®å½•ï¼Œè¿™é‡Œæˆ‘ä»¬ç”¨é»˜è®¤çš„å°±å¥½</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm init -y</div></pre></td></tr></table></figure><p>æ™®é€šçš„ node.js è„šæœ¬éœ€è¦ä½¿ç”¨<code>node æ–‡ä»¶å</code>çš„å½¢å¼æ‰§è¡Œï¼Œåœ¨è„šæœ¬é¦–è¡ŒåŠ ä¸Š<code>#!/usr/bin/env node</code>å¯ä»¥åœ¨<code>linux</code>ç¯å¢ƒä¸­æŒ‡å®šè„šæœ¬çš„è§£é‡Šç¨‹åº</p><p>ä¸€åˆ‡ä»<code>hello world</code>å¼€å§‹ï¼Œæˆ‘ä»¬ç°åœ¨æ–°å»ºä¸€ä¸ª<code>bin</code>ç›®å½•ï¼Œåœ¨ä¸‹é¢ç”¨å»ºä¸€ä¸ª<code>hello.js</code>ï¼Œå†™å…¥ä¸‹é¢å†…å®¹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/usr/bin/env node</span></div><div class="line"><span class="built_in">console</span>.log(<span class="string">"hello world"</span>);</div></pre></td></tr></table></figure><p>ç„¶åå»<code>node ./bin/hello</code>ï¼Œå¯ä»¥çœ‹åˆ°æ§åˆ¶å°ä¼šè¾“å‡º<code>hello world</code></p><p>å½“ç„¶è¿™ä¸ªåªæ˜¯åœ¨ç‰¹å®šç›®å½•ä¸‹å»æ‰§è¡Œè¿™ä¸ªæ–‡ä»¶ï¼Œå¦‚æœæƒ³å’Œå…¶ä»–å‘½ä»¤è¡Œå·¥å…·åšåˆ°æ— å¤„ä¸åœ¨ï¼Œå¯ä»¥åœ¨<code>package.json</code>ä¸­åšå¦‚ä¸‹æŒ‡å®š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"name"</span>: <span class="string">"hello"</span>,</div><div class="line">  <span class="attr">"bin"</span>: &#123;</div><div class="line">    <span class="attr">"hello"</span>: <span class="string">"./bin/hello"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>ç„¶åå†é€šè¿‡<code>npm link</code>å»æ·»åŠ åˆ°ç³»ç»Ÿ<code>PATH</code>ï¼Œä¸è¦æ‹…å¿ƒä¼šæ±¡æŸ“ç³»ç»Ÿï¼Œæ—¢ç„¶æœ‰<code>npm link</code>ï¼Œè‚¯å®šå°±æœ‰<code>npm unlink</code>ï¼Œå°±æ˜¯æŠŠæˆ‘ä»¬æ·»åŠ çš„åˆ é™¤ï¼Œè¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ä»»ä½•ä¸€ä¸ªç›®å½•ä¸‹ä½¿ç”¨è¿™ä¸ª<code>hello</code>å‘½ä»¤äº†</p><p>ä¸Šé¢å°±æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„å‘½ä»¤è¡Œäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å¯¹å®ƒè¿›è¡Œå®Œå–„ï¼Œæœ€å¸¸è§çš„å°±æ˜¯å‚æ•°ï¼Œæœ‰å¾ˆå¤š<code>npm</code>æ¨¡å—å¯ä»¥è§£ææˆ‘ä»¬ä¼ å…¥çš„å‚æ•°ï¼Œå¸¸ç”¨çš„æœ‰<a href="https://www.npmjs.com/package/commander" target="_blank" rel="external">commander</a>ã€<a href="https://www.npmjs.com/package/minimist" target="_blank" rel="external">minimist</a>ç­‰</p><p>åœ¨è¿™é‡Œæˆ‘ç”¨çš„<code>minimist</code>è¿™ä¸ªæ¨¡å—ï¼Œç”¨æ³•<code>npm</code>ä¸Šå·²ç»æœ‰äº†è¿™é‡Œä¸å†èµ˜è¿°ï¼Œä¸‹é¢æˆ‘ä»¬ä¸€èµ·å®Œæˆä¸€ä¸ªç¿»è¯‘å°å·¥å…·ï¼Œè°ƒç”¨è°·æ­Œçš„ç¿»è¯‘æ¥å£ï¼Œè¿™é‡Œæˆ‘ç›´æ¥ç”¨çš„<code>translate-api</code>è¿™ä¸ª<code>npm</code>åŒ…,ä¸€èµ·çœ‹ä¸‹å®ç°ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/usr/bin/env node</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> minimist = <span class="built_in">require</span>(<span class="string">"minimist"</span>),</div><div class="line">    translate = <span class="built_in">require</span>(<span class="string">"translate-api"</span>);</div><div class="line"></div><div class="line"><span class="comment">//è·å–å‚æ•°</span></div><div class="line"><span class="keyword">var</span> args = minimist((process.argv.slice(<span class="number">2</span>)), &#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     *  å‚æ•°åˆ«å</span></div><div class="line"><span class="comment">     * hello --target=abc &lt;=&gt; hello -t=abc</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    alias: &#123;</div><div class="line">        t: <span class="string">"target"</span>,</div><div class="line">        i: <span class="string">"input"</span></div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">//å­˜å‚¨è¾“å…¥çš„å‚æ•°</span></div><div class="line"><span class="keyword">var</span> target = args.target,</div><div class="line">    input = args.input;</div><div class="line"></div><div class="line"><span class="comment">//è°ƒç”¨å°è£…å¥½çš„Google Translate API</span></div><div class="line">translate.getText(input, &#123; <span class="attr">to</span>: target &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</div><div class="line"><span class="built_in">console</span>.log(res.text);</div><div class="line"><span class="comment">//é€€å‡ºè¿›ç¨‹</span></div><div class="line">    process.exit(<span class="number">1</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œæˆ‘ä»¬ä¸€ä¸ªç®€å•çš„å‘½ä»¤è¡Œå·¥å…·å°±å†™å¥½äº†ï¼Œåªæ˜¯ä¸€ä¸ªå°ç©å…·ï¼Œè¿˜æœ‰å¾ˆå¤šæ²¡å®ç°ï¼Œæ¯”å¦‚å­å‘½ä»¤ç­‰ã€‚</p><p>é‚£ä¹ˆå¦‚æœæ„Ÿè§‰è¿™ä¸ªå·¥å…·å†™çš„è¿˜è¡Œï¼Œæƒ³åˆ†äº«åˆ°<code>npm</code>ä»“åº“é‡Œé¢ç»™æ›´å¤šäººä½¿ç”¨ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±è¦ç”¨åˆ°<code>npm</code>çš„ä¸€äº›å­å‘½ä»¤äº†ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦ç”¨<code>npm adduser</code>å»ç™»å½•<code>npm</code>ï¼Œè®©å®ƒçŸ¥é“è¿™ä¸ªåŒ…æ˜¯è°å‘å¸ƒçš„ï¼Œç„¶åç”¨<code>npm publish</code>å»æ¨é€åˆ°ä»“åº“ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨å‘å¸ƒ<code>npm</code>åŒ…æ—¶æˆ‘ä»¬éœ€è¦æŠŠé•œåƒæºåˆ‡æ¢æˆå®˜æ–¹çš„ï¼Œæ¨èä½¿ç”¨<a href="https://www.npmjs.com/package/nrm" target="_blank" rel="external">nrm</a>å»ç®¡ç†é•œåƒï¼Œåœ¨ç”¨<code>publish</code>ä¹‹å‰ï¼Œå…ˆ<code>nrm use npm</code>åˆ‡ä¸‹é•œåƒï¼Œç­‰å‘å¸ƒæˆåŠŸä¹‹ååˆ«äººå°±å¯ä»¥ç”¨<code>npm install &lt;package-name&gt; -g</code>å»æŠŠæˆ‘ä»¬çš„å‘½ä»¤è¡Œå·¥å…·å®‰è£…åˆ°å…¨å±€ä½¿ç”¨å•¦ğŸ˜œ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;è‡ªä»nodejsé—®ä¸–ä¹‹åï¼Œéšç€å‰ç«¯ä¸æ–­çš„å‘å±•ï¼Œå‡ºç°è¿‡å¾ˆå¤šçš„å‘½ä»¤è¡Œå·¥å…·ï¼Œå°±æ¯”å¦‚å‰ç«¯æ„å»ºå·¥å…·ï¼Œä»æœ€å¼€å§‹çš„&lt;code&gt;grunt&lt;/code&gt;ï¼Œå†åˆ°&lt;code&gt;gulp&lt;/code&gt;ï¼Œç„¶ååˆ°ç°åœ¨çš„&lt;code&gt;webpack&lt;/code&gt;ç­‰ç­‰ï¼Œå®ƒä»¬éƒ½æœ‰è‡ªå·±çš„å‘½ä»¤è¡Œï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¸€èµ·åˆ†
      
    
    </summary>
    
      <category term="javascript" scheme="http://yoursite.com/categories/javascript/"/>
    
      <category term="å‘½ä»¤è¡Œå·¥å…·" scheme="http://yoursite.com/categories/javascript/%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7/"/>
    
    
  </entry>
  
  <entry>
    <title>async/awaitå­¦ä¹ </title>
    <link href="http://yoursite.com/2016/11/09/2016-11-09-async:await-tourial/"/>
    <id>http://yoursite.com/2016/11/09/2016-11-09-async:await-tourial/</id>
    <published>2016-11-08T16:00:00.000Z</published>
    <updated>2017-03-30T12:19:21.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨å¤„ç†javascriptä¸­å¼‚æ­¥çš„æ—¶å€™,å›è°ƒå¾€å¾€æ˜¯æœ€è®©äººæ¶å¿ƒçš„,ä¹‹å‰ä»‹ç»è¿‡ç”¨<a href="http://123.207.98.169:81/2016/05/04/2016-05-04-es6-promise/" target="_blank" rel="external">Promise</a>æ¥å¤„ç†å¼‚æ­¥çš„é—®é¢˜,ä½†æ˜¯å³ä½¿ç”¨ä¸Šäº†Promise,åœ¨å¤„ç†å›è°ƒä¸Šè¿˜æ˜¯ä¼šæœ‰å„ç§åµŒå¥—,ä»Šå¤©æ¥ä»‹ç»ä¸‹ES7ä¸­çš„async/await,ç”±äºåœ¨Nodejsä¸­è¿˜æœªå¾—åˆ°æ”¯æŒ,æ‰€ä»¥éœ€è¦å€ŸåŠ©ä¸€äº›npmåŒ…æ¥å®è·µ,åœ¨è¿™é‡Œç”¨çš„æ˜¯<a href="https://github.com/yortus/asyncawait" target="_blank" rel="external">asyncawait</a>ã€‚</p><p>å…ˆæ¥ä¸ªåŸç”Ÿæ–‡ä»¶è¯»å–çš„ä¾‹å­:</p><pre><code>const fs = require(&quot;fs&quot;);fs.readFile(&quot;test.txt&quot;, (ex, res) =&gt; {   console.log(res.toString());    //   do something...   fs.readFile(&quot;test2.txt&quot;, (ex, res) =&gt; {        console.log(res.toString());        //  do something   });});//  æ§åˆ¶å°è¾“å‡ºxxxxxyyyyy</code></pre><p>ä¸‹é¢æˆ‘ä»¬å†ç”¨async/awaitå®ç°ä¸€é:</p><pre><code>const async = require(&quot;asyncawait&quot;).async;const await = require(&quot;asyncawait&quot;).await;let readFile = function(path) {    return new Promise((resolve, reject) =&gt; {        fs.readFile(path, (ex, res) =&gt; {            if (ex) {                reject(ex);            }            resolve(res);        });    });}let asyncReadFile = async(() =&gt; {    let fs = await (readFile(&quot;test.txt&quot;));    let fs2 = await (readFile(&quot;test2.txt&quot;));    console.log(fs.toString());    console.log(fs2.toString());});asyncReadFile();</code></pre><p>è™½ç„¶ä»£ç å¯èƒ½æ¯”ä¸Šé¢çš„å¤šäº†ä¸€ç‚¹,ä½†æ˜¯å·²ç»å®Œå…¨çœ‹ä¸åˆ°å›è°ƒåµŒå¥—çš„å½±å­äº†,ä¹Ÿèƒ½å®ŒæˆåŒæ ·çš„åŠŸèƒ½,ä½•ä¹è€Œä¸ä¸ºã€‚ğŸ˜‰</p><p>ä¸‹é¢æˆ‘ä»¬å†æ¥æ¨¡æ‹Ÿä¸€ä¸ªå¼‚æ­¥è¯·æ±‚çš„ä¾‹å­:</p><pre><code>const async = require(&quot;asyncawait&quot;).async;const await = require(&quot;asyncawait&quot;).await;const http = require(&quot;http&quot;);http.createServer((req, res) =&gt; {    switch (req.url) {        case &quot;/async-await&quot;:            setTimeout(() =&gt; {                res.writeHead(200, { &quot;Content-Type&quot;: &quot;text/plain&quot; });                res.end(&quot;request end&quot;);            }, 5000);            break;        case &quot;/async-await2&quot;:            setTimeout(() =&gt; {                res.writeHead(200, { &quot;Content-Type&quot;: &quot;text/plain&quot; });                res.end(&quot;request end2&quot;);            }, 8000);            break;        default:            break;    }}).listen(3000, &quot;127.0.0.1&quot;);let requestUrl = function(path) {    return new Promise((resolve, reject) =&gt; {        http.get({            hostname: &apos;localhost&apos;,            port: 3000,            path: path,            agent: false        }, (res) =&gt; {            res.on(&quot;data&quot;, (data) =&gt; {                resolve(data);            });            res.on(&quot;error&quot;, (ex) =&gt; {                reject(ex);            })        });    });}let asyncRequest = async(() =&gt; {    let resp, resp2;    await (requestUrl(&quot;/async-await&quot;).then((res) =&gt; {        console.log(res.toString());        resp = res.toString();    }).catch((ex) =&gt; {        resp = &quot;å‘ç”Ÿé”™è¯¯!&quot;;    }));    await (requestUrl(&quot;/async-await2&quot;).then((res) =&gt; {        resp2 = res.toString();    }).catch((ex) =&gt; {        resp = &quot;å‘ç”Ÿé”™è¯¯!&quot;;    }));    console.log(resp);    console.log(resp2);});asyncRequest();//  æ§åˆ¶å°è¾“å‡ºrequest endrequest end2</code></pre><p>ç”±æ­¤æˆ‘ä»¬å¯ä»¥å°†async/awaitç”¨åœ¨å¾ˆå¤šåœ°æ–¹,æ¯”å¦‚ä¾‹å­ä¸­çš„æ–‡ä»¶è¯»å–ã€å¼‚æ­¥è¯·æ±‚ã€nodejsä¸­çš„æŸ¥è¯¢æ•°æ®åº“ç­‰ç­‰ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨å¤„ç†javascriptä¸­å¼‚æ­¥çš„æ—¶å€™,å›è°ƒå¾€å¾€æ˜¯æœ€è®©äººæ¶å¿ƒçš„,ä¹‹å‰ä»‹ç»è¿‡ç”¨&lt;a href=&quot;http://123.207.98.169:81/2016/05/04/2016-05-04-es6-promise/&quot; target=&quot;_blank&quot; rel=&quot;external
      
    
    </summary>
    
      <category term="javascript" scheme="http://yoursite.com/categories/javascript/"/>
    
      <category term="ES7" scheme="http://yoursite.com/categories/javascript/ES7/"/>
    
      <category term="async/await" scheme="http://yoursite.com/categories/javascript/ES7/async-await/"/>
    
    
  </entry>
  
  <entry>
    <title>IEä¸‹AngularJsä¸­çš„ajaxç¼“å­˜</title>
    <link href="http://yoursite.com/2016/11/02/2016-11-02-ie-ajax-cache/"/>
    <id>http://yoursite.com/2016/11/02/2016-11-02-ie-ajax-cache/</id>
    <published>2016-11-01T16:00:00.000Z</published>
    <updated>2017-03-30T12:19:21.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨å•é¡µåº”ç”¨è¶Šæ¥è¶Šæ™®åŠçš„ä»Šå¤©,è¶Šæ¥è¶Šå¤šçš„é¡¹ç›®éƒ½ä¼šé‡‡ç”¨è¿™ç§æ–¹æ¡ˆ,è¿™å‡ å¤©ç”¨AngularJsåšäº†ä¸€ä¸ªPCç«¯åº”ç”¨,æœ‰ç™»å½•æ³¨å†Œçš„åŠŸèƒ½,ç™»å½•æ³¨å†Œçš„åŠŸèƒ½æ˜¯é€šè¿‡ajaxå®ç°çš„,åœ¨ç™»å½•æ³¨å†Œä»¥åé¡µé¢ä¸åˆ·æ–°,åªä¿®æ”¹$rootScopeä¸‹çš„æŸäº›å±æ€§å€¼,ç„¶ååœ¨é¡µé¢é‡Œé¢é€šè¿‡ng-ifä¹‹ç±»çš„æŒ‡ä»¤æ¥æ§åˆ¶ç›¸å…³å…ƒç´ çš„æ˜¾ç¤ºéšè—ã€‚</p><p>ä¹‹å‰çš„å¤§æ¦‚å®ç°å¦‚ä¸‹:</p><pre><code>//  jsvar app = angular.module(&quot;app&quot;, []);app.run([&quot;$rootScope&quot;, &quot;$http&quot;, function($rootScope, $http) {    $rootScope.isLogin = false;    $rootScope.$on(&quot;$routeChangeStart&quot;, function (event, next, current) {    $http.get(&quot;xxxx&quot;)        .success(function(res) {            $rootScope.isLogin = !!(res.isLogin);            //  ...        })        .error(function() {            //  ...        });    });}]);//  HTML&lt;div class=&quot;container&quot;&gt;    &lt;a href=&quot;/user/center&quot; ng-if=&quot;isLogin&quot;&gt;ç”¨æˆ·ä¸­å¿ƒ&lt;/a&gt;    &lt;a href=&quot;javascript:;&quot; ng-click=&quot;logout()&quot; ng-if=&quot;isLogin&quot;&gt;ç™»å‡º&lt;/a&gt;    &lt;a href=&quot;/login&quot; ng-if=&quot;!isLogin&quot;&gt;ç™»å½•&lt;/a&gt;&lt;/div&gt;</code></pre><p>åæ¥å‘ç°åœ¨Chrome/Firefoxä¸‹éƒ½æ˜¯å¥½çš„,åˆ°äº†IEä¸‹ç™»å½•ä»¥åä¸åˆ·æ–°å°±æ˜¾ç¤ºä¸å¯¹ã€‚åŸæ¥ä»¥ä¸ºæ˜¯ng-ifåœ¨IEä¸‹é‡æ–°æ¸²æŸ“è¿‡æ…¢çš„é—®é¢˜,æ”¹æˆng-showä»¥åè¿˜æ˜¯ä¸è¡Œ,ç„¶åçœ‹httpçŠ¶æ€ç ,å‘ç°æ˜¯304,æƒ³åˆ°å¯èƒ½å’Œç¼“å­˜æœ‰å…³ç³»,åæ¥æ”¹äº†é…ç½®ä¸­å…³é”®ajaxè¯·æ±‚é‚£è¾¹çš„ä¸œè¥¿,å‘ç°å¯ä»¥äº†,æ ¸å¿ƒä»£ç å¦‚ä¸‹:</p><pre><code>app.config([&quot;$routeProvider&quot;, &quot;$httpProvider&quot;, function($routeProvider, $httpProvider){    //  ...    if (!$httpProvider.defaults.headers.get) {        $httpProvider.defaults.headers.get = {};    }    $httpProvider.defaults.headers.common[&quot;X-Requested-With&quot;] = &quot;XMLHttpRequest&quot;;    $httpProvider.defaults.headers.get[&quot;Cache-Control&quot;] = &quot;no-cache&quot;;    $httpProvider.defaults.headers.get[&quot;Pragma&quot;] = &quot;no-cache&quot;;}]);</code></pre>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨å•é¡µåº”ç”¨è¶Šæ¥è¶Šæ™®åŠçš„ä»Šå¤©,è¶Šæ¥è¶Šå¤šçš„é¡¹ç›®éƒ½ä¼šé‡‡ç”¨è¿™ç§æ–¹æ¡ˆ,è¿™å‡ å¤©ç”¨AngularJsåšäº†ä¸€ä¸ªPCç«¯åº”ç”¨,æœ‰ç™»å½•æ³¨å†Œçš„åŠŸèƒ½,ç™»å½•æ³¨å†Œçš„åŠŸèƒ½æ˜¯é€šè¿‡ajaxå®ç°çš„,åœ¨ç™»å½•æ³¨å†Œä»¥åé¡µé¢ä¸åˆ·æ–°,åªä¿®æ”¹$rootScopeä¸‹çš„æŸäº›å±æ€§å€¼,ç„¶ååœ¨é¡µé¢é‡Œé¢é€šè¿‡ng-ifä¹‹ç±»çš„æŒ‡ä»¤æ¥æ§åˆ¶ç›¸
      
    
    </summary>
    
      <category term="javascript" scheme="http://yoursite.com/categories/javascript/"/>
    
      <category term="AngularJs" scheme="http://yoursite.com/categories/javascript/AngularJs/"/>
    
      <category term="ajax" scheme="http://yoursite.com/categories/javascript/AngularJs/ajax/"/>
    
    
  </entry>
  
  <entry>
    <title>javascriptä¸­çš„åºåˆ—åŒ–</title>
    <link href="http://yoursite.com/2016/09/17/2016-09-17-javascript-serialize/"/>
    <id>http://yoursite.com/2016/09/17/2016-09-17-javascript-serialize/</id>
    <published>2016-09-16T16:00:00.000Z</published>
    <updated>2017-03-30T12:19:21.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ç”¨jQueryå‘é€ajax(POST)è¯·æ±‚çš„æ—¶å€™,æœ€å¸¸è§çš„æäº¤æ–¹å¼å°±æ˜¯â€application/x-www-form-urlencodedâ€,é€šå¸¸éƒ½ä¼šä¼ å…¥ä¸€ä¸ªdataå±æ€§ä½œä¸ºä¼ è¾“ç»™åç«¯çš„æ•°æ®,åœ¨ajaxå‘é€ä¹‹å‰,é‚£ä¹ˆæˆ‘ä»¬ç›´æ¥å¦‚æœç›´æ¥ä¼ å…¥æŠŠè¿™ä¸ªå¯¹è±¡ä¼ é€’ç»™åç«¯,åç«¯å°±ä¸èƒ½å¯¹è¯¥å¯¹è±¡è¿›è¡Œè§£æ,å› ä¸ºå¯¹è±¡ä¼šè¢«è½¬æˆå­—ç¬¦ä¸²â€[object Object]â€,æ‰€ä»¥å°±éœ€è¦æˆ‘ä»¬å¯¹è¯¥å¯¹è±¡è¿›è¡Œurlç¼–ç ,å¹¶ä¸”è½¬æ¢æˆå­—ç¬¦ä¸²,å†ä¼ ç»™åç«¯ã€‚</p><p>å‡è®¾æˆ‘ä»¬å…ˆä¼ é€’ä¸€ä¸ªç®€å•çš„å¯¹è±¡(æ‰€æœ‰çš„keyå¯¹åº”çš„valueéƒ½ä¸æ˜¯å¼•ç”¨ç±»å‹[Arrayã€Object]),å°±åƒä¸‹é¢è¿™æ ·:</p><pre><code>{    string: &quot;string&quot;,    number: 1}</code></pre><p>ç”¨jQueryä¸­çš„$.ajaxæ–¹æ³•,POSTæäº¤,æ‰“å¼€è¯·æ±‚é¢æ¿,åœ¨form dataé‚£è¾¹,ç‚¹å‡»view source,å¯ä»¥çœ‹åˆ°ä¸‹é¢è¿™ä¸€ä¸²å­—ç¬¦ä¸²,å°±åƒä¸‹é¢çš„æ ·å­:</p><pre><code>string=string&amp;number=1</code></pre><p>åœ¨jQueryä¸­,$.paramè¿™ä¸ªæ–¹æ³•å¯ä»¥å®ç°è¿›è¡Œurlç¼–ç çš„ä½œç”¨ã€‚</p><p>ç°åœ¨å¯ä»¥è‡ªå·±å®ç°ä¸€ä¸ª:</p><pre><code>//  è·å–å¯¹è±¡ä¸Šçš„ç±»åfunction _typeOf(obj) {    return {}.toString.call(obj).slice(8, -1);}//  encodeURIComponentç®€å†™function _encode(data) {    data = data || &quot;&quot;;    return encodeURIComponent(data);}//  åºåˆ—åŒ–ä¸»å‡½æ•°function _serializenData(data) {    var res = data,        typeIn;    //  åˆ¤æ–­ä¼ å…¥çš„æ˜¯å¦æ˜¯ä¸€ä¸ªObjectç±»å‹çš„æ•°æ®    if (_typeOf(data) === &quot;Object&quot;) {        res = [];        for (var i in data) {            typeIn = _typeOf(data[i]);            switch (typeIn) {                //  é‡åˆ°Objectã€Arrayæ—¶éœ€è¦è¿›è¡Œéå†æˆ–è€…æšä¸¾,å¯¹å…¶å†…éƒ¨å…ƒç´ ã€å±æ€§åšå¤„ç†åå†æ”¾åˆ°ç»“æœé›†æ•°ç»„ä¸­                case &quot;Object&quot;:                    res.push(_loopObject(data[i], i));                    break;                case &quot;Array&quot;:                    res.push(_loopArray(data[i], i));                    break;                //  å…¶ä»–ç±»å‹ç›´æ¥æ¨åˆ°ç»“æœé›†æ•°ç»„                default:                    res.push(_encode(i) + &quot;=&quot; + _encode(data[i]));                    break;            }        }        //  æŠŠç»“æœé›†æ•°ç»„è½¬æ¢æˆ&quot;xxx=111&amp;yyy=333&amp;zzz=444&quot;çš„å½¢å¼        res = res.join(&quot;&amp;&quot;).replace(&quot;%20&quot;, &quot;+&quot;)    }    return (&quot;&quot; + res);}/** * æ·±å±‚éå†ä¸€ä¸ªæ•°ç»„ * @param  {[type]} array [description] * @param  {[type]} key   [description] * @return {[type]}       [description] */function _loopArray(array, key) {    var res = [],        typeIn;    for (var i = 0, len = array.length; i &lt; len; i++) {        //  è·å–æ¯ä¸€é¡¹çš„ç±»å,å¦‚æœæ˜¯Object/åˆ™é€’å½’è°ƒç”¨_loopArray/_loopObject,ä¼ å…¥å½“å‰é¡¹å’Œå±æ€§å,å¤„ç†å­é¡¹,å†æ”¾åˆ°ç»“æœé›†ä¸­        typeIn = _typeOf(array[i]);        switch (typeIn) {            case &quot;Array&quot;:                res.push(_loopArray(array[i], (key + &quot;[&quot; + i + &quot;]&quot;)));                break;            case &quot;Object&quot;:                res.push(_loopObject(array[i], (key + &quot;[&quot; + i + &quot;]&quot;)));                break;            //    å…¶ä»–ç±»å‹çš„ç›´æ¥æ¨åˆ°ç»“æœé›†æ•°ç»„            default:                res.push(_encode(key + &quot;[]&quot;) + &quot;=&quot; + _encode((&quot;&quot; + array[i])));                break;        }    }    //  æŠŠç»“æœé›†è½¬æ¢æˆ&quot;xxx=111&amp;yyy=333&amp;zzz=444&quot;çš„å½¢å¼    return res.join(&quot;&amp;&quot;);}/** * æ·±å±‚éå†ä¸€ä¸ªå¯¹è±¡ * @param  {[type]} object [description] * @param  {[type]} key    [description] * @return {[type]}        [description] */function _loopObject(object, key) {    var res = [],        typeIn;    for (var i in object) {        //  å–å¾—ä¸€ä¸ªå½“å‰keyå¯¹åº”valueçš„ç±»å,å¦‚æœæ˜¯Object/Array,åˆ™è¿›è¡Œé€’å½’è°ƒç”¨        typeIn = _typeOf(object[i]);        switch (typeIn) {            case &quot;Array&quot;:                res.push(_loopArray(object[i], key + &quot;[&quot; + i + &quot;]&quot;));                break;            case &quot;Object&quot;:                res.push(_loopObject(object[i], key + &quot;[&quot; + i + &quot;]&quot;));                break;            //    å…¶ä»–ç±»å‹çš„ç›´æ¥æ¨åˆ°ç»“æœé›†æ•°ç»„ä¸­            default:                res.push(_encode(key + &quot;[&quot; + i + &quot;]&quot;) + &quot;=&quot; + _encode((&quot;&quot; + object[i])));                break;        }    }    //  æŠŠç»“æœé›†è½¬æ¢æˆ&quot;xxx=111&amp;yyy=333&amp;zzz=444&quot;çš„å½¢å¼    return res.join(&quot;&amp;&quot;);}</code></pre><p>ä¸‹é¢æˆ‘ä»¬æ¨¡æ‹Ÿå‡ ä¸ªå¤æ‚ç‚¹çš„å¯¹è±¡,è°ƒç”¨å°è£…çš„åºåˆ—åŒ–æ–¹æ³•,å’Œ$.paramè¿›è¡Œå¯¹æ¯”:</p><pre><code>var obj = {    string: &quot;string&quot;,    number: 1,    array: [1, 2, 3, 4, 5]};var obj2 = {    string: &quot;string&quot;,    number: 1,    array: [        1, 2, 3, 4, 5, {            key1: &quot;value1&quot;,            key2: &quot;value2&quot;,            key3: &quot;value3&quot;        }    ]};var obj3 = {    array: [1, 2, 3, 4, 5],    arrayobject: [{        key1: &quot;value1&quot;,        key2: &quot;value2&quot;,        key3: &quot;value3&quot;    }, {        key1: &quot;value1&quot;,        key2: &quot;value2&quot;,        key3: &quot;value3&quot;    }, {        key1: &quot;value1&quot;,        key2: &quot;value2&quot;,        key3: &quot;value3&quot;    }]};var deepObj1 = {    arr: [{        string: &quot;string&quot;,        number: 1,        arr: [1, 2, 3, 4],        mixArr: [{            key1: &quot;value1&quot;,            key2: &quot;value2&quot;        }, {            key1: &quot;value1&quot;,            key2: &quot;value2&quot;        }, {            key1: &quot;value1&quot;,            key2: &quot;value2&quot;        }]    }]};var deepObj2 = {    obj: {        key1: &quot;value1&quot;,        key2: &quot;value2&quot;,        key3: &quot;value3&quot;    },    array: [1, 2, 3, 4, 5],    objectArray: {        array: [1, 2, 3, 4, 5, {            key1: &quot;value1&quot;,            key2: &quot;value2&quot;,            key3: &quot;value3&quot;        }]    },    arrayObj: [{        key1: &quot;value1&quot;,        key2: &quot;value2&quot;,        key3: &quot;value3&quot;    }, {        key1: &quot;value1&quot;,        key2: &quot;value2&quot;,        key3: &quot;value3&quot;    }, {        key1: &quot;value1&quot;,        key2: &quot;value2&quot;,        key3: &quot;value3&quot;    }]};//  æ‰“å¼€æ§åˆ¶å°çš„consoleé¢æ¿,æŸ¥çœ‹è¾“å‡ºconsole.group(&quot;serialize obj&quot;);console.log(_serializenData(obj));  //  ...console.log($.param(obj));  //  ...console.log(_serializenData(obj) === $.param(obj)); //  trueconsole.groupEnd();console.group(&quot;serialize obj2&quot;);console.log(_serializenData(obj2)); //  ...console.log($.param(obj2)); //  ...console.log(_serializenData(obj2) === $.param(obj2));   //  trueconsole.groupEnd();    console.group(&quot;serialize obj3&quot;);console.log(_serializenData(obj3)); //  ...console.log($.param(obj3)); //  ...console.log(_serializenData(obj3) === $.param(obj3));   //  trueconsole.groupEnd();console.group(&quot;serialize deepObj1&quot;);console.log(_serializenData(deepObj1)); //  ...console.log($.param(deepObj1)); //  ...console.log(_serializenData(deepObj1) === $.param(deepObj1));   //  trueconsole.groupEnd();console.group(&quot;serialize deepObj2&quot;);console.log(_serializenData(deepObj2)); //  ...console.log($.param(deepObj2)); //  ...console.log(_serializenData(deepObj2) === $.param(deepObj2));   //  trueconsole.groupEnd();</code></pre>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨ç”¨jQueryå‘é€ajax(POST)è¯·æ±‚çš„æ—¶å€™,æœ€å¸¸è§çš„æäº¤æ–¹å¼å°±æ˜¯â€application/x-www-form-urlencodedâ€,é€šå¸¸éƒ½ä¼šä¼ å…¥ä¸€ä¸ªdataå±æ€§ä½œä¸ºä¼ è¾“ç»™åç«¯çš„æ•°æ®,åœ¨ajaxå‘é€ä¹‹å‰,é‚£ä¹ˆæˆ‘ä»¬ç›´æ¥å¦‚æœç›´æ¥ä¼ å…¥æŠŠè¿™ä¸ªå¯¹è±¡ä¼ é€’ç»™åç«¯,åç«¯å°±ä¸èƒ½å¯¹è¯¥
      
    
    </summary>
    
      <category term="javascript" scheme="http://yoursite.com/categories/javascript/"/>
    
      <category term="åºåˆ—åŒ–" scheme="http://yoursite.com/categories/javascript/%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
    
  </entry>
  
  <entry>
    <title>javascriptä¸­Dateç»†èŠ‚</title>
    <link href="http://yoursite.com/2016/08/30/2016-08-30-something-about-javascript-Date/"/>
    <id>http://yoursite.com/2016/08/30/2016-08-30-something-about-javascript-Date/</id>
    <published>2016-08-29T16:00:00.000Z</published>
    <updated>2017-03-30T12:19:21.000Z</updated>
    
    <content type="html"><![CDATA[<h5 id="Safriæµè§ˆå™¨new-Date-â€œyyyy-mm-ddâ€-è¿”å›invalid-Date"><a href="#Safriæµè§ˆå™¨new-Date-â€œyyyy-mm-ddâ€-è¿”å›invalid-Date" class="headerlink" title="Safriæµè§ˆå™¨new Date(â€œyyyy-mm-ddâ€)è¿”å›invalid Date"></a>Safriæµè§ˆå™¨new Date(â€œyyyy-mm-ddâ€)è¿”å›invalid Date</h5><p>è®¸å¤šæ—¶å€™æˆ‘ä»¬éœ€è¦åˆå§‹åŒ–ä¸€ä¸ªå…·ä½“æŸå¤©çš„æ—¥æœŸå¯¹è±¡çš„æ—¶å€™,ä¼šç”¨åˆ°new Date(),è¿™ä¸ªæ–¹æ³•,æˆ‘ä»¬å¯ä»¥ä¼ å…¥ä¸€ä¸ªå­—ç¬¦ä¸²ä½œä¸ºå‚æ•°æ¥æŒ‡å®šå…·ä½“çš„æ—¥æœŸ,è€Œä¸€èˆ¬æˆ‘ä»¬ä¼šä¼ å…¥ä¸€ä¸ªâ€yyyy-mm-dd hh:ii:ssâ€è¿™ç§æ ¼å¼ä½œä¸ºä¸€ä¸ªåˆå§‹æ—¥æœŸ,ä½†åˆ°äº†Safriæµè§ˆå™¨ä¸‹,å°±ä¼šè¿”å›ä¸€ä¸ªinvalid Date,è°ƒç”¨è¯¥Dateå®ä¾‹ä¸‹çš„æ‰€æœ‰æ–¹æ³•éƒ½ä¼šè¿”å›NaNå€¼,åŸå› æ˜¯Safriä¸èƒ½æ­£å¸¸è§£æä¸­é—´çš„â€-â€œåˆ†éš”ç¬¦,è§£å†³åŠæ³•ä¹Ÿå¾ˆç®€å•,æœ‰ä¸¤ç§:</p><p>ç›´æ¥</p><pre><code>var myDate1 = Date.parseExact(&quot;29-11-2010&quot;, &quot;dd-MM-yyyy&quot;);var myDate2 = Date.parseExact(&quot;11-29-2010&quot;, &quot;MM-dd-yyyy&quot;);var myDate3 = Date.parseExact(&quot;2010-11-29&quot;, &quot;yyyy-MM-dd&quot;);var myDate4 = Date.parseExact(&quot;2010-29-11&quot;, &quot;yyyy-dd-MM&quot;);</code></pre><p>æˆ–è€…</p><pre><code>new Date(&quot;2011-04-12&quot;.replace(/-/g, &quot;/&quot;));</code></pre><h5 id="setMonthæº¢å‡ºé—®é¢˜"><a href="#setMonthæº¢å‡ºé—®é¢˜" class="headerlink" title="setMonthæº¢å‡ºé—®é¢˜"></a>setMonthæº¢å‡ºé—®é¢˜</h5><p>å®ä¾‹åŒ–ä¸€ä¸ªDateå¯¹è±¡,é€šè¿‡å¦‚ä¸‹çš„æ–¹å¼,ç„¶åè°ƒç”¨è¯¥å®ä¾‹çš„setMonthæ–¹æ³•,æŠŠå½“å‰æœˆä»½åŠ 1,å°±åƒä¸‹é¢è¿™æ ·</p><pre><code>var date = new Date(&quot;2016/01/30&quot;);date.setMonth(date.getMonth() + 1);console.log(date.getMonth());       //  Tue Mar 01 2016 00:00:00 GMT+0800 (CST)</code></pre><p>æˆ–è€…</p><pre><code>var date = new Date(&quot;2016/10/31&quot;);date.setMonth(date.getMonth() + 1);console.log(date);                 //  Thu Dec 01 2016 00:00:00 GMT+0800 (CST)</code></pre><p>ä¸Šé¢ä¸¤æ®µæˆ‘ä»¬éƒ½å¸Œæœ›æ˜¯è¿”å›çš„æ˜¯2æœˆå’Œ11æœˆ,ä½†æ˜¯çœŸæ­£è¿”å›äº†3æœˆå’Œ12æœˆ</p><p>å‡ºç°è¿™ç§æƒ…å†µçš„åŸå› æ˜¯2æœˆæ²¡æœ‰28/29å·ä»¥åçš„æ—¥æœŸ,è€Œå½“å‰æ—¥æœŸå¯¹è±¡çš„æ—¥æœŸä¸º30å·,è°ƒç”¨setMonth,å°±å¯¼è‡´æº¢å‡º,ä¸‹é¢çš„ä¾‹å­åŒç†ã€‚</p><p>è§£å†³åŠæ³•ä¹Ÿå¾ˆç®€å•,åœ¨è°ƒç”¨setMonthä¹‹å‰,æ‹¿ä¸‹ä¸ªæœˆçš„æœ€åä¸€å¤©å’Œå½“å‰çš„æ¯”è¾ƒä¸‹,å†åšç›¸åº”å¤„ç†å°±å¥½,æˆ–è€…æ›´ç®€å•ç²—æš´çš„æ–¹æ³•,æŠŠå½“å‰Dateå¯¹è±¡çš„dateæ”¹æˆ1,å“ˆå“ˆã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h5 id=&quot;Safriæµè§ˆå™¨new-Date-â€œyyyy-mm-ddâ€-è¿”å›invalid-Date&quot;&gt;&lt;a href=&quot;#Safriæµè§ˆå™¨new-Date-â€œyyyy-mm-ddâ€-è¿”å›invalid-Date&quot; class=&quot;headerlink&quot; title=&quot;Safr
      
    
    </summary>
    
      <category term="javascript" scheme="http://yoursite.com/categories/javascript/"/>
    
      <category term="Date" scheme="http://yoursite.com/categories/javascript/Date/"/>
    
    
  </entry>
  
</feed>
