<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>å°å®‹</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2019-09-28T12:34:56.000Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>rwson</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Reactäº‹ä»¶ç»‘å®šç»ˆæä¼˜åŒ–æ–¹æ¡ˆ</title>
    <link href="http://yoursite.com/2019/09/28/2019-09-28-react-binding-events-with-arguments/"/>
    <id>http://yoursite.com/2019/09/28/2019-09-28-react-binding-events-with-arguments/</id>
    <published>2019-09-27T16:00:00.000Z</published>
    <updated>2019-09-28T12:34:56.000Z</updated>
    
    <content type="html"><![CDATA[<p><code>React</code>ä½œä¸ºç›®å‰ç‚™æ‰‹å¯çƒ­çš„å‰ç«¯æ¡†æ¶ï¼Œé‡Œé¢æœ‰å¾ˆå¤šå¸å¼•äººçš„åœ°æ–¹ï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸€äº›å¼€å‘ä½“éªŒä¸å¤ªå¥½çš„åœ°æ–¹ï¼Œæ¯”å¦‚æˆ‘ä»¬å¹³æ—¶åšäº‹ä»¶ç»‘å®šçš„æ—¶å€™è¦æ˜¾ç¤ºçš„ç»‘å®š<code>this</code>ï¼Œå¦åˆ™å°±å¯èƒ½å¯¼è‡´å„ç§<code>bug</code>ï¼Œå…³äºäº‹ä»¶<code>this</code>ç»‘å®šä¹Ÿæœ‰å¾ˆå¤šç§å½¢å¼ï¼Œå„ç§æ–¹æ³•éƒ½æœ‰ä¼˜åŠ£ï¼Œä¸‹é¢æˆ‘ä»¬å°†å¯¹ç…§å‡ ç§ç»‘å®šæ–¹å¼æ¥è¿›è¡Œå¯¹æ¯”ï¼Œæœ€ç»ˆå®ç°ä¸€ä¸ªé€‚åˆè‡ªå·±çš„æ–¹æ¡ˆ</p><h5 id="åœ¨æ„é€ å‡½æ•°ä¸­è¿›è¡Œç»‘å®š"><a href="#åœ¨æ„é€ å‡½æ•°ä¸­è¿›è¡Œç»‘å®š" class="headerlink" title="åœ¨æ„é€ å‡½æ•°ä¸­è¿›è¡Œç»‘å®š"></a>åœ¨æ„é€ å‡½æ•°ä¸­è¿›è¡Œç»‘å®š</h5><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span> (props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props)</span><br><span class="line">    <span class="keyword">this</span>.state = &#123;</span><br><span class="line">      t: <span class="string">'t'</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// this.bind1 = this.bind1.bind(this) æ— å‚å†™æ³•</span></span><br><span class="line">    <span class="keyword">this</span>.bind1 = <span class="keyword">this</span>.bind1.bind(<span class="keyword">this</span>, <span class="keyword">this</span>.state.t)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ— å‚å†™æ³• </span></span><br><span class="line">    <span class="comment">// bind1 () &#123;</span></span><br><span class="line">    <span class="comment">//   console.log('bind1', this)</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">  bind1 (t, event) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'bind1'</span>, <span class="keyword">this</span>, t, event)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render () &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="keyword">this</span>.bind1&#125;&gt;æ‰“å°<span class="number">1</span>&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ç§æ–¹å¼çš„ä¼˜ç‚¹å°±æ˜¯åªä¼šç”Ÿæˆä¸€ä¸ªæ–¹æ³•å®ä¾‹ï¼Œå¹¶ä¸”ç»‘å®šä¸€æ¬¡ä¹‹åå¦‚æœå¤šæ¬¡ç”¨åˆ°è¿™ä¸ªæ–¹æ³•ä¹Ÿä¸éœ€è¦å†ç»‘å®šã€‚ç¼ºç‚¹æ˜¯å¦‚æœæˆ‘ä»¬ç›´æ¥åœ¨<code>constructor</code>ä¸­è¿›è¡Œç»‘å®šçš„è¯ï¼Œå‚æ•°å°±æ— æ³•åŠ¨æ€åŒ–ï¼Œåªèƒ½å›ºå®šæ­»ç”¨<code>state</code>é‡Œçš„å€¼ï¼Œæ¯”å¦‚æˆ‘ä»¬ä¸€ä¸ªåˆ—è¡¨ç»„ä»¶ï¼Œ  ç‚¹å‡»æŸä¸€æ¡æŸä¸€ä¸ªå…·ä½“æ“ä½œçš„æ—¶å€™ï¼Œéœ€è¦ä¼ å…¥ä¸€ä¸ª<code>id</code>ä¹‹ç±»çš„å­—æ®µä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼Œè¿™ç§ç»‘å®šå½¢å¼å°±æ— æ³•å¤„ç†äº†ï¼Œç¼ºç‚¹äºŒå°±æ˜¯å³ä½¿ä¸ç”¨åˆ°<code>state</code>ï¼Œä¹Ÿéœ€è¦åœ¨æ„é€ å™¨é‡Œåšç»‘å®š</p><h5 id="è¡Œå†…åŒ¿åå‡½æ•°"><a href="#è¡Œå†…åŒ¿åå‡½æ•°" class="headerlink" title="è¡Œå†…åŒ¿åå‡½æ•°"></a>è¡Œå†…åŒ¿åå‡½æ•°</h5><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">bind3 (t, event) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'bind3'</span>, <span class="keyword">this</span>, t, event)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">render () &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      <span class="comment">// &lt;button onClick=&#123;() =&gt; this.bind3()&#125;&gt;æ‰“å°3&lt;/button&gt; æ— å‚å†™æ³•</span></span><br><span class="line">      &lt;button onClick=&#123;(event) =&gt; <span class="keyword">this</span>.bind3(<span class="keyword">this</span>.state.t, event)&#125;&gt;æ‰“å°<span class="number">3</span>&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ç§æ–¹å¼çš„ä¼˜ç‚¹å°±æ˜¯æ¯”è¾ƒç®€å•ï¼Œçµæ´»ï¼Œä½†æ˜¯æœ€å¤§çš„ç¼ºç‚¹å°±æ˜¯åœ¨æ¯æ¬¡<code>render</code>çš„æ—¶å€™éƒ½ä¼šæ‰§è¡Œè¿™ä¸ªåŒ¿åå‡½æ•°ï¼Œå½“è¿™ä¸ªå‡½æ•°ä½œä¸º<code>props</code>ä¼ å…¥ä½é˜¶ç»„ä»¶çš„æ—¶å€™ï¼Œè¿™äº›ç»„ä»¶å¯èƒ½ä¼šè¿›è¡Œé¢å¤–çš„é‡æ–°æ¸²æŸ“ï¼Œå› ä¸ºæ¯ä¸€æ¬¡éƒ½æ˜¯æ–°çš„æ–¹æ³•å®ä¾‹ä½œä¸ºçš„æ–°çš„å±æ€§ä¼ é€’ï¼Œå¸¦æ¥äº†é¢å¤–çš„æ€§èƒ½å¼€é”€</p><h5 id="åœ¨renderä¸­æ˜¾ç¤ºbind"><a href="#åœ¨renderä¸­æ˜¾ç¤ºbind" class="headerlink" title="åœ¨renderä¸­æ˜¾ç¤ºbind"></a>åœ¨<code>render</code>ä¸­æ˜¾ç¤º<code>bind</code></h5><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">bind3 (t, event) &#123;</span><br><span class="line">   <span class="built_in">console</span>.log(<span class="string">'bind3'</span>, <span class="keyword">this</span>, t, event)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> render () &#123;</span><br><span class="line">   <span class="keyword">return</span> (</span><br><span class="line">     &lt;div&gt;</span><br><span class="line">       <span class="comment">// &lt;button onClick=&#123;this.bind3.bind(this)&#125;&gt;æ‰“å°3&lt;/button&gt; æ— å‚å†™æ³•</span></span><br><span class="line">       &lt;button onClick=&#123;<span class="keyword">this</span>.bind3.bind(<span class="keyword">this</span>, xxx)&#125;&gt;æ‰“å°<span class="number">3</span>&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">     &lt;/</span>div&gt;</span><br><span class="line">   )</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>è¿™ç§å†™æ³•è™½ç„¶å’ŒåŒ¿åå‡½æ•°å†™æ³•ä¸Šå®Œå…¨ä¸ä¸€æ ·ï¼Œä½†æ˜¯ç¼ºç‚¹åŸºæœ¬ä¸Šå¯ä»¥è®¤ä¸ºæ˜¯ä¸€æ ·çš„ ğŸ˜‚ï¼Œä¹Ÿä¼šå¸¦æ¥é¢å¤–çš„æ€§èƒ½å¼€é”€ </p><h5 id="ä½¿ç”¨å±æ€§åˆå§‹åŒ–å™¨è¯­æ³•ç»‘å®šthis"><a href="#ä½¿ç”¨å±æ€§åˆå§‹åŒ–å™¨è¯­æ³•ç»‘å®šthis" class="headerlink" title="ä½¿ç”¨å±æ€§åˆå§‹åŒ–å™¨è¯­æ³•ç»‘å®šthis"></a>ä½¿ç”¨å±æ€§åˆå§‹åŒ–å™¨è¯­æ³•ç»‘å®šthis</h5><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">bind3 = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">   <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">     xxx: <span class="string">'xxx'</span></span><br><span class="line">   &#125;)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> render () &#123;</span><br><span class="line">   <span class="keyword">return</span> (</span><br><span class="line">     &lt;div&gt;</span><br><span class="line">       &lt;button onClick=&#123;<span class="keyword">this</span>.bind3&#125;&gt;æ‰“å°<span class="number">3</span>&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">     &lt;/</span>div&gt;</span><br><span class="line">   )</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>è¿™ç§æ–¹æ³•åˆ©ç”¨äº†ç®­å¤´å‡½æ•°ä¸­<code>ç®­å¤´å‡½æ•°å†…éƒ¨çš„thisæ˜¯è¯æ³•ä½œç”¨åŸŸï¼Œç”±ä¸Šä¸‹æ–‡ç¡®å®š</code>çš„ç‰¹ç‚¹ï¼Œå†™æ³•ä¸Šæ¯”è¾ƒç®€å•ï¼Œä¸”ä¸ä¼šå¸¦æ¥é¢å¤–æ€§èƒ½å¼€é”€ï¼Œå¹¶ä¸”ä¸ä¼šåƒç¬¬ä¸€ç§é‚£æ ·å¸¦æ¥å¤šä½™ä»£ç ï¼Œçœ‹ä¼¼å¾ˆå®Œç¾ï¼Œä½†æ˜¯å’Œåœ¨<code>constructor</code>ä¸€æ ·ï¼Œæ— æ³•å°†å‚æ•°åŠ¨æ€åŒ–</p><h5 id="this-xxx"><a href="#this-xxx" class="headerlink" title="::this.xxx()"></a><code>::this.xxx()</code></h5><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> bind5()&#123;</span><br><span class="line">   <span class="built_in">console</span>.log(<span class="string">'bind5'</span>, <span class="keyword">this</span>)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">render() &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">   &lt;div&gt;</span><br><span class="line">      &lt;button onClick=&#123;::<span class="keyword">this</span>.bind5&#125;&gt;<span class="xml"><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">   &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp"> )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p>è¿™ç§æ–¹æ³•æˆ‘è‡ªå·±æ²¡ç”¨è¿‡ï¼Œæ‰€ä»¥ä¸çŸ¥é“å…·ä½“æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹</p><p>ä¸Šé¢å‡ ç§æ˜¯ç›®å‰æˆ‘ä»¬å†™<code>React</code>ç»„ä»¶æ—¶ï¼ŒåŸºæœ¬ä¸Šéƒ½ä¼šç”¨åˆ°çš„å‡ ç§<code>this</code>ç»‘å®šæ–¹å¼ï¼Œé€šè¿‡åˆ†ææ¥çœ‹ï¼Œå¤šå¤šå°‘å°‘éƒ½æœ‰ä¸€ç‚¹ç¼ºç‚¹ï¼Œç›®å‰ä¹Ÿæœ‰å¾ˆå¤šå¼€æºæ¯”å¦‚<a href="[https://www.npmjs.com/package/auto-bind](https://www.npmjs.com/package/auto-bind">autobind</a>æˆ–è€…<a href="[https://www.npmjs.com/package/memo-bind](https://www.npmjs.com/package/memo-bind">memo-bind</a>ï¼Œä½†æ˜¯ä¹Ÿä¼šæœ‰éƒ¨åˆ†ä¸è¶³ï¼Œæ‰€ä»¥å†³å®šè‡ªå·±å®ç°ä¸€ä¸ªï¼š</p><h5 id="bind-with-arguments"><a href="#bind-with-arguments" class="headerlink" title="bind-with-arguments"></a>bind-with-arguments</h5><p>å…ˆæ¥çœ‹çœ‹åŸºç¡€ç‰ˆæœ¬çš„:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bindWithArguments</span>(<span class="params">target, name, descriptor</span>) </span>&#123;</span><br><span class="line">  <span class="comment">//ç¼“å­˜æœ€ç»ˆè¦æ‰§è¡Œçš„æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">const</span> excuter = target[name];</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¯¹è¯¥æ–¹æ³•è¿›è¡Œé‡æ–°åŒ…è£…</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Object</span>.assign(target, descriptor, &#123;</span><br><span class="line">        value: <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">              <span class="comment">//ç”¨applyæ¥ç»‘å®šä½œç”¨åŸŸä»¥åŠä¼ å…¥å¤–éƒ¨å‚æ•°, å¹¶ä¸”æŠŠæ‰§è¡Œç»“æœä½œä¸ºè¿”å›å€¼</span></span><br><span class="line">                <span class="keyword">return</span> excuterType.apply(target, args);</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æµ‹è¯•çš„è¿‡ç¨‹ä¸­å‘ç°ï¼Œä¸Šè¿°ç‰ˆæœ¬åªèƒ½æ»¡è¶³åŒæ­¥çš„å›è°ƒå‡½æ•°ï¼Œä½†æ˜¯å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬ä¼šæ ¹æ®ç”¨æˆ·æ“ä½œæ¥å‘èµ·æŸä¸ªå…·ä½“çš„å¼‚æ­¥è¯·æ±‚ï¼Œæ‰€ä»¥ä»…ä»…ä¸Šé¢é‚£éƒ¨åˆ†æ˜¯ä¸è¡Œçš„ï¼Œæ ¹æ®<a href="[https://developer.mozilla.org/](https://developer.mozilla.org/">MDN</a>ä¸Šå¯¹<a href="[https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/AsyncFunction](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/AsyncFunction">async</a>çš„ä»‹ç»ï¼Œæˆ‘ä»¬æ¥å®Œå–„ä»£ç :</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bindWithArguments</span>(<span class="params">target, name, descriptor</span>) </span>&#123;</span><br><span class="line">  <span class="comment">//ç¼“å­˜æœ€ç»ˆè¦æ‰§è¡Œçš„æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">const</span> excutor = target[name];</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//æ™®é€šæ–¹æ³•: [object Function] async: [object AsyncFunction]</span></span><br><span class="line">    <span class="keyword">const</span> excutorType = &#123;&#125;.toString.call(excutor).slice(<span class="number">8</span>, <span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">const</span> isAsync = excutorType === <span class="string">'AsyncFunction'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Object</span>.assign(target, descriptor, &#123;</span><br><span class="line">        value: <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> isAsync ? <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">              <span class="comment">//å¦‚æœæ˜¯å¼‚æ­¥æ–¹æ³•ï¼Œå°±ç”¨async/awaitåŒ…ä¸€å±‚å†è¿”å›å‡ºå»</span></span><br><span class="line">                <span class="keyword">return</span> (<span class="keyword">await</span> excutor.apply(target, args));</span><br><span class="line">            &#125; : <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> excutor.apply(target, args);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨å¼‚æ­¥æ–¹æ³•å·²ç»æ”¯æŒäº†ï¼Œçœ‹ä¸‹å…·ä½“ç”¨æ³•</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> deffer = <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(resolve, <span class="number">2000</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> asyncFn(a, b) &#123;</span><br><span class="line">        <span class="keyword">await</span> deffer();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'deffer'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è£…é¥°åŒæ­¥æ–¹æ³•</span></span><br><span class="line">    @bindWithArg</span><br><span class="line">    <span class="keyword">async</span> callAsync() &#123;</span><br><span class="line">        <span class="built_in">console</span>.time();</span><br><span class="line">      <span class="comment">//å†…éƒ¨å†è°ƒç”¨å¼‚æ­¥æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="keyword">this</span>.asyncFn(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="built_in">console</span>.timeEnd();</span><br><span class="line">        <span class="comment">//  åç»­å·¥ä½œ</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è£…é¥°åŒæ­¥æ–¹æ³•</span></span><br><span class="line">    @bindWithArg</span><br><span class="line">    syncFn(a, b) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(a, b);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;div&gt;</span><br><span class="line">                &lt;h3&gt;bindWithArguments&lt;<span class="regexp">/h3&gt;</span></span><br><span class="line"><span class="regexp">            /</span><span class="regexp">/è°ƒç”¨åŒæ­¥æ–¹æ³•</span></span><br><span class="line"><span class="regexp">                &lt;p onClick=&#123;this.syncFn('1', &#123;</span></span><br><span class="line"><span class="regexp">                    a: 'xxx',</span></span><br><span class="line"><span class="regexp">                    b: 'yyy'</span></span><br><span class="line"><span class="regexp">                &#125;)&#125;&gt;sync fn&lt;/</span>p&gt;</span><br><span class="line">            <span class="comment">//è°ƒç”¨å¼‚æ­¥æ–¹æ³•</span></span><br><span class="line">                &lt;p onClick=&#123;<span class="keyword">this</span>.callAsync()&#125;&gt; <span class="keyword">async</span> click fn&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">            &lt;/</span>div&gt;</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>çœ‹ä¸Šé¢çš„ä¾‹å­å·²ç»å¾ˆæ¸…æ¥šï¼Œä½†æ˜¯å…¶å®è¿˜æœ‰ä¸€ç‚¹ä¸å¤ªå®Œç¾çš„åœ°æ–¹ï¼Œå°±æ˜¯æˆ‘ä»¬ä¸éœ€è¦ä¼ å…¥ä»»ä½•å‚æ•°çš„æ—¶å€™ä¹Ÿæ˜¯ç”¨<code>onClick={ this.xxx() }</code>æ¥è°ƒç”¨ï¼Œå¯¹äºç”¨æƒ¯äº†<code>autobind</code>çš„æˆ‘ä»¬å¯èƒ½ä¸å¤ªä¹ æƒ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬ç»§ç»­å®Œå–„ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> functionMap = &#123;</span><br><span class="line">    <span class="comment">//å¼‚æ­¥å¹¶ä¸”æœ‰å‚æ•°</span></span><br><span class="line">    AsyncWith: <span class="function">(<span class="params">excutor, target, ...argus</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span>  <span class="keyword">async</span> () =&gt; (<span class="keyword">await</span> excutor.apply(target, argus))</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">//å¼‚æ­¥æ— å‚æ•°</span></span><br><span class="line">    AsyncEmpty: <span class="keyword">async</span> (excutor, target) =&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">await</span> excutor.call(target));</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">//åŒæ­¥å¹¶ä¸”æœ‰å‚æ•°</span></span><br><span class="line">    SyncWith: <span class="function">(<span class="params">excutor, target, ...argus</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> excutor.apply(target, argus);;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">//åŒæ­¥æ— å‚æ•°</span></span><br><span class="line">    SyncEmpty: <span class="function">(<span class="params">excutor, target</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> excutor.call(target);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bindWithArg</span>(<span class="params">target, name, descriptor</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> excutor = target[name];</span><br><span class="line">    <span class="keyword">const</span> excutorType = &#123;&#125;.toString.call(excutor).slice(<span class="number">8</span>, <span class="number">-1</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//åˆ¤æ–­æ˜¯å¦å¼‚æ­¥</span></span><br><span class="line">    <span class="keyword">const</span> asyncCall = excutorType === <span class="string">'AsyncFunction'</span> ? <span class="string">'Async'</span> : <span class="string">'Sync'</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//åˆ¤æ–­æ˜¯å¦æœ‰å‚æ•°</span></span><br><span class="line">    <span class="keyword">const</span> emptyCall = excutor.length === <span class="number">0</span> ? <span class="string">'Empty'</span> : <span class="string">'With'</span>;</span><br><span class="line">    <span class="keyword">const</span> fnType = <span class="string">`<span class="subst">$&#123;asyncCall&#125;</span><span class="subst">$&#123;emptyCall&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Object</span>.assign(target, descriptor, &#123;</span><br><span class="line">        value: functionMap[fnType].bind(<span class="literal">null</span>, excutor, target)</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œå°±å®Œæˆäº†æ‰€æœ‰åŠŸèƒ½ï¼Œä¸»è¦æ˜¯ç”¨åˆ°é—­åŒ…å’Œå‡½æ•°å½¢å‚çš„ä¸€äº›çŸ¥è¯†ç‚¹ï¼Œæœ¬é¡¹ç›®å·²ç»å¼€æºåˆ°<a href="https://github.com/rwson/bind-with-arguments.git" target="_blank" rel="noopener">github</a>ï¼Œéœ€è¦äº†è§£è¯¦ç»†çš„è¯·ç§»æ­¥</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ­¤è£…é¥°å™¨ä¸æ”¯æŒ<code>ä½¿ç”¨å±æ€§åˆå§‹åŒ–å™¨è¯­æ³•ç»‘å®šthis</code>çš„å†™æ³•ï¼Œå› ä¸ºè¿™ç§å†™æ³•åœ¨å®šä¹‰è¯¥å‡½æ•°æ—¶ï¼Œå·²ç»åšäº†ç»‘å®šï¼Œæ‰€ä»¥æ— éœ€åšé‡å¤å·¥ä½œ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;code&gt;React&lt;/code&gt;ä½œä¸ºç›®å‰ç‚™æ‰‹å¯çƒ­çš„å‰ç«¯æ¡†æ¶ï¼Œé‡Œé¢æœ‰å¾ˆå¤šå¸å¼•äººçš„åœ°æ–¹ï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸€äº›å¼€å‘ä½“éªŒä¸å¤ªå¥½çš„åœ°æ–¹ï¼Œæ¯”å¦‚æˆ‘ä»¬å¹³æ—¶åšäº‹ä»¶ç»‘å®šçš„æ—¶å€™è¦æ˜¾ç¤ºçš„ç»‘å®š&lt;code&gt;this&lt;/code&gt;ï¼Œå¦åˆ™å°±å¯èƒ½å¯¼è‡´å„ç§&lt;code&gt;bug&lt;/code&gt;ï¼Œå…³äºäº‹ä»¶&lt;code&gt;th
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/categories/JavaScript/"/>
    
      <category term="React" scheme="http://yoursite.com/categories/JavaScript/React/"/>
    
      <category term="decorator" scheme="http://yoursite.com/categories/JavaScript/React/decorator/"/>
    
    
  </entry>
  
  <entry>
    <title>redux-logicæºç é˜…è¯»</title>
    <link href="http://yoursite.com/2018/06/06/2018-06-06-read-redux-logic/"/>
    <id>http://yoursite.com/2018/06/06/2018-06-06-read-redux-logic/</id>
    <published>2018-06-05T16:00:00.000Z</published>
    <updated>2018-06-08T03:24:12.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ç”¨<a href="https://reactjs.org/" target="_blank" rel="noopener">React</a>å’Œ<a href="https://redux.js.org/" target="_blank" rel="noopener">Redux</a>åšå¼€å‘æ—¶, éƒ½ä¼šç”¨åˆ°å¼‚æ­¥çš„ä¸€äº›ä¸œè¥¿, ä¹‹å‰æ›´å¤šçš„ç”¨çš„æ˜¯<code>redux-thunk</code>æˆ–è€…<code>redux-saga</code>ä¹‹ç±»çš„, ä½†æ˜¯éƒ½æœ‰ç”¨çš„ä¸é¡ºçš„åœ°æ–¹, æœ‰ä¸€æ¬¡çªç„¶å‘ç°<a href="https://github.com/jeffbski/redux-logic" target="_blank" rel="noopener">redux-logic</a>æ˜¯ä¸€ä¸ªå¾ˆä¸é”™çš„è§£å†³æ–¹æ¡ˆ, ç”¨èµ·æ¥ä¹Ÿæ„Ÿè§‰å¾ˆé¡ºæ‰‹, ä¸å¸‚é¢ä¸Šå…¶ä»–<code>redux</code>ä¸­é—´ä»¶ä¸åŒçš„åˆ†æéƒ½åœ¨<a href="https://codewinds.com/assets/article/redux-logic-nodevember.pdf" target="_blank" rel="noopener">è¿™é‡Œ</a>, æ„Ÿå…´è¶£çš„å¯ä»¥è‡ªå·±æŸ¥çœ‹ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸‹<code>redux-logic</code>çš„åŸºæœ¬ç”¨æ³•:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//logic/index.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; createLogic &#125; <span class="keyword">from</span> <span class="string">'redux-logic'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> someLogic = createLogic(&#123;</span><br><span class="line"><span class="comment">//å½“å‰logicç›‘å¬çš„actionType</span></span><br><span class="line">type: <span class="string">'SOME_ACTION_TYPE'</span>,</span><br><span class="line"></span><br><span class="line"><span class="comment">//å–æ¶ˆå½“å‰logicæ‰§è¡Œçš„actionType</span></span><br><span class="line">cancelType: <span class="string">'CANCEL_TYPE'</span>,</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ˜¯å¦è·å–æœ€åä¸€ä¸ªè¿”å›</span></span><br><span class="line">latest: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line"><span class="comment">//å½“å‰actionTypeçš„ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line"><span class="keyword">async</span> process(&#123; getState, action, cancelled &#125;, dispatch, done) &#123;</span><br><span class="line"><span class="keyword">const</span> res = <span class="keyword">await</span> asyncFn();</span><br><span class="line">dispatch(newAction(&#123;</span><br><span class="line">...res</span><br><span class="line">&#125;));</span><br><span class="line">done();</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> someLogic;</span><br><span class="line"></span><br><span class="line"><span class="comment">//store/index.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; createStore, applyMiddleware &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createLogicMiddleware &#125; <span class="keyword">from</span> <span class="string">'redux-logic'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; routerMiddleware &#125; <span class="keyword">from</span> <span class="string">'react-router-redux'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> reducer <span class="keyword">from</span> <span class="string">'../reducers'</span>;</span><br><span class="line"><span class="keyword">import</span> history <span class="keyword">from</span> <span class="string">'../history'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; someLogic &#125; <span class="keyword">from</span> <span class="string">'../logic'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> configureStore = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> reduxRouteMiddleware = routerMiddleware(history),</span><br><span class="line"></span><br><span class="line"><span class="comment">//å°†æ‰€æœ‰çš„logicåº”ç”¨åˆ°ä¸­é—´ä»¶ä¸­</span></span><br><span class="line">    loggicMiddleware = createLogicMiddleware([someLogic]),</span><br><span class="line">    middlewares = process.env.NODE_ENV === <span class="string">'development'</span> ? [loggicMiddleware, reduxRouteMiddleware, logger] : [loggicMiddleware, reduxRouteMiddleware],</span><br><span class="line">        createStoreWithMiddleware = applyMiddleware(...middlewares)(createStore),</span><br><span class="line">        store = createStoreWithMiddleware(reducer);</span><br><span class="line">    <span class="keyword">return</span> store;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> configureStore();</span><br></pre></td></tr></table></figure><p>æœ¬æ–‡ä¼šé€æ­¥åˆ†æ<code>redux-logic</code>çš„ç›¸å…³å®ç°, é¦–å…ˆæŠŠ<a href="https://github.com/jeffbski/redux-logic" target="_blank" rel="noopener">redux-logic</a>å…‹éš†åˆ°æœ¬åœ°, æºç éƒ½ä½äº<code>redux-logic/src</code>é‡Œé¢, æ‰€ä»¥æˆ‘ä»¬ä»<code>src/index.js</code>å¼€å§‹:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> createLogic, &#123; configureLogic &#125; <span class="keyword">from</span> <span class="string">'./createLogic'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> createLogicMiddleware <span class="keyword">from</span> <span class="string">'./createLogicMiddleware'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  configureLogic,</span><br><span class="line">  createLogic,</span><br><span class="line">  createLogicMiddleware</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  configureLogic,</span><br><span class="line">  createLogic,</span><br><span class="line">  createLogicMiddleware</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„ä»£ç ä¸­å¯ä»¥çœ‹åˆ°, ä¸€å…±å¯¼å‡º3ä¸ªå‡½æ•°, <code>configureLogic</code>çš„åŠŸèƒ½å°±æ˜¯å¯¹æ‰€æœ‰çš„<code>logic</code>è¿›è¡Œé…ç½®(è¶…æ—¶è­¦å‘Šæ—¶é—´ç­‰), æˆ‘ä»¬ä¸»è¦çœ‹<code>createLogic</code>å’Œ<code>createLogicMiddleware</code>:</p><ul><li>createLogic</li></ul><p><code>createLogic</code>ä½äº<code>src/createLogic</code>é‡Œ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ›å»ºä¸€ä¸ªLogicå¯¹è±¡</span></span><br><span class="line"><span class="comment"> * @param  &#123;Object&#125; logicOptions</span></span><br><span class="line"><span class="comment"> *         @param  &#123;String&#125;     logicOptions.name           å¯é€‰å€¼, ä¸»è¦ç”¨äºLogicä¸­çš„å¼‚å¸¸æç¤º, å¯é€‰å€¼</span></span><br><span class="line"><span class="comment"> *         @param  &#123;String&#125;     logicOptions.type           è§¦å‘å½“å‰Logicçš„redux action type</span></span><br><span class="line"><span class="comment"> *         @param  &#123;String&#125;     logicOptions.cancelType     å–æ¶ˆæ‰§è¡Œå½“å‰Logicçš„redux action type</span></span><br><span class="line"><span class="comment"> *         @param  &#123;Boolean&#125;    logicOptions.latest         æ˜¯å¦åªè·å–æœ€åä¸€æ¬¡çš„ç»“æœ,ç±»ä¼¼redux-sagaä¸­çš„takeLatest effect</span></span><br><span class="line"><span class="comment"> *         @param  &#123;Number&#125;     logicOptions.debounce       å‡½æ•°å»æŠ–é…ç½®, å•ä½ä¸ºæ¯«ç§’</span></span><br><span class="line"><span class="comment"> *         @param  &#123;Object&#125;     logicOptions.throttle       å‡½æ•°èŠ‚æµé…ç½®, å•ä½ä¸ºæ¯«ç§’</span></span><br><span class="line"><span class="comment"> *         @param  &#123;Function&#125;   logicOptions.validate       åœ¨æ‰§è¡Œprocessä¹‹å‰çš„ä¸€ä¸ªé’©å­, å¯ä»¥å¯¹å½“å‰actionæ‰§è¡Œä¸€äº›æ“ä½œ</span></span><br><span class="line"><span class="comment"> *         @param  &#123;Function&#125;   logicOptions.transform      validateçš„ä¸€ä¸ªåˆ«å, validateå’Œtransformåªéœ€æŒ‡å®šä¸€ä¸ªå³å¯</span></span><br><span class="line"><span class="comment"> *         @param  &#123;Function&#125;   logicOptions.process        å½“å‰redux action typeå¯¹åº”çš„å¤„ç†é€»è¾‘(å‘èµ·å¼‚æ­¥è¯·æ±‚, åœ¨å¼‚æ­¥è¯·æ±‚è¿”å›æˆåŠŸä¹‹åè§¦å‘æ–°çš„redux action)</span></span><br><span class="line"><span class="comment"> *         @param  &#123;Object&#125;     logicOptions.processOptions processä¸­éœ€è¦çš„ä¸€äº›é…ç½®</span></span><br><span class="line"><span class="comment"> *         @param  &#123;Number&#125;     logicOptions.warnTimeout    è¶…æ—¶è­¦å‘Šæ—¶é—´, é»˜è®¤60ç§’, éœ€è¦åœ¨processä¸­æ‰‹åŠ¨è°ƒç”¨doneæ¥ç»ˆæ­¢è¿™ä¸ªLogic, å¦‚æœæ˜¯ä¸€ä¸ªæŒç»­æ€§çš„Logic, warnTimeoutéœ€è¦è®¾ç½®æˆ0</span></span><br><span class="line"><span class="comment"> * @return &#123;Object&#125;              åˆ›å»ºå‡ºæ¥çš„Logic</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">createLogic</span>(<span class="params">logicOptions = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//  æ— æ•ˆé…ç½®é¡¹éªŒè¯, æŠŠæ— æ•ˆçš„é…ç½®é¡¹é”®åæ”¾æ•°ç»„è¿”å›</span></span><br><span class="line">    <span class="keyword">const</span> invalidOptions = getInvalidOptions(logicOptions, allowedOptions);</span><br><span class="line">    <span class="keyword">if</span> (invalidOptions.length) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`unknown or misspelled option(s): <span class="subst">$&#123;invalidOptions&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  name, type, cancelType, validate, transforméƒ½ä»ä¼ å…¥çš„logicOptionsé‡Œé¢è·å–</span></span><br><span class="line">    <span class="comment">//  å¦‚æœå…¶ä»–é…ç½®é¡¹æ²¡æœ‰åœ¨logicOptionsä¸­å£°æ˜, å°±ä»é»˜è®¤é…ç½®ä¸­è·å–æˆ–è€…ç»™ä¸€ä¸ªé»˜è®¤å€¼</span></span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">        name,</span><br><span class="line">        type,</span><br><span class="line">        cancelType,</span><br><span class="line">        warnTimeout = defaultOptions.warnTimeout,</span><br><span class="line">        latest = defaultOptions.latest,</span><br><span class="line">        debounce = defaultOptions.debounce,</span><br><span class="line">        throttle = defaultOptions.throttle,</span><br><span class="line">        validate,</span><br><span class="line">        transform,</span><br><span class="line">        process = emptyProcess,</span><br><span class="line">        processOptions = &#123;&#125;</span><br><span class="line">    &#125; = logicOptions;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  typeå¿…ä¼ </span></span><br><span class="line">    <span class="keyword">if</span> (!type) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'type is required, use \'*\' to match all actions'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  validateå’Œtranformåªèƒ½åŒæ—¶æŒ‡å®šä¸€ä¸ª</span></span><br><span class="line">    <span class="keyword">if</span> (validate &amp;&amp; transform) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'logic cannot define both the validate and transform hooks they are aliases'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  warnTimeoutéœ€è¦æ”¾åœ¨processOptionsåŒçº§</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> processOptions.warnTimeout !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'warnTimeout is a top level createLogic option, not a processOptions option'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  è·å–processOptionsä¸­çš„æ— æ•ˆé…ç½®é¡¹</span></span><br><span class="line">    <span class="keyword">const</span> invalidProcessOptions = getInvalidOptions(processOptions, allowedProcessOptions);</span><br><span class="line">    <span class="keyword">if</span> (invalidProcessOptions.length) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`unknown or misspelled processOption(s): <span class="subst">$&#123;invalidProcessOptions&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  å¦‚æœvalidateå’Œtransforméƒ½æ²¡ä¼ å…¥,å°±ç”¨é»˜è®¤çš„, å¦åˆ™å°±ç”¨ä¼ å…¥çš„validate</span></span><br><span class="line">    <span class="keyword">const</span> validateDefaulted = (!validate &amp;&amp; !transform) ?</span><br><span class="line">        identityValidation :</span><br><span class="line">        validate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  å¦‚æœåœ¨processOptionsé‡Œé¢æŒ‡å®šäº†dispatchMultiple, warnTimeoutåº”è¯¥æ˜¯0</span></span><br><span class="line">    <span class="keyword">if</span> (NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">        <span class="keyword">typeof</span> processOptions.dispatchMultiple !== <span class="string">'undefined'</span> &amp;&amp;</span><br><span class="line">        warnTimeout !== <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(<span class="string">`warning: in logic for type(s): <span class="subst">$&#123;type&#125;</span> - dispatchMultiple is always true in next version. For non-ending logic, set warnTimeout to 0`</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        æ ¹æ®process.lengthå¯ä»¥è·å–ä¼ å…¥çš„processå¯¹åº”çš„å¤„ç†å‡½æ•°ä¸­çš„å½¢å‚ä¸ªæ•°</span></span><br><span class="line"><span class="comment">        ä»è€Œç¡®å®šprocessOptionä¸­çš„ä¸€äº›é»˜è®¤å€¼</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        const fn = function(arg1, agr2) &#123;&#125;;</span></span><br><span class="line"><span class="comment">        console.log(fn.length);  -&gt; 2</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        const fn = function(arg1, agr2, arg3) &#123;&#125;;</span></span><br><span class="line"><span class="comment">        console.log(fn.length); -&gt; 3</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    <span class="keyword">switch</span> (process.length) &#123;</span><br><span class="line">        <span class="comment">//  å¦‚æœæ²¡æœ‰æˆ–åªæœ‰ä¸€ä¸ªå½¢å‚æ²¡æœ‰ä¼ å…¥ä¸”dispatchReturnæ²¡æœ‰åœ¨processOptionsä¼ å…¥, å°±æŠŠå®ƒè®¾ç½®æˆtrue</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            setIfUndefined(processOptions, <span class="string">'dispatchReturn'</span>, <span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//  ä¸¤ä¸ªå½¢å‚(single-dispatchæ¨¡å¼[å·²åºŸå¼ƒ])</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">if</span> (NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">                !processOptions.dispatchMultiple &amp;&amp;</span><br><span class="line">                warnTimeout !== <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">console</span>.error(<span class="string">`warning: in logic for type(s): <span class="subst">$&#123;type&#125;</span> - single-dispatch mode is deprecated, call done when finished dispatching. For non-ending logic, set warnTimeout: 0`</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">            3ä¸ªå½¢å‚åŠæ›´å¤š, è®¤ä¸ºæ˜¯multi-dispatchæ¨¡å¼</span></span><br><span class="line"><span class="comment">            processOptions.dispatchMultiple = processOptions === undefined ? true : processOptions.dispatchMultiple</span></span><br><span class="line"><span class="comment">        **/</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            setIfUndefined(processOptions, <span class="string">'dispatchMultiple'</span>, <span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  è¿”å›å¤„ç†å¥½çš„å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        name: typeToStrFns(name),</span><br><span class="line">        type: typeToStrFns(type),</span><br><span class="line">        cancelType: typeToStrFns(cancelType),</span><br><span class="line">        latest,</span><br><span class="line">        debounce,</span><br><span class="line">        throttle,</span><br><span class="line">        validate: validateDefaulted,</span><br><span class="line">        transform,</span><br><span class="line">        process,</span><br><span class="line">        processOptions,</span><br><span class="line">        warnTimeout</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„åˆ†æä¸­æˆ‘ä»¬å¯ä»¥å¾—å‡º: åœ¨<code>createLogic</code>ä¸­åšçš„ä¸»è¦æ˜¯ä¸€äº›å‚æ•°çš„éªŒè¯å’Œé»˜è®¤å€¼çš„å¤„ç†, ä¸‹é¢æˆ‘ä»¬ä¸€èµ·çœ‹çœ‹ä»–é‡Œé¢çš„è°ƒç”¨çš„ä¸€äº›çš„å®ç°:</p><p>å…ˆæ¥çœ‹ä¸‹<code>getInvalidOptions</code>:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getInvalidOptions</span>(<span class="params">options, validOptions</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Object</span>.keys(options)</span><br><span class="line">    .filter(<span class="function"><span class="params">k</span> =&gt;</span> validOptions.indexOf(k) === <span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**æ¯”å¦‚åœ¨createLogicé‡Œçš„ç¬¬ä¸€è¡Œå°±è°ƒç”¨äº†è¯¥æ–¹æ³•</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">export default function createLogic(logicOptions = &#123;&#125;) &#123;</span></span><br><span class="line"><span class="comment">  const invalidOptions = getInvalidOptions(logicOptions, allowedOptions);</span></span><br><span class="line"><span class="comment">  //...</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">const allowedOptions = [</span></span><br><span class="line"><span class="comment">  'name',</span></span><br><span class="line"><span class="comment">  'type',</span></span><br><span class="line"><span class="comment">  'cancelType',</span></span><br><span class="line"><span class="comment">  'latest',</span></span><br><span class="line"><span class="comment">  'debounce',</span></span><br><span class="line"><span class="comment">  'throttle',</span></span><br><span class="line"><span class="comment">  'validate',</span></span><br><span class="line"><span class="comment">  'transform',</span></span><br><span class="line"><span class="comment">  'process',</span></span><br><span class="line"><span class="comment">  'processOptions',</span></span><br><span class="line"><span class="comment">  'warnTimeout'</span></span><br><span class="line"><span class="comment">];</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">**/</span></span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„åˆ†æä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡º, <code>getInvalidOptions</code>ç”¨æ¥è·å–<code>Object</code>é‡Œçš„ä¸åˆæ³•çš„é…ç½®é¡¹, å¹¶æŠŠéæ³•çš„<code>key</code>ä½œä¸ºæ•°ç»„çš„å½¢å¼è¿”å›ã€‚</p><p><code>typeToStrFns</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¦‚æœæ˜¯æ•°ç»„å½¢å¼å°±é’ˆå¯¹æ•°ç»„çš„æ¯ä¸€é¡¹éƒ½è°ƒç”¨typeToStrFns, è¿”å›ä¸€ä¸ªæ–°æ•°ç»„</span></span><br><span class="line"><span class="comment">//å¦‚æœæ˜¯å‡½æ•°å½¢å¼å°±è¿”å›å‡½æ•°ä½“çš„å­—ç¬¦ä¸²å½¢å¼</span></span><br><span class="line"><span class="comment">//å…¶å®ƒç›´æ¥è¿”å›</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">typeToStrFns</span>(<span class="params">type</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(type)) &#123; <span class="keyword">return</span> type.map(<span class="function"><span class="params">x</span> =&gt;</span> typeToStrFns(x)); &#125;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">typeof</span> type === <span class="string">'function'</span>) ?</span><br><span class="line">    type.toString() :</span><br><span class="line">    type;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>setIfUndefined</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setIfUndefined</span>(<span class="params">obj, propName, propValue</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> obj[propName] === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">    obj[propName] = propValue;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ²¡ä»€ä¹ˆå¥½è¯´çš„ğŸ˜‚</p><ul><li>createLogicMiddleware<br><code>createLogic</code>åˆ†æå®Œäº†, ä¸‹é¢ä¸€èµ·çœ‹çœ‹<code>createLogicMiddleware</code>, <code>createLogicMiddleware</code>ä½äº<code>src/createLogicMiddleware</code>é‡Œ:</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">@param arrLogic  Array.&lt;logic&gt;</span></span><br><span class="line"><span class="comment">@param deps  Object</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">createLogicMiddleware</span>(<span class="params">arrLogic = [], deps = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(arrLogic)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'createLogicMiddleware needs to be called with an array of logic items'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ¤æ–­æ˜¯å¦æœ‰é‡å¤çš„logic</span></span><br><span class="line">  <span class="keyword">const</span> duplicateLogic = findDuplicates(arrLogic);</span><br><span class="line">  <span class="keyword">if</span> (duplicateLogic.length) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`duplicate logic, indexes: <span class="subst">$&#123;duplicateLogic&#125;</span>`</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">å› ä¸ºredux-logicé›†æˆäº†rxjs</span></span><br><span class="line"><span class="comment">æ‰€ä»¥Subjectå’ŒBehaviorSubjectéƒ½æ˜¯rxjsé‡Œçš„ä¸»ä½“</span></span><br><span class="line"><span class="comment">BehaviorSubjectä½œä¸ºSubjectçš„ä¸€ä¸ªå˜ä½“, å’ŒSubjectä¸åŒçš„æ˜¯å®ƒæœ‰ä¸€ä¸ªåˆå§‹å€¼</span></span><br><span class="line"><span class="comment">https://cn.rx.js.org/manual/overview.html#h15</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line">  <span class="keyword">const</span> actionSrc$ = <span class="keyword">new</span> Subject();</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç”¨æ¥ç›‘è§†æ‰€æœ‰action</span></span><br><span class="line">  <span class="keyword">const</span> monitor$ = <span class="keyword">new</span> Subject();</span><br><span class="line">  <span class="keyword">const</span> lastPending$ = <span class="keyword">new</span> BehaviorSubject(&#123; <span class="attr">op</span>: OP_INIT &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¯¹monitor$ä½¿ç”¨ç´¯åŠ å™¨å‡½æ•°,è¿”å›ç”Ÿæˆçš„ä¸­é—´å€¼,å¯é€‰çš„åˆå§‹å€¼</span></span><br><span class="line">  monitor$</span><br><span class="line">    .scan(<span class="function">(<span class="params">acc, x</span>) =&gt;</span> &#123; <span class="comment">// è¿½åŠ ä¸€ä¸ªpendingçŠ¶æ€çš„è®¡æ•°å™¨</span></span><br><span class="line">      <span class="keyword">let</span> pending = acc.pending || <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">switch</span> (x.op) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'top'</span> : <span class="comment">// å½“å‰actionä½äºlogicæ ˆçš„é¡¶çº§</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">'begin'</span> : <span class="comment">// å¼€å§‹è§¦å‘ä¸€ä¸ªaction</span></span><br><span class="line">          pending += <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">åœ¨createLogicé‡Œçš„processä¸­è°ƒç”¨äº†done, doneçš„å®ç°ç¨å€™åˆ†æ;</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">'end'</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'bottom'</span>: <span class="comment">// actionå˜æˆäº†ä¸€ä¸ªè¢«è½¬æ¢åçš„æ–°action</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">åœ¨createLogicé‡Œçš„validateä¸­è°ƒç”¨äº†allow, ä¸”è§¦å‘äº†ä¸€ä¸ªæ–°çš„action</span></span><br><span class="line"><span class="comment">craeteLogic(&#123;</span></span><br><span class="line"><span class="comment">...</span></span><br><span class="line"><span class="comment">validate(&#123; getState, action &#125;, allow, reject) &#123;</span></span><br><span class="line"><span class="comment">allow(action);</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">&#125;)</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">'nextDisp'</span> :</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'filtered'</span> : <span class="comment">// å½“å‰actionç”±äºæ— æ•ˆè¢«è¿‡æ»¤</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">'dispatchError'</span> : <span class="comment">// æ´¾å‘actionçš„æ—¶å€™å¼‚å¸¸(å¥½åƒæš‚æ—¶æ²¡ç”¨åˆ°)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">åœ¨actionæ‹¦æˆªå™¨(validate)é‡Œé¢æ‰§è¡Œreject</span></span><br><span class="line"><span class="comment">craeteLogic(&#123;</span></span><br><span class="line"><span class="comment">...</span></span><br><span class="line"><span class="comment">validate(&#123; getState, action &#125;, allow, reject) &#123;</span></span><br><span class="line"><span class="comment">reject(action);</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">&#125;)</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">'cancelled'</span>:</span><br><span class="line">          pending -= <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...x,</span><br><span class="line">        pending</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;, &#123; <span class="attr">pending</span>: <span class="number">0</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//https://cn.rx.js.org/manual/usage.html</span></span><br><span class="line">    .subscribe(lastPending$);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> savedStore;</span><br><span class="line">  <span class="keyword">let</span> savedNext;</span><br><span class="line">  <span class="keyword">let</span> actionEnd$;</span><br><span class="line">  <span class="keyword">let</span> logicSub;</span><br><span class="line">  <span class="keyword">let</span> logicCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç¼“å­˜ä¼ å…¥çš„logicæ•°ç»„</span></span><br><span class="line">  <span class="keyword">let</span> savedLogicArr = arrLogic;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è°ƒç”¨å®ŒcreateLogicMiddlewareåè¿”å›çš„reduxä¸­é—´ä»¶</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">mw</span>(<span class="params">store</span>) </span>&#123;</span><br><span class="line"><span class="comment">//å¤šæ¬¡è°ƒç”¨äº†createLogicMiddleware, å¹¶ä¸”ä¼ å…¥äº†ä¸åŒçš„store</span></span><br><span class="line">    <span class="keyword">if</span> (savedStore &amp;&amp; savedStore !== store) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'cannot assign logicMiddleware instance to multiple stores, create separate instance for each'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç¼“å­˜æœ¬æ¬¡è°ƒç”¨ä¼ å…¥çš„store</span></span><br><span class="line">    savedStore = store;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">next</span> =&gt;</span> &#123;</span><br><span class="line">      savedNext = next;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä»applyLogicè¿”å›ä¸­è·å–action$, sub, æŠŠlogicCountèµ‹å€¼ç»™cnt</span></span><br><span class="line">      <span class="keyword">const</span> &#123; action$, sub, <span class="attr">logicCount</span>: cnt &#125; =</span><br><span class="line">            applyLogic(arrLogic, savedStore, savedNext,</span><br><span class="line">                       logicSub, actionSrc$, deps, logicCount,</span><br><span class="line">                       monitor$);</span><br><span class="line">      actionEnd$ = action$;</span><br><span class="line">      logicSub = sub;</span><br><span class="line">      logicCount = cnt;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">        debug(<span class="string">'starting off'</span>, action);</span><br><span class="line">        monitor$.next(&#123; action, <span class="attr">op</span>: <span class="string">'top'</span> &#125;);</span><br><span class="line">        actionSrc$.next(action);</span><br><span class="line">        <span class="keyword">return</span> action;</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//ç»™mwæŒ‚è½½ä¸€ä¸ªæŒ‡å‘monitor$çš„monitor$å±æ€§</span></span><br><span class="line">  mw.monitor$ = monitor$;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¸€ä¸ªè‡ªå®šä¹‰é’©å­å‡½æ•°, ä¸»è¦ç”¨äºæµ‹è¯•</span></span><br><span class="line"><span class="comment">     * @param  &#123;Function&#125; fn   å¯å†™å…¥ç›¸å…³æµ‹è¯•é€»è¾‘</span></span><br><span class="line"><span class="comment">     * @return &#123;Objetc&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    mw.whenComplete = <span class="function"><span class="keyword">function</span> <span class="title">whenComplete</span>(<span class="params">fn = identity</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> lastPending$</span><br><span class="line">            <span class="comment">//  åªæœ‰å½“x.pending &gt; 0æ˜¯æ‰ç»§ç»­å¾€ä¸‹èµ°</span></span><br><span class="line">            .takeWhile(<span class="function"><span class="params">x</span> =&gt;</span> x.pending)</span><br><span class="line">            .map(<span class="function">(<span class="params"> <span class="regexp">/* x */</span> </span>) =&gt;</span> <span class="literal">undefined</span>)</span><br><span class="line">            .toPromise()</span><br><span class="line">            .then(fn);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">ç»™å½“å‰reduxä¸­é—´ä»¶åŠ¨æ€æ·»åŠ ä¾èµ–(ç›¸å½“äºcreateLogicMiddlewareç¬¬äºŒä¸ªå‚æ•°çš„æ‹“å±•)</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line">  mw.addDeps = <span class="function"><span class="keyword">function</span> <span class="title">addDeps</span>(<span class="params">additionalDeps</span>) </span>&#123;</span><br><span class="line"><span class="comment">//æ‰€æ·»åŠ çš„ä¾èµ–å¿…é¡»æ˜¯ä¸€ä¸ªå¯¹è±¡ç±»å‹</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> additionalDeps !== <span class="string">'object'</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'addDeps should be called with an object'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//éå†æ‰€æ·»åŠ çš„ä¸­é—´ä»¶</span></span><br><span class="line">    <span class="built_in">Object</span>.keys(additionalDeps).forEach(<span class="function"><span class="params">k</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> existing = deps[k];</span><br><span class="line">      <span class="keyword">const</span> newValue = additionalDeps[k];</span><br><span class="line"><span class="comment">//æ‰€æ·»åŠ çš„ä¸­é—´ä»¶ä¸èƒ½å’Œå½“å‰å·²æœ‰çš„é‡å(å½“å‰å·²ç»æœ‰çš„ä¸èƒ½è¢«è¦†ç›–)</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> existing !== <span class="string">'undefined'</span> &amp;&amp;</span><br><span class="line">          existing !== newValue) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`addDeps cannot override an existing dep value: <span class="subst">$&#123;k&#125;</span>`</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      deps[k] = newValue;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">ç»™å½“å‰reduxä¸­é—´ä»¶åŠ¨æ€æ·»åŠ æ–°çš„logic</span></span><br><span class="line"><span class="comment">@param arrNewLogic Array.&lt;Logic&gt;</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line">  mw.addLogic = <span class="function"><span class="keyword">function</span> <span class="title">addLogic</span>(<span class="params">arrNewLogic</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!arrNewLogic.length) &#123; <span class="keyword">return</span> &#123; logicCount &#125;; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆå¹¶åˆ°å½“å‰å·²æœ‰çš„æ•°ç»„é‡Œé¢</span></span><br><span class="line">    <span class="keyword">const</span> combinedLogic = savedLogicArr.concat(arrNewLogic);</span><br><span class="line">    <span class="keyword">const</span> duplicateLogic = findDuplicates(combinedLogic);</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ¤æ–­æ˜¯å¦æœ‰é‡å¤</span></span><br><span class="line">    <span class="keyword">if</span> (duplicateLogic.length) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`duplicate logic, indexes: <span class="subst">$&#123;duplicateLogic&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> &#123; action$, sub, <span class="attr">logicCount</span>: cnt &#125; =</span><br><span class="line">          applyLogic(arrNewLogic, savedStore, savedNext,</span><br><span class="line">                     logicSub, actionEnd$, deps, logicCount, monitor$);</span><br><span class="line">    actionEnd$ = action$;</span><br><span class="line">    logicSub = sub;</span><br><span class="line">    logicCount = cnt;</span><br><span class="line">    savedLogicArr = combinedLogic;</span><br><span class="line">    debug(<span class="string">'added logic'</span>);</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">logicCount</span>: cnt &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">ç»™å½“å‰reduxä¸­é—´ä»¶åˆå¹¶æ–°çš„logic</span></span><br><span class="line"><span class="comment">@param arrNewLogic Array.&lt;Logic&gt;</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line">  mw.mergeNewLogic = <span class="function"><span class="keyword">function</span> <span class="title">mergeNewLogic</span>(<span class="params">arrMergeLogic</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦é‡å</span></span><br><span class="line">    <span class="keyword">const</span> duplicateLogic = findDuplicates(arrMergeLogic);</span><br><span class="line">    <span class="keyword">if</span> (duplicateLogic.length) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`duplicate logic, indexes: <span class="subst">$&#123;duplicateLogic&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿‡æ»¤æ‰é‡å¤çš„</span></span><br><span class="line">    <span class="keyword">const</span> arrNewLogic = arrMergeLogic.filter(<span class="function"><span class="params">x</span> =&gt;</span></span><br><span class="line">      savedLogicArr.indexOf(x) === <span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">return</span> mw.addLogic(arrNewLogic);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">æ›¿æ¢å½“å‰æ‰€æœ‰çš„logicå˜æˆæ–°çš„logic</span></span><br><span class="line"><span class="comment">   **/</span></span><br><span class="line">  mw.replaceLogic = <span class="function"><span class="keyword">function</span> <span class="title">replaceLogic</span>(<span class="params">arrRepLogic</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> duplicateLogic = findDuplicates(arrRepLogic);</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ¤æ–­æ–°çš„logicæ•°ç»„é‡Œæ˜¯å¦æœ‰é‡å¤çš„logic</span></span><br><span class="line">    <span class="keyword">if</span> (duplicateLogic.length) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`duplicate logic, indexes: <span class="subst">$&#123;duplicateLogic&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> &#123; action$, sub, <span class="attr">logicCount</span>: cnt &#125; =</span><br><span class="line">          applyLogic(arrRepLogic, savedStore, savedNext,</span><br><span class="line">                     logicSub, actionSrc$, deps, <span class="number">0</span>, monitor$);</span><br><span class="line">    actionEnd$ = action$;</span><br><span class="line">    logicSub = sub;</span><br><span class="line">    logicCount = cnt;</span><br><span class="line">    savedLogicArr = arrRepLogic;</span><br><span class="line">    debug(<span class="string">'replaced logic'</span>);</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">logicCount</span>: cnt &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> mw;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„åˆ†æä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡º, <code>createLogicMiddleware</code>è¿”å›äº†ä¸€ä¸ªä¸­é—´ä»¶, è¯¥ä¸­é—´ä»¶åŸºäº<a href="https://cn.rx.js.org/" target="_blank" rel="noopener">Rxjs</a>å®ç°, è¿”å›çš„ä¸­é—´ä»¶ä¸­å¤„ç†ç›¸å…³<code>redux action</code>å¯¹åº”çš„é€»è¾‘ã€‚</p><p>åœ¨<code>createLogicMiddleware</code>ä¸­è°ƒç”¨äº†ä¸€äº›å…¶ä»–å‡½æ•°, é€ä¸ªçœ‹ä¸‹è¿™äº›å‡½æ•°çš„å®ç°:</p><p><code>findDuplicates</code>, è¯¥æ–¹æ³•å®ŒæˆæŸ¥æ‰¾æ•°ç»„é‡Œé¢é‡å¤çš„<code>Logic</code>, å¹¶è®°å½•é‡å¤çš„ä¸‹æ ‡è¿”å›</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">@param arrLogic  Array.&lt;Logic&gt;   logicæ•°ç»„</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @param  &#123;Array.&lt;Logic&gt;&#125;  arrLogic Logicæ•°ç»„</span></span><br><span class="line"><span class="comment"> * @return &#123;Array.&lt;Number&gt;&#125;          é‡å¤çš„Logicä¸‹æ ‡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findDuplicates</span>(<span class="params">arrLogic</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> arrLogic.reduce(<span class="function">(<span class="params">acc, x1, idx1</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//  ä¸æ˜¯åŒä¸€ä¸ªä¸‹æ ‡, ä¸”å€¼ç›¸ç­‰çš„æƒ…å†µä¸‹å°±æŠŠä¸‹æ ‡æ”¾åˆ°accé‡Œé¢</span></span><br><span class="line">    <span class="keyword">if</span> (arrLogic.some(<span class="function">(<span class="params">x2, idx2</span>) =&gt;</span> (idx1 !== idx2 &amp;&amp; x1 === x2))) &#123;</span><br><span class="line">      acc.push(idx1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> acc;</span><br><span class="line">  &#125;, []);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†çœ‹çœ‹çœ‹<code>applyLogic</code>çš„å®ç°:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @param  &#123;Array.&lt;Logic&gt;&#125;   arrLogic        Logicæ•°ç»„</span></span><br><span class="line"><span class="comment"> * @param  &#123;Object&#125;         store            redux store</span></span><br><span class="line"><span class="comment"> * @param  &#123;Function&#125;       next             reduxä¸­é—´ä»¶ä¸­çš„ç¬¬äºŒå±‚å‡½æ•°</span></span><br><span class="line"><span class="comment"> * @param  &#123;Rx.Subject&#125;     sub              å½“å‰actionå¯¹åº”çš„</span></span><br><span class="line"><span class="comment"> * @param  &#123;Rx.Subject&#125;     actionIn$        å½“å‰actionå¯¹åº”çš„å¯è®¢é˜…å¯¹è±¡</span></span><br><span class="line"><span class="comment"> * @param  &#123;Object&#125;         deps             createLogicMiddleçš„ç¬¬äºŒä¸ªå‚æ•°</span></span><br><span class="line"><span class="comment"> * @param  &#123;Number&#125;         startLogicCount  ç”¨äºå‘½å</span></span><br><span class="line"><span class="comment"> * @param  &#123;Rx.Subject&#125;     monitor$         å…¨å±€å¯è®¢é˜…å¯¹è±¡</span></span><br><span class="line"><span class="comment"> * @return &#123;Object&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">applyLogic</span>(<span class="params">arrLogic, store, next, sub, actionIn$, deps, startLogicCount, monitor$</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!store || !next) &#123; <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'store is not defined'</span>); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  å¦‚æœå½“å‰Logicå·²ç»æ˜¯ä¸€ä¸ªRx.Subject(å·²ç»è¢«è®¢é˜…è¿‡äº†), å–æ¶ˆè®¢é˜…</span></span><br><span class="line">    <span class="keyword">if</span> (sub) &#123; sub.unsubscribe(); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  å¯¹å½“å‰Logicæ•°ç»„è¿›è¡Œæ“ä½œ(å‘½åç­‰), è¿”å›ä¸€ä¸ªæ–°æ•°ç»„</span></span><br><span class="line">    <span class="keyword">const</span> wrappedLogic = arrLogic.map(<span class="function">(<span class="params">logic, idx</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">//  ç»™å½“å‰æœªæŒ‡å®šnameçš„Logicè¿›è¡Œå‘½åå¹¶ä¸”è¿”å›, namingç¨å€™åˆ†æ</span></span><br><span class="line">        <span class="keyword">const</span> namedLogic = naming(logic, idx + startLogicCount);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//  åŒ…è£…å‘½ååçš„Logic, wrapperç¨å€™åˆ†æ</span></span><br><span class="line">        <span class="keyword">return</span> wrapper(namedLogic, store, deps, monitor$);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> actionOut$ = wrappedLogic.reduce(<span class="function">(<span class="params">acc$, wep</span>) =&gt;</span> wep(acc$), actionIn$);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  è®¢é˜…æ–°çš„Observableå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">const</span> newSub = actionOut$.subscribe(<span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">        debug(<span class="string">'actionEnd$'</span>, action);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> result = next(action);</span><br><span class="line">            debug(<span class="string">'result'</span>, result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            <span class="built_in">console</span>.error(<span class="string">'error in mw dispatch or next call, probably in middlware/reducer/render fn:'</span>, err);</span><br><span class="line">            <span class="keyword">const</span> msg = (err &amp;&amp; err.message) ? err.message : err;</span><br><span class="line">            monitor$.next(&#123; action, <span class="attr">err</span>: msg, <span class="attr">op</span>: <span class="string">'nextError'</span> &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//  actionå˜æˆäº†ä¸€ä¸ªè¢«è½¬æ¢åçš„æ–°action</span></span><br><span class="line">        monitor$.next(&#123; <span class="attr">nextAction</span>: action, <span class="attr">op</span>: <span class="string">'bottom'</span> &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        action$: actionOut$,</span><br><span class="line">        sub: newSub,</span><br><span class="line">        logicCount: startLogicCount + arrLogic.length</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„åˆ†æä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡º, <code>applyLogic</code>è¿”å›äº†ä¸€ä¸ªæ–°çš„<a href="https://cn.rx.js.org/class/es6/Observable.js~Observable.html" target="_blank" rel="noopener">Rx.Observable</a>, é‡Œé¢è°ƒç”¨äº†<code>naming</code>å’Œ<code>wrapper</code>, ä¸‹é¢æˆ‘ä»¬é€ä¸ªåˆ†æä¸‹ã€‚</p><p>å…ˆçœ‹<code>naming</code>çš„å®ç°å§:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ¤æ–­å½“å‰ä¼ å…¥çš„Logicæœ‰æ²¡æœ‰name, æœ‰å°±ä¸åšä»»ä½•æ“ä½œç›´æ¥è¿”å›, æ²¡æœ‰å°±ç»™å½“å‰Logicæ·»åŠ ä¸€ä¸ªnameå±æ€§åè¿”å›</span></span><br><span class="line"><span class="comment"> * @param  &#123;Object&#125; logic å½“å‰Logic</span></span><br><span class="line"><span class="comment"> * @param  &#123;Number&#125; idx   å½“å‰Logicåœ¨arrLogicä¸­çš„ä¸‹æ ‡åœ°å€</span></span><br><span class="line"><span class="comment"> * @return &#123;Object&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">naming</span>(<span class="params">logic, idx</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (logic.name) &#123; <span class="keyword">return</span> logic; &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        ...logic,</span><br><span class="line">        name: <span class="string">`L(<span class="subst">$&#123;logic.type.toString()&#125;</span>)-<span class="subst">$&#123;idx&#125;</span>`</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†çœ‹ä¸‹<code>wrapper</code>çš„, <code>wrapper</code>æ˜¯å†™åœ¨<code>src/logicWrapper</code>é‡Œçš„, <code>wrapper</code>è¿”å›çš„æ˜¯ä¸€ä¸ª<code>Rx.Observable</code>:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Logicä¸­ç›¸å…³å¤„ç†</span></span><br><span class="line"><span class="comment"> * @param  &#123;Object&#125;     options.action   å½“å‰action</span></span><br><span class="line"><span class="comment"> * @param  &#123;Object&#125;     options.logic    å½“å‰logic</span></span><br><span class="line"><span class="comment"> * @param  &#123;Object&#125;     options.store    redux store</span></span><br><span class="line"><span class="comment"> * @param  &#123;Object&#125;     options.deps     createLogicMiddlewareçš„ç¬¬äºŒä¸ªå‚æ•°</span></span><br><span class="line"><span class="comment"> * @param  &#123;Rx.Subject&#125; options.cancel$  å–æ¶ˆLogicæ‰§è¡Œçš„è®¢é˜…å¯¹è±¡</span></span><br><span class="line"><span class="comment"> * @param  &#123;Rx.Subject&#125; options.monitor$ å…¨å±€å¯è®¢é˜…å¯¹è±¡</span></span><br><span class="line"><span class="comment"> * @return &#123;Rx.Observable&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">createLogicAction$</span>(<span class="params">&#123; action, logic, store, deps, cancel$, monitor$ &#125;</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  reduxStore.getState()</span></span><br><span class="line">    <span class="keyword">const</span> &#123; getState &#125; = store;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  ä»å½“å‰logicä¸­å–å¾—ç›¸å…³é…ç½®å‚æ•°</span></span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">        name,</span><br><span class="line">        warnTimeout,</span><br><span class="line">        process: processFn,</span><br><span class="line">        processOptions: &#123;</span><br><span class="line">            dispatchReturn,</span><br><span class="line">            dispatchMultiple,</span><br><span class="line">            successType,</span><br><span class="line">            failType</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; = logic;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  å½“å‰Logicçš„æ‹¦æˆªå™¨</span></span><br><span class="line">    <span class="keyword">const</span> intercept = logic.validate || logic.transform;</span><br><span class="line"></span><br><span class="line">    debug(<span class="string">'createLogicAction$'</span>, name, action);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  å¼€å§‹æœ¬æ¬¡actionçš„æ‰§è¡Œ</span></span><br><span class="line">    monitor$.next(&#123; action, name, <span class="attr">op</span>: <span class="string">'begin'</span> &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        1.å½“å‰actionå‘ç”Ÿæ”¹å˜</span></span><br><span class="line"><span class="comment">        2.åœ¨validate/transformä¸­è°ƒç”¨allow</span></span><br><span class="line"><span class="comment">        3.æ— æ•ˆçš„action type</span></span><br><span class="line"><span class="comment">        4.actionè¢«å–æ¶ˆ</span></span><br><span class="line"><span class="comment">        interceptCompleteéƒ½ä¼šå˜æˆtrue, æ ‡è®°æ‹¦æˆªå™¨å¤„ç†å®Œæˆ</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="keyword">let</span> interceptComplete = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  https://cn.rx.js.org/class/es6/Observable.js~Observable.html#instance-method-take</span></span><br><span class="line">    <span class="keyword">const</span> logicAction$ = Observable.create(<span class="function"><span class="params">logicActionObs</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">//  åˆ›å»ºä¸€ä¸ªä¸»é¢˜(åªå‘å‡ºä¸€ä¸ªå€¼), ç”¨æ¥è®¢é˜…`å–æ¶ˆLogicæ‰§è¡Œçš„è®¢é˜…å¯¹è±¡`, åœ¨å–æ¶ˆæœ¬æ¬¡actionå, é€šçŸ¥`å–æ¶ˆLogicæ‰§è¡Œçš„è®¢é˜…å¯¹è±¡`</span></span><br><span class="line">            <span class="keyword">const</span> cancelled$ = (<span class="keyword">new</span> Subject()).take(<span class="number">1</span>);</span><br><span class="line">            cancel$.subscribe(cancelled$);</span><br><span class="line">            cancelled$</span><br><span class="line">                .subscribe(</span><br><span class="line">                    () =&gt; &#123;</span><br><span class="line">                        <span class="comment">//  ç¡®ä¿cancelä¸ä¼šè¢«è°ƒç”¨2æ¬¡(åœ¨createLogicMiddleä¸­è¿½åŠ çš„pendingåªä¼šè¢«å‡ä¸€æ¬¡)</span></span><br><span class="line">                        <span class="keyword">if</span> (!interceptComplete) &#123;</span><br><span class="line">                            monitor$.next(&#123; action, name, <span class="attr">op</span>: <span class="string">'cancelled'</span> &#125;);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            monitor$.next(&#123; action, name, <span class="attr">op</span>: <span class="string">'dispCancelled'</span> &#125;);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                );</span><br><span class="line"></span><br><span class="line">            <span class="comment">//  å¦‚æœå½“å‰Logicä¸æ˜¯ä¸€ä¸ªæŒç»­æ€§çš„, ä¸”æ²¡æœ‰åœ¨warnTimeout / 1000ç§’å†…è°ƒç”¨done(warnTimeout &gt; 0), å°±ç»™å‡ºå¼‚å¸¸æç¤º</span></span><br><span class="line">            <span class="keyword">if</span> (NODE_ENV !== <span class="string">'production'</span> &amp;&amp; warnTimeout) &#123;</span><br><span class="line">                Observable.timer(warnTimeout)</span><br><span class="line">                    <span class="comment">//  https://cn.rx.js.org/class/es6/Observable.js~Observable.html#instance-method-takeUntil</span></span><br><span class="line">                    <span class="comment">//  https://cn.rx.js.org/class/es6/Observable.js~Observable.html#instance-method-defaultIfEmpty</span></span><br><span class="line">                    .takeUntil(cancelled$.defaultIfEmpty(<span class="literal">true</span>))</span><br><span class="line">                    .do(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                        <span class="comment">//console.error(`warning: logic ($&#123;name&#125;) is still running after $&#123;warnTimeout / 1000&#125;s, forget to call done()? For non-ending logic, set warnTimeout: 0`);</span></span><br><span class="line">                    &#125;)</span><br><span class="line">                    .subscribe();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> dispatch$ = (<span class="keyword">new</span> Subject())</span><br><span class="line">                .mergeAll()</span><br><span class="line">                .takeUntil(cancel$);</span><br><span class="line"></span><br><span class="line">            dispatch$</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                    .do(&#123;</span></span><br><span class="line"><span class="comment">                        nextOrObserver: mapToActionAndDispatch,</span></span><br><span class="line"><span class="comment">                        error: mapErrorToActionAndDispatch</span></span><br><span class="line"><span class="comment">                    &#125;)</span></span><br><span class="line"><span class="comment">                    è¿™é‡Œçœç•¥äº†nextOrObserverå’Œerror</span></span><br><span class="line"><span class="comment">                    https://cn.rx.js.org/class/es6/Observable.js~Observable.html#instance-method-do</span></span><br><span class="line"><span class="comment">                 **/</span></span><br><span class="line">                .do(</span><br><span class="line">                    mapToActionAndDispatch,</span><br><span class="line">                    mapErrorToActionAndDispatch</span><br><span class="line">                )</span><br><span class="line">                .subscribe(&#123;</span><br><span class="line">                    error: <span class="function">(<span class="params"> <span class="regexp">/* err */</span> </span>) =&gt;</span> &#123;</span><br><span class="line">                        <span class="comment">//  åœ¨å‘ç”Ÿå¼‚å¸¸å, ç»ˆæ­¢æœ¬æ¬¡acion, å¹¶ä¸”å–æ¶ˆè®¢é˜…cancelled$</span></span><br><span class="line">                        monitor$.next(&#123; action, name, <span class="attr">op</span>: <span class="string">'end'</span> &#125;);</span><br><span class="line">                        cancelled$.complete();</span><br><span class="line">                        cancelled$.unsubscribe();</span><br><span class="line">                    &#125;,</span><br><span class="line">                    complete: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                        <span class="comment">//  æœ¬æ¬¡actionå¤„ç†å®Œæˆ</span></span><br><span class="line">                        monitor$.next(&#123; action, name, <span class="attr">op</span>: <span class="string">'end'</span> &#125;);</span><br><span class="line">                        cancelled$.complete();</span><br><span class="line">                        cancelled$.unsubscribe();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//  è§¦å‘reduxé‡Œé¢çš„action</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">storeDispatch</span>(<span class="params">act</span>) </span>&#123;</span><br><span class="line">                monitor$.next(&#123; action, <span class="attr">dispAction</span>: act, <span class="attr">op</span>: <span class="string">'dispatch'</span> &#125;);</span><br><span class="line">                <span class="keyword">return</span> store.dispatch(act);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * é€‚é…ä¸åŒæƒ…å†µçš„action, ç»„è£…åå¦‚æœæ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„redux action, å°±è°ƒç”¨reduxStore.dispatch</span></span><br><span class="line"><span class="comment">             * @param  &#123;Object&#125; actionOrValue</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">mapToActionAndDispatch</span>(<span class="params">actionOrValue</span>) </span>&#123;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                    let act;</span></span><br><span class="line"><span class="comment">                    if (isInterceptAction(actionOrValue)) &#123;</span></span><br><span class="line"><span class="comment">                        act = unwrapInterceptAction(actionOrValue);</span></span><br><span class="line"><span class="comment">                    &#125; else &#123;</span></span><br><span class="line"><span class="comment">                        if (successType) &#123;</span></span><br><span class="line"><span class="comment">                            act = mapToAction(successType, actionOrValue, false);</span></span><br><span class="line"><span class="comment">                        &#125; else &#123;</span></span><br><span class="line"><span class="comment">                            act = actionOrValue;</span></span><br><span class="line"><span class="comment">                        &#125;</span></span><br><span class="line"><span class="comment">                    &#125;</span></span><br><span class="line"><span class="comment">                    æŠŠä¸‹é¢çš„ä»£ç æ‹†æˆä¸Šé¢çš„æ ·å­, å¤§æ¦‚åšäº†ä¸‹é¢å‡ ä»¶äº‹æƒ…:</span></span><br><span class="line"><span class="comment">                    åˆ¤æ–­æ˜¯ä¸æ˜¯ä¸€ä¸ªæ‹¦æˆªå™¨, å¦‚æœæ˜¯å°±æŠŠä¹‹å‰åŒ…è£…çš„æ‹¦æˆªå™¨è§£åŒ…</span></span><br><span class="line"><span class="comment">                    åˆ¤æ–­processOptions.successTypeæ˜¯å¦å­˜åœ¨, å­˜åœ¨å°±è°ƒç”¨mapToAction, æ‹¼å‡ºä¸€ä¸ªæ–°çš„redux action, è°ƒç”¨reduxSrore.dispatch</span></span><br><span class="line"><span class="comment">                    å¦åˆ™å°±ç›´æ¥ä½¿ç”¨actionOrValue</span></span><br><span class="line"><span class="comment">                **/</span></span><br><span class="line">                <span class="keyword">const</span> act = (isInterceptAction(actionOrValue)) ? </span><br><span class="line">                unwrapInterceptAction(actionOrValue) : (successType) ? </span><br><span class="line">                mapToAction(successType, actionOrValue, <span class="literal">false</span>) : actionOrValue;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (act) &#123;</span><br><span class="line">                    storeDispatch(act);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * æ ¹æ®actionOrValueçš„ç±»å‹æ¥ç»„è£…å¯ä»¥è¢«reduxStore.dispatchè°ƒç”¨çš„action</span></span><br><span class="line"><span class="comment">             * @param  &#123;any&#125; actionOrValue</span></span><br><span class="line"><span class="comment">             * @return &#123;Object&#125;</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">mapErrorToActionAndDispatch</span>(<span class="params">actionOrValue</span>) </span>&#123;</span><br><span class="line">                <span class="comment">//  æ‹¦æˆªå™¨ç±»å‹çš„ç›´æ¥è°ƒç”¨è§¦å‘__interceptAction</span></span><br><span class="line">                <span class="keyword">if</span> (isInterceptAction(actionOrValue)) &#123;</span><br><span class="line">                    <span class="keyword">const</span> interceptAction = unwrapInterceptAction(actionOrValue);</span><br><span class="line">                    <span class="keyword">return</span> storeDispatch(interceptAction);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//  åˆ¤æ–­Logicä¸­çš„processOptionsé‡Œæœ‰æ²¡æœ‰failType</span></span><br><span class="line">                <span class="keyword">if</span> (failType) &#123;</span><br><span class="line">                    <span class="comment">//  å¦‚æœæœ‰failType, ç»„è£…ä¸€ä¸ªæ–°çš„redux actionå¹¶è§¦å‘</span></span><br><span class="line">                    <span class="keyword">const</span> act = mapToAction(failType, actionOrValue, <span class="literal">true</span>);</span><br><span class="line">                    <span class="keyword">if</span> (act) &#123;</span><br><span class="line">                        <span class="keyword">return</span> storeDispatch(act);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//  actionOrValueæœ¬èº«å°±æ˜¯ä¸€ä¸ªå¼‚å¸¸</span></span><br><span class="line">                <span class="keyword">if</span> (actionOrValue <span class="keyword">instanceof</span> <span class="built_in">Error</span>) &#123;</span><br><span class="line">                    <span class="keyword">const</span> act =</span><br><span class="line">                        <span class="comment">//  actionOrValueæœ¬èº«åŒ…å«type, ç›´æ¥è°ƒç”¨redux.dispatch(actionOrValue)</span></span><br><span class="line">                        <span class="comment">//  å¦åˆ™åŒ…è£…å‡ºä¸€ä¸ªredux action(typeä¸ºUNHANDLED_LOGIC_ERROR), åœ¨è°ƒç”¨redux.dispatch</span></span><br><span class="line">                        (actionOrValue.type) ? actionOrValue :</span><br><span class="line">                        &#123;</span><br><span class="line">                            type: UNHANDLED_LOGIC_ERROR,</span><br><span class="line">                            payload: actionOrValue,</span><br><span class="line">                            error: <span class="literal">true</span></span><br><span class="line">                        &#125;;</span><br><span class="line">                    <span class="keyword">return</span> storeDispatch(act);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//  actionOrValueæ˜¯ä¸€ä¸ªplain objectæˆ–ä¸€ä¸ªå‡½æ•°(action creator)</span></span><br><span class="line">                <span class="keyword">const</span> typeOfValue = <span class="keyword">typeof</span> actionOrValue;</span><br><span class="line">                <span class="keyword">if</span> (actionOrValue &amp;&amp; (typeOfValue === <span class="string">'object'</span> || typeOfValue === <span class="string">'function'</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> storeDispatch(actionOrValue);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//  éå¼‚å¸¸/å‡½æ•°/plain objectçš„æƒ…å†µ</span></span><br><span class="line">                storeDispatch(&#123;</span><br><span class="line">                    type: UNHANDLED_LOGIC_ERROR,</span><br><span class="line">                    payload: actionOrValue,</span><br><span class="line">                    error: <span class="literal">true</span></span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * ç»„è£…å‡ºä¸€ä¸ªæœ‰æ•ˆçš„redux actionå¹¶è¿”å›</span></span><br><span class="line"><span class="comment">             * @param  &#123;String|Function&#125; type       redux action type</span></span><br><span class="line"><span class="comment">             * @param  &#123;Object&#125; payload             redux payload</span></span><br><span class="line"><span class="comment">             * @param  &#123;Error|Unfdeined&#125; err        error</span></span><br><span class="line"><span class="comment">             * @return &#123;Object&#125;</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">mapToAction</span>(<span class="params">type, payload, err</span>) </span>&#123;</span><br><span class="line">                <span class="comment">//  action typeæœ¬èº«æ˜¯ä¸€ä¸ªaction creator, ç›´æ¥æ‰§è¡Œtype</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">typeof</span> type === <span class="string">'function'</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> type(payload);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//  åŒ…è£…å‡ºä¸€ä¸ªæœ‰æ•ˆçš„redux action</span></span><br><span class="line">                <span class="keyword">const</span> act = &#123; type, payload &#125;;</span><br><span class="line">                <span class="keyword">if</span> (err) &#123; act.error = <span class="literal">true</span>; &#125;</span><br><span class="line">                <span class="keyword">return</span> act;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// allowMore is now deprecated in favor of variable process arity</span></span><br><span class="line">            <span class="comment">// which sets processOptions.dispatchMultiple = true then</span></span><br><span class="line">            <span class="comment">// expects done() cb to be called to end</span></span><br><span class="line">            <span class="comment">// Might still be needed for internal use so keeping it for now</span></span><br><span class="line">            <span class="keyword">const</span> DispatchDefaults = &#123;</span><br><span class="line">                allowMore: <span class="literal">false</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * è§¦å‘</span></span><br><span class="line"><span class="comment">             * @param  &#123;[type]&#125; act     [description]</span></span><br><span class="line"><span class="comment">             * @param  &#123;[type]&#125; options [description]</span></span><br><span class="line"><span class="comment">             * @return &#123;[type]&#125;         [description]</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">act, options = DispatchDefaults</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">const</span> &#123; allowMore &#125; = applyDispatchDefaults(options);</span><br><span class="line">                <span class="comment">//  action !== undefined</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">typeof</span> act !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                        let action;</span></span><br><span class="line"><span class="comment">                        if (isObservable(act)) &#123;</span></span><br><span class="line"><span class="comment">                            action = act;</span></span><br><span class="line"><span class="comment">                        &#125; else if (isPromise(act)) &#123;</span></span><br><span class="line"><span class="comment">                            action = Observable.fromPromise(act);</span></span><br><span class="line"><span class="comment">                        &#125; else if (act instanceof Error) &#123;</span></span><br><span class="line"><span class="comment">                            action = Observable.throw(act);</span></span><br><span class="line"><span class="comment">                        &#125; else &#123;</span></span><br><span class="line"><span class="comment">                            action = Observable.of(act);</span></span><br><span class="line"><span class="comment">                        &#125;</span></span><br><span class="line"><span class="comment">                        dispatch$.next(action);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                        https://cn.rx.js.org/class/es6/MiscJSDoc.js~ObserverDoc.html#instance-method-next</span></span><br><span class="line"><span class="comment">                     **/</span></span><br><span class="line">                    dispatch$.next(</span><br><span class="line">                        (isObservable(act)) ? act :</span><br><span class="line">                        (isPromise(act)) ? Observable.fromPromise(act) :</span><br><span class="line">                        (act <span class="keyword">instanceof</span> <span class="built_in">Error</span>) ? Observable.throw(act) :</span><br><span class="line">                        Observable.of(act)</span><br><span class="line">                    );</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!(dispatchMultiple || allowMore)) &#123;</span><br><span class="line">                   dispatch$.complete();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> act;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">applyDispatchDefaults</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    ...DispatchDefaults,</span><br><span class="line">                    ...options</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//  æ‹¼è£…createLogicä¸­ç›¸å…³é’©å­å‡½æ•°(validate/tranform/process)ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°</span></span><br><span class="line">            <span class="keyword">const</span> depObj = &#123;</span><br><span class="line">                ...deps,</span><br><span class="line">                cancelled$,</span><br><span class="line">                ctx: &#123;&#125;, <span class="comment">// åœ¨ä¸åŒé’©å­ä¸­å…±äº«æ•°æ®</span></span><br><span class="line">                getState,</span><br><span class="line">                action</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">shouldDispatch</span>(<span class="params">act, useDispatch</span>) </span>&#123;</span><br><span class="line">                <span class="comment">//  æ–°çš„actionä¸ºç©º</span></span><br><span class="line">                <span class="keyword">if</span> (!act) &#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line">                <span class="comment">//  åœ¨è§¦å‘å¦å¤–ä¸€ä¸ªactionä¹‹å‰, ç¡®ä¿è§¦å‘çš„æ˜¯ä¸€ä¸ªæ–°çš„action</span></span><br><span class="line">                <span class="keyword">if</span> (useDispatch === <span class="string">'auto'</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> (act.type !== action.type);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//  å¦åˆ™æ ¹æ®useDispatchæ˜¯å¦ä¸ºç©º, è¿”å›</span></span><br><span class="line">                <span class="keyword">return</span> (useDispatch);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> AllowRejectNextDefaults = &#123;</span><br><span class="line">                useDispatch: <span class="string">'auto'</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">applyAllowRejectNextDefaults</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    ...AllowRejectNextDefaults,</span><br><span class="line">                    ...options</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//  æ‹¦æˆªå™¨(validate/tranform)é‡Œçš„allowæˆ–next</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">allow</span>(<span class="params">act, options = AllowRejectNextDefaults</span>) </span>&#123;</span><br><span class="line">                handleNextOrDispatch(<span class="literal">true</span>, act, options);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">reject</span>(<span class="params">act, options = AllowRejectNextDefaults</span>) </span>&#123;</span><br><span class="line">                handleNextOrDispatch(<span class="literal">false</span>, act, options);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//  å®Œæˆæœ¬æ¬¡action, åœ¨createLogicä¸­çš„processæœ€åè°ƒç”¨</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                dispatch$.complete();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * å¯¹å½“å‰æ‹¦æˆªå™¨ç±»å‹action(validate/transform)åšä¸€æ¬¡åŒ…è£…, æ–¹ä¾¿åé¢åˆ¤æ–­</span></span><br><span class="line"><span class="comment">             * @param  &#123;Object&#125; act å½“å‰action</span></span><br><span class="line"><span class="comment">             * @return &#123;Object&#125;</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">wrapActionForIntercept</span>(<span class="params">act</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (!act) &#123; <span class="keyword">return</span> act; &#125;</span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    __interceptAction: act</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * åˆ¤æ–­ä¼ å…¥çš„actionæ˜¯å¦ä¸ºæ‹¦æˆªå™¨ç±»å‹çš„</span></span><br><span class="line"><span class="comment">             * @param  &#123;Object&#125;  act å½“å‰action</span></span><br><span class="line"><span class="comment">             * @return &#123;Boolean&#125;</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">isInterceptAction</span>(<span class="params">act</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> act &amp;&amp; act.__interceptAction;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * å¯¹æ‹¦æˆªå™¨æ‰§è¡Œè§£åŒ…</span></span><br><span class="line"><span class="comment">             * @param  &#123;Object&#125;  act å½“å‰action</span></span><br><span class="line"><span class="comment">             * @return &#123;Object&#125;      redux action</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">unwrapInterceptAction</span>(<span class="params">act</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> act.__interceptAction;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * æ‹¦æˆªå™¨(validate/tranform)é‡Œçš„allowã€rejectå®ç°, è§¦å‘æ–°çš„redux action</span></span><br><span class="line"><span class="comment">             * @param  &#123;Boolean&#125; shouldProcess æ˜¯å¦æ‰§è¡Œprocess</span></span><br><span class="line"><span class="comment">             * @param  &#123;Object&#125; act            æ–°çš„redux action</span></span><br><span class="line"><span class="comment">             * @param  &#123;Object&#125; options</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">handleNextOrDispatch</span>(<span class="params">shouldProcess, act, options</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">const</span> &#123; useDispatch &#125; = applyAllowRejectNextDefaults(options);</span><br><span class="line">                <span class="comment">//  åˆ¤æ–­æ˜¯å¦åº”è¯¥è§¦å‘ä¼ å…¥çš„redux action</span></span><br><span class="line">                <span class="keyword">if</span> (shouldDispatch(act, useDispatch)) &#123;</span><br><span class="line">                    monitor$.next(&#123; action, <span class="attr">dispAction</span>: act, name, shouldProcess, <span class="attr">op</span>: <span class="string">'nextDisp'</span> &#125;);</span><br><span class="line">                    interceptComplete = <span class="literal">true</span>;</span><br><span class="line">                    dispatch(wrapActionForIntercept(act), &#123; <span class="attr">allowMore</span>: <span class="literal">true</span> &#125;); <span class="comment">// will be completed later</span></span><br><span class="line">                    logicActionObs.complete(); <span class="comment">// dispatched action, so no next(act)</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123; <span class="comment">// normal next</span></span><br><span class="line">                    <span class="keyword">if</span> (act) &#123;</span><br><span class="line">                        monitor$.next(&#123; action, <span class="attr">nextAction</span>: act, name, shouldProcess, <span class="attr">op</span>: <span class="string">'next'</span> &#125;);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">//  æ— æ•ˆçš„action, ç›´æ¥ç»“æŸæœ¬æ¬¡æ‹¦æˆªå™¨</span></span><br><span class="line">                        monitor$.next(&#123; action, name, shouldProcess, <span class="attr">op</span>: <span class="string">'filtered'</span> &#125;);</span><br><span class="line">                        interceptComplete = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    postIfDefinedOrComplete(act, logicActionObs);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//  æ‰§è¡ŒLogicä¸­çš„processå›è°ƒ</span></span><br><span class="line">                <span class="keyword">if</span> (shouldProcess) &#123;</span><br><span class="line">                    <span class="comment">//  ç»„ç»‡depObjçš„actionå‚æ•°</span></span><br><span class="line">                    depObj.action = act || action;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">const</span> retValue = processFn(depObj, dispatch, done);</span><br><span class="line">                        <span class="comment">/**</span></span><br><span class="line"><span class="comment">                            å¦‚æœåœ¨createLogicæŒ‡å®šäº†processOption.dispatchReturnä¸ºtrue, å¹¶ä¸”prcessæ‰§è¡Œå®Œä¹‹åè¿”å›æœ‰æ•ˆçš„å€¼</span></span><br><span class="line"><span class="comment">                            å°±å†æŠŠè¿”å›å€¼ä½œä¸ºä¸€ä¸ªæ–°çš„redux actionè¿›è¡Œè§¦å‘</span></span><br><span class="line"><span class="comment">                            å¦åˆ™ç›´æ¥ç»“æŸdispatch$è¿™ä¸ªRx.Subject</span></span><br><span class="line"><span class="comment">                            </span></span><br><span class="line"><span class="comment">                            æ‰§è¡Œprocess, å¹¶ä¸”æ¥æ”¶è¿”å›å€¼</span></span><br><span class="line"><span class="comment">                            åˆ¤æ–­processOption.dispatchReturn</span></span><br><span class="line"><span class="comment">                                æˆç«‹: åˆ¤æ–­è¿”å›å€¼æ˜¯å¦æœ‰æ•ˆ</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                                    æœ‰æ•ˆ: dispatch -&gt; mapToActionAndDispatch</span></span><br><span class="line"><span class="comment">                                        mapToActionAndDispatchè¿”å›ä¸€ä¸ªæœ‰æ•ˆçš„action:</span></span><br><span class="line"><span class="comment">                                            ç»§ç»­reduxStore.dispatch(mapToActionAndDispatch(retValue))</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                                    æ— æ•ˆ: dispatch$.complete -&gt; monitor$.next(&#123; action, name, op: 'end' &#125;); cancelled$.complete(); cancelled$.unsubscribe();</span></span><br><span class="line"><span class="comment">                        **/</span></span><br><span class="line">                        <span class="keyword">if</span> (dispatchReturn) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (<span class="keyword">typeof</span> retValue === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">                                dispatch$.complete();</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                dispatch(retValue);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">                        <span class="built_in">console</span>.error(<span class="string">`unhandled exception in logic named: <span class="subst">$&#123;name&#125;</span>`</span>, err);</span><br><span class="line">                        <span class="comment">//  æ‰§è¡Œprocessçš„è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸</span></span><br><span class="line">                        dispatch(Observable.throw(err));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//  ä¼ å…¥çš„actæ˜¯ä¸€ä¸ªç©ºå€¼, æˆ–è€…å’Œå½“å‰çš„typeç›¸åŒ, æˆ–è€…useDispatchä¸æˆç«‹</span></span><br><span class="line">                    dispatch$.complete();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * åœ¨æœ¬æ¬¡æ‹¦æˆªå™¨ä¹‹åæ‰§è¡Œ</span></span><br><span class="line"><span class="comment">             * @param  &#123;Object&#125; act       æ–°çš„action</span></span><br><span class="line"><span class="comment">             * @param  &#123;Rx.Subject&#125; act$  å½“å‰actionå¯¹åº”çš„Observableå¯¹è±¡</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">postIfDefinedOrComplete</span>(<span class="params">act, act$</span>) </span>&#123;</span><br><span class="line">                <span class="comment">//  å¦‚æœæ–°çš„actionå­˜åœ¨, æ‰§è¡Œæ–°çš„action</span></span><br><span class="line">                <span class="keyword">if</span> (act) &#123;</span><br><span class="line">                    act$.next(act);</span><br><span class="line">                &#125;</span><br><span class="line">                interceptComplete = <span class="literal">true</span>;</span><br><span class="line">                act$.complete();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//  å¼€å§‹æœ¬æ¬¡actionçš„æ‰§è¡Œ</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">start</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                intercept(depObj, allow, reject);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            start();</span><br><span class="line">        &#125;)</span><br><span class="line">        .takeUntil(cancel$)</span><br><span class="line">        <span class="comment">//  è§„å®šlogicAction$å€¼å‘å‡ºä¸€ä¸ªå€¼å°±å®Œæˆ</span></span><br><span class="line">        .take(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> logicAction$;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šå°±æ˜¯æœ¬äººå¯¹<code>redux-logic</code>çš„é˜…è¯», ç»è¿‡é˜…è¯», å¤§è‡´äº†è§£åˆ°æ•´ä¸ª<code>redux-logic</code>çš„æ‰§è¡Œé¡ºåºåº”è¯¥æ˜¯ä¸‹å›¾æ‰€ç¤ºçš„æ ·å­ã€‚</p><p><img src="/imgs/redux-logic.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨ç”¨&lt;a href=&quot;https://reactjs.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;React&lt;/a&gt;å’Œ&lt;a href=&quot;https://redux.js.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/categories/JavaScript/"/>
    
      <category term="React" scheme="http://yoursite.com/categories/JavaScript/React/"/>
    
      <category term="Redux" scheme="http://yoursite.com/categories/JavaScript/React/Redux/"/>
    
    
  </entry>
  
  <entry>
    <title>Vueä¸­computedè®¡ç®—å±æ€§å’Œwatchè§‚å¯Ÿè€…åŸç†</title>
    <link href="http://yoursite.com/2017/11/09/2017-11-09-vue-computed/"/>
    <id>http://yoursite.com/2017/11/09/2017-11-09-vue-computed/</id>
    <published>2017-11-08T16:00:00.000Z</published>
    <updated>2017-11-09T08:54:04.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ç”¨<code>Vue</code>åšå¼€å‘ä¸­, æˆ‘ä»¬å¤šå¤šå°‘å°‘éƒ½ä¼šç”¨åˆ°é‡Œé¢ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„ä¸œè¥¿: <code>computed</code>å’Œ<code>watch</code>, æ¥ä¸‹æ¥æˆ‘ä»¬ä¸€èµ·åˆ†æå¹¶ç®€å•å®ç°ä¸‹è¿™ä¸¤ä¸ªå±æ€§ã€‚</p><h4 id="computed"><a href="#computed" class="headerlink" title="computed"></a>computed</h4><p><code>computed</code>åä¸ºè®¡ç®—å±æ€§, ç›®çš„å°±æ˜¯è®©æˆ‘ä»¬åœ¨æ¨¡æ¿é‡Œé¢åªå…³æ³¨ç®€å•çš„ç»‘å®š, ä¸åšå¤æ‚æ“ä½œ, æ‹¿å®˜ç½‘çš„ä»£ç åšä¾‹å­,ä¸‹é¢å°±æ˜¯ä¸€ä¸ªç›¸å¯¹å¤æ‚çš„æ“ä½œ:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"example"</span>&gt;</span></span><br><span class="line">  &#123;&#123; message.split('').reverse().join('') &#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å…ˆæ¥çœ‹ä¸‹ç”¨æ³•:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    data() &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        firstName: <span class="string">"rw"</span>,</span><br><span class="line">        lastName: <span class="string">"son"</span>,</span><br><span class="line">        age: <span class="number">25</span></span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    computed: &#123;</span><br><span class="line">      <span class="comment">//  æŒ‡å®šè®¡ç®—å±æ€§çš„getter</span></span><br><span class="line">      info() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">`info content: my name is <span class="subst">$&#123;<span class="keyword">this</span>.firstName&#125;</span><span class="subst">$&#123;<span class="keyword">this</span>.lastName&#125;</span>, I'm <span class="subst">$&#123;<span class="keyword">this</span>.age&#125;</span> years old`</span>;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">//  åŒæ—¶æä¾›getterå’Œsetter, setterä¸­å¯ä»¥æ“ä½œå…¶ä»–æ•°æ®</span></span><br><span class="line">      fullName: &#123;</span><br><span class="line">        <span class="keyword">get</span>() &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="string">`my fullName is: <span class="subst">$&#123;<span class="keyword">this</span>.firstName&#125;</span><span class="subst">$&#123;<span class="keyword">this</span>.lastName&#125;</span>`</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">set</span>(value) &#123;</span><br><span class="line">          value = value.split(<span class="string">" "</span>);</span><br><span class="line">          <span class="keyword">this</span>.firstName = value[<span class="number">0</span>];</span><br><span class="line">          <span class="keyword">this</span>.lastName = value[value.length - <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">  text: <span class="string">"just a test case"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    created() &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="keyword">this</span>.info);</span><br><span class="line">      <span class="comment">//  info content: my name is rwson, I'm 25 years old</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.fullName = <span class="string">"son rw"</span>;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">console</span>.log(<span class="keyword">this</span>.info);</span><br><span class="line">      <span class="comment">//  info content: my name is sonrw, I'm 25 years old</span></span><br><span class="line"></span><br><span class="line">      <span class="built_in">console</span>.log(<span class="keyword">this</span>.fullName);</span><br><span class="line">      <span class="comment">//  my fullName is: sonrw</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><code>computed</code>çš„ç”¨æ³•å°±æ˜¯ä¸Šé¢ä¾‹å­ä¸­çš„ä¸¤ç§, ä¸‹é¢æˆ‘ä»¬ä¸€èµ·æ¥æ¨¡æ‹Ÿå®ç°ä¸‹:</p><p>é¦–å…ˆæˆ‘ä»¬æ¨¡æ‹Ÿå°è£…ä¸€ä¸ª<code>Vm</code>å‡½æ•°ä½œä¸ºæ„é€ å™¨, ç„¶åå»è°ƒç”¨å®ƒ,</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vm = <span class="keyword">new</span> Vm(&#123;</span><br><span class="line">data() &#123;</span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">firstName: <span class="string">"rw"</span>,</span><br><span class="line">lastName: <span class="string">"son"</span>,</span><br><span class="line">age: <span class="number">25</span></span><br><span class="line">&#125;;</span><br><span class="line">&#125;,</span><br><span class="line">computed: &#123;</span><br><span class="line">info() &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">`info content: my name is <span class="subst">$&#123;<span class="keyword">this</span>.firstName&#125;</span><span class="subst">$&#123;<span class="keyword">this</span>.lastName&#125;</span>, I'm <span class="subst">$&#123;<span class="keyword">this</span>.age&#125;</span> years old`</span>;</span><br><span class="line">&#125;,</span><br><span class="line">fullName: &#123;</span><br><span class="line"><span class="keyword">get</span>() &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">`my fullName is: <span class="subst">$&#123;<span class="keyword">this</span>.firstName&#125;</span><span class="subst">$&#123;<span class="keyword">this</span>.lastName&#125;</span>`</span>;</span><br><span class="line">&#125;,</span><br><span class="line"><span class="keyword">set</span>(value) &#123;</span><br><span class="line">value = value.split(<span class="string">" "</span>);</span><br><span class="line"><span class="keyword">this</span>.firstName = value[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">this</span>.lastName = value[value.length - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line">text: <span class="string">"just a test case"</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(vm.text);</span><br><span class="line"><span class="comment">//just a test case</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(vm.info);</span><br><span class="line"><span class="comment">//info content: my name is rwson, I'm 25 years old</span></span><br><span class="line"></span><br><span class="line">vm.fullName = <span class="string">"song rw"</span>;</span><br><span class="line"><span class="built_in">console</span>.log(vm.info);</span><br><span class="line"><span class="comment">//info content: my name is songrw, I'm 25 years old</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(vm.firstName);</span><br><span class="line"><span class="comment">//song</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯è¿è¡Œç»“æœå’Œè°ƒç”¨, ä¸‹é¢æˆ‘ä»¬ä¸€èµ·å®ç°ä¸‹<code>Vm</code>è¿™ä¸ªå‡½æ•°:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//vmæ„é€ å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vm</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line"><span class="keyword">const</span> data = obj.data();</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¤„ç†dataæ‰§è¡Œçš„è¿”å›ç»“æœ</span></span><br><span class="line">handleData(<span class="keyword">this</span>, data);</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¤„ç†compotedå¯¹è±¡</span></span><br><span class="line">handleComputed(<span class="keyword">this</span>, obj.computed);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//hasOwnPropertyç®€å†™</span></span><br><span class="line"><span class="keyword">const</span> hasOwnProp = <span class="function">(<span class="params">obj, prop</span>) =&gt;</span> obj.hasOwnProperty(prop);</span><br><span class="line"></span><br><span class="line"><span class="comment">//è·å–prototypeç±»å</span></span><br><span class="line"><span class="keyword">const</span> typeOf = <span class="function">(<span class="params">obj</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="keyword">return</span> &#123;&#125;.toString.call(obj).slice(<span class="number">8</span>, <span class="number">-1</span>).toLowerCase();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æšä¸¾å¯¹è±¡</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loopObj</span>(<span class="params">obj, callback</span>) </span>&#123;</span><br><span class="line"> <span class="built_in">Object</span>.keys(obj).forEach(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">callback(key, obj[key], obj);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç»™dataç”¨Object.definePropertyç»‘å®š</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleData</span>(<span class="params">context, data</span>) </span>&#123;</span><br><span class="line">loopObj(data, (key, val, data) =&gt; &#123;</span><br><span class="line">defineProp(context, key, val);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¤„ç†computedå±æ€§</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleComputed</span>(<span class="params">context, obj</span>) </span>&#123;</span><br><span class="line"><span class="keyword">let</span> type;</span><br><span class="line">loopObj(obj, (key, val, obj) =&gt; &#123;</span><br><span class="line">defineProp(context, key, val);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">defineProp</span>(<span class="params">obj, key, val</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> _val = val, type;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">        enumerable: <span class="literal">true</span>,</span><br><span class="line">        configable: <span class="literal">true</span>,</span><br><span class="line">        <span class="keyword">get</span>: function() &#123;</span><br><span class="line">            type = typeOf(_val);</span><br><span class="line">            <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * å±æ€§å€¼å¯¹åº”ä¸€ä¸ªå‡½æ•°, ä¹Ÿå°±æ˜¯computedé‡Œé¢åªå£°æ˜äº†getter</span></span><br><span class="line"><span class="comment">             * eg.</span></span><br><span class="line"><span class="comment">             * ...</span></span><br><span class="line"><span class="comment">             * computed: &#123;</span></span><br><span class="line"><span class="comment">             * info() &#123;</span></span><br><span class="line"><span class="comment">             * return `info content: my name is $&#123;this.firstName&#125;$&#123;this.lastName&#125;, I'm $&#123;this.age&#125; years old`;</span></span><br><span class="line"><span class="comment">             * &#125;</span></span><br><span class="line"><span class="comment">             * ...</span></span><br><span class="line"><span class="comment">             * &#125;</span></span><br><span class="line"><span class="comment">             * ...</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">"function"</span>:</span><br><span class="line">            <span class="keyword">return</span> _val.call(obj);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * å±æ€§å€¼å¯¹åº”ä¸€ä¸ªå¯¹è±¡, ä¹Ÿå°±æ˜¯computedé‡Œé¢åŒæ—¶å£°æ˜äº†getter/setter</span></span><br><span class="line"><span class="comment">             * eg.</span></span><br><span class="line"><span class="comment">             * ...</span></span><br><span class="line"><span class="comment">             * computed: &#123;</span></span><br><span class="line"><span class="comment">             * fullName: &#123;</span></span><br><span class="line"><span class="comment">             * get() &#123;</span></span><br><span class="line"><span class="comment">             * return `my fullName is: $&#123;this.firstName&#125;$&#123;this.lastName&#125;`;</span></span><br><span class="line"><span class="comment">             * &#125;,</span></span><br><span class="line"><span class="comment">             * set() &#123;</span></span><br><span class="line"><span class="comment">             * value = value.split(" ");</span></span><br><span class="line"><span class="comment">             * this.firstName = value[0];</span></span><br><span class="line"><span class="comment">             * this.lastName = value[value.length - 1];</span></span><br><span class="line"><span class="comment">             * &#125;</span></span><br><span class="line"><span class="comment">             * &#125;</span></span><br><span class="line"><span class="comment">             * &#125;</span></span><br><span class="line"><span class="comment">             * ...</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">"object"</span>:</span><br><span class="line">            <span class="keyword">return</span> _val.get.call(obj);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//å…¶ä»–ç±»å‹é»˜è®¤</span></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> _val;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">set</span>: function(newV) &#123;</span><br><span class="line">        type = typeOf(_val);</span><br><span class="line">        <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">        <span class="comment">//å±æ€§å€¼å¯¹åº”ä¸€ä¸ªå¯¹è±¡, ä¹Ÿå°±æ˜¯computedé‡Œé¢åŒæ—¶å£°æ˜äº†getter/setter</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">"object"</span>:</span><br><span class="line">        _val.set.call(obj, newV);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å…¶ä»–ç±»å‹çš„é»˜è®¤</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">if</span> (newV !== _val) &#123;</span><br><span class="line">        _val = newV;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢å°±æ˜¯æˆ‘ä»¬ä¸€ä¸ªå®ç°äº†, å…¶ä¸­<code>defineProp</code>è¿™ä¸ªå‡½æ•°ä¸­, æˆ‘ä»¬åšäº†ä¸‹é¢å‡ æ­¥:</p><ol><li>ç¼“å­˜å½“å‰å±æ€§å€¼</li><li>è°ƒç”¨Object.definePropertyæ–¹æ³•åœ¨objä¸Šå®šä¹‰å±æ€§key</li><li>åœ¨<code>descriptor</code>ä¸­çš„<code>getter</code>/<code>setter</code>é‡Œé¢åˆ¤æ–­å±æ€§å€¼ç±»å‹(å¦‚æœæ˜¯å‡½æ•°æˆ–è€…å¯¹è±¡, é‚£è¯¥å±æ€§å°±æ˜¯åœ¨<code>computed</code>[å…ˆä¸è°ˆ<code>watch</code>]é‡Œé¢å£°æ˜çš„, <code>getter</code>é‡Œé¢è¿”å›è¯¥å‡½æ•°çš„æ‰§è¡Œç»“æœã€<code>setter</code>é‡Œé¢æ‰§è¡Œ<code>computed</code>ä¸­æŒ‡å®šçš„<code>set</code>å‡½æ•°[å¦‚æœæœ‰çš„è¯], å¦åˆ™ä½œä¸ºæ™®é€šçš„<code>data</code>å¤„ç†)</li></ol><h4 id="watch"><a href="#watch" class="headerlink" title="watch"></a>watch</h4><p><code>watch</code>åä¸ºè§‚å¯Ÿè€…, é€šè¿‡ç›‘å¬ç»„ä»¶å†…æŸä¸ªå±æ€§æ¥æ‰§è¡ŒæŸäº›æ“ä½œ, æœ€å¸¸ç”¨çš„å°±æ˜¯ç»„ä»¶ä¸­æŸä¸ªå±æ€§å€¼å‘ç”Ÿå˜åŒ–ä¹‹å, å‘åç«¯å‘é€ä¸€ä¸ªå¼‚æ­¥è¯·æ±‚, æ¯”å¦‚ä¸€äº›å•†å“ç½‘ç«™ä¸Šæœ‰é¡¶éƒ¨tabæ , æ¯ä¸ªtabéƒ½æ˜¯ä¸€ä¸ªç±»ç›®, è¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥ç»™è¿™äº›tabç»‘å®š<code>click</code>äº‹ä»¶, ç„¶ååœ¨äº‹ä»¶å¤„ç†ä¸­å¤„ç†é¡¶éƒ¨tabæ ç»‘å®šçš„å±æ€§å€¼, watchä¸­å»ç›‘å¬å®ƒçš„å˜åŒ–æ¥å‘é€å¼‚æ­¥è¯·æ±‚ç­‰ç­‰, æ¯”å¦‚ä¸‹é¢çš„ä¾‹å­:</p><p>å…ˆæ¥çœ‹æ¨¡æ¿éƒ¨åˆ†:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> @<span class="attr">click</span>=<span class="string">"setFilter('1')"</span>&gt;</span>ç”·è£…<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> @<span class="attr">click</span>=<span class="string">"setFilter('2')"</span>&gt;</span>å¥³è£…<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> @<span class="attr">click</span>=<span class="string">"setFilter('3')"</span>&gt;</span>ç«¥è£…<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> @<span class="attr">click</span>=<span class="string">"setFilter('4')"</span>&gt;</span>ç¾é£Ÿ<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬çœ‹çœ‹jséƒ¨åˆ†å®ç°:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span>() &#123;</span><br><span class="line">data() &#123;</span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">page: <span class="number">1</span>,</span><br><span class="line">filter: <span class="string">"1"</span>,</span><br><span class="line">goodsList: []</span><br><span class="line">&#125;;</span><br><span class="line">&#125;,</span><br><span class="line">watch: &#123;</span><br><span class="line"><span class="keyword">async</span> filter() &#123;</span><br><span class="line"><span class="keyword">const</span> &#123; filter, page &#125; = <span class="keyword">this</span>,</span><br><span class="line">res = <span class="keyword">await</span> <span class="keyword">this</span>.queryGoods(filter, page);</span><br><span class="line"><span class="keyword">if</span> (res.success) &#123;</span><br><span class="line"><span class="keyword">this</span>.goodsList = res.goods;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line">methods: &#123;</span><br><span class="line">setFilter(filter) &#123;</span><br><span class="line"><span class="keyword">this</span>.filter = filter;</span><br><span class="line"><span class="keyword">this</span>.page = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">this</span>.goodsList = [];</span><br><span class="line">&#125;,</span><br><span class="line"><span class="keyword">async</span> queryGoods(filter, page) &#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç„¶è¿™ä¸ªä¾‹å­å¯èƒ½æœ‰ç‚¹æç«¯, å› ä¸º<code>queryGoods</code>å®Œå…¨å¯ä»¥æ”¾åœ¨<code>setFilter</code>é‡Œé¢å»è°ƒç”¨, ä½†æ˜¯ä¸ºäº†æ¼”ç¤ºæ•ˆæœ, åªèƒ½è¿™ä¹ˆåšäº†ğŸ˜‚</p><p>ä¸‹é¢ä¸€èµ·çœ‹çœ‹çœ‹çœ‹<code>watch</code>éƒ¨åˆ†çš„å®ç°, æœ‰äº†åˆšæ‰çš„åˆ†æ, æˆ‘ä»¬çŸ¥é“<code>watch</code>ä¸­å£°æ˜çš„è‚¯å®šæ˜¯åœ¨<code>setter</code>éƒ¨åˆ†è¿›è¡Œè°ƒç”¨çš„, æ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨å¤„ç†<code>data</code>çš„æ—¶å€™å°±æŠŠ<code>watch</code>å¯¹åº”çš„åŠ ä¸Š:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//é¦–å…ˆæˆ‘ä»¬éœ€è¦åœ¨æ„é€ å‡½æ•°é‡Œé¢, æ”¹ä¸‹handleDataè¿™ä¸ªå‡½æ•°çš„è°ƒç”¨, ç»™å®ƒæŠŠobj.watchä¹Ÿä¼ è¿›å»</span></span><br><span class="line"><span class="comment">// handleData(this, data);</span></span><br><span class="line">handleData(<span class="keyword">this</span>, data, obj.watch);</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ¥ä¸‹æ¥æˆ‘ä»¬æ”¹å†™handleDataè¿™ä¸ªå‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleData</span>(<span class="params">context, data, watch</span>) </span>&#123;</span><br><span class="line"><span class="keyword">let</span> inWatch, watchVal;</span><br><span class="line">loopObj(data, (key, val, data) =&gt; &#123;</span><br><span class="line"><span class="comment">//åˆ¤æ–­åœ¨watchä¸­æ˜¯å¦ä¹Ÿå£°æ˜äº†è¯¥å±æ€§å€¼</span></span><br><span class="line">inWatch = hasOwnProp(watch, key);</span><br><span class="line"><span class="comment">//å¦‚æœæœ‰å–å‡ºæ¥, ä½œä¸ºdefinePropçš„ç¬¬äº”ä¸ªå‚æ•°ç»™ä¼ è¿›å»</span></span><br><span class="line">watchVal = inWatch ? watch[key] : <span class="literal">null</span>;</span><br><span class="line">defineProp(context, key, val, inWatch, watchVal);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸‹é¢å°±æ˜¯æˆ‘ä»¬è¯´åˆ°çš„åœ¨setteréƒ¨åˆ†è°ƒç”¨å£°æ˜çš„watchè§‚å¯Ÿè€…</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">defineProp</span>(<span class="params">obj, key, val, inWatch = false, watchVal = (</span>) =&gt; </span>&#123;&#125;) &#123;</span><br><span class="line">    <span class="keyword">let</span> _val = val, type;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">        enumerable: <span class="literal">true</span>,</span><br><span class="line">        configable: <span class="literal">true</span>,</span><br><span class="line">        <span class="keyword">get</span>: function() &#123;</span><br><span class="line">            type = typeOf(_val);</span><br><span class="line">            <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * å±æ€§å€¼å¯¹åº”ä¸€ä¸ªå‡½æ•°, ä¹Ÿå°±æ˜¯computedé‡Œé¢åªå£°æ˜äº†getter</span></span><br><span class="line"><span class="comment">             * eg.</span></span><br><span class="line"><span class="comment">             * ...</span></span><br><span class="line"><span class="comment">             * computed: &#123;</span></span><br><span class="line"><span class="comment">             * info() &#123;</span></span><br><span class="line"><span class="comment">             * return `info content: my name is $&#123;this.firstName&#125;$&#123;this.lastName&#125;, I'm $&#123;this.age&#125; years old`;</span></span><br><span class="line"><span class="comment">             * &#125;</span></span><br><span class="line"><span class="comment">             * ...</span></span><br><span class="line"><span class="comment">             * &#125;</span></span><br><span class="line"><span class="comment">             * ...</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">"function"</span>:</span><br><span class="line">            <span class="keyword">return</span> _val.call(obj);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * å±æ€§å€¼å¯¹åº”ä¸€ä¸ªå¯¹è±¡, ä¹Ÿå°±æ˜¯computedé‡Œé¢åŒæ—¶å£°æ˜äº†getter/setter</span></span><br><span class="line"><span class="comment">             * eg.</span></span><br><span class="line"><span class="comment">             * ...</span></span><br><span class="line"><span class="comment">             * computed: &#123;</span></span><br><span class="line"><span class="comment">             * fullName: &#123;</span></span><br><span class="line"><span class="comment">             * get() &#123;</span></span><br><span class="line"><span class="comment">             * return `my fullName is: $&#123;this.firstName&#125;$&#123;this.lastName&#125;`;</span></span><br><span class="line"><span class="comment">             * &#125;,</span></span><br><span class="line"><span class="comment">             * set() &#123;</span></span><br><span class="line"><span class="comment">             * value = value.split(" ");</span></span><br><span class="line"><span class="comment">             * this.firstName = value[0];</span></span><br><span class="line"><span class="comment">             * this.lastName = value[value.length - 1];</span></span><br><span class="line"><span class="comment">             * &#125;</span></span><br><span class="line"><span class="comment">             * &#125;</span></span><br><span class="line"><span class="comment">             * &#125;</span></span><br><span class="line"><span class="comment">             * ...</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">"object"</span>:</span><br><span class="line">            <span class="keyword">return</span> _val.get.call(obj);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//å…¶ä»–ç±»å‹é»˜è®¤</span></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> _val;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">set</span>: function(newV) &#123;</span><br><span class="line">        type = typeOf(_val);</span><br><span class="line">        <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">        <span class="comment">//å±æ€§å€¼å¯¹åº”ä¸€ä¸ªå¯¹è±¡, ä¹Ÿå°±æ˜¯computedé‡Œé¢åŒæ—¶å£°æ˜äº†getter/setter</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">"object"</span>:</span><br><span class="line">        _val.set.call(obj, newV);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å…¶ä»–ç±»å‹çš„é»˜è®¤</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">if</span> (newV !== _val) &#123;</span><br><span class="line">        _val = newV;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¦‚æœwatchè§‚å¯Ÿè€…å­˜åœ¨, å¹¶ä¸”å¯¹åº”ä¸€ä¸ªå›è°ƒå‡½æ•°, åœ¨å€¼å‘ç”Ÿæ”¹å˜çš„æ—¶å€™è°ƒç”¨è¯¥å›è°ƒ, å¹¶ä¿®æ”¹thisæŒ‡å‘åˆ°å½“å‰vmå®ä¾‹</span></span><br><span class="line">            <span class="keyword">if</span> (inWatch &amp;&amp; typeOf(watchVal) === <span class="string">"function"</span>) &#123;</span><br><span class="line">            watchVal.call(obj);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†æ¥çœ‹ä¸‹ç”¨æ³•:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vm = <span class="keyword">new</span> Vm(&#123;</span><br><span class="line">data() &#123;</span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">firstName: <span class="string">"rw"</span>,</span><br><span class="line">lastName: <span class="string">"son"</span>,</span><br><span class="line">age: <span class="number">25</span></span><br><span class="line">&#125;;</span><br><span class="line">&#125;,</span><br><span class="line">computed: &#123;</span><br><span class="line">info() &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">`info content: my name is <span class="subst">$&#123;<span class="keyword">this</span>.firstName&#125;</span><span class="subst">$&#123;<span class="keyword">this</span>.lastName&#125;</span>, I'm <span class="subst">$&#123;<span class="keyword">this</span>.age&#125;</span> years old`</span>;</span><br><span class="line">&#125;,</span><br><span class="line">fullName: &#123;</span><br><span class="line"><span class="keyword">get</span>() &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">`my fullName is: <span class="subst">$&#123;<span class="keyword">this</span>.firstName&#125;</span><span class="subst">$&#123;<span class="keyword">this</span>.lastName&#125;</span>`</span>;</span><br><span class="line">&#125;,</span><br><span class="line"><span class="keyword">set</span>(value) &#123;</span><br><span class="line">value = value.split(<span class="string">" "</span>);</span><br><span class="line"><span class="keyword">this</span>.firstName = value[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">this</span>.lastName = value[value.length - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line">text: <span class="string">"just a test case"</span></span><br><span class="line">&#125;,</span><br><span class="line">watch: &#123;</span><br><span class="line">firstName() &#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`%c now firstName's value is: <span class="subst">$&#123;<span class="keyword">this</span>.firstName&#125;</span>`</span>, <span class="string">"color: red"</span>);</span><br><span class="line"><span class="comment">//èµ°åˆ°vm.fullName = "song rw";å°±ä¼šè¾“å‡º</span></span><br><span class="line">&#125;,</span><br><span class="line">lastName() &#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`%c now lastName's value is: <span class="subst">$&#123;<span class="keyword">this</span>.lastName&#125;</span>`</span>, <span class="string">"color: green"</span>);</span><br><span class="line"><span class="comment">//èµ°åˆ°vm.fullName = "song rw";å°±ä¼šè¾“å‡º</span></span><br><span class="line">&#125;,</span><br><span class="line">age() &#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`%c now age's value is: <span class="subst">$&#123;<span class="keyword">this</span>.age&#125;</span>`</span>, <span class="string">"color: yellow"</span>);</span><br><span class="line"><span class="comment">//èµ°åˆ°vm.fullName = "song rw";å°±ä¼šè¾“å‡º</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(vm.text);</span><br><span class="line"><span class="built_in">console</span>.log(vm.info);</span><br><span class="line">vm.fullName = <span class="string">"song rw"</span>;</span><br><span class="line"><span class="built_in">console</span>.log(vm.info);</span><br><span class="line"><span class="built_in">console</span>.log(vm.firstName);</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨ç”¨&lt;code&gt;Vue&lt;/code&gt;åšå¼€å‘ä¸­, æˆ‘ä»¬å¤šå¤šå°‘å°‘éƒ½ä¼šç”¨åˆ°é‡Œé¢ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„ä¸œè¥¿: &lt;code&gt;computed&lt;/code&gt;å’Œ&lt;code&gt;watch&lt;/code&gt;, æ¥ä¸‹æ¥æˆ‘ä»¬ä¸€èµ·åˆ†æå¹¶ç®€å•å®ç°ä¸‹è¿™ä¸¤ä¸ªå±æ€§ã€‚&lt;/p&gt;
&lt;h4 id=&quot;computed&quot;&gt;&lt;a h
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/categories/JavaScript/"/>
    
      <category term="Vue" scheme="http://yoursite.com/categories/JavaScript/Vue/"/>
    
    
  </entry>
  
  <entry>
    <title>ç”¨NodeJså’ŒPythonå¼€å‘ä¸€ä¸ªSublimeæ’ä»¶</title>
    <link href="http://yoursite.com/2017/10/24/2017-10-24-write-a-sublime-plugin-by-python-nodejs/"/>
    <id>http://yoursite.com/2017/10/24/2017-10-24-write-a-sublime-plugin-by-python-nodejs/</id>
    <published>2017-10-23T16:00:00.000Z</published>
    <updated>2017-10-24T07:38:04.000Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://www.sublimetext.com/" target="_blank" rel="noopener">Sublime Text</a>è‘—æœ‰æœ€æ€§æ„Ÿçš„ç¼–è¾‘å™¨ä¹‹ç§°,å®ƒè½»é‡,æ˜“äºæ‹“å±•,é€šè¿‡æ’ä»¶çš„æ–¹å¼å¯ä½¿å®ƒå˜å¾—å¾ˆå¼ºå¤§,è€Œæˆ‘æ›´æ˜¯æŠŠå®ƒä½œä¸ºè‡ªå·±çš„ä¸»è¦ç¼–è¾‘å™¨ä½¿ç”¨ã€‚</p><p>æœ‰ä¸€æ¬¡é€›<a href="https://packagecontrol.io" target="_blank" rel="noopener">package control</a>çš„æ—¶å€™,å‘ç°ä¸€ä¸ªç”¨<code>NodeJs</code>æ¥å†™æ’ä»¶çš„è„šæ‰‹æ¶: <a href="https://github.com/akira-cn/SublimeJS_Samples" target="_blank" rel="noopener">SublimeJS_Samples</a>,æ‰å‘ç°ç”¨<code>NodeJs</code>ç»“åˆ<code>Python</code>ä¹Ÿå¯ä»¥æ¥å¼€å‘æ’ä»¶,è¿™å¯¹äºå¯¹<code>Python</code>ä¸æ˜¯ç‰¹åˆ«äº†è§£çš„äººå¯èƒ½å¾ˆåƒåŠ›,ç„¶åå°±ç ”ç©¶äº†å‡ ä¸ªå¸¸ç”¨æ’ä»¶çš„æºç ,æ‹¿<a href="https://github.com/luozhihua/sublime-vue-formatter" target="_blank" rel="noopener">sublime-vue-formatter</a>è¿™ä¸ªæ’ä»¶è¯¦ç»†çœ‹äº†ä¸‹,æ€»ç»“å‡ºåŸç†å¤§æ¦‚æ˜¯è¿™æ ·çš„:</p><ol><li>åœ¨<code>Python</code>ä¸­æ‹¿åˆ°å½“å‰æ­£åœ¨ç¼–è¾‘çš„æ–‡ä»¶æˆ–è€…é€‰ä¸­çš„å†…å®¹</li><li>ç”¨<code>Python</code>å­è¿›ç¨‹<code>subprocess</code>å»æ‰§è¡Œä¸€æ®µcmdå‘½ä»¤å¹¶æ¥å—è¾“å‡º,<code>Node</code>è·¯å¾„ä¸ºæˆ‘ä»¬ç”µè„‘ä¸Šè£…çš„<code>Node</code>ç»å¯¹è·¯å¾„(ç”¨æˆ·äº‹å…ˆé…ç½®å¥½), å†å»æ‰§è¡Œä¸€ä¸ª<code>NodeJs</code>è„šæœ¬, ä»¥Macä¸ºä¾‹, æœ€åè¦æ‰§è¡Œçš„å‘½ä»¤å¤§æ¦‚æ˜¯è¿™æ ·çš„<code>/usr/local/bin/node script/run.js --arg1=argVal1  --arg2=argVal2</code>(å…¶å®å’Œæˆ‘ä»¬å¹³æ—¶åœ¨Terminalé‡Œè¿è¡Œçš„ä¸€æ ·)</li><li><code>Python</code>æ¥æ”¶åˆ°<code>NodeJs</code>çš„æ‰§è¡Œè¿”å›çš„æ—¶å€™, æ›¿æ¢æ–‡ä»¶ä¸­çš„ç›¸å…³å†…å®¹</li></ol><p>æŠ±ç€è¯•è¯•çœ‹çš„å¿ƒç†,æˆ‘ä¹Ÿå†³å®šè‡ªå·±ç”¨è¿™ä¸ªæ¨¡å¼å†™ä¸ªå›¾ç‰‡å‹ç¼©ç›¸å…³çš„æ’ä»¶,å…ˆç®€å•ä»‹ç»ä¸‹æˆ‘æƒ³å†™çš„æ’ä»¶çš„åŠŸèƒ½:</p><ol><li>ç”¨æˆ·åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ–°å»ºé…ç½®æ–‡ä»¶, æŒ‡å®šå‹ç¼©ç›®å½•å’Œé‡Šæ”¾ç›®å½•, è°ƒç”¨<a href="http://tinypng.com" target="_blank" rel="noopener">tinypng</a>çš„å¼€å‘è€…APIè¿›è¡Œå‹ç¼©</li><li>å½“å‹ç¼©å®Œçš„å›¾ç‰‡å°äºå¤šå°‘å­—èŠ‚æ—¶æŠŠcssä¸­çš„å¼•ç”¨è½¬æ¢æˆ<code>Base64</code>ç¼–ç ,ä¹Ÿæ˜¯é€šè¿‡é…ç½®é¡¹</li><li>ç”¨æˆ·å¯ä»¥é€šè¿‡ä¸€äº›å¿«æ·é”®æˆ–è€…å‘½ä»¤(å­å‘½ä»¤)åœ¨é¡¹ç›®æ ¹ç›®å½•æ–°å»ºé…ç½®æ–‡ä»¶ã€ä¿®æ”¹å…¨å±€<code>NodeJs</code>è·¯å¾„é…ç½®ç­‰ç­‰</li></ol><p>ç°åœ¨çŸ¥é“äº†æˆ‘ä»¬æƒ³åšä»€ä¹ˆ, ä¸‹ä¸€æ­¥å°±æ˜¯æ ¹æ®è¿™ä¸ªéœ€æ±‚å¼€å§‹å†™ä»£ç , å› ä¸ºæ˜¯å›¾ç‰‡å‹ç¼©æ’ä»¶, æ‰€ä»¥æˆ‘æŠŠå®ƒå‘½åæˆ<code>sublime-image-compressor</code></p><h4 id="å‘½ä»¤ã€å­å‘½ä»¤"><a href="#å‘½ä»¤ã€å­å‘½ä»¤" class="headerlink" title="å‘½ä»¤ã€å­å‘½ä»¤"></a>å‘½ä»¤ã€å­å‘½ä»¤</h4><p>åœ¨æ’ä»¶é…ç½®ä¸­, å‘½ä»¤éƒ½æ˜¯é€šè¿‡é…ç½®æ–‡ä»¶å†™å…¥çš„, ä¸‹é¢è´´ä¸‹æˆ‘ä»¬è¿™ä¸ªæ’ä»¶æ”¯æŒå‘½ä»¤çš„ä¸€ä¸ªé…ç½®å¹¶åšä»‹ç»</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">//ImageCompressor.sublime-commands</span><br><span class="line"></span><br><span class="line">[&#123;</span><br><span class="line">  <span class="attr">"caption"</span>: <span class="string">"ImageCompress"</span>,</span><br><span class="line">  <span class="attr">"command"</span>: <span class="string">"image_compress"</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">  <span class="attr">"caption"</span>: <span class="string">"ImageCompress: Init Project Config File"</span>,</span><br><span class="line">  <span class="attr">"command"</span>: <span class="string">"imagecompress_config_project"</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">  <span class="attr">"caption"</span>: <span class="string">"ImageCompress: Set Global Config"</span>,</span><br><span class="line">  <span class="attr">"command"</span>: <span class="string">"imagecompress_set_global_plugin_options"</span></span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure><p><code>.sublime-commands</code>æ˜¯ç”¨æ¥æŒ‡å®šæ’ä»¶æ”¯æŒçš„å‘½ä»¤çš„, é‡Œé¢æŒ‡å®šä¸€ä¸ªå¯¹è±¡å‹æ•°ç»„, æ•°ç»„æœ‰<code>caption</code>å’Œ<code>command</code>ä¸¤é¡¹, éœ€è¦æ³¨æ„çš„æ˜¯, <code>command</code>çš„å€¼å’Œ<code>Python</code>çš„ç±»æ˜¯å¯¹åº”çš„, ä¸”<code>Python</code>ä¸­ç”¨é©¼å³°å‘½åæ³•æ¥å®šä¹‰ç±»å, ä»¥ç¬¬ä¸€é¡¹ä¸ºä¾‹, æ¯”å¦‚<code>command</code>çš„å€¼ä¸º<code>image_compress</code>, æˆ‘ä»¬çš„<code>Python</code>ä¸­å°±éœ€è¦åƒç±»ä¼¼ä¸‹é¢çš„æ ·å­å®šä¹‰ä¸€ä¸ªç±»:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImageCompressCommand</span><span class="params">(sublime_plugin.TextCommand)</span>:</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self, edit)</span>:</span></span><br></pre></td></tr></table></figure><p>å…¶ä»–ç±»ä¼¼</p><h4 id="å¿«æ·é”®"><a href="#å¿«æ·é”®" class="headerlink" title="å¿«æ·é”®"></a>å¿«æ·é”®</h4><p>åœ¨æ’ä»¶é…ç½®ä¸­, å¿«æ·é”®éƒ½æ˜¯é€šè¿‡é…ç½®æ–‡ä»¶å†™å…¥çš„, ä¸‹é¢è´´ä¸‹æˆ‘ä»¬è¿™ä¸ªæ’ä»¶å¿«æ·é”®çš„ä¸€ä¸ªé…ç½®å¹¶åšä»‹ç», éœ€è¦æ³¨æ„çš„æ˜¯, å¦‚æœéœ€è¦å…¼å®¹å¤šå¹³å°, å› ä¸ºæ¯ä¸ªå¹³å°çš„é”®å¯èƒ½éƒ½ä¸å¤ªä¸€æ ·, åˆ™éœ€è¦å¤šä»½é…ç½®æ–‡ä»¶, <code>Windows</code>/<code>Mac</code>/<code>Linux</code>çš„å‘½ååˆ†åˆ«æ˜¯<code>Default (Windows).sublime-keymap</code>/<code>Default (OSX).sublime-keymap</code>/<code>Default (Linux).sublime-keymap</code>, ä¸‹é¢æˆ‘ä»¬æŠŠ<code>Default (OSX).sublime-keymap</code>è¿™ä¸ªæ–‡ä»¶çš„å†…å®¹è´´å‡ºæ¥çœ‹ä¸‹:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[&#123;</span><br><span class="line">  <span class="attr">"keys"</span>: [<span class="string">"ctrl+shift+i"</span>, <span class="string">"c"</span>],</span><br><span class="line">  <span class="attr">"command"</span>: <span class="string">"image_compress"</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">  <span class="attr">"keys"</span>: [<span class="string">"ctrl+alt+i"</span>, <span class="string">"f"</span>],</span><br><span class="line">  <span class="attr">"command"</span>: <span class="string">"image_compress_config_project"</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">  <span class="attr">"keys"</span>: [<span class="string">"ctrl+alt+i"</span>, <span class="string">"g"</span>],</span><br><span class="line">  <span class="attr">"command"</span>: <span class="string">"image_compress_set_global_plugin_options"</span></span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure><p><code>.sublime-keymap</code>ä¹Ÿæ˜¯æŒ‡å®šä¸€ä¸ªå¯¹è±¡å‹æ•°ç»„, æ¯ä¸ªå¯¹è±¡æœ‰<code>keys</code>å’Œ<code>command</code>ä¸¤ä¸ªå±æ€§, <code>keys</code>æ˜¯æŒ‡å®šæŒ‰å“ªå‡ ä¸ªé”®ç”Ÿæ•ˆçš„, <code>command</code>çš„é…ç½®å’Œä¹‹å‰çš„å‘½ä»¤é…ç½®ä¸€æ ·</p><p>å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡æ·»åŠ å…¶ä»–é…ç½®æ–‡ä»¶æ¯”å¦‚<code>Context.sublime-menu</code>æˆ–è€…<code>Main.sublime-menu</code>æ¥æŒ‡å®šæ’ä»¶çš„å³é”®èœå•æˆ–è€…åœ¨<code>Toolbar</code>ä¸Šçš„èœå•é…ç½®</p><p>è¯´å®Œäº†å‡ ä¸ªé…ç½®, æˆ‘ä»¬ä¸€èµ·æ¥å†™<code>Python</code>å’Œ<code>NodeJs</code>, å…ˆå†™<code>Python</code>å§</p><p>åœ¨<code>Python</code>ä¸­æˆ‘ä»¬éœ€è¦å®Œæˆå¤§æ¦‚ä¸‹é¢å‡ ä¸ªä»»åŠ¡:</p><ol><li>é¦–å…ˆè·å–ç”¨æˆ·å½“å‰é¡¹ç›®çš„æ ¹ç›®å½•</li><li>è·å–æ ¹ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶, å¦‚æœç”¨æˆ·æ²¡æœ‰æ–°å»ºé…ç½®æ–‡ä»¶, å°±è¯»å–ä¸€ä»½é»˜è®¤çš„é…ç½®æ–‡ä»¶, æ‹¼å‡ºå‘½ä»¤è¡Œå‚æ•°(â€“arg1=argVal1 â€“arg2=argVal2)</li><li>è·å–ç”¨æˆ·è£…çš„<code>NodeJs</code>å…¨è·¯å¾„, ç»“åˆä¸Šä¸€æ­¥æ‹¼å¥½çš„å‘½ä»¤è¡Œå‚æ•°å†æ‹¼å‡ºä¸€ä¸ªå¯æ‰§è¡Œå‘½ä»¤(ç±»ä¼¼åˆšæ‰åˆ†ææµç¨‹é‚£è¾¹é‚£æ¡)</li><li>ç”¨<code>subprocess</code>æ¨¡å—æ¥è¿è¡Œè¯¥å‘½ä»¤</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å†™æ’ä»¶å¿…é¡»å¼•å…¥è¿™ä¸¤ä¸ªæ¨¡å—</span></span><br><span class="line"><span class="keyword">import</span> sublime, sublime_plugin</span><br><span class="line"></span><br><span class="line"><span class="comment"># Pythonå†…ç½®æ¨¡å—çš„å¼•å…¥</span></span><br><span class="line"><span class="keyword">import</span> os, sys, subprocess, codecs, webbrowser, platform, json</span><br><span class="line"></span><br><span class="line"><span class="comment"># å½“å‰æ’ä»¶, é…ç½®æ–‡ä»¶, å¿«æ·é”®é…ç½®, æ‰§è¡Œä»»åŠ¡çš„jsè·¯å¾„é…ç½®</span></span><br><span class="line">PLUGIN_FOLDER = os.path.dirname(os.path.realpath(__file__))</span><br><span class="line">CONFIG_FILE = <span class="string">"image-compressor.config.json"</span></span><br><span class="line">SETTINGS_FILE = <span class="string">"ImageCompressor.sublime-settings"</span></span><br><span class="line">KEYMAP_FILE = <span class="string">"Default ($PLATFORM).sublime-keymap"</span></span><br><span class="line"><span class="comment"># è¿™é‡ŒJS_PATHå¿…é¡»ä¸ºç»å¯¹è·¯å¾„, å¦åˆ™ä¼šå»$&#123;nodepath&#125;æ‰¾/scripts/index.js,æ‰¾ä¸åˆ°è‚¯å®šä¼šæŠ¥é”™</span></span><br><span class="line">JS_PATH = PLUGIN_FOLDER.replace(<span class="string">" "</span>, <span class="string">"\\ "</span>) + <span class="string">"/scripts/index.js"</span></span><br><span class="line"></span><br><span class="line">//å¼•å…¥commandsæ¨¡å—, å¹¶catchå¼‚å¸¸</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">  <span class="keyword">import</span> commands</span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">  <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImageCompressCommand</span><span class="params">(sublime_plugin.TextCommand)</span>:</span></span><br><span class="line">  </span><br><span class="line">  <span class="string">"""</span></span><br><span class="line"><span class="string">    æ’ä»¶éœ€è¦ä¸€ä¸ªrunæ–¹æ³•, è¯¥æ–¹æ³•æ¥æ”¶selfå’Œeditä¸¤ä¸ªå‚æ•°</span></span><br><span class="line"><span class="string">    def run(self, run[, args])</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    self: ä»£è¡¨å½“å‰ç±»</span></span><br><span class="line"><span class="string">    view: ä»£è¡¨å½“å‰ç¼–è¾‘çš„tab</span></span><br><span class="line"><span class="string">    args: å…¶ä»–å‚æ•°, å¯ä»¥åœ¨é…ç½®ä¸­æŒ‡å®š</span></span><br><span class="line"><span class="string">      æ¯”å¦‚ &#123; "caption": "xxx", "command": "xxxx", "args": &#123;"by": "abc"&#125; &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      class Xxxx(sublime_plugin.TextCommand):</span></span><br><span class="line"><span class="string">        def run(self, edit, by):</span></span><br><span class="line"><span class="string">          print("by=" + by)</span></span><br><span class="line"><span class="string">          # by=file</span></span><br><span class="line"><span class="string">  """</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self, edit)</span>:</span></span><br><span class="line">    <span class="comment"># æ‹¿åˆ°é¡¹ç›®æ ¹è·¯å¾„çš„ç»å¯¹è·¯å¾„</span></span><br><span class="line">    currentDir = PluginUtils.get_active_project_path()</span><br><span class="line">    <span class="comment"># ä».sublime-settingsé…ç½®æ–‡ä»¶ä¸­è·å–å½“å‰å¹³å°çš„node_path</span></span><br><span class="line">    nodepath = PluginUtils.get_node_path()</span><br><span class="line">    <span class="comment"># è·å–æ ¹è·¯å¾„</span></span><br><span class="line">    configs = PluginUtils.load_config()</span><br><span class="line"></span><br><span class="line">    configs += <span class="string">" --currentDir='"</span> + currentDir + <span class="string">"'"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç©ºæ ¼æ›¿æ¢</span></span><br><span class="line">    nodepath = nodepath.replace(<span class="string">" "</span>, <span class="string">"\\ "</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ‹¼ä¸€ä¸ªcmdæ•°ç»„</span></span><br><span class="line">    cmd = [nodepath, JS_PATH]</span><br><span class="line">    cmd.append(configs)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ‰§è¡Œå‘½ä»¤</span></span><br><span class="line">    PluginUtils.exec_cmd(cmd)</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æˆ‘ä»¬å®Œæˆäº†ä¸€ä¸ª<code>ImageCompressCommand</code>è¿™ä¸ªç±»çš„å°è£…,å¹¶ä¸”åœ¨<code>run</code>é‡Œé¢å¥½å‡ ä¸ªåœ°æ–¹éƒ½è°ƒç”¨äº†<code>PluginUtils</code>ä¸‹çš„é™æ€æ–¹æ³•, ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹<code>PluginUtils</code>çš„å®šä¹‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#åœ¨pythonç”¨staticmethod Decoratorè¡¨ç¤ºé™æ€æ–¹æ³•</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PluginUtils</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">      è¯»å–é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="string">      è¿™é‡Œçš„é€»è¾‘æœ‰ç‚¹ä¸å¯¹, åº”è¯¥å…ˆå»é¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰¾é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="string">      æ‰¾ä¸åˆ°å†æ‰¾é»˜è®¤çš„é…ç½®</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">load_config</span><span class="params">(base)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            args = <span class="string">""</span></span><br><span class="line">            <span class="comment"># ä»¥è¯»å–çš„æ¨¡å¼æ‰“å¼€é…ç½®æ–‡ä»¶</span></span><br><span class="line">            fs = open(CONFIG_FILE, <span class="string">"r"</span>)</span><br><span class="line">            stream = fs.read()</span><br><span class="line">            <span class="comment"># steamè¯»å‡ºæ¥æ˜¯ä¸ªjsonå­—ç¬¦ä¸², æ‰€ä»¥éœ€è¦ç”¨json.loadsè½¬æ¢æˆdict</span></span><br><span class="line">            <span class="comment"># http://python3-cookbook.readthedocs.io/zh_CN/latest/c06/p02_read-write_json_data.html</span></span><br><span class="line">            data = json.loads(stream)</span><br><span class="line">            <span class="comment"># è·å–dictä¸‹çš„keyå˜æˆä¸€ä¸ªlist</span></span><br><span class="line">            keys = data.keys()</span><br><span class="line">            <span class="comment"># å…³é—­æ–‡ä»¶</span></span><br><span class="line">            fs.close()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># æšä¸¾æ‰€æœ‰key</span></span><br><span class="line">            <span class="keyword">for</span> key <span class="keyword">in</span> keys:</span><br><span class="line">                val = data[key]</span><br><span class="line">                <span class="comment"># æ•°ç»„ç±»å‹å‚æ•°è½¬æ¢æˆå­—ç¬¦ä¸²</span></span><br><span class="line">                <span class="keyword">if</span> isinstance(val, list):</span><br><span class="line">                    val = <span class="string">"-compress-config-split-"</span>.join(val)</span><br><span class="line">                args += <span class="string">" --"</span> + key + <span class="string">"="</span> + str(val)</span><br><span class="line">            <span class="keyword">return</span> args</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#ä».sublime-settingsé‡Œé¢è·å–ç›¸å…³é…ç½®é¡¹</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_pref</span><span class="params">(key)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> sublime.load_settings(SETTINGS_FILE).get(key)</span><br><span class="line"></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">        ä».sublime-settingsé‡Œé¢è·å–å½“å‰å¹³å°ä¸‹nodejsçš„è·¯å¾„</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_node_path</span><span class="params">()</span>:</span></span><br><span class="line">        platform = sublime.platform()</span><br><span class="line">        node = PluginUtils.get_pref(<span class="string">"node_path"</span>).get(platform)</span><br><span class="line">        <span class="keyword">return</span> node</span><br><span class="line"></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">        è·å–å½“å‰æ¿€æ´»é¡¹ç›®çš„æ ¹è·¯å¾„</span></span><br><span class="line"><span class="string">        å‚è€ƒhttps://github.com/fyneworks/sublime-TortoiseGIT/blob/master/TortoiseGIT.py#L8å®ç°</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_active_project_path</span><span class="params">()</span>:</span></span><br><span class="line">        window = sublime.active_window()</span><br><span class="line">        folders = window.folders()</span><br><span class="line">        <span class="keyword">if</span> len(folders) == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> folders[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            active_view = window.active_view()</span><br><span class="line">            active_file_name = active_view.file_name() <span class="keyword">if</span> active_view <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> active_file_name:</span><br><span class="line">                <span class="keyword">return</span> folders[<span class="number">0</span>] <span class="keyword">if</span> len(folders) <span class="keyword">else</span> os.path.expanduser(<span class="string">"~"</span>)</span><br><span class="line">            <span class="keyword">for</span> folder <span class="keyword">in</span> folders:</span><br><span class="line">                <span class="keyword">if</span> active_file_name.startswith(folder):</span><br><span class="line">                    <span class="keyword">return</span> folder</span><br><span class="line">            <span class="keyword">return</span> os.path.dirname(active_file_name)</span><br><span class="line"></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">        æ‰§è¡Œå‘½ä»¤</span></span><br><span class="line"><span class="string">        å‚è€ƒhttps://github.com/luozhihua/sublime-vue-formatter/blob/master/vue-next-formatter.py#L196å®ç°</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">exec_cmd</span><span class="params">(cmd)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> int(sublime.version()) &lt; <span class="number">3000</span>:</span><br><span class="line">            <span class="keyword">if</span> sublime.platform() != <span class="string">"windows"</span>:</span><br><span class="line">                run = <span class="string">'"'</span> + <span class="string">'" "'</span>.join(cmd) + <span class="string">'"'</span></span><br><span class="line">                <span class="keyword">return</span> commands.getoutput(run)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                startupinfo = subprocess.STARTUPINFO()</span><br><span class="line">                startupinfo.dwFlags |= subprocess.STARTF_USESHOWWINDOW</span><br><span class="line">                <span class="keyword">return</span> subprocess.Popen(cmd, \</span><br><span class="line">                                        stdout=subprocess.PIPE, \</span><br><span class="line">                                        startupinfo=startupinfo).communicate()[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            run = <span class="string">" "</span>.join(cmd)</span><br><span class="line">            res = subprocess.check_output(run, stderr=subprocess.STDOUT, shell=<span class="literal">True</span>, env=os.environ)</span><br><span class="line">            print(res)</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æˆ‘ä»¬å°±å®Œæˆäº†å¯¹<code>PluginUtils</code>è¿™ä¸ªç±»çš„å°è£…, åœ¨æœ€åä¸€ä¸ªæ–¹æ³•ä¸­, æˆ‘ä»¬ç”¨äº†<code>subprocess</code>ä¸‹é¢çš„å‡ ä¸ªæ–¹æ³•, <code>subprocess</code>ä¸‹é¢è¿˜æœ‰å¾ˆå¤šå…¶ä»–æ–¹æ³•, è¿™äº›åœ¨<a href="http://python3-cookbook.readthedocs.io/zh_CN/latest/c13/p06_executing_external_command_and_get_its_output.html" target="_blank" rel="noopener">æ–‡æ¡£</a>é‡Œé¢éƒ½èƒ½æ‰¾åˆ°, ä¸‹é¢å†çœ‹çœ‹<code>NodeJs</code>éƒ¨åˆ†å®ç°:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> dir = <span class="built_in">require</span>(<span class="string">"node-dir"</span>),</span><br><span class="line">    co = <span class="built_in">require</span>(<span class="string">"co"</span>),</span><br><span class="line">    tinify = <span class="built_in">require</span>(<span class="string">"tinify"</span>),</span><br><span class="line">    mkdirp = <span class="built_in">require</span>(<span class="string">"mkdirp"</span>),</span><br><span class="line">    <span class="built_in">Promise</span> = <span class="built_in">require</span>(<span class="string">"bluebird"</span>),</span><br><span class="line">    fs = <span class="built_in">require</span>(<span class="string">"fs"</span>),</span><br><span class="line">    path = <span class="built_in">require</span>(<span class="string">"path"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç¼“å­˜Object.prototype</span></span><br><span class="line"><span class="keyword">const</span> obj2 = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å‚æ•°è§£æ</span></span><br><span class="line"><span class="keyword">const</span> parseArgs = <span class="function"><span class="params">arr</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> res = &#123;&#125;,</span><br><span class="line">        tmp = <span class="literal">null</span>;</span><br><span class="line">    arr.map(<span class="function"><span class="params">item</span> =&gt;</span> item.replace(<span class="regexp">/^-&#123;2&#125;/</span>, <span class="string">""</span>))</span><br><span class="line">        .forEach(<span class="function"><span class="params">val</span> =&gt;</span> &#123;</span><br><span class="line">            tmp = val.split(<span class="string">"="</span>);</span><br><span class="line">            <span class="comment">//Pythonä¸­å¸ƒå°”å€¼è½¬æ¢æˆTrue/False, æ•°å­—è½¬æ¢æˆ'123'</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="regexp">/^[\d]+$/</span>.test(tmp[<span class="number">1</span>])) &#123;</span><br><span class="line">                tmp[<span class="number">1</span>] = <span class="built_in">Number</span>(tmp[<span class="number">1</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="regexp">/^True$/</span>.test(tmp[<span class="number">1</span>])) &#123;</span><br><span class="line">                tmp[<span class="number">1</span>] = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="regexp">/^False/</span>.test(tmp[<span class="number">1</span>])) &#123;</span><br><span class="line">                tmp[<span class="number">1</span>] = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            res[tmp[<span class="number">0</span>]] = tmp[<span class="number">1</span>];</span><br><span class="line">        &#125;);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ¤æ–­æ˜¯å¦ä¸ºä¸€ä¸ªå›¾ç‰‡æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">const</span> isImageFile = <span class="function"><span class="params">file</span> =&gt;</span> <span class="regexp">/\.(jpe?g|png|gif)$/i</span>.test(file);</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ¤æ–­æ˜¯å¦ä¸ºä¸€ä¸ªcssæ–‡ä»¶</span></span><br><span class="line"><span class="keyword">const</span> isCssFile = <span class="function"><span class="params">file</span> =&gt;</span> <span class="regexp">/\.css$/i</span>.test(file);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç›®æ ‡ç›®å½•</span></span><br><span class="line"><span class="keyword">const</span> distDir = <span class="function">(<span class="params">prefix, folder</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!folder) &#123;</span><br><span class="line">        folder = prefix;</span><br><span class="line">        prefix = __dirname;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ‹¼è·¯å¾„</span></span><br><span class="line">    <span class="keyword">return</span> path.join(prefix, folder);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åŒæ­¥è¯»å–ä¸€ä¸ªæ–‡ä»¶çš„çŠ¶æ€</span></span><br><span class="line"><span class="keyword">const</span> fstat = <span class="function"><span class="params">filePath</span> =&gt;</span> fs.fstatSync(filePath);</span><br><span class="line"></span><br><span class="line"><span class="comment">//æŠŠæ–‡ä»¶è½¬æ¢æˆbase64ç¼–ç </span></span><br><span class="line"><span class="keyword">const</span> toBase64 = <span class="function"><span class="params">filePath</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> buffer = fs.readFileSync(filePath);</span><br><span class="line">    <span class="keyword">return</span> buffer.toString(<span class="string">"base64"</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æŠŠä¸€ä¸ªæ•°ç»„æŒ‰ç…§20ä¸ªæ¯é¡¹åšå­é¡¹ç›®æ‹†åˆ†æˆäºŒçº§æ•°ç»„</span></span><br><span class="line"><span class="keyword">const</span> splitArray = <span class="function"><span class="params">array</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> length = array.length;</span><br><span class="line">    <span class="keyword">let</span> res = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; length; i += <span class="number">20</span>) &#123;</span><br><span class="line">        res.push(array.slice(i, i + <span class="number">20</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ¤æ–­ç›®å½•æ˜¯å¦å­˜åœ¨</span></span><br><span class="line"><span class="keyword">const</span> folderExist = <span class="function"><span class="params">folder</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        fs.readdirSync(folder);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¯»å–ç›®å½•ä¸‹çš„csså¹¶ä¸”è½¬æ¢æˆASTå¯¹è±¡</span></span><br><span class="line"><span class="keyword">const</span> listCssAST = <span class="function"><span class="params">cssdir</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> list = [],</span><br><span class="line">        fullPath = <span class="literal">null</span>,</span><br><span class="line">        basename = <span class="literal">null</span>,</span><br><span class="line">        stream = <span class="literal">null</span>;</span><br><span class="line">    files = fs.readFileSync(cssdir);</span><br><span class="line">    list = files.filter(<span class="function"><span class="params">file</span> =&gt;</span> isCssFile).map(<span class="function"><span class="params">file</span> =&gt;</span> &#123;</span><br><span class="line">        fullPath = path.join(cssdir, file);</span><br><span class="line">        stream = fs.readFileSync(fullPath);</span><br><span class="line">        basename = path.basename(fullPath);</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            ast: stream.parse(stream.toString()),</span><br><span class="line">            sourcePath: fullPath,</span><br><span class="line">            distPath: path.join(</span><br><span class="line">                cssdir,</span><br><span class="line">                <span class="string">`<span class="subst">$&#123;basename.replace(<span class="regexp">/\.css$/i</span>, <span class="string">""</span>)&#125;</span>.css`</span></span><br><span class="line">            )</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ›¿æ¢cssä¸­çš„background: url(xxx) ä¸º background: url(base64: xxxx)</span></span><br><span class="line"><span class="keyword">const</span> replaceCss = <span class="function">(<span class="params">cssdir, files</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!files || files.length === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> csses = listCssAST(cssdir);</span><br><span class="line">    <span class="keyword">if</span> (csses.length === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    files = files.map(<span class="function"><span class="params">file</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            source: file,</span><br><span class="line">            encoded: toBase64(file)</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//<span class="doctag">TODO:</span>éå†CSS ASTå¹¶æ›¿æ¢å¼•ç”¨</span></span><br><span class="line">    <span class="comment">// csses.forEach((&#123; ast, distPath &#125;) =&gt; &#123;&#125;);</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * promiseifyToFile -&gt; source = yield promiseifyToFile("a/b/c/d.jpg");</span></span><br><span class="line"><span class="comment"> * @param  &#123;String&#125; file æºæ–‡ä»¶è·¯å¾„</span></span><br><span class="line"><span class="comment"> * @param  &#123;String&#125; dist ç›®æ ‡æ–‡ä»¶è·¯å¾„</span></span><br><span class="line"><span class="comment"> * åœ¨è°ƒç”¨tinypng APIå¼‚å¸¸å, ç›´æ¥æ‹·è´æºæ–‡ä»¶åˆ°ç›¸å…³ç›®å½•</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> promiseifyToFile = <span class="function">(<span class="params">file, dist</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> fileUp = tinify.fromFile(file);</span><br><span class="line">            fileUp._url</span><br><span class="line">                .then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">                    fileUp</span><br><span class="line">                        .toFile(dist)</span><br><span class="line">                        .then(<span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (e) &#123;</span><br><span class="line">                                reject(e);</span><br><span class="line">                                <span class="keyword">return</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            resolve();</span><br><span class="line">                        &#125;)</span><br><span class="line">                        .catch(reject);</span><br><span class="line">                &#125;)</span><br><span class="line">                .catch(reject);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            fs.copyFileSync(file, dist);</span><br><span class="line">            resolve();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è·å–ç±»å‹å</span></span><br><span class="line"><span class="keyword">const</span> typeOf = <span class="function"><span class="params">obj</span> =&gt;</span> obj2.toString.call(obj).slice(<span class="number">8</span>, <span class="number">-1</span>).toLowerCase();</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> args;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (process.argv.length &gt; <span class="number">2</span>) &#123;</span><br><span class="line"><span class="comment">//å‚æ•°è¯»å–å’Œå¤„ç†</span></span><br><span class="line">args = parseArgs(process.argv.slice(<span class="number">2</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (args) &#123;</span><br><span class="line"><span class="comment">//prefixå¤„ç†</span></span><br><span class="line">args.prefix = args.prefix || <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æºæ–‡ä»¶ç›®å½•å’Œcssæ–‡ä»¶ç›®å½•çš„ç»åº¦è·¯å¾„å¤„ç†</span></span><br><span class="line">args.source = args.source.split(<span class="string">"-compress-config-split-"</span>).map(<span class="function"><span class="params">item</span> =&gt;</span> path.join(args.currentDir, item));</span><br><span class="line">args.cssDir = args.cssDir.split(<span class="string">"-compress-config-split-"</span>).map(<span class="function"><span class="params">item</span> =&gt;</span> path.join(args.currentDir, item));</span><br><span class="line"></span><br><span class="line"><span class="comment">//tinypngçš„API Key</span></span><br><span class="line">tinify.key = args.key;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å…¥å£å‡½æ•°</span></span><br><span class="line"><span class="comment"> * @param  options.source</span></span><br><span class="line"><span class="comment"> * @param  options.outputDir</span></span><br><span class="line"><span class="comment"> * @param  options.prefix</span></span><br><span class="line"><span class="comment"> * @param  options.injectCssUrl</span></span><br><span class="line"><span class="comment"> * @param  options.injectMaxSize</span></span><br><span class="line"><span class="comment"> * @param  options.cssDir</span></span><br><span class="line"><span class="comment"> * @param  options.currentDir</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params">&#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    source,</span></span></span><br><span class="line"><span class="function"><span class="params">    outputDir,</span></span></span><br><span class="line"><span class="function"><span class="params">    prefix,</span></span></span><br><span class="line"><span class="function"><span class="params">    injectCssUrl,</span></span></span><br><span class="line"><span class="function"><span class="params">    injectMaxSize,</span></span></span><br><span class="line"><span class="function"><span class="params">    cssDir,</span></span></span><br><span class="line"><span class="function"><span class="params">    currentDir</span></span></span><br><span class="line"><span class="function"><span class="params">&#125;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> distPath = distDir(currentDir, outputDir),</span><br><span class="line">        filesList = [],</span><br><span class="line">        tmp = <span class="literal">null</span>,</span><br><span class="line">        basename;</span><br><span class="line"></span><br><span class="line">    mkdirp.sync(distPath);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¼‚æ­¥ä¸Šä¼ , å¹¶ä¸”æ”¾åˆ°å…·ä½“çš„ç›®å½•</span></span><br><span class="line">    co(<span class="function"><span class="keyword">function</span>*(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">of</span> dirs) &#123;</span><br><span class="line">                tmp = <span class="keyword">yield</span> dir.promiseFiles(i);</span><br><span class="line">                filesList = [].concat.call(filesList, tmp.filter(<span class="function"><span class="params">file</span> =&gt;</span> isImageFile(file)));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (tmp <span class="keyword">of</span> filesList) &#123;</span><br><span class="line">                basename = path.basename(tmp);</span><br><span class="line">                <span class="keyword">const</span> res = <span class="keyword">yield</span> promiseifyToFile(</span><br><span class="line">                    tmp,</span><br><span class="line">                    path.join(distPath, basename)</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">init(args);</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œ, æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªå‘½ä»¤å°±å®ç°å¥½äº†, å¦‚æœæƒ³æµ‹è¯•, å¯ä»¥ç›´æ¥åœ¨<code>Sublime Text</code>æŒ‰ä¸‹<code>ctrl + &#39;</code>(æ•°å­—1å‰é¢é‚£ä¸ªé”®), ç„¶ååœ¨<code>console</code>ä¸­è¿è¡Œ<code>view.run_command(&quot;image_compress&quot;)</code>, <code>view.run_command</code>æ¥æ”¶çš„å‚æ•°å’Œæˆ‘ä»¬åœ¨<code>keyMap</code>æˆ–è€…<code>command</code>é‡Œé¢å®šä¹‰çš„ä¸€è‡´ã€‚</p><p>è‡³æ­¤, æˆ‘ä»¬æ’ä»¶çš„ç¬¬ä¸€ä¸ªåŠŸèƒ½å°±å®Œæˆäº†, åé¢è¿˜æœ‰ä¸¤ä¸ªéœ€è¦åš, ç›¸å¯¹ç®€å•, ä¸å†åšä»‹ç», ç”¨æ³•å’Œä»£ç è¯·ç§»æ­¥<a href="https://github.com/rwson/sublime-image-compressor" target="_blank" rel="noopener">GitHub</a>ã€‚</p><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>æˆ‘ä»¬å¯ä»¥ç”¨è¿™ç§æ¨¡å¼å¼€å‘å¾ˆå¤šæ’ä»¶, æ¯”å¦‚ä»£ç å‹ç¼©ç±»ã€ ä»£ç æ ¼å¼åŒ–ç±»ã€ ä»£ç è¯­æ³•æ£€æµ‹ç±»ç­‰ç­‰, å…³äºè¿™äº›, <a href="https://www.npmjs.com/" target="_blank" rel="noopener">npm</a>ä¸Šé¢æœ‰å¾ˆå¤šç°æˆçš„åŒ…, <code>NodeJs</code>ç«¯éœ€è¦åšçš„åªæœ‰å¤„ç†è¾“å…¥, å†è¿”å›ç»“æœå°±å¥½ã€‚</p><p>è¿™ç§æ¨¡å¼æ–¹ä¾¿äº†å¾ˆå¤šäººå»è‡ªå·±å¼€å‘æ’ä»¶, ä½†æ˜¯ä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹, é¦–å…ˆå¼€å‘çš„æ—¶å€™å¾ˆç—›è‹¦, ä¸æ˜“è°ƒè¯•, è€Œä¸”åœ¨ç”¨<code>Node</code>å’Œ<code>Python</code>é€šä¿¡çš„æ—¶å€™, æ•°æ®å¤šçš„æ—¶å€™å¯èƒ½ä¼šæœ‰äº›å»¶è¿Ÿç­‰ç­‰ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;a href=&quot;https://www.sublimetext.com/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Sublime Text&lt;/a&gt;è‘—æœ‰æœ€æ€§æ„Ÿçš„ç¼–è¾‘å™¨ä¹‹ç§°,å®ƒè½»é‡,æ˜“äºæ‹“å±•,é€šè¿‡æ’ä»¶çš„æ–¹å¼å¯ä½¿å®ƒå˜å¾—å¾ˆå¼ºå¤§,è€Œæˆ‘æ›´æ˜¯æŠŠå®ƒä½œä¸ºè‡ªå·±çš„ä¸»è¦ç¼–
      
    
    </summary>
    
    
      <category term="NodeJs" scheme="http://yoursite.com/categories/NodeJs/"/>
    
      <category term="Python" scheme="http://yoursite.com/categories/NodeJs/Python/"/>
    
    
  </entry>
  
  <entry>
    <title>webpackæºç é˜…è¯»</title>
    <link href="http://yoursite.com/2017/09/25/2017-09-25-read-webpack-source/"/>
    <id>http://yoursite.com/2017/09/25/2017-09-25-read-webpack-source/</id>
    <published>2017-09-24T16:00:00.000Z</published>
    <updated>2017-09-26T13:12:39.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨å‰ç«¯å·¥ç¨‹åŒ–è¶Šæ¥è¶Šæ™®åŠçš„ä»Šå¤©ï¼Œæˆ‘ä»¬å‡ ä¹æ¯ä¸ªé¡¹ç›®éƒ½éœ€è¦ç”¨åˆ°æ„å»ºå·¥å…·ï¼Œä»ä¸€å¼€å§‹çš„<code>grunt</code>ï¼Œåˆ°<code>gulp</code>ï¼Œå†åˆ°ç°åœ¨çš„<code>webpack</code>ã€‚<br>æˆ‘ä»¬åœ¨ä½¿ç”¨<code>webpack</code>æ—¶ï¼Œå¯ä»¥é€šè¿‡é…ç½®ä¸€äº›å‘½ä»¤è¡Œå‚æ•°æ¥è®©<code>webpack</code>å®Œæˆä¸€äº›ç¼–è¯‘æ‰“åŒ…çš„ä»»åŠ¡ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬æ‰§è¡Œ<code>webpack</code>è¿™ä¸ªå‘½ä»¤çš„æ—¶å€™ï¼Œ<code>webpack</code>ç©¶ç«Ÿåšäº†å“ªäº›äº‹æƒ…? æˆ‘ä»¬ä¸€èµ·æ¥è¯»è¯»<code>webpack</code>çš„ç›¸å…³æºç ã€‚</p><p>æ³¨ï¼šæœ¬æ–‡é˜…è¯»çš„ç‰ˆæœ¬ä¸º<a href="https://github.com/webpack/webpack/tree/webpack-1" target="_blank" rel="noopener">webpack1.15.0</a>ï¼Œä»å…¥å£å¼€å§‹åˆ†æå†æ‹¿åˆ°æˆ‘ä»¬çš„å‘½ä»¤ä¹‹åæ‰§è¡Œçš„çš„æµç¨‹ï¼Œæ‰€ä»¥æœ‰äº›ä¸ªäººè®¤ä¸ºä¸é‡è¦çš„å¯èƒ½ä¼šçœç•¥ã€‚</p><p>é€šè¿‡<code>package.json</code>ä¸­çš„<code>bin</code>çš„æŒ‡å‘å¯ä»¥çŸ¥é“é¦–å…ˆä¼šèµ°åˆ°<code>./bin/webpack.js</code>è¿™ä¸ªæ–‡ä»¶ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env node</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//å¼•å…¥nodejs pathæ¨¡å—</span></span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// require.resolveè·å–/bin/webpack.jsçš„ç»å¯¹è·¯å¾„(ä»é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„node_modulesé‡Œé¢æ‰¾)</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">var</span> localWebpack = <span class="built_in">require</span>.resolve(path.join(process.cwd(), <span class="string">"node_modules"</span>, <span class="string">"webpack"</span>, <span class="string">"bin"</span>, <span class="string">"webpack.js"</span>));</span><br><span class="line"><span class="keyword">if</span>(__filename !== localWebpack) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">require</span>(localWebpack);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">catch</span>(e) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> optimist = <span class="built_in">require</span>(<span class="string">"optimist"</span>)</span><br><span class="line">.usage(<span class="string">"webpack "</span> + <span class="built_in">require</span>(<span class="string">"../package.json"</span>).version + <span class="string">"\n"</span> +</span><br><span class="line"><span class="string">"Usage: https://webpack.github.io/docs/cli.html"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">"./config-optimist"</span>)(optimist);</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¯¹åœ¨å‘½ä»¤è¡Œä¼ å…¥çš„å‚æ•°è¿›è¡Œè§£æ</span></span><br><span class="line"><span class="comment">//--colorsã€--jsonã€ ...</span></span><br><span class="line">optimist</span><br><span class="line">.boolean(<span class="string">"json"</span>).alias(<span class="string">"json"</span>, <span class="string">"j"</span>).describe(<span class="string">"json"</span>)</span><br><span class="line">.boolean(<span class="string">"colors"</span>).alias(<span class="string">"colors"</span>, <span class="string">"c"</span>).describe(<span class="string">"colors"</span>)</span><br><span class="line"><span class="comment">//å…¶ä»–å‚æ•°è§£æ, ç•¥;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//è·å–è§£æåçš„å‚æ•°å¹¶è½¬æ¢æ ¼å¼</span></span><br><span class="line"><span class="keyword">var</span> argv = optimist.argv;</span><br><span class="line"><span class="keyword">var</span> options = <span class="built_in">require</span>(<span class="string">"./convert-argv"</span>)(optimist, argv);</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¦‚æœæœ‰ç¬¦åˆargvé‡Œé¢çš„å‚æ•°</span></span><br><span class="line"><span class="comment">//å°±æ‰§è¡Œç›¸å…³çš„å›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ifArg</span>(<span class="params">name, fn, init</span>) </span>&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">Array</span>.isArray(argv[name])) &#123;</span><br><span class="line"><span class="keyword">if</span>(init) init();</span><br><span class="line">argv[name].forEach(fn);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">typeof</span> argv[name] !== <span class="string">"undefined"</span>) &#123;</span><br><span class="line"><span class="keyword">if</span>(init) init();</span><br><span class="line">fn(argv[name], <span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  å¤„ç†è¾“å‡ºç›¸å…³ï¼ˆoutputï¼‰çš„é…ç½®å‚æ•°ï¼Œå¹¶æ‰§è¡Œç¼–è¯‘å‡½æ•°</span></span><br><span class="line"><span class="comment"> *  @param   &#123;[type]&#125;  options  [description]</span></span><br><span class="line"><span class="comment"> *  @return  &#123;[type]&#125;           [description]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">processOptions</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line"><span class="comment">//å¦‚æœoptionsä¸‹é¢çš„thenæ˜¯ä¸ªå‡½æ•°(optionsæ˜¯ä¸ªPromiseç¤ºä¾‹)</span></span><br><span class="line"><span class="comment">//æŠŠprocessOptionsä½œä¸ºå‚æ•°ä¼ åˆ°options.thenä¸­</span></span><br><span class="line"><span class="comment">//å¹¶ä¸”ä¸­æ–­ä¸‹é¢ä»£ç çš„æ‰§è¡Œ</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">typeof</span> options.then === <span class="string">"function"</span>) &#123;</span><br><span class="line">options.then(processOptions).catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line"><span class="built_in">console</span>.error(err.stack || err);</span><br><span class="line">process.exit();</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¦‚æœä¼ å…¥çš„optionsæ˜¯ä¸€ä¸ªæ•°ç»„, å–æ•°ç»„çš„ç¬¬ä¸€é¡¹</span></span><br><span class="line"><span class="keyword">var</span> firstOptions = <span class="built_in">Array</span>.isArray(options) ? options[<span class="number">0</span>] : options;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¾“å‡ºçš„é…ç½®</span></span><br><span class="line"><span class="keyword">var</span> outputOptions = <span class="built_in">Object</span>.create(options.stats || firstOptions.stats || &#123;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¦‚æœoutputOptionsä¸­æœ¬èº«æ²¡æœ‰context</span></span><br><span class="line"><span class="comment">//å°±æŠŠé…ç½®é¡¹ä¸­çš„contextç»™å®ƒ</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">typeof</span> outputOptions.context === <span class="string">"undefined"</span>)</span><br><span class="line">outputOptions.context = firstOptions.context;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å„ç§å‘½ä»¤è¡Œå‚æ•°å¤„ç†</span></span><br><span class="line">ifArg(<span class="string">"json"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">bool</span>) </span>&#123;</span><br><span class="line"><span class="keyword">if</span>(bool)</span><br><span class="line">outputOptions.json = bool;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//è¿˜æœ‰å¾ˆå¤šifArgï¼Œç•¥</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//å¼•å…¥webpackå…¥å£æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">var</span> webpack = <span class="built_in">require</span>(<span class="string">"../lib/webpack.js"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//é”™è¯¯å †æ ˆè¿½è¸ªä¸Šé™</span></span><br><span class="line"><span class="built_in">Error</span>.stackTraceLimit = <span class="number">30</span>;</span><br><span class="line"><span class="keyword">var</span> lastHash = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ‰§è¡Œç¼–è¯‘</span></span><br><span class="line"><span class="keyword">var</span> compiler = webpack(options);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compilerCallback</span>(<span class="params">err, stats</span>) </span>&#123;</span><br><span class="line">      <span class="comment">//å‘½ä»¤è¡Œå‚æ•°ä¸­æ²¡æœ‰å¸¦æœ‰--watch</span></span><br><span class="line"><span class="keyword">if</span>(!options.watch) &#123;</span><br><span class="line">compiler.purgeInputFileSystem();</span><br><span class="line">&#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//å‡ºé”™</span></span><br><span class="line"><span class="keyword">if</span>(err) &#123;</span><br><span class="line">lastHash = <span class="literal">null</span>;</span><br><span class="line"><span class="built_in">console</span>.error(err.stack || err);</span><br><span class="line"><span class="keyword">if</span>(err.details) <span class="built_in">console</span>.error(err.details);</span><br><span class="line"><span class="keyword">if</span>(!options.watch) &#123;</span><br><span class="line">process.on(<span class="string">"exit"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">process.exit(<span class="number">1</span>);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(outputOptions.json) &#123;</span><br><span class="line">process.stdout.write(<span class="built_in">JSON</span>.stringify(stats.toJson(outputOptions), <span class="literal">null</span>, <span class="number">2</span>) + <span class="string">"\n"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(stats.hash !== lastHash) &#123;</span><br><span class="line">lastHash = stats.hash;</span><br><span class="line">process.stdout.write(stats.toString(outputOptions) + <span class="string">"\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">//å‘½ä»¤è¡Œå‚æ•°ä¸­å¸¦æœ‰--watch</span></span><br><span class="line"><span class="keyword">if</span>(options.watch) &#123;</span><br><span class="line"><span class="keyword">var</span> primaryOptions = !<span class="built_in">Array</span>.isArray(options) ? options : options[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">var</span> watchOptions = primaryOptions.watchOptions || primaryOptions.watch || &#123;&#125;;</span><br><span class="line"><span class="keyword">if</span>(watchOptions.stdin) &#123;</span><br><span class="line">process.stdin.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">process.exit(<span class="number">0</span>); <span class="comment">// eslint-disable-line</span></span><br><span class="line">&#125;);</span><br><span class="line">process.stdin.resume();</span><br><span class="line">&#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//è°ƒç”¨compilerä¸‹é¢çš„watchæ¥ç›‘å¬æ–‡ä»¶å˜åŒ–</span></span><br><span class="line">compiler.watch(watchOptions, compilerCallback);</span><br><span class="line">&#125; <span class="keyword">else</span></span><br><span class="line">compiler.run(compilerCallback);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ‰§è¡ŒprocessOptionså¹¶ä¸”ä¼ å…¥è§£æå‡ºæ¥çš„å‚æ•°</span></span><br><span class="line">processOptions(options);</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢å®šä¹‰çš„<code>processOptions</code>æ–¹æ³•ä¸­å¯ä»¥çœ‹åˆ°å¼•å…¥äº†<code>../lib/webpack.js</code>è¿™ä¸ªæ–‡ä»¶ï¼Œä¸‹é¢æˆ‘ä»¬ä¸€èµ·çœ‹çœ‹<code>../lib/webpack.js</code>è¿™ä¸ªæ–‡ä»¶ã€‚</p><p>åœ¨<code>../lib/webpack.js</code>ä¸­ï¼Œ<code>webpack</code>ä½œä¸ºå…¥å£å‡½æ•°ï¼Œæˆ‘ä»¬ä¸€èµ·çœ‹ä¸‹å®ƒçš„å®ç°ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  webpackå…¥å£</span></span><br><span class="line"><span class="comment"> *  @param   &#123;Object&#125;    options   webpack.config.jsä¸­module.exportså‡ºæ¥çš„å¯¹è±¡</span></span><br><span class="line"><span class="comment"> *  @param   &#123;Function&#125;  callback  å›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="comment"> *  @return  &#123;Object&#125;              webpack Compiler Object/multi compiler object Collection</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">webpack</span>(<span class="params">options, callback</span>) </span>&#123;</span><br><span class="line"><span class="keyword">var</span> compiler;</span><br><span class="line"><span class="comment">//optionsæ˜¯ä¸€ä¸ªæ•°ç»„æ—¶, å®ä¾‹åŒ–ä¸€ä¸ªMultiCompiler, å»mapè¿™ä¸ªæ•°ç»„, é’ˆå¯¹æ¯ä¸ªé…ç½®é¡¹è¿”å›ä¸€ä¸ªwebpackå®ä¾‹, æœ€åç”¨compileræ¥æ”¶</span></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">Array</span>.isArray(options)) &#123;</span><br><span class="line">compiler = <span class="keyword">new</span> MultiCompiler(options.map(<span class="function"><span class="keyword">function</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line"><span class="keyword">return</span> webpack(options);</span><br><span class="line">&#125;));</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">typeof</span> options === <span class="string">"object"</span>) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ä¾‹åŒ–ä¸€ä¸ªWebpackOptionsDefaulteræ¥å¤„ç†é»˜è®¤é…ç½®é¡¹</span></span><br><span class="line"><span class="keyword">new</span> WebpackOptionsDefaulter().process(options);</span><br><span class="line"></span><br><span class="line"><span class="comment">//å®ä¾‹åŒ–ä¸€ä¸ªCompiler, Compilerç»§æ‰¿è‡ªTapable(https://doc.webpack-china.org/api/plugins/tapable/)</span></span><br><span class="line"><span class="comment">//Compilerå®ä¾‹åŒ–åä¼šç»§æ‰¿åˆ°applyã€pluginç­‰è°ƒç”¨å’Œç»‘å®šæ’ä»¶çš„æ–¹æ³•</span></span><br><span class="line">compiler = <span class="keyword">new</span> Compiler();</span><br><span class="line"></span><br><span class="line"><span class="comment">//é…ç½®é¡¹</span></span><br><span class="line">compiler.options = options;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¯¹ä¼ å…¥çš„optionsè¿›è¡Œé€ä¸ªç¼–è¯‘,å¹¶ä¸”æŠŠoptionsä½œä¸ºè¿”å›å€¼é‡èµ‹å€¼åˆ°compiler.options</span></span><br><span class="line">compiler.options = <span class="keyword">new</span> WebpackOptionsApply().process(options, compiler);</span><br><span class="line"></span><br><span class="line"><span class="comment">//åº”ç”¨nodeç¯å¢ƒæ’ä»¶(ç»™compilerè®¾ç½®resolversã€watchFileSystemã€outputFileSystem)</span></span><br><span class="line"><span class="keyword">new</span> NodeEnvironmentPlugin().apply(compiler);</span><br><span class="line"></span><br><span class="line"><span class="comment">//è§¦å‘environmentå’Œafter-environmentäº‹ä»¶</span></span><br><span class="line">compiler.applyPlugins(<span class="string">"environment"</span>);</span><br><span class="line">compiler.applyPlugins(<span class="string">"after-environment"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//optionsæ—¢ä¸æ˜¯æ•°ç»„ä¹Ÿä¸æ˜¯å¯¹è±¡æ—¶, æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Invalid argument: options"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å­˜åœ¨å›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="keyword">if</span>(callback) &#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">typeof</span> callback !== <span class="string">"function"</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Invalid argument: callback"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//å‘½ä»¤è¡Œé‡Œé¢å¸¦watch, æˆ–è€…optionsæ˜¯ä¸ªæ•°ç»„(å¹¶ä¸”æ•°ç»„ä¸­æœ‰ä¸€é¡¹çš„watchä¸ºtrue)</span></span><br><span class="line"><span class="keyword">if</span>(options.watch === <span class="literal">true</span> || (<span class="built_in">Array</span>.isArray(options) &amp;&amp;</span><br><span class="line">options.some(<span class="function"><span class="keyword">function</span>(<span class="params">o</span>) </span>&#123;</span><br><span class="line"><span class="keyword">return</span> o.watch;</span><br><span class="line">&#125;))) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ ¹æ®å‚æ•°ç±»å‹æ‹¿åˆ°watchOptions</span></span><br><span class="line"><span class="keyword">var</span> watchOptions = (!<span class="built_in">Array</span>.isArray(options) ? options : options[<span class="number">0</span>]).watchOptions || &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//watchDelayå±æ€§åº”è¯¥è¢«options.watchOptions.aggregateTimeoutä»£æ›¿</span></span><br><span class="line"><span class="keyword">var</span> watchDelay = (!<span class="built_in">Array</span>.isArray(options) ? options : options[<span class="number">0</span>]).watchDelay;</span><br><span class="line"><span class="keyword">if</span>(watchDelay) &#123;</span><br><span class="line"><span class="built_in">console</span>.warn(<span class="string">"options.watchDelay is deprecated: Use 'options.watchOptions.aggregateTimeout' instead"</span>);</span><br><span class="line">watchOptions.aggregateTimeout = watchDelay;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å®ä¾‹åŒ–å¹¶è¿”å›ä¸€ä¸ªwatchå¯¹è±¡</span></span><br><span class="line"><span class="keyword">return</span> compiler.watch(watchOptions, callback);</span><br><span class="line">&#125;</span><br><span class="line">compiler.run(callback);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> compiler;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  åœ¨å¯¹è±¡ä¸‹ç”¨Object.definePropertyçš„æ–¹æ³•æ·»åŠ æ’ä»¶</span></span><br><span class="line"><span class="comment"> *  @param   &#123;Object&#125;  exports  è¢«æ·»åŠ çš„å¯¹è±¡</span></span><br><span class="line"><span class="comment"> *  @param   &#123;String&#125;  path     åœ¨getä¸­è¿”å›require</span></span><br><span class="line"><span class="comment"> *  @param   &#123;Array&#125;   plugins  æ’ä»¶æ•°ç»„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">exportPlugins</span>(<span class="params">exports, path, plugins</span>) </span>&#123;</span><br><span class="line">plugins.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line"><span class="built_in">Object</span>.defineProperty(exports, name, &#123;</span><br><span class="line">configurable: <span class="literal">false</span>,</span><br><span class="line">enumerable: <span class="literal">true</span>,</span><br><span class="line"><span class="keyword">get</span>: function() &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">require</span>(path + <span class="string">"/"</span> + name);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªæ–‡ä»¶æœ€åï¼Œé€šè¿‡ä¸Šé¢çš„<code>exportPlugins</code>åœ¨<code>webpack</code>ä¸‹é¢æŒ‚è½½äº†ä¸€äº›æ’ä»¶åšå±æ€§</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æš´éœ²æ’ä»¶åˆ°webpackä¸‹é¢</span></span><br><span class="line"><span class="comment">//new webpack.DefinePlugin()</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">exportPlugins(exports, <span class="string">"."</span>, [</span><br><span class="line"><span class="string">"DefinePlugin"</span>,</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">]);</span><br><span class="line">exportPlugins(exports.optimize = &#123;&#125;, <span class="string">"./optimize"</span>, [</span><br><span class="line"><span class="string">"AggressiveMergingPlugin"</span>,</span><br><span class="line"><span class="string">"CommonsChunkPlugin"</span>,</span><br><span class="line"><span class="string">"DedupePlugin"</span>,</span><br><span class="line"><span class="string">"LimitChunkCountPlugin"</span>,</span><br><span class="line"><span class="string">"MinChunkSizePlugin"</span>,</span><br><span class="line"><span class="string">"OccurenceOrderPlugin"</span>,</span><br><span class="line"><span class="string">"OccurrenceOrderPlugin"</span>,</span><br><span class="line"><span class="string">"UglifyJsPlugin"</span></span><br><span class="line">]);</span><br><span class="line">exportPlugins(exports.dependencies = &#123;&#125;, <span class="string">"./dependencies"</span>, [</span><br><span class="line"><span class="string">"LabeledModulesPlugin"</span></span><br><span class="line">]);</span><br></pre></td></tr></table></figure><p>åˆšæ‰åœ¨å¯¹<code>webpack</code>è¿›è¡Œæ ‡æ³¨çš„æ—¶å€™ï¼Œå®ä¾‹åŒ–äº†<code>WebpackOptionsApply</code>å¯¹è±¡å¹¶ä¸”è°ƒç”¨äº†<code>process</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°†ä¼šå¯¹æˆ‘ä»¬ä¼ è¿›å»çš„<code>options</code>å’Œ<code>compiler</code>ç¼–è¯‘å¯¹è±¡è¿›è¡Œé€ä¸ªç¼–è¯‘ï¼Œä¸‹é¢æˆ‘ä»¬ä¸€èµ·çœ‹ä¸‹<code>WebpackOptionsApply</code>è¿™ä¸ªæ¨¡å—çš„å®ç°ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">WebpackOptionsApply</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="comment">//OptionsApplyæ„é€ å‡½æ•°çš„ç»§æ‰¿</span></span><br><span class="line">OptionsApply.call(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = WebpackOptionsApply;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç»§æ‰¿OptionsApplyçš„åŸå‹</span></span><br><span class="line">WebpackOptionsApply.prototype = <span class="built_in">Object</span>.create(OptionsApply.prototype);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  å¯¹æˆ‘ä»¬ä¼ è¿›å»çš„optionså’Œcompilerç¼–è¯‘å¯¹è±¡è¿›è¡Œé€ä¸ªç¼–è¯‘</span></span><br><span class="line"><span class="comment"> *  @param   &#123;[type]&#125;  options   [description]</span></span><br><span class="line"><span class="comment"> *  @param   &#123;[type]&#125;  compiler  [description]</span></span><br><span class="line"><span class="comment"> *  @return  &#123;[type]&#125;            [description]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">WebpackOptionsApply.prototype.process = <span class="function"><span class="keyword">function</span>(<span class="params">options, compiler</span>) </span>&#123;</span><br><span class="line"><span class="comment">//contextå¤„ç†</span></span><br><span class="line">compiler.context = options.context;</span><br><span class="line"></span><br><span class="line"><span class="comment">//pluginsçš„å¤„ç†, è°ƒç”¨compiler.apply.apply</span></span><br><span class="line"><span class="keyword">if</span>(options.plugins &amp;&amp; <span class="built_in">Array</span>.isArray(options.plugins)) &#123;</span><br><span class="line">compiler.apply.apply(compiler, options.plugins);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç¼“å­˜è¾“å…¥è¾“å‡ºçš„è·¯å¾„</span></span><br><span class="line">compiler.outputPath = options.output.path;</span><br><span class="line">compiler.recordsInputPath = options.recordsInputPath || options.recordsPath;</span><br><span class="line">compiler.recordsOutputPath = options.recordsOutputPath || options.recordsPath;</span><br><span class="line">compiler.name = options.name;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¦‚æœoptions.targetæ˜¯ä¸ªå­—ç¬¦ä¸²,æ ¹æ®options.targetåˆ¤æ–­å…·ä½“åº”ç”¨å“ªäº›æ’ä»¶(compiler.apply)</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">typeof</span> options.target === <span class="string">"string"</span>) &#123;</span><br><span class="line"><span class="comment">//è¿™è¾¹æœ¬æ¥æœ‰ä¸ªswitch...caseæ¥æ ¹æ®options.targetçš„å…·ä½“å€¼åº”ç”¨</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(options.target !== <span class="literal">false</span>) &#123;</span><br><span class="line">options.target(compiler);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Unsupported target '"</span> + options.target + <span class="string">"'."</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//output.libraryç›¸å…³é…ç½®</span></span><br><span class="line"><span class="keyword">if</span>(options.output.library || options.output.libraryTarget !== <span class="string">"var"</span>) &#123;</span><br><span class="line"><span class="keyword">var</span> LibraryTemplatePlugin = <span class="built_in">require</span>(<span class="string">"./LibraryTemplatePlugin"</span>);</span><br><span class="line">compiler.apply(<span class="keyword">new</span> LibraryTemplatePlugin(options.output.library, options.output.libraryTarget, options.output.umdNamedDefine));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¤„ç†externalså±æ€§,å‘Šè¯‰webpackä¸è¦æ‰“åŒ…è¿™äº›æ¨¡å—,è€Œæ˜¯åœ¨è¿è¡Œæ—¶ä»ç¯å¢ƒä¸­è¯·æ±‚ä»–ä»¬</span></span><br><span class="line"><span class="keyword">if</span>(options.externals) &#123;</span><br><span class="line"><span class="keyword">var</span> ExternalsPlugin = <span class="built_in">require</span>(<span class="string">"./ExternalsPlugin"</span>);</span><br><span class="line">compiler.apply(<span class="keyword">new</span> ExternalsPlugin(options.output.libraryTarget, options.externals));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¤„ç†hotå±æ€§,devServerç›¸å…³</span></span><br><span class="line"><span class="keyword">if</span>(options.hot) &#123;</span><br><span class="line">compiler.apply(<span class="keyword">new</span> MovedToPluginWarningPlugin(<span class="string">"hot"</span>, <span class="string">"HotModuleReplacementPlugin"</span>));</span><br><span class="line"><span class="keyword">var</span> HotModuleReplacementPlugin = <span class="built_in">require</span>(<span class="string">"./HotModuleReplacementPlugin"</span>);</span><br><span class="line">compiler.apply(<span class="keyword">new</span> HotModuleReplacementPlugin(options.output));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//devtoolå’ŒsourceMapç›¸å…³é…ç½®</span></span><br><span class="line"><span class="keyword">if</span>(options.devtool &amp;&amp; (options.devtool.indexOf(<span class="string">"sourcemap"</span>) &gt;= <span class="number">0</span> || options.devtool.indexOf(<span class="string">"source-map"</span>) &gt;= <span class="number">0</span>)) &#123;</span><br><span class="line"><span class="keyword">var</span> hidden = options.devtool.indexOf(<span class="string">"hidden"</span>) &gt;= <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> inline = options.devtool.indexOf(<span class="string">"inline"</span>) &gt;= <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> evalWrapped = options.devtool.indexOf(<span class="string">"eval"</span>) &gt;= <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> cheap = options.devtool.indexOf(<span class="string">"cheap"</span>) &gt;= <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> moduleMaps = options.devtool.indexOf(<span class="string">"module"</span>) &gt;= <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> noSources = options.devtool.indexOf(<span class="string">"nosources"</span>) &gt;= <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> legacy = options.devtool.indexOf(<span class="string">"@"</span>) &gt;= <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> modern = options.devtool.indexOf(<span class="string">"#"</span>) &gt;= <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> comment = legacy &amp;&amp; modern ? <span class="string">"\n/*\n//@ sourceMappingURL=[url]\n//# sourceMappingURL=[url]\n*/"</span> :</span><br><span class="line">legacy ? <span class="string">"\n/*\n//@ sourceMappingURL=[url]\n*/"</span> :</span><br><span class="line">modern ? <span class="string">"\n//# sourceMappingURL=[url]"</span> :</span><br><span class="line"><span class="literal">null</span>;</span><br><span class="line"><span class="keyword">var</span> Plugin = evalWrapped ? EvalSourceMapDevToolPlugin : SourceMapDevToolPlugin;</span><br><span class="line">compiler.apply(<span class="keyword">new</span> Plugin(&#123;</span><br><span class="line">filename: inline ? <span class="literal">null</span> : options.output.sourceMapFilename,</span><br><span class="line">moduleFilenameTemplate: options.output.devtoolModuleFilenameTemplate,</span><br><span class="line">fallbackModuleFilenameTemplate: options.output.devtoolFallbackModuleFilenameTemplate,</span><br><span class="line">append: hidden ? <span class="literal">false</span> : comment,</span><br><span class="line"><span class="built_in">module</span>: moduleMaps ? <span class="literal">true</span> : cheap ? <span class="literal">false</span> : <span class="literal">true</span>,</span><br><span class="line">columns: cheap ? <span class="literal">false</span> : <span class="literal">true</span>,</span><br><span class="line">lineToLine: options.output.devtoolLineToLine,</span><br><span class="line">noSources: noSources,</span><br><span class="line">&#125;));</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(options.devtool &amp;&amp; options.devtool.indexOf(<span class="string">"eval"</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">var</span> legacy = options.devtool.indexOf(<span class="string">"@"</span>) &gt;= <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> modern = options.devtool.indexOf(<span class="string">"#"</span>) &gt;= <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> comment = legacy &amp;&amp; modern ? <span class="string">"//@ sourceURL=[url]\n//# sourceURL=[url]"</span> :</span><br><span class="line">legacy ? <span class="string">"//@ sourceURL=[url]"</span> :</span><br><span class="line">modern ? <span class="string">"//# sourceURL=[url]"</span> :</span><br><span class="line"><span class="literal">null</span>;</span><br><span class="line">compiler.apply(<span class="keyword">new</span> EvalDevToolModulePlugin(comment, options.output.devtoolModuleFilenameTemplate));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">compiler.apply(<span class="keyword">new</span> EntryOptionPlugin());</span><br><span class="line">compiler.applyPluginsBailResult(<span class="string">"entry-option"</span>, options.context, options.entry);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(options.prefetch) &#123;</span><br><span class="line">compiler.apply(<span class="keyword">new</span> MovedToPluginWarningPlugin(<span class="string">"prefetch"</span>, <span class="string">"PrefetchPlugin"</span>));</span><br><span class="line"><span class="keyword">var</span> PrefetchPlugin = <span class="built_in">require</span>(<span class="string">"./PrefetchPlugin"</span>);</span><br><span class="line">options.prefetch.map(<span class="function"><span class="keyword">function</span>(<span class="params">request</span>) </span>&#123;</span><br><span class="line">compiler.apply(<span class="keyword">new</span> PrefetchPlugin(options.context, request));</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">compiler.apply(</span><br><span class="line"><span class="keyword">new</span> CompatibilityPlugin(),</span><br><span class="line"><span class="keyword">new</span> LoaderPlugin(),<span class="comment">//loaderæ’ä»¶</span></span><br><span class="line"><span class="keyword">new</span> NodeStuffPlugin(options.node),<span class="comment">//nodejsç¯å¢ƒç›¸å…³çš„æ’ä»¶</span></span><br><span class="line"><span class="keyword">new</span> RequireJsStuffPlugin(),<span class="comment">//RequireJsçš„æ’ä»¶</span></span><br><span class="line"><span class="keyword">new</span> APIPlugin(),<span class="comment">//å˜é‡åçš„æ›¿æ¢,ç¼–è¯‘åçš„æ–‡ä»¶é‡Œéšå¤„å¯è§çš„__webpack_require__å˜é‡åå°±æ˜¯åœ¨æ­¤å¤„ç†</span></span><br><span class="line"><span class="keyword">new</span> ConstPlugin(),<span class="comment">//è½¬æ¢ä¸€äº›if, ä¸‰ç›®è¡¨è¾¾å¼ç­‰ç­‰</span></span><br><span class="line"><span class="keyword">new</span> RequireIncludePlugin(),<span class="comment">//require.includeå‡½æ•°çš„è½¬æ¢</span></span><br><span class="line"><span class="keyword">new</span> RequireEnsurePlugin(),<span class="comment">//require.ensureå‡½æ•°çš„è½¬æ¢</span></span><br><span class="line"><span class="keyword">new</span> RequireContextPlugin(options.resolve.modulesDirectories, options.resolve.extensions),</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">new</span> AMDPlugin(options.module, options.amd || &#123;&#125;),</span><br><span class="line"><span class="comment">//AMDè§„èŒƒæ’ä»¶</span></span><br><span class="line"><span class="keyword">new</span> CommonJsPlugin(options.module)<span class="comment">//commonJsè§„èŒƒæ’ä»¶</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">compiler.apply(</span><br><span class="line"><span class="keyword">new</span> RemoveParentModulesPlugin(),<span class="comment">//ç§»é™¤çˆ¶moduleçš„æ’ä»¶</span></span><br><span class="line"><span class="keyword">new</span> RemoveEmptyChunksPlugin(),<span class="comment">//ç§»é™¤ç©ºæ¨¡å—çš„æ’ä»¶</span></span><br><span class="line"><span class="keyword">new</span> MergeDuplicateChunksPlugin(),<span class="comment">//ç§»é™¤é‡å¤æ¨¡å—çš„æ’ä»¶</span></span><br><span class="line"><span class="keyword">new</span> FlagIncludedChunksPlugin()<span class="comment">//outputä¸­å¯¹äºåç§°çš„é…ç½®([name].[hash].[ext])</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">compiler.apply(<span class="keyword">new</span> TemplatedPathPlugin());</span><br><span class="line"></span><br><span class="line">compiler.apply(<span class="keyword">new</span> RecordIdsPlugin());<span class="comment">//è®°å½•chunkIdçš„æ’ä»¶</span></span><br><span class="line"></span><br><span class="line">compiler.apply(<span class="keyword">new</span> WarnCaseSensitiveModulesPlugin());</span><br><span class="line"><span class="comment">//å¤§å°å†™æ•æ„Ÿçš„æ’ä»¶</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * webpack.optimizeå±æ€§ä¸‹çš„å‡ ä¸ªæ–¹æ³•</span></span><br><span class="line"><span class="comment"> * ./webpack.js</span></span><br><span class="line"><span class="comment"> * exportPlugins(exports.optimize = &#123;&#125;, "./optimize", [</span></span><br><span class="line"><span class="comment"> * "AggressiveMergingPlugin"</span></span><br><span class="line"><span class="comment"> * //...</span></span><br><span class="line"><span class="comment"> * ]);</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span>(options.optimize &amp;&amp; options.optimize.occurenceOrder) &#123;</span><br><span class="line">compiler.apply(<span class="keyword">new</span> MovedToPluginWarningPlugin(<span class="string">"optimize.occurenceOrder"</span>, <span class="string">"optimize.OccurrenceOrderPlugin"</span>));</span><br><span class="line"><span class="keyword">var</span> OccurrenceOrderPlugin = <span class="built_in">require</span>(<span class="string">"./optimize/OccurrenceOrderPlugin"</span>);</span><br><span class="line">compiler.apply(<span class="keyword">new</span> OccurrenceOrderPlugin(options.optimize.occurenceOrderPreferEntry));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¤„ç†minChunkSize, æ€§èƒ½ä¼˜åŒ–ç›¸å…³</span></span><br><span class="line"><span class="comment"> * ä¸€äº›å°æ¨¡å—ä¼šè¢«æ‰“åŒ…æˆå•ç‹¬çš„æ¨¡å—è€Œé€ æˆä¸å¿…è¦çš„HTTPè¯·æ±‚, æŒ‡å®šminChunkSizeä¼šåˆå¹¶è¿™äº›å°æ¨¡å—, å‡å°‘HTTPè¯·æ±‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span>(options.optimize &amp;&amp; options.optimize.minChunkSize) &#123;</span><br><span class="line">compiler.apply(<span class="keyword">new</span> MovedToPluginWarningPlugin(<span class="string">"optimize.minChunkSize"</span>, <span class="string">"optimize.MinChunkSizePlugin"</span>));</span><br><span class="line"><span class="keyword">var</span> MinChunkSizePlugin = <span class="built_in">require</span>(<span class="string">"./optimize/MinChunkSizePlugin"</span>);</span><br><span class="line">compiler.apply(<span class="keyword">new</span> MinChunkSizePlugin(options.optimize));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å’ŒmaxChunksSizeç›¸å</span></span><br><span class="line"><span class="keyword">if</span>(options.optimize &amp;&amp; options.optimize.maxChunks) &#123;</span><br><span class="line">compiler.apply(<span class="keyword">new</span> MovedToPluginWarningPlugin(<span class="string">"optimize.maxChunks"</span>, <span class="string">"optimize.LimitChunkCountPlugin"</span>));</span><br><span class="line"><span class="keyword">var</span> LimitChunkCountPlugin = <span class="built_in">require</span>(<span class="string">"./optimize/LimitChunkCountPlugin"</span>);</span><br><span class="line">compiler.apply(<span class="keyword">new</span> LimitChunkCountPlugin(options.optimize));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(options.optimize.minimize) &#123;</span><br><span class="line">compiler.apply(<span class="keyword">new</span> MovedToPluginWarningPlugin(<span class="string">"optimize.minimize"</span>, <span class="string">"optimize.UglifyJsPlugin"</span>));</span><br><span class="line"><span class="keyword">var</span> UglifyJsPlugin = <span class="built_in">require</span>(<span class="string">"./optimize/UglifyJsPlugin"</span>);</span><br><span class="line"><span class="keyword">if</span>(options.optimize.minimize === <span class="literal">true</span>)</span><br><span class="line">compiler.apply(<span class="keyword">new</span> UglifyJsPlugin());</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">compiler.apply(<span class="keyword">new</span> UglifyJsPlugin(options.optimize.minimize));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç¼“å­˜,è¯¥å±æ€§åœ¨watchçš„æ¨¡å¼ä¸‹é»˜è®¤å¼€å¯ç¼“å­˜</span></span><br><span class="line"><span class="keyword">if</span>(options.cache === <span class="literal">undefined</span> ? options.watch : options.cache) &#123;</span><br><span class="line"><span class="keyword">var</span> CachePlugin = <span class="built_in">require</span>(<span class="string">"./CachePlugin"</span>);</span><br><span class="line">compiler.apply(<span class="keyword">new</span> CachePlugin(<span class="keyword">typeof</span> options.cache === <span class="string">"object"</span> ? options.cache : <span class="literal">null</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¤„ç†provideå±æ€§,å¦‚æœæœ‰åˆ™è°ƒç”¨ProvidePluginæ’ä»¶,è¿™ä¸ªæ’ä»¶å¯ä»¥è®©ä¸€ä¸ªmoduleèµ‹å€¼ä¸ºä¸€ä¸ªå˜é‡,ä»è€Œèƒ½åœ¨æ¯ä¸ªmoduleä¸­ä»¥å˜é‡åè®¿é—®å®ƒ</span></span><br><span class="line"><span class="comment"> * new webpack.ProvidePlugin(&#123;</span></span><br><span class="line"><span class="comment"> * identifier: "module1"</span></span><br><span class="line"><span class="comment"> * &#125;);</span></span><br><span class="line"><span class="comment"> * new webpack.ProvidePlugin(&#123;</span></span><br><span class="line"><span class="comment"> * identifier: ["module1", "property1"]</span></span><br><span class="line"><span class="comment"> * &#125;);</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">typeof</span> options.provide === <span class="string">"object"</span>) &#123;</span><br><span class="line">compiler.apply(<span class="keyword">new</span> MovedToPluginWarningPlugin(<span class="string">"provide"</span>, <span class="string">"ProvidePlugin"</span>));</span><br><span class="line"><span class="keyword">var</span> ProvidePlugin = <span class="built_in">require</span>(<span class="string">"./ProvidePlugin"</span>);</span><br><span class="line">compiler.apply(<span class="keyword">new</span> ProvidePlugin(options.provide));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¤„ç†defineå±æ€§,å¦‚æœæœ‰è¿™ä¸ªå±æ€§åˆ™è°ƒç”¨DefinePluginæ’ä»¶,è¿™ä¸ªæ’ä»¶å¯ä»¥å®šä¹‰å…¨å±€çš„å¸¸é‡</span></span><br><span class="line"><span class="comment"> * //define</span></span><br><span class="line"><span class="comment"> * new webpack.DefinePlugin(&#123;</span></span><br><span class="line"><span class="comment"> * PRODUCTION: JSON.stringify(true),</span></span><br><span class="line"><span class="comment"> * BROWSER_SUPPORTS_HTML5: true</span></span><br><span class="line"><span class="comment"> * &#125;);</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * //use</span></span><br><span class="line"><span class="comment"> * if(!PRODUCTION) &#123;</span></span><br><span class="line"><span class="comment"> * console.log("develop mode");</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * if (!BROWSER_SUPPORTS_HTML5) &#123;</span></span><br><span class="line"><span class="comment"> * require("html5shiv");</span></span><br><span class="line"><span class="comment"> * &#125; </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span>(options.define) &#123;</span><br><span class="line">compiler.apply(<span class="keyword">new</span> MovedToPluginWarningPlugin(<span class="string">"define"</span>, <span class="string">"DefinePlugin"</span>));</span><br><span class="line"><span class="keyword">var</span> defineObject = &#123;&#125;;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">typeof</span> options.define === <span class="string">"object"</span>) &#123;</span><br><span class="line"><span class="built_in">Object</span>.keys(options.define).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">defineObject[key] = options.define[key];</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">compiler.apply(<span class="keyword">new</span> DefinePlugin(defineObject));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//defineDebugä¸ä¸ºfalse,å£°æ˜ä¸€ä¸ªå…¨å±€çš„DEBUG</span></span><br><span class="line"><span class="keyword">if</span>(options.defineDebug !== <span class="literal">false</span>)</span><br><span class="line">compiler.apply(<span class="keyword">new</span> DefinePlugin(&#123;</span><br><span class="line">DEBUG: !!options.debug</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line"><span class="comment">//è§¦å‘after-pluginså’Œåº”ç”¨ä¸€äº›å…¶ä»–æ’ä»¶, æœ€åè§¦å‘after-resolvers</span></span><br><span class="line">compiler.applyPlugins(<span class="string">"after-plugins"</span>, compiler);</span><br><span class="line">compiler.resolvers.normal.apply(</span><br><span class="line"><span class="keyword">new</span> UnsafeCachePlugin(options.resolve.unsafeCache)</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">);</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">compiler.applyPlugins(<span class="string">"after-resolvers"</span>, compiler);</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿”å›options</span></span><br><span class="line"><span class="keyword">return</span> options;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>çœ‹å®Œè¿™ä¸€æ®µä¹‹åï¼Œä¸ªäººå¯¹<code>webpack</code>çš„äº†è§£æ›´æ·±å…¥äº†ä¸€äº›ï¼Œç†Ÿæ‚‰äº†å¥½å‡ ä¸ªå¹³å¸¸ä¸æ€ä¹ˆç”¨åˆ°ï¼Œä½†æ˜¯æ„Ÿè§‰è¿˜æ˜¯å¾ˆæœ‰ç”¨çš„ä¸œè¥¿ï¼Œä¾‹å¦‚<code>externals</code>å’Œ<code>define</code>å±æ€§ã€‚</p><p>åˆ°è¿™é‡Œï¼Œ<code>webpack</code>çš„æ•´ä½“æµç¨‹ç®—æ˜¯å®Œäº†ï¼Œåœ¨<code>webpack</code>ä¸­ï¼Œæœ‰å„å¼å„æ ·çš„æ’ä»¶ï¼Œä¸‹é¢æˆ‘ä»¬ä¸€èµ·äº†è§£ä¸‹å¤§å®¶æ‰€ç†ŸçŸ¥çš„<code>UglifyJsPlugin</code>æ¥ç†è§£ä¸‹æ’ä»¶ä½“ç³»å’ŒåŠ æ·±å¯¹<code>webpack</code>æµç¨‹çš„ç†è§£ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬äº†è§£ä¸‹å¼€å‘<a href="https://doc.webpack-china.org/development/how-to-write-a-plugin" target="_blank" rel="noopener">webpackæ’ä»¶</a>çš„ä¸€äº›äº‹é¡¹ï¼š<br>åœ¨ä¸­æ–‡é‡Œé¢æåˆ°ï¼š</p><ul><li>ä¸€ä¸ªJavaScriptå‘½åå‡½æ•°</li><li>åœ¨å®ƒçš„åŸå‹ä¸Šå®šä¹‰ä¸€ä¸ª<code>apply</code>æ–¹æ³•</li><li>æŒ‡å®šæŒ‚è½½çš„webpackäº‹ä»¶é’©å­</li><li>å¤„ç†webpackå†…éƒ¨å®ä¾‹çš„ç‰¹å®šæ•°æ®</li><li>åŠŸèƒ½å®Œæˆåè°ƒç”¨webpackæä¾›çš„å›è°ƒ</li></ul><p>åŸºç¡€ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‘½åå‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyExampleWebpackPlugin</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨å®ƒçš„ prototype ä¸Šå®šä¹‰ä¸€ä¸ª apply æ–¹æ³•ã€‚</span></span><br><span class="line">MyExampleWebpackPlugin.prototype.apply = <span class="function"><span class="keyword">function</span>(<span class="params">compiler</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// æŒ‡å®šæŒ‚è½½çš„webpackäº‹ä»¶é’©å­</span></span><br><span class="line">  compiler.plugin(<span class="string">'webpacksEventHook'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">compilation <span class="regexp">/* å¤„ç†webpackå†…éƒ¨å®ä¾‹çš„ç‰¹å®šæ•°æ®*/</span>, callback</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"This is an example plugin!!!"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŠŸèƒ½å®Œæˆåè°ƒç”¨webpackæä¾›çš„å›è°ƒã€‚</span></span><br><span class="line">    callback();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>äº†è§£äº†æ’ä»¶çš„åŸºæœ¬æ¶æ„ï¼Œä¸‹é¢ä¸€èµ·çœ‹ä¸‹<code>UglifyJsPlugin</code>çš„å®ç°ï¼Œ<code>UglifyJsPlugin</code>ä½äº<code>lib/optimize/UglifyJsPlugin.js</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¸€ä¸ªJavaScriptå‘½åå‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UglifyJsPlugin</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">typeof</span> options !== <span class="string">"object"</span>) options = &#123;&#125;;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">typeof</span> options.compressor !== <span class="string">"undefined"</span>) &#123;</span><br><span class="line">options.compress = options.compressor;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">this</span>.options = options;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = UglifyJsPlugin;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åœ¨å®ƒçš„åŸå‹ä¸Šå®šä¹‰ä¸€ä¸ªapplyæ–¹æ³•</span></span><br><span class="line">UglifyJsPlugin.prototype.apply = <span class="function"><span class="keyword">function</span>(<span class="params">compiler</span>) </span>&#123;</span><br><span class="line"><span class="keyword">var</span> options = <span class="keyword">this</span>.options;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¦‚æœåªé€‰æŒ‡å®šé¡¹ä¸­æœ‰å…³äºæ–‡ä»¶åç¼€çš„å°±ç”¨æŒ‡å®šé¡¹ä¸­çš„ï¼Œå¦åˆ™ç”¨é»˜è®¤çš„(.jsç»“å°¾)</span></span><br><span class="line">options.test = options.test || <span class="regexp">/\.js($|\?)/i</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> requestShortener = <span class="keyword">new</span> RequestShortener(compiler.context);</span><br><span class="line">compiler.plugin(<span class="string">"compilation"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">compilation</span>) </span>&#123;</span><br><span class="line"><span class="keyword">if</span>(options.sourceMap !== <span class="literal">false</span>) &#123;</span><br><span class="line">compilation.plugin(<span class="string">"build-module"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">module</span>) </span>&#123;</span><br><span class="line"><span class="comment">// to get detailed location info about errors</span></span><br><span class="line"><span class="built_in">module</span>.useSourceMap = <span class="literal">true</span>;</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æŒ‡å®šæŒ‚è½½çš„webpackäº‹ä»¶é’©å­(optimize-chunk-assets)</span></span><br><span class="line"><span class="comment"> * @param  &#123;Object&#125;  chunks     è¢«å‹ç¼©çš„æ¨¡å—ä¿¡æ¯</span></span><br><span class="line"><span class="comment"> * @param  &#123;Object&#125;  callback webpackæä¾›çš„å›è°ƒ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">compilation.plugin(<span class="string">"optimize-chunk-assets"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">chunks, callback</span>) </span>&#123;</span><br><span class="line"><span class="keyword">var</span> files = [];</span><br><span class="line"></span><br><span class="line"><span class="comment">//å–å‡ºæ¨¡å—ä¸­çš„æ–‡ä»¶</span></span><br><span class="line">chunks.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>) </span>&#123;</span><br><span class="line">chunk.files.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">file</span>) </span>&#123;</span><br><span class="line">files.push(file);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//compilation.additionalChunkAssetsè¿™ä¸ªé˜Ÿåˆ—åœ¨lib/HotModuleReplacementPlugin.jsè¿™ä¸ªæ–‡ä»¶ä¸­è¢«åŠ å…¥äº†æ–°å…ƒç´ </span></span><br><span class="line"><span class="comment">//ä¹Ÿä¸€èµ·åˆå¹¶åˆ°filesä¸­å»</span></span><br><span class="line">compilation.additionalChunkAssets.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">file</span>) </span>&#123;</span><br><span class="line">files.push(file);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//æå–å‡ºç¬¦åˆoptionsä¸­æŒ‡å®šçš„æ–‡ä»¶åç¼€çš„æ–‡ä»¶</span></span><br><span class="line">files = files.filter(ModuleFilenameHelpers.matchObject.bind(<span class="literal">undefined</span>, options));</span><br><span class="line">files.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">file</span>) </span>&#123;</span><br><span class="line"><span class="keyword">var</span> oldWarnFunction = uglify.AST_Node.warn_function;</span><br><span class="line"><span class="keyword">var</span> warnings = [];</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">var</span> asset = compilation.assets[file];</span><br><span class="line"><span class="keyword">if</span>(asset.__UglifyJsPlugin) &#123;</span><br><span class="line">compilation.assets[file] = asset.__UglifyJsPlugin;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//sourceMapç›¸å…³</span></span><br><span class="line"><span class="keyword">if</span>(options.sourceMap !== <span class="literal">false</span>) &#123;</span><br><span class="line"><span class="keyword">if</span>(asset.sourceAndMap) &#123;</span><br><span class="line"><span class="keyword">var</span> sourceAndMap = asset.sourceAndMap();</span><br><span class="line"><span class="keyword">var</span> inputSourceMap = sourceAndMap.map;</span><br><span class="line"><span class="keyword">var</span> input = sourceAndMap.source;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">var</span> inputSourceMap = asset.map();</span><br><span class="line"><span class="keyword">var</span> input = asset.source();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> sourceMap = <span class="keyword">new</span> SourceMapConsumer(inputSourceMap);</span><br><span class="line">uglify.AST_Node.warn_function = <span class="function"><span class="keyword">function</span>(<span class="params">warning</span>) </span>&#123; <span class="comment">// eslint-disable-line camelcase</span></span><br><span class="line"><span class="keyword">var</span> match = <span class="regexp">/\[.+:([0-9]+),([0-9]+)\]/</span>.exec(warning);</span><br><span class="line"><span class="keyword">var</span> line = +match[<span class="number">1</span>];</span><br><span class="line"><span class="keyword">var</span> column = +match[<span class="number">2</span>];</span><br><span class="line"><span class="keyword">var</span> original = sourceMap.originalPositionFor(&#123;</span><br><span class="line">line: line,</span><br><span class="line">column: column</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">if</span>(!original || !original.source || original.source === file) <span class="keyword">return</span>;</span><br><span class="line">warnings.push(warning.replace(<span class="regexp">/\[.+:([0-9]+),([0-9]+)\]/</span>, <span class="string">""</span>) +</span><br><span class="line"><span class="string">"["</span> + requestShortener.shorten(original.source) + <span class="string">":"</span> + original.line + <span class="string">","</span> + original.column + <span class="string">"]"</span>);</span><br><span class="line">&#125;;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">var</span> input = asset.source();</span><br><span class="line">uglify.AST_Node.warn_function = <span class="function"><span class="keyword">function</span>(<span class="params">warning</span>) </span>&#123; <span class="comment">// eslint-disable-line camelcase</span></span><br><span class="line">warnings.push(warning);</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br><span class="line">uglify.base54.reset();</span><br><span class="line"><span class="keyword">var</span> ast = uglify.parse(input, &#123;</span><br><span class="line">filename: file</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//å‹ç¼©ä»£ç å¹¶åº”ç”¨è½¬æ¢</span></span><br><span class="line"><span class="keyword">if</span>(options.compress !== <span class="literal">false</span>) &#123;</span><br><span class="line">ast.figure_out_scope();</span><br><span class="line"><span class="keyword">var</span> compress = uglify.Compressor(options.compress);</span><br><span class="line">ast = ast.transform(compress);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åœ¨é¡¶çº§ä½œç”¨åŸŸæ‰“ä¹±å˜é‡åç§°ï¼ˆé»˜è®¤ä¸å¼€å¯ï¼‰</span></span><br><span class="line"><span class="keyword">if</span>(options.mangle !== <span class="literal">false</span>) &#123;</span><br><span class="line">ast.figure_out_scope(options.mangle || &#123;&#125;);</span><br><span class="line">ast.compute_char_frequency(options.mangle || &#123;&#125;);</span><br><span class="line">ast.mangle_names(options.mangle || &#123;&#125;);</span><br><span class="line"><span class="keyword">if</span>(options.mangle &amp;&amp; options.mangle.props) &#123;</span><br><span class="line">uglify.mangle_properties(ast, options.mangle.props);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> output = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ³¨é‡Š</span></span><br><span class="line">output.comments = <span class="built_in">Object</span>.prototype.hasOwnProperty.call(options, <span class="string">"comments"</span>) ? options.comments : <span class="regexp">/^\**!|@preserve|@license/</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä»£ç ç¾åŒ–</span></span><br><span class="line">output.beautify = options.beautify;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æŠŠoptions.outputä¸‹çš„æ¯é¡¹æå–åˆ°output</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> k <span class="keyword">in</span> options.output) &#123;</span><br><span class="line">output[k] = options.output[k];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(options.sourceMap !== <span class="literal">false</span>) &#123;</span><br><span class="line"><span class="keyword">var</span> map = uglify.SourceMap(&#123; <span class="comment">// eslint-disable-line new-cap</span></span><br><span class="line">file: file,</span><br><span class="line">root: <span class="string">""</span></span><br><span class="line">&#125;);</span><br><span class="line">output.source_map = map; <span class="comment">// eslint-disable-line camelcase</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> stream = uglify.OutputStream(output); <span class="comment">// eslint-disable-line new-cap</span></span><br><span class="line">ast.print(stream);</span><br><span class="line"><span class="keyword">if</span>(map) map = map + <span class="string">""</span>;</span><br><span class="line">stream = stream + <span class="string">""</span>;</span><br><span class="line">asset.__UglifyJsPlugin = compilation.assets[file] = (map ?</span><br><span class="line"><span class="keyword">new</span> SourceMapSource(stream, file, <span class="built_in">JSON</span>.parse(map), input, inputSourceMap) :</span><br><span class="line"><span class="keyword">new</span> RawSource(stream));</span><br><span class="line"><span class="keyword">if</span>(warnings.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">compilation.warnings.push(<span class="keyword">new</span> <span class="built_in">Error</span>(file + <span class="string">" from UglifyJs\n"</span> + warnings.join(<span class="string">"\n"</span>)));</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line"><span class="comment">//æ•è·åˆ°å‹ç¼©å‡ºé”™ä¿¡æ¯çš„æ“ä½œ</span></span><br><span class="line"><span class="keyword">if</span>(err.line) &#123;</span><br><span class="line"><span class="keyword">var</span> original = sourceMap &amp;&amp; sourceMap.originalPositionFor(&#123;</span><br><span class="line">line: err.line,</span><br><span class="line">column: err.col</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">if</span>(original &amp;&amp; original.source) &#123;</span><br><span class="line">compilation.errors.push(<span class="keyword">new</span> <span class="built_in">Error</span>(file + <span class="string">" from UglifyJs\n"</span> + err.message + <span class="string">" ["</span> + requestShortener.shorten(original.source) + <span class="string">":"</span> + original.line + <span class="string">","</span> + original.column + <span class="string">"]"</span>));</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">compilation.errors.push(<span class="keyword">new</span> <span class="built_in">Error</span>(file + <span class="string">" from UglifyJs\n"</span> + err.message + <span class="string">" ["</span> + file + <span class="string">":"</span> + err.line + <span class="string">","</span> + err.col + <span class="string">"]"</span>));</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(err.msg) &#123;</span><br><span class="line">compilation.errors.push(<span class="keyword">new</span> <span class="built_in">Error</span>(file + <span class="string">" from UglifyJs\n"</span> + err.msg));</span><br><span class="line">&#125; <span class="keyword">else</span></span><br><span class="line">compilation.errors.push(<span class="keyword">new</span> <span class="built_in">Error</span>(file + <span class="string">" from UglifyJs\n"</span> + err.stack));</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">uglify.AST_Node.warn_function = oldWarnFunction; <span class="comment">// eslint-disable-line camelcase</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ‰§è¡Œå›è°ƒå‡½æ•°</span></span><br><span class="line">callback();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŒ‡å®šæŒ‚è½½çš„webpackäº‹ä»¶é’©å­(normal-module-loader)</span></span><br><span class="line">compilation.plugin(<span class="string">"normal-module-loader"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">context</span>) </span>&#123;</span><br><span class="line">context.minimize = <span class="literal">true</span>;</span><br><span class="line">&#125;);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢å°±æ˜¯æˆ‘å¯¹<code>UglifyJsPlugin</code>çš„æ ‡æ³¨ï¼Œä»è¿™ä¸ªæ’ä»¶çš„æºç åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥åŸºæœ¬çœ‹åˆ° webpack ç¼–è¯‘æ—¶çš„è¯»å†™è¿‡ç¨‹å¤§è‡´æ˜¯æ€ä¹ˆæ ·çš„ï¼šå®ä¾‹åŒ–æ’ä»¶ â€“&gt; è¯»å–æºæ–‡ä»¶ â€“&gt; ç¼–è¯‘å¹¶è¾“å‡º</p><h5 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><p>æˆ‘ä»¬åœ¨å‘½ä»¤è¡Œé‡Œè¾“å…¥äº†<code>webpack [--xxx]</code>ä¹‹åï¼Œ<code>webpack</code>å†…éƒ¨å¤§æ¦‚å¸®æˆ‘ä»¬åšäº†ä¸‹é¢å‡ ä»¶äº‹æƒ…ï¼š</p><ul><li>é¦–å…ˆä¼šèµ°åˆ°<code>bin/webpack.js</code>ï¼Œè§£æå‘½ä»¤è¡Œå‚æ•°ä»¥åŠå¼€å§‹æ‰§è¡Œç¼–è¯‘</li><li>åœ¨<code>bin/webpack.js</code>ä¸­è°ƒç”¨<code>webpack</code>å…¥å£å‡½æ•°ï¼Œ èµ°åˆ°<code>lib/webpack.js</code></li><li>åœ¨<code>webpack</code>ä¸­å®ä¾‹åŒ–ä¸€ä¸ª<code>Compiler</code>å¯¹è±¡ï¼ˆç»§æ‰¿<code>Tapable</code>ï¼Œå®ç°æ’ä»¶çš„æ³¨å†Œï¼‰ï¼Œè°ƒç”¨ç›®å½•ä¸‹çš„<code>lib/WebpackOptionsApply.js</code>æ¨¡å—</li><li>åœ¨<code>lib/WebpackOptionsApply.js</code>ä¸­æ ¹æ®ä¼ å…¥çš„<code>options</code>å’Œ<code>compiler</code>é€ä¸ªç¼–è¯‘å¹¶åº”ç”¨ä¸åŒæ’ä»¶ï¼Œå¹¶ä¸”è¿”å›æ–‡ä»¶</li></ul><h5 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h5><p><a href="https://zhuanlan.zhihu.com/p/24717349" target="_blank" rel="noopener">[webpack]æºç è§£è¯»ï¼šå‘½ä»¤è¡Œè¾“å…¥webpackçš„æ—¶å€™éƒ½å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</a></p><p><a href="http://www.jianshu.com/p/01a606c97d76" target="_blank" rel="noopener">webpackæºç åˆ†æï¼ˆä¸€ï¼‰â€” Tapableæ’ä»¶æ¶æ„</a></p><p><a href="https://juejin.im/entry/576b7aeda633bd0064065c74" target="_blank" rel="noopener">webpack æºç è§£æ</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨å‰ç«¯å·¥ç¨‹åŒ–è¶Šæ¥è¶Šæ™®åŠçš„ä»Šå¤©ï¼Œæˆ‘ä»¬å‡ ä¹æ¯ä¸ªé¡¹ç›®éƒ½éœ€è¦ç”¨åˆ°æ„å»ºå·¥å…·ï¼Œä»ä¸€å¼€å§‹çš„&lt;code&gt;grunt&lt;/code&gt;ï¼Œåˆ°&lt;code&gt;gulp&lt;/code&gt;ï¼Œå†åˆ°ç°åœ¨çš„&lt;code&gt;webpack&lt;/code&gt;ã€‚&lt;br&gt;æˆ‘ä»¬åœ¨ä½¿ç”¨&lt;code&gt;webpack&lt;/code&gt;æ—¶ï¼Œå¯ä»¥é€šè¿‡
      
    
    </summary>
    
    
      <category term="javascript" scheme="http://yoursite.com/categories/javascript/"/>
    
      <category term="webpackï¼Œæ„å»ºå·¥å…·" scheme="http://yoursite.com/categories/javascript/webpack%EF%BC%8C%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7/"/>
    
    
  </entry>
  
  <entry>
    <title>ä»é›¶å¼€å§‹å†™ä¸€ä¸ªReact - setStateå’Œç”Ÿå‘½å‘¨æœŸ</title>
    <link href="http://yoursite.com/2017/09/14/2017-09-14-write-your-own-react-2/"/>
    <id>http://yoursite.com/2017/09/14/2017-09-14-write-your-own-react-2/</id>
    <published>2017-09-13T16:00:00.000Z</published>
    <updated>2017-09-14T09:26:47.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨å‰é¢ä¸€ç¯‡ä¸­æˆ‘ä»¬ç”¨<code>instantiateReactComponent</code>æ–¹æ³•æ¥æ ¹æ®<code>node</code>çš„ä¸åŒæ¥è¿”å›ä¸åŒçš„ç»„ä»¶å®ä¾‹ï¼Œä¹‹å‰çš„åˆ†ç±»å¯èƒ½æœ‰äº›é—®é¢˜ï¼Œå°±æ˜¯å½“è¯¥ç»„ä»¶ä¸­<code>JSX</code>éƒ¨åˆ†æœ‰è¿”å›<code>null</code>çš„æƒ…å†µï¼Œ<code>instantiateReactComponent</code>å°±ä¸èƒ½è¿”å›æ­£ç¡®çš„ç»„ä»¶ï¼Œæ‰€ä»¥åœ¨è¿™é‡ŒåŠ äº†ä¸€ç§æ–°çš„ç»„ä»¶ç±»å‹ï¼š<code>ReactEmptyComponent</code>ï¼Œä½œç”¨å°±æ˜¯è¿”å›ä¸€æ®µç©ºçš„æ³¨é‡Šï¼Œæ ‡è®°è¿™æ˜¯ä¸€ä¸ªç©ºç»„ä»¶ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">instantiateReactComponent</span>(<span class="params">node</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (lodash.isNull(node) || lodash.isUndefined(node)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ReactEmptyComponent(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//  ç©ºç»„ä»¶</span></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ReactEmptyComponent</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(node) &#123;</span><br><span class="line">        <span class="keyword">this</span>.type = <span class="string">"ReactEmptyComponent"</span>;</span><br><span class="line">        <span class="keyword">this</span>._currentElement = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">this</span>._rootNodeID = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  ç©ºç»„ä»¶æŒ‚è½½ç›´æ¥è¿”å›ä¸€æ®µç©ºæ³¨é‡Šå›å»</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    mountComponent(rootID) &#123;</span><br><span class="line">        <span class="keyword">this</span>._rootNodeID = rootID;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">`&lt;!-- empty component data-reactid="<span class="subst">$&#123;<span class="keyword">this</span>._rootNodeID&#125;</span>" --&gt;`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¹‹å‰ç®€å•å®ç°äº†ä¸€ä¸ªåˆå§‹åŒ–æ¸²æŸ“çš„è¿‡ç¨‹ï¼Œç°åœ¨æˆ‘ä»¬ä¸€èµ·å®ç°ä¸€ä¸ª<code>setState</code>æ–¹æ³•ä»¥åŠç»„ä»¶åé¢çš„æ›´æ–°é€»è¾‘ã€‚<code>setState</code>æ˜¯åœ¨ç»„ä»¶ä¸­è¢«è°ƒç”¨çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ä¹‹å‰çš„<code>Component</code>ç±»ä¸­åŠ å…¥ä¸€ä¸ª<code>setState</code>æ–¹æ³•ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    setState(newState, callback) &#123;</span><br><span class="line">        <span class="keyword">const</span> stacks = StackTrace.getSync();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> &#123;functionName, source&#125; <span class="keyword">of</span> stacks) &#123;</span><br><span class="line">            <span class="keyword">if</span>(RENDER_REG.test(functionName) &amp;&amp; RENDER_REG.test(source)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"callStack Error: you can't call setState in render method!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>._reactInternalInstance.receiveComponent(<span class="literal">null</span>, newState);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (lodash.isFunction(callback)) &#123;</span><br><span class="line">            callback();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹å‰ä¸€ç¯‡æˆ‘ä»¬è¯´åˆ°ä¸€å…±å¯åˆ†æˆæ–‡æœ¬ç»„ä»¶ï¼Œæµè§ˆå™¨æ ‡ç­¾ç»„ä»¶ï¼Œè‡ªå®šä¹‰æ ‡ç­¾ç»„ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨è¿™ä¸‰ä¸ªç»„ä»¶ä¸­å„å®ç°ä¸€ä¸ª<code>receiveComponent</code>æ¥æ¥æ”¶æ–°ç»„ä»¶å¹¶ä¸”å®ç°ç›¸åº”æ›´æ–°ï¼š</p><p>å¯¹äºæ™®é€šçš„æ–‡æœ¬èŠ‚ç‚¹ï¼Œè¦åšçš„ç›¸å¯¹ç®€å•ï¼Œå°±æ˜¯åœ¨<code>receiveComponent</code>ä¸­å»æ›´æ–°ç›¸å…³<code>DOM</code>çš„<code>textContent</code>ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ReactDOMTextComponent</span> </span>&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  æ¥æ”¶åˆ°æ–°ç»„ä»¶</span></span><br><span class="line"><span class="comment">     *  @param   &#123;String&#125;  text  [æ¥æ”¶åˆ°çš„æ–°ç»„ä»¶]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    receiveComponent(text) &#123;</span><br><span class="line">        <span class="keyword">const</span> nextStringText = (<span class="string">""</span> + text);</span><br><span class="line">        <span class="keyword">if</span> (nextStringText !== <span class="keyword">this</span>._currentElement) &#123;</span><br><span class="line">            <span class="keyword">this</span>._currentElement = nextStringText;</span><br><span class="line">          <span class="comment">//æ›´æ–°ç›¸å…³DOMçš„textContent</span></span><br><span class="line">            $(<span class="string">`[data-reactid='<span class="subst">$&#123;<span class="keyword">this</span>._rootNodeID&#125;</span>']`</span>).textContent = nextStringText;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è‡ªå®šæ ‡ç­¾ç»„ä»¶ä¸­ï¼Œæˆ‘ä»¬éœ€è¦åšçš„äº‹æƒ…å¤§æ¦‚å¦‚ä¸‹</p><ul><li>å¦‚æœè°ƒç”¨æ—¶ä¼ å…¥äº†æ–°çš„<code>Vnode</code>å°±æŠŠå½“å‰çš„<code>_currentElement</code>æ”¹æˆæ–°ä¼ å…¥çš„<code>Vnode</code></li><li>åˆå¹¶æ–°è€<code>state</code></li><li>è°ƒç”¨ç»„ä»¶å®ä¾‹ä¸‹çš„<code>shouldComponentUpdate</code>æ ¹æ®è¿”å›çš„å¸ƒå°”å€¼å»åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°ç»„ä»¶</li><li>è°ƒç”¨ç»„ä»¶å®ä¾‹ä¸‹çš„<code>componentWillUpdate</code></li><li>è°ƒç”¨ç»„ä»¶çš„<code>render</code>å»æ‹¿åˆ°æ–°çš„<code>Vnode</code>ï¼Œå’Œä¹‹å‰çš„åšå¯¹æ¯”ï¼Œå¦‚æœä¹‹å‰çš„ç»„ä»¶<code>Vnode</code>ä¸å­˜åœ¨ï¼Œå°±ç›´æ¥è°ƒç”¨<code>instantiateReactComponent</code>è¿”å›æ–°çš„ç»„ä»¶å®ä¾‹</li><li>è°ƒç”¨ç»„ä»¶ç”Ÿå‘½å‘¨æœŸä¸‹çš„<code>componentDidUpdate</code>æ–¹æ³•</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ReactCompositeComponent</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  æ¥æ”¶åˆ°æ–°ç»„ä»¶, æ›´æ–°å®ä¾‹ä¸‹çš„state, ç»„ä»¶ç”Ÿå‘½å‘¨æœŸæ–¹æ³•è°ƒç”¨</span></span><br><span class="line"><span class="comment">     *  @param   &#123;ReactElement&#125;  nextElement  [æ–°çš„Vnode]</span></span><br><span class="line"><span class="comment">     *  @param   &#123;Object&#125;        newState     [this.setState(state)ä¸­çš„state]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    receiveComponent(nextElement, newState) &#123;</span><br><span class="line">        <span class="comment">//  å¦‚æœæ¥å—äº†æ–°çš„, å°±ä½¿ç”¨æœ€æ–°çš„element</span></span><br><span class="line">        <span class="keyword">this</span>._currentElement = nextElement || <span class="keyword">this</span>._currentElement;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> &#123; _rootNodeID &#125; = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> inst = <span class="keyword">this</span>._instance,</span><br><span class="line"></span><br><span class="line">            <span class="comment">//  nextStateå’ŒnextPropsçš„å¤„ç†</span></span><br><span class="line">            nextState = <span class="built_in">Object</span>.assign(inst.state || &#123;&#125;, newState),</span><br><span class="line">            nextProps = lodash.clone(<span class="keyword">this</span>._currentElement.props),</span><br><span class="line">            finalProps,</span><br><span class="line">            prevComponentInstance,</span><br><span class="line">            prevRenderedElement,</span><br><span class="line">            nextRenderedElement,</span><br><span class="line">            nextMarkup,</span><br><span class="line">            child;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//  ä¿®æ”¹ç»„ä»¶çš„stateå’Œprops</span></span><br><span class="line">        <span class="keyword">this</span>._instance.state = nextState;</span><br><span class="line">        <span class="keyword">this</span>._instance.props = nextProps;</span><br><span class="line">        inst.state = nextState;</span><br><span class="line">        inst.props = nextProps;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//  å£°æ˜å‘¨æœŸshouldComponentUpdate</span></span><br><span class="line">        <span class="keyword">if</span> (!inst.shouldComponentUpdate(nextProps, nextState)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//  å£°æ˜å‘¨æœŸcomponentWillUpdate</span></span><br><span class="line">        inst.componentWillUpdate(nextProps, nextState);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//  ä¹‹å‰çš„ç»„ä»¶ç»„ä»¶å®ä¾‹</span></span><br><span class="line">        prevComponentInstance = <span class="keyword">this</span>._renderedComponent;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//  ä¹‹å‰çš„ç»„ä»¶å…ƒç´ </span></span><br><span class="line">        prevRenderedElement = prevComponentInstance._currentElement;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//  å³å°†è¢«æ¸²æŸ“çš„æ–°ç»„ä»¶å…ƒç´ </span></span><br><span class="line">        nextRenderedElement = inst.render();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//  åˆ¤æ–­æ˜¯éœ€è¦æ›´æ–°è¿˜æ˜¯ç›´æ¥å°±é‡æ–°æ¸²æŸ“</span></span><br><span class="line">        <span class="keyword">if</span> (shouldUpdateReactComponent(prevRenderedElement, nextRenderedElement)) &#123;</span><br><span class="line">            prevComponentInstance.receiveComponent(nextRenderedElement);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//  é‡æ–°newä¸€ä¸ªå¯¹åº”çš„component</span></span><br><span class="line">            <span class="keyword">this</span>._renderedComponent = instantiateReactComponent(nextRenderedElement);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//  é‡æ–°ç”Ÿæˆå¯¹åº”çš„å…ƒç´ å†…å®¹</span></span><br><span class="line">            nextMarkup = <span class="keyword">this</span>._renderedComponent.mountComponent(_rootNodeID);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//  æ›¿æ¢æ•´ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">            $(<span class="string">`[data-reactid="<span class="subst">$&#123;_rootNodeID&#125;</span>"]`</span>).innerHTML = nextMarkup;</span><br><span class="line">        &#125;</span><br><span class="line">        inst.componentDidUpdate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ç»„ä»¶çš„<code>render</code>è¢«é‡æ–°è°ƒç”¨ä¹‹åï¼Œæœ€åè¿˜æ˜¯éœ€è¦è¦æ›´æ–°<code>DOM</code>çš„ï¼Œæ‰€ä»¥åœ¨<code>ReactDOMComponent</code>ä¸‹çš„<code>receiveComponent</code>é‡Œæˆ‘ä»¬éœ€è¦å¯¹ç»„ä»¶é‡Œçš„<code>DOM</code>ä¸‹çš„å±æ€§å’Œç»“æ„è¿›è¡Œæ›´æ–°ã€‚</p><p>åœ¨<code>React</code>ä¸­ï¼Œæœ‰ä¸€å¥—<code>diff</code>ç®—æ³•æ¥æ¯”è¾ƒæ–°è€ç»„ä»¶é—´çš„å·®å¼‚ï¼Œè¿”å›éœ€è¦æ›´æ–°çš„é˜Ÿåˆ—ï¼Œç„¶åç»Ÿä¸€å¯¹<code>DOM</code>ç»“æ„è¿›è¡Œæ›´æ–°ï¼Œåœ¨<code>ReactDOMComponent</code>ä¸‹çš„<code>receiveComponent</code>ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å®Œæˆä¸‹é¢çš„å‡ ä»¶äº‹æƒ…</p><ul><li>æ‹¿åˆ°è€çš„<code>props</code>å’Œæ–°çš„<code>props</code>åšï¼Œåœ¨<code>_updateDOMProperties</code>ä¸­å¯¹<code>DOM</code>ä¸‹çš„å±æ€§è¿›è¡Œæ›´æ–°</li><li>è°ƒç”¨<code>_updateDOMChildren</code>ï¼Œä¼ å…¥æ–°çš„ç»„ä»¶å­èŠ‚ç‚¹ï¼Œå»æ‹¼å‡‘å·®å¼‚é˜Ÿåˆ—ï¼Œç„¶åæ›´æ–°<code>DOM</code></li><li>ä¿®æ”¹<code>currentElement</code>å˜æˆæœ¬æ¬¡æ¸²æŸ“çš„ï¼Œä¾›ä¸‹æ¬¡ä½¿ç”¨</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ReactDOMComponent</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  æ¥æ”¶åˆ°æ–°ç»„ä»¶</span></span><br><span class="line"><span class="comment">     *  @param   &#123;Object&#125;  nextElement  [æ–°ç»„ä»¶]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    receiveComponent(nextElement) &#123;</span><br><span class="line">        <span class="keyword">const</span> lastProps = lodash.clone(<span class="keyword">this</span>._currentElement.props),</span><br><span class="line">            nextProps = nextElement.props;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//  éœ€è¦å•ç‹¬çš„æ›´æ–°å±æ€§</span></span><br><span class="line">        <span class="keyword">this</span>._updateDOMProperties(lastProps, nextProps);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//  å†æ›´æ–°å­èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">this</span>._updateDOMChildren(nextElement.props.children);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//  ä¿®æ”¹currentElementå˜æˆæœ¬æ¬¡æ¸²æŸ“çš„</span></span><br><span class="line">        <span class="keyword">this</span>._currentElement = nextElement;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  æ›´æ–°ç»„ä»¶ä¸­ç›¸å…³DOMçš„å±æ€§</span></span><br><span class="line"><span class="comment">     *  @param    &#123;Object&#125;  lastProps  [æ—§å±æ€§]</span></span><br><span class="line"><span class="comment">     *  @param    &#123;Object&#125;  nextProps  [æ–°å±æ€§]</span></span><br><span class="line"><span class="comment">     *  @private</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    _updateDOMProperties(lastProps, nextProps) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; _rootNodeID &#125; = <span class="keyword">this</span>,</span><br><span class="line">        element = $(<span class="string">`[data-reactid="<span class="subst">$&#123;_rootNodeID&#125;</span>"]`</span>);</span><br><span class="line">        <span class="keyword">let</span> propKey, propValue, eventType, removed;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (propKey <span class="keyword">in</span> lastProps) &#123;</span><br><span class="line">            <span class="comment">//  åªåˆ é™¤è€å±æ€§ä¸­æœ‰ä½†æ˜¯æ–°å±æ€§ä¸­æ²¡æœ‰çš„</span></span><br><span class="line">            <span class="keyword">if</span> (hasOwnProperty(lastProps, propKey) &amp;&amp; !hasOwnProperty(nextProps, propKey)) &#123;</span><br><span class="line">                propValue = lastProps[propKey];</span><br><span class="line"></span><br><span class="line">                <span class="comment">//  ä¹‹å‰çš„äº‹ä»¶ä»£ç†éœ€è¦è§£é™¤</span></span><br><span class="line">                <span class="keyword">if</span> (EVENT_REG.test(propKey)) &#123;</span><br><span class="line">                    eventType = propKey.replace(<span class="string">"on"</span>, <span class="string">""</span>);</span><br><span class="line">                    Event.undelegate(&#123;</span><br><span class="line">                        element: doc,</span><br><span class="line">                        type: eventType,</span><br><span class="line">                        selector: <span class="string">`[data-reactid="<span class="subst">$&#123;_rootNodeID&#125;</span>"]`</span></span><br><span class="line">                    &#125;);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === <span class="string">"className"</span>) &#123;</span><br><span class="line">                    removed = <span class="string">"class"</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    removed = propKey;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//  åˆ é™¤DOMä¸Šçš„ç›¸å…³å±æ€§</span></span><br><span class="line">                element.removeAttribute(removed);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//  å¼€å§‹éå†æ–°å±æ€§é›†åˆ</span></span><br><span class="line">        <span class="keyword">for</span> (propKey <span class="keyword">in</span> nextProps) &#123;</span><br><span class="line">            <span class="keyword">if</span> (hasOwnProperty(nextProps, propKey) &amp;&amp; propKey !== <span class="string">"children"</span>) &#123;</span><br><span class="line">                propValue = lastProps[propKey];</span><br><span class="line">              <span class="comment">//é‡æ–°ä»£ç†äº‹ä»¶</span></span><br><span class="line">                <span class="keyword">if</span> (EVENT_REG.test(propKey)) &#123;</span><br><span class="line">                    eventType = propKey.replace(<span class="string">"on"</span>, <span class="string">""</span>);</span><br><span class="line">                    Event.undelegate(&#123;</span><br><span class="line">                        element: doc,</span><br><span class="line">                        type: eventType,</span><br><span class="line">                        selector: <span class="string">`[data-reactid="<span class="subst">$&#123;_rootNodeID&#125;</span>"]`</span></span><br><span class="line">                    &#125;);</span><br><span class="line">                    Event.delegate(&#123;</span><br><span class="line">                        element: doc,</span><br><span class="line">                        type: eventType,</span><br><span class="line">                        selector: <span class="string">`[data-reactid="<span class="subst">$&#123;_rootNodeID&#125;</span>"]`</span>,</span><br><span class="line">                        handler: propValue,</span><br><span class="line">                        context: <span class="literal">null</span></span><br><span class="line">                    &#125;);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === <span class="string">"className"</span>) &#123;</span><br><span class="line">                    element.setAttribute(<span class="string">"class"</span>, propValue);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === <span class="string">"style"</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (lodash.isObject(propValue)) &#123;</span><br><span class="line">                        propValue = toStyle.string(propValue);</span><br><span class="line">                    &#125;</span><br><span class="line">                    element.setAttribute(propKey, propValue);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    element.setAttribute(propKey, propValue);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  æ›´æ–°å­å…ƒç´ </span></span><br><span class="line"><span class="comment">     *  @param    &#123;Array&#125;  nextChildrenElements  [è¢«æ›´æ–°çš„ç»„ä»¶é˜Ÿåˆ—]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    _updateDOMChildren(nextChildrenElements) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nextChildrenElements &amp;&amp; nextChildrenElements.length) &#123;</span><br><span class="line"></span><br><span class="line">            update.updateDepth++;</span><br><span class="line">            <span class="comment">//  é€’å½’æ‰¾å‡ºå·®åˆ«, ç»„è£…å·®å¼‚å¯¹è±¡</span></span><br><span class="line">            update.diff(update.diffQueue, nextChildrenElements, <span class="keyword">this</span>);</span><br><span class="line">            update.updateDepth--;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//  åº”ç”¨æ›´æ–°</span></span><br><span class="line">            <span class="keyword">if</span> (update.updateDepth === <span class="number">0</span>) &#123;</span><br><span class="line">                update.patch(update.diffQueue);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>_updateDOMChildren</code>ä¸­æˆ‘ä»¬è°ƒç”¨äº†<code>update.diff</code>å’Œ<code>update.patch</code>æ–¹æ³•ï¼Œä¸€ä¸ªå¯¹æ¯”ä¸€ä¸ªåº”ç”¨ï¼Œè¿™é‡Œæˆ‘æ˜¯æŠŠ<code>diff</code>å’Œ<code>patch</code>æ”¾åˆ°ä¸€ä¸ªå¯¹è±¡ä¸‹ä½œä¸ºä¸€ä¸ªæ¨¡å—æš´éœ²å‡ºå»çš„ï¼Œä¸‹é¢å°±æ˜¯å…·ä½“çš„å®ç°ä»£ç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å®šä¹‰æ›´æ–°ç±»å‹(ç§»åŠ¨å·²ç»å­˜åœ¨çš„ï¼Œåˆ é™¤èŠ‚ç‚¹ï¼Œæ’å…¥çš„æ–°æ ‡ç­¾)</span></span><br><span class="line"><span class="keyword">const</span> UPDATE_TYPES = &#123;</span><br><span class="line">    MOVE_EXISTING: <span class="number">1</span>,</span><br><span class="line">    REMOVE_NODE: <span class="number">2</span>,</span><br><span class="line">    INSERT_MARKUP: <span class="number">3</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> update = &#123;</span><br><span class="line">    <span class="comment">//  æ›´æ–°æ·±åº¦æ ‡è¯†</span></span><br><span class="line">    updateDepth: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  æ›´æ–°é˜Ÿåˆ—</span></span><br><span class="line">    diffQueue: [],</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  é€’å½’æ‰¾å‡ºå·®åˆ«, ç»„è£…å·®å¼‚å¯¹è±¡, æ·»åŠ åˆ°æ›´æ–°é˜Ÿåˆ—diffQueue</span></span><br><span class="line"><span class="comment">     *  @param   &#123;Array&#125;  diffQueue             [æ›´æ–°é˜Ÿåˆ—]</span></span><br><span class="line"><span class="comment">     *  @param   &#123;Array&#125;  nextChildrenElements  [æ–°çš„å­ç»„ä»¶é›†åˆ]</span></span><br><span class="line"><span class="comment">     *  @param   &#123;Object&#125; component             [è¢«diffçš„ç»„ä»¶]</span></span><br><span class="line"><span class="comment">     *  @return  &#123;Array&#125;                        [éœ€è¦æ›´æ–°çš„å†…å®¹]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    diff(diffQueue, nextChildrenElements, component) &#123;</span><br><span class="line">        <span class="comment">//  è·å–åˆ°å½“å‰ç»„ä»¶ä¸‹å·²ç»æ¸²æŸ“çš„ç»„ä»¶é›†åˆï¼ŒæŠŠcomponent._renderedChildrenæ‰å¹³æˆä¸€ä¸ªå¯¹è±¡ï¼Œå¦‚æœchildæœ‰keyï¼Œå°±æ‹¿keyä½œä¸ºå¯¹åº”çš„å±æ€§åï¼Œå¦åˆ™ç”¨ä¸‹æ ‡åšå±æ€§åï¼Œå…·ä½“å®ç°å¯ä»¥çœ‹ä¸‹é¢</span></span><br><span class="line">        <span class="keyword">const</span> prevChildren = flattenChildren(component._renderedChildren),</span><br><span class="line"></span><br><span class="line">            <span class="comment">//  ç”Ÿæˆæ–°çš„å­èŠ‚ç‚¹çš„componentå¯¹è±¡é›†åˆ(å¦‚æœæ˜¯ç»„ä»¶æœ‰æ›´æ–°, å°±å¤ç”¨åŸæ¥çš„, å¦‚æœæ˜¯æ–°å¢å°±æ˜¯æ–°çš„ç»„ä»¶å®ä¾‹)</span></span><br><span class="line">            nextChildren = generateComponentChildren(prevChildren, nextChildrenElements);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> lastIndex = <span class="number">0</span>,</span><br><span class="line">            nextIndex = <span class="number">0</span>,</span><br><span class="line">            prevChild = <span class="literal">null</span>,</span><br><span class="line">            nextChild = <span class="literal">null</span>,</span><br><span class="line">            name, props, propKey, eventType;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//  æšä¸¾nextChildren</span></span><br><span class="line">        <span class="keyword">for</span> (name <span class="keyword">in</span> nextChildren) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!hasOwnProperty(nextChildren, name)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            prevChild = prevChildren &amp;&amp; prevChildren[name];</span><br><span class="line">            nextChild = nextChildren[name];</span><br><span class="line"></span><br><span class="line">            <span class="comment">//  ä¸¤ä¸ªç›¸åŒè¯´æ˜æ˜¯ä½¿ç”¨çš„åŒä¸€ä¸ªcomponent,æ‰€ä»¥æˆ‘ä»¬éœ€è¦åšç§»åŠ¨çš„æ“ä½œ</span></span><br><span class="line">            <span class="keyword">if</span> (lodash.isEqual(prevChild, nextChild)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (prevChild._mountIndex &lt; lastIndex) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.diffQueue.push(&#123;</span><br><span class="line">                        parentId: component._rootNodeID,</span><br><span class="line">                        parentNode: $(<span class="string">`[data-reactid="<span class="subst">$&#123;component._rootNodeID&#125;</span>"]`</span>),</span><br><span class="line">                        type: UPDATE_TYPES.MOVE_EXISTING,</span><br><span class="line">                      <span class="comment">//ä»ç»„ä»¶åŸæ¥çš„mountIndex</span></span><br><span class="line">                        fromIndex: prevChild._mountIndex,</span><br><span class="line">                      <span class="comment">//åˆ°nextIndex</span></span><br><span class="line">                        toIndex: nextIndex</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">              </span><br><span class="line">              <span class="comment">//ç¼“å­˜ä¸Šæ¬¡éå†æ—¶æœ€å¤§çš„index</span></span><br><span class="line">                lastIndex = <span class="built_in">Math</span>.max(prevChild._mountIndex, lastIndex);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//  ä¹‹å‰å­˜åœ¨å­èŠ‚ç‚¹, éœ€è¦å…ˆå°†å­èŠ‚ç‚¹ç§»é™¤</span></span><br><span class="line">                <span class="keyword">if</span> (prevChild) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.diffQueue.push(&#123;</span><br><span class="line">                        parentId: component._rootNodeID,</span><br><span class="line">                        parentNode: $(<span class="string">`[data-reactid="<span class="subst">$&#123;component._rootNodeID&#125;</span>"]`</span>),</span><br><span class="line">                        type: UPDATE_TYPES.REMOVE_NODE,</span><br><span class="line">                        fromIndex: prevChild._mountIndex,</span><br><span class="line">                        toIndex: <span class="literal">null</span></span><br><span class="line">                    &#125;);</span><br><span class="line">                    lastIndex = <span class="built_in">Math</span>.max(prevChild._mountIndex, lastIndex);</span><br><span class="line"></span><br><span class="line">                    props = (prevChild._currentElement &amp;&amp; prevChild._currentElement.props) ? prevChild._currentElement.props : &#123;&#125;;</span><br><span class="line"></span><br><span class="line">                  <span class="comment">//å¯¹ç§»é™¤çš„å­èŠ‚ç‚¹éœ€è¦è¿›è¡Œäº‹ä»¶ä»£ç†çš„æ¥è§¦ï¼Œé˜²æ­¢é‡å¤</span></span><br><span class="line">                    <span class="keyword">for</span> (propKey <span class="keyword">in</span> props) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (hasOwnProperty(props, propKey) &amp;&amp; EVENT_REG.test(propKey)) &#123;</span><br><span class="line">                            eventType = propKey.replace(<span class="string">"on"</span>, <span class="string">""</span>);</span><br><span class="line">                            Event.undelegate(&#123;</span><br><span class="line">                                element: doc,</span><br><span class="line">                                type: eventType,</span><br><span class="line">                                selector: <span class="string">`[data-reactid="<span class="subst">$&#123;prevChild._rootNodeID&#125;</span>"]`</span></span><br><span class="line">                            &#125;);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//  æ–°å¢çš„èŠ‚ç‚¹, éœ€è¦pushåˆ°diffQueue</span></span><br><span class="line">                <span class="keyword">if</span> (nextChild) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.diffQueue.push(&#123;</span><br><span class="line">                        parentId: component._rootNodeID,</span><br><span class="line">                        parentNode: $(<span class="string">`[data-reactid="<span class="subst">$&#123;component._rootNodeID&#125;</span>"]`</span>),</span><br><span class="line">                        type: UPDATE_TYPES.INSERT_MARKUP,</span><br><span class="line">                        fromIndex: <span class="literal">null</span>,</span><br><span class="line">                        toIndex: nextIndex,</span><br><span class="line">                        markup: nextChild.mountComponent(<span class="string">`<span class="subst">$&#123;component._rootNodeID&#125;</span>.<span class="subst">$&#123;name&#125;</span>`</span>)</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//  æ›´æ–°_mountIndexå’ŒnextIndex</span></span><br><span class="line">            nextChild._mountIndex = nextIndex;</span><br><span class="line">            nextIndex++;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//  æŠŠnextChildrenå…‹éš†ä¸€ä»½ç»™_renderedChildren</span></span><br><span class="line">            component._renderedChildren = makeArray(nextChildren);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  åº”ç”¨æ›´æ–°, æ‰§è¡ŒDOMæ“ä½œ</span></span><br><span class="line"><span class="comment">     *  @param   &#123;Array&#125;  updates  [å·®å¼‚å¯¹è±¡é›†åˆ]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    patch(updates) &#123;</span><br><span class="line">        <span class="keyword">let</span> initialChildren = &#123;&#125;,</span><br><span class="line">            deleteChildren = [],</span><br><span class="line">            updatedIndex, updatedChild, parentID;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> update <span class="keyword">of</span> updates) &#123;</span><br><span class="line">            updatedIndex = update.fromIndex;</span><br><span class="line">            updatedChild = update.parentNode.children[updatedIndex];</span><br><span class="line">            parentID = update.parentID;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//  æŠŠæ‰€æœ‰éœ€è¦æ›´æ–°çš„èŠ‚ç‚¹éƒ½ä¿å­˜ä¸‹æ¥</span></span><br><span class="line">            initialChildren[parentID] = initialChildren[parentID] || [];</span><br><span class="line"></span><br><span class="line">            <span class="comment">//  ä½¿ç”¨parentIDä½œä¸ºç®€æ˜“å‘½åç©ºé—´</span></span><br><span class="line">            initialChildren[parentID][updatedIndex] = updatedChild;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//  æ‰€æœ‰éœ€è¦ä¿®æ”¹çš„èŠ‚ç‚¹å…ˆåˆ é™¤,å¯¹äºmoveçš„,åé¢å†é‡æ–°æ’å…¥åˆ°æ­£ç¡®çš„ä½ç½®å³å¯</span></span><br><span class="line">            <span class="keyword">if</span> (!lodash.isNull(updatedChild) &amp;&amp; !lodash.isUndefined(updatedChild)) &#123;</span><br><span class="line">                deleteChildren.push(updatedChild);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//  åˆ é™¤éœ€è¦åˆ é™¤çš„èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> child <span class="keyword">of</span> deleteChildren) &#123;</span><br><span class="line">            child.parentNode.removeChild(child);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> updateItem <span class="keyword">of</span> updates) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (updateItem.type) &#123;</span><br><span class="line">                <span class="comment">//  æ’å…¥æ–°å…ƒç´ </span></span><br><span class="line">                <span class="keyword">case</span> UPDATE_TYPES.INSERT_MARKUP:</span><br><span class="line">                    insertChildAt(updateItem.parentNode, updateItem.markup, updateItem.toIndex);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//  å…ƒç´ ä½ç½®å‘ç”Ÿæ”¹å˜    </span></span><br><span class="line">                <span class="keyword">case</span> UPDATE_TYPES.MOVE_EXISTING:</span><br><span class="line">                    insertChildAt(updateItem.parentNode, initialChildren[updateItem.parentID][updateItem.fromIndex], updateItem.toIndex);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//  ä¸Šé¢å·²ç»åˆ é™¤, æ‰€ä»¥ä¸éœ€è¦å¤„ç†</span></span><br><span class="line">                <span class="keyword">case</span> UPDATE_TYPES.REMOVE_NODE:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//  é‡ç½®ç›¸å…³å˜é‡</span></span><br><span class="line">        <span class="keyword">this</span>.reset();</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  é‡ç½®ç›¸å…³å˜é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    reset() &#123;</span><br><span class="line">        <span class="keyword">this</span>.updateDepth = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">this</span>.diffQueue = [];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨<code>diff</code>ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†ä¸¤ä¸ªæ–°æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯<code>flattenChildren</code>å’Œ<code>generateComponentChildren</code>ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹<code>flattenChildren</code>çš„å®ç°ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  æŠŠåŸæ¥æ˜¯æ•°ç»„çš„å­ç»„ä»¶é›†åˆè½¬æ¢æˆMapè¿”å›</span></span><br><span class="line"><span class="comment"> *  @param   &#123;Array&#125;  componentChildren     [å­ç»„ä»¶é›†åˆ]</span></span><br><span class="line"><span class="comment"> *  @return  &#123;Object&#125;                       [è¾“å‡ºçš„Map, æ¯ä¸ªå­ç»„ä»¶çš„keyæˆ–è€…ä¸€ä¸ªéšæœºæ•°åškey]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flattenChildren</span>(<span class="params">componentChildren</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> childrenMap = &#123;&#125;,</span><br><span class="line">        child, name, i, len;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>, len = componentChildren.length; i &lt; len; i++) &#123;</span><br><span class="line">        child = componentChildren[i];</span><br><span class="line">        name = child &amp;&amp; child._currentelement &amp;&amp; child._currentelement.key ? child._currentelement.key : i.toString(<span class="number">36</span>);</span><br><span class="line">        childrenMap[name] = child;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> childrenMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>generateComponentChildren</code>æˆ‘ä»¬å¤§æ¦‚éœ€è¦å®Œæˆä¸‹é¢å‡ ä»¶äº‹æƒ…ï¼š</p><ul><li>éå†æ‹¿åˆ°å³å°†æ¸²æŸ“çš„æ–°ç»„ä»¶<code>children</code>ï¼ˆåšå‚æ•° <code>nextChildrenElements</code>ä¼ å…¥ï¼‰å’Œè€èŠ‚ç‚¹è¿›è¡Œå¯¹æ¯”</li><li>å¦‚æœè€èŠ‚ç‚¹å­˜åœ¨ä¸”å’Œæ–°èŠ‚ç‚¹æœ‰å·®å¼‚ï¼Œå³è°ƒç”¨è€èŠ‚ç‚¹ä¸‹çš„<code>receiveComponent</code>å»æ›´æ–°</li><li>å¦åˆ™å¦‚æœè€èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œåˆ™é‡æ–°è°ƒç”¨<code>instantiateReactComponent</code>è¿”å›ä¸€ä¸ªç»„ä»¶å®ä¾‹</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  ç”Ÿæˆå­èŠ‚ç‚¹elementsçš„componenté›†åˆ</span></span><br><span class="line"><span class="comment"> *  @param   &#123;Object&#125;  prevChildren          [flattenChildrenè¿”å›çš„Map]</span></span><br><span class="line"><span class="comment"> *  @param   &#123;Array&#125;   nextChildrenElements  [å³å°†è¦æ¸²æŸ“çš„èŠ‚ç‚¹]</span></span><br><span class="line"><span class="comment"> *  @return  &#123;Object&#125;                        [å­èŠ‚ç‚¹elementsçš„componenté›†åˆ]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generateComponentChildren</span>(<span class="params">prevChildren, nextChildrenElements</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> nextChildren = &#123;&#125;,</span><br><span class="line">        index, len, name, prevChild, prevElement, nextElement, nextChildInstance, element;</span><br><span class="line">    nextChildrenElements = nextChildrenElements || [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (index = <span class="number">0</span>, len = nextChildrenElements.length; index &lt; len; index++) &#123;</span><br><span class="line">        element = nextChildrenElements[index];</span><br><span class="line">        name = (element &amp;&amp; element.key) ? element.key : index;</span><br><span class="line">        prevChild = prevChildren &amp;&amp; prevChildren[name];</span><br><span class="line">        prevElement = prevChild &amp;&amp; prevChild._currentElement;</span><br><span class="line">        nextElement = element;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//  ç»„ä»¶æœ‰æ›´æ–°, è°ƒç”¨å½“å‰ç»„ä»¶ä¸‹çš„reciveComponentå»æ›´æ–°ç»„ä»¶</span></span><br><span class="line">        <span class="keyword">if</span> (shouldUpdateReactComponent(prevElement, nextElement)) &#123;</span><br><span class="line">            prevChild.receiveComponent(nextElement);</span><br><span class="line">            nextChildren[name] = prevChild;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//  æ–°èŠ‚ç‚¹, å®ä¾‹åŒ–æ–°ç»„ä»¶</span></span><br><span class="line">            nextChildInstance = instantiateReactComponent(nextElement);</span><br><span class="line">            nextChildren[name] = nextChildInstance;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> nextChildren;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¹‹å‰å¥½å‡ ä¸ªåœ°æ–¹æˆ‘ä»¬éƒ½çœ‹åˆ°äº†<code>shouldUpdateReactComponent</code>è¿™ä¸ªæ–¹æ³•ï¼Œå®ƒå®Œæˆçš„åŠŸèƒ½ä¸»è¦æ˜¯åˆ¤æ–­ä¸¤ä¸ª<code>Vnode</code>ä¹‹å‰æ˜¯å¦æœ‰å·®å¼‚ï¼Œè¿”å›å¸ƒå°”å€¼ï¼Œä¸»è¦å®Œæˆä¸‹é¢å‡ ä»¶äº‹æƒ…ï¼š</p><ul><li>å¦‚æœæ–°è€<code>Vnode</code>æœ‰ä¸€ä¸ªæˆ–è€…éƒ½ä¸ºç©ºï¼Œç›´æ¥è¿”å›<code>false</code></li><li>æ–‡æœ¬èŠ‚ç‚¹ä¹‹é—´çš„å¯¹æ¯”</li><li>å½“æ–°çš„<code>Vnode</code>çš„<code>type</code>æ˜¯<code>object</code>ï¼Œæ¯”è¾ƒè€èŠ‚ç‚¹çš„<code>type</code>å’Œ<code>key</code>ï¼Œå¹¶ä¸”æ‹¿åˆ°ä¸¤è€…çš„<code>children</code>æ•°ç»„ï¼Œåšä¸€ä¸ªç®€å•çš„é•¿åº¦å¯¹æ¯”</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  åˆ¤æ–­ç»„ä»¶æ˜¯å¦éœ€è¦æ›´æ–°</span></span><br><span class="line"><span class="comment"> *  @param   &#123;Object&#125;  prevElement  [è€çš„vnode]</span></span><br><span class="line"><span class="comment"> *  @param   &#123;Object&#125;  nextElement  [æ–°çš„vnode]</span></span><br><span class="line"><span class="comment"> *  @return  &#123;Boolean&#125;              [æ ‡è¯†ç»„ä»¶æ˜¯å¦éœ€è¦æ›´æ–°]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">shouldUpdateReactComponent</span>(<span class="params">prevElement, nextElement</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//  æ’é™¤ä¸ºç©ºçš„æƒ…å†µ</span></span><br><span class="line">    <span class="keyword">if</span> (!lodash.isNull(prevElement) &amp;&amp; !lodash.isNull(nextElement) &amp;&amp; !lodash.isUndefined(prevElement) &amp;&amp; !lodash.isUndefined(nextElement)) &#123;</span><br><span class="line">        <span class="keyword">const</span> prevType = <span class="keyword">typeof</span> prevElement,</span><br><span class="line">            nextType = <span class="keyword">typeof</span> nextElement;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//  çº¯æ–‡æœ¬ç»„ä»¶</span></span><br><span class="line">        <span class="keyword">if</span> (prevType === <span class="string">"number"</span> || prevType === <span class="string">"string"</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> (nextType === <span class="string">"number"</span> || nextType === <span class="string">"number"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> prevChildren = [],</span><br><span class="line">                nextChildren = [],</span><br><span class="line">                childEqual = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(prevElement &amp;&amp; prevElement.props) &#123;</span><br><span class="line">                prevChildren = prevElement.props.children || [];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (nextElement &amp;&amp; nextElement.props) &#123;</span><br><span class="line">                nextChildren = nextElement.props.children || [];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            childEqual = prevChildren.length === nextChildren.length;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> (nextType === <span class="string">"object"</span> &amp;&amp;</span><br><span class="line">                (prevElement.type === nextElement.type) &amp;&amp;</span><br><span class="line">                (prevElement.key === nextElement.key) &amp;&amp;</span><br><span class="line">                childEqual);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œæˆ‘ä»¬å°±å®ç°ä¸€ä¸ª<code>setState</code>å’Œç”Ÿå‘½å‘¨æœŸï¼Œåœ¨ä¾‹å­ä¸­å®ç°äº†ä¸€ä¸ª<code>Todo</code>ï¼Œä¸€èµ·çœ‹ä¸‹æ•ˆæœ</p><p><img src="/imgs/todo.gif" alt="todo"></p><p>è‡³æ­¤æˆ‘ä»¬å°±å®ç°äº†ä¸€ä¸ªç®€å•çš„<code>React</code>ï¼Œä½†æ˜¯ä»…ä»…å®ç°äº†<code>è™šæ‹ŸèŠ‚ç‚¹</code>ï¼Œ<code>å·®å¼‚ç®—æ³•</code>ï¼Œ<code>propså•å‘æ•°æ®æµ</code>ï¼Œè¿˜æœ‰å¾ˆå¤šæ›´ä¼˜ç§€çš„æ²¡å®ç°ï¼Œæ¯”å¦‚æ‰¹é‡æ›´æ–°ï¼Œäº‹ä»¶ä¼˜åŒ–ï¼Œç»„ä»¶ä¸­çš„<code>refs</code>ï¼ŒæœåŠ¡ç«¯æ¸²æŸ“ç­‰ç­‰ï¼Œåªæ˜¯ä¸€ä¸ªç©å…·ï¼Œå¯¹äºæƒ³æ·±å…¥äº†è§£<code>React</code>åŸç†çš„å¯èƒ½ä¼šæœ‰äº›å¸®åŠ©ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨å‰é¢ä¸€ç¯‡ä¸­æˆ‘ä»¬ç”¨&lt;code&gt;instantiateReactComponent&lt;/code&gt;æ–¹æ³•æ¥æ ¹æ®&lt;code&gt;node&lt;/code&gt;çš„ä¸åŒæ¥è¿”å›ä¸åŒçš„ç»„ä»¶å®ä¾‹ï¼Œä¹‹å‰çš„åˆ†ç±»å¯èƒ½æœ‰äº›é—®é¢˜ï¼Œå°±æ˜¯å½“è¯¥ç»„ä»¶ä¸­&lt;code&gt;JSX&lt;/code&gt;éƒ¨åˆ†æœ‰è¿”å›&lt;code&gt;null&lt;/co
      
    
    </summary>
    
    
      <category term="javascript" scheme="http://yoursite.com/categories/javascript/"/>
    
      <category term="React" scheme="http://yoursite.com/categories/javascript/React/"/>
    
    
  </entry>
  
  <entry>
    <title>ä»é›¶å¼€å§‹å†™ä¸€ä¸ªReact - åˆå§‹åŒ–æ¸²æŸ“</title>
    <link href="http://yoursite.com/2017/09/04/2017-09-04-write-your-own-react-1/"/>
    <id>http://yoursite.com/2017/09/04/2017-09-04-write-your-own-react-1/</id>
    <published>2017-09-03T16:00:00.000Z</published>
    <updated>2017-09-07T04:26:08.000Z</updated>
    
    <content type="html"><![CDATA[<p>æˆ‘ä»¬çŸ¥é“<code>React</code>ç»„ä»¶è¿”å›çš„æ˜¯<code>JSX</code>ï¼Œè€Œ<code>JSX</code>å°†è¢«<code>babel</code>è½¬æ¢ï¼Œåœ¨<code>React</code>ä¸­æ˜¯å°†<code>JSX</code>ä¸­è½¬æ¢æˆ<code>React.createElement(type, config, children)</code>çš„å½¢å¼ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"app-container"</span>&gt;</span>App Component<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//babelè½¬æ¢åè¾“å‡ºçš„ä»£ç </span></span><br><span class="line"><span class="keyword">var</span> App = React.createClass(&#123;</span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> React.createElement(<span class="string">"div"</span>, &#123;</span><br><span class="line">          className: <span class="string">"app-container"</span></span><br><span class="line">        &#125;, <span class="string">"App Component"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥åœ¨<code>babel</code>ä¸­æŠŠ<code>JSX</code>çš„<code>pragma</code>è½¬æ¢æ”¹æˆè‡ªå·±çš„å‡½æ•°å:</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"presets"</span>: [</span><br><span class="line">    <span class="string">"es2015"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"plugins"</span>: [</span><br><span class="line">    [<span class="string">"transform-react-jsx"</span>, &#123;</span><br><span class="line">      "pragma":  "createElement"//é»˜è®¤çš„æ˜¯React.createElement, è¿™é‡Œæˆ‘ä»¬è¿˜æ˜¯ç”¨é»˜è®¤çš„</span><br><span class="line">    &#125;]</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢ä¸€èµ·çœ‹çœ‹<code>createElement</code>çš„å®ç°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> uselessProp = [<span class="string">"key"</span>, <span class="string">"ref"</span>, <span class="string">"__self"</span>, <span class="string">"__source"</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createElement</span>(<span class="params">type, config, ...children</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> props = &#123;&#125;,</span><br><span class="line">        key = <span class="literal">null</span>,</span><br><span class="line">        ref = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (config != <span class="literal">null</span>) &#123;</span><br><span class="line">        ref = lodash.isUndefined(config.ref) ? <span class="literal">null</span> : config.ref;</span><br><span class="line">        key = lodash.isUndefined(config.key) ? <span class="literal">null</span> : <span class="string">""</span> + config.key;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> propsName <span class="keyword">in</span> config) &#123;</span><br><span class="line">            <span class="keyword">if</span> (uselessProp.indexOf(propsName) === <span class="number">-1</span> &amp;&amp; hasOwnProperty(config, propsName)) &#123;</span><br><span class="line">                props[propsName] = config[propsName];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//  å­ç»„ä»¶</span></span><br><span class="line">        props.children = children;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ReactElement(type, key, props, ref);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ<code>createElement</code>å°±æ˜¯å¯¹å‚æ•°è¿›è¡Œå¤„ç†ï¼Œè¿”å›ä¸€ä¸ªReactElement(<code>virtual-dom</code>)ï¼Œ<code>ReactElement</code>è¿”å›ä¸€ä¸ª<code>vnode</code>æ¥è¡¨ç¤ºä¸€ä¸ªèŠ‚ç‚¹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReactElement</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(type, key, props, ref) &#123;</span><br><span class="line">        <span class="keyword">this</span>.type = type;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">        <span class="keyword">this</span>.props = props || &#123;&#125;;</span><br><span class="line">        <span class="keyword">this</span>.ref = ref || &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿”å›çš„<code>vnode</code>ä¸­ï¼Œ<code>type</code>ç”¨æ¥æ ‡è¯†ç»„ä»¶ç±»å‹ï¼Œ<code>props</code>å°±æ˜¯ç»„ä»¶ä¸­æ ‡ç­¾ä¸Šçš„<code>attributes</code>ï¼Œ<code>key</code>ç”¨ä½œè¿™ä¸ª<code>vnode</code>çš„å”¯ä¸€æ ‡è¯†ï¼Œå¯ç”¨äºåé¢çš„æ›´æ–°ï¼Œç°åœ¨æœ‰äº†<code>vnode</code>ï¼Œå°±éœ€è¦å°†<code>vnode</code>è½¬æ¢æˆçœŸå®çš„<code>DOM</code>æŒ‚è½½åˆ°é¡µé¢ä¸Šï¼Œåœ¨<code>React</code>å¯åŠ¨çš„æ—¶å€™ï¼Œæ˜¯é€šè¿‡<code>ReactDOM.render</code>æ¥è¿›è¡Œæ¸²æŸ“ç»„ä»¶åˆ°é¡µé¢ï¼Œæ¸²æŸ“å°±æ˜¯ä¸€ä¸ªé€’å½’è°ƒç”¨<code>render</code>çš„è¿‡ç¨‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">componnet, container, callback = noop</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> componentInstance = instantiateReactComponent(componnet),</span><br><span class="line">        markup = componentInstance.mountComponent(React.nextReactRootIndex ++);</span><br><span class="line">    container.innerHTML = markup;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lodash.isFunction(callback)) &#123;</span><br><span class="line">        callback.call(componentInstance);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>render</code>ä¸­æˆ‘ä»¬è°ƒç”¨äº†ä¸€ä¸ª<code>instantiateReactComponent</code>ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯æ ¹æ®<code>vnode</code>é‡Œé¢<code>type</code>çš„ä¸åŒæ¥è¿”å›ä¸åŒçš„ç»„ä»¶ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">instantiateReactComponent</span>(<span class="params">node</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//  æ–‡æœ¬èŠ‚ç‚¹çš„æƒ…å†µ</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> node === <span class="string">"string"</span> || <span class="keyword">typeof</span> node === <span class="string">"number"</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ReactDOMTextComponent(node);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  æµè§ˆå™¨é»˜è®¤èŠ‚ç‚¹çš„æƒ…å†µ</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> node === <span class="string">"object"</span> &amp;&amp; <span class="keyword">typeof</span> node.type === <span class="string">"string"</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ReactDOMComponent(node);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  è‡ªå®šä¹‰çš„å…ƒç´ èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> node === <span class="string">"object"</span> &amp;&amp; <span class="keyword">typeof</span> node.type === <span class="string">"function"</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ReactCompositeComponent(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œ<code>ReactDOMTextComponent</code>æ˜¯çº¯æ–‡æœ¬ç»„ä»¶ï¼Œ<code>ReactDOMComponent</code>æ˜¯æµè§ˆå™¨æ ‡ç­¾ç»„ä»¶ï¼Œ<code>ReactCompositeComponent</code>æ˜¯è‡ªå®šä¹‰çš„ç»„ä»¶ï¼Œåé¢çš„ä¸¤ç§ç»„ä»¶ç±»å‹éƒ½å±äº<code>virtual-dom</code>ã€‚</p><p>æˆ‘ä»¬æ¥ä¸‹æ¥çœ‹çœ‹ä¸Šé¢ä¸‰ä¸ªç»„ä»¶çš„å®ç°ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  æ–‡æœ¬ç»„ä»¶</span></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ReactDOMTextComponent</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(text) &#123;</span><br><span class="line">        <span class="comment">//  å­˜ä¸‹å½“å‰çš„å­—ç¬¦ä¸²</span></span><br><span class="line">        <span class="keyword">this</span>._currentElement =  (<span class="string">""</span> + text);</span><br><span class="line">        <span class="comment">//  ç»„ä»¶å”¯ä¸€id</span></span><br><span class="line">        <span class="keyword">this</span>._rootNodeID = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  componentæ¸²æŸ“æ—¶ç”Ÿæˆçš„domç»“æ„</span></span><br><span class="line"><span class="comment">     *  @param   &#123;String&#125;  rootID  [ç»„ä»¶å”¯ä¸€id]</span></span><br><span class="line"><span class="comment">     *  @return  &#123;String&#125;          [HTMLå­—ç¬¦ä¸²]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    mountComponent(rootID) &#123;</span><br><span class="line">        <span class="keyword">this</span>._rootNodeID = rootID;</span><br><span class="line"><span class="keyword">return</span> <span class="string">`&lt;!-- react-text: <span class="subst">$&#123;<span class="keyword">this</span>._rootNodeID&#125;</span> --&gt;<span class="subst">$&#123;<span class="keyword">this</span>._currentElement&#125;</span>&lt;!-- /react-text --&gt;`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æµè§ˆå™¨æ ‡ç­¾ç»„ä»¶</span></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ReactDOMComponent</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(element) &#123;</span><br><span class="line">        <span class="comment">//  å­˜ä¸‹å½“å‰å…ƒç´ å¼•ç”¨</span></span><br><span class="line">        <span class="keyword">this</span>._currentElement = element;</span><br><span class="line">        <span class="comment">//  ç»„ä»¶å”¯ä¸€id</span></span><br><span class="line">        <span class="keyword">this</span>._rootNodeID = <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">//  å­ç»„ä»¶é›†åˆ</span></span><br><span class="line">        <span class="keyword">this</span>._renderedChildren = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  componentæ¸²æŸ“æ—¶ç”Ÿæˆçš„domç»“æ„</span></span><br><span class="line"><span class="comment">     *  @param   &#123;String&#125;  rootID  [ç»„ä»¶å”¯ä¸€id]</span></span><br><span class="line"><span class="comment">     *  @return  &#123;String&#125;          [HTMLå­—ç¬¦ä¸²]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    mountComponent(rootID) &#123;</span><br><span class="line">        <span class="keyword">this</span>._rootNodeID = rootID;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> &#123; props, type &#125; = <span class="keyword">this</span>._currentElement,</span><br><span class="line">            &#123; children &#125; = props,</span><br><span class="line">            </span><br><span class="line"><span class="comment">//åˆ¤æ–­æ˜¯å¦ä¸ºå•æ ‡ç­¾</span></span><br><span class="line">            isSingleTag = SINGLE_TAG_REG.test(type);</span><br><span class="line">        <span class="keyword">let</span> tagOpen,</span><br><span class="line">            tagClose,</span><br><span class="line">            propKey, </span><br><span class="line">            propValue, </span><br><span class="line">            eventType,</span><br><span class="line">            childrenInstances, </span><br><span class="line">            childComponentInstance, </span><br><span class="line">            childrenMarkups, </span><br><span class="line">            curRootId;</span><br><span class="line"></span><br><span class="line">        tagOpen = [];</span><br><span class="line">        tagOpen.push(<span class="string">`&lt;<span class="subst">$&#123;type&#125;</span>`</span>, <span class="string">`data-reactid="<span class="subst">$&#123;<span class="keyword">this</span>._rootNodeID&#125;</span>"`</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (propKey <span class="keyword">in</span> props) &#123;</span><br><span class="line">          </span><br><span class="line">          <span class="comment">//è¿‡æ»¤æ‰propKeyä¸º"children"çš„æƒ…å†µ</span></span><br><span class="line">            <span class="keyword">if</span> (hasOwnProperty(props, propKey) &amp;&amp; propKey !== <span class="string">"children"</span>) &#123;</span><br><span class="line"></span><br><span class="line">                propValue = props[propKey];</span><br><span class="line">                <span class="keyword">if</span> (<span class="regexp">/^on[a-z]+/i</span>.test(propKey)) &#123;</span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                     *  handleClick() &#123;</span></span><br><span class="line"><span class="comment">                     *      alert("clicked");</span></span><br><span class="line"><span class="comment">                     *  &#125;</span></span><br><span class="line"><span class="comment">                     *  </span></span><br><span class="line"><span class="comment">                     *  render() &#123;</span></span><br><span class="line"><span class="comment">                     *      return (</span></span><br><span class="line"><span class="comment">                     *          &lt;div onClick=&#123;this.handleClick&#125;&gt;click me&lt;/div&gt;</span></span><br><span class="line"><span class="comment">                     *      );</span></span><br><span class="line"><span class="comment">                     *  &#125;</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                  </span><br><span class="line">                  <span class="comment">//å–å¾—äº‹ä»¶åç§°å¹¶è¿›è¡Œäº‹ä»¶ä»£ç†</span></span><br><span class="line">                    eventType = propKey.replace(<span class="string">"on"</span>, <span class="string">""</span>).toLowerCase();</span><br><span class="line">                    Event.delegate(&#123;</span><br><span class="line">                        element: doc,</span><br><span class="line">                        type: eventType,</span><br><span class="line">                        selector: <span class="string">`[data-reactid="<span class="subst">$&#123;<span class="keyword">this</span>._rootNodeID&#125;</span>"]`</span>,</span><br><span class="line">                        handler: propValue,</span><br><span class="line">                        context: <span class="literal">null</span></span><br><span class="line">                    &#125;);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//  <span class="doctag">TODO:</span> å®ç°å¯¹å½“å‰å…ƒç´ è¿›è¡Œäº‹ä»¶ä»£ç†</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === <span class="string">"style"</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                     *  render() &#123;</span></span><br><span class="line"><span class="comment">                     *      return (</span></span><br><span class="line"><span class="comment">                     *          &lt;div style=&#123;"background: red;"&#125;&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="comment">                     *      );</span></span><br><span class="line"><span class="comment">                     *  &#125;</span></span><br><span class="line"><span class="comment">                     *</span></span><br><span class="line"><span class="comment">                     *  -----------------------</span></span><br><span class="line"><span class="comment">                     *</span></span><br><span class="line"><span class="comment">                     *  render() &#123;</span></span><br><span class="line"><span class="comment">                     *      return (</span></span><br><span class="line"><span class="comment">                     *          &lt;div style=&#123;&#123;background: 'red'&#125;&#125;&gt;</span></span><br><span class="line"><span class="comment">                     *          &lt;/div&gt;</span></span><br><span class="line"><span class="comment">                     *      );</span></span><br><span class="line"><span class="comment">                     *  &#125;</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    <span class="keyword">if</span> (lodash.isObject(propValue)) &#123;</span><br><span class="line">                      </span><br><span class="line"><span class="comment">//è¿™é‡Œçš„toStyleç”¨äº†ä¸€ä¸ªnpmåŒ…(https://www.npmjs.com/package/to-style)</span></span><br><span class="line">                        propValue = toStyle.string(propValue);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    tagOpen.push(<span class="string">`style="<span class="subst">$&#123;propValue&#125;</span>"`</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propValue === <span class="string">"className"</span>) &#123;</span><br><span class="line">                    tagOpen.push(<span class="string">`class="<span class="subst">$&#123;propValue&#125;</span>"`</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    tagOpen.push(<span class="string">`<span class="subst">$&#123;propKey&#125;</span>="<span class="subst">$&#123;propValue&#125;</span>"`</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isSingleTag) &#123;</span><br><span class="line">            tagOpen.push(<span class="string">"/&gt;"</span>);</span><br><span class="line">            tagClose = <span class="string">""</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            tagOpen.push(<span class="string">"&gt;"</span>);</span><br><span class="line">            tagClose = <span class="string">`&lt;/<span class="subst">$&#123;type&#125;</span>&gt;`</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        childrenMarkups = [];</span><br><span class="line">        childrenInstances = [];</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//éå†å­èŠ‚ç‚¹ï¼Œå®ä¾‹åŒ–-&gt;æ¸²æŸ“å­èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (children &amp;&amp; children.length) &#123;</span><br><span class="line">            children.forEach(<span class="function">(<span class="params">child, key</span>) =&gt;</span> &#123;</span><br><span class="line">                childComponentInstance = instantiateReactComponent(child);</span><br><span class="line">                childrenInstances.push(childComponentInstance);</span><br><span class="line">                childComponentInstance._mountIndex = key;</span><br><span class="line">              </span><br><span class="line">              <span class="comment">//æ‹¼ä¸€ä¸ªç±»ä¼¼äº"x.y"çš„å­èŠ‚ç‚¹çš„nodeId</span></span><br><span class="line">                curRootId = <span class="string">`<span class="subst">$&#123;<span class="keyword">this</span>._rootNodeID&#125;</span>.<span class="subst">$&#123;key&#125;</span>`</span>;</span><br><span class="line">                childrenMarkups.push(childComponentInstance.mountComponent.call(childComponentInstance, curRootId));</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//å°†å­ç»„ä»¶çš„é›†åˆä¿ç•™èµ·æ¥ï¼Œç•™ä½œåé¢æ›´æ–°ä½¿ç”¨</span></span><br><span class="line">        <span class="keyword">this</span>._renderedChildren = childrenInstances;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//è¿”å›ç»„ä»¶çš„çœŸå®HTMLç»“æ„</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;tagOpen.join(<span class="string">" "</span>)&#125;</span> <span class="subst">$&#123;childrenMarkups.join(<span class="string">" "</span>)&#125;</span> <span class="subst">$&#123;tagClose&#125;</span>`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Reactè‡ªå®šä¹‰ç»„ä»¶</span></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ReactCompositeComponent</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(element) &#123;</span><br><span class="line">        <span class="comment">//  å­˜æ”¾å…ƒç´ elementå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">this</span>._currentElement = element;</span><br><span class="line">        <span class="comment">//  å­˜æ”¾å”¯ä¸€æ ‡è¯†</span></span><br><span class="line">        <span class="keyword">this</span>._rootNodeID = <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">//  å­˜æ”¾å¯¹åº”çš„ReactClassçš„å®ä¾‹</span></span><br><span class="line">        <span class="keyword">this</span>._instance = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mountComponent(rootID, hostContainerInfo, context) &#123;</span><br><span class="line">        <span class="keyword">this</span>._rootNodeID = rootID;</span><br><span class="line">        <span class="keyword">const</span> &#123; props, type &#125; = <span class="keyword">this</span>._currentElement,</span><br><span class="line">            ReactClass = type,</span><br><span class="line">            <span class="comment">//æ ¹æ®vnodeä¸­çš„typeæ¥å®ä¾‹åŒ–</span></span><br><span class="line">            <span class="comment">//åœ¨instantiateReactComponentä¸­å¯ä»¥çœ‹åˆ°,åªæœ‰å½“vnodeçš„typeæ˜¯ä¸€ä¸ªæ–¹æ³•ç±»å‹(ç»„ä»¶çš„constructor)æ—¶æ‰ä¼šè¿”å›ReactCompositeComponent</span></span><br><span class="line">            inst = <span class="keyword">new</span> ReactClass(props);</span><br><span class="line">        <span class="keyword">let</span> renderedElement, renderedComponentInstance, renderedMarkup;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//ä¿æŒå¯¹å½“å‰ç»„ä»¶å®ä¾‹çš„å¼•ç”¨</span></span><br><span class="line">        <span class="keyword">this</span>._instance = inst;</span><br><span class="line">        inst._reactInternalInstance = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//æ‰§è¡Œç”Ÿå‘½å‘¨æœŸä¸­çš„componentWillMount</span></span><br><span class="line">        <span class="keyword">if</span> (lodash.isFunction(inst.componentWillMount)) &#123;</span><br><span class="line">            inst.componentWillMount();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//è°ƒç”¨å½“å‰ç»„ä»¶çš„render</span></span><br><span class="line">        renderedElement = <span class="keyword">this</span>._instance.render();</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//æ ¹æ®renderä¸­è¿”å›çš„å†å»æ‰§è¡ŒinstantiateReactComponent</span></span><br><span class="line">        renderedComponentInstance = instantiateReactComponent(renderedElement);</span><br><span class="line">        <span class="keyword">this</span>._renderedComponent = renderedComponentInstance;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//æŒ‚è½½ç»„ä»¶</span></span><br><span class="line">        renderedMarkup = renderedComponentInstance.mountComponent(<span class="keyword">this</span>._rootNodeID);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (lodash.isFunction(inst.componentDidMount)) &#123;</span><br><span class="line">            inst.componentDidMount();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> renderedMarkup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receiveComponent(nextElement, newState) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢å°±æ˜¯æˆ‘ä»¬å¯¹ä¸‰ç§ç»„ä»¶çš„ä¸€ä¸ªå®ç°ï¼Œä¸‹é¢æˆ‘ä»¬ç”¨ä¸€ä¸ªå›¾ç®€å•è¡¨ç¤ºä¸‹å…·ä½“çš„æ¸²æŸ“è¿‡ç¨‹ï¼Œç¬¬ä¸€æ¬¡ç”»å›¾ï¼Œä¸è¶³ä¹‹å¤„å¤šå¤šåŒ…æ¶µã€‚</p><p><img src="/imgs/react-render.png" alt="æ¸²æŸ“é€»è¾‘"></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å†™ä¸€ä¸ª<code>Component</code>åŸºç±»ï¼Œå»ç»™æ‰€æœ‰çš„å­ç±»ç»§æ‰¿ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    setState(newState) &#123;</span><br><span class="line">        <span class="keyword">this</span>._reactInternalInstance.receiveComponent(<span class="literal">null</span>, newState);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  ç»„ä»¶å³å°†è¢«æŒ‚è½½åˆ°DOMä¸Š</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    componentWillMount() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  ç»„ä»¶å·²ç»è¢«æŒ‚è½½åˆ°DOMä¸Š</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    componentDidMount() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  ç»„ä»¶å³å°†æ”¶åˆ°æ–°çš„props</span></span><br><span class="line"><span class="comment">     *  @param   &#123;Object&#125;  nextProps  [æ–°çš„props]</span></span><br><span class="line"><span class="comment">     *  @param   &#123;Object&#125;  nextState  [æ–°çš„state]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    componentWillReceiveProps(nextProps, nextState) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  ç»„ä»¶æ˜¯å¦åº”è¯¥æ›´æ–°</span></span><br><span class="line"><span class="comment">     *  @param   &#123;Object&#125;  nextProps  [æ–°çš„props]</span></span><br><span class="line"><span class="comment">     *  @param   &#123;Object&#125;  nextState  [æ–°çš„state]</span></span><br><span class="line"><span class="comment">     *  @return  &#123;Boolean&#125;            [æ ‡è®°ç»„ä»¶æ˜¯å¦åº”è¯¥æ›´æ–°]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    shouldComponentUpdate(nextProps, nextState) &#123;</span><br><span class="line">        <span class="keyword">return</span> lodash.isEqual(<span class="keyword">this</span>.state, nextState) || lodash.isEqual(<span class="keyword">this</span>.props, nextProps);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  ç»„ä»¶å³å°†æ›´æ–°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    componentWillUpdate() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  ç»„ä»¶å·²ç»æ›´æ–°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    componentDidUpdate() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  ç»„ä»¶å³å°†è¢«å¸è½½</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    componentWillUnmount() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  è¿”å›ç»„ä»¶å†…éƒ¨çš„jsx</span></span><br><span class="line"><span class="comment">     *  @return  &#123;JSX&#125;  [ç»„ä»¶å¸ƒå±€]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    render() &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æˆ‘ä»¬ä¸€èµ·æ ¹æ®ä¸Šé¢çš„ä»£ç æ¥å®Œæˆä¸€ä¸ªåˆå§‹åŒ–æ¸²æŸ“çš„demoï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"./src/react"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InputComponnet</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    keyUpHandler(ev) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">&lt;input</span><br><span class="line">        type = <span class="string">"text"</span></span><br><span class="line">                ref=<span class="string">"textInput"</span></span><br><span class="line">        placeholder = &#123; <span class="string">"è¯·è¾“å…¥..."</span> &#125;</span><br><span class="line">        onKeyUp = &#123; <span class="keyword">this</span>.keyUpHandler.bind(<span class="keyword">this</span>) &#125;</span><br><span class="line">        style = &#123;&#123;</span><br><span class="line">                display: <span class="string">"block"</span>,</span><br><span class="line">                width: <span class="string">"200px"</span>,</span><br><span class="line">                height: <span class="string">"30px"</span>,</span><br><span class="line">                fontSize: <span class="string">"14px"</span>,</span><br><span class="line">                lineHeight: <span class="string">"30px"</span></span><br><span class="line">        &#125;&#125; /&gt;</span><br><span class="line">       );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> ( </span><br><span class="line">            &lt;div style = &#123; <span class="string">"background: red;"</span> &#125; &gt;</span><br><span class="line">        App Component &lt;InputComponnet placeholder = &#123; <span class="string">"è¯·è¾“å…¥..."</span> &#125;/&gt; </span><br><span class="line">         &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">        );</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">React.render( &lt; App /</span> &gt; , <span class="built_in">document</span>.querySelector(<span class="string">"#root"</span>));</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œæˆ‘ä»¬çš„åˆå§‹åŒ–æ¸²æŸ“å·²ç»å®Œæˆäº†ï¼Œæˆ‘ä»¬å®ç°äº†ç»„ä»¶ä¸­çš„äº‹ä»¶ç»‘å®šï¼ˆäº‹ä»¶ä»£ç†ï¼‰ï¼Œç®€å•çš„ç”Ÿå‘½å‘¨æœŸï¼ˆ<code>componentWillMout</code>ï¼Œ <code>componentDidMount</code>ï¼‰ï¼Œå°†<code>virtual-dom</code>è½¬æ¢æˆçœŸå®çš„<code>DOM</code>å¹¶ä¸”æŒ‚è½½åˆ°é¡µé¢çš„è¿‡ç¨‹ã€‚</p><p><a href="https://github.com/rwson/little-react" target="_blank" rel="noopener">è¿™é‡Œ</a>å¯ä»¥æŸ¥çœ‹ç›¸å¯¹å®Œæ•´çš„ä»£ç ã€‚</p><h4 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h4><ul><li><a href="http://www.ahonn.me/2017/06/08/write-a-react-from-scratch-init-render/" target="_blank" rel="noopener">ä»é›¶å¼€å§‹å†™ä¸€ä¸ª Reactï¼šåˆå§‹åŒ–æ¸²æŸ“</a></li><li><a href="https://segmentfault.com/a/1190000010822571" target="_blank" rel="noopener">ä»0å®ç°ä¸€ä¸ªtiny react</a></li><li><a href="http://purplebamboo.github.io/2015/09/15/reactjs_source_analyze_part_one/" target="_blank" rel="noopener">reactjsæºç åˆ†æ-ä¸Šç¯‡</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æˆ‘ä»¬çŸ¥é“&lt;code&gt;React&lt;/code&gt;ç»„ä»¶è¿”å›çš„æ˜¯&lt;code&gt;JSX&lt;/code&gt;ï¼Œè€Œ&lt;code&gt;JSX&lt;/code&gt;å°†è¢«&lt;code&gt;babel&lt;/code&gt;è½¬æ¢ï¼Œåœ¨&lt;code&gt;React&lt;/code&gt;ä¸­æ˜¯å°†&lt;code&gt;JSX&lt;/code&gt;ä¸­è½¬æ¢æˆ&lt;code&gt;Reac
      
    
    </summary>
    
    
      <category term="javascript" scheme="http://yoursite.com/categories/javascript/"/>
    
      <category term="React" scheme="http://yoursite.com/categories/javascript/React/"/>
    
    
  </entry>
  
  <entry>
    <title>å®ç°ä½ è‡ªå·±çš„Promise</title>
    <link href="http://yoursite.com/2017/08/04/2017-08-04-write-your-promise/"/>
    <id>http://yoursite.com/2017/08/04/2017-08-04-write-your-promise/</id>
    <published>2017-08-03T16:00:00.000Z</published>
    <updated>2017-09-04T08:08:49.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ç°ä»£åŒ–å‰ç«¯å¼€å‘ä¸­ï¼Œç»å¸¸ä¼šç”¨åˆ°<code>Promise</code>æ¨¡å¼ï¼Œ<code>Promise</code>æœ€å¤§çš„å¥½å¤„å°±æ˜¯å¯ä»¥ä½¿å¼‚æ­¥ä»£ç çœ‹èµ·æ¥å¦‚åŒæ­¥èˆ¬æ¸…æ–°æ˜“è¯»ï¼Œä»è€Œä»å›è°ƒåœ°ç‹±ä¸­è§£è„±å‡ºæ¥ï¼Œ<code>ES6</code>å·²ç»åŸç”Ÿæ”¯æŒ<code>Promise</code>å¯¹è±¡ï¼Œä½†åœ¨æœªæ”¯æŒçš„æµè§ˆå™¨ä¸­è¿˜éœ€è¦é€šè¿‡ polyfill æ¨¡æ‹Ÿå®ç°ã€‚ä¸‹é¢ä¸€èµ·å®ç°ä¸€ä¸ª<code>Promise</code>ã€‚</p><p>ä¸€èˆ¬æˆ‘ä»¬ç”¨<code>Promise</code>ä¼šå†™æˆç±»ä¼¼ä¸‹é¢çš„æ ·å­ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ins = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">ins.then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">//   ...</span></span><br><span class="line">&#125;, (ex) =&gt; &#123;&#125;);</span><br></pre></td></tr></table></figure><p>åœ¨<code>Promise</code>ä¸­ä¸€å…±å­˜åœ¨ä¸‰ç§çŠ¶æ€ï¼Œ<code>PENDING</code>, <code>FULFILLED</code>,<code>REJECTED</code>ï¼Œåœ¨å®ä¾‹åŒ–ä¸€ä¸ª<code>Promise</code>åï¼Œå®ƒçš„çŠ¶æ€ä¼šå˜æˆ<code>PENDING</code>ï¼Œæ‰§è¡Œ<code>resolve</code>æˆ–è€…<code>reject</code>æ–¹æ³•ä¼šæŠŠçŠ¶æ€æ”¹æˆ<code>FULFILLED</code>æˆ–è€…<code>REJECTED</code>ï¼Œæ­¤è¿‡ç¨‹ä¸å¯é€†ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ª<code>Promise</code>åªèƒ½è°ƒç”¨ä¸€æ¬¡<code>resolve</code>æˆ–è€…<code>reject</code>ã€‚</p><p>å…ˆæ¥æ­ä¸ªéª¨æ¶:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PENDING = <span class="string">"PENDING"</span>,</span><br><span class="line">    FULFILLED = <span class="string">"FULFILLED"</span>,</span><br><span class="line">    REJECTED = <span class="string">"REJECTED"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Promise</span>(<span class="params">resolver</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!isFunction(resolver)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">"TypeError: resolver must be a function"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å®ä¾‹çš„å€¼</span></span><br><span class="line">    <span class="keyword">this</span>.value = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å®ä¾‹çš„çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">this</span>.status = PENDING;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç¼“å­˜thenå’Œcatchä¸­ä¼ å…¥çš„æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">this</span>._doneCallbacks = [];</span><br><span class="line">    <span class="keyword">this</span>._failCallbacks = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åœ¨æ‰§è¡Œresolverå†…éƒ¨æŠ›å‡ºå¼‚å¸¸, try ... catch åŒ…è£¹</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        resolver(resolve.bind(<span class="keyword">this</span>), reject.bind(<span class="keyword">this</span>));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line">        reject.bind(<span class="keyword">this</span>)(ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span>.prototype = &#123;</span><br><span class="line">  <span class="keyword">constructor</span>: Promise,</span><br><span class="line">  </span><br><span class="line">  then: function(onFulfilled, onRejected) &#123;&#125;,</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">catch</span>: <span class="function"><span class="keyword">function</span>(<span class="params">onRejected</span>) </span>&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isFunction</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> obj === <span class="string">"function"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢å®ç°äº†ä¸€ä¸ª<code>Promise</code>æ„é€ å™¨å¹¶ä¸”åœ¨å®ƒåŸå‹ä¸Šå£°æ˜äº†<code>then</code>å’Œ<code>catch</code>ä¸¤ä¸ªç©ºæ–¹æ³•ï¼Œä¸‹é¢æˆ‘ä»¬ä¸€èµ·æ¥å®ç°ä¸€ä¸‹<code>then</code>å’Œ<code>catch</code>ä¸¤ä¸ªæ–¹æ³•, <code>Promise</code>ä¸­çš„<code>then</code>æ”¯æŒè°ƒç”¨ï¼Œæ‰€ä»¥<code>then</code>æ–¹æ³•éœ€è¦è¿”å›ä¸€ä¸ª<code>Promise</code>å®ä¾‹ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.prototype = &#123;</span><br><span class="line">  <span class="keyword">constructor</span>: Promise,</span><br><span class="line">  </span><br><span class="line">  //thenæ–¹æ³•æ¥å—onFulfilled, onRejectedä¸¤ä¸ªå›è°ƒ, å¹¶ä¸”è¿”å›ä¸€ä¸ªæ–°çš„Promiseå®ä¾‹</span><br><span class="line">  then: function(onFulfilled, onRejected) &#123;</span><br><span class="line">    <span class="comment">//è¦è¿”å›çš„æ–°Promise</span></span><br><span class="line">    <span class="keyword">let</span> ins = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125;);</span><br><span class="line"><span class="keyword">if</span> (isFunction(onFulfilled)) &#123;</span><br><span class="line">      <span class="comment">//å°†onFulfilledç¼“å­˜åˆ°_doneCallbacksä¸­</span></span><br><span class="line">      <span class="keyword">this</span>._doneCallbacks.push(makeCallback(ins, onFulfilled, <span class="string">"resolve"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isFunction(onRejected)) &#123;</span><br><span class="line">      <span class="keyword">this</span>._failCallbacks.push(makeCallback(ins, onFulfilled, <span class="string">"reject"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ins;</span><br><span class="line">  &#125;,</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">catch</span>: <span class="function"><span class="keyword">function</span>(<span class="params">onRejected</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.then(<span class="literal">null</span>, onRejected);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨å®ä¾‹åŒ–ä¸€ä¸ª<code>Promise</code>æ—¶ï¼Œæˆ‘ä»¬çš„<code>resolver</code>æœ‰<code>resolve</code>å’Œ<code>reject</code>ä¸¤ä¸ªå‚æ•°(ä¹Ÿå°±æ˜¯ä¸Šé¢æ„é€ å™¨ä¸­çš„æœ€å)ï¼Œåœ¨å®ä¾‹åŒ–å®Œæˆåå…¶ä¸­æœ‰ä¸€ä¸ªå°†è¢«ç«‹å³è°ƒç”¨ï¼Œç”¨äºç»“æŸå½“å‰<code>Promise</code>ã€‚ä¸‹é¢ä¸€èµ·å®ç°ä¸‹<code>resolve</code>å’Œ<code>reject</code>ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°å®Œæˆçš„åŠŸèƒ½å°±æ˜¯æ¥å—<code>resolver</code>ä¸­å¼‚æ­¥å¤„ç†è¿”å›çš„å€¼å¹¶ä¸”ä¼ é€’ç»™<code>then</code>æˆ–è€…<code>catch</code>ï¼Œå¹¶ä¸”å°†å½“å‰<code>PENDING</code>çš„çŠ¶æ€æ”¹æ‰ï¼Œåˆšæ‰ä¸Šé¢è¯´åˆ°<code>Promise</code>çš„çŠ¶æ€ä»<code>PENDING</code>åˆ°<code>FULFILLED</code>æˆ–è€…<code>REJECTED</code>æ˜¯ä¸€ä¸ªä¸å¯é€†çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥ä¸ºäº†ç¡®ä¿<code>resolve</code>æˆ–è€…<code>reject</code>ä¸è¢«å¤šæ¬¡è°ƒç”¨ï¼Œéœ€è¦åœ¨æ–¹æ³•å¼€å¤´æå‰åˆ¤æ–­ä¸‹<code>status</code>æ˜¯ä¸æ˜¯<code>PENDING</code>çŠ¶æ€ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolve</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.status !== PENDING) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">this</span>.value = data;</span><br><span class="line">  <span class="keyword">this</span>.status = FULFILLED;</span><br><span class="line">  run.call(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reject</span>(<span class="params">ex</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.status !== PENDING) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">this</span>.value = ex;</span><br><span class="line">  <span class="keyword">this</span>.status = REJECTED;</span><br><span class="line">  run.call(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>resolve</code>å’Œ<code>reject</code>ä¸­ï¼Œæˆ‘ä»¬éƒ½è°ƒç”¨äº†<code>run</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„ä½œç”¨æ˜¯ç”¨äºè§¦å‘æ¥ä¸‹æ¥çš„<code>Promise</code>çš„æ‰§è¡Œã€‚<code>run</code>å‡½æ•°ä¸­éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œéœ€è¦å¼‚æ­¥æ‰§è¡Œç›¸å…³çš„å›è°ƒå‡½æ•°ï¼Œä¸‹é¢ä¸€èµ·æ¥å®ç°ä¸€ä¸ª<code>run</code>æ–¹æ³•ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯æ¯ä¸ª<code>Promise</code>åªèƒ½è¢«æ‰§è¡Œä¸€æ¬¡ï¼Œæ‰€ä»¥åœ¨<code>run</code>æ–¹æ³•æœ€åï¼ŒæŠŠ<code>_doneCallbacks</code>å’Œ<code>_failCallbacks</code>ç½®ç©ºã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.status === PENDING) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//è·å–åˆ°å¼‚æ­¥å¤„ç†åçš„å€¼, æ ¹æ®å½“å‰çŠ¶æ€è·å–è¦æ‰§è¡Œçš„å›è°ƒ</span></span><br><span class="line">  <span class="keyword">const</span> &#123; value &#125; = <span class="keyword">this</span>,</span><br><span class="line">callbacks = <span class="keyword">this</span>.status === FULFILLED ? <span class="keyword">this</span>._doneCallbacks : <span class="keyword">this</span>._failCallbacksï¼›</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//Promiseå¼‚æ­¥æ‰§è¡Œ</span></span><br><span class="line">  <span class="keyword">let</span> timeout = setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> fn <span class="keyword">of</span> callbacks) &#123;</span><br><span class="line">  <span class="comment">//å€¼ç©¿é€åˆ°æ¯ä¸ªthenæˆ–è€…catch</span></span><br><span class="line">      fn(value);</span><br><span class="line">    &#125;</span><br><span class="line">    clearTimeout(timeout);</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">this</span>._doneCallbacks = [];</span><br><span class="line">  <span class="keyword">this</span>._failCallbacks = [];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢<code>run</code>é‡Œæ‰§è¡Œçš„æ¯ä¸ª<code>fn</code>éƒ½æ˜¯<code>then</code>æ–¹æ³•ä¸­<code>push</code>è¿›<code>_doneCallbacks</code>æˆ–<code>_failCallbacksçš„</code>makeCallback<code>è¿”å›å€¼ï¼Œ</code>makeCallback`æ˜¯æ•´ä¸ªä»£ç ä¸­æ¯”è¾ƒå¤æ‚çš„ä¸€éƒ¨åˆ†ï¼Œä¸‹é¢ä¸€èµ·çœ‹ä¸‹å…·ä½“å®ç°ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeCallback</span>(<span class="params">promise, callback, action</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">promiseCallback</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//callbackæ˜¯ä¸ªå‡½æ•°</span></span><br><span class="line">        <span class="keyword">if</span> (isFunction(callback)) &#123;</span><br><span class="line">        <span class="comment">//å®šä¹‰ä¸ªå˜é‡å»æ¥å—è¿”å›å€¼</span></span><br><span class="line">        <span class="comment">//é˜²æ­¢æŠ›å‡ºå¼‚å¸¸, try ... catch åŒ…è£¹, catch æ—¶ç›´æ¥è°ƒç”¨reject</span></span><br><span class="line">            <span class="keyword">let</span> x;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                x = callback(value);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line">                reject.bind(promise)(ex);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//callbackä¸­è¿”å›çš„æ˜¯this, ä¼šå¼•å‘æ­»å¾ªç¯</span></span><br><span class="line">            <span class="comment">//æŠ›å‡ºç±»å‹å¼‚å¸¸åˆ°reject</span></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * const ins = new Promise((resolve, reject) =&gt; &#123;&#125;);</span></span><br><span class="line"><span class="comment">             * ins.then(() =&gt; &#123;</span></span><br><span class="line"><span class="comment">             * return ins;</span></span><br><span class="line"><span class="comment">             * &#125;);</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (x === promise) &#123;</span><br><span class="line">                <span class="keyword">let</span> reason = <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">"TypeError: The return value could not be same with the promise"</span>);</span><br><span class="line">                reject.bind(promise)(reason);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (x <span class="keyword">instanceof</span> <span class="built_in">Promise</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//callbackä¸­è¿”å›ä¸€ä¸ªæ–°çš„Promise</span></span><br><span class="line">            <span class="comment">//æ‰§è¡Œè¯¥Promiseçš„thenå’Œcatch</span></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * const ins = new Promise((resolve, reject) =&gt; &#123;&#125;);</span></span><br><span class="line"><span class="comment">             * ins.then(() =&gt; &#123;</span></span><br><span class="line"><span class="comment">             * return new Promise((resolve, reject) =&gt; &#123;&#125;);</span></span><br><span class="line"><span class="comment">             * &#125;);</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">                x.then(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">                    resolve.bind(promise)(data);</span><br><span class="line">                &#125;, (ex) =&gt; &#123;</span><br><span class="line">                    reject.bind(promise)(ex);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> then;</span><br><span class="line">                (<span class="function"><span class="keyword">function</span> <span class="title">resolveThenable</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœè¿”å›çš„æ˜¯ä¸€ä¸ªThenableå¯¹è±¡(Promise)</span></span><br><span class="line">                    <span class="keyword">if</span> (x &amp;&amp; (<span class="keyword">typeof</span> x === <span class="string">"object"</span> || isFunction(x))) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            then = x.then;</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line">                            reject.bind(promise)(ex);</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (isFunction(then)) &#123;</span><br><span class="line">                            <span class="comment">// è°ƒç”¨Thenableå¯¹è±¡çš„thenæ–¹æ³•æ—¶,ä¼ é€’è¿›å»çš„resolvePromiseå’ŒrejectPromiseæ–¹æ³•ï¼ˆåŠä¸‹é¢çš„ä¸¤ä¸ªåŒ¿åæ–¹æ³•ï¼‰</span></span><br><span class="line">                            <span class="comment">// å¯èƒ½ä¼šè¢«é‡å¤è°ƒç”¨ã€‚ ä½†Promise+è§„èŒƒè§„å®šè¿™ä¸¤ä¸ªæ–¹æ³•æœ‰ä¸”åªèƒ½æœ‰å…¶ä¸­çš„ä¸€ä¸ªè¢«è°ƒç”¨ä¸€æ¬¡,å¤šæ¬¡è°ƒç”¨å°†è¢«å¿½ç•¥</span></span><br><span class="line">                            <span class="comment">// æ­¤å¤„é€šè¿‡invokedæ¥å¤„ç†é‡å¤è°ƒç”¨</span></span><br><span class="line">                            <span class="keyword">let</span> invoked = <span class="literal">false</span>;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                then.call( x, (y) =&gt; &#123;</span><br><span class="line">                                <span class="comment">//å¦‚æœå·²ç»è¢«è°ƒç”¨äº†ï¼Œç›´æ¥returnæ‰</span></span><br><span class="line">                                        <span class="keyword">if</span> (invoked) &#123;</span><br><span class="line">                                            <span class="keyword">return</span>;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                        invoked = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">                                        <span class="comment">// é¿å…æ­»å¾ªç¯</span></span><br><span class="line">                                        <span class="keyword">if</span> (y === x) &#123;</span><br><span class="line">                                            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">"TypeError: The return value could not be same with the previous thenable object"</span>);</span><br><span class="line">                                        &#125;</span><br><span class="line"></span><br><span class="line">                                        <span class="comment">// yä»æœ‰å¯èƒ½æ˜¯thenableå¯¹è±¡ï¼Œé€’å½’è°ƒç”¨</span></span><br><span class="line">                                        resolveThenable(y);</span><br><span class="line">                                    &#125;, (e) =&gt; &#123;</span><br><span class="line">                                        <span class="keyword">if</span> (invoked) &#123;</span><br><span class="line">                                            <span class="keyword">return</span>;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                        invoked = <span class="literal">true</span>;</span><br><span class="line">                                        reject.bind(promise)(e);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                );</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                                <span class="comment">// å¦‚æœresolvePromiseå’ŒrejectPromiseæ–¹æ³•è¢«è°ƒç”¨å,å†æŠ›å‡ºå¼‚å¸¸,åˆ™å¿½ç•¥å¼‚å¸¸</span></span><br><span class="line">                                <span class="comment">// å¦åˆ™ç”¨å¼‚å¸¸å¯¹è±¡rejectæ­¤Promiseå¯¹è±¡</span></span><br><span class="line">                                <span class="keyword">if</span> (!invoked) &#123;</span><br><span class="line">                                    reject.bind(promise)(e);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            resolve.bind(promise)(x);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        resolve.bind(promise)(x);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;(x));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//æ ¹æ®actionåˆ¤æ–­æ‰§è¡Œresolveæˆ–è€…reject</span></span><br><span class="line">        action === <span class="string">"resolve"</span> ? resolve.bind(promise)(value) : reject.bind(promise)(value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢å°±æ˜¯æˆ‘å¯¹äºä¸€ä¸ª<code>Promise</code>çš„å®ç°ï¼Œå®Œæ•´ä»£ç è¯·ç§»æ­¥æˆ‘çš„<a href="https://github.com/rwson/My-Promise" target="_blank" rel="noopener">GitHub</a></p><p>å‚è€ƒï¼š</p><ul><li><a href="http://www.ituring.com.cn/article/66566" target="_blank" rel="noopener">Promises/A+è§„èŒƒ</a></li><li><a href="http://bruce-xu.github.io/blogs/js/promise" target="_blank" rel="noopener">JS Promiseçš„å®ç°åŸç†</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨ç°ä»£åŒ–å‰ç«¯å¼€å‘ä¸­ï¼Œç»å¸¸ä¼šç”¨åˆ°&lt;code&gt;Promise&lt;/code&gt;æ¨¡å¼ï¼Œ&lt;code&gt;Promise&lt;/code&gt;æœ€å¤§çš„å¥½å¤„å°±æ˜¯å¯ä»¥ä½¿å¼‚æ­¥ä»£ç çœ‹èµ·æ¥å¦‚åŒæ­¥èˆ¬æ¸…æ–°æ˜“è¯»ï¼Œä»è€Œä»å›è°ƒåœ°ç‹±ä¸­è§£è„±å‡ºæ¥ï¼Œ&lt;code&gt;ES6&lt;/code&gt;å·²ç»åŸç”Ÿæ”¯æŒ&lt;code&gt;Promise&lt;/cod
      
    
    </summary>
    
    
      <category term="javascript" scheme="http://yoursite.com/categories/javascript/"/>
    
      <category term="Promise" scheme="http://yoursite.com/categories/javascript/Promise/"/>
    
    
  </entry>
  
  <entry>
    <title>ç¼–å†™ä½ è‡ªå·±çš„async.waterfall</title>
    <link href="http://yoursite.com/2017/05/14/2017-05-14-write-your-async.waterfall/"/>
    <id>http://yoursite.com/2017/05/14/2017-05-14-write-your-async.waterfall/</id>
    <published>2017-05-13T16:00:00.000Z</published>
    <updated>2017-06-14T08:43:06.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨æ—©æœŸçš„å¼‚æ­¥å¼€å‘ä¸­ï¼Œå¦‚æœæœ‰ä¸€äº›å¼‚æ­¥ä»»åŠ¡éœ€è¦å¤„ç†ï¼Œéš¾å…ä¼šé‡åˆ°å›è°ƒåœ°ç‹±ï¼Œä¸ºäº†è§£å†³è¿™ç§é—®é¢˜ï¼Œä¹Ÿå‡ºç°è¿‡å¾ˆå¤šç¬¬ä¸‰æ–¹åº“æ¥é¿å…ï¼Œå…¶ä¸­<a href="[https://caolan.github.io/async/]">async.js</a>å°±æ˜¯æ¯”è¾ƒæœ‰åçš„ä¸€ä¸ªï¼Œé‡Œé¢æœ‰ä¸ª<code>waterfall</code>æ–¹æ³•ï¼Œæœ¬æ–‡æˆ‘ä»¬ä¸€èµ·æ¥æ¨¡æ‹Ÿå®ç°ä¸€ä¸ªç±»ä¼¼çš„</p><p>å…ˆæ¥çœ‹ä¸‹è°ƒç”¨</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">waterfall([</span><br><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params">cb</span>) </span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">new</span> <span class="built_in">Date</span>);</span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">cb(<span class="literal">null</span>, <span class="number">123</span>);</span><br><span class="line">&#125;, <span class="number">2000</span>);</span><br><span class="line">&#125;,</span><br><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params">arg, cb</span>) </span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">new</span> <span class="built_in">Date</span>);</span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(arg);</span><br><span class="line">cb(<span class="literal">null</span>, <span class="number">123</span>, <span class="number">456</span>);</span><br><span class="line">&#125;, <span class="number">2000</span>);</span><br><span class="line">&#125;,</span><br><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params">arg1, arg2, cb</span>) </span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">new</span> <span class="built_in">Date</span>);</span><br><span class="line"><span class="built_in">console</span>.log(arg1, arg2);</span><br><span class="line">&#125;</span><br><span class="line">], <span class="function"><span class="keyword">function</span>(<span class="params">ex</span>) </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (ex) &#123;</span><br><span class="line"><span class="keyword">throw</span> ex;</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸‹å®ç°ä¸‹<code>waterfall</code>è¿™ä¸ªæ–¹æ³• : </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @param task ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment"> * @param callback æœ€åçš„å›è°ƒ</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">task = [], callback = noop</span>) </span>&#123;</span><br><span class="line">  <span class="comment">//ç±»å‹åˆ¤æ–­</span></span><br><span class="line">    <span class="keyword">if</span> (!(task <span class="keyword">instanceof</span> <span class="built_in">Array</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> callback(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"task should be an array!"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    (<span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">        <span class="comment">//  ç¬¬ä¸€ä¸ªå‚æ•°å¦‚æœä¸ä¸ºç©ºå°±ç›´æ¥æ‰§è¡Œcallback</span></span><br><span class="line">        <span class="keyword">if</span> (args[<span class="number">0</span>]) &#123;</span><br><span class="line">            <span class="keyword">return</span> callback(args[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (task.length) &#123;</span><br><span class="line">            <span class="comment">//  å–å¾—å½“å‰è¦æ‰§è¡Œçš„å‡½æ•°</span></span><br><span class="line">            <span class="keyword">let</span> fn = task.shift();</span><br><span class="line">          <span class="comment">//ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯errorç›¸å…³çš„,æ‰€ä»¥ä»ç¬¬äºŒä¸ªå¼€å§‹æˆªå–</span></span><br><span class="line">            fn.apply(<span class="literal">null</span>, [...args.slice(<span class="number">1</span>), onlyOnce(next)]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            callback.apply(<span class="literal">null</span>, args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åŒ…è£…ä¸€ä¸ªå‡½æ•°ç¡®ä¿å®ƒåªè¢«æ‰§è¡Œä¸€æ¬¡</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">onlyOnce</span>(<span class="params">cb</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> flag = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">            <span class="keyword">return</span> cb(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'cb already called'</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        cb.apply(<span class="literal">null</span>, args);</span><br><span class="line">        flag = <span class="literal">true</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">noop</span>(<span class="params"></span>) </span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢å°±æ˜¯å¯¹<code>waterfall</code>æ–¹æ³•çš„å®ç°ï¼Œåœ¨<a href="[https://caolan.github.io/async/]">async.js</a>è¿˜æœ‰å¾ˆå¤šå…¶ä»–å¾ˆæœ‰ç”¨çš„æ–¹æ³•ï¼Œåé¢æœ‰æœºä¼šç»§ç»­æ¨¡æ‹Ÿå®ç°ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨æ—©æœŸçš„å¼‚æ­¥å¼€å‘ä¸­ï¼Œå¦‚æœæœ‰ä¸€äº›å¼‚æ­¥ä»»åŠ¡éœ€è¦å¤„ç†ï¼Œéš¾å…ä¼šé‡åˆ°å›è°ƒåœ°ç‹±ï¼Œä¸ºäº†è§£å†³è¿™ç§é—®é¢˜ï¼Œä¹Ÿå‡ºç°è¿‡å¾ˆå¤šç¬¬ä¸‰æ–¹åº“æ¥é¿å…ï¼Œå…¶ä¸­&lt;a href=&quot;[https://caolan.github.io/async/]&quot;&gt;async.js&lt;/a&gt;å°±æ˜¯æ¯”è¾ƒæœ‰åçš„ä¸€ä¸ªï¼Œé‡Œé¢æœ‰ä¸ª&lt;code&gt;wa
      
    
    </summary>
    
    
      <category term="javascript" scheme="http://yoursite.com/categories/javascript/"/>
    
      <category term="å¼‚æ­¥æµæ§åˆ¶" scheme="http://yoursite.com/categories/javascript/%E5%BC%82%E6%AD%A5%E6%B5%81%E6%8E%A7%E5%88%B6/"/>
    
    
  </entry>
  
  <entry>
    <title>å®ç°ä¸€ä¸ªnewå‡½æ•°</title>
    <link href="http://yoursite.com/2017/04/20/2017-04-20-write-a-new-operator/"/>
    <id>http://yoursite.com/2017/04/20/2017-04-20-write-a-new-operator/</id>
    <published>2017-04-19T16:00:00.000Z</published>
    <updated>2017-11-09T09:02:38.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨æ—¥å¸¸javaScriptå¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¤šå¤šå°‘å°‘éƒ½ä¼šç”¨åˆ°<code>new</code>ï¼Œæœ€å¸¸è§çš„æ¯”å¦‚<code>new Date</code>ç­‰ç­‰ï¼Œåœ¨ä¸€äº›<code>js</code>é¢å‘å¯¹è±¡ä¸­ï¼Œç”¨åˆ°<code>new</code>çš„åœ°æ–¹æ›´å¤šäº†ï¼Œæ¯”å¦‚æˆ‘ä»¬é€šè¿‡<code>function</code>æ¥æ¨¡æ‹Ÿå£°æ˜ä¸€ä¸ªç±»ï¼Œéœ€è¦å®ä¾‹åŒ–çš„æ—¶å€™å°±éœ€è¦ç”¨<code>new xxx()</code>:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Class</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> inst = <span class="keyword">new</span> Class();</span><br></pre></td></tr></table></figure><p>åœ¨<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/new" target="_blank" rel="noopener">MDN</a>ä¸Šå¯¹åœ¨æ‰§è¡Œäº†<code>new</code>ä¹‹åçš„ä»‹ç»å¦‚ä¸‹:</p><ul><li>ä¸€ä¸ªæ–°å¯¹è±¡è¢«åˆ›å»ºã€‚å®ƒç»§æ‰¿è‡ª<code>*foo*.prototype</code></li><li>æ„é€ å‡½æ•° <code>*foo*</code> è¢«æ‰§è¡Œã€‚æ‰§è¡Œçš„æ—¶å€™ï¼Œç›¸åº”çš„ä¼ å‚ä¼šè¢«ä¼ å…¥ï¼ŒåŒæ—¶ä¸Šä¸‹æ–‡ä¼šè¢«æŒ‡å®šä¸ºè¿™ä¸ªæ–°å®ä¾‹ã€‚<code>new *foo*</code> ç­‰åŒäº <code>new *foo*()</code>, åªèƒ½ç”¨åœ¨ä¸ä¼ é€’ä»»ä½•å‚æ•°çš„æƒ…å†µã€‚</li><li>å¦‚æœæ„é€ å‡½æ•°è¿”å›äº†ä¸€ä¸ªâ€œå¯¹è±¡â€ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡ä¼šå–ä»£æ•´ä¸ª<code>new</code>å‡ºæ¥çš„ç»“æœã€‚å¦‚æœæ„é€ å‡½æ•°æ²¡æœ‰è¿”å›å¯¹è±¡ï¼Œé‚£ä¹ˆ<code>new</code>å‡ºæ¥çš„ç»“æœä¸ºæ­¥éª¤1åˆ›å»ºçš„å¯¹è±¡ã€‚(ä¸€èˆ¬æƒ…å†µä¸‹æ„é€ å‡½æ•°ä¸è¿”å›ä»»ä½•å€¼ï¼Œä¸è¿‡ç”¨æˆ·å¦‚æœæƒ³è¦†ç›–è¿™ä¸ªè¿”å›å€¼ï¼Œå¯ä»¥è‡ªå·±é€‰æ‹©è¿”å›ä¸€ä¸ªæ™®é€šå¯¹è±¡æ¥è¦†ç›–ã€‚å½“ç„¶ï¼Œè¿”å›æ•°ç»„ä¹Ÿä¼šè¦†ç›–ï¼Œå› ä¸ºæ•°ç»„ä¹Ÿæ˜¯å¯¹è±¡ã€‚)</li></ul><p>åœ¨çŸ¥é“äº†<code>new</code>ä¹‹åå‘ç”Ÿçš„äº‹æƒ…ï¼Œæˆ‘ä»¬çš„<code>_new</code>å‡½æ•°å°±å¯ä»¥æŒ‰ç…§ä¸Šé¢çš„å‡ ä¸ªæ­¥éª¤æ¥ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_new</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">//è·å–åˆ°æ‰€æœ‰å‚æ•°</span></span><br><span class="line"><span class="keyword">var</span> args = [].slice.call(<span class="built_in">arguments</span>),</span><br><span class="line">        <span class="comment">//åˆ›å»ºä¸€ä¸ªç©ºå¯¹è±¡</span></span><br><span class="line">obj = <span class="built_in">Object</span>.create(&#123;&#125;),</span><br><span class="line">        <span class="comment">//æŠŠç¬¬ä¸€ä¸ªå‚æ•°ä½œä¸ºæ„é€ å™¨</span></span><br><span class="line">Constructor = args[<span class="number">0</span>],</span><br><span class="line">res;</span><br><span class="line">  <span class="comment">//ç»§æ‰¿æ„é€ å™¨ä¸‹çš„åŸå‹</span></span><br><span class="line">obj.__proto__ = args[<span class="number">0</span>].prototype;</span><br><span class="line">  <span class="comment">//æ‰§è¡Œæ„é€ å™¨ï¼Œå¹¶ä¼ å…¥ç›¸å…³å‚æ•°</span></span><br><span class="line">res = Constructor.apply(obj, args.slice(<span class="number">1</span>));</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯ç¬¬ä¸€ç‰ˆï¼Œæˆ‘ä»¬æŠŠæ„é€ å™¨çš„æ‰§è¡Œç»“æœä½œä¸ºè¿”å›å€¼è¿”å›å‡ºå»ï¼Œä¸‹é¢æˆ‘ä»¬ä¸€èµ·å†™ä¸ªæ¨¡æ‹Ÿç±»æµ‹è¯•ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Class</span>(<span class="params">name, age</span>) </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.name = name;</span><br><span class="line"><span class="keyword">this</span>.age = age;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Class.prototype = &#123;</span><br><span class="line"><span class="keyword">constructor</span>: Class,</span><br><span class="line">method: function () &#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"I'm method under Class.prototype"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> inst = _new(Class, <span class="string">"rwson"</span>, <span class="number">24</span>);</span><br><span class="line">inst.method();</span><br><span class="line"><span class="built_in">console</span>.log(inst);</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨æ§åˆ¶å°æ‰“å‡ºçš„ç±»ä¼¼ä¸‹å›¾çš„ä¸œè¥¿</p><p><img src="/imgs/new-1.png" alt="new-1"></p><p>æˆ‘ä»¬ç°åœ¨å®ç°äº†ä¸€ä¸ªç‰ˆæœ¬ï¼Œåªæ˜¯æŠŠåœ¨<code>_new</code>æ–¹æ³•ä¸­çš„<code>obj</code>å¯¹è±¡è¿”å›å‡ºæ¥äº†ï¼Œåˆšæ‰ä¸Šé¢ç¬¬ä¸‰æ­¥éª¤è¯´åˆ°ï¼Œ<code>å¦‚æœæ„é€ å‡½æ•°è¿”å›äº†ä¸€ä¸ªâ€œå¯¹è±¡â€ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡ä¼šå–ä»£æ•´ä¸ª</code>new<code>å‡ºæ¥çš„ç»“æœã€‚å¦‚æœæ„é€ å‡½æ•°æ²¡æœ‰è¿”å›å¯¹è±¡ï¼Œé‚£ä¹ˆ</code>new<code>å‡ºæ¥çš„ç»“æœä¸ºæ­¥éª¤1åˆ›å»ºçš„å¯¹è±¡ã€‚(ä¸€èˆ¬æƒ…å†µä¸‹æ„é€ å‡½æ•°ä¸è¿”å›ä»»ä½•å€¼ï¼Œä¸è¿‡ç”¨æˆ·å¦‚æœæƒ³è¦†ç›–è¿™ä¸ªè¿”å›å€¼ï¼Œå¯ä»¥è‡ªå·±é€‰æ‹©è¿”å›ä¸€ä¸ªæ™®é€šå¯¹è±¡æ¥è¦†ç›–ã€‚å½“ç„¶ï¼Œè¿”å›æ•°ç»„ä¹Ÿä¼šè¦†ç›–ï¼Œå› ä¸ºæ•°ç»„ä¹Ÿæ˜¯å¯¹è±¡ã€‚)</code>ï¼Œé’ˆå¯¹æ„é€ å‡½æ•°æœ‰è¿”å›å€¼çš„æƒ…å†µï¼Œæˆ‘ä»¬éœ€è¦æŠŠè¯¥è¿”å›å€¼è¿”å›ï¼Œä¸‹é¢æˆ‘ä»¬æŠŠä¹‹å‰çš„ä»£ç æ”¹æ”¹ï¼Œä»¥é€‚é…æœ‰è¿”å›å€¼çš„æƒ…å†µï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_new</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">var</span> args = [].slice.call(<span class="built_in">arguments</span>),</span><br><span class="line">obj = <span class="built_in">Object</span>.create(&#123;&#125;),</span><br><span class="line">Constructor = args[<span class="number">0</span>],</span><br><span class="line">res;</span><br><span class="line">obj.__proto__ = args[<span class="number">0</span>].prototype;</span><br><span class="line">res = Constructor.apply(obj, args.slice(<span class="number">1</span>));</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//åˆ¤æ–­Constructorçš„è¿”å›å€¼ç±»å‹</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">typeof</span> res === <span class="string">"object"</span> ? res : obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ ·æˆ‘ä»¬å†™ä¸ªç±»åšæµ‹è¯•</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Class</span>(<span class="params">name, age</span>) </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.name = name;</span><br><span class="line"><span class="keyword">this</span>.age = age;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">       name: name,</span><br><span class="line">       age: age</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> inst = _new(Class, <span class="string">"rwson"</span>, <span class="number">24</span>);</span><br><span class="line"><span class="built_in">console</span>.log(inst);</span><br></pre></td></tr></table></figure><p>è§‚å¯Ÿåœ¨æ§åˆ¶å°çš„è¾“å‡ºåº”è¯¥å’Œä¸‹é¢çš„ç±»ä¼¼ï¼š</p><p><img src="/imgs/new-2.png" alt="new-2"></p><p>åˆ°è¿™é‡Œæˆ‘ä»¬çš„<code>_new</code>æ–¹æ³•å°±å®ç°äº†ï¼Œä½†æ˜¯ç”±äº<code>Object.create</code>çš„åŸå› ï¼Œåœ¨<code>IE9-</code>çš„ç‰ˆæœ¬ä¸­å¯èƒ½ä¸å¤ªæ”¯æŒï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æŠŠ<code>Object.create</code>æ”¹æˆ<code>new Object</code>æˆ–è€…å¯¹è±¡å­—é¢é‡çš„å½¢å¼</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_new</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">var</span> args = [].slice.call(<span class="built_in">arguments</span>),</span><br><span class="line">obj = &#123;&#125;,</span><br><span class="line">Constructor = args[<span class="number">0</span>],</span><br><span class="line">res;</span><br><span class="line">obj.__proto__ = args[<span class="number">0</span>].prototype;</span><br><span class="line">res = Constructor.apply(obj, args.slice(<span class="number">1</span>));</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//åˆ¤æ–­Constructorçš„è¿”å›å€¼ç±»å‹</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">typeof</span> res === <span class="string">"object"</span> ? res : obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨æ—¥å¸¸javaScriptå¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¤šå¤šå°‘å°‘éƒ½ä¼šç”¨åˆ°&lt;code&gt;new&lt;/code&gt;ï¼Œæœ€å¸¸è§çš„æ¯”å¦‚&lt;code&gt;new Date&lt;/code&gt;ç­‰ç­‰ï¼Œåœ¨ä¸€äº›&lt;code&gt;js&lt;/code&gt;é¢å‘å¯¹è±¡ä¸­ï¼Œç”¨åˆ°&lt;code&gt;new&lt;/code&gt;çš„åœ°æ–¹æ›´å¤šäº†ï¼Œæ¯”å¦‚æˆ‘ä»¬é€šè¿‡&lt;code&gt;fu
      
    
    </summary>
    
    
      <category term="javascript" scheme="http://yoursite.com/categories/javascript/"/>
    
      <category term="newæ“ä½œç¬¦" scheme="http://yoursite.com/categories/javascript/new%E6%93%8D%E4%BD%9C%E7%AC%A6/"/>
    
    
  </entry>
  
  <entry>
    <title>NodeJsè¯»å–windowsæ³¨å†Œè¡¨æ¥å¯¹è½¯ä»¶è¿›è¡Œå¸è½½</title>
    <link href="http://yoursite.com/2017/03/29/2017-03-29-node-read-regedit-uninstall-software/"/>
    <id>http://yoursite.com/2017/03/29/2017-03-29-node-read-regedit-uninstall-software/</id>
    <published>2017-03-28T16:00:00.000Z</published>
    <updated>2017-03-30T13:28:52.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘åœ¨åŸºäºnode-webkit(ä»¥ä¸‹ç®€ç§°NW)å¼€å‘windowsæ¡Œé¢app,é‡Œé¢æœ‰ä¸ªç±»ä¼¼äºè½¯ä»¶å¸‚åœºçš„åŠŸèƒ½,åå°ç®¡ç†å‘˜æä¾›ä¸€äº›è½¯ä»¶,å¯ä»¥ä»è¯¥appä¸Šè¿›è¡Œä¸‹è½½ã€å®‰è£…ã€å¸è½½ã€å‡çº§ç­‰ç­‰ã€‚</p><p>å®‰è£…æˆ–å‡çº§å¯ä»¥ç›´æ¥é€šè¿‡æŠŠä¸‹è½½å¥½çš„zipåŒ…è§£å‹å‡ºæ¥ç„¶åæ‰§è¡Œé‡Œé¢çš„exeç¨‹åºå®‰è£…å°±å¥½,ä½†æ˜¯å¸è½½ç›¸å¯¹æ¥è¯´æ¯”è¾ƒéº»çƒ¦,å‡ ä¹æ¯ä¸ªç¬¬ä¸‰æ–¹exeåœ¨å®‰è£…åçš„ç›®å½•é‡Œé¢éƒ½æœ‰ä¸€ä¸ªuninstall.exe,ä½†æ˜¯æˆ‘ä»¬ä¸çŸ¥é“è¿™ä¸ªè½¯ä»¶å…·ä½“å®‰è£…åœ¨å“ª,æ‰€ä»¥è¦å¸è½½ä¹Ÿæ— ä»ä¸‹æ‰‹,è¿™æ—¶å€™å°±æƒ³åˆ°äº†æ³¨å†Œè¡¨,é€šè¿‡æ³¨å†Œè¡¨å¯ä»¥è·å–åˆ°æŸä¸ªè½¯ä»¶çš„å®‰è£…ç›®å½•,æ‰€ä»¥å¯ä»¥å…ˆæŠŠå½“å‰æ³¨å†Œè¡¨çš„ç›®å½•å–å¾—,å†å»ç›¸åº”ç›®å½•ä¸‹æ‰¾å¸è½½è¯¥è½¯ä»¶çš„é‚£ä¸ªexeå¹¶æ‰§è¡Œã€‚</p><p>ç”±äºNWæ˜¯åŸºäºnodejsçš„,æ‰€ä»¥å¯ä»¥é€šè¿‡ä¸€äº›ç¬¬ä¸‰æ–¹çš„npmåŒ…æ¥æ“ä½œ,åœ¨è¿™é‡Œä¸»è¦ä¸»è¦ç”¨åˆ°çš„åŒ…æ˜¯<a href="https://github.com/fresc81/node-winreg" target="_blank" rel="noopener">winreg</a>,é¦–å…ˆæˆ‘ä»¬å…ˆåˆ†æä¸‹æ³¨å†Œè¡¨:</p><p><img src="/imgs/regedit-nalysis.png" alt="æ³¨å†Œè¡¨åˆ†æ"></p><p>å¯ä»¥çœ‹åˆ°æ ¹ä¸‹é¢æœ‰5ä¸ªå¤§é¡¹(HKEY_CLASSES_ROOTã€HKEY_CURRENT_USERã€HKEY_LOCAL_MACHINEã€HKEY_USERSã€HKEY_CURRENT_CONFIG),ç¬¬ä¸‰æ–¹è½¯ä»¶åŸºæœ¬ä¸Šéƒ½æ˜¯åœ¨HKEY_LOCAL_MACHINEä¸‹é¢çš„,æ‰€ä»¥è¯»å–çš„æ—¶å€™å°±ä»HKEY_LOCAL_MACHINEä¸‹é¢å¼€å§‹æ‰¾,è¿™é‡Œä»¥æœç‹—è¾“å…¥æ³•ä¸ºä¾‹:</p><p><img src="/imgs/sogouinput.png" alt="æœç‹—è¾“å…¥æ³•åˆ†æ"></p><p>ä»ä¸Šå›¾ä¸­çœ‹åˆ°è¯¥é¡¹çš„å…¨è·¯å¾„ä¸ºâ€HKEY_LOCAL_MACHINE\SOFTWARE\SogouInputâ€,æ³¨å†Œé¡¹é‡Œçš„ç¬¬ä¸€é¡¹å°±æ˜¯å®‰è£…è·¯å¾„,å¯¹åº”çš„åç§°æ˜¯é»˜è®¤,æ‰€ä»¥æˆ‘ä»¬è¯»å–çš„æ—¶å€™ä»å°±å¯ä»¥è¯»å–åˆšæ‰çš„é‚£ä¸ªè·¯å¾„,ä¸‹é¢æ˜¯ä¸»è¦çš„å®ç°:</p><pre><code>const Registry = require(&quot;winreg&quot;),    child_process = require(&quot;child_process&quot;),    path = require(&quot;path&quot;),    key = new Registry({        //  æ‰“å¼€HKEY_LOCAL_MACHINEè¿™ä¸ªå¤§ç±»        //  ä¸€å…±æœ‰5ä¸ªå±æ€§,åˆ†åˆ«æ˜¯&apos;HKLM&apos;, &apos;HKCU&apos;, &apos;HKCR&apos;, &apos;HKU&apos;, &apos;HKCC&apos;        //  å°±æ˜¯ä¸Šé¢é‚£5å¤§é¡¹çš„ç®€ç§°        hive: Registry.HKLM,        //  åæ–œæ å‰é¢éœ€è¦åŠ &quot;\&quot;è¿›è¡Œè½¬ä¹‰        key: &quot;\\SOFTWARE\\SogouInput&quot;    });let pre, end, cur, target;//  è·å–åˆ°æ³¨å†Œé¡¹ä¸­ä¸­æ‰€æœ‰é…ç½®é¡¹,ä»¥é”®å€¼å¯¹çš„å½¢å¼è¿”å›//  æ¯ä¸€å°é¡¹åˆ†åˆ«åŒ…å«(hostã€hiveã€keyã€nameã€typeã€valueã€arch)è¿™å‡ ä¸ªå±æ€§key.values((err, res) =&gt; {    if (err) {        console.log(err);    } else {        for(var i in res) {            cur = res[i];            //  åˆ¤æ–­å½“å‰é¡¹çš„åç§°æ˜¯å¦åŒ…å«defaultæˆ–è€…version            if (/default/gi.test(cur.name)) {                pre = cur.value;            } else if (/^version$/gi.test(cur.name)) {                end = cur.value;            }        }        //  æ‹¼æ¥è½¯ä»¶çš„å®‰è£…å…¨è·¯å¾„        target = `${pre}\\${end}`;        //  ç»“åˆnodejsä¸­å­è¿›ç¨‹æ¨¡å—ä¸­çš„execFileæ–¹æ³•æ‰§è¡Œå¸è½½çš„exe        child_process.execFile(path.join(target, &quot;Uninstall.exe&quot;), (err, res) =&gt; {            if (err) {                console.log(&quot;å¸è½½å¤±è´¥,è¯·é‡è¯•!&quot;);            }        });    }});</code></pre><p>æœ€åæ‰§è¡Œå†™å¥½çš„jsæ–‡ä»¶,å°±ä¼šé¡ºåˆ©æ‰“å¼€ç›¸å…³å¸è½½çª—å£:</p><p><img src="/imgs/uninstall-screenshoot.png" alt="å¸è½½çª—å£"></p><p>å½“ç„¶è¿™åªæ˜¯ä¸€ä¸ªç®€å•çš„å®ç°,æ˜¯åˆ†æå¥½äº†è½¯ä»¶å®‰è£…ç›®å½•ä¸‹çš„å¸è½½æ–‡ä»¶åœ¨ä»€ä¹ˆåœ°æ–¹å»è°ƒç”¨å®ƒçš„,è‚¯å®šä¸èƒ½åº”ç”¨äºæ‰€æœ‰åœºæ™¯,åº”è¯¥éå†è¯¥è½¯ä»¶å®‰è£…çš„æ ¹ç›®å½•å’Œå­ç›®å½•æœç´¢å¸è½½ç¨‹åºæ‰€åœ¨çš„æœ€ç»ˆç›®å½•æ¥æ‰§è¡Œå¹¶è¿›è¡Œå¸è½½ã€‚</p><h5 id="è®°åœ¨2017-03-30"><a href="#è®°åœ¨2017-03-30" class="headerlink" title="è®°åœ¨2017-03-30"></a>è®°åœ¨2017-03-30</h5><p>ä»Šå¤©å°è¯•ç”¨æ˜¨å¤©çš„å†™æ³•æ¥å®ç°è½¯ä»¶å¸è½½,å‘ç°å®ç°èµ·æ¥å¹¶ä¸æ˜¯é‚£ä¹ˆç®€å•,è€Œä¸”éå†æ–‡ä»¶çš„è¯é¢ä¸´ä¸€ä¸ªæ€§èƒ½é—®é¢˜,å±‚çº§ä¸€å¤š,é€’å½’å¾ªç¯å°±å¯èƒ½å¯¼è‡´éœ€è¦ç­‰å¥½ä¹…æ‰èƒ½å¼€å§‹å¸è½½,æ‰€ä»¥åˆæ·±å…¥ç ”ç©¶äº†ä¸‹æ³¨å†Œè¡¨,çœŸæ˜¯å¾—æ¥å…¨ä¸è´¹å·¥å¤«,æ³¨å†Œè¡¨é‡Œé¢å°±ç»™æˆ‘ä»¬æä¾›äº†æŸä¸ªè½¯ä»¶çš„å¸è½½è·¯å¾„,å…·ä½“ä½ç½®åœ¨</p><pre><code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\</code></pre><p>è¿™è¾¹éƒ½æ˜¯æˆ‘ä»¬å®‰è£…çš„æ‰€æœ‰è½¯ä»¶,éœ€è¦æ³¨æ„çš„æ˜¯åœ¨64ä½ç³»ç»Ÿä¸­è¯¥è·¯å¾„æœ‰æ‰€ä¸åŒ,å¤§é—®é¢˜è§£å†³äº†,æˆ‘ä»¬åˆé¢ä¸´ä¸€ä¸ªå…¶ä»–é—®é¢˜,å°±æ˜¯æœ‰äº›è½¯ä»¶åœ¨å®‰è£…å,å¸è½½é‚£ä¸€çº§çš„æœ€åä¸€å±‚å¹¶ä¸æ˜¯å®ƒè‡ªå·±çš„åå­—,è€Œæ˜¯ä¸€ä¸²èŠ±æ‹¬å·å¼€å§‹èŠ±æ‹¬å·ç»“å°¾çš„å­—ç¬¦ä¸²,ç±»ä¼¼äºä¸‹å›¾æ‰€ç¤º:</p><p><img src="/imgs/uninstall-id.png" alt="å¸è½½id"></p><p>äºæ˜¯åˆåœ¨å¥½å‡ ç§ä¸åŒç‰ˆæœ¬çš„windowsç”µè„‘ä¸Šè¿›è¡Œå°è¯•,å‘ç°è¿™ä¸ªidå§‹ç»ˆæ˜¯å”¯ä¸€çš„,æœ€åå’Œéœ€æ±‚å•†é‡å†³å®šåå°ç®¡ç†å‘˜åœ¨æä¾›è½¯ä»¶çš„æ—¶å€™æŠŠè¿™ä¸ªidä¹Ÿå¸¦ä¸Š,è¿™æ ·å°±è§£å†³äº†é—®é¢˜,è¿™æ ·å”¯ä¸€çš„ä¸å¥½å°±æ˜¯åå°ç®¡ç†å‘˜çš„å·¥ä½œå¯èƒ½ä¼šç¨å¾®ç¹çç‚¹ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æœ€è¿‘åœ¨åŸºäºnode-webkit(ä»¥ä¸‹ç®€ç§°NW)å¼€å‘windowsæ¡Œé¢app,é‡Œé¢æœ‰ä¸ªç±»ä¼¼äºè½¯ä»¶å¸‚åœºçš„åŠŸèƒ½,åå°ç®¡ç†å‘˜æä¾›ä¸€äº›è½¯ä»¶,å¯ä»¥ä»è¯¥appä¸Šè¿›è¡Œä¸‹è½½ã€å®‰è£…ã€å¸è½½ã€å‡çº§ç­‰ç­‰ã€‚&lt;/p&gt;
&lt;p&gt;å®‰è£…æˆ–å‡çº§å¯ä»¥ç›´æ¥é€šè¿‡æŠŠä¸‹è½½å¥½çš„zipåŒ…è§£å‹å‡ºæ¥ç„¶åæ‰§è¡Œé‡Œé¢çš„exeç¨‹åºå®‰è£…å°±
      
    
    </summary>
    
    
      <category term="nodejs" scheme="http://yoursite.com/categories/nodejs/"/>
    
      <category term="æ¡Œé¢exe" scheme="http://yoursite.com/categories/nodejs/%E6%A1%8C%E9%9D%A2exe/"/>
    
    
  </entry>
  
  <entry>
    <title>decoratorçš„å­¦ä¹ </title>
    <link href="http://yoursite.com/2017/02/17/2017-02-17-es7-decorator-tourial/"/>
    <id>http://yoursite.com/2017/02/17/2017-02-17-es7-decorator-tourial/</id>
    <published>2017-02-16T16:00:00.000Z</published>
    <updated>2017-02-17T12:44:15.000Z</updated>
    
    <content type="html"><![CDATA[<p>éšç€å‰ç«¯æŠ€æœ¯çš„å‘å±•,è¶Šæ¥è¶Šå¤šäººæŠŠES6ã€7ç”¨åœ¨æ—¥å¸¸å¼€å‘ä¸­,åœ¨ES7ä¸­é™¤äº†å¹¿ä¸ºäººçŸ¥çš„async/awaitä¹‹å¤–,è¿˜æœ‰ä¸€å¤§ç‰¹æ€§ â€” decorator(è£…é¥°å™¨)ã€‚</p><p>åœ¨ä¹‹å‰åŸç”Ÿjavascriptè®¾è®¡æ¨¡å¼ä¸­çš„ä¸€ç¯‡æ–‡ç« (<a href="http://rwson.github.io/2015/07/15/2015-07-15-js-design-mode-decorator/" target="_blank" rel="noopener">javascriptè£…é¥°è€…æ¨¡å¼</a>)ä¸­è¯´é“: jsè£…é¥°è€…æ¨¡å¼å¯ä»¥æŠŠä¸€ä¸ªå¯¹è±¡(ç±»/å‡½æ•°)é€æ˜åœ°åŒ…è£…åœ¨å¦å¤–ä¸€ä¸ªå¯¹è±¡ä¸Š,å®Œæˆå¯¹è¢«è£…é¥°è€…æ·»åŠ ä¸€äº›æ–°åŠŸèƒ½çš„ä½œç”¨ã€‚ç®€å•çš„è¯´æˆ‘ä»¬å¯ä»¥åœ¨ä¸ä¿®æ”¹ç±»/å‡½æ•°å†…éƒ¨ä»£ç çš„æƒ…å†µä¸‹,æ¥è¾¾åˆ°ç»™ç±»/å‡½æ•°åŠ å…¥ä¸€äº›æ–°åŠŸèƒ½ã€‚</p><p>è£…é¥°å™¨å¯ä»¥ä½œç”¨äºç±»æˆ–è€…ç±»çš„æˆå‘˜å±æ€§/æ–¹æ³•ä¸Š,ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸¤æ®µä»£ç æ¥åˆ†åˆ«è§£é‡Š:</p><pre><code>//  ä½œç”¨äºç±»/** * éœ€æ±‚: * å°è£…4ä¸ªæ–¹æ³•,åˆ†åˆ«å®ç°åŠ å‡ä¹˜é™¤å››ä¸ªåŠŸèƒ½ * é€šè¿‡è£…é¥°å™¨ç»™ç±»æ·»åŠ è¿™å››ä¸ªæ–¹æ³•,å¹¶ä¸”å¯æŒ‡å®šæ˜¯å¦ä½œä¸ºç±»çš„é™æ€æ–¹æ³•æ·»åŠ  **///  åŠ å‡ä¹˜é™¤çš„å®ç°function add() {    return [].slice.call(arguments).reduce((a, b) =&gt; a + b);}function reduce() {    return [].slice.call(arguments).reduce((a, b) =&gt; a - b);}function mul() {    return [].slice.call(arguments).reduce((a, b) =&gt; a * b);}function div() {    return [].slice.call(arguments).reduce((a, b) =&gt; a / b);}@bindCal(add, true)@bindCal(reduce, true)@bindCal(mul, false)@bindCal(div, false)class MyMath {}</code></pre><p>ä¸Šé¢æˆ‘ä»¬å®Œæˆäº†éœ€æ±‚ä¸­çš„å››ä¸ªå‡½æ•°çš„å°è£…ä»¥åŠå¯¹MyMathç±»åº”ç”¨äº†è£…é¥°å™¨,ä¸‹é¢æˆ‘ä»¬å°±æ¥å®ç°è¿™ä¸ªè£…é¥°å™¨:</p><pre><code>/** * @param    {Function}   method    æŒ‡å‘éœ€è¦è¢«æ·»åŠ æ–¹æ³•çš„æŒ‡é’ˆ * @param    {String}     isStatic  æ˜¯å¦æ·»åŠ ä¸ºé™æ€å±æ€§,é»˜è®¤ä¸ºtrue * @return   {Function} */function bindCal(method, isStatic = true) {    //  è·å–åˆ°æ–¹æ³•å    const {name} = method;    //  å½“ä½œç”¨äºç±»ä¸Šæ—¶,ä¼šè¿”å›ä¸€ä¸ªåŒ¿åå‡½æ•°,å°†ç±»çš„æ„é€ å‡½æ•°ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°    return function(target) {        //  è·å–ç±»çš„åŸå‹        const {prototype} = target;        //  æ·»åŠ ä¸ºåŸå‹å±æ€§(éé™æ€å±æ€§)        if (!isStatic) {            //  æ£€æµ‹è¦æ·»åŠ çš„å±æ€§æ˜¯å¦å­˜åœ¨            if (prototype[name]) {                throw `${prototype.name}.${name} already exits!`;            } else {                //  åˆ©ç”¨ES5ä¸­çš„Object.definePropertyæ¥æ·»åŠ ç›¸å…³å±æ€§                Object.defineProperty(target.prototype, name, {                    value: method                });            }        } else {            //  æ·»åŠ ä¸ºé™æ€å±æ€§            //  æ£€æµ‹è¦æ·»åŠ çš„å±æ€§æ˜¯å¦å­˜åœ¨            if (target[name]) {                throw `${target}.${name} already exits!`;            }            //  åˆ©ç”¨ES5ä¸­çš„Object.definePropertyæ¥æ·»åŠ ç›¸å…³å±æ€§            Object.defineProperty(target, name, {                value: method            });        }        //  è¿”å›ç±»çš„æ„é€ å™¨        return target;    }}</code></pre><p>æˆ‘ä»¬æŠŠaddå’Œreduceä½œä¸ºé™æ€æ–¹æ³•æ·»åŠ ç»™MyMathç±»,æŠŠmulå’Œdivä½œä¸ºåŸå‹æ–¹æ³•ç»™äº†MyMathç±»,æ‰€ä»¥è°ƒç”¨åº”è¯¥çœ‹èµ·æ¥åƒä¸‹é¢çš„æ ·å­:</p><pre><code>const math = new MyMath();console.log(MyMath.add(1, 2, 3, 4));        //  10console.log(MyMath.reduce(1, 2, 3, 4));     //  -8console.log(math.mul(1, 2, 3, 4));          //  24console.log(math.div(10000, 1000, 10, 5));  //  0.2</code></pre><p>ä¸Šé¢å°±æ˜¯æˆ‘ä»¬åœ¨ç±»ä¸Šåº”ç”¨è£…é¥°å™¨çš„ä¸€ä¸ªä¾‹å­,ä¸‹é¢å†ä¸€èµ·çœ‹ä¸‹å¦‚æœåœ¨æˆå‘˜å±æ€§/æ–¹æ³•ä¸Šåº”ç”¨æ„é€ å™¨çš„ä¾‹å­:</p><pre><code>/** * éœ€æ±‚: * å®ç°åœ¨ç±»ä¸­å¯ä»¥å†»ç»“æˆå‘˜å±æ€§(å¤–éƒ¨æ— æ³•ä¿®æ”¹,åªè¯») * å®ç°ä¿®æ”¹ç±»ä¸­æˆå‘˜æ–¹æ³•ä¸­çš„thisæŒ‡å‘ **///  å®ç°ä¸€ä¸ªç±»,å¹¶ä¸”å¯¹å…¶æˆå‘˜å±æ€§/æ–¹æ³•åº”ç”¨è£…é¥°å™¨ã€å®šä¹‰ä¸€ä¸ªå¯¹è±¡,ä½œä¸ºæˆå‘˜æ–¹æ³•ä¸­çš„thisæŒ‡å‘const obj = {    name: &quot;rwson&quot;,    age: 24,    sex: &quot;male&quot;,    job: &quot;web developer&quot;};class Context {    constructor() {    }    @readonly    version = &quot;1.0.0&quot;;    @bindContext(obj)    showContext() {        console.log(this);    }} </code></pre><p>ä¸Šé¢æˆ‘ä»¬å®Œæˆäº†å¯¹è£…é¥°å™¨åº”ç”¨è¿‡ç¨‹,ä¸‹é¢ä¸€èµ·çœ‹ä¸‹readonlyå’ŒbindContextä¸¤ä¸ªè£…é¥°å™¨çš„å®ç°:</p><pre><code>/** * @param    {Object}   target    å½“å‰ç±»çš„prototype * @param    {String}   key       å°†è¦è¢«è£…é¥°çš„å±æ€§å * @param    {Object}   decorator ES5ä¸­Object.definePropertyçš„æœ€åä¸€ä¸ªå‚æ•° * @return   {Object}   decorator */function readonly(target, key, decorator) {    decorator.configurable = false;    decorator.enumerable = false;    decorator.writable = false;    decorator.value = decorator.value;    return decorator;}/** * @param    {Object}   context    éœ€è¦ç»‘å®šæˆthisçš„å¯¹è±¡ * @return   {Function} */function bindContext(context) {    /**     * @param    {Object}   target    å½“å‰ç±»çš„prototype     * @param    {String}   key       å°†è¦è¢«è£…é¥°çš„å±æ€§å     * @param    {Object}   decorator ES5ä¸­Object.definePropertyçš„æœ€åä¸€ä¸ªå‚æ•°     * @return   {Object}   decorator     */    return function(target, key, decorator) {        if (typeof context === &quot;undefined&quot;) {            context = target;        }        decorator.value = decorator.value.bind(context);        return decorator;    }}</code></pre><p>å¥½äº†ä¸Šé¢å°±æ˜¯æˆ‘ä»¬çš„ä¸¤ä¸ªä½œç”¨äºæˆå‘˜å±æ€§/æ–¹æ³•ä¸Šçš„è£…é¥°å™¨,ä¸‹é¢ä¸€èµ·æ¥çœ‹ä¸‹ç®€å•çš„è°ƒç”¨å§:</p><pre><code>const context = new Context();context.showContext();          //  æ‰“å°å‡ºåˆšæ‰å®šä¹‰çš„objå¯¹è±¡context.version = &quot;1.1.0&quot;;      //  æŠ›å‡ºå¼‚å¸¸ Uncaught TypeError: Cannot assign to read only property &apos;version&apos; of object &apos;#&lt;Context&gt;&apos;</code></pre><p>å¥½äº†,ä¸Šé¢å°±è£…é¥°å™¨çš„å‡ ç§ç”¨æ³•å’Œå®ç°,æˆ‘ä»¬å¯èƒ½ä¼šå‘ç°åˆšæ‰åœ¨å®šä¹‰è£…é¥°å™¨å‡½æ•°çš„æ—¶å€™,å½“è¯¥è£…é¥°å™¨ä½œç”¨äºç±»ä¸Šçš„æ—¶å€™è¿”å›å‡ºçš„åŒ¿åå‡½æ•°éƒ½æ˜¯ä¸€ä¸ªå‚æ•°;è€Œä½œç”¨äºæˆå‘˜å±æ€§æˆ–è€…æˆå‘˜æ–¹æ³•ä¸Šçš„,éƒ½æ˜¯ä¸‰ä¸ªå‚æ•°,è¿™åˆæ˜¯ä¸ºå•¥å‘¢?</p><p>ä¸€èµ·æ¥åˆ†æä¸‹ç¼–è¯‘åçš„ä»£ç :</p><pre><code>/** * @param    {Object}               target     å½“å‰ç±»çš„prototype * @param    {String}               property   å°†è¦è¢«è£…é¥°çš„å±æ€§å * @param    {Array.&lt;Function&gt;}       decorators è£…é¥°å™¨å‡½æ•°åˆ—è¡¨ * @param    {Object}               descriptor ES5ä¸­Object.definePropertyçš„æœ€åä¸€ä¸ªå‚æ•° * @param    {[type]}   context    [description] * @return   {[type]}              [description] * @private */function _applyDecoratedDescriptor(target, property, decorators, descriptor, context) {    //    å±æ€§å¯¹è±¡    var desc = {};    //    Object[&quot;keys&quot;]    -&gt; [&quot;value&quot;, &quot;writable&quot;, &quot;enumerable&quot;, &quot;configurable&quot;]    //    æŠŠES5ä¸­Object.definePropertyçš„æœ€åä¸€ä¸ªå‚æ•°çš„å±æ€§å˜æˆå¤–éƒ¨æŒ‡å®šçš„    Object[&apos;ke&apos; + &apos;ys&apos;](descriptor).forEach(function (key) {        desc[key] = descriptor[key];    });    desc.enumerable = !!desc.enumerable;    desc.configurable = !!desc.configurable;    if (&apos;value&apos; in desc || desc.initializer) {        desc.writable = true;    }    desc = decorators.slice().reverse().reduce(function (desc, decorator) {        return decorator(target, property, desc) || desc;    }, desc);    if (context &amp;&amp; desc.initializer !== void 0) {        desc.value = desc.initializer ? desc.initializer.call(context) : void 0;        desc.initializer = undefined;    }    //    åˆ©ç”¨Object.definePropertyå®šä¹‰å±æ€§    if (desc.initializer === void 0) {        Object[&apos;define&apos; + &apos;Property&apos;](target, property, desc);        desc = null;    }    //    è¿”å›å½“å‰å±æ€§å¯¹è±¡    return desc;}</code></pre><p>å¯ä»¥çœ‹å‡ºå…¶å®decoratoræœ€åä¹Ÿæ˜¯é€šè¿‡Object.definePropertyå®ç°çš„,æ‰€ä»¥å‚æ•°å’ŒObject.definePropertyæ˜¯ä¸€è‡´çš„ã€‚</p><p>é‚£æ—¥å¸¸å¼€å‘ä¸­,æˆ‘ä»¬å¯èƒ½éœ€è¦å€ŸåŠ©babelæ¥å¯¹å¸¦æœ‰decoratorçš„ä»£ç è¿›è¡Œç¼–è¯‘,é¦–å…ˆæˆ‘ä»¬éœ€è¦å®‰è£…babel:</p><pre><code>npm install babel -g</code></pre><p>ç„¶ååˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•è¿è¡Œ:</p><pre><code>npm install babel-plugin-transform-decorators-legacy --save-dev</code></pre><p>ç„¶ååˆ›å»º.babelrcé…ç½®æ–‡ä»¶,åœ¨pluginsé€‰é¡¹ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®:</p><pre><code>//  ...&quot;plugins&quot;: [    &quot;transform-decorators-legacy&quot;]//  ...</code></pre><p>æœ€åæˆ‘ä»¬å°±å¯ä»¥ç¼–è¯‘ä¹‹å‰å†™çš„ä»£ç äº†:</p><pre><code>babel decorator.js &gt; decorator.es5.js</code></pre>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;éšç€å‰ç«¯æŠ€æœ¯çš„å‘å±•,è¶Šæ¥è¶Šå¤šäººæŠŠES6ã€7ç”¨åœ¨æ—¥å¸¸å¼€å‘ä¸­,åœ¨ES7ä¸­é™¤äº†å¹¿ä¸ºäººçŸ¥çš„async/awaitä¹‹å¤–,è¿˜æœ‰ä¸€å¤§ç‰¹æ€§ â€” decorator(è£…é¥°å™¨)ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨ä¹‹å‰åŸç”Ÿjavascriptè®¾è®¡æ¨¡å¼ä¸­çš„ä¸€ç¯‡æ–‡ç« (&lt;a href=&quot;http://rwson.gi
      
    
    </summary>
    
    
      <category term="javascript" scheme="http://yoursite.com/categories/javascript/"/>
    
      <category term="ES7" scheme="http://yoursite.com/categories/javascript/ES7/"/>
    
      <category term="decorator" scheme="http://yoursite.com/categories/javascript/ES7/decorator/"/>
    
    
  </entry>
  
  <entry>
    <title>å®ç°ä¸€ä¸ªæ‹·è´æ–‡ä»¶å¤¹ä»¥åŠæ–‡ä»¶å¤¹ä¸‹æ‰€æœ‰æ–‡ä»¶çš„æ–¹æ³•</title>
    <link href="http://yoursite.com/2017/01/20/2017-01-20-copy-a-directory-and-files-under-it/"/>
    <id>http://yoursite.com/2017/01/20/2017-01-20-copy-a-directory-and-files-under-it/</id>
    <published>2017-01-19T16:00:00.000Z</published>
    <updated>2017-03-30T12:19:21.000Z</updated>
    
    <content type="html"><![CDATA[<p>å®ç°è¿™ä¸ªæ–¹æ³•ä¾èµ–äº†<a href="https://www.npmjs.com/package/fs-extra" target="_blank" rel="noopener">fs-extra</a>æ¨¡å—,å®ç°ç›®çš„æ˜¯ä¸ºäº†ä¸€ä¸ªæ–¹æ³•æ‹·è´æ‰€æœ‰å½“å‰ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶,å…·ä½“å®ç°å¦‚ä¸‹:</p><pre><code>let fs = require(&quot;fs-extra&quot;);/** * æ‰¹é‡æ‹·è´æ–‡ä»¶ * @param src           æºç›®å½•          String * @param target        ç›®æ ‡ç›®å½•        String * @param filetypes     æ–‡ä»¶ç±»å‹        RegExp * @param ignorefiles   å¿½ç•¥æ–‡ä»¶åˆ—è¡¨    Array **/fs.copyAllFiles = (src, target, filetypes, ignorefiles) =&gt; {    let argus = arguments,        readSrc = src,        targetSrc = target,        fileSrc, targeFileSrc;    fs.readdir(readSrc, (ex, files) =&gt; {        if (files.length) {            files.forEach((file) =&gt; {                //  å½“å‰æ–‡ä»¶ä¸åœ¨å¿½ç•¥åˆ—è¡¨ä¸­                if (!(~ignoreFiles.indexOf(file))) {                    fileSrc = path.resolve(readSrc, file);                    if (filetypes.test(file)) {                        targeFileSrc = path.resolve(targetSrc, file);                        fs.copySync(fileSrc, targeFileSrc);                    } else {                        targeFileSrc = path.resolve(targetSrc, file);                        fs.copySync(fileSrc, targeFileSrc);                        //  é€’å½’æ‹·è´ä¸‹ä¸€çº§ç›®å½•                        fs.copyAllFiles.call(fileSrc, targeFileSrc, filetypes, ignorefiles);                    }                }            });        }    });};</code></pre><p>ä¸Šé¢çš„å°±æ˜¯è¦å®ç°çš„æ–¹æ³•,è°ƒç”¨çš„æ–¹æ³•å°±çœ‹èµ·æ¥åƒä¸‹é¢çš„æ ·å­:</p><pre><code>const ignoreFiles = [&quot;.DS_Store&quot;, &quot;.idea&quot;, &quot;.git&quot;, &quot;.svn&quot;];fs.copyAllFiles(&quot;a&quot;, &quot;b&quot;, /\.jpe?g|\.png/, ignoreFiles);</code></pre>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;å®ç°è¿™ä¸ªæ–¹æ³•ä¾èµ–äº†&lt;a href=&quot;https://www.npmjs.com/package/fs-extra&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;fs-extra&lt;/a&gt;æ¨¡å—,å®ç°ç›®çš„æ˜¯ä¸ºäº†ä¸€ä¸ªæ–¹æ³•æ‹·è´æ‰€æœ‰å½“å‰ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶,å…·ä½“å®ç°å¦‚ä¸‹:&lt;
      
    
    </summary>
    
    
      <category term="nodejs" scheme="http://yoursite.com/categories/nodejs/"/>
    
      <category term="æ–‡ä»¶æ“ä½œ" scheme="http://yoursite.com/categories/nodejs/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C/"/>
    
    
  </entry>
  
  <entry>
    <title>å®ç°ä¸€ä¸ªwebpack loader</title>
    <link href="http://yoursite.com/2017/01/18/2017-01-18-wrire-a-webpack-loader/"/>
    <id>http://yoursite.com/2017/01/18/2017-01-18-wrire-a-webpack-loader/</id>
    <published>2017-01-17T16:00:00.000Z</published>
    <updated>2017-03-30T12:19:21.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨React,ES6å¼€å‘æ¨¡å¼è¶Šæ¥è¶Šæ™®åŠçš„ä»Šå¤©,webpackå°±æˆäº†å‰ç«¯æ„å»ºçš„ä¸€ä¸ªæ ‡é…ã€‚webpackæœ‰ä¸¤å¤§é‡è¦éƒ¨åˆ†ç»„æˆ: loaderå’Œpluginã€‚loaderæ˜¯ç”¨åœ¨åº”ç”¨æºç ä¸Šçš„è½¬æ¢åŸä»¶,æ¯”å¦‚æœ€å¸¸ç”¨åˆ°çš„babel-loader/jsx-loader/file-loader/css-loader/url-loaderç­‰ç­‰ã€‚</p><p>loaderå¯é“¾å¼æ‰§è¡Œ,ä¸€ç§æ–‡ä»¶ç±»å‹å¯ä»¥ç”¨å¤šä¸ªloader(æ¯”å¦‚cssæ–‡ä»¶,å¯èƒ½å°±éœ€è¦ç”¨åˆ°css-loaderå’Œstyle-loader),loaderä¹‹é—´ç”¨â€!â€åˆ†éš”,å½“å‰loaderå¤„ç†å®Œ,æŠŠå¤„ç†ç»“æœå¸¦åˆ°ä¸‹ä¸€ä¸ªloader,æœ€åä¸€ä¸ªloaderè¿”å›ä¸€ä¸ªStringæˆ–è€…String Bufferè¿”å›ç»™compilerã€‚</p><p>loaderè°ƒç”¨æ–¹å¼å¤§ä½“æœ‰3ç§å½¢å¼:</p><ol><li><p>å¼•ç”¨æ—¶è°ƒç”¨</p><pre><code>//  a.jsrequire(&quot;style-loader/url!css-loader!./xxx.css&quot;);</code></pre></li><li><p>webpackç›´æ¥è°ƒç”¨</p><pre><code>//  webpack.config.js//  ...module: {    loaders: [        //  ...        {            test: /\.css$/,            loader: &quot;style-loader!css-loader&quot;        }    ]}</code></pre></li><li><p>æŒ‡å®šloadersæ•°ç»„</p><pre><code>//  webpack.config.js//  ...module: {    loaders: [        //  ...        {            test: /\.css$/,            loaders: [                &quot;style-loader&quot;,                &quot;css-loader&quot;            ]        }    ]}</code></pre></li></ol><p>webpackå®˜ç½‘ä¸Šè¯´â€A loader is a node module exporting a functionâ€,ä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªloaderå°±æ˜¯ä¸€ä¸ªæš´éœ²å‡ºå»çš„nodeæ¨¡å—,æ—¢ç„¶æ˜¯ä¸€ä¸ªnode module,ä¹Ÿå°±åŸºæœ¬å¯ä»¥å†™æˆä¸‹é¢çš„æ ·å­:</p><pre><code>module.exports = function() {    //  ...};</code></pre><p>éœ€è¦æ³¨æ„çš„æ˜¯,åœ¨è¯¥æ¨¡å—è¢«è°ƒç”¨æ—¶,ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ–‡ä»¶çš„å†…å®¹,æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å†æ”¹æ”¹:</p><pre><code>/** * @param content  å°†è¢«å¤„ç†çš„å†…å®¹ * **/module.exports = function(content) {    //  ...    //  è¿è¡Œä¸‹ä¸€ä¸ªloader    this.callback(content);};</code></pre><p>çŸ¥é“äº†å¤§ä½“å†™æ³•,ç°åœ¨æˆ‘ä»¬å°±æ¥å®ç°ä¸€ä¸ªç®€å•çš„loader,ä¸»è¦åŠŸèƒ½å°±æ˜¯æŠŠcssä¸­çš„pxå•ä½è½¬æ¢æˆremå•ä½</p><pre><code>//  px2rem-loader/index.js&quot;use strict&quot;;//  ç”¨æ¥è·å–è°ƒç”¨loaderæ—¶ä¼ å…¥çš„å‚æ•°ç­‰ç­‰var loaderUtils = require(&quot;loader-utils&quot;);//  cssè§£ææ¨¡å—var css = require(&quot;css&quot;);//  ä¹˜é™¤æ¨¡å—,é˜²æ­¢åœ¨è®¡ç®—ä¸­å‡ºç°ç²¾åº¦ä¸¢å¤±çš„é—®é¢˜var privateMath = {    mul: function(num1, num2) {        var m = 0,            s1 = num1.toString(),            s2 = num2.toString();        try {            m += s1.split(&quot;.&quot;)[1].length        } catch (e) {}        try {            m += s2.split(&quot;.&quot;)[1].length        } catch (e) {}        return Number(s1.replace(&quot;.&quot;, &quot;&quot;)) * Number(s2.replace(&quot;.&quot;, &quot;&quot;)) / Math.pow(10, m);    },    div: function(num1, num2) {        var t1, t2, r1, r2;        try {            t1 = num1.toString().split(&apos;.&apos;)[1].length;        } catch (e) {            t1 = 0;        }        try {            t2 = num2.toString().split(&quot;.&quot;)[1].length;        } catch (e) {            t2 = 0;        }        r1 = Number(num1.toString().replace(&quot;.&quot;, &quot;&quot;));        r2 = Number(num2.toString().replace(&quot;.&quot;, &quot;&quot;));        return (r1 / r2) * Math.pow(10, t2 - t1);    }};module.exports = function(content) {    //  æŠŠå½“æˆcsså†…å®¹è§£ææˆASTå¯¹è±¡    var contentAST = css.parse(content);    //  ä½¿ç”¨loaderæ—¶çš„queryString(ç›¸å…³å‚æ•°)    var query = loaderUtils.parseQuery(this.query);    //  æœ€å°pxå€¼,å½“æ•°ç»„å°äºå®ƒæ˜¯å¿½ç•¥è®¡ç®—    var minSize = query.minSize || 1;    //  åŸºæ•°(æœ€åè®¡ç®—å‡ºçš„ç»“æœ = (åŸå…ˆçš„å¤§å° / base / scale) + &quot;rem&quot;)    var base = query.base || 37.5;    //  å¿½ç•¥çš„æ ·å¼è§„åˆ™åç§°    var ignore = query.ignore.length ? query.ignore.split(&quot;|&quot;) : [];    //  ç¼©æ”¾æ¯”    var scale = query.scale || 1;    //  åŒ¹é…10pxæˆ–è€…10.5pxè¿™ç§å•ä½    var pxUnitReg = /\d+[\.{1}\d+]?px/gi;    var tmp;    //  éå†æ ·å¼æ ‘    contentAST.stylesheet.rules.forEach(function(rule) {        //  éå†æ ·å¼è¡¨        rule.declarations.forEach(function(style) {            if (ignore.indexOf(style.property) &lt; 0) {                style.value = style.value.replace(pxUnitReg, function(match) {                    tmp = parseFloat(match);                    if(tmp &gt; minSize) {                        return privateMath.div(tmp, privateMath.mul(base, scale)) + &quot;rem&quot;;                    }                });            }        });    });    //  å†æŠŠå¤„ç†å¥½çš„ASTå¯¹è±¡è½¬æˆcss String    content = css.stringify(contentAST);    //  è°ƒç”¨ä¸‹ä¸€ä¸ªloader    this.callback(null, content);};</code></pre><p>åˆ°è¿™é‡Œ,ä¸€ä¸ªç®€å•çš„loadå°±ç®—å®ç°äº†,ä¸€èµ·æ¥çœ‹ä¸‹è°ƒç”¨æŠŠ:</p><pre><code>//  webpack.config.jsconst webpack = require(&quot;webpack&quot;);module.exports = {    entry: &quot;./src/js/entry.js&quot;,    output: {        path: __dirname,        filename: &quot;build/bundle.js&quot;    },    module: {        loaders: [{            test: /\.js$/,            loader: &apos;babel-loader?presets[]=es2015&apos;        }, {            test: /\.css$/,            loader: &apos;style-loader!css-loader!px2rem-loader?base=37.5&amp;scale=2&amp;minSize=1&amp;ignore=border|margin|padding&apos;        }]    },    plugins: [    ]};</code></pre><p>ä¹‹å‰çš„css:</p><p><img src="/imgs/webpack-loader-1.png" alt></p><p>æ‰“åŒ…ä¹‹å:</p><p><img src="/imgs/webpack-px-2rem-compiled.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨React,ES6å¼€å‘æ¨¡å¼è¶Šæ¥è¶Šæ™®åŠçš„ä»Šå¤©,webpackå°±æˆäº†å‰ç«¯æ„å»ºçš„ä¸€ä¸ªæ ‡é…ã€‚webpackæœ‰ä¸¤å¤§é‡è¦éƒ¨åˆ†ç»„æˆ: loaderå’Œpluginã€‚loaderæ˜¯ç”¨åœ¨åº”ç”¨æºç ä¸Šçš„è½¬æ¢åŸä»¶,æ¯”å¦‚æœ€å¸¸ç”¨åˆ°çš„babel-loader/jsx-loader/file-loader
      
    
    </summary>
    
    
      <category term="javascript" scheme="http://yoursite.com/categories/javascript/"/>
    
      <category term="æ„å»ºå·¥å…·" scheme="http://yoursite.com/categories/javascript/%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7/"/>
    
      <category term="webpack" scheme="http://yoursite.com/categories/javascript/%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7/webpack/"/>
    
    
  </entry>
  
  <entry>
    <title>Shadow DOMç ”ç©¶</title>
    <link href="http://yoursite.com/2016/12/12/2016-12-12-chrome-shadow-dom-tourial/"/>
    <id>http://yoursite.com/2016/12/12/2016-12-12-chrome-shadow-dom-tourial/</id>
    <published>2016-12-11T16:00:00.000Z</published>
    <updated>2017-02-11T03:55:27.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨<a href="https://github.com/Polymer/polymer" target="_blank" rel="noopener">Polymer</a>ä¸­,æå‡ºäº†<a href="https://developer.mozilla.org/zh-CN/docs/Web/Web_Components" target="_blank" rel="noopener">Web Component</a>çš„æ¦‚å¿µ,æ—¨åœ¨è®©å¼€å‘è€…å¯ä»¥å°è£…å‡ºå¾ˆå¤šå¯å¤ç”¨çš„ç»„ä»¶ã€‚ç°åœ¨,webkitæ·»åŠ äº†å¯¹è¯¥APIæ”¯æŒ,ä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬ä¸ç”¨å€ŸåŠ©æ¡†æ¶,ä¹Ÿå¯ä»¥è‡ªå·±å°è£…å‡ºå¯å¤ç”¨çš„ç»„ä»¶(é€šè¿‡è‡ªå®šä¹‰å…ƒç´ çš„å½¢å¼),è€Œä¸éœ€è¦ä¾èµ–å…¶ä»–æ¡†æ¶æ¥å®ç°ã€‚</p><p>å‡è®¾æˆ‘ä»¬è¿™è¾¹éœ€è¦å°è£…ä¸€ä¸ªè¿›åº¦æ¡ç»„ä»¶,å®ç°ä»£ç å¤§æ¦‚æ˜¯è¿™æ ·çš„:</p><pre><code>//  javascriptclass CustomProgressBar extends HTMLElement {    constructor(args) {        super(args);        //  createShadowRootç”¨æ¥åˆ›å»ºä¸€ä¸ªshadowDOMå®ä¾‹        const shadowRoot = this.createShadowRoot();        //  è®¾ç½®ç»„ä»¶å†…çš„å¸ƒå±€ç»“æ„å’Œæ ·å¼        shadowRoot.innerHTML = `            &lt;style type=&quot;text/css&quot;&gt;                :host {                    display: inline-block;                    width: 200px;                    height: 30px;                    box-sizing: border-box;                    padding: 1px;                }                :host * {                    -webkit-touch-callout: none;                    -webkit-user-select: none;                    -khtml-user-select: none;                    -moz-user-select: none;                    -ms-user-select: none;                    user-select: none;                }                .progress {                    display: inline-block;                    width: 200px;                    height: 30px;                    position: relative;                    border: 1px solid #000;                }                .progress &gt; .bar {                    background: red;                    height: 100%;                    width: 0;                    transition: all 0.2s;                }                .progress .label {                    position: absolute;                    top: 0;                    left: 0;                    width: 100%;                    text-align: center;                    font-size: 14px;                    line-height: 30px;                    color: #000;                }            &lt;/style&gt;            &lt;div class=&quot;progress&quot; aria-valuenow=&quot;0&quot; aria-valuemin=&quot;0&quot; aria-valuemax=&quot;100&quot;&gt;                &lt;div class=&quot;bar&quot;&gt;&lt;/div&gt;                &lt;div class=&quot;label&quot;&gt;0%&lt;/div&gt;            &lt;/div&gt;        `;        //  å°†ç›¸å…³å…ƒç´ å­˜å‚¨åˆ°æˆå‘˜å˜é‡ä¸­        this._progressElement = shadowRoot.querySelector(&quot;.progress&quot;);        this._bar = shadowRoot.querySelector(&quot;.bar&quot;);        this._label = shadowRoot.querySelector(&quot;.label&quot;);    }    /**     * å–å¾—å½“å‰è¿›åº¦     * @return {string}     */    get progress() {        return Number(this._progressElement.getAttribute(&quot;aria-valuenow&quot;));    }    /**     * è®¾ç½®è¿›åº¦     * @param value     */    set progress(value) {        //  æœ€å¤§å€¼å€¼æœ€å°å€¼        const max = this._progressElement.getAttribute(&quot;aria-valuemax&quot;),              min = this._progressElement.getAttribute(&quot;aria-valuemin&quot;);        //  ç±»å‹åˆ¤æ–­        if(Number.isNaN(Number(value))) {            throw new Error(`value must be an number type, you specified ${value} which is ${{}.toString.call(value).slice(8, -1).toLowerCase()}!`);        }        //  èŒƒå›´æ£€æµ‹        if(value &gt; max || value &lt; min) {            throw new Error(`value must between ${min} to ${max} , you specified ${value}!`);        }        //  è®¾ç½®ç›¸å…³å±æ€§        this._progressElement.setAttribute(&quot;aria-valuenow&quot;, value);        this._bar.style.width = `${value}%`;        this._label.textContent = `${value}%`;    }    /**     * æä¾›å¯ä»¥ç»‘å®šonclickçš„æ¥å£     * @param callback     */    set onclick(callback) {        if(typeof callback === &quot;function&quot;) {            this._progressElement.addEventListener(&quot;click&quot;, e =&gt; {                callback.call(this, e);            }, false);        }    }}//  è°ƒç”¨ customElements.defineå®šä¹‰è‡ªå®šä¹‰å…ƒç´ ,ç¬¬ä¸€ä¸ªå‚æ•°è‡ªå®šä¹‰å…ƒç´ å,ç¬¬äºŒä¸ªå‚æ•°æ˜¯HTMLElementçš„ä¸€ä¸ªå­ç±»customElements.define(&quot;custom-progress-bar&quot;, CustomProgressBar);window.onload = () =&gt; {    let customProgressBar = document.querySelector(&quot;custom-progress-bar&quot;),        progress;    /**     * ç»™è¿›åº¦æ¡ç»„ä»¶ç»‘å®šonclickäº‹ä»¶,æ¯æ¬¡ç‚¹å‡»è¿›åº¦åŠ 10     * @param e     */    customProgressBar.onclick = (e) =&gt; {        progress = Number(this.progress);        if(progress &gt;= 100) {            progress = 0;        } else {            progress += 10;        }        this.progress = progress;    };};//  HTML//  ç°åœ¨æˆ‘ä»¬å¯ä»¥é€šè¿‡new CustomProgressBar()æˆ–è€…custom-progress-baræ¥ä½¿ç”¨è‡ªå®šä¹‰å…ƒç´ äº†&lt;custom-progress-bar&gt;&lt;/custom-progress-bar&gt;</code></pre><p>è‡³æ­¤æˆ‘ä»¬çš„ä¸€ä¸ªè¿›åº¦æ¡ç»„ä»¶å°±ç®—å°è£…å®Œæˆäº†,éœ€è¦æ³¨æ„çš„æ˜¯,customElements.defineæ–¹æ³•å¯¹ç¬¬ä¸€ä¸ªå‚æ•°æœ‰ä¸€äº›è¦æ±‚:</p><ul><li>å¿…é¡»ä»¥å°å†™å­—æ¯ a-z å¼€å¤´</li><li>ä¸èƒ½åŒ…å«å¤§å†™å­—æ¯ A-Z</li><li>å¿…é¡»åŒ…å«â€-â€œ</li></ul><p>æœ€åæ¸²æŸ“å‡ºæ¥æ˜¯å¦‚ä¸‹çš„å¸ƒå±€ç»“æ„:</p><p><img src="/imgs/shadow-dom-rendered.png" alt></p><p>ä¸€èµ·çœ‹çœ‹å®é™…çš„æ•ˆæœ:</p><p><img src="/imgs/shadow-dom-gif.gif" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨&lt;a href=&quot;https://github.com/Polymer/polymer&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Polymer&lt;/a&gt;ä¸­,æå‡ºäº†&lt;a href=&quot;https://developer.mozilla.org/zh-CN
      
    
    </summary>
    
    
      <category term="javascript" scheme="http://yoursite.com/categories/javascript/"/>
    
      <category term="Shadow DOM" scheme="http://yoursite.com/categories/javascript/Shadow-DOM/"/>
    
      <category term="Web Component" scheme="http://yoursite.com/categories/javascript/Shadow-DOM/Web-Component/"/>
    
    
  </entry>
  
  <entry>
    <title>javascriptæ¨¡å—åŒ–ç¼–ç¨‹-åŒæ­¥æ¨¡å¼</title>
    <link href="http://yoursite.com/2016/11/29/2016-11-23-js-sync-module-mode/"/>
    <id>http://yoursite.com/2016/11/29/2016-11-23-js-sync-module-mode/</id>
    <published>2016-11-28T16:00:00.000Z</published>
    <updated>2017-03-30T12:19:21.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨æ—¥å¸¸å¼€å‘ä¸­,ä¸ºäº†ä¾¿äºå¤šäººåä½œå¼€å‘,æˆ‘ä»¬é€šå¸¸éƒ½ä¼šé‡‡ç”¨æ¨¡å—åŒ–å¼€å‘çš„æ¨¡å¼,ä»Šå¤©çœ‹å¼ è£é“­çš„ã€Šjavascriptè®¾è®¡æ¨¡å¼ã€‹çš„æ—¶å€™,çœ‹åˆ°åŒæ­¥æ¨¡å¼è¿™ä¸€ç« ,ç»“åˆè‡ªå·±ä¹‹å‰çš„ç«‹å³,ä¹Ÿæ¥å®ç°ä¸€ä¸ªç®€å•çš„åŒæ­¥æ¨¡å—åŒ–æ¨¡å¼ã€‚</p><pre><code>const module = (() =&gt; {    //  ç¼“å­˜ä¹‹å‰å£°æ˜çš„æ¨¡å—    let modules = {};    /**     * [description]     * @param  deps     ä¾èµ–åˆ—è¡¨     * @return Array     */    let _loadDeps = (deps) =&gt; {        return deps.map((dep) =&gt; {            return modules[dep];        });    };    return {        /**         * å£°æ˜ä¸€ä¸ªæ¨¡å—         * @param   id      æ¨¡å—id         * @param   deps    ä¾èµ–æ•°ç»„(æ¨¡å—id)         * @param   factory æ„é€ å‡½æ•°         */        define: (id, deps, factory) =&gt; {            //  è·å–ä¾èµ–,å¹¶ä¸”å–å¾—æ¨¡å—è¿”å›çš„å¯¹è±¡            deps = _loadDeps(deps);            deps.map(function(dep) {                return dep.factory.apply(window, dep.deps);            });            //  åˆ¤æ–­æ¨¡å—åæ˜¯å¦é‡å¤            if (modules[id]) {                 throw new Error(&quot;module &quot; + id + &quot; has been declared!&quot;);            }            //  ç¼“å­˜æ¨¡å—            modules[id] = {                id: id,                factory: factory,                deps: deps            };        },        /**         * ä½¿ç”¨å®šä¹‰å¥½çš„æ¨¡å—         * @param   depArr  ä¾èµ–æ•°ç»„(æ¨¡å—id)         * @param   factory æ„é€ å‡½æ•°         */        use: (depArr, factory) =&gt; {            //  è·å–ä¾èµ–,å¹¶ä¸”å–å¾—æ¨¡å—è¿”å›çš„å¯¹è±¡            depArr = depArr.map((dep) =&gt; {                return modules[dep].factory.apply(window, modules[dep].deps);            });            //  è¿è¡Œæ„é€ å‡½æ•°            factory.apply(window, depArr);        }    };})();</code></pre><p>ä¸‹é¢æˆ‘ä»¬å£°æ˜å‡ ä¸ªæ¨¡å—åšæµ‹è¯•:</p><pre><code>//  Aæ¨¡å—module.define(&quot;A&quot;, [], () =&gt; {    return {        method: () =&gt; {            console.log(&quot;method under module A&quot;);        }    };});//  Bæ¨¡å—module.define(&quot;B&quot;, [], () =&gt; {    return {        method: () =&gt; {            console.log(&quot;method under module B&quot;);        }    };});//  Personç±»module.define(&quot;PersonClass&quot;, [], () =&gt; {    class Person {        constructor(name, age, sex, job) {            this.name = name;            this.age = age;            this.sex = sex;            this.job = job;        }        hello() {            console.log(&quot;hello &quot; + this.name);        }        eat() {            console.log(this.name + &quot; will eat&quot;);        }        getProfile() {            return {                name: this.name,                age: this.age,                sex: this.sex,                job: this.job            };        }    }    return Person;});</code></pre><p>æœ€åæˆ‘ä»¬è°ƒç”¨module.useæ¥ä½¿ç”¨è¿™äº›æ¨¡å—:</p><pre><code>module.use([&quot;A&quot;, &quot;B&quot;, &quot;PersonClass&quot;], (A, B, PersonClass) =&gt; {    A.method();    B.method();    let person = new PersonClass(&quot;rwson&quot;, 24, &quot;male&quot;, &quot;web developer&quot;);    person.hello();    setTimeout(function() {        person.eat();    }, 5000);    console.log(person.getProfile());});</code></pre><p>æœ€åæµè§ˆå™¨æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹å›¾çš„ç»“æœ:</p><p><img src="/imgs/sync-module-mode.png" alt="javascriptæ¨¡å—åŒ–-åŒæ­¥æ¨¡å¼"></p><p>è‡³æ­¤ä¸€ä¸ªç®€å•çš„æ¨¡å—åŒ–å·¥å…·å°±å¼€å‘å®Œæˆäº†ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨æ—¥å¸¸å¼€å‘ä¸­,ä¸ºäº†ä¾¿äºå¤šäººåä½œå¼€å‘,æˆ‘ä»¬é€šå¸¸éƒ½ä¼šé‡‡ç”¨æ¨¡å—åŒ–å¼€å‘çš„æ¨¡å¼,ä»Šå¤©çœ‹å¼ è£é“­çš„ã€Šjavascriptè®¾è®¡æ¨¡å¼ã€‹çš„æ—¶å€™,çœ‹åˆ°åŒæ­¥æ¨¡å¼è¿™ä¸€ç« ,ç»“åˆè‡ªå·±ä¹‹å‰çš„ç«‹å³,ä¹Ÿæ¥å®ç°ä¸€ä¸ªç®€å•çš„åŒæ­¥æ¨¡å—åŒ–æ¨¡å¼ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;const module = (() =&amp;g
      
    
    </summary>
    
    
      <category term="javascript" scheme="http://yoursite.com/categories/javascript/"/>
    
      <category term="æ¨¡å—åŒ–" scheme="http://yoursite.com/categories/javascript/%E6%A8%A1%E5%9D%97%E5%8C%96/"/>
    
    
  </entry>
  
  <entry>
    <title>Gulpæ’ä»¶çš„ç ”ç©¶</title>
    <link href="http://yoursite.com/2016/11/29/2016-11-29-gulp-plugin-tourial/"/>
    <id>http://yoursite.com/2016/11/29/2016-11-29-gulp-plugin-tourial/</id>
    <published>2016-11-28T16:00:00.000Z</published>
    <updated>2017-03-30T12:19:21.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ç½‘é¡µç«¯åŠŸèƒ½è¶Šæ¥è¶Šç¹æ‚çš„ä»Šå¤©,éšç€åŠŸèƒ½çš„å¢å¤š,ä»£ç é‡ä¹Ÿå¿…ä¸å¯å°‘çš„å¤šä¸ª,ä»£ç é‡ä¸€å¤š,webæ€§èƒ½å°±æ˜¾å¾—å°¤ä¸ºé‡è¦,å°¤å…¶æ˜¯åŠ è½½æ–¹é¢,æ—¶é—´å¤ªé•¿,å¯èƒ½ç”¨æˆ·å°±æ²¡å¿ƒæƒ…ç­‰ä¸‹å»,æ‰€ä»¥ç°åœ¨çš„webé¡¹ç›®ä¸€èˆ¬éƒ½åœ¨å‘å¸ƒçš„æ—¶å€™è¿›è¡Œä¸€ç‰ˆè‡ªåŠ¨æ„å»º,ä»åŸæ¥çš„gruntåˆ°gulp,å†åˆ°ç°åœ¨çš„webpackã€‚</p><p>ä»Šå¤©ç ”ç©¶äº†ä¸‹gulpæ’ä»¶,å†™ç‚¹å¿ƒå¾—ä½“ä¼šå§ã€‚çœ‹äº†ä¸¤ä¸ªgulpæ’ä»¶æºç ,å‘ç°é‡Œé¢éƒ½å¼•å…¥äº†<a href="https://github.com/rvagg/through2" target="_blank" rel="noopener">through2</a>è¿™ä¸ªåŒ…,å®˜æ–¹çš„è¯´æ³•å°±æ˜¯â€Node Streamçš„ç®€å•å°è£…ï¼Œç›®çš„æ˜¯è®©é“¾å¼æµæ“ä½œæ›´åŠ ç®€å•;â€,å°±ä¹Ÿç…§è‘«èŠ¦ç”»ç“¢,å¼•ç”¨äº†è¿™ä¸ªåŒ…,ç®€å•å®ç°ä¸€ä¸ªgulpæ’ä»¶,åŠŸèƒ½å°±æ˜¯å‹ç¼©css,å¹¶ä¸”æŠŠcssä¸­çš„â€background: url(xxxx.png)â€ä¸­çš„â€xxxx.pngâ€è½¬æ¢æˆbase64ç¼–ç çš„å½¢å¼,å‡å°‘httpè¯·æ±‚æ•°ã€‚</p><pre><code>&quot;use strict&quot;;const through = require(&quot;through2&quot;),    path = require(&quot;path&quot;),    fs = require(&quot;fs&quot;),    //  å¼•ç”¨async/await,æ–¹ä¾¿å¤„ç†æ–‡ä»¶è¯»å†™çš„å¼‚æ­¥æ“ä½œ    async = require(&quot;asyncawait&quot;).async,    await = require(&quot;asyncawait&quot;).await,    //  åŒ¹é…url(../xxx.yyy)è¿™ç§è¡¨è¾¾å¼    imgReg = /url\s*\((\s*[A-Za-z0-9\-\_\.\/\:]+\s*)\);?/gi,    //  å°†fs.readFileå°è£…æˆPromise    readFile = (path) =&gt; {        return new Promise((resolve, reject) =&gt; {            fs.readFile(path, (ex, file) =&gt; {                if (ex) {                    reject(ex);                }                resolve(file);            });        });    };let base, contents, match, tmp, url;//  æš´éœ²å‡ºå»çš„å‡½æ•°module.exports = (opt) =&gt; {    return through.obj(function(file, enc, cb) {        //  æ–‡ä»¶ä¸ºç©ºç›´æ¥æ‰§è¡Œå›è°ƒå‡½æ•°        if (file.isNull()) {            cb(null, file);        }        //  å–å¾—å½“å‰cssçš„ç»å¯¹è·¯å¾„        base = file.base;        //  åŒ¹é…cssä¸­çš„æ— æ•ˆå­—ç¬¦,å¹¶ä¸”è½¬æ¢æˆbuffer        file.contents = new Buffer(file._contents.toString()            //  å»æ¢è¡Œç¬¦            .replace(/\n/gm, &quot;&quot;)            //  å»&quot;{&quot;ä¹‹ååˆ°ç¬¬ä¸€æ¡æ ·å¼é—´çš„ç©ºç™½å­—ç¬¦            .replace(/\{\s+/g, &quot;{&quot;)            //  å»&quot;;&quot;ä¹‹åçš„ç©ºç™½å­—ç¬¦            .replace(/\;\s+/g, &quot;;&quot;));        //  å°†æ–‡ä»¶å†…å®¹è½¬æ¢æˆæ™®é€šå­—ç¬¦ä¸²å¹¶ç¼“å­˜        contents = file.contents.toString();        //  å–å¾—url(../../xxx.yyy),å¹¶ä¸”ç¼“å­˜        match = contents.match(imgReg);        //  async-awaitè¯»å–å›¾ç‰‡æ–‡ä»¶æˆbase64ç¼–ç         async(() =&gt; {            //  éå†ä¹‹å‰çš„ç¼“å­˜é¡¹            match.forEach((item) =&gt; {                //  æ‹¼å‡‘æ–‡ä»¶ç»å¯¹è·¯å¾„                url = item.replace(&quot;url(&quot;, &quot;&quot;).replace(&quot;)&quot;, &quot;&quot;).trim();                //  ç”¨awaitè¯»å–æ–‡ä»¶,é¿å…åµŒå¥—                tmp = await (readFile(path.resolve(base, url)));                //  æ›¿æ¢ä¹‹å‰åŒ¹é…çš„å­—ç¬¦ä¸²                contents = contents.replace(item, `url(data:image/png;base64,${tmp.toString(&quot;base64&quot;)})`);            });            //  æŠŠæ–‡ä»¶å†…å®¹è½¬æˆbuffer            file.contents = new Buffer(contents);            //  å›è°ƒå‡½æ•°            cb(null, file);        })();    });};</code></pre><p>è‡³æ­¤,ä¸€ä¸ªç®€å•çš„æ’ä»¶å°±å®ç°äº†,å½“ç„¶,è¿˜æœ‰å¾ˆå¤šä¸è¶³,æ¯”å¦‚å¯¹å›¾ç‰‡è¿›è¡Œå‹ç¼©,å‡å°‘base64å­—ç¬¦ä¸²çš„é•¿åº¦,ç”¨requestæ¨¡å—å¤„ç†å¯¹ç½‘ç»œå›¾ç‰‡çš„å¼•ç”¨ç­‰ç­‰ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨ç½‘é¡µç«¯åŠŸèƒ½è¶Šæ¥è¶Šç¹æ‚çš„ä»Šå¤©,éšç€åŠŸèƒ½çš„å¢å¤š,ä»£ç é‡ä¹Ÿå¿…ä¸å¯å°‘çš„å¤šä¸ª,ä»£ç é‡ä¸€å¤š,webæ€§èƒ½å°±æ˜¾å¾—å°¤ä¸ºé‡è¦,å°¤å…¶æ˜¯åŠ è½½æ–¹é¢,æ—¶é—´å¤ªé•¿,å¯èƒ½ç”¨æˆ·å°±æ²¡å¿ƒæƒ…ç­‰ä¸‹å»,æ‰€ä»¥ç°åœ¨çš„webé¡¹ç›®ä¸€èˆ¬éƒ½åœ¨å‘å¸ƒçš„æ—¶å€™è¿›è¡Œä¸€ç‰ˆè‡ªåŠ¨æ„å»º,ä»åŸæ¥çš„gruntåˆ°gulp,å†åˆ°ç°åœ¨çš„webpackã€‚&lt;/
      
    
    </summary>
    
    
      <category term="javascript" scheme="http://yoursite.com/categories/javascript/"/>
    
      <category term="Gulp" scheme="http://yoursite.com/categories/javascript/Gulp/"/>
    
      <category term="æ„å»ºå·¥å…·" scheme="http://yoursite.com/categories/javascript/Gulp/%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7/"/>
    
    
  </entry>
  
  <entry>
    <title>ä¸€èµ·å†™ä¸€ä¸ªnpmå‘½ä»¤è¡Œå·¥å…·</title>
    <link href="http://yoursite.com/2016/11/20/2016-11-20-write-a-client/"/>
    <id>http://yoursite.com/2016/11/20/2016-11-20-write-a-client/</id>
    <published>2016-11-19T16:00:00.000Z</published>
    <updated>2017-09-22T03:17:53.000Z</updated>
    
    <content type="html"><![CDATA[<p>è‡ªä»nodejsé—®ä¸–ä¹‹åï¼Œéšç€å‰ç«¯ä¸æ–­çš„å‘å±•ï¼Œå‡ºç°è¿‡å¾ˆå¤šçš„å‘½ä»¤è¡Œå·¥å…·ï¼Œå°±æ¯”å¦‚å‰ç«¯æ„å»ºå·¥å…·ï¼Œä»æœ€å¼€å§‹çš„<code>grunt</code>ï¼Œå†åˆ°<code>gulp</code>ï¼Œç„¶ååˆ°ç°åœ¨çš„<code>webpack</code>ç­‰ç­‰ï¼Œå®ƒä»¬éƒ½æœ‰è‡ªå·±çš„å‘½ä»¤è¡Œï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¸€èµ·åˆ†æå¹¶å®ç°ä¸€ä¸ªç®€å•çš„å‘½ä»¤è¡Œå·¥å…·</p><p>é¦–å…ˆéœ€è¦å»ºä¸€ä¸ªç›®å½•ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬æš‚ä¸”å«<code>cli-starter</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir cli-starter</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬éœ€è¦å»ç”¨<code>npm</code>åˆå§‹åŒ–è¿™ä¸ªç›®å½•ï¼Œè¿™é‡Œæˆ‘ä»¬ç”¨é»˜è®¤çš„å°±å¥½</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm init -y</span><br></pre></td></tr></table></figure><p>æ™®é€šçš„ node.js è„šæœ¬éœ€è¦ä½¿ç”¨<code>node æ–‡ä»¶å</code>çš„å½¢å¼æ‰§è¡Œï¼Œåœ¨è„šæœ¬é¦–è¡ŒåŠ ä¸Š<code>#!/usr/bin/env node</code>å¯ä»¥åœ¨<code>linux</code>ç¯å¢ƒä¸­æŒ‡å®šè„šæœ¬çš„è§£é‡Šç¨‹åº</p><p>ä¸€åˆ‡ä»<code>hello world</code>å¼€å§‹ï¼Œæˆ‘ä»¬ç°åœ¨æ–°å»ºä¸€ä¸ª<code>bin</code>ç›®å½•ï¼Œåœ¨ä¸‹é¢ç”¨å»ºä¸€ä¸ª<code>hello.js</code>ï¼Œå†™å…¥ä¸‹é¢å†…å®¹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env node</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"hello world"</span>);</span><br></pre></td></tr></table></figure><p>ç„¶åå»<code>node ./bin/hello</code>ï¼Œå¯ä»¥çœ‹åˆ°æ§åˆ¶å°ä¼šè¾“å‡º<code>hello world</code></p><p>å½“ç„¶è¿™ä¸ªåªæ˜¯åœ¨ç‰¹å®šç›®å½•ä¸‹å»æ‰§è¡Œè¿™ä¸ªæ–‡ä»¶ï¼Œå¦‚æœæƒ³å’Œå…¶ä»–å‘½ä»¤è¡Œå·¥å…·åšåˆ°æ— å¤„ä¸åœ¨ï¼Œå¯ä»¥åœ¨<code>package.json</code>ä¸­åšå¦‚ä¸‹æŒ‡å®š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"hello"</span>,</span><br><span class="line">  <span class="attr">"bin"</span>: &#123;</span><br><span class="line">    <span class="attr">"hello"</span>: <span class="string">"./bin/hello"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åå†é€šè¿‡<code>npm link</code>å»æ·»åŠ åˆ°ç³»ç»Ÿ<code>PATH</code>ï¼Œä¸è¦æ‹…å¿ƒä¼šæ±¡æŸ“ç³»ç»Ÿï¼Œæ—¢ç„¶æœ‰<code>npm link</code>ï¼Œè‚¯å®šå°±æœ‰<code>npm unlink</code>ï¼Œå°±æ˜¯æŠŠæˆ‘ä»¬æ·»åŠ çš„åˆ é™¤ï¼Œè¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ä»»ä½•ä¸€ä¸ªç›®å½•ä¸‹ä½¿ç”¨è¿™ä¸ª<code>hello</code>å‘½ä»¤äº†</p><p>ä¸Šé¢å°±æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„å‘½ä»¤è¡Œäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å¯¹å®ƒè¿›è¡Œå®Œå–„ï¼Œæœ€å¸¸è§çš„å°±æ˜¯å‚æ•°ï¼Œæœ‰å¾ˆå¤š<code>npm</code>æ¨¡å—å¯ä»¥è§£ææˆ‘ä»¬ä¼ å…¥çš„å‚æ•°ï¼Œå¸¸ç”¨çš„æœ‰<a href="https://www.npmjs.com/package/commander" target="_blank" rel="noopener">commander</a>ã€<a href="https://www.npmjs.com/package/minimist" target="_blank" rel="noopener">minimist</a>ç­‰</p><p>åœ¨è¿™é‡Œæˆ‘ç”¨çš„<code>minimist</code>è¿™ä¸ªæ¨¡å—ï¼Œç”¨æ³•<code>npm</code>ä¸Šå·²ç»æœ‰äº†è¿™é‡Œä¸å†èµ˜è¿°ï¼Œä¸‹é¢æˆ‘ä»¬ä¸€èµ·å®Œæˆä¸€ä¸ªç¿»è¯‘å°å·¥å…·ï¼Œè°ƒç”¨è°·æ­Œçš„ç¿»è¯‘æ¥å£ï¼Œè¿™é‡Œæˆ‘ç›´æ¥ç”¨çš„<code>translate-api</code>è¿™ä¸ª<code>npm</code>åŒ…,ä¸€èµ·çœ‹ä¸‹å®ç°ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env node</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> minimist = <span class="built_in">require</span>(<span class="string">"minimist"</span>),</span><br><span class="line">    translate = <span class="built_in">require</span>(<span class="string">"translate-api"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//è·å–å‚æ•°</span></span><br><span class="line"><span class="keyword">var</span> args = minimist((process.argv.slice(<span class="number">2</span>)), &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  å‚æ•°åˆ«å</span></span><br><span class="line"><span class="comment">     * hello --target=abc &lt;=&gt; hello -t=abc</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    alias: &#123;</span><br><span class="line">        t: <span class="string">"target"</span>,</span><br><span class="line">        i: <span class="string">"input"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//å­˜å‚¨è¾“å…¥çš„å‚æ•°</span></span><br><span class="line"><span class="keyword">var</span> target = args.target,</span><br><span class="line">    input = args.input;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è°ƒç”¨å°è£…å¥½çš„Google Translate API</span></span><br><span class="line">translate.getText(input, &#123; <span class="attr">to</span>: target &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(res.text);</span><br><span class="line"><span class="comment">//é€€å‡ºè¿›ç¨‹</span></span><br><span class="line">    process.exit(<span class="number">1</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œæˆ‘ä»¬ä¸€ä¸ªç®€å•çš„å‘½ä»¤è¡Œå·¥å…·å°±å†™å¥½äº†ï¼Œåªæ˜¯ä¸€ä¸ªå°ç©å…·ï¼Œè¿˜æœ‰å¾ˆå¤šæ²¡å®ç°ï¼Œæ¯”å¦‚å­å‘½ä»¤ç­‰ã€‚</p><p>é‚£ä¹ˆå¦‚æœæ„Ÿè§‰è¿™ä¸ªå·¥å…·å†™çš„è¿˜è¡Œï¼Œæƒ³åˆ†äº«åˆ°<code>npm</code>ä»“åº“é‡Œé¢ç»™æ›´å¤šäººä½¿ç”¨ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±è¦ç”¨åˆ°<code>npm</code>çš„ä¸€äº›å­å‘½ä»¤äº†ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦ç”¨<code>npm adduser</code>å»ç™»å½•<code>npm</code>ï¼Œè®©å®ƒçŸ¥é“è¿™ä¸ªåŒ…æ˜¯è°å‘å¸ƒçš„ï¼Œç„¶åç”¨<code>npm publish</code>å»æ¨é€åˆ°ä»“åº“ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨å‘å¸ƒ<code>npm</code>åŒ…æ—¶æˆ‘ä»¬éœ€è¦æŠŠé•œåƒæºåˆ‡æ¢æˆå®˜æ–¹çš„ï¼Œæ¨èä½¿ç”¨<a href="https://www.npmjs.com/package/nrm" target="_blank" rel="noopener">nrm</a>å»ç®¡ç†é•œåƒï¼Œåœ¨ç”¨<code>publish</code>ä¹‹å‰ï¼Œå…ˆ<code>nrm use npm</code>åˆ‡ä¸‹é•œåƒï¼Œç­‰å‘å¸ƒæˆåŠŸä¹‹ååˆ«äººå°±å¯ä»¥ç”¨<code>npm install &lt;package-name&gt; -g</code>å»æŠŠæˆ‘ä»¬çš„å‘½ä»¤è¡Œå·¥å…·å®‰è£…åˆ°å…¨å±€ä½¿ç”¨å•¦ğŸ˜œ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;è‡ªä»nodejsé—®ä¸–ä¹‹åï¼Œéšç€å‰ç«¯ä¸æ–­çš„å‘å±•ï¼Œå‡ºç°è¿‡å¾ˆå¤šçš„å‘½ä»¤è¡Œå·¥å…·ï¼Œå°±æ¯”å¦‚å‰ç«¯æ„å»ºå·¥å…·ï¼Œä»æœ€å¼€å§‹çš„&lt;code&gt;grunt&lt;/code&gt;ï¼Œå†åˆ°&lt;code&gt;gulp&lt;/code&gt;ï¼Œç„¶ååˆ°ç°åœ¨çš„&lt;code&gt;webpack&lt;/code&gt;ç­‰ç­‰ï¼Œå®ƒä»¬éƒ½æœ‰è‡ªå·±çš„å‘½ä»¤è¡Œï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¸€èµ·åˆ†
      
    
    </summary>
    
    
      <category term="javascript" scheme="http://yoursite.com/categories/javascript/"/>
    
      <category term="å‘½ä»¤è¡Œå·¥å…·" scheme="http://yoursite.com/categories/javascript/%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7/"/>
    
    
  </entry>
  
  <entry>
    <title>async/awaitå­¦ä¹ </title>
    <link href="http://yoursite.com/2016/11/09/2016-11-09-async:await-tourial/"/>
    <id>http://yoursite.com/2016/11/09/2016-11-09-async:await-tourial/</id>
    <published>2016-11-08T16:00:00.000Z</published>
    <updated>2017-03-30T12:19:21.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨å¤„ç†javascriptä¸­å¼‚æ­¥çš„æ—¶å€™,å›è°ƒå¾€å¾€æ˜¯æœ€è®©äººæ¶å¿ƒçš„,ä¹‹å‰ä»‹ç»è¿‡ç”¨<a href="http://123.207.98.169:81/2016/05/04/2016-05-04-es6-promise/" target="_blank" rel="noopener">Promise</a>æ¥å¤„ç†å¼‚æ­¥çš„é—®é¢˜,ä½†æ˜¯å³ä½¿ç”¨ä¸Šäº†Promise,åœ¨å¤„ç†å›è°ƒä¸Šè¿˜æ˜¯ä¼šæœ‰å„ç§åµŒå¥—,ä»Šå¤©æ¥ä»‹ç»ä¸‹ES7ä¸­çš„async/await,ç”±äºåœ¨Nodejsä¸­è¿˜æœªå¾—åˆ°æ”¯æŒ,æ‰€ä»¥éœ€è¦å€ŸåŠ©ä¸€äº›npmåŒ…æ¥å®è·µ,åœ¨è¿™é‡Œç”¨çš„æ˜¯<a href="https://github.com/yortus/asyncawait" target="_blank" rel="noopener">asyncawait</a>ã€‚</p><p>å…ˆæ¥ä¸ªåŸç”Ÿæ–‡ä»¶è¯»å–çš„ä¾‹å­:</p><pre><code>const fs = require(&quot;fs&quot;);fs.readFile(&quot;test.txt&quot;, (ex, res) =&gt; {   console.log(res.toString());    //   do something...   fs.readFile(&quot;test2.txt&quot;, (ex, res) =&gt; {        console.log(res.toString());        //  do something   });});//  æ§åˆ¶å°è¾“å‡ºxxxxxyyyyy</code></pre><p>ä¸‹é¢æˆ‘ä»¬å†ç”¨async/awaitå®ç°ä¸€é:</p><pre><code>const async = require(&quot;asyncawait&quot;).async;const await = require(&quot;asyncawait&quot;).await;let readFile = function(path) {    return new Promise((resolve, reject) =&gt; {        fs.readFile(path, (ex, res) =&gt; {            if (ex) {                reject(ex);            }            resolve(res);        });    });}let asyncReadFile = async(() =&gt; {    let fs = await (readFile(&quot;test.txt&quot;));    let fs2 = await (readFile(&quot;test2.txt&quot;));    console.log(fs.toString());    console.log(fs2.toString());});asyncReadFile();</code></pre><p>è™½ç„¶ä»£ç å¯èƒ½æ¯”ä¸Šé¢çš„å¤šäº†ä¸€ç‚¹,ä½†æ˜¯å·²ç»å®Œå…¨çœ‹ä¸åˆ°å›è°ƒåµŒå¥—çš„å½±å­äº†,ä¹Ÿèƒ½å®ŒæˆåŒæ ·çš„åŠŸèƒ½,ä½•ä¹è€Œä¸ä¸ºã€‚ğŸ˜‰</p><p>ä¸‹é¢æˆ‘ä»¬å†æ¥æ¨¡æ‹Ÿä¸€ä¸ªå¼‚æ­¥è¯·æ±‚çš„ä¾‹å­:</p><pre><code>const async = require(&quot;asyncawait&quot;).async;const await = require(&quot;asyncawait&quot;).await;const http = require(&quot;http&quot;);http.createServer((req, res) =&gt; {    switch (req.url) {        case &quot;/async-await&quot;:            setTimeout(() =&gt; {                res.writeHead(200, { &quot;Content-Type&quot;: &quot;text/plain&quot; });                res.end(&quot;request end&quot;);            }, 5000);            break;        case &quot;/async-await2&quot;:            setTimeout(() =&gt; {                res.writeHead(200, { &quot;Content-Type&quot;: &quot;text/plain&quot; });                res.end(&quot;request end2&quot;);            }, 8000);            break;        default:            break;    }}).listen(3000, &quot;127.0.0.1&quot;);let requestUrl = function(path) {    return new Promise((resolve, reject) =&gt; {        http.get({            hostname: &apos;localhost&apos;,            port: 3000,            path: path,            agent: false        }, (res) =&gt; {            res.on(&quot;data&quot;, (data) =&gt; {                resolve(data);            });            res.on(&quot;error&quot;, (ex) =&gt; {                reject(ex);            })        });    });}let asyncRequest = async(() =&gt; {    let resp, resp2;    await (requestUrl(&quot;/async-await&quot;).then((res) =&gt; {        console.log(res.toString());        resp = res.toString();    }).catch((ex) =&gt; {        resp = &quot;å‘ç”Ÿé”™è¯¯!&quot;;    }));    await (requestUrl(&quot;/async-await2&quot;).then((res) =&gt; {        resp2 = res.toString();    }).catch((ex) =&gt; {        resp = &quot;å‘ç”Ÿé”™è¯¯!&quot;;    }));    console.log(resp);    console.log(resp2);});asyncRequest();//  æ§åˆ¶å°è¾“å‡ºrequest endrequest end2</code></pre><p>ç”±æ­¤æˆ‘ä»¬å¯ä»¥å°†async/awaitç”¨åœ¨å¾ˆå¤šåœ°æ–¹,æ¯”å¦‚ä¾‹å­ä¸­çš„æ–‡ä»¶è¯»å–ã€å¼‚æ­¥è¯·æ±‚ã€nodejsä¸­çš„æŸ¥è¯¢æ•°æ®åº“ç­‰ç­‰ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨å¤„ç†javascriptä¸­å¼‚æ­¥çš„æ—¶å€™,å›è°ƒå¾€å¾€æ˜¯æœ€è®©äººæ¶å¿ƒçš„,ä¹‹å‰ä»‹ç»è¿‡ç”¨&lt;a href=&quot;http://123.207.98.169:81/2016/05/04/2016-05-04-es6-promise/&quot; target=&quot;_blank&quot; rel=&quot;noopener
      
    
    </summary>
    
    
      <category term="javascript" scheme="http://yoursite.com/categories/javascript/"/>
    
      <category term="ES7" scheme="http://yoursite.com/categories/javascript/ES7/"/>
    
      <category term="async/await" scheme="http://yoursite.com/categories/javascript/ES7/async-await/"/>
    
    
  </entry>
  
  <entry>
    <title>IEä¸‹AngularJsä¸­çš„ajaxç¼“å­˜</title>
    <link href="http://yoursite.com/2016/11/02/2016-11-02-ie-ajax-cache/"/>
    <id>http://yoursite.com/2016/11/02/2016-11-02-ie-ajax-cache/</id>
    <published>2016-11-01T16:00:00.000Z</published>
    <updated>2017-03-30T12:19:21.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨å•é¡µåº”ç”¨è¶Šæ¥è¶Šæ™®åŠçš„ä»Šå¤©,è¶Šæ¥è¶Šå¤šçš„é¡¹ç›®éƒ½ä¼šé‡‡ç”¨è¿™ç§æ–¹æ¡ˆ,è¿™å‡ å¤©ç”¨AngularJsåšäº†ä¸€ä¸ªPCç«¯åº”ç”¨,æœ‰ç™»å½•æ³¨å†Œçš„åŠŸèƒ½,ç™»å½•æ³¨å†Œçš„åŠŸèƒ½æ˜¯é€šè¿‡ajaxå®ç°çš„,åœ¨ç™»å½•æ³¨å†Œä»¥åé¡µé¢ä¸åˆ·æ–°,åªä¿®æ”¹$rootScopeä¸‹çš„æŸäº›å±æ€§å€¼,ç„¶ååœ¨é¡µé¢é‡Œé¢é€šè¿‡ng-ifä¹‹ç±»çš„æŒ‡ä»¤æ¥æ§åˆ¶ç›¸å…³å…ƒç´ çš„æ˜¾ç¤ºéšè—ã€‚</p><p>ä¹‹å‰çš„å¤§æ¦‚å®ç°å¦‚ä¸‹:</p><pre><code>//  jsvar app = angular.module(&quot;app&quot;, []);app.run([&quot;$rootScope&quot;, &quot;$http&quot;, function($rootScope, $http) {    $rootScope.isLogin = false;    $rootScope.$on(&quot;$routeChangeStart&quot;, function (event, next, current) {    $http.get(&quot;xxxx&quot;)        .success(function(res) {            $rootScope.isLogin = !!(res.isLogin);            //  ...        })        .error(function() {            //  ...        });    });}]);//  HTML&lt;div class=&quot;container&quot;&gt;    &lt;a href=&quot;/user/center&quot; ng-if=&quot;isLogin&quot;&gt;ç”¨æˆ·ä¸­å¿ƒ&lt;/a&gt;    &lt;a href=&quot;javascript:;&quot; ng-click=&quot;logout()&quot; ng-if=&quot;isLogin&quot;&gt;ç™»å‡º&lt;/a&gt;    &lt;a href=&quot;/login&quot; ng-if=&quot;!isLogin&quot;&gt;ç™»å½•&lt;/a&gt;&lt;/div&gt;</code></pre><p>åæ¥å‘ç°åœ¨Chrome/Firefoxä¸‹éƒ½æ˜¯å¥½çš„,åˆ°äº†IEä¸‹ç™»å½•ä»¥åä¸åˆ·æ–°å°±æ˜¾ç¤ºä¸å¯¹ã€‚åŸæ¥ä»¥ä¸ºæ˜¯ng-ifåœ¨IEä¸‹é‡æ–°æ¸²æŸ“è¿‡æ…¢çš„é—®é¢˜,æ”¹æˆng-showä»¥åè¿˜æ˜¯ä¸è¡Œ,ç„¶åçœ‹httpçŠ¶æ€ç ,å‘ç°æ˜¯304,æƒ³åˆ°å¯èƒ½å’Œç¼“å­˜æœ‰å…³ç³»,åæ¥æ”¹äº†é…ç½®ä¸­å…³é”®ajaxè¯·æ±‚é‚£è¾¹çš„ä¸œè¥¿,å‘ç°å¯ä»¥äº†,æ ¸å¿ƒä»£ç å¦‚ä¸‹:</p><pre><code>app.config([&quot;$routeProvider&quot;, &quot;$httpProvider&quot;, function($routeProvider, $httpProvider){    //  ...    if (!$httpProvider.defaults.headers.get) {        $httpProvider.defaults.headers.get = {};    }    $httpProvider.defaults.headers.common[&quot;X-Requested-With&quot;] = &quot;XMLHttpRequest&quot;;    $httpProvider.defaults.headers.get[&quot;Cache-Control&quot;] = &quot;no-cache&quot;;    $httpProvider.defaults.headers.get[&quot;Pragma&quot;] = &quot;no-cache&quot;;}]);</code></pre>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨å•é¡µåº”ç”¨è¶Šæ¥è¶Šæ™®åŠçš„ä»Šå¤©,è¶Šæ¥è¶Šå¤šçš„é¡¹ç›®éƒ½ä¼šé‡‡ç”¨è¿™ç§æ–¹æ¡ˆ,è¿™å‡ å¤©ç”¨AngularJsåšäº†ä¸€ä¸ªPCç«¯åº”ç”¨,æœ‰ç™»å½•æ³¨å†Œçš„åŠŸèƒ½,ç™»å½•æ³¨å†Œçš„åŠŸèƒ½æ˜¯é€šè¿‡ajaxå®ç°çš„,åœ¨ç™»å½•æ³¨å†Œä»¥åé¡µé¢ä¸åˆ·æ–°,åªä¿®æ”¹$rootScopeä¸‹çš„æŸäº›å±æ€§å€¼,ç„¶ååœ¨é¡µé¢é‡Œé¢é€šè¿‡ng-ifä¹‹ç±»çš„æŒ‡ä»¤æ¥æ§åˆ¶ç›¸
      
    
    </summary>
    
    
      <category term="javascript" scheme="http://yoursite.com/categories/javascript/"/>
    
      <category term="AngularJs" scheme="http://yoursite.com/categories/javascript/AngularJs/"/>
    
      <category term="ajax" scheme="http://yoursite.com/categories/javascript/AngularJs/ajax/"/>
    
    
  </entry>
  
</feed>
